<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>在 Rails 上升級 Ruby — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="在 Rails 上升級 Ruby — Ruby on Rails Guides" />
  <meta name="description" content="在 Rails 上升級 Ruby本指南提供了在 Rails 上將應用程序升級到較新版本的 Ruby 時要遵循的步驟。這些步驟也可在單獨的發行指南中找到。" />
  <meta property="og:description" content="在 Rails 上升級 Ruby本指南提供了在 Rails 上將應用程序升級到較新版本的 Ruby 時要遵循的步驟。這些步驟也可在單獨的發行指南中找到。" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.0</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多資訊請前往 <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        更多在 Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">部落格</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">指南</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">論壇</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">在 GitHub 上做出貢獻</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="返回首頁">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">首頁</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">手冊目錄</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>從這裡開始</dt>
                  <dd><a href="getting_started.html">Rails 入門</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record 基礎</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record 遷移 (Migrations)</a></dd>
                  <dd><a href="active_record_validations.html">Active Record 驗證 (Validations)</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record 回呼 (Callbacks)</a></dd>
                  <dd><a href="association_basics.html">Active Record 關聯 (Associations)</a></dd>
                  <dd><a href="active_record_querying.html">Active Record 查詢介面</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="layouts_and_rendering.html">Rails 中的版面配置(Layouts)和算繪(Rendering)</a></dd>
                  <dd><a href="form_helpers.html">Action View 表單 Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller 概述</a></dd>
                  <dd><a href="routing.html">Rails 從外到內路由</a></dd>
                </div>
                <div class="guides-section">
                  <dt>其他元件</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support 核心擴充套件</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer 基礎知識</a></dd>
                  <dd><a href="active_job_basics.html">Active Job 基礎</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage 概述</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable 概述</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>深入研究</dt>
                  <dd><a href="i18n.html">Rails 國際化 (I18n) API</a></dd>
                  <dd><a href="testing.html">測試 Rails 應用程式</a></dd>
                  <dd><a href="security.html">保護 Rails 應用程式</a></dd>
                  <dd><a href="debugging_rails_applications.html">除錯 Rails 應用程式</a></dd>
                  <dd><a href="configuring.html">設定 Rails 應用程式</a></dd>
                  <dd><a href="command_line.html">Rails 命令列</a></dd>
                  <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">自動載入和重新載入常量</a></dd>
                  <dd><a href="caching_with_rails.html">使用 Rails 快取</a></dd>
                  <dd><a href="api_app.html">將 Rails 用於僅 API 的應用程式</a></dd>
                </div>
                <div class="guides-section">
                  <dt>擴充 rails</dt>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">建立和自定義 Rails 產生器和模板</a></dd>
                </div>
                <div class="guides-section">
                  <dt>貢獻</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API 文件指南</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">指南指南</a></dd>
                </div>
                <div class="guides-section">
                  <dt>政策</dt>
                  <dd><a href="maintenance_policy.html">維修政策</a></dd>
                </div>
                <div class="guides-section">
                  <dt>發行說明</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</a></dd>
                  <dd><a href="6_1_release_notes.html">6.1 版 - 2020 年 12 月</a></dd>
                  <dd><a href="6_0_release_notes.html">6.0 版 - 2019 年 8 月</a></dd>
                  <dd><a href="5_2_release_notes.html">5.2 版 - 2018 年 4 月</a></dd>
                  <dd><a href="5_1_release_notes.html">5.1 版 - 2017 年 4 月</a></dd>
                  <dd><a href="5_0_release_notes.html">5.0 版 - 2016 年 6 月</a></dd>
                  <dd><a href="4_2_release_notes.html">4.2 版 - 2014 年 12 月</a></dd>
                  <dd><a href="4_1_release_notes.html">4.1 版 - 2014 年 4 月</a></dd>
                  <dd><a href="4_0_release_notes.html">4.0 版 - 2013 年 6 月</a></dd>
                  <dd><a href="3_2_release_notes.html">3.2 版 - 2012 年 1 月</a></dd>
                  <dd><a href="3_1_release_notes.html">3.1 版 - 2011 年 8 月</a></dd>
                  <dd><a href="3_0_release_notes.html">3.0 版 - 2010 年 8 月</a></dd>
                  <dd><a href="2_3_release_notes.html">2.3 版 - 2009 年 3 月</a></dd>
                  <dd><a href="2_2_release_notes.html">2.2 版 - 2008 年 11 月</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">貢獻</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">手冊目錄</option>
              <optgroup label="從這裡開始">
                  <option value="getting_started.html">Rails 入門</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record 基礎</option>
                  <option value="active_record_migrations.html">Active Record 遷移 (Migrations)</option>
                  <option value="active_record_validations.html">Active Record 驗證 (Validations)</option>
                  <option value="active_record_callbacks.html">Active Record 回呼 (Callbacks)</option>
                  <option value="association_basics.html">Active Record 關聯 (Associations)</option>
                  <option value="active_record_querying.html">Active Record 查詢介面</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Rails 中的版面配置(Layouts)和算繪(Rendering)</option>
                  <option value="form_helpers.html">Action View 表單 Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller 概述</option>
                  <option value="routing.html">Rails 從外到內路由</option>
              </optgroup>
              <optgroup label="其他元件">
                  <option value="active_support_core_extensions.html">Active Support 核心擴充套件</option>
                  <option value="action_mailer_basics.html">Action Mailer 基礎知識</option>
                  <option value="active_job_basics.html">Active Job 基礎</option>
                  <option value="active_storage_overview.html">Active Storage 概述</option>
                  <option value="action_cable_overview.html">Action Cable 概述</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="深入研究">
                  <option value="i18n.html">Rails 國際化 (I18n) API</option>
                  <option value="testing.html">測試 Rails 應用程式</option>
                  <option value="security.html">保護 Rails 應用程式</option>
                  <option value="debugging_rails_applications.html">除錯 Rails 應用程式</option>
                  <option value="configuring.html">設定 Rails 應用程式</option>
                  <option value="command_line.html">Rails 命令列</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="autoloading_and_reloading_constants.html">自動載入和重新載入常量</option>
                  <option value="caching_with_rails.html">使用 Rails 快取</option>
                  <option value="api_app.html">將 Rails 用於僅 API 的應用程式</option>
              </optgroup>
              <optgroup label="擴充 rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">建立和自定義 Rails 產生器和模板</option>
              </optgroup>
              <optgroup label="貢獻">
                  <option value="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</option>
                  <option value="api_documentation_guidelines.html">API 文件指南</option>
                  <option value="ruby_on_rails_guides_guidelines.html">指南指南</option>
              </optgroup>
              <optgroup label="政策">
                  <option value="maintenance_policy.html">維修政策</option>
              </optgroup>
              <optgroup label="發行說明">
                  <option value="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</option>
                  <option value="6_1_release_notes.html">6.1 版 - 2020 年 12 月</option>
                  <option value="6_0_release_notes.html">6.0 版 - 2019 年 8 月</option>
                  <option value="5_2_release_notes.html">5.2 版 - 2018 年 4 月</option>
                  <option value="5_1_release_notes.html">5.1 版 - 2017 年 4 月</option>
                  <option value="5_0_release_notes.html">5.0 版 - 2016 年 6 月</option>
                  <option value="4_2_release_notes.html">4.2 版 - 2014 年 12 月</option>
                  <option value="4_1_release_notes.html">4.1 版 - 2014 年 4 月</option>
                  <option value="4_0_release_notes.html">4.0 版 - 2013 年 6 月</option>
                  <option value="3_2_release_notes.html">3.2 版 - 2012 年 1 月</option>
                  <option value="3_1_release_notes.html">3.1 版 - 2011 年 8 月</option>
                  <option value="3_0_release_notes.html">3.0 版 - 2010 年 8 月</option>
                  <option value="2_3_release_notes.html">2.3 版 - 2009 年 3 月</option>
                  <option value="2_2_release_notes.html">2.2 版 - 2008 年 11 月</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>在 Rails 上升級 Ruby</h2><p>本指南提供了在 Rails 上將應用程序升級到較新版本的 Ruby 時要遵循的步驟。這些步驟也可在單獨的發行指南中找到。</p>

                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#">一般建議</a>

<ul>
<li><a href="#">測試覆蓋率</a></li>
<li><a href="#ruby">Ruby 版本</a></li>
<li><a href="#">升級過程</a></li>
<li><a href="#">更新任務</a></li>
<li><a href="#">設定框架預設值</a></li>
</ul>
</li>
<li>
<a href="#rails-6-1-rails-7-0">從 Rails 6.1 升級到 Rails 7.0</a>

<ul>
<li><a href="#rails-6-1-rails-7-0-">彈簧</a></li>
<li><a href="#zeitwerk">應用程式需要在 <code>zeitwerk</code> 模式下執行</a></li>
<li><a href="#setter-config-autoloader">setter <code>config.autoloader=</code> 已刪除</a></li>
<li><a href="#activesupport-dependencies-api"><code>ActiveSupport::Dependencies</code>私有API已刪除</a></li>
<li><a href="#">初始化期間自動載入</a></li>
<li><a href="#config-autoload-once-paths">能夠設定 <code>config.autoload_once_paths</code></a></li>
<li><a href="#actiondispatch-request-content-type-content-type"><code>ActionDispatch::Request#content_type</code> 現在原樣返回 Content-Type 標頭。</a></li>
<li><a href="#key-sha256">Key 產生器摘要類更改為使用 SHA256</a></li>
<li><a href="#activesupport-sha256">ActiveSupport 的摘要類::摘要更改為 SHA256</a></li>
<li><a href="#activesupport-cache">新的 ActiveSupport::Cache 序列化格式</a></li>
<li><a href="#activestorage-preview">ActiveStorage 視訊 preview 影象產生</a></li>
<li><a href="#activestorage-vips">ActiveStorage 變體處理器更改為 :vips</a></li>
</ul>
</li>
<li>
<a href="#rails-6-0-rails-6-1">從 Rails 6.0 升級到 Rails 6.1</a>

<ul>
<li><a href="#rails-application-config-for-value-keys"><code>Rails.application.config_for</code> 返回 value 不再支援使用字串 keys 進行訪問。</a></li>
<li><a href="#respond-to-any-content-type">使用 <code>respond_to#any</code> 時回應的 Content-Type</a></li>
<li><a href="#activesupport-callbacks-halted-callback-hook"><code>ActiveSupport::Callbacks#halted_callback_hook</code> 現在接收第二個引數</a></li>
<li><a href="#controllers-helper-string-constantize">controllers中的<code>helper</code>類方法使用的是<code>String#constantize</code></a></li>
<li><a href="#http-https-308-http">從 HTTP 重定向到 HTTPS 現在將使用 308 HTTP 狀態程式碼</a></li>
<li><a href="#active-storage">Active Storage 現在需要影象處理</a></li>
</ul>
</li>
<li>
<a href="#rails-5-2-rails-6-0">從 Rails 5.2 升級到 Rails 6.0</a>

<ul>
<li><a href="#webpacker">使用 Webpacker</a></li>
<li><a href="#ssl">強制 SSL</a></li>
<li><a href="#cookies">目的和到期元資料現在嵌入在簽名和加密的 cookies 中以提高安全性</a></li>
<li><a href="#npm-rails">所有 npm 包都移到了 <code>@rails</code> 作用域</a></li>
<li><a href="#action-cable-javascript-api">Action Cable JavaScript API 更改</a></li>
<li><a href="#actiondispatch-response-content-type-content-type"><code>ActionDispatch::Response#content_type</code> 現在無需修改即可返回 Content-Type 標頭</a></li>
<li><a href="#">自動載入</a></li>
<li><a href="#active-storage">Active Storage 賦值行為改變</a></li>
</ul>
</li>
<li>
<a href="#rails-5-1-rails-5-2">從 Rails 5.1 升級到 Rails 5.2</a>

<ul>
<li><a href="#rails-5-1-rails-5-2">載入程式</a></li>
<li><a href="#cookie-cookies-values">簽名或加密 cookie 中的到期現在嵌入在 cookies values 中</a></li>
</ul>
</li>
<li>
<a href="#rails-5-0-rails-5-1">從 Rails 5.0 升級到 Rails 5.1</a>

<ul>
<li><a href="#hashwithindifferentaccess">頂級 <code>HashWithIndifferentAccess</code> 已軟棄用</a></li>
<li><a href="#application-secrets-keys-symbols"><code>application.secrets</code> 現在載入了所有 keys 作為 symbols</a></li>
<li><a href="#render-text-nothing">在 <code>render</code> 中刪除了對 <code>:text</code> 和 <code>:nothing</code> 的棄用支援</a></li>
<li><a href="#redirect-to-back">移除了對 <code>redirect_to :back</code> 的棄用支援</a></li>
</ul>
</li>
<li>
<a href="#rails-4-2-rails-5-0">從 Rails 4.2 升級到 Rails 5.0</a>

<ul>
<li><a href="#ruby-2-2-2">Ruby 2.2.2+ 需要</a></li>
<li><a href="#active-record-models-applicationrecord">Active Record Models 現在預設繼承自 ApplicationRecord</a></li>
<li><a href="#throw-abort-callback">通過 <code>throw(:abort)</code> 停止 Callback 鏈</a></li>
<li><a href="#activejob-applicationjob">ActiveJob 現在預設繼承自 ApplicationJob</a></li>
<li><a href="#rails-controller">Rails Controller 測試</a></li>
<li><a href="#">生產環境啟動後自動載入關閉</a></li>
<li><a href="#xml">XML 序列化</a></li>
<li><a href="#mysql">刪除了對舊版 <code>mysql</code> 資料庫介面卡的支援</a></li>
<li><a href="#">刪除了對偵錯程式的支援</a></li>
<li><a href="#bin-rails">使用 <code>bin/rails</code> 來執行任務和測試</a></li>
<li><a href="#actioncontroller-parameters-hashwithindifferentaccess"><code>ActionController::Parameters</code> 不再繼承 <code>HashWithIndifferentAccess</code></a></li>
<li><a href="#protect-from-forgery-prepend-false"><code>protect_from_forgery</code> 現在預設為 <code>prepend: false</code></a></li>
<li><a href="#raw">預設模板處理程式現在是 RAW</a></li>
<li><a href="#">添加了模板依賴的萬用字元匹配</a></li>
<li><a href="#actionview-helpers-recordtaghelper-gem-record-tag-helper"><code>ActionView::Helpers::RecordTagHelper</code> 移動到外部 gem (record_tag_helper)</a></li>
<li><a href="#protected-attributes-gem">移除了對 <code>protected_attributes</code> Gem 的支援</a></li>
<li><a href="#activerecord-deprecated-finders-gem">刪除了對 <code>activerecord-deprecated_finders</code> gem 的支援</a></li>
<li><a href="#activesupport-testcase"><code>ActiveSupport::TestCase</code> 預設測試訂單現在是隨機的</a></li>
<li><a href="#actioncontroller-live-concern"><code>ActionController::Live</code> 變成了 <code>Concern</code></a></li>
<li><a href="#">新框架預設值</a></li>
<li><a href="#json-jsonb">JSON/JSONB 序列化的變化</a></li>
</ul>
</li>
<li>
<a href="#rails-4-1-rails-4-2">從 Rails 4.1 升級到 Rails 4.2</a>

<ul>
<li><a href="#">網路控制檯</a></li>
<li><a href="#">回應者</a></li>
<li><a href="#transaction-callbacks">transaction 中的錯誤處理 callbacks</a></li>
<li><a href="#">測試用例排序</a></li>
<li><a href="#">序列化屬性</a></li>
<li><a href="#">生產日誌級別</a></li>
<li><a href="#after-bundle-rails"><code>after_bundle</code> 在 Rails 模板中</a></li>
<li><a href="#rails-html">Rails HTML 消毒劑</a></li>
<li><a href="#rails-dom">Rails DOM 測試</a></li>
<li><a href="#tokens">偽裝真實性 Tokens</a></li>
<li><a href="#action-mailer">Action Mailer</a></li>
<li><a href="#key">國外 Key 支援</a></li>
</ul>
</li>
<li>
<a href="#rails-4-0-rails-4-1">從 Rails 4.0 升級到 Rails 4.1</a>

<ul>
<li><a href="#script-csrf">遠端 <code>&lt;script&gt;</code> 標籤的 CSRF 保護</a></li>
<li><a href="#rails-4-0-rails-4-1">彈簧</a></li>
<li><a href="#config-secrets-yml"><code>config/secrets.yml</code></a></li>
<li><a href="#helper">更改以測試 helper</a></li>
<li><a href="#cookies">Cookies 序列化器</a></li>
<li><a href="#flash">Flash 結構變化</a></li>
<li><a href="#json">JSON 處理的變化</a></li>
<li><a href="#callback-return">在內聯 callback 塊中使用 <code>return</code></a></li>
<li><a href="#active-record">定義在 Active Record 夾具中的方法</a></li>
<li><a href="#i18n">I18n 強制執行可用的語言環境</a></li>
<li><a href="#relation-mutator">對 Relation 呼叫的 Mutator 方法</a></li>
<li><a href="#">預設範圍的變化</a></li>
<li><a href="#">從字串渲染內容</a></li>
<li><a href="#postgresql-json-hstore">PostgreSQL json 和 hstore 資料型別</a></li>
<li><a href="#activesupport-callbacks"><code>ActiveSupport::Callbacks</code> 的顯式塊使用</a></li>
</ul>
</li>
<li>
<a href="#rails-3-2-rails-4-0">從 Rails 3.2 升級到 Rails 4.0</a>

<ul>
<li><a href="#http">HTTP 補丁</a></li>
<li><a href="#rails-3-2-rails-4-0-gemfile">Gemfile</a></li>
<li><a href="#rails-3-2-rails-4-0-">供應商/外掛</a></li>
<li><a href="#rails-3-2-rails-4-0-active-record">Active Record</a></li>
<li><a href="#">活動資源</a></li>
<li><a href="#active-model">Active Model</a></li>
<li><a href="#action-pack">Action Pack</a></li>
<li><a href="#active-support">Active Support</a></li>
<li><a href="#helpers">Helpers 載入順序</a></li>
<li><a href="#active-record-observer-action-controller-sweeper">Active Record Observer 和 Action Controller Sweeper</a></li>
<li><a href="#rails">鏈輪-rails</a></li>
<li><a href="#sass-rails">sass-rails</a></li>
</ul>
</li>
<li>
<a href="#rails-3-1-rails-3-2">從 Rails 3.1 升級到 Rails 3.2</a>

<ul>
<li><a href="#rails-3-1-rails-3-2-gemfile">Gemfile</a></li>
<li><a href="#rails-3-1-rails-3-2-development-rb">設定/環境/development.rb</a></li>
<li><a href="#rails-3-1-rails-3-2-test-rb">設定/環境/test.rb</a></li>
<li><a href="#rails-3-1-rails-3-2">供應商/外掛</a></li>
<li><a href="#rails-3-1-rails-3-2-active-record">Active Record</a></li>
</ul>
</li>
<li>
<a href="#rails-3-0-rails-3-1">從 Rails 3.0 升級到 Rails 3.1</a>

<ul>
<li><a href="#gemfile">Gemfile</a></li>
<li><a href="#config-application-rb">config/application.rb</a></li>
<li><a href="#rails-3-0-rails-3-1-development-rb">設定/環境/development.rb</a></li>
<li><a href="#config-environments-production-rb">config/environments/production.rb</a></li>
<li><a href="#rails-3-0-rails-3-1-test-rb">設定/環境/test.rb</a></li>
<li><a href="#config-initializers-wrap-parameters-rb">config/initializers/wrap_parameters.rb</a></li>
<li><a href="#session-store-rb">設定/初始化程式/session_store.rb</a></li>
<li><a href="#views-helpers-cache-concat">移除 views 中資產 helpers 引用中的 :cache 和 :concat 選項</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id=""><a class="anchorlink" href="#">1 一般建議</a></h3><p>在嘗試升級現有應用程式之前，您應該確保有充分的升級理由。您需要平衡多個因素：對新功能的需求、為舊程式碼尋找支援的難度越來越大，以及您的可用時間和技能，僅舉幾例。</p><h4 id=""><a class="anchorlink" href="#">1.1 測試覆蓋率</a></h4><p>確保您的應用程式在升級後仍能正常工作的最佳方法是在開始該過程之前具有良好的測試覆蓋率。如果您沒有自動測試來測試您的大部分應用程式，您將需要花時間手動測試所有已更改的部分。在 Rails 升級的情況下，這意味著應用程式中的每一個功能。幫自己一個忙，確保您的測試覆蓋率良好<em>在開始升級之前</em>。</p><h4 id="ruby"><a class="anchorlink" href="#ruby">1.2 Ruby 版本</a></h4><p>Rails 在釋出時通常與最新發布的 Ruby 版本保持接近：</p>
<ul>
<li>Rails 7 需要 Ruby 2.7.0 或更新版本。</li>
<li>Rails 6 需要 Ruby 2.5.0 或更新版本。</li>
<li>Rails 5 需要 Ruby 2.2.2 或更新版本。</li>
</ul>
<p>最好分別升級 Ruby 和 Rails。可以先升級到最新的Ruby，然後再升級Rails。</p><h4 id=""><a class="anchorlink" href="#">1.3 升級過程</a></h4><p>更改 Rails 版本時，最好緩慢移動，一次一個次要版本，以充分利用棄用警告。 Rails 版本號的格式為 Major.Minor.Patch。允許主版本和次版本對公共 API 進行更改，因此這可能會導致您的應用程式出錯。補丁版本僅包含錯誤修復，不更改任何公共 API。</p><p>該過程應如下進行：</p>
<ol>
<li>編寫測試並確保它們通過。</li>
<li>移至當前版本之後的最新補丁版本。</li>
<li>修復測試和不推薦使用的功能。
4.移動到下一個次要版本的最新補丁版本。</li>
</ol>
<p>重複此過程，直到達到目標 Rails 版本。</p><h5 id=""><a class="anchorlink" href="#">1.3.1 在版本之間移動</a></h5><p>要在版本之間移動：</p><p>1.更改<code>Gemfile</code>中的Rails版本號，執行<code>bundle update</code>。
2. 更改 <code>package.json</code> 中 Rails JavaScript 包的版本並執行 <code>yarn install</code>（如果在 Webpacker 上執行）。
3. 執行<a href="#the-update-task">更新任務</a>。
4. 執行您的測試。</p><p>您可以在 <a href="https://rubygems.org/gems/rails/versions">此處</a> 中找到所有已釋出的 Rails 寶石的列表。</p><h4 id=""><a class="anchorlink" href="#">1.4 更新任務</a></h4><p>Rails 提供了 <code>rails app:update</code> 命令。更新Rails版本後
在 <code>Gemfile</code> 中，執行此命令。
這將幫助您建立新檔案和更改舊檔案
互動式session。</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>app:update
<span class="go">       exist  config
    conflict  config/application.rb
Overwrite /myapp/config/application.rb? (enter "h" for help) [Ynaqdh]
       force  config/application.rb
      create  config/initializers/new_framework_defaults_7_0.rb
</span><span class="c">...
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails app:update
">Copy</button>
</div>
<p>別忘了 review 的差異，看看有沒有什麼意想不到的變化。</p><h4 id=""><a class="anchorlink" href="#">1.5 設定框架預設值</a></h4><p>新的 Rails 版本可能具有與以前版本不同的設定預設值。但是，在執行上述步驟後，您的應用程式仍將使用<em>上一個</em> Rails 版本的設定預設值執行。這是因為 <code>config/application.rb</code> 中 <code>config.load_defaults</code> 的 value 尚未更改。</p><p>為了讓您一一升級到新的預設值，更新任務建立了一個檔案 <code>config/initializers/new_framework_defaults_X.Y.rb</code>（檔名中包含所需的 Rails 版本）。您應該通過在檔案中取消註釋來啟用新的設定預設值；這可以通過多次部署逐步完成。一旦您的應用程式準備好以新的預設值執行，您可以刪除此檔案並翻轉 <code>config.load_defaults</code> value。</p><h3 id="rails-6-1-rails-7-0"><a class="anchorlink" href="#rails-6-1-rails-7-0">2 從 Rails 6.1 升級到 Rails 7.0</a></h3><h4 id="rails-6-1-rails-7-0-"><a class="anchorlink" href="#rails-6-1-rails-7-0-">2.1 彈簧</a></h4><p>如果您的應用程式使用 Spring，則至少需要升級到 3.0.0 版本。否則你會得到</p><div class="code_container">
<pre><code class="highlight plaintext">undefined method `mechanism=' for ActiveSupport::Dependencies:Module
</code></pre>
<button class="clipboard-button" data-clipboard-text="undefined method `mechanism=' for ActiveSupport::Dependencies:Module
">Copy</button>
</div>
<p>另外，請確保在 <code>config/environments/test.rb</code> 中將 <code>config.cache_classes</code> 設定為 <code>false</code>。</p><h4 id="zeitwerk"><a class="anchorlink" href="#zeitwerk">2.2 應用程式需要在 <code>zeitwerk</code> 模式下執行</a></h4><p>仍在 <code>classic</code> 模式下執行的應用程式必須切換到 <code>zeitwerk</code> 模式。詳情請檢視<a href="https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#autoloading">Rails 6.0升級指南</a>。</p><h4 id="setter-config-autoloader"><a class="anchorlink" href="#setter-config-autoloader">2.3 setter <code>config.autoloader=</code> 已刪除</a></h4><p>Rails 7中沒有設定自動載入模式的設定點，刪除了<code>config.autoloader=</code>。如果您出於某種原因將其設定為 <code>:zeitwerk</code>，只需將其刪除即可。</p><h4 id="activesupport-dependencies-api"><a class="anchorlink" href="#activesupport-dependencies-api">2.4 <code>ActiveSupport::Dependencies</code>私有API已刪除</a></h4><p><code>ActiveSupport::Dependencies</code> 的私有 API 已被刪除。這包括像 <code>hook!</code>、<code>unhook!</code>、<code>depend_on</code>、<code>require_or_load</code>、<code>mechanism</code> 等方法。</p><p>幾個亮點：</p>
<ul>
<li>如果您使用 <code>ActiveSupport::Dependencies.constantize</code> 或 `<code>ActiveSupport::Dependencies.safe_constantize</code>, just change them to <code>String#constantize</code> or <code>String#safe_constantize</code>。</li>
</ul>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="p">.</span><span class="nf">constantize</span><span class="p">(</span><span class="s2">"User"</span><span class="p">)</span> <span class="c1"># NO LONGER POSSIBLE</span>
  <span class="s2">"User"</span><span class="p">.</span><span class="nf">constantize</span> <span class="c1"># 👍</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='  ActiveSupport::Dependencies.constantize("User") # NO LONGER POSSIBLE
  "User".constantize # 👍
'>Copy</button>
</div>

<ul>
<li><p>任何對 <code>ActiveSupport::Dependencies.mechanism</code>、reader 或 writer 的使用都必須被相應地訪問 <code>config.cache_classes</code> 替換。</p></li>
<li><p>如果要跟蹤自動載入器的活動，<code>ActiveSupport::Dependencies.verbose=</code> 不再可用，只需將 <code>Rails.autoloaders.log!</code> 扔到 <code>config/application.rb</code> 中即可。</p></li>
</ul>
<p>輔助內部類或 modules 也沒有了，例如 <code>ActiveSupport::Dependencies::Reference</code>、<code>ActiveSupport::Dependencies::Blamable</code> 等。</p><h4 id=""><a class="anchorlink" href="#">2.5 初始化期間自動載入</a></h4><p>在 <code>to_prepare</code> 塊之外的初始化期間自動載入可過載常量的應用程式解除安裝了這些常量，並且自 Rails 6.0 以來發出了此警告：</p><div class="code_container">
<pre><code class="highlight plaintext">DEPRECATION WARNING: Initialization autoloaded the constant ....

Being able to do this is deprecated. Autoloading during initialization is going
to be an error condition in future versions of Rails.

...
</code></pre>
<button class="clipboard-button" data-clipboard-text="DEPRECATION WARNING: Initialization autoloaded the constant ....

Being able to do this is deprecated. Autoloading during initialization is going
to be an error condition in future versions of Rails.

...
">Copy</button>
</div>
<p>如果您仍然在日誌中收到此警告，請檢視 <a href="https://guides.rubyonrails.org/v7.0/autoloading_and_reloading_constants.html#autoloading-when-the-application-boots">自動載入指南</a> 中有關應用程式啟動時自動載入的部分。否則，您將在 Rails 7 中獲得 <code>NameError</code>。</p><h4 id="config-autoload-once-paths"><a class="anchorlink" href="#config-autoload-once-paths">2.6 能夠設定 <code>config.autoload_once_paths</code></a></h4><p><code>config.autoload_once_paths</code> 可以在 <code>config/application.rb</code> 中定義的應用程式類的主體中設定，也可以在 <code>config/environments/*</code> 中的環境設定中設定。</p><p>類似地，引擎可以在引擎類的類主體或環境設定中設定該集合。</p><p>之後，集合被凍結，您可以從這些路徑自動載入。特別是，您可以在初始化期間從那裡自動載入。它們由 <code>Rails.autoloaders.once</code> 自動載入器管理，它不會重新載入，只會自動載入/急切載入。</p><p>如果您在處理環境設定後設定了此設定並且正在獲取 <code>FrozenError</code>，請移動程式碼。</p><h4 id="actiondispatch-request-content-type-content-type"><a class="anchorlink" href="#actiondispatch-request-content-type-content-type">2.7 <code>ActionDispatch::Request#content_type</code> 現在原樣返回 Content-Type 標頭。</a></h4><p>以前， <code>ActionDispatch::Request#content_type</code> 返回的 value 不包含字符集部分。
此行為更改為返回的包含字符集部分的 Content-Type 標頭。</p><p>如果您只需要 MIME 型別，請改用 <code>ActionDispatch::Request#media_type</code>。</p><p>前：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">request</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"CONTENT_TYPE"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">,</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='request = ActionDispatch::Request.new("CONTENT_TYPE" =&gt; "text/csv; header=present; charset=utf-16", "REQUEST_METHOD" =&gt; "GET")
request.content_type #=&gt; "text/csv"
'>Copy</button>
</div>
<p>後：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">request</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">,</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present; charset=utf-16"</span>
<span class="n">request</span><span class="p">.</span><span class="nf">media_type</span>   <span class="c1">#=&gt; "text/csv"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='request = ActionDispatch::Request.new("Content-Type" =&gt; "text/csv; header=present; charset=utf-16", "REQUEST_METHOD" =&gt; "GET")
request.content_type #=&gt; "text/csv; header=present; charset=utf-16"
request.media_type   #=&gt; "text/csv"
'>Copy</button>
</div>
<h4 id="key-sha256"><a class="anchorlink" href="#key-sha256">2.8 Key 產生器摘要類更改為使用 SHA256</a></h4><p>key 產生器的預設摘要類正在從 SHA1 更改為 SHA256。
這會對 Rails 產生的任何加密訊息產生影響，包括
加密的 cookies。</p><p>為了能夠使用舊的摘要類讀取訊息，有必要
註冊一個旋轉器。</p><p>以下是加密的 cookies 的旋轉器示例。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">cookies_rotations</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">cookies</span><span class="o">|</span>
  <span class="n">salt</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">authenticated_encrypted_cookie_salt</span>
  <span class="n">secret_key_base</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">.</span><span class="nf">secret_key_base</span>

  <span class="n">key_generator</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">KeyGenerator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
    <span class="n">secret_key_base</span><span class="p">,</span> <span class="ss">iterations: </span><span class="mi">1000</span><span class="p">,</span> <span class="ss">hash_digest_class: </span><span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span>
  <span class="p">)</span>
  <span class="n">key_len</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">MessageEncryptor</span><span class="p">.</span><span class="nf">key_len</span>
  <span class="n">secret</span> <span class="o">=</span> <span class="n">key_generator</span><span class="p">.</span><span class="nf">generate_key</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">key_len</span><span class="p">)</span>

  <span class="n">cookies</span><span class="p">.</span><span class="nf">rotate</span> <span class="ss">:encrypted</span><span class="p">,</span> <span class="n">secret</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.config.action_dispatch.cookies_rotations.tap do |cookies|
  salt = Rails.application.config.action_dispatch.authenticated_encrypted_cookie_salt
  secret_key_base = Rails.application.secrets.secret_key_base

  key_generator = ActiveSupport::KeyGenerator.new(
    secret_key_base, iterations: 1000, hash_digest_class: OpenSSL::Digest::SHA1
  )
  key_len = ActiveSupport::MessageEncryptor.key_len
  secret = key_generator.generate_key(salt, key_len)

  cookies.rotate :encrypted, secret
end
">Copy</button>
</div>
<h4 id="activesupport-sha256"><a class="anchorlink" href="#activesupport-sha256">2.9 ActiveSupport 的摘要類::摘要更改為 SHA256</a></h4><p>ActiveSupport::Digest 的預設摘要類從 SHA1 更改為 SHA256。
這會對 Etags 之類的東西產生影響，這些東西也會改變和快取 keys。
更改這些 keys 會影響快取命中率，所以要小心謹慎
為此，在升級到新雜湊時。</p><h4 id="activesupport-cache"><a class="anchorlink" href="#activesupport-cache">2.10 新的 ActiveSupport::Cache 序列化格式</a></h4><p>引入了更快、更緊湊的序列化格式。</p><p>要啟用它，您必須設定 <code>config.active_support.cache_format_version = 7.0</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 設定/應用程式.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.1</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">cache_format_version</span> <span class="o">=</span> <span class="mf">7.0</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 設定/應用程式.rb

config.load_defaults 6.1
config.active_support.cache_format_version = 7.0
">Copy</button>
</div>
<p>或者乾脆：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 設定/應用程式.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">7.0</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 設定/應用程式.rb

config.load_defaults 7.0
">Copy</button>
</div>
<p>但是 Rails 6.1 應用程式無法讀取這種新的序列化格式，
所以為了確保無縫升級，您必須首先部署 Rails 7.0 升級
<code>config.active_support.cache_format_version = 6.1</code>，然後只有一次全部 Rails
流程已更新您可以設定<code>config.active_support.cache_format_version = 7.0</code>。</p><p>Rails 7.0 能夠讀取這兩種格式，因此快取不會在
升級。</p><h4 id="activestorage-preview"><a class="anchorlink" href="#activestorage-preview">2.11 ActiveStorage 視訊 preview 影象產生</a></h4><p>視訊 preview 影象產生現在使用 FFmpeg 的場景變化檢測來產生
更有意義的 preview 影象。以前將使用視訊的第一幀
如果視訊從黑色淡入，就會導致問題。這種變化需要
FFmpeg v3.4+。</p><h4 id="activestorage-vips"><a class="anchorlink" href="#activestorage-vips">2.12 ActiveStorage 變體處理器更改為 :vips</a></h4><p>影象轉換現在將使用 libvips 而不是 ImageMagick。這將減少
產生變體所需的時間以及 CPU 和記憶體使用率，從而改善回應
依賴 active storage 來提供影象的應用程式中的次數。</p><p><code>:mini_magick</code> 選項沒有被棄用，所以可以繼續使用它。</p><p>遷移到 libvips 需要將現有的影象轉換程式碼更改為
<code>image_processing</code> 巨集，並用 libvips 的選項替換 ImageMagick 的選項。</p><h5 id="resize-to-limit-resize"><a class="anchorlink" href="#resize-to-limit-resize">2.12.1 用 resize_to_limit 替換 resize</a></h5><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(resize: "100x")
</span><span class="gi">+ variant(resize_to_limit: [100, nil])
</span></code></pre>
<button class="clipboard-button" data-clipboard-text='- variant(resize: "100x")
+ variant(resize_to_limit: [100, nil])
'>Copy</button>
</div>
<p>如果你忘記這樣做，當你切換到vips時你會看到這個錯誤：<code>no implicit conversion to float from string</code>。</p><h5 id=""><a class="anchorlink" href="#">2.12.2 裁剪時使用陣列</a></h5><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(crop: "1920x1080+0+0")
</span><span class="gi">+ variant(crop: [0, 0, 1920, 1080])
</span></code></pre>
<button class="clipboard-button" data-clipboard-text='- variant(crop: "1920x1080+0+0")
+ variant(crop: [0, 0, 1920, 1080])
'>Copy</button>
</div>
<p>如果你忘記這樣做，當你切換到vips時你會看到這個錯誤：<code>unable to call crop: you supplied 2 arguments, but operation needs 5</code>。</p><h5 id="values"><a class="anchorlink" href="#values">2.12.3 夾住你的作物 values：</a></h5><p>Vips 在裁剪方面比 ImageMagick 更嚴格：
1. 如果 <code>x</code> 和/或 <code>y</code> 為負 values，則不會裁剪。例如：<code>[-10, -10, 100, 100]</code>
2.如果位置（<code>x</code>或<code>y</code>）加上裁剪尺寸（<code>width</code>，<code>height</code>）大於影象，則不會裁剪。例如：一個 125x125 的影象和一個 <code>[50, 50, 100, 100]</code> 的裁剪</p><p>如果你忘記這樣做，當你切換到vips時你會看到這個錯誤：<code>extract_area: bad extract area</code></p><h5 id="resize-pad"><a class="anchorlink" href="#resize-pad">2.12.4 調整resize和pad使用的背景色</a></h5><p>Vips 使用黑色作為預設背景色 <code>resize_and_pad</code>，而不是像 ImageMagick 那樣的白色。使用 <code>background</code> 選項修復該問題：
<code>diff
- variant(resize_and_pad: [300, 300])
+ variant(resize_and_pad: [300, 300, background: [255]])
</code></p><h5 id="exif"><a class="anchorlink" href="#exif">2.12.5 刪除任何根據 EXIF 的旋轉</a></h5><p>Vips 將在處理變體時使用 EXIF 值自動旋轉影象。如果您從使用者上傳的照片中儲存旋轉 values 以使用 ImageMagick 應用旋轉，則必須停止這樣做：
<code>diff
- variant(format: :jpg, rotate: rotation_value)
+ variant(format: :jpg)
</code></p><h5 id=""><a class="anchorlink" href="#">2.12.6 用色彩空間替換單色</a></h5><p>Vips 使用不同的選項來製作單色影象：
<code>diff
- variant(monochrome: true)
+ variant(colourspace: "b-w")
</code></p><h5 id="libvips"><a class="anchorlink" href="#libvips">2.12.7 切換到用於壓縮影象的 libvips 選項</a></h5><p>JPEG格式
<code>diff
- variant(strip: true, quality: 80, interlace: "JPEG", sampling_factor: "4:2:0", colorspace: "sRGB")
+ variant(saver: { strip: true, quality: 80, interlace: true })
</code></p><p>PNG
<code>diff
- variant(strip: true, quality: 75)
+ variant(saver: { strip: true, compression: 9 })
</code></p><p>網路
<code>diff
- variant(strip: true, quality: 75, define: { webp: { lossless: false, alpha_quality: 85, thread_level: 1 } })
+ variant(saver: { strip: true, quality: 75, lossless: false, alpha_q: 85, reduction_effort: 6, smart_subsample: true })
</code></p><p>動圖
<code>diff
- variant(layers: "Optimize")
+ variant(saver: { optimize_gif_frames: true, optimize_gif_transparency: true })
</code></p><h5 id=""><a class="anchorlink" href="#">2.12.8 部署到生產</a></h5><p>Active Storage 將必須執行的轉換列表編碼到影象的 url 中。
如果您的應用程式正在快取這些 url，則在您將新程式碼部署到生產環境後，您的影象將中斷。
因此，您必須手動使受影響的快取 keys 無效。</p><p>例如，如果您在 view 中有這樣的內容：
<code>rhtml
&lt;% @products.each do |product| %&gt;
  &lt;% cache product do %&gt;
    &lt;%= image_tag product.cover_photo.variant(resize: "200x") %&gt;
  &lt;% end %&gt;
&lt;% end %&gt;
</code></p><p>您可以通過觸控產品或更改快取 key 來使快取無效：
<code>rhtml
&lt;% @products.each do |product| %&gt;
  &lt;% cache ["v2", product] do %&gt;
    &lt;%= image_tag product.cover_photo.variant(resize_to_limit: [200, nill]) %&gt;
  &lt;% end %&gt;
&lt;% end %&gt;
</code></p><h3 id="rails-6-0-rails-6-1"><a class="anchorlink" href="#rails-6-0-rails-6-1">3 從 Rails 6.0 升級到 Rails 6.1</a></h3><p>有關對 Rails 6.1 所做更改的更多資訊，請參閱 <a href="6_1_release_notes.html">發行說明</a>。</p><h4 id="rails-application-config-for-value-keys"><a class="anchorlink" href="#rails-application-config-for-value-keys">3.1 <code>Rails.application.config_for</code> 返回 value 不再支援使用字串 keys 進行訪問。</a></h4><p>給定一個這樣的設定檔案：</p><div class="code_container">
<pre><code class="highlight yaml"><span class="c1"># 設定/example.yml</span>
<span class="na">development</span><span class="pi">:</span>
  <span class="na">options</span><span class="pi">:</span>
    <span class="na">key</span><span class="pi">:</span> <span class="s">value</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 設定/example.yml
development:
  options:
    key: value
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config_for</span><span class="p">(</span><span class="ss">:example</span><span class="p">).</span><span class="nf">options</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.config_for(:example).options
">Copy</button>
</div>
<p>這用於返回一個雜湊，您可以在該雜湊上使用字串 keys 訪問 values。這在 6.0 中已被棄用，現在不再起作用。</p><p>如果您仍然想使用字串 keys 訪問 values，您可以在 <code>config_for</code> 的返回值上呼叫 <code>with_indifferent_access</code>，例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config_for</span><span class="p">(</span><span class="ss">:example</span><span class="p">).</span><span class="nf">with_indifferent_access</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">'options'</span><span class="p">,</span> <span class="s1">'key'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.config_for(:example).with_indifferent_access.dig('options', 'key')
">Copy</button>
</div>
<h4 id="respond-to-any-content-type"><a class="anchorlink" href="#respond-to-any-content-type">3.2 使用 <code>respond_to#any</code> 時回應的 Content-Type</a></h4><p>回應中返回的 Content-Type 標頭可能與 Rails 6.0 返回的不同，
更具體地說，如果您的應用程式使用 <code>respond_to { |format| format.any }</code>。
Content-Type 現在將根據給定的塊而不是請求的格式。</p><p>例子：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">my_action</span>
  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
    <span class="nb">format</span><span class="p">.</span><span class="nf">any</span> <span class="p">{</span> <span class="n">render</span><span class="p">(</span><span class="ss">json: </span><span class="p">{</span> <span class="ss">foo: </span><span class="s1">'bar'</span> <span class="p">})</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="def my_action
  respond_to do |format|
    format.any { render(json: { foo: 'bar' }) }
  end
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span><span class="p">(</span><span class="s1">'my_action.csv'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="get('my_action.csv')
">Copy</button>
</div>
<p>以前的行為是返回 <code>text/csv</code> 回應的 Content-Type，這是不準確的，因為正在呈現 JSON 回應。
當前行為正確返回 <code>application/json</code> 回應的內容型別。</p><p>如果您的應用程式依賴於之前的錯誤行為，我們鼓勵您指定
您的 action 接受哪種格式，即</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">format</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="ss">:xml</span><span class="p">,</span> <span class="ss">:json</span><span class="p">)</span> <span class="p">{</span> <span class="n">render</span> <span class="n">request</span><span class="p">.</span><span class="nf">format</span><span class="p">.</span><span class="nf">to_sym</span> <span class="o">=&gt;</span> <span class="vi">@people</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="format.any(:xml, :json) { render request.format.to_sym =&gt; @people }
">Copy</button>
</div>
<h4 id="activesupport-callbacks-halted-callback-hook"><a class="anchorlink" href="#activesupport-callbacks-halted-callback-hook">3.3 <code>ActiveSupport::Callbacks#halted_callback_hook</code> 現在接收第二個引數</a></h4><p>Active Support 允許您在 callback 時覆蓋 <code>halted_callback_hook</code>
停止鏈條。此方法現在接收第二個引數，即被暫停的 callback 的名稱。
如果您有覆蓋此方法的類，請確保它接受兩個引數。請注意，這是一箇中斷
在沒有預先棄用週期的情況下更改（出於效能原因）。</p><p>例子：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before_create</span> <span class="p">{</span> <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="p">}</span>

  <span class="k">def</span> <span class="nf">halted_callback_hook</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">callback_name</span><span class="p">)</span> <span class="c1"># =&gt; This method now accepts 2 arguments instead of 1</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Book couldn't be </span><span class="si">#{</span><span class="n">callback_name</span><span class="si">}</span><span class="s2">d"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  before_save { throw(:abort) }
  before_create { throw(:abort) }

  def halted_callback_hook(filter, callback_name) # =&gt; This method now accepts 2 arguments instead of 1
    Rails.logger.info(&quot;Book couldn't be #{callback_name}d&quot;)
  end
end
">Copy</button>
</div>
<h4 id="controllers-helper-string-constantize"><a class="anchorlink" href="#controllers-helper-string-constantize">3.4 controllers中的<code>helper</code>類方法使用的是<code>String#constantize</code></a></h4><p>從概念上講，在 Rails 6.1 之前</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">helper</span> <span class="s2">"foo/bar"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='helper "foo/bar"
'>Copy</button>
</div>
<p>導致</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">require_dependency</span> <span class="s2">"foo/bar_helper"</span>
<span class="n">module_name</span> <span class="o">=</span> <span class="s2">"foo/bar_helper"</span><span class="p">.</span><span class="nf">camelize</span>
<span class="n">module_name</span><span class="p">.</span><span class="nf">constantize</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='require_dependency "foo/bar_helper"
module_name = "foo/bar_helper".camelize
module_name.constantize
'>Copy</button>
</div>
<p>現在它改為這樣做：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">prefix</span> <span class="o">=</span> <span class="s2">"foo/bar"</span><span class="p">.</span><span class="nf">camelize</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">Helper"</span><span class="p">.</span><span class="nf">constantize</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='prefix = "foo/bar".camelize
"#{prefix}Helper".constantize
'>Copy</button>
</div>
<p>此更改向後相容大多數應用程式，在這種情況下，您無需執行任何操作。</p><p>但是，從技術上講，controllers 可以將 <code>helpers_path</code> 設定為指向 <code>$LOAD_PATH</code> 中不在自動載入路徑中的目錄。開箱即用不再支援該用例。如果 helper module 不可自動載入，則應用程式負責在呼叫 <code>helper</code> 之前載入它。</p><h4 id="http-https-308-http"><a class="anchorlink" href="#http-https-308-http">3.5 從 HTTP 重定向到 HTTPS 現在將使用 308 HTTP 狀態程式碼</a></h4><p>將非 GET/HEAD 請求從 HTTP 重定向到 HTTPS 時，在 <code>ActionDispatch::SSL</code> 中使用的預設 HTTP 狀態程式碼已更改為 <a href="https://tools.ietf.org/html/rfc7538">https://tools.ietf.org/html/rfc7538</a> 中定義的 <code>308</code>。</p><h4 id="active-storage"><a class="anchorlink" href="#active-storage">3.6 Active Storage 現在需要影象處理</a></h4><p>在 Active Storage 中處理變體時，現在需要捆綁 <a href="https://github.com/janko-m/image_processing">image_processing gem</a> 而不是直接使用 <code>mini_magick</code>。影象處理預設設定為在幕後使用 <code>mini_magick</code>，因此最簡單的升級方法是將 <code>mini_magick</code> gem 替換為 <code>image_processing</code> gem，並確保刪除 <code>combine_options</code> 的顯式使用，因為它不再需要。</p><p>為了便於閱讀，您可能希望將原始 <code>resize</code> 呼叫更改為 <code>image_processing</code> 巨集。例如，而不是：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100"</span><span class="p">)</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100&gt;"</span><span class="p">)</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100^"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='video.preview(resize: "100x100")
video.preview(resize: "100x100&gt;")
video.preview(resize: "100x100^")
'>Copy</button>
</div>
<p>你可以分別做：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_fit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_fill: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="video.preview(resize_to_fit: [100, 100])
video.preview(resize_to_limit: [100, 100])
video.preview(resize_to_fill: [100, 100])
">Copy</button>
</div>
<h3 id="rails-5-2-rails-6-0"><a class="anchorlink" href="#rails-5-2-rails-6-0">4 從 Rails 5.2 升級到 Rails 6.0</a></h3><p>有關對 Rails 6.0 所做更改的更多資訊，請參閱 <a href="6_0_release_notes.html">發行說明</a>。</p><h4 id="webpacker"><a class="anchorlink" href="#webpacker">4.1 使用 Webpacker</a></h4><p><a href="https://github.com/rails/webpacker">Webpacker</a>
是 Rails 6 的預設 JavaScript 編譯器。但是如果您正在升級應用程式，則預設情況下不會啟用它。
如果您想使用 Webpacker，請將其包含在您的 Gemfile 中並安裝它：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"webpacker"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='gem "webpacker"
'>Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>webpacker:install
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails webpacker:install
">Copy</button>
</div>
<h4 id="ssl"><a class="anchorlink" href="#ssl">4.2 強制 SSL</a></h4><p>controllers 上的 <code>force_ssl</code> 方法已被棄用，將在
Rails 6.1。鼓勵您啟用 <code>config.force_ssl</code> 以強制執行 HTTPS
整個應用程式的連線。如果您需要免除某些端點
從重定向，您可以使用 <code>config.ssl_options</code> 來設定該行為。</p><h4 id="cookies"><a class="anchorlink" href="#cookies">4.3 目的和到期元資料現在嵌入在簽名和加密的 cookies 中以提高安全性</a></h4><p>為了提高安全性，Rails 將用途和到期元資料嵌入到加密或簽名的 cookies value 中。</p><p>Rails 然後可以阻止試圖複製簽名/加密的 value 的攻擊
一個 cookie 並將其用作另一個 cookie 的 value。</p><p>這個新的嵌入元資料使那些 cookies 與早於 6.0 的 Rails 版本不相容。</p><p>如果您需要 cookies 5.2 及更早版本讀取 cookies，或者您仍在驗證 6.0 部署並希望
能夠回滾設定
<code>Rails.application.config.action_dispatch.use_cookies_with_metadata</code> 到 <code>false</code>。</p><h4 id="npm-rails"><a class="anchorlink" href="#npm-rails">4.4 所有 npm 包都移到了 <code>@rails</code> 作用域</a></h4><p>如果您之前載入了 <code>actioncable</code>、<code>activestorage</code> 中的任何一個，
或者 <code>rails-ujs</code> 包通過 npm/yarn，你必須更新這些的名字
將依賴項升級到 <code>6.0.0</code> 之前：</p><div class="code_container">
<pre><code class="highlight plaintext">actioncable   → @rails/actioncable
activestorage → @rails/activestorage
rails-ujs     → @rails/ujs
</code></pre>
<button class="clipboard-button" data-clipboard-text="actioncable   → @rails/actioncable
activestorage → @rails/activestorage
rails-ujs     → @rails/ujs
">Copy</button>
</div>
<h4 id="action-cable-javascript-api"><a class="anchorlink" href="#action-cable-javascript-api">4.5 Action Cable JavaScript API 更改</a></h4><p>Action Cable JavaScript 包已從 CoffeeScript 轉換而來
到 ES2015，我們現在在 npm 發行版中釋出原始碼。</p><p>此版本包括對可選部分的一些重大更改
Action Cable JavaScript API：</p>
<ul>
<li>
<p>WebSocket 介面卡和記錄器介面卡的設定已被移動
從 <code>ActionCable</code> 的屬性到 <code>ActionCable.adapters</code> 的屬性。
如果您正在設定這些介面卡，您將需要製作
這些變化：</p>
<div class="code_container">
<pre><code class="highlight diff"><span class="gd">-    ActionCable.WebSocket = MyWebSocket
</span><span class="gi">+    ActionCable.adapters.WebSocket = MyWebSocket
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="-    ActionCable.WebSocket = MyWebSocket
+    ActionCable.adapters.WebSocket = MyWebSocket
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight diff"><span class="gd">-    ActionCable.logger = myLogger
</span><span class="gi">+    ActionCable.adapters.logger = myLogger
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="-    ActionCable.logger = myLogger
+    ActionCable.adapters.logger = myLogger
">Copy</button>
</div>
</li>
<li>
<p><code>ActionCable.startDebugging()</code> 和 <code>ActionCable.stopDebugging()</code>
方法已被刪除並替換為屬性
<code>ActionCable.logger.enabled</code>。如果您正在使用這些方法
將需要進行這些更改：</p>
<div class="code_container">
<pre><code class="highlight diff"><span class="gd">-    ActionCable.startDebugging()
</span><span class="gi">+    ActionCable.logger.enabled = true
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="-    ActionCable.startDebugging()
+    ActionCable.logger.enabled = true
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight diff"><span class="gd">-    ActionCable.stopDebugging()
</span><span class="gi">+    ActionCable.logger.enabled = false
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="-    ActionCable.stopDebugging()
+    ActionCable.logger.enabled = false
">Copy</button>
</div>
</li>
</ul>
<h4 id="actiondispatch-response-content-type-content-type"><a class="anchorlink" href="#actiondispatch-response-content-type-content-type">4.6 <code>ActionDispatch::Response#content_type</code> 現在無需修改即可返回 Content-Type 標頭</a></h4><p>以前， <code>ActionDispatch::Response#content_type</code> 的返回 value 不包含字符集部分。
此行為已更改為包括先前省略的字符集部分。</p><p>如果您只需要 MIME 型別，請改用 <code>ActionDispatch::Response#media_type</code>。</p><p>前：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resp</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='resp = ActionDispatch::Response.new(200, "Content-Type" =&gt; "text/csv; header=present; charset=utf-16")
resp.content_type #=&gt; "text/csv; header=present"
'>Copy</button>
</div>
<p>後：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resp</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present; charset=utf-16"</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">media_type</span>   <span class="c1">#=&gt; "text/csv"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='resp = ActionDispatch::Response.new(200, "Content-Type" =&gt; "text/csv; header=present; charset=utf-16")
resp.content_type #=&gt; "text/csv; header=present; charset=utf-16"
resp.media_type   #=&gt; "text/csv"
'>Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">4.7 自動載入</a></h4><p>Rails 6 預設設定</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 設定/應用程式.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.0</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 設定/應用程式.rb

config.load_defaults 6.0
">Copy</button>
</div>
<p>在 CRuby 上啟用 <code>zeitwerk</code> 自動載入模式。在這種模式下，自動載入、重新載入和預先載入由 <a href="https://github.com/fxn/zeitwerk">Zeitwerk</a> 管理。</p><h5 id=""><a class="anchorlink" href="#">4.7.1 公共介面</a></h5><p>一般來說，應用程式不需要直接使用 Zeitwerk 的 API。 Rails 根據現有合約進行設定：<code>config.autoload_paths</code>、<code>config.cache_classes</code> 等。</p><p>雖然應用程式應該堅持該介面，但實際的 Zeitwerk 載入器物件可以作為</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">main</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.autoloaders.main
">Copy</button>
</div>
<p>例如，如果您需要預載入單表繼承 (STI) 類或設定自定義變形器，這可能會很方便。</p><h5 id=""><a class="anchorlink" href="#">4.7.2 專案結構</a></h5><p>如果正在升級的應用程式正確自動載入，則專案結構應該已經基本相容。</p><p>但是，<code>classic</code> 模式從缺少的常量名 (<code>underscore</code>) 推斷檔名，而 <code>zeitwerk</code> 模式從檔名 (<code>camelize</code>) 推斷常量名。這些 helpers 並不總是彼此相反，尤其是在涉及首字母縮略詞時。例如，<code>"FOO".underscore</code> 是 <code>"foo"</code>，但 <code>"foo".camelize</code> 是 <code>"Foo"</code>，而不是 <code>"FOO"</code>。</p><p>可以使用 <code>zeitwerk:check</code> 任務檢查相容性：</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>zeitwerk:check
<span class="go">Hold on, I am eager loading the application.
All is good!
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails zeitwerk:check
">Copy</button>
</div>
<h5 id="require-dependency"><a class="anchorlink" href="#require-dependency">4.7.3 require_dependency</a></h5><p><code>require_dependency</code> 的所有已知用例都已消除，您應該 grep 專案並刪除它們。</p><p>如果您的應用程式使用單表繼承，請參閱自動載入和重新載入常量（Zeitwerk 模式）指南的<a href="autoloading_and_reloading_constants.html#single-table-inheritance">單表繼承部分</a>。</p><h5 id="module"><a class="anchorlink" href="#module">4.7.4 類中的限定名稱和 module 定義</a></h5><p>您現在可以在類和 module 定義中穩健地使用常量路徑：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 這個類的主體中的自動載入現在匹配 Ruby 語義。</span>
<span class="k">class</span> <span class="nc">Admin::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 這個類的主體中的自動載入現在匹配 Ruby 語義。
class Admin::UsersController &lt; ApplicationController
  # ...
end
">Copy</button>
</div>
<p>需要注意的一個問題是，根據執行順序，經典的自動載入器有時可以自動載入 <code>Foo::Wadus</code></p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Foo::Bar</span>
  <span class="nc">Wadus</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Foo::Bar
  Wadus
end
">Copy</button>
</div>
<p>這與 Ruby 語義不匹配，因為 <code>Foo</code> 不在巢狀中，並且在 <code>zeitwerk</code> 模式下根本不起作用。如果您發現這樣的極端情況，您可以使用限定名稱 <code>Foo::Wadus</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Foo::Bar</span>
  <span class="nc">Foo::Wadus</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Foo::Bar
  Foo::Wadus
end
">Copy</button>
</div>
<p>或將 <code>Foo</code> 新增到巢狀中：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Foo</span>
  <span class="k">class</span> <span class="nc">Bar</span>
    <span class="no">Wadus</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module Foo
  class Bar
    Wadus
  end
end
">Copy</button>
</div>
<h5 id=""><a class="anchorlink" href="#">4.7.5 關注點</a></h5><p>您可以從標準結構自動載入和預先載入，例如</p><div class="code_container">
<pre><code class="highlight plaintext">app/models
app/models/concerns
</code></pre>
<button class="clipboard-button" data-clipboard-text="app/models
app/models/concerns
">Copy</button>
</div>
<p>在這種情況下，<code>app/models/concerns</code> 被假定為根目錄（因為它屬於自動載入路徑），並且它作為名稱空間被忽略。所以，<code>app/models/concerns/foo.rb</code> 應該定義 <code>Foo</code>，而不是 <code>Concerns::Foo</code>。</p><p><code>Concerns::</code> 名稱空間與經典自動載入器一起作為實現的副作用，但這並不是真正的預期行為。使用 <code>Concerns::</code> 的應用程式需要重新命名這些類和 modules 才能在 <code>zeitwerk</code> 模式下執行。</p><h5 id="app"><a class="anchorlink" href="#app">4.7.6 在自動載入路徑中有 <code>app</code></a></h5><p>一些專案想要像 <code>app/api/base.rb</code> 這樣的東西來定義 <code>API::Base</code>，並將 <code>app</code> 新增到自動載入路徑中以在 <code>classic</code> 模式下完成。由於Rails自動將<code>app</code>的所有子目錄新增到自動載入路徑中，我們還有另一種情況，其中存在巢狀的根目錄，因此設定不再起作用。類似的原理我們在上面用 <code>concerns</code> 解釋過。</p><p>如果要保留該結構，則需要從初始化程式的自動載入路徑中刪除子目錄：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="p">.</span><span class="nf">autoload_paths</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/app/api"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='ActiveSupport::Dependencies.autoload_paths.delete("#{Rails.root}/app/api")
'>Copy</button>
</div>
<h5 id=""><a class="anchorlink" href="#">4.7.7 自動載入常量和顯式名稱空間</a></h5><p>如果在檔案中定義了名稱空間，則此處為 <code>Hotel</code>：</p><div class="code_container">
<pre><code class="highlight plaintext">app/models/hotel.rb         # Defines Hotel.
app/models/hotel/pricing.rb # Defines Hotel::Pricing.
</code></pre>
<button class="clipboard-button" data-clipboard-text="app/models/hotel.rb         # Defines Hotel.
app/models/hotel/pricing.rb # Defines Hotel::Pricing.
">Copy</button>
</div>
<p>必須使用 <code>class</code> 或 <code>module</code> keywords 設定 <code>Hotel</code> 常量。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Hotel</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Hotel
end
">Copy</button>
</div>
<p>很好。</p><p>替代品，如</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Hotel</span> <span class="o">=</span> <span class="no">Class</span><span class="p">.</span><span class="nf">new</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Hotel = Class.new
">Copy</button>
</div>
<p>或者</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Hotel</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Hotel = Struct.new
">Copy</button>
</div>
<p>不會工作，不會找到像 <code>Hotel::Pricing</code> 這樣的子物件。</p><p>此限制僅適用於顯式名稱空間。沒有定義名稱空間的類和 modules 可以使用這些習語來定義。</p><h5 id=""><a class="anchorlink" href="#">4.7.8 一個檔案，一個常量（在同一個頂層）</a></h5><p>在 <code>classic</code> 模式下，您可以在技術上在同一頂級定義幾個常量，並重新載入它們。例如，給定</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/foo.rb</span>

<span class="k">class</span> <span class="nc">Foo</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Bar</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/models/foo.rb

class Foo
end

class Bar
end
">Copy</button>
</div>
<p>雖然 <code>Bar</code> 無法自動載入，但自動載入 <code>Foo</code> 也會將 <code>Bar</code> 標記為自動載入。 <code>zeitwerk</code>模式下不是這樣，需要將<code>Bar</code>移動到自己的檔案<code>bar.rb</code>中。一個檔案，一個常量。</p><p>這僅影響與上面示例中相同的頂層的常量。內部類和 modules 很好。例如，考慮</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/foo.rb</span>

<span class="k">class</span> <span class="nc">Foo</span>
  <span class="k">class</span> <span class="nc">InnerClass</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/models/foo.rb

class Foo
  class InnerClass
  end
end
">Copy</button>
</div>
<p>如果應用程式重新載入 <code>Foo</code>，它也會重新載入 <code>Foo::InnerClass</code>。</p><h5 id="spring-test"><a class="anchorlink" href="#spring-test">4.7.9 Spring 和 <code>test</code> 環境</a></h5><p>如果發生變化，Spring 會重新載入應用程式程式碼。在 <code>test</code> 環境中，您需要啟用重新載入才能正常工作：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 設定/環境/test.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">cache_classes</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 設定/環境/test.rb

config.cache_classes = false
">Copy</button>
</div>
<p>否則你會得到這個錯誤：</p><div class="code_container">
<pre><code class="highlight plaintext">reloading is disabled because config.cache_classes is true
</code></pre>
<button class="clipboard-button" data-clipboard-text="reloading is disabled because config.cache_classes is true
">Copy</button>
</div>
<h5 id="-"><a class="anchorlink" href="#-">4.7.10 載入程式</a></h5><p>Bootsnap 至少應為 1.4.2 版。</p><p>除此之外，如果執行 Ruby 2.5，由於直譯器中的錯誤，Bootsnap 需要禁用 iseq 快取。在這種情況下，請確保至少依賴 Bootsnap 1.4.4。</p><h5 id="config-add-autoload-paths-to-load-path"><a class="anchorlink" href="#config-add-autoload-paths-to-load-path">4.7.11 <code>config.add_autoload_paths_to_load_path</code></a></h5><p>新的設定點</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">add_autoload_paths_to_load_path</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.add_autoload_paths_to_load_path
">Copy</button>
</div>
<p>預設情況下為 <code>true</code> 以實現向後相容性，但允許您選擇退出將自動載入路徑新增到 <code>$LOAD_PATH</code>。</p><p>這在大多數應用程式中是有意義的，因為您永遠不應該需要 <code>app/models</code> 中的檔案，例如，Zeitwerk 僅在內部使用絕對檔名。</p><p>通過選擇退出，您可以優化 <code>$LOAD_PATH</code> 查詢（要檢查的目錄更少），並節省 Bootsnap 工作和記憶體消耗，因為它不需要為這些目錄構建索引。</p><h5 id=""><a class="anchorlink" href="#">4.7.12 執行緒安全</a></h5><p>在經典模式下，常量自動載入不是執行緒安全的，儘管 Rails 有鎖定，例如在啟用自動載入時使 Web 請求執行緒安全，因為它在開發環境中很常見。</p><p>恆定自動載入在 <code>zeitwerk</code> 模式下是執行緒安全的。例如，您現在可以在由 <code>runner</code> 命令執行的多執行緒指令碼中自動載入。</p><h5 id="config-autoload-paths-glob"><a class="anchorlink" href="#config-autoload-paths-glob">4.7.13 config.autoload_paths 中的 Glob</a></h5><p>當心像這樣的設定</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">+=</span> <span class="no">Dir</span><span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib/**/"</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='config.autoload_paths += Dir["#{config.root}/lib/**/"]
'>Copy</button>
</div>
<p><code>config.autoload_paths</code> 的每個元素都應該代表頂級名稱空間（<code>Object</code>），因此它們不能巢狀（除了上面解釋的 <code>concerns</code> 目錄）。</p><p>要解決此問題，只需刪除萬用字元：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="si">#{</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='config.autoload_paths &lt;&lt; "#{config.root}/lib"
'>Copy</button>
</div>
<h5 id="eager"><a class="anchorlink" href="#eager">4.7.14 Eager 載入和自動載入是一致的</a></h5><p>在 <code>classic</code> 模式下，如果 <code>app/models/foo.rb</code> 定義了 <code>Bar</code>，您將無法自動載入該檔案，但快速載入會起作用，因為它會盲目地遞迴載入檔案。如果您首先測試急切載入，這可能是錯誤的來源，稍後執行可能會失敗自動載入。</p><p>在 <code>zeitwerk</code> 模式下，兩種載入模式是一致的，它們在同一個檔案中失敗和出錯。</p><h5 id="rails-6-classic-autoloader"><a class="anchorlink" href="#rails-6-classic-autoloader">4.7.15 如何在 Rails 6 中使用 Classic Autoloader</a></h5><p>應用程式可以載入 Rails 6 個預設值，並通過以這種方式設定 <code>config.autoloader</code> 仍然使用經典的自動載入器：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 設定/應用程式.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.0</span>
<span class="n">config</span><span class="p">.</span><span class="nf">autoloader</span> <span class="o">=</span> <span class="ss">:classic</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 設定/應用程式.rb

config.load_defaults 6.0
config.autoloader = :classic
">Copy</button>
</div>
<p>在 Rails 6 應用程式中使用 Classic Autoloader 時，由於執行緒安全問題，建議在開發環境中將 Web 伺服器和後臺處理器的平行計算級別設定為 1。</p><h4 id="active-storage"><a class="anchorlink" href="#active-storage">4.8 Active Storage 賦值行為改變</a></h4><p>使用 Rails 5.2 的預設設定，分配給使用 <code>has_many_attached</code> 宣告的附件集合會附加新檔案：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many_attached</span> <span class="ss">:highlights</span>
<span class="k">end</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"funky.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>

<span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">highlights: </span><span class="p">[</span> <span class="n">blob</span> <span class="p">])</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 2</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "funky.jpg"</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">second</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class User &lt; ApplicationRecord
  has_many_attached :highlights
end

user.highlights.attach(filename: "funky.jpg", ...)
user.highlights.count # =&gt; 1

blob = ActiveStorage::Blob.create_after_upload!(filename: "town.jpg", ...)
user.update!(highlights: [ blob ])

user.highlights.count # =&gt; 2
user.highlights.first.filename # =&gt; "funky.jpg"
user.highlights.second.filename # =&gt; "town.jpg"
'>Copy</button>
</div>
<p>使用 Rails 6.0 的預設設定，分配給附件集合會替換現有檔案而不是附加到它們。這與分配給集合 association 時的 Active Record 行為匹配：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"funky.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>

<span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">highlights: </span><span class="p">[</span> <span class="n">blob</span> <span class="p">])</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='user.highlights.attach(filename: "funky.jpg", ...)
user.highlights.count # =&gt; 1

blob = ActiveStorage::Blob.create_after_upload!(filename: "town.jpg", ...)
user.update!(highlights: [ blob ])

user.highlights.count # =&gt; 1
user.highlights.first.filename # =&gt; "town.jpg"
'>Copy</button>
</div>
<p><code>#attach</code> 可用於新增新附件而不刪除現有附件：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 2</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "funky.jpg"</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">second</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='blob = ActiveStorage::Blob.create_after_upload!(filename: "town.jpg", ...)
user.highlights.attach(blob)

user.highlights.count # =&gt; 2
user.highlights.first.filename # =&gt; "funky.jpg"
user.highlights.second.filename # =&gt; "town.jpg"
'>Copy</button>
</div>
<p>現有應用程式可以通過將 <code>config.active_storage.replace_on_assign_to_many</code> 設定為 <code>true</code> 來選擇加入此新行為。舊行為將在 Rails 7.0 中棄用，並在 Rails 7.1 中刪除。</p><h3 id="rails-5-1-rails-5-2"><a class="anchorlink" href="#rails-5-1-rails-5-2">5 從 Rails 5.1 升級到 Rails 5.2</a></h3><p>有關對 Rails 5.2 所做更改的更多資訊，請參閱 <a href="5_2_release_notes.html">發行說明</a>。</p><h4 id="rails-5-1-rails-5-2"><a class="anchorlink" href="#rails-5-1-rails-5-2">5.1 載入程式</a></h4><p>Rails 5.2 在<a href="https://github.com/rails/rails/pull/29313">新產生的應用程式的 Gemfile</a> 中添加了 bootsnap gem。
<code>app:update</code> 命令在 <code>boot.rb</code> 中設定它。如果你想使用它，然後將它新增到 Gemfile 中，
否則更改 <code>boot.rb</code> 以不使用引導快照。</p><h4 id="cookie-cookies-values"><a class="anchorlink" href="#cookie-cookies-values">5.2 簽名或加密 cookie 中的到期現在嵌入在 cookies values 中</a></h4><p>為了提高安全性，Rails 現在也將到期資訊嵌入到加密或簽名的 cookies value 中。</p><p>這個新的嵌入資訊使那些 cookies 與早於 5.2 的 Rails 版本不相容。</p><p>如果您需要 5.1 及更早版本讀取 cookies，或者您仍在驗證 5.2 部署並希望
允許您回滾設定
<code>Rails.application.config.action_dispatch.use_authenticated_cookie_encryption</code> 到 <code>false</code>。</p><h3 id="rails-5-0-rails-5-1"><a class="anchorlink" href="#rails-5-0-rails-5-1">6 從 Rails 5.0 升級到 Rails 5.1</a></h3><p>有關對 Rails 5.1 所做更改的更多資訊，請參閱 <a href="5_1_release_notes.html">發行說明</a>。</p><h4 id="hashwithindifferentaccess"><a class="anchorlink" href="#hashwithindifferentaccess">6.1 頂級 <code>HashWithIndifferentAccess</code> 已軟棄用</a></h4><p>如果您的應用程式使用頂級 <code>HashWithIndifferentAccess</code> 類，您
應該慢慢移動你的程式碼來代替使用 <code>ActiveSupport::HashWithIndifferentAccess</code>。</p><p>它只是軟棄用，這意味著您的程式碼不會在
時刻，不會顯示棄用警告，但這個常量將是
將來刪除。</p><p>此外，如果您有包含此類物件轉儲的非常舊的 YAML 文件，
您可能需要再次載入和轉儲它們以確保它們引用
正確的常量，並且載入它們將來不會中斷。</p><h4 id="application-secrets-keys-symbols"><a class="anchorlink" href="#application-secrets-keys-symbols">6.2 <code>application.secrets</code> 現在載入了所有 keys 作為 symbols</a></h4><p>如果您的應用程式將巢狀設定儲存在 <code>config/secrets.yml</code> 中，則所有 keys
現在載入為 symbols，因此應該更改使用字串的訪問。</p><p>從：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">[</span><span class="ss">:smtp_settings</span><span class="p">][</span><span class="s2">"address"</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Rails.application.secrets[:smtp_settings]["address"]
'>Copy</button>
</div>
<p>到：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">[</span><span class="ss">:smtp_settings</span><span class="p">][</span><span class="ss">:address</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.secrets[:smtp_settings][:address]
">Copy</button>
</div>
<h4 id="render-text-nothing"><a class="anchorlink" href="#render-text-nothing">6.3 在 <code>render</code> 中刪除了對 <code>:text</code> 和 <code>:nothing</code> 的棄用支援</a></h4><p>如果您的 controllers 正在使用 <code>render :text</code>，它們將不再起作用。新方法
使用 <code>text/plain</code> 的 MIME 型別渲染文字的方法是使用 <code>render :plain</code>。</p><p>同樣，<code>render :nothing</code> 也被刪除，你應該使用 <code>head</code> 方法
傳送僅包含標頭的回應。例如，<code>head :ok</code> 傳送一個
200 回應，沒有要呈現的正文。</p><h4 id="redirect-to-back"><a class="anchorlink" href="#redirect-to-back">6.4 移除了對 <code>redirect_to :back</code> 的棄用支援</a></h4><p>在 Rails 5.0 中，不推薦使用 <code>redirect_to :back</code>。在 Rails 5.1 中，它被完全刪除。</p><p>作為替代，使用 <code>redirect_back</code>。需要注意的是 <code>redirect_back</code> 也需要
一個 <code>fallback_location</code> 選項，將在 <code>HTTP_REFERER</code> 缺失的情況下使用。</p><div class="code_container">
<pre><code class="highlight plaintext">redirect_back(fallback_location: root_path)
</code></pre>
<button class="clipboard-button" data-clipboard-text="redirect_back(fallback_location: root_path)
">Copy</button>
</div>
<h3 id="rails-4-2-rails-5-0"><a class="anchorlink" href="#rails-4-2-rails-5-0">7 從 Rails 4.2 升級到 Rails 5.0</a></h3><p>有關對 Rails 5.0 所做更改的更多資訊，請參閱 <a href="5_0_release_notes.html">發行說明</a>。</p><h4 id="ruby-2-2-2"><a class="anchorlink" href="#ruby-2-2-2">7.1 Ruby 2.2.2+ 需要</a></h4><p>從 Ruby 到 Rails 5.0 以後，Ruby 2.2.2+ 是唯一支援的 Ruby 版本。
在繼續之前，請確保您使用的是 Ruby 2.2.2 版本或更高版本。</p><h4 id="active-record-models-applicationrecord"><a class="anchorlink" href="#active-record-models-applicationrecord">7.2 Active Record Models 現在預設繼承自 ApplicationRecord</a></h4><p>在 Rails 4.2 中，一個 Active Record model 繼承自 <code>ActiveRecord::Base</code>。在 Rails 5.0 中，
所有的 models 都繼承自 <code>ApplicationRecord</code>。</p><p><code>ApplicationRecord</code> 是所有 app models 的新超類，類似於 app
controllers 子類化 <code>ApplicationController</code> 而不是
<code>ActionController::Base</code>。這為應用程式提供了一個設定應用程式範圍的單一位置
model 行為。</p><p>從Rails 4.2升級到Rails 5.0時，需要建立一個
在 <code>app/models/</code> 中的 <code>application_record.rb</code> 檔案並新增以下內容：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ApplicationRecord &lt; ActiveRecord::Base
  self.abstract_class = true
end
">Copy</button>
</div>
<p>然後確保您所有的 models 都繼承自它。</p><h4 id="throw-abort-callback"><a class="anchorlink" href="#throw-abort-callback">7.3 通過 <code>throw(:abort)</code> 停止 Callback 鏈</a></h4><p>在 Rails 4.2 中，當“之前” callback 在 Active Record 中返回 <code>false</code> 時
和 Active Model，那麼整個 callback 鏈就停止了。換句話說，
連續的“之前” callbacks 不會被執行，並且 action 也不會被包裝
在 callbacks。</p><p>在 Rails 5.0 中，在 Active Record 或 Active Model callback 中返回 <code>false</code>
不會有停止 callback 鏈的副作用。相反，callback
鏈必須通過呼叫 <code>throw(:abort)</code> 顯式停止。</p><p>當您從 Rails 4.2 升級到 Rails 5.0 時，返回 <code>false</code> 的那種
callbacks 仍將停止回呼鏈，但您將收到棄用
警告即將發生的變化。</p><p>準備好後，您可以選擇加入新行為並刪除棄用
通過將以下設定新增到您的 <code>config/application.rb</code> 來警告：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">halt_callback_chains_on_return_false</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="ActiveSupport.halt_callback_chains_on_return_false = false
">Copy</button>
</div>
<p>請注意，此選項不會影響 Active Support callbacks 因為它們從不
當返回任何 value 時停止鏈。</p><p>有關更多詳細資訊，請參閱 <a href="https://github.com/rails/rails/pull/17227">#17227</a>。</p><h4 id="activejob-applicationjob"><a class="anchorlink" href="#activejob-applicationjob">7.4 ActiveJob 現在預設繼承自 ApplicationJob</a></h4><p>在 Rails 4.2 中，一個 Active Job 繼承自 <code>ActiveJob::Base</code>。在 Rails 5.0 中，這個
行為已更改為現在從 <code>ApplicationJob</code> 繼承。</p><p>從Rails 4.2升級到Rails 5.0時，需要建立一個
在 <code>app/jobs/</code> 中的 <code>application_job.rb</code> 檔案並新增以下內容：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ApplicationJob &lt; ActiveJob::Base
end
">Copy</button>
</div>
<p>然後確保您的所有作業類都繼承自它。</p><p>有關更多詳細資訊，請參閱 <a href="https://github.com/rails/rails/pull/19034">#19034</a>。</p><h4 id="rails-controller"><a class="anchorlink" href="#rails-controller">7.5 Rails Controller 測試</a></h4><h5 id="helper-extraction-rails-controller-testing"><a class="anchorlink" href="#helper-extraction-rails-controller-testing">7.5.1 一些 helper 方法的 Extraction 到 <code>rails-controller-testing</code></a></h5><p><code>assigns</code> 和 <code>assert_template</code> 已被提取到 <code>rails-controller-testing</code> gem。到
繼續在 controller 測試中使用這些方法，將 <code>gem 'rails-controller-testing'</code> 新增到
您的 <code>Gemfile</code>。</p><p>如果您使用 RSpec 進行測試，請參閱 gem 中所需的額外設定
文件。</p><h5 id=""><a class="anchorlink" href="#">7.5.2 上傳檔案時的新行為</a></h5><p>如果您在測試中使用 <code>ActionDispatch::Http::UploadedFile</code>
上傳檔案，你需要改用類似的<code>Rack::Test::UploadedFile</code>
類代替。</p><p>有關更多詳細資訊，請參閱 <a href="https://github.com/rails/rails/issues/26404">#26404</a>。</p><h4 id=""><a class="anchorlink" href="#">7.6 生產環境啟動後自動載入關閉</a></h4><p>現在通過以下方式在生產環境中啟動後禁用自動載入
預設。</p><p>熱切載入應用程式是啟動過程的一部分，因此頂級
常量很好並且仍然會自動載入，不需要需要它們的檔案。</p><p>更深的地方的常量只在執行時執行，比如正常方法體，
也很好，因為定義它們的檔案將在啟動時預先載入。</p><p>對於絕大多數應用程式，此更改不需要 action。但在
您的應用程式在執行時需要自動載入的非常罕見的事件
生產，將 <code>Rails.application.config.enable_dependency_loading</code> 設定為 true。</p><h4 id="xml"><a class="anchorlink" href="#xml">7.7 XML 序列化</a></h4><p><code>ActiveModel::Serializers::Xml</code> 已經從 Rails 提取到 <code>activemodel-serializers-xml</code>
寶石。要繼續在您的應用程式中使用 XML 序列化，請新增 <code>gem 'activemodel-serializers-xml'</code>
到您的 <code>Gemfile</code>。</p><h4 id="mysql"><a class="anchorlink" href="#mysql">7.8 刪除了對舊版 <code>mysql</code> 資料庫介面卡的支援</a></h4><p>Rails 5 刪除了對舊版 <code>mysql</code> 資料庫介面卡的支援。大多數使用者應該能夠
使用 <code>mysql2</code> 代替。找人維護時會轉成單獨的gem
它。</p><h4 id=""><a class="anchorlink" href="#">7.9 刪除了對偵錯程式的支援</a></h4><p>Ruby 2.2 不支援 <code>debugger</code>，而 Rails 需要 Rails 5。請改用 <code>byebug</code>。</p><h4 id="bin-rails"><a class="anchorlink" href="#bin-rails">7.10 使用 <code>bin/rails</code> 來執行任務和測試</a></h4><p>Rails 5 增加了通過 <code>bin/rails</code> 而不是 rake 執行任務和測試的能力。一般來說
這些變化與 rake 並行，但有些被完全移植。</p><p>要使用新的測試執行器，只需輸入 <code>bin/rails test</code>。</p><p><code>rake dev:cache</code> 現在是 <code>bin/rails dev:cache</code>。</p><p>在應用程式的根目錄中執行 <code>bin/rails</code> 以檢視可用命令列表。</p><h4 id="actioncontroller-parameters-hashwithindifferentaccess"><a class="anchorlink" href="#actioncontroller-parameters-hashwithindifferentaccess">7.11 <code>ActionController::Parameters</code> 不再繼承 <code>HashWithIndifferentAccess</code></a></h4><p>在您的應用程式中呼叫 <code>params</code> 現在將返回一個物件而不是雜湊。如果你的
引數已經被允許，那麼您將不需要進行任何更改。如果您使用 <code>map</code>
以及其他依賴於能夠讀取雜湊的方法，而不管 <code>permitted?</code> 你會
需要升級您的應用程式以首先允許然後轉換為雜湊。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">([</span><span class="ss">:proceed_to</span><span class="p">,</span> <span class="ss">:return_to</span><span class="p">]).</span><span class="nf">to_h</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="params.permit([:proceed_to, :return_to]).to_h
">Copy</button>
</div>
<h4 id="protect-from-forgery-prepend-false"><a class="anchorlink" href="#protect-from-forgery-prepend-false">7.12 <code>protect_from_forgery</code> 現在預設為 <code>prepend: false</code></a></h4><p><code>protect_from_forgery</code> 預設為 <code>prepend: false</code> 這意味著它將被插入到
callback 鏈在您在應用程式中呼叫它的點。如果你想
<code>protect_from_forgery</code> 始終首先執行，然後您應該更改您的應用程式以使用
<code>protect_from_forgery prepend: true</code>。</p><h4 id="raw"><a class="anchorlink" href="#raw">7.13 預設模板處理程式現在是 RAW</a></h4><p>擴充套件中沒有模板處理程式的檔案將使用原始處理程式呈現。
以前 Rails 將使用 ERB 模板處理程式呈現檔案。</p><p>如果您不希望通過原始處理程式處理您的檔案，您應該新增一個副檔名
到可以由適當的模板處理程式解析的檔案。</p><h4 id=""><a class="anchorlink" href="#">7.14 添加了模板依賴的萬用字元匹配</a></h4><p>您現在可以對模板依賴項使用萬用字元匹配。例如，如果你是
像這樣定義你的模板：</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/subscribers_changed </span><span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/completed </span><span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/uncompleted </span><span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;% # Template Dependency: recordings/threads/events/subscribers_changed %&gt;
&lt;% # Template Dependency: recordings/threads/events/completed %&gt;
&lt;% # Template Dependency: recordings/threads/events/uncompleted %&gt;
">Copy</button>
</div>
<p>您現在可以使用萬用字元呼叫依賴項一次。</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/* </span><span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;% # Template Dependency: recordings/threads/events/* %&gt;
">Copy</button>
</div>
<h4 id="actionview-helpers-recordtaghelper-gem-record-tag-helper"><a class="anchorlink" href="#actionview-helpers-recordtaghelper-gem-record-tag-helper">7.15 <code>ActionView::Helpers::RecordTagHelper</code> 移動到外部 gem (record_tag_helper)</a></h4><p><code>content_tag_for</code> 和 <code>div_for</code> 已被刪除，以支援僅使用 <code>content_tag</code>。要繼續使用舊方法，請將 <code>record_tag_helper</code> gem 新增到您的 <code>Gemfile</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'record_tag_helper'</span><span class="p">,</span> <span class="s1">'~&gt; 1.0'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="gem 'record_tag_helper', '~&gt; 1.0'
">Copy</button>
</div>
<p>有關更多詳細資訊，請參閱 <a href="https://github.com/rails/rails/pull/18411">#18411</a>。</p><h4 id="protected-attributes-gem"><a class="anchorlink" href="#protected-attributes-gem">7.16 移除了對 <code>protected_attributes</code> Gem 的支援</a></h4><p>Rails 5 不再支援 <code>protected_attributes</code> gem。</p><h4 id="activerecord-deprecated-finders-gem"><a class="anchorlink" href="#activerecord-deprecated-finders-gem">7.17 刪除了對 <code>activerecord-deprecated_finders</code> gem 的支援</a></h4><p>Rails 5 不再支援 <code>activerecord-deprecated_finders</code> gem。</p><h4 id="activesupport-testcase"><a class="anchorlink" href="#activesupport-testcase">7.18 <code>ActiveSupport::TestCase</code> 預設測試訂單現在是隨機的</a></h4><p>在您的應用程式中執行測試時，預設順序現在是 <code>:random</code>
而不是 <code>:sorted</code>。使用以下設定選項將其設定回 <code>:sorted</code>。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 設定/環境/test.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">test_order</span> <span class="o">=</span> <span class="ss">:sorted</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 設定/環境/test.rb
Rails.application.configure do
  config.active_support.test_order = :sorted
end
">Copy</button>
</div>
<h4 id="actioncontroller-live-concern"><a class="anchorlink" href="#actioncontroller-live-concern">7.19 <code>ActionController::Live</code> 變成了 <code>Concern</code></a></h4><p>如果您在 controller 中包含的另一個 module 中包含 <code>ActionController::Live</code>，那麼您
還應該使用 <code>ActiveSupport::Concern</code> 擴充套件 module。或者，您可以使用 <code>self.included</code> 掛載機制
一旦包含 <code>StreamingSupport</code>，將 <code>ActionController::Live</code> 直接包含到 controller 中。</p><p>這意味著如果您的應用程式曾經有自己的流媒體 module，則以下程式碼
會在生產中中斷：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 這是流式 controllers 使用 Warden/Devise 執行身份驗證的變通方法。</span>
<span class="c1"># 見 https://github.com/plataformatec/devise/issues/2332</span>
<span class="c1"># 在路由器中進行身份驗證是該問題中建議的另一種解決方案</span>
<span class="k">class</span> <span class="nc">StreamingSupport</span>
  <span class="kp">include</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Live</span> <span class="c1"># this won't work in production for Rails 5</span>
  <span class="c1"># extend ActiveSupport::Concern # unless you uncomment this line.</span>

  <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="k">super</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">ArgumentError</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span> <span class="o">==</span> <span class="s1">'uncaught throw :warden'</span>
      <span class="kp">throw</span> <span class="ss">:warden</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="n">e</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 這是流式 controllers 使用 Warden/Devise 執行身份驗證的變通方法。
# 見 https://github.com/plataformatec/devise/issues/2332
# 在路由器中進行身份驗證是該問題中建議的另一種解決方案
class StreamingSupport
  include ActionController::Live # this won't work in production for Rails 5
  # extend ActiveSupport::Concern # unless you uncomment this line.

  def process(name)
    super(name)
  rescue ArgumentError =&gt; e
    if e.message == 'uncaught throw :warden'
      throw :warden
    else
      raise e
    end
  end
end
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">7.20 新框架預設值</a></h4><h5 id="active-record-belongs-to"><a class="anchorlink" href="#active-record-belongs-to">7.20.1 Active Record <code>belongs_to</code> 預設選項需要</a></h5><p>如果 association 不存在，則 <code>belongs_to</code> 現在預設會觸發驗證錯誤。</p><p>這可以通過 <code>optional: true</code> 關閉 per-association。</p><p>此預設值將在新應用程式中自動設定。如果現有應用
要新增此功能，需要在初始化程式中開啟它：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.active_record.belongs_to_required_by_default = true
">Copy</button>
</div>
<p>預設情況下，您的所有 models 的設定都是全域性的，但您可以
在每個模型的基礎上覆蓋它。這應該可以幫助您遷移所有 models 以擁有它們
associations 預設需要。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># model is not yet ready to have its association required by default</span>

  <span class="nb">self</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="n">belongs_to</span><span class="p">(</span><span class="ss">:author</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># model is ready to have its association required by default</span>

  <span class="nb">self</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">belongs_to</span><span class="p">(</span><span class="ss">:pilot</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  # model is not yet ready to have its association required by default

  self.belongs_to_required_by_default = false
  belongs_to(:author)
end

class Car &lt; ApplicationRecord
  # model is ready to have its association required by default

  self.belongs_to_required_by_default = true
  belongs_to(:pilot)
end
">Copy</button>
</div>
<h5 id="csrf-tokens"><a class="anchorlink" href="#csrf-tokens">7.20.2 執行表單 CSRF Tokens</a></h5><p>Rails 5 現在支援 per-form CSRF tokens 以減輕使用表單的程式碼注入攻擊
由 JavaScript 建立。啟用此選項後，您的應用程式中的每個表單都會有自己的
自己的 CSRF token 特定於 action 和該表單的方法。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">per_form_csrf_tokens</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.action_controller.per_form_csrf_tokens = true
">Copy</button>
</div>
<h5 id=""><a class="anchorlink" href="#">7.20.3 帶有原產地檢查的偽造保護</a></h5><p>您現在可以設定您的應用程式以檢查是否應檢查 HTTP <code>Origin</code> 標頭
反對站點的起源作為額外的 CSRF 防禦。在您的設定中設定以下內容
真的：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">forgery_protection_origin_check</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.action_controller.forgery_protection_origin_check = true
">Copy</button>
</div>
<h5 id="action-mailer"><a class="anchorlink" href="#action-mailer">7.20.4 允許設定 Action Mailer 佇列名稱</a></h5><p>預設的郵件佇列名稱是 <code>mailers</code>。此設定選項允許您全域性更改
佇列名稱。在您的設定中設定以下內容：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">deliver_later_queue_name</span> <span class="o">=</span> <span class="ss">:new_queue_name</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.action_mailer.deliver_later_queue_name = :new_queue_name
">Copy</button>
</div>
<h5 id="action-mailer-views"><a class="anchorlink" href="#action-mailer-views">7.20.5 支援 Action Mailer 中的片段快取 Views</a></h5><p>在您的設定中設定 <code>config.action_mailer.perform_caching</code> 以確定您的 Action Mailer views
應該支援快取。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">perform_caching</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.action_mailer.perform_caching = true
">Copy</button>
</div>
<h5 id="db-structure-dump"><a class="anchorlink" href="#db-structure-dump">7.20.6 設定<code>db:structure:dump</code>的輸出</a></h5><p>如果您使用 <code>schema_search_path</code> 或其他 PostgreSQL 擴充套件，您可以控制架構的方式
傾倒。設定為 <code>:all</code> 以產生所有轉儲，或設定為 <code>:schema_search_path</code> 以從模式搜尋路徑產生。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">dump_schemas</span> <span class="o">=</span> <span class="ss">:all</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.active_record.dump_schemas = :all
">Copy</button>
</div>
<h5 id="ssl-hsts"><a class="anchorlink" href="#ssl-hsts">7.20.7 設定 SSL 選項以啟用子域的 HSTS</a></h5><p>在您的設定中設定以下內容以在使用子域時啟用 HSTS：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">ssl_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">hsts: </span><span class="p">{</span> <span class="ss">subdomains: </span><span class="kp">true</span> <span class="p">}</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.ssl_options = { hsts: { subdomains: true } }
">Copy</button>
</div>
<h5 id=""><a class="anchorlink" href="#">7.20.8 保留接收者的時區</a></h5><p>使用 Ruby 2.4 時，可以在呼叫 <code>to_time</code> 時保留接收者的時區。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">to_time_preserves_timezone</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="ActiveSupport.to_time_preserves_timezone = false
">Copy</button>
</div>
<h4 id="json-jsonb"><a class="anchorlink" href="#json-jsonb">7.21 JSON/JSONB 序列化的變化</a></h4><p>在 Rails 5.0 中，JSON/JSONB 屬性的序列化和反序列化方式發生了變化。現在，如果
您設定的列等於 <code>String</code>，Active Record 將不再轉動該字串
進入 <code>Hash</code>，而只會返回字串。這不僅限於程式碼
與 models 互動，但也會影響 <code>db/schema.rb</code> 中的 <code>:default</code> 列設定。
建議您不要將列設定為等於 <code>String</code>，而是傳遞一個 <code>Hash</code>
相反，它將自動與 JSON 字串相互轉換。</p><h3 id="rails-4-1-rails-4-2"><a class="anchorlink" href="#rails-4-1-rails-4-2">8 從 Rails 4.1 升級到 Rails 4.2</a></h3><h4 id=""><a class="anchorlink" href="#">8.1 網路控制檯</a></h4><p>首先，將 <code>gem 'web-console', '~&gt; 2.0'</code> 新增到 <code>Gemfile</code> 中的 <code>:development</code> 組並執行 <code>bundle install</code>（升級 Rails 時不會包含它）。安裝完成後，您可以簡單地將控制檯 helper（即 <code>&lt;%= console %&gt;</code>）的引用放入要啟用它的任何 view 中。您在開發環境中的 view 的任何錯誤頁面上也會提供一個控制檯。</p><h4 id=""><a class="anchorlink" href="#">8.2 回應者</a></h4><p><code>respond_with</code> 和類級別的 <code>respond_to</code> 方法已提取到 <code>responders</code> gem。要使用它們，只需將 <code>gem 'responders', '~&gt; 2.0'</code> 新增到您的 <code>Gemfile</code>。如果不將 <code>responders</code> gem 包含在您的依賴項中，則對 <code>respond_with</code> 和 <code>respond_to</code> 的呼叫（再次在類級別）將不再起作用：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/controllers/users_controller.rb</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:json</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/controllers/users_controller.rb

class UsersController &lt; ApplicationController
  respond_to :html, :json

  def show
    @user = User.find(params[:id])
    respond_with @user
  end
end
">Copy</button>
</div>
<p>實例級 <code>respond_to</code> 不受影響，不需要額外的 gem：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/controllers/users_controller.rb</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/controllers/users_controller.rb

class UsersController &lt; ApplicationController
  def show
    @user = User.find(params[:id])
    respond_to do |format|
      format.html
      format.json { render json: @user }
    end
  end
end
">Copy</button>
</div>
<p>有關更多詳細資訊，請參閱 <a href="https://github.com/rails/rails/pull/16526">#16526</a>。</p><h4 id="transaction-callbacks"><a class="anchorlink" href="#transaction-callbacks">8.3 transaction 中的錯誤處理 callbacks</a></h4><p>目前，Active Record 抑制引發的錯誤
在 <code>after_rollback</code> 或 <code>after_commit</code> callbacks 內，只將它們列印到
日誌。在下一個版本中，這些錯誤將不再被抑制。
相反，錯誤會像其他 Active 一樣正常傳播
記錄 callbacks。</p><p>當您定義 <code>after_rollback</code> 或 <code>after_commit</code> callback 時，您
將收到有關此即將發生的更改的棄用警告。什麼時候
你準備好了，你可以選擇加入新的行為並刪除
通過將以下設定新增到您的
<code>config/application.rb</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">raise_in_transactional_callbacks</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.active_record.raise_in_transactional_callbacks = true
">Copy</button>
</div>
<p>見 <a href="https://github.com/rails/rails/pull/14488">#14488</a> 和
<a href="https://github.com/rails/rails/pull/16537">#16537</a> 瞭解更多詳情。</p><h4 id=""><a class="anchorlink" href="#">8.4 測試用例排序</a></h4><p>在 Rails 5.0 中，預設情況下會以隨機順序執行測試用例。在
期待這個變化，Rails 4.2 引入了一個新的設定選項
<code>active_support.test_order</code> 用於明確指定測試順序。這
允許您通過將選項設定為鎖定當前行為
<code>:sorted</code>，或者通過將選項設定為 <code>:random</code> 來選擇未來的行為。</p><p>如果您沒有為此選項指定 value，則會出現棄用警告
發出。為避免這種情況，請將以下行新增到您的測試環境中：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 設定/環境/test.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">test_order</span> <span class="o">=</span> <span class="ss">:sorted</span> <span class="c1"># or `:random` if you prefer</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 設定/環境/test.rb
Rails.application.configure do
  config.active_support.test_order = :sorted # or `:random` if you prefer
end
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">8.5 序列化屬性</a></h4><p>使用自定義編碼器（例如 <code>serialize :metadata, JSON</code>）時，
將 <code>nil</code> 分配給序列化的屬性會將其儲存到資料庫中
作為 <code>NULL</code> 而不是通過編碼器傳遞 <code>nil</code> value（例如 <code>"null"</code>
使用 <code>JSON</code> 編碼器時）。</p><h4 id=""><a class="anchorlink" href="#">8.6 生產日誌級別</a></h4><p>Rails 5中，將更改生產環境的預設日誌級別
到 <code>:debug</code>（從 <code>:info</code>）。要保留當前預設值，請新增以下內容
線到您的 <code>production.rb</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 設定為 `:info` 以匹配當前預設值，或設定為 `:debug` 以選擇加入</span>
<span class="c1"># 未來的預設值。</span>
<span class="n">config</span><span class="p">.</span><span class="nf">log_level</span> <span class="o">=</span> <span class="ss">:info</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 設定為 `:info` 以匹配當前預設值，或設定為 `:debug` 以選擇加入
# 未來的預設值。
config.log_level = :info
">Copy</button>
</div>
<h4 id="after-bundle-rails"><a class="anchorlink" href="#after-bundle-rails">8.7 <code>after_bundle</code> 在 Rails 模板中</a></h4><p>如果您有一個在版本控制中新增所有檔案的 Rails 模板，它
新增產生的 binstub 失敗，因為它在 Bundler 之前執行：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 模板.rb</span>
<span class="n">generate</span><span class="p">(</span><span class="ss">:scaffold</span><span class="p">,</span> <span class="s2">"person name:string"</span><span class="p">)</span>
<span class="n">route</span> <span class="s2">"root to: 'people#index'"</span>
<span class="n">rake</span><span class="p">(</span><span class="s2">"db:migrate"</span><span class="p">)</span>

<span class="n">git</span> <span class="ss">:init</span>
<span class="n">git</span> <span class="ss">add: </span><span class="s2">"."</span>
<span class="n">git</span> <span class="ss">commit: </span><span class="sx">%Q{ -m 'Initial commit' }</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 模板.rb
generate(:scaffold, &quot;person name:string&quot;)
route &quot;root to: 'people#index'&quot;
rake(&quot;db:migrate&quot;)

git :init
git add: &quot;.&quot;
git commit: %Q{ -m 'Initial commit' }
">Copy</button>
</div>
<p>您現在可以將 <code>git</code> 呼叫包裝在 <code>after_bundle</code> 塊中。它將執行
在產生 binstub 之後。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 模板.rb</span>
<span class="n">generate</span><span class="p">(</span><span class="ss">:scaffold</span><span class="p">,</span> <span class="s2">"person name:string"</span><span class="p">)</span>
<span class="n">route</span> <span class="s2">"root to: 'people#index'"</span>
<span class="n">rake</span><span class="p">(</span><span class="s2">"db:migrate"</span><span class="p">)</span>

<span class="n">after_bundle</span> <span class="k">do</span>
  <span class="n">git</span> <span class="ss">:init</span>
  <span class="n">git</span> <span class="ss">add: </span><span class="s2">"."</span>
  <span class="n">git</span> <span class="ss">commit: </span><span class="sx">%Q{ -m 'Initial commit' }</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 模板.rb
generate(:scaffold, &quot;person name:string&quot;)
route &quot;root to: 'people#index'&quot;
rake(&quot;db:migrate&quot;)

after_bundle do
  git :init
  git add: &quot;.&quot;
  git commit: %Q{ -m 'Initial commit' }
end
">Copy</button>
</div>
<h4 id="rails-html"><a class="anchorlink" href="#rails-html">8.8 Rails HTML 消毒劑</a></h4><p>清理應用程式中的 HTML 片段有了新的選擇。這
古老的 html-scanner 方法現在正式被棄用，以支援
<a href="https://github.com/rails/rails-html-sanitizer"><code>Rails HTML Sanitizer</code></a>。</p><p>這意味著方法 <code>sanitize</code>、<code>sanitize_css</code>、<code>strip_tags</code> 和
<code>strip_links</code> 由一個新的實現支援。</p><p>這種新的消毒劑在內部使用 <a href="https://github.com/flavorjones/loofah">Loofah</a>。絲瓜絡反過來使用 Nokogiri，它
包裝用 C 和 Java 編寫的 XML 解析器，因此清理應該更快
無論您執行哪個 Ruby 版本。</p><p>新版本更新了<code>sanitize</code>，所以可以取一個<code>Loofah::Scrubber</code>
強力擦洗。
<a href="https://github.com/flavorjones/loofah#loofahscrubber">在此處檢視洗滌器的一些示例</a>。</p><p>還添加了兩個新的洗滌器：<code>PermitScrubber</code> 和 <code>TargetScrubber</code>。
閱讀 <a href="https://github.com/rails/rails-html-sanitizer">gem 的自述檔案</a> 瞭解更多資訊。</p><p><code>PermitScrubber</code> 和 <code>TargetScrubber</code> 的文件解釋了您如何
可以完全控制何時以及如何剝離元素。</p><p>如果您的應用程式需要使用舊的 sanitizer 實現，請在您的 <code>Gemfile</code> 中包含 <code>rails-deprecated_sanitizer</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'rails-deprecated_sanitizer'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="gem 'rails-deprecated_sanitizer'
">Copy</button>
</div>
<h4 id="rails-dom"><a class="anchorlink" href="#rails-dom">8.9 Rails DOM 測試</a></h4><p><a href="https://api.rubyonrails.org/v4.1/classes/ActionDispatch/Assertions/TagAssertions.html"><code>TagAssertions</code> module</a>（包含諸如<code>assert_tag</code>之類的方法），<a href="https://github.com/rails/rails/blob/6061472b8c310158a2a2e8e9a6b81a1aef6b60fe/actionpack/lib/action_dispatch/testing/assertions/dom.rb">已棄用</a>支援ZHTW_3_19_WTHZ_WTHZ_1_WTHZ_WTHZ_<code>assert_tag</code><em>1_WTHZ方法中的<code>assert_select</code>方法，其中ZHTW_3_1_ZHWTZ_WTHZ_1_WTHZ_WTHZ_1</em>WTHWT_WTHZ_test_zh_TH​​ZWHTZ_test_zh_1_ZHWTWT_test_zh_TWZ_1_ZHWT_WTHZ_test_1</p><h4 id="tokens"><a class="anchorlink" href="#tokens">8.10 偽裝真實性 Tokens</a></h4><p>為了減輕 SSL 攻擊，<code>form_authenticity_token</code> 現在被遮蔽，以便它隨每個請求而變化。因此，tokens 通過取消遮蔽然後解密來驗證。因此，任何用於驗證來自非 rails 表單且依賴於靜態 session CSRF 令牌的請求的策略都必須考慮到這一點。</p><h4 id="action-mailer"><a class="anchorlink" href="#action-mailer">8.11 Action Mailer</a></h4><p>以前，在郵件程式類上呼叫郵件程式方法將導致
直接執行對應的實例方法。隨著引進
Active Job 和 <code>#deliver_later</code>，這不再是真的。在 Rails 4.2 中，
實例方法的呼叫被推遲到 <code>deliver_now</code> 或
<code>deliver_later</code> 被呼叫。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Notifier</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Called"</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Notifier &lt; ActionMailer::Base
  def notify(user, ...)
    puts "Called"
    mail(to: user.email, ...)
  end
end
'>Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">mail</span> <span class="o">=</span> <span class="no">Notifier</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="c1"># Notifier#notify is not yet called at this point</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">mail</span><span class="p">.</span><span class="nf">deliver_now</span>           <span class="c1"># Prints "Called"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='mail = Notifier.notify(user, ...) # Notifier#notify is not yet called at this point
mail = mail.deliver_now           # Prints "Called"
'>Copy</button>
</div>
<p>對於大多數應用程式，這不應導致任何明顯差異。
但是，如果您需要同步執行一些非郵件程式方法，並且
您以前依賴同步代理行為，您應該
直接在郵件程式類上將它們定義為類方法：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Notifier</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">broadcast_notifications</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="n">users</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="no">Notifier</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Notifier &lt; ActionMailer::Base
  def self.broadcast_notifications(users, ...)
    users.each { |user| Notifier.notify(user, ...) }
  end
end
">Copy</button>
</div>
<h4 id="key"><a class="anchorlink" href="#key">8.12 國外 Key 支援</a></h4><p>migration DSL 已擴充套件為支援外部 key 定義。如果
您一直在使用 Foreigner gem，您可能需要考慮將其刪除。
注意 Rails 的外部 key 支援是 Foreigner 的子集。這意味著
並非每個 Foreigner 定義都可以完全替換為其 Rails
migration DSL 對應。</p><p>migration 過程如下：</p>
<ol>
<li>從 <code>Gemfile</code> 中刪除 <code>gem "foreigner"</code>。</li>
<li>執行 <code>bundle install</code>。</li>
<li>執行 <code>bin/rake db:schema:dump</code>。</li>
<li>確保 <code>db/schema.rb</code> 包含每個外部 key 定義
必要的選項。</li>
</ol>
<h3 id="rails-4-0-rails-4-1"><a class="anchorlink" href="#rails-4-0-rails-4-1">9 從 Rails 4.0 升級到 Rails 4.1</a></h3><h4 id="script-csrf"><a class="anchorlink" href="#script-csrf">9.1 遠端 <code>&lt;script&gt;</code> 標籤的 CSRF 保護</a></h4><p>或者，“我的測試失敗了！！！？”或“我的 <code>&lt;script&gt;</code> 小部件被破壞了！！”</p><p>跨站點請求偽造 (CSRF) 保護現在包含 GET 請求
JavaScript 回應也是如此。這可以防止第三方站點遠端訪問
使用 <code>&lt;script&gt;</code> 標記引用您的 JavaScript 以提取敏感資料。</p><p>這意味著您使用的功能和整合測試</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">format: :js</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="get :index, format: :js
">Copy</button>
</div>
<p>現在將觸發 CSRF 保護。切換到</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">xhr</span> <span class="ss">:get</span><span class="p">,</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">format: :js</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="xhr :get, :index, format: :js
">Copy</button>
</div>
<p>顯式測試 <code>XmlHttpRequest</code>。</p><div class="note"><p>您自己的 <code>&lt;script&gt;</code> 標籤被視為跨源並被
預設也是。如果您真的想從 <code>&lt;script&gt;</code> 標籤載入 JavaScript，
您現在必須明確跳過那些 actions 上的 CSRF 保護。</p></div><h4 id="rails-4-0-rails-4-1"><a class="anchorlink" href="#rails-4-0-rails-4-1">9.2 彈簧</a></h4><p>如果您想使用 Spring 作為您的應用程式預載入器，您需要：</p>
<ol>
<li>將 <code>gem 'spring', group: :development</code> 新增到您的 <code>Gemfile</code>。</li>
<li>使用 <code>bundle install</code> 安裝彈簧。</li>
<li>使用 <code>bundle exec spring binstub</code> 產生 Spring binstub。</li>
</ol>
<div class="note"><p>使用者定義的 rake 任務將在 <code>development</code> 環境中執行
預設。如果您希望它們在其他環境中執行，請參閱
<a href="https://github.com/rails/spring#rake">Spring README</a>。</p></div><h4 id="config-secrets-yml"><a class="anchorlink" href="#config-secrets-yml">9.3 <code>config/secrets.yml</code></a></h4><p>如果您想使用新的 <code>secrets.yml</code> 約定來儲存應用程式的
祕密，你需要：</p>
<ol>
<li>
<p>在 <code>config</code> 資料夾中建立一個 <code>secrets.yml</code> 檔案，內容如下：</p>
<div class="code_container">
<pre><code class="highlight yaml"><span class="na">development</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span>

<span class="na">production</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='development:
  secret_key_base:

test:
  secret_key_base:

production:
  secret_key_base: &lt;%= ENV["SECRET_KEY_BASE"] %&gt;
'>Copy</button>
</div>
</li>
<li><p>使用來自 <code>secret_token.rb</code> 初始值設定項的現有 <code>secret_key_base</code>
為執行該程式的任何使用者設定 <code>SECRET_KEY_BASE</code> 環境變數
Rails 應用程式在生產中。或者，您可以簡單地複製現有的
<code>secret_key_base</code> 從 <code>secret_token.rb</code> 初始化器到 <code>secrets.yml</code>
在 <code>production</code> 部分下，替換 <code>&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</code>。</p></li>
<li><p>移除 <code>secret_token.rb</code> 初始值設定項。</p></li>
<li><p>使用 <code>rake secret</code> 為 <code>development</code> 和 <code>test</code> 部分產生新的 keys。</p></li>
<li><p>重新啟動您的伺服器。</p></li>
</ol>
<h4 id="helper"><a class="anchorlink" href="#helper">9.4 更改以測試 helper</a></h4><p>如果您的測試 helper 包含對
<code>ActiveRecord::Migration.check_pending!</code> 這個可以去掉。支票
現在當你 <code>require "rails/test_help"</code> 時自動完成，雖然
將此行留在您的 helper 中沒有任何危害。</p><h4 id="cookies"><a class="anchorlink" href="#cookies">9.5 Cookies 序列化器</a></h4><p>Rails 4.1 之前建立的應用程式使用 <code>Marshal</code> 將 cookie values 序列化為
簽名和加密的 cookie 罐子。如果要使用新的根據 <code>JSON</code> 的格式
在您的應用程式中，您可以新增一個包含以下內容的初始化檔案：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">cookies_serializer</span> <span class="o">=</span> <span class="ss">:hybrid</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.config.action_dispatch.cookies_serializer = :hybrid
">Copy</button>
</div>
<p>這會將您現有的 <code>Marshal</code> 序列化 cookies 透明地遷移到
新的根據 <code>JSON</code> 的格式。</p><p>使用 <code>:json</code> 或 <code>:hybrid</code> 序列化程式時，您應該注意並非所有
Ruby 物件可以序列化為 JSON。例如，<code>Date</code> 和 <code>Time</code> 物件
將被序列化為字串，並且 <code>Hash</code>es 將其 keys 字串化。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CookiesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">set_cookie</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:expiration_date</span><span class="p">]</span> <span class="o">=</span> <span class="no">Date</span><span class="p">.</span><span class="nf">tomorrow</span> <span class="c1"># =&gt; Thu, 20 Mar 2014</span>
    <span class="n">redirect_to</span> <span class="ss">action: </span><span class="s1">'read_cookie'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">read_cookie</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:expiration_date</span><span class="p">]</span> <span class="c1"># =&gt; "2014-03-20"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CookiesController &lt; ApplicationController
  def set_cookie
    cookies.encrypted[:expiration_date] = Date.tomorrow # =&gt; Thu, 20 Mar 2014
    redirect_to action: 'read_cookie'
  end

  def read_cookie
    cookies.encrypted[:expiration_date] # =&gt; &quot;2014-03-20&quot;
  end
end
">Copy</button>
</div>
<p>建議您只在 cookies 中儲存簡單資料（字串和數字）。
如果必須儲存複雜的物件，則需要處理轉換
在後續請求中讀取 values 時手動。</p><p>如果您使用 cookie session 儲存，這將適用於 <code>session</code> 和
<code>flash</code> 雜湊也是如此。</p><h4 id="flash"><a class="anchorlink" href="#flash">9.6 Flash 結構變化</a></h4><p>Flash 訊息 keys 是
<a href="https://github.com/rails/rails/commit/a668beffd64106a1e1fedb71cc25eaaa11baf0c1">標準化為字串</a>。他們
仍然可以使用 symbols 或字串訪問。迴圈通過閃光燈
將始終產生字串 keys：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">flash</span><span class="p">[</span><span class="s2">"string"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"a string"</span>
<span class="n">flash</span><span class="p">[</span><span class="ss">:symbol</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"a symbol"</span>

<span class="c1"># Rails &lt; 4.1</span>
<span class="n">flash</span><span class="p">.</span><span class="nf">keys</span> <span class="c1"># =&gt; ["string", :symbol]</span>

<span class="c1"># Rails &gt;= 4.1</span>
<span class="n">flash</span><span class="p">.</span><span class="nf">keys</span> <span class="c1"># =&gt; ["string", "symbol"]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='flash["string"] = "a string"
flash[:symbol] = "a symbol"

# Rails &lt; 4.1
flash.keys # =&gt; ["string", :symbol]

# Rails &gt;= 4.1
flash.keys # =&gt; ["string", "symbol"]
'>Copy</button>
</div>
<p>確保將 Flash 訊息 keys 與字串進行比較。</p><h4 id="json"><a class="anchorlink" href="#json">9.7 JSON 處理的變化</a></h4><p>Rails 4.1 中有一些與 JSON 處理相關的重大更改。</p><h5 id="multijson"><a class="anchorlink" href="#multijson">9.7.1 MultiJSON 移除</a></h5><p>MultiJSON 已達到其 <a href="https://github.com/rails/rails/pull/10576">end-of-life</a>
並已從 Rails 中移除。</p><p>如果您的應用程式當前直接依賴 MultiJSON，您有幾個選擇：</p>
<ol>
<li><p>將“multi_json”新增到您的 <code>Gemfile</code>。請注意，這可能會在未來停止工作</p></li>
<li><p>使用 <code>obj.to_json</code> 和 <code>JSON.parse(str)</code> 從 MultiJSON 遷移。</p></li>
</ol>
<div class="warning"><p>不要簡單地將 <code>MultiJson.dump</code> 和 <code>MultiJson.load</code> 替換為
<code>JSON.dump</code> 和 <code>JSON.load</code>。這些 JSON gem API 用於序列化和
反序列化任意 Ruby 物件，通常是 <a href="https://ruby-doc.org/stdlib-2.2.2/libdoc/json/rdoc/JSON.html#method-i-load">不安全的</a>。</p></div><h5 id="json-gem"><a class="anchorlink" href="#json-gem">9.7.2 JSON gem 相容性</a></h5><p>從歷史上看，Rails 與 JSON gem 存在一些相容性問題。使用
Rails 應用程式中的 <code>JSON.generate</code> 和 <code>JSON.dump</code> 可以產生
意外錯誤。</p><p>Rails 4.1 通過將自己的編碼器與 JSON gem 隔離來解決這些問題。這
JSON gem API 將正常執行，但它們將無法訪問任何
Rails 特定的功能。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">FooBar</span>
  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="p">{</span> <span class="ss">foo: </span><span class="s1">'bar'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class FooBar
  def as_json(options = nil)
    { foo: 'bar' }
  end
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">FooBar</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">to_json</span>
<span class="p">=&gt;</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">foo</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">bar</span><span class="se">\"</span><span class="s2">}"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="no">FooBar</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span> <span class="ss">quirks_mode: </span><span class="kp">true</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">#&lt;FooBar:0x007fa80a481610&gt;</span><span class="se">\"</span><span class="s2">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="FooBar.new.to_json
JSON.generate(FooBar.new, quirks_mode: true)
">Copy</button>
</div>
<h5 id="json"><a class="anchorlink" href="#json">9.7.3 新的 JSON 編碼器</a></h5><p>Rails 4.1 中的 JSON 編碼器已被重寫以利用 JSON
寶石。對於大多數應用程式，這應該是一個透明的更改。然而，作為
在重寫的一部分中，以下功能已從編碼器中刪除：</p><p>1.迴圈資料結構檢測
2.支援<code>encode_json</code>掛載機制
3. 將 <code>BigDecimal</code> 物件編碼為數字而不是字串的選項</p><p>如果您的應用程式依賴於這些功能之一，您可以通過
新增 <a href="https://github.com/rails/activesupport-json_encoder"><code>activesupport-json_encoder</code></a>
寶石到您的 <code>Gemfile</code>。</p><h5 id="time-json"><a class="anchorlink" href="#time-json">9.7.4 Time 物件的 JSON 表示</a></h5><p><code>#as_json</code> 用於具有時間分量的物件（<code>Time</code>、<code>DateTime</code>、<code>ActiveSupport::TimeWithZone</code>）
現在預設返回毫秒精度。如果您需要保持沒有毫秒的舊行為
精度，在初始化程式中設定以下內容：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">JSON</span><span class="o">::</span><span class="no">Encoding</span><span class="p">.</span><span class="nf">time_precision</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="ActiveSupport::JSON::Encoding.time_precision = 0
">Copy</button>
</div>
<h4 id="callback-return"><a class="anchorlink" href="#callback-return">9.8 在內聯 callback 塊中使用 <code>return</code></a></h4><p>以前，Rails 允許內聯 callback 塊以這種方式使用 <code>return</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="k">return</span> <span class="kp">false</span> <span class="p">}</span> <span class="c1"># BAD</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ReadOnlyModel &lt; ActiveRecord::Base
  before_save { return false } # BAD
end
">Copy</button>
</div>
<p>這種行為從未被有意支援。由於內部結構的變化
<code>ActiveSupport::Callbacks</code> 的，在 Rails 4.1 中不再允許。用一個
內聯 callback 塊中的 <code>return</code> 語句導致 <code>LocalJumpError</code>
執行 callback 時引發。</p><p>可以重構使用 <code>return</code> 的內聯 callback 塊以評估為
返回 value：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="kp">false</span> <span class="p">}</span> <span class="c1"># GOOD</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ReadOnlyModel &lt; ActiveRecord::Base
  before_save { false } # GOOD
end
">Copy</button>
</div>
<p>或者，如果首選 <code>return</code>，則建議明確定義
一個方法：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="ss">:before_save_callback</span> <span class="c1"># GOOD</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">before_save_callback</span>
      <span class="k">return</span> <span class="kp">false</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ReadOnlyModel &lt; ActiveRecord::Base
  before_save :before_save_callback # GOOD

  private
    def before_save_callback
      return false
    end
end
">Copy</button>
</div>
<p>此更改適用於 Rails 中使用 callbacks 的大多數地方，包括
Active Record 和 Active Model callbacks，以及 Action 中的過濾器
Controller（例如 <code>before_action</code>）。</p><p>請參閱 <a href="https://github.com/rails/rails/pull/13271">此拉取請求</a> 瞭解更多
細節。</p><h4 id="active-record"><a class="anchorlink" href="#active-record">9.9 定義在 Active Record 夾具中的方法</a></h4><p>Rails 4.1 在單獨的上下文中評估每個裝置的 ERB，因此 helper 方法
在一個裝置中定義的在其他裝置中不可用。</p><p>多個夾具中使用的 Helper 方法應在 modules 上定義
包含在新引入的 <code>ActiveRecord::FixtureSet.context_class</code> 中，在
<code>test_helper.rb</code>。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">FixtureFileHelpers</span>
  <span class="k">def</span> <span class="nf">file_sha</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA256</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'test/fixtures'</span><span class="p">,</span> <span class="n">path</span><span class="p">)))</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">FixtureSet</span><span class="p">.</span><span class="nf">context_class</span><span class="p">.</span><span class="nf">include</span> <span class="no">FixtureFileHelpers</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module FixtureFileHelpers
  def file_sha(path)
    OpenSSL::Digest::SHA256.hexdigest(File.read(Rails.root.join('test/fixtures', path)))
  end
end

ActiveRecord::FixtureSet.context_class.include FixtureFileHelpers
">Copy</button>
</div>
<h4 id="i18n"><a class="anchorlink" href="#i18n">9.10 I18n 強制執行可用的語言環境</a></h4><p>Rails 4.1 現在預設 I18n 選項 <code>enforce_available_locales</code> 為 <code>true</code>。這
意味著它將確保傳遞給它的所有語言環境都必須在
<code>available_locales</code> 列表。</p><p>要禁用它（並允許 I18n 接受 <em>any</em> 語言環境選項），請新增以下內容
設定到您的應用程式：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">i18n</span><span class="p">.</span><span class="nf">enforce_available_locales</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.i18n.enforce_available_locales = false
">Copy</button>
</div>
<p>請注意，此選項是作為安全措施新增的，以確保使用者輸入
除非事先知道，否則不能用作區域設定資訊。所以，
除非您有充分的理由，否則建議不要禁用此選項
這樣做。</p><h4 id="relation-mutator"><a class="anchorlink" href="#relation-mutator">9.11 對 Relation 呼叫的 Mutator 方法</a></h4><p><code>Relation</code> 不再有像 <code>#map!</code> 和 <code>#delete_if</code> 這樣的修改器方法。兌換
在使用這些方法之前通過呼叫 <code>#to_a</code> 到 <code>Array</code>。</p><p>它的目標在於防止呼叫 mutator 的程式碼中出現奇怪的錯誤和混淆
方法直接放在 <code>Relation</code> 上。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 而不是這個</span>
<span class="no">Author</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Hank Moody'</span><span class="p">).</span><span class="nf">compact!</span>

<span class="c1"># 現在你必須這樣做</span>
<span class="n">authors</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Hank Moody'</span><span class="p">).</span><span class="nf">to_a</span>
<span class="n">authors</span><span class="p">.</span><span class="nf">compact!</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 而不是這個
Author.where(name: 'Hank Moody').compact!

# 現在你必須這樣做
authors = Author.where(name: 'Hank Moody').to_a
authors.compact!
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">9.12 預設範圍的變化</a></h4><p>預設範圍不再被連結條件覆蓋。</p><p>在以前的版本中，當您在 model 中定義 <code>default_scope</code> 時
它被同一欄位中的連結條件覆蓋。現在它
像任何其他範圍一樣合併。</p><p>前：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'pending'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'active'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'inactive'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s1">'inactive'</span><span class="p">)</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ActiveRecord::Base
  default_scope { where state: 'pending' }
  scope :active, -&gt; { where state: 'active' }
  scope :inactive, -&gt; { where state: 'inactive' }
end

User.all
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'pending'

User.active
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'active'

User.where(state: 'inactive')
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'inactive'
">Copy</button>
</div>
<p>後：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'pending'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'active'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'inactive'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s1">'inactive'</span><span class="p">)</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'inactive'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ActiveRecord::Base
  default_scope { where state: 'pending' }
  scope :active, -&gt; { where state: 'active' }
  scope :inactive, -&gt; { where state: 'inactive' }
end

User.all
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'pending'

User.active
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'pending' AND &quot;users&quot;.&quot;state&quot; = 'active'

User.where(state: 'inactive')
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'pending' AND &quot;users&quot;.&quot;state&quot; = 'inactive'
">Copy</button>
</div>
<p>要獲得以前的行為，需要明確刪除
<code>default_scope</code> 條件使用 <code>unscoped</code>、<code>unscope</code>、<code>rewhere</code> 或
<code>except</code>。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'pending'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">unscope</span><span class="p">(</span><span class="ss">where: :state</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s1">'active'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">rewhere</span> <span class="ss">state: </span><span class="s1">'inactive'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">inactive</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ActiveRecord::Base
  default_scope { where state: 'pending' }
  scope :active, -&gt; { unscope(where: :state).where(state: 'active') }
  scope :inactive, -&gt; { rewhere state: 'inactive' }
end

User.all
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'pending'

User.active
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'active'

User.inactive
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'inactive'
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">9.13 從字串渲染內容</a></h4><p>Rails 4.1 向 <code>render</code> 引入了 <code>:plain</code>、<code>:html</code> 和 <code>:body</code> 選項。那些
選項現在是呈現根據字串的內容的首選方式，因為它允許
您指定您希望回應傳送的內容型別。</p>
<ul>
<li>
<code>render :plain</code> 將設定內容型別為 <code>text/plain</code>
</li>
<li>
<code>render :html</code> 將設定內容型別為 <code>text/html</code>
</li>
<li>
<code>render :body</code> 將<em>不</em>設定內容型別標題。</li>
</ul>
<p>從安全的角度來看，如果您不希望在您的
回應正文，您應該使用 <code>render :plain</code> 因為大多數瀏覽器都會轉義
對您的回應中包含不安全的內容。</p><p>我們將在未來版本中棄用 <code>render :text</code>。所以，請
開始使用更精確的 <code>:plain</code>、<code>:html</code> 和 <code>:body</code> 選項。
使用 <code>render :text</code> 可能會帶來安全風險，因為內容是作為
<code>text/html</code>。</p><h4 id="postgresql-json-hstore"><a class="anchorlink" href="#postgresql-json-hstore">9.14 PostgreSQL json 和 hstore 資料型別</a></h4><p>Rails 4.1 將 <code>json</code> 和 <code>hstore</code> 列對映到字串-keyed Ruby <code>Hash</code>。
在早期版本中，使用了 <code>HashWithIndifferentAccess</code>。這意味著
不再支援 symbol 訪問。這也適用於
<code>store_accessors</code> 根據 <code>json</code> 或 <code>hstore</code> 列的頂部。確保使用
字串 keys 一致。</p><h4 id="activesupport-callbacks"><a class="anchorlink" href="#activesupport-callbacks">9.15 <code>ActiveSupport::Callbacks</code> 的顯式塊使用</a></h4><p>Rails 4.1 現在期望在呼叫時傳遞一個顯式塊
<code>ActiveSupport::Callbacks.set_callback</code>。這種變化源於
<code>ActiveSupport::Callbacks</code> 在 4.1 版本中被大量重寫。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 以前在 Rails 4.0</span>
<span class="n">set_callback</span> <span class="ss">:save</span><span class="p">,</span> <span class="ss">:around</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span> <span class="n">stuff</span><span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">;</span> <span class="n">stuff</span> <span class="p">}</span>

<span class="c1"># 現在在 Rails 4.1</span>
<span class="n">set_callback</span> <span class="ss">:save</span><span class="p">,</span> <span class="ss">:around</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span> <span class="p">{</span> <span class="n">stuff</span><span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">;</span> <span class="n">stuff</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 以前在 Rails 4.0
set_callback :save, :around, -&gt;(r, &amp;block) { stuff; result = block.call; stuff }

# 現在在 Rails 4.1
set_callback :save, :around, -&gt;(r, block) { stuff; result = block.call; stuff }
">Copy</button>
</div>
<h3 id="rails-3-2-rails-4-0"><a class="anchorlink" href="#rails-3-2-rails-4-0">10 從 Rails 3.2 升級到 Rails 4.0</a></h3><p>如果您的應用程式當前在任何早於 3.2.x 的 Rails 版本上，您應該先升級到 Rails 3.2，然後再嘗試升級到 Rails 4.0。</p><p>以下更改的目標在於將您的應用程序升級到 Rails 4.0。</p><h4 id="http"><a class="anchorlink" href="#http">10.1 HTTP 補丁</a></h4><p>Rails 4 現在使用 <code>PATCH</code> 作為 RESTful 更新的主要 HTTP 動詞
資源在 <code>config/routes.rb</code> 中宣告。 <code>update</code> action 仍在使用，
並且 <code>PUT</code> 請求也將繼續路由到 <code>update</code> action。
因此，如果您僅使用標準 RESTful 路由，則無需進行任何更改：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:users</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="resources :users
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="vi">@user</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= form_for @user do |f| %&gt;
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="c1"># No change needed; PATCH will be preferred, and PUT will still work.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class UsersController &lt; ApplicationController
  def update
    # No change needed; PATCH will be preferred, and PUT will still work.
  end
end
">Copy</button>
</div>
<p>但是，如果您使用 <code>form_for</code> 進行更新，則需要進行更改
使用 <code>PUT</code> HTTP 方法將資源與自定義路由結合使用：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">put</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="ss">on: :member</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="resources :users do
  put :update_name, on: :member
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="p">[</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="vi">@user</span> <span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= form_for [ :update_name, @user ] do |f| %&gt;
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">update_name</span>
    <span class="c1"># Change needed; form_for will try to use a non-existent PATCH route.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class UsersController &lt; ApplicationController
  def update_name
    # Change needed; form_for will try to use a non-existent PATCH route.
  end
end
">Copy</button>
</div>
<p>如果公共 API 中未使用 action 並且您可以自由更改
HTTP 方法，您可以更新您的路由以使用 <code>patch</code> 而不是 <code>put</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">patch</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="ss">on: :member</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="resources :users do
  patch :update_name, on: :member
end
">Copy</button>
</div>
<p><code>PUT</code> 對 Rails 4 中的 <code>/users/:id</code> 的請求被路由到 <code>update</code>，因為它們是
今天。因此，如果您有一個可以獲取真實 PUT 請求的 API，它就會起作用。
路由器還將 <code>PATCH</code> 請求路由到 <code>/users/:id</code> 到 <code>update</code> action。</p><p>如果在公共 API 中使用 action 並且您無法更改為 HTTP 方法
正在使用，您可以更新表單以使用 <code>PUT</code> 方法：</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="p">[</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="vi">@user</span> <span class="p">],</span> <span class="ss">method: :put</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= form_for [ :update_name, @user ], method: :put do |f| %&gt;
">Copy</button>
</div>
<p>有關 PATCH 的更多資訊以及進行此更改的原因，請參閱 <a href="https://weblog.rubyonrails.org/2012/2/26/edge-rails-patch-is-the-new-primary-http-method-for-updates/">這篇文章</a>
在 Rails 部落格上。</p><h5 id=""><a class="anchorlink" href="#">10.1.1 關於媒體型別的說明</a></h5><p><code>PATCH</code> 動詞的勘誤表 <a href="http://www.rfc-editor.org/errata_search.php?rfc=5789">指定'diff' 媒體型別應該是
與 <code>PATCH</code> 一起使用</a>。一
這種格式是<a href="https://tools.ietf.org/html/rfc6902">JSON Patch</a>。而 Rails
本身不支援 JSON Patch，新增支援很容易：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 在您的 controller 中：</span>
<span class="k">def</span> <span class="nf">update</span>
  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
    <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="k">do</span>
      <span class="c1"># perform a partial update</span>
      <span class="vi">@article</span><span class="p">.</span><span class="nf">update</span> <span class="n">params</span><span class="p">[</span><span class="ss">:article</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="nb">format</span><span class="p">.</span><span class="nf">json_patch</span> <span class="k">do</span>
      <span class="c1"># perform sophisticated change</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 在您的 controller 中：
def update
  respond_to do |format|
    format.json do
      # perform a partial update
      @article.update params[:article]
    end

    format.json_patch do
      # perform sophisticated change
    end
  end
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/json_patch.rb</span>
<span class="no">Mime</span><span class="o">::</span><span class="no">Type</span><span class="p">.</span><span class="nf">register</span> <span class="s1">'application/json-patch+json'</span><span class="p">,</span> <span class="ss">:json_patch</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/initializers/json_patch.rb
Mime::Type.register 'application/json-patch+json', :json_patch
">Copy</button>
</div>
<p>由於 JSON Patch 最近才被製作成 RFC，所以沒有很多很棒的
Ruby 庫還沒有。亞倫帕特森的
<a href="https://github.com/tenderlove/hana">hana</a> 就是這樣一種寶石，但沒有
完全支援規範中的最後幾個更改。</p><h4 id="rails-3-2-rails-4-0-gemfile"><a class="anchorlink" href="#rails-3-2-rails-4-0-gemfile">10.2 Gemfile</a></h4><p>Rails 4.0 從 <code>Gemfile</code> 中刪除了 <code>assets</code> 組。你需要刪除它
升級時從 <code>Gemfile</code> 行。您還應該更新您的應用程式
檔案（在 <code>config/application.rb</code> 中）：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 需要 Gemfile 中列出的寶石，包括任何寶石</span>
<span class="c1"># 你只限於:test、:development 或:production。</span>
<span class="no">Bundler</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="o">*</span><span class="no">Rails</span><span class="p">.</span><span class="nf">groups</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 需要 Gemfile 中列出的寶石，包括任何寶石
# 你只限於:test、:development 或:production。
Bundler.require(*Rails.groups)
">Copy</button>
</div>
<h4 id="rails-3-2-rails-4-0-"><a class="anchorlink" href="#rails-3-2-rails-4-0-">10.3 供應商/外掛</a></h4><p>Rails 4.0 不再支援從 <code>vendor/plugins</code> 載入外掛。您必須通過將它們提取到 gems 並將它們新增到您的 <code>Gemfile</code> 來替換任何外掛。如果您選擇不讓它們成為寶石，您可以將它們移動到 <code>lib/my_plugin/*</code> 中，並在 <code>config/initializers/my_plugin.rb</code> 中新增適當的初始化程式。</p><h4 id="rails-3-2-rails-4-0-active-record"><a class="anchorlink" href="#rails-3-2-rails-4-0-active-record">10.4 Active Record</a></h4>
<ul>
<li><p>Rails 4.0 已經從 Active Record 中刪除了身份對映，因為<a href="https://github.com/rails/rails/commit/302c912bf6bcd0fa200d964ec2dc4a44abe328a6">與 associations 的一些不一致</a>。如果您已在應用程式中手動啟用它，則必須刪除以下不再起作用的設定：<code>config.active_record.identity_map</code>。</p></li>
<li><p>associations 集合中的 <code>delete</code> 方法現在可以接收 <code>Integer</code> 或 <code>String</code> 引數作為記錄 ID，除了記錄之外，與 <code>destroy</code> 方法非常相似。以前它為此類引數引發了 <code>ActiveRecord::AssociationTypeMismatch</code>。從 Rails 4.0 開始，<code>delete</code> 會在刪除之前自動嘗試查詢與給定 id 匹配的記錄。</p></li>
<li><p>在 Rails 4.0 中，當列或表被重新命名時，相關索引也被重新命名。如果您有重新命名索引的 migrations，則不再需要它們。</p></li>
<li><p>Rails 4.0 已將 <code>serialized_attributes</code> 和 <code>attr_readonly</code> 更改為僅類方法。您不應該使用實例方法，因為它現在已被棄用。您應該將它們更改為使用類方法，例如<code>self.serialized_attributes</code> 到 <code>self.class.serialized_attributes</code>。</p></li>
<li><p>使用預設編碼器時，將 <code>nil</code> 分配給序列化屬性將儲存它
到資料庫作為 <code>NULL</code> 而不是通過 YAML (<code>"--- \n...\n"</code>) 傳遞 <code>nil</code> value。</p></li>
<li><p>Rails 4.0 刪除了 <code>attr_accessible</code> 和 <code>attr_protected</code> 功能，支援強引數。您可以使用 <a href="https://github.com/rails/protected_attributes">Protected Attributes gem</a> 獲得平滑的升級路徑。</p></li>
<li><p>如果您沒有使用受保護的屬性，您可以刪除任何相關的選項
這個 gem 如 <code>whitelist_attributes</code> 或 <code>mass_assignment_sanitizer</code> 選項。</p></li>
<li>
<p>Rails 4.0 要求作用域使用可呼叫物件，例如 Proc 或 lambda：</p>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="n">where</span><span class="p">(</span><span class="ss">active: </span><span class="kp">true</span><span class="p">)</span>

  <span class="c1"># becomes</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="  scope :active, where(active: true)

  # becomes
  scope :active, -&gt; { where active: true }
">Copy</button>
</div>
</li>
<li><p>Rails 4.0 已棄用 <code>ActiveRecord::Fixtures</code> 而支援 <code>ActiveRecord::FixtureSet</code>。</p></li>
<li><p>Rails 4.0 已棄用 <code>ActiveRecord::TestCase</code> 而支援 <code>ActiveSupport::TestCase</code>。</p></li>
<li><p>Rails 4.0 已棄用舊式根據雜湊的查詢器 API。這意味著
以前接受“查詢器選項”的方法不再適用。例如，<code>Book.find(:all, conditions: { name: '1984' })</code> 已被棄用，取而代之的是 <code>Book.where(name: '1984')</code></p></li>
<li>
<p>除 <code>find_by_...</code> 和 <code>find_by_...!</code> 之外的所有動態方法均已棄用。
以下是處理更改的方法：</p>
<ul>
<li>
<code>find_all_by_...</code> 變成 <code>where(...)</code>。</li>
<li>
<code>find_last_by_...</code> 變成 <code>where(...).last</code>。</li>
<li>
<code>scoped_by_...</code> 變成 <code>where(...)</code>。</li>
<li>
<code>find_or_initialize_by_...</code> 變成 <code>find_or_initialize_by(...)</code>。</li>
<li>
<code>find_or_create_by_...</code> 變成 <code>find_or_create_by(...)</code>。</li>
</ul>
</li>
<li><p>請注意，<code>where(...)</code> 返回一個關係，而不是像舊查詢器那樣的陣列。如果您需要 <code>Array</code>，請使用 <code>where(...).to_a</code>。</p></li>
<li><p>這些等效方法可能不會執行與先前實現相同的 SQL。</p></li>
<li><p>要重新啟用舊的查詢器，您可以使用 <a href="https://github.com/rails/activerecord-deprecated_finders">activerecord-deprecated_finders gem</a>。</p></li>
<li>
<p>Rails 4.0 已更改為 <code>has_and_belongs_to_many</code> 關係的預設連線表，以去除第二個表名的公共字首。必須使用 <code>join_table</code> 選項指定 models 與公共字首之間的任何現有 <code>has_and_belongs_to_many</code> 關係。例如：</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="no">CatalogCategory</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:catalog_products</span><span class="p">,</span> <span class="ss">join_table: </span><span class="s1">'catalog_categories_catalog_products'</span>
<span class="k">end</span>

<span class="no">CatalogProduct</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:catalog_categories</span><span class="p">,</span> <span class="ss">join_table: </span><span class="s1">'catalog_categories_catalog_products'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="CatalogCategory &lt; ActiveRecord::Base
  has_and_belongs_to_many :catalog_products, join_table: 'catalog_categories_catalog_products'
end

CatalogProduct &lt; ActiveRecord::Base
  has_and_belongs_to_many :catalog_categories, join_table: 'catalog_categories_catalog_products'
end
">Copy</button>
</div>
</li>
<li><p>注意字首也考慮了作用域，所以 <code>Catalog::Category</code> 和 <code>Catalog::Product</code> 或 <code>Catalog::Category</code> 和 <code>CatalogProduct</code> 之間的關係需要類似地更新。</p></li>
</ul>
<h4 id=""><a class="anchorlink" href="#">10.5 活動資源</a></h4><p>Rails 4.0 將 Active Resource 提取到自己的 gem 中。如果您仍然需要該功能，您可以在您的 <code>Gemfile</code> 中新增 <a href="https://github.com/rails/activeresource">Active Resource gem</a>。</p><h4 id="active-model"><a class="anchorlink" href="#active-model">10.6 Active Model</a></h4>
<ul>
<li><p>Rails 4.0 改變了錯誤附加到 <code>ActiveModel::Validations::ConfirmationValidator</code> 的方式。現在，當確認驗證失敗時，錯誤將附加到 <code>:#{attribute}_confirmation</code> 而不是 <code>attribute</code>。</p></li>
<li>
<p>Rails 4.0 已將 <code>ActiveModel::Serializers::JSON.include_root_in_json</code> 預設 value 更改為 <code>false</code>。現在，Active Model Serializers 和 Active Record 物件具有相同的預設行為。這意味著您可以在 <code>config/initializers/wrap_parameters.rb</code> 檔案中註釋或刪除以下選項：</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Disable root element in JSON by default.</span>
<span class="c1"># ActiveSupport.on_load(:active_record) do</span>
<span class="c1">#   self.include_root_in_json = false</span>
<span class="c1"># end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Disable root element in JSON by default.
# ActiveSupport.on_load(:active_record) do
#   self.include_root_in_json = false
# end
">Copy</button>
</div>
</li>
</ul>
<h4 id="action-pack"><a class="anchorlink" href="#action-pack">10.7 Action Pack</a></h4>
<ul>
<li>
<p>Rails 4.0 引入了 <code>ActiveSupport::KeyGenerator</code> 並將其用作產生和驗證已簽名的 cookies（除其他外）的基礎。如果您保留現有的 <code>secret_token</code> 並新增新的 <code>secret_key_base</code>，則使用 Rails 3.x 產生的現有簽名 cookies 將透明升級。</p>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="c1"># config/initializers/secret_token.rb</span>
  <span class="no">Myapp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">secret_token</span> <span class="o">=</span> <span class="s1">'existing secret token'</span>
  <span class="no">Myapp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">secret_key_base</span> <span class="o">=</span> <span class="s1">'new secret key base'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="  # config/initializers/secret_token.rb
  Myapp::Application.config.secret_token = 'existing secret token'
  Myapp::Application.config.secret_key_base = 'new secret key base'
">Copy</button>
</div>
<p>請注意，您應該等到 Rails 4.x 上擁有 100% 的使用者群併合理確定您不需要回滾到 Rails 3.x 時再設定 <code>secret_key_base</code>。這是因為根據 Rails 4.x 中新的 <code>secret_key_base</code> 簽名的 cookies 不向後相容 Rails 3.x。您可以隨意保留現有的 <code>secret_token</code>，而不是設定新的 <code>secret_key_base</code>，並忽略棄用警告，直到您有理由確定升級已完成。</p>
<p>如果您依賴於外部應用程式或 JavaScript 能夠讀取 Rails 應用程式的已簽名 session cookies（或一般已簽名 cookies）的能力，則在解除這些問題之前不應設定 <code>secret_key_base</code>。</p>
</li>
<li>
<p>如果設定了 <code>secret_key_base</code>，Rails 4.0 會加密根據 cookie 的 sessions 的內容。 Rails 3.x 已簽名但未加密根據 cookie 的會話的內容。簽名的 cookies 是“安全的”，因為它們經過驗證是由您的應用程式產生的並且是防篡改的。但是，終端使用者可以對內容進行 viewed，並且對內容進行加密可以消除這種警告/擔憂，而不會顯著降低效能。</p>
<p>請閱讀 <a href="https://github.com/rails/rails/pull/9978">Pull Request #9978</a> 以瞭解有關遷移到加密 session cookies 的詳細資訊。</p>
</li>
<li><p>Rails 4.0 刪除了 <code>ActionController::Base.asset_path</code> 選項。使用資產管道功能。</p></li>
<li><p>Rails 4.0 已棄用 <code>ActionController::Base.page_cache_extension</code> 選項。請改用 <code>ActionController::Base.default_static_extension</code>。</p></li>
<li><p>Rails 4.0 從 Action Pack 中移除了 Action 和頁面快取。您需要新增 <code>actionpack-action_caching</code> gem 才能在 controllers 中使用 <code>caches_action</code> 和 <code>actionpack-page_caching</code> 以使用 <code>caches_page</code>。</p></li>
<li><p>Rails 4.0 移除了 XML 引數解析器。如果您需要此功能，則需要新增 <code>actionpack-xml_parser</code> gem。</p></li>
<li><p>Rails 4.0 使用 symbols 或返回 nil 的過程更改了預設的 <code>layout</code> 查詢集。要獲得“無佈局”行為，請返回 false 而不是 nil。</p></li>
<li><p>Rails 4.0 將預設的 memcached 客戶端從 <code>memcache-client</code> 更改為 <code>dalli</code>。要升級，只需將 <code>gem 'dalli'</code> 新增到您的 <code>Gemfile</code>。</p></li>
<li><p>Rails 4.0 棄用了 controllers 中的 <code>dom_id</code> 和 <code>dom_class</code> 方法（它們在 views 中很好）。您需要在需要此功能的 controllers 中包含 <code>ActionView::RecordIdentifier</code> module。</p></li>
<li><p>Rails 4.0 棄用了 <code>link_to</code> helper 的 <code>:confirm</code> 選項。你應該
而是依賴於資料屬性（例如 <code>data: { confirm: 'Are you sure?' }</code>）。
此棄用還涉及根據此的 helpers（例如 <code>link_to_if</code>
或 <code>link_to_unless</code>）。</p></li>
<li><p>Rails 4.0 改變了 <code>assert_generates</code>、<code>assert_recognizes</code> 和 <code>assert_routing</code> 的工作方式。現在所有這些斷言都引發了 <code>Assertion</code> 而不是 <code>ActionController::RoutingError</code>。</p></li>
<li>
<p>如果定義了衝突的命名路由，Rails 4.0 會引發 <code>ArgumentError</code>。這可以由顯式定義的命名路由或 <code>resources</code> 方法觸發。以下是兩個與名為 <code>example_path</code> 的路由衝突的示例：</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="s1">'one'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
<span class="n">get</span> <span class="s1">'two'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="get 'one' =&gt; 'test#example', as: :example
get 'two' =&gt; 'test#example', as: :example
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:examples</span>
<span class="n">get</span> <span class="s1">'clashing/:id'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="resources :examples
get 'clashing/:id' =&gt; 'test#example', as: :example
">Copy</button>
</div>
<p>在第一種情況下，您可以簡單地避免對多個使用相同的名稱
路線。在第二種中，您可以使用提供的 <code>only</code> 或 <code>except</code> 選項
<code>resources</code> 方法來限制建立的路由，詳見
<a href="routing.html#restricting-the-routes-created">路由指南</a>。</p>
</li>
<li>
<p>Rails 4.0 也改變了 unicode 字元路徑的繪製方式。現在您可以直接繪製 unicode 字元路由。如果您已經繪製了此類路線，則必須對其進行更改，例如：</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="s1">'こんにちは'</span><span class="p">),</span> <span class="ss">controller: </span><span class="s1">'welcome'</span><span class="p">,</span> <span class="ss">action: </span><span class="s1">'index'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="get Rack::Utils.escape('こんにちは'), controller: 'welcome', action: 'index'
">Copy</button>
</div>
<p>變成</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="s1">'こんにちは'</span><span class="p">,</span> <span class="ss">controller: </span><span class="s1">'welcome'</span><span class="p">,</span> <span class="ss">action: </span><span class="s1">'index'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="get 'こんにちは', controller: 'welcome', action: 'index'
">Copy</button>
</div>
</li>
<li>
<p>Rails 4.0 要求使用 <code>match</code> 的路由必須指定請求方法。例如：</p>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="c1"># Rails 3.x</span>
  <span class="n">match</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="s1">'root#index'</span>

  <span class="c1"># becomes</span>
  <span class="n">match</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="s1">'root#index'</span><span class="p">,</span> <span class="ss">via: :get</span>

  <span class="c1"># or</span>
  <span class="n">get</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="s1">'root#index'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="  # Rails 3.x
  match '/' =&gt; 'root#index'

  # becomes
  match '/' =&gt; 'root#index', via: :get

  # or
  get '/' =&gt; 'root#index'
">Copy</button>
</div>
</li>
<li>
<p>Rails 4.0 已刪除 <code>ActionDispatch::BestStandardsSupport</code> 中介軟體，<code>&lt;!DOCTYPE html&gt;</code> 已根據 <a href="https://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx</a> 觸發標準模式，ChromeFrame 標頭已移至 <code>config.action_dispatch.default_headers</code>。</p>
<p>請記住，您還必須從應用程式程式碼中刪除對中介軟體的任何引用，例如：</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Raise exception</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span><span class="p">(</span><span class="no">Rack</span><span class="o">::</span><span class="no">Lock</span><span class="p">,</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">BestStandardsSupport</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Raise exception
config.middleware.insert_before(Rack::Lock, ActionDispatch::BestStandardsSupport)
">Copy</button>
</div>
<p>還要檢查 <code>config.action_dispatch.best_standards_support</code> 的環境設定並刪除它（如果存在）。</p>
</li>
<li>
<p>Rails 4.0 允許通過設定 <code>config.action_dispatch.default_headers</code> 來設定 HTTP 標頭。預設值如下：</p>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="n">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">default_headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'X-Frame-Options'</span> <span class="o">=&gt;</span> <span class="s1">'SAMEORIGIN'</span><span class="p">,</span>
    <span class="s1">'X-XSS-Protection'</span> <span class="o">=&gt;</span> <span class="s1">'1; mode=block'</span>
  <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="  config.action_dispatch.default_headers = {
    'X-Frame-Options' =&gt; 'SAMEORIGIN',
    'X-XSS-Protection' =&gt; '1; mode=block'
  }
">Copy</button>
</div>
<p>請注意，如果您的應用程式依賴於在 <code>&lt;frame&gt;</code> 或 <code>&lt;iframe&gt;</code> 中載入某些頁面，那麼您可能需要將 <code>X-Frame-Options</code> 顯式設定為 <code>ALLOW-FROM ...</code> 或 <code>ALLOWALL</code>。</p>
</li>
<li><p>在 Rails 4.0 中，預編譯資產不再自動從 <code>vendor/assets</code> 和 <code>lib/assets</code> 複製非 JS/CSS 資產。 Rails 應用和引擎開發者應該將這些資產放在 <code>app/assets</code> 或設定 <code>config.assets.precompile</code>。</p></li>
<li><p>在 Rails 4.0 中，當 action 不處理請求格式時，會引發 <code>ActionController::UnknownFormat</code>。預設情況下，通過回應 406 Not Acceptable 來處理異常，但您現在可以覆蓋它。在 Rails 3 中，總是返回 406 Not Acceptable。沒有覆蓋。</p></li>
<li><p>在 Rails 4.0 中，當 <code>ParamsParser</code> 無法解析請求引數時，會引發通用的 <code>ActionDispatch::ParamsParser::ParseError</code> 異常。例如，您將想要拯救這個異常而不是低級別的 <code>MultiJson::DecodeError</code>。</p></li>
<li><p>在 Rails 4.0 中，當引擎安裝在從 URL 字首提供的應用程式上時，<code>SCRIPT_NAME</code> 正確巢狀。您不再需要設定 <code>default_url_options[:script_name]</code> 來解決覆蓋的 URL 字首。</p></li>
<li><p>Rails 4.0 棄用了 <code>ActionController::Integration</code> 而支援 <code>ActionDispatch::Integration</code>。</p></li>
<li><p>Rails 4.0 棄用了 <code>ActionController::IntegrationTest</code> 而支援 <code>ActionDispatch::IntegrationTest</code>。</p></li>
<li><p>Rails 4.0 棄用了 <code>ActionController::PerformanceTest</code> 而支援 <code>ActionDispatch::PerformanceTest</code>。</p></li>
<li><p>Rails 4.0 棄用了 <code>ActionController::AbstractRequest</code> 而支援 <code>ActionDispatch::Request</code>。</p></li>
<li><p>Rails 4.0 棄用了 <code>ActionController::Request</code> 而支援 <code>ActionDispatch::Request</code>。</p></li>
<li><p>Rails 4.0 棄用了 <code>ActionController::AbstractResponse</code> 而支援 <code>ActionDispatch::Response</code>。</p></li>
<li><p>Rails 4.0 棄用了 <code>ActionController::Response</code> 而支援 <code>ActionDispatch::Response</code>。</p></li>
<li><p>Rails 4.0 棄用了 <code>ActionController::Routing</code> 而支援 <code>ActionDispatch::Routing</code>。</p></li>
</ul>
<h4 id="active-support"><a class="anchorlink" href="#active-support">10.8 Active Support</a></h4><p>Rails 4.0 刪除了 <code>ERB::Util#json_escape</code> 的 <code>j</code> 別名，因為 <code>j</code> 已經用於 <code>ActionView::Helpers::JavaScriptHelper#escape_javascript</code>。</p><h5 id=""><a class="anchorlink" href="#">10.8.1 快取</a></h5><p>快取方法在 Rails 3.x 和 4.0 之間發生了變化。您應該<a href="https://guides.rubyonrails.org/caching_with_rails.html#activesupport-cache-store">更改快取名稱空間</a> 並使用冷快取推出。</p><h4 id="helpers"><a class="anchorlink" href="#helpers">10.9 Helpers 載入順序</a></h4><p>從多個目錄載入 helpers 的順序在 Rails 4.0 中發生了變化。以前，它們被收集起來，然後按字母順序排序。升級到 Rails 4.0 後，helpers 將保留載入目錄的順序，並且只會在每個目錄中按字母順序排序。除非您明確使用 <code>helpers_path</code> 引數，否則此更改只會影響從引擎載入 helpers 的方式。如果您依賴排序，則應檢查升級後是否有正確的方法可用。如果你想改變引擎載入的順序，你可以使用 <code>config.railties_order=</code> 方法。</p><h4 id="active-record-observer-action-controller-sweeper"><a class="anchorlink" href="#active-record-observer-action-controller-sweeper">10.10 Active Record Observer 和 Action Controller Sweeper</a></h4><p><code>ActiveRecord::Observer</code> 和 <code>ActionController::Caching::Sweeper</code> 已被提取到 <code>rails-observers</code> gem。如果您需要這些功能，您將需要新增 <code>rails-observers</code> gem。</p><h4 id="rails"><a class="anchorlink" href="#rails">10.11 鏈輪-rails</a></h4>
<ul>
<li>
<code>assets:precompile:primary</code> 和 <code>assets:precompile:all</code> 已被刪除。請改用 <code>assets:precompile</code>。</li>
<li>
<p>應將 <code>config.assets.compress</code> 選項更改為 <code>config.assets.js_compressor</code>，例如：</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">js_compressor</span> <span class="o">=</span> <span class="ss">:uglifier</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.js_compressor = :uglifier
">Copy</button>
</div>
</li>
</ul>
<h4 id="sass-rails"><a class="anchorlink" href="#sass-rails">10.12 sass-rails</a></h4>
<ul>
<li>不推薦使用帶有兩個引數的 <code>asset-url</code>。例如：<code>asset-url("rails.png", image)</code> 變為 <code>asset-url("rails.png")</code>。</li>
</ul>
<h3 id="rails-3-1-rails-3-2"><a class="anchorlink" href="#rails-3-1-rails-3-2">11 從 Rails 3.1 升級到 Rails 3.2</a></h3><p>如果您的應用程式當前在任何早於 3.1.x 的 Rails 版本上，您
在嘗試更新到 Rails 3.2 之前，應該先升級到 Rails 3.1。</p><p>以下更改的目標在於將您的應用程序升級到最新版本
Rails 的 3.2.x 版本。</p><h4 id="rails-3-1-rails-3-2-gemfile"><a class="anchorlink" href="#rails-3-1-rails-3-2-gemfile">11.1 Gemfile</a></h4><p>對 <code>Gemfile</code> 進行以下更改。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'3.2.21'</span>

<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span>   <span class="s1">'~&gt; 3.2.6'</span>
  <span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 3.2.2'</span>
  <span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span>     <span class="s1">'&gt;= 1.0.3'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="gem 'rails', '3.2.21'

group :assets do
  gem 'sass-rails',   '~&gt; 3.2.6'
  gem 'coffee-rails', '~&gt; 3.2.2'
  gem 'uglifier',     '&gt;= 1.0.3'
end
">Copy</button>
</div>
<h4 id="rails-3-1-rails-3-2-development-rb"><a class="anchorlink" href="#rails-3-1-rails-3-2-development-rb">11.2 設定/環境/development.rb</a></h4><p>您應該將幾個新的設定設定新增到您的開發環境中：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 對 Active Record models 的批量賦值保護引發異常</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">mass_assignment_sanitizer</span> <span class="o">=</span> <span class="ss">:strict</span>

<span class="c1"># 記錄查詢時間超過這個的查詢計劃（有效</span>
<span class="c1"># 使用 SQLite、MySQL 和 PostgreSQL)</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">auto_explain_threshold_in_seconds</span> <span class="o">=</span> <span class="mf">0.5</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 對 Active Record models 的批量賦值保護引發異常
config.active_record.mass_assignment_sanitizer = :strict

# 記錄查詢時間超過這個的查詢計劃（有效
# 使用 SQLite、MySQL 和 PostgreSQL)
config.active_record.auto_explain_threshold_in_seconds = 0.5
">Copy</button>
</div>
<h4 id="rails-3-1-rails-3-2-test-rb"><a class="anchorlink" href="#rails-3-1-rails-3-2-test-rb">11.3 設定/環境/test.rb</a></h4><p><code>mass_assignment_sanitizer</code> 設定設定也應該新增到 <code>config/environments/test.rb</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 對 Active Record models 的批量賦值保護引發異常</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">mass_assignment_sanitizer</span> <span class="o">=</span> <span class="ss">:strict</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 對 Active Record models 的批量賦值保護引發異常
config.active_record.mass_assignment_sanitizer = :strict
">Copy</button>
</div>
<h4 id="rails-3-1-rails-3-2"><a class="anchorlink" href="#rails-3-1-rails-3-2">11.4 供應商/外掛</a></h4><p>Rails 3.2 棄用 <code>vendor/plugins</code> 和 Rails 4.0 將完全刪除它們。雖然作為 Rails 3.2 升級的一部分並不是絕對必要的，但您可以通過將它們提取到 gem 並將它們新增到您的 <code>Gemfile</code> 來開始替換任何外掛。如果您選擇不讓它們成為寶石，您可以將它們移動到 <code>lib/my_plugin/*</code> 中，並在 <code>config/initializers/my_plugin.rb</code> 中新增適當的初始化程式。</p><h4 id="rails-3-1-rails-3-2-active-record"><a class="anchorlink" href="#rails-3-1-rails-3-2-active-record">11.5 Active Record</a></h4><p>選項 <code>:dependent =&gt; :restrict</code> 已從 <code>belongs_to</code> 中刪除。如果你想阻止刪除物件，如果有任何關聯物件，你可以設定 <code>:dependent =&gt; :destroy</code> 並在從任何關聯物件的銷燬 callbacks 檢查是否存在 association 後返回 <code>false</code>。</p><h3 id="rails-3-0-rails-3-1"><a class="anchorlink" href="#rails-3-0-rails-3-1">12 從 Rails 3.0 升級到 Rails 3.1</a></h3><p>如果您的應用程式當前在任何早於 3.0.x 的 Rails 版本上，您應該在嘗試更新到 Rails 3.1 之前升級到 Rails 3.0。</p><p>以下更改的目標在於將您的應用程序升級到 Rails 3.1.12，即 Rails 的最後一個 3.1.x 版本。</p><h4 id="gemfile"><a class="anchorlink" href="#gemfile">12.1 Gemfile</a></h4><p>對 <code>Gemfile</code> 進行以下更改。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'3.1.12'</span>
<span class="n">gem</span> <span class="s1">'mysql2'</span>

<span class="c1"># 新的 asset pipeline 需要</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span>   <span class="s1">'~&gt; 3.1.7'</span>
  <span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 3.1.1'</span>
  <span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span>     <span class="s1">'&gt;= 1.0.3'</span>
<span class="k">end</span>

<span class="c1"># jQuery 是 Rails 3.1 中預設的 JavaScript 庫</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="gem 'rails', '3.1.12'
gem 'mysql2'

# 新的 asset pipeline 需要
group :assets do
  gem 'sass-rails',   '~&gt; 3.1.7'
  gem 'coffee-rails', '~&gt; 3.1.1'
  gem 'uglifier',     '&gt;= 1.0.3'
end

# jQuery 是 Rails 3.1 中預設的 JavaScript 庫
gem 'jquery-rails'
">Copy</button>
</div>
<h4 id="config-application-rb"><a class="anchorlink" href="#config-application-rb">12.2 config/application.rb</a></h4><p>asset pipeline 需要新增以下內容：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">version</span> <span class="o">=</span> <span class="s1">'1.0'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.enabled = true
config.assets.version = '1.0'
">Copy</button>
</div>
<p>如果您的應用程式對資源使用“/assets”路由，您可能需要更改用於資產的字首以避免衝突：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 預設為'/assets'</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">prefix</span> <span class="o">=</span> <span class="s1">'/asset-files'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 預設為'/assets'
config.assets.prefix = '/asset-files'
">Copy</button>
</div>
<h4 id="rails-3-0-rails-3-1-development-rb"><a class="anchorlink" href="#rails-3-0-rails-3-1-development-rb">12.3 設定/環境/development.rb</a></h4><p>刪除 RJS 設定 <code>config.action_view.debug_rjs = true</code>。</p><p>如果啟用 asset pipeline，請新增這些設定：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 不壓縮資產</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compress</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># 展開載入資產的行</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">debug</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 不壓縮資產
config.assets.compress = false

# 展開載入資產的行
config.assets.debug = true
">Copy</button>
</div>
<h4 id="config-environments-production-rb"><a class="anchorlink" href="#config-environments-production-rb">12.4 config/environments/production.rb</a></h4><p>同樣，下面的大部分更改都是針對 asset pipeline 的。您可以在 <a href="asset_pipeline.html">Asset Pipeline</a> 指南中閱讀有關這些的更多資訊。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 壓縮 JavaScript 和 CSS</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compress</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># 如果缺少預編譯資產，不要回退到資產管道</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compile</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># 為資產 URL 產生摘要</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">digest</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># 預設為 Rails.root.join("public/assets")</span>
<span class="c1"># config.assets.manifest = YOUR_PATH</span>

<span class="c1"># 預編譯附加資產（application.js、application.css 和所有非 JS/CSS 都已新增）</span>
<span class="c1"># config.assets.precompile += %w( admin.js admin.css )</span>

<span class="c1"># 強制通過 SSL 訪問應用程式，使用 Strict-Transport-Security，並使用安全的 cookies。</span>
<span class="c1"># config.force_ssl = true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# 壓縮 JavaScript 和 CSS
config.assets.compress = true

# 如果缺少預編譯資產，不要回退到資產管道
config.assets.compile = false

# 為資產 URL 產生摘要
config.assets.digest = true

# 預設為 Rails.root.join("public/assets")
# config.assets.manifest = YOUR_PATH

# 預編譯附加資產（application.js、application.css 和所有非 JS/CSS 都已新增）
# config.assets.precompile += %w( admin.js admin.css )

# 強制通過 SSL 訪問應用程式，使用 Strict-Transport-Security，並使用安全的 cookies。
# config.force_ssl = true
'>Copy</button>
</div>
<h4 id="rails-3-0-rails-3-1-test-rb"><a class="anchorlink" href="#rails-3-0-rails-3-1-test-rb">12.5 設定/環境/test.rb</a></h4><p>您可以通過在測試環境中新增這些內容來幫助測試效能：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 設定靜態資源伺服器以使用 Cache-Control 進行效能測試</span>
<span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'Cache-Control'</span> <span class="o">=&gt;</span> <span class="s1">'public, max-age=3600'</span>
<span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 設定靜態資源伺服器以使用 Cache-Control 進行效能測試
config.public_file_server.enabled = true
config.public_file_server.headers = {
  'Cache-Control' =&gt; 'public, max-age=3600'
}
">Copy</button>
</div>
<h4 id="config-initializers-wrap-parameters-rb"><a class="anchorlink" href="#config-initializers-wrap-parameters-rb">12.6 config/initializers/wrap_parameters.rb</a></h4><p>如果您希望將引數包裝到巢狀雜湊中，請使用以下內容新增此檔案。這在新應用程式中預設開啟。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 修改這個檔案的時候一定要重啟伺服器。</span>
<span class="c1"># 該檔案包含 ActionController::ParamsWrapper 的設定</span>
<span class="c1"># 預設啟用。</span>

<span class="c1"># 為 JSON 啟用引數包裝。您可以通過將 :format 設定為空陣列來禁用此功能。</span>
<span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:action_controller</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">wrap_parameters</span> <span class="ss">format: </span><span class="p">[</span><span class="ss">:json</span><span class="p">]</span>
<span class="k">end</span>

<span class="c1"># 預設禁用 JSON 中的根元素。</span>
<span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:active_record</span><span class="p">)</span> <span class="k">do</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">include_root_in_json</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 修改這個檔案的時候一定要重啟伺服器。
# 該檔案包含 ActionController::ParamsWrapper 的設定
# 預設啟用。

# 為 JSON 啟用引數包裝。您可以通過將 :format 設定為空陣列來禁用此功能。
ActiveSupport.on_load(:action_controller) do
  wrap_parameters format: [:json]
end

# 預設禁用 JSON 中的根元素。
ActiveSupport.on_load(:active_record) do
  self.include_root_in_json = false
end
">Copy</button>
</div>
<h4 id="session-store-rb"><a class="anchorlink" href="#session-store-rb">12.7 設定/初始化程式/session_store.rb</a></h4><p>您需要將會話 key 更改為新的內容，或刪除所有 sessions：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 在 config/initializers/session_store.rb</span>
<span class="no">AppName</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">session_store</span> <span class="ss">:cookie_store</span><span class="p">,</span> <span class="ss">key: </span><span class="s1">'SOMETHINGNEW'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 在 config/initializers/session_store.rb
AppName::Application.config.session_store :cookie_store, key: 'SOMETHINGNEW'
">Copy</button>
</div>
<p>或者</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>bin/rake db:sessions:clear
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rake db:sessions:clear
">Copy</button>
</div>
<h4 id="views-helpers-cache-concat"><a class="anchorlink" href="#views-helpers-cache-concat">12.8 移除 views 中資產 helpers 引用中的 :cache 和 :concat 選項</a></h4>
<ul>
<li>對於 Asset Pipeline，不再使用 :cache 和 :concat 選項，請從 views 中刪除這些選項。</li>
</ul>


        <h3>回饋</h3>
        <p>
          我們鼓勵您幫助提高本指南的品質。
        </p>
        <p>
          如果您發現任何拼寫錯誤或資訊錯誤，請提供回饋。
          要開始回饋，您可以閱讀我們的 <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">回饋</a> 部分。
        </p>
        <p>
          您還可能會發現不完整的內容或不是最新的內容。
          請務必為 main 新增任何遺漏的文件。假設是
          <a href="https://edgeguides.rubyonrails.org">非穩定版指南(edge guides)</a> 請先驗證問題是否已經在主分支上解決。
          請前往 <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南寫作準則</a> 查看寫作風格和慣例。
        </p>
        <p>
          如果由於某種原因您發現要修復的內容但無法自行修補，請您 <a href="https://github.com/rails/rails/issues">提出 issue</a>。
        </p>
        <p>關於 Ruby on Rails 的任何類型的討論歡迎提供任何文件至 <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">rubyonrails-docs 討論區</a>。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>本作品已獲得<a href="https://creativecommons.org/licenses/by-sa/4.0/">知識共享署名-相同方式共享 4.0 國際</a>許可</p>
<p>“Rails”、“Ruby on Rails”和 Rails 標誌是 David Heinemeier Hansson 的商標。 保留所有權利。</p>
    </div>
  </div>
</body>
</html>
