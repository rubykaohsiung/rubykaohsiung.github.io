<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>åœ¨ Rails ä¸Šå‡ç´š Ruby â€” Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="åœ¨ Rails ä¸Šå‡ç´š Ruby â€” Ruby on Rails Guides" />
  <meta name="description" content="åœ¨ Rails ä¸Šå‡ç´š Rubyæœ¬æŒ‡å—æä¾›äº†åœ¨ Rails ä¸Šå°‡æ‡‰ç”¨ç¨‹åºå‡ç´šåˆ°è¼ƒæ–°ç‰ˆæœ¬çš„ Ruby æ™‚è¦éµå¾ªçš„æ­¥é©Ÿã€‚é€™äº›æ­¥é©Ÿä¹Ÿå¯åœ¨å–®ç¨çš„ç™¼è¡ŒæŒ‡å—ä¸­æ‰¾åˆ°ã€‚" />
  <meta property="og:description" content="åœ¨ Rails ä¸Šå‡ç´š Rubyæœ¬æŒ‡å—æä¾›äº†åœ¨ Rails ä¸Šå°‡æ‡‰ç”¨ç¨‹åºå‡ç´šåˆ°è¼ƒæ–°ç‰ˆæœ¬çš„ Ruby æ™‚è¦éµå¾ªçš„æ­¥é©Ÿã€‚é€™äº›æ­¥é©Ÿä¹Ÿå¯åœ¨å–®ç¨çš„ç™¼è¡ŒæŒ‡å—ä¸­æ‰¾åˆ°ã€‚" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.0</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">æ›´å¤šè³‡è¨Šè«‹å‰å¾€ <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        æ›´å¤šåœ¨ Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">éƒ¨è½æ ¼</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">æŒ‡å—</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">è«–å£‡</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">åœ¨ GitHub ä¸Šåšå‡ºè²¢ç»</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="è¿”å›é¦–é ">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">é¦–é </a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">æ‰‹å†Šç›®éŒ„</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>å¾é€™è£¡é–‹å§‹</dt>
                  <dd><a href="getting_started.html">Rails å…¥é–€</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record åŸºç¤</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record é·ç§» (Migrations)</a></dd>
                  <dd><a href="active_record_validations.html">Active Record é©—è­‰ (Validations)</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record å›å‘¼ (Callbacks)</a></dd>
                  <dd><a href="association_basics.html">Active Record é—œè¯ (Associations)</a></dd>
                  <dd><a href="active_record_querying.html">Active Record æŸ¥è©¢ä»‹é¢</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="layouts_and_rendering.html">Rails ä¸­çš„ç‰ˆé¢é…ç½®(Layouts)å’Œç®—ç¹ª(Rendering)</a></dd>
                  <dd><a href="form_helpers.html">Action View è¡¨å–® Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller æ¦‚è¿°</a></dd>
                  <dd><a href="routing.html">Rails å¾å¤–åˆ°å…§è·¯ç”±</a></dd>
                </div>
                <div class="guides-section">
                  <dt>å…¶ä»–å…ƒä»¶</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support æ ¸å¿ƒæ“´å……å¥—ä»¶</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer åŸºç¤çŸ¥è­˜</a></dd>
                  <dd><a href="active_job_basics.html">Active Job åŸºç¤</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage æ¦‚è¿°</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable æ¦‚è¿°</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>æ·±å…¥ç ”ç©¶</dt>
                  <dd><a href="i18n.html">Rails åœ‹éš›åŒ– (I18n) API</a></dd>
                  <dd><a href="testing.html">æ¸¬è©¦ Rails æ‡‰ç”¨ç¨‹å¼</a></dd>
                  <dd><a href="security.html">ä¿è­· Rails æ‡‰ç”¨ç¨‹å¼</a></dd>
                  <dd><a href="debugging_rails_applications.html">é™¤éŒ¯ Rails æ‡‰ç”¨ç¨‹å¼</a></dd>
                  <dd><a href="configuring.html">è¨­å®š Rails æ‡‰ç”¨ç¨‹å¼</a></dd>
                  <dd><a href="command_line.html">Rails å‘½ä»¤åˆ—</a></dd>
                  <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">è‡ªå‹•è¼‰å…¥å’Œé‡æ–°è¼‰å…¥å¸¸é‡</a></dd>
                  <dd><a href="caching_with_rails.html">ä½¿ç”¨ Rails å¿«å–</a></dd>
                  <dd><a href="api_app.html">å°‡ Rails ç”¨æ–¼åƒ… API çš„æ‡‰ç”¨ç¨‹å¼</a></dd>
                </div>
                <div class="guides-section">
                  <dt>æ“´å…… rails</dt>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">å»ºç«‹å’Œè‡ªå®šç¾© Rails ç”¢ç”Ÿå™¨å’Œæ¨¡æ¿</a></dd>
                </div>
                <div class="guides-section">
                  <dt>è²¢ç»</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">åœ¨ Rails ä¸Šç‚º Ruby åšè²¢ç»</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API æ–‡ä»¶æŒ‡å—</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">æŒ‡å—æŒ‡å—</a></dd>
                </div>
                <div class="guides-section">
                  <dt>æ”¿ç­–</dt>
                  <dd><a href="maintenance_policy.html">ç¶­ä¿®æ”¿ç­–</a></dd>
                </div>
                <div class="guides-section">
                  <dt>ç™¼è¡Œèªªæ˜</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">åœ¨ Rails ä¸Šå‡ç´š Ruby</a></dd>
                  <dd><a href="6_1_release_notes.html">6.1 ç‰ˆ - 2020 å¹´ 12 æœˆ</a></dd>
                  <dd><a href="6_0_release_notes.html">6.0 ç‰ˆ - 2019 å¹´ 8 æœˆ</a></dd>
                  <dd><a href="5_2_release_notes.html">5.2 ç‰ˆ - 2018 å¹´ 4 æœˆ</a></dd>
                  <dd><a href="5_1_release_notes.html">5.1 ç‰ˆ - 2017 å¹´ 4 æœˆ</a></dd>
                  <dd><a href="5_0_release_notes.html">5.0 ç‰ˆ - 2016 å¹´ 6 æœˆ</a></dd>
                  <dd><a href="4_2_release_notes.html">4.2 ç‰ˆ - 2014 å¹´ 12 æœˆ</a></dd>
                  <dd><a href="4_1_release_notes.html">4.1 ç‰ˆ - 2014 å¹´ 4 æœˆ</a></dd>
                  <dd><a href="4_0_release_notes.html">4.0 ç‰ˆ - 2013 å¹´ 6 æœˆ</a></dd>
                  <dd><a href="3_2_release_notes.html">3.2 ç‰ˆ - 2012 å¹´ 1 æœˆ</a></dd>
                  <dd><a href="3_1_release_notes.html">3.1 ç‰ˆ - 2011 å¹´ 8 æœˆ</a></dd>
                  <dd><a href="3_0_release_notes.html">3.0 ç‰ˆ - 2010 å¹´ 8 æœˆ</a></dd>
                  <dd><a href="2_3_release_notes.html">2.3 ç‰ˆ - 2009 å¹´ 3 æœˆ</a></dd>
                  <dd><a href="2_2_release_notes.html">2.2 ç‰ˆ - 2008 å¹´ 11 æœˆ</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">è²¢ç»</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">æ‰‹å†Šç›®éŒ„</option>
              <optgroup label="å¾é€™è£¡é–‹å§‹">
                  <option value="getting_started.html">Rails å…¥é–€</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record åŸºç¤</option>
                  <option value="active_record_migrations.html">Active Record é·ç§» (Migrations)</option>
                  <option value="active_record_validations.html">Active Record é©—è­‰ (Validations)</option>
                  <option value="active_record_callbacks.html">Active Record å›å‘¼ (Callbacks)</option>
                  <option value="association_basics.html">Active Record é—œè¯ (Associations)</option>
                  <option value="active_record_querying.html">Active Record æŸ¥è©¢ä»‹é¢</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Rails ä¸­çš„ç‰ˆé¢é…ç½®(Layouts)å’Œç®—ç¹ª(Rendering)</option>
                  <option value="form_helpers.html">Action View è¡¨å–® Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller æ¦‚è¿°</option>
                  <option value="routing.html">Rails å¾å¤–åˆ°å…§è·¯ç”±</option>
              </optgroup>
              <optgroup label="å…¶ä»–å…ƒä»¶">
                  <option value="active_support_core_extensions.html">Active Support æ ¸å¿ƒæ“´å……å¥—ä»¶</option>
                  <option value="action_mailer_basics.html">Action Mailer åŸºç¤çŸ¥è­˜</option>
                  <option value="active_job_basics.html">Active Job åŸºç¤</option>
                  <option value="active_storage_overview.html">Active Storage æ¦‚è¿°</option>
                  <option value="action_cable_overview.html">Action Cable æ¦‚è¿°</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="æ·±å…¥ç ”ç©¶">
                  <option value="i18n.html">Rails åœ‹éš›åŒ– (I18n) API</option>
                  <option value="testing.html">æ¸¬è©¦ Rails æ‡‰ç”¨ç¨‹å¼</option>
                  <option value="security.html">ä¿è­· Rails æ‡‰ç”¨ç¨‹å¼</option>
                  <option value="debugging_rails_applications.html">é™¤éŒ¯ Rails æ‡‰ç”¨ç¨‹å¼</option>
                  <option value="configuring.html">è¨­å®š Rails æ‡‰ç”¨ç¨‹å¼</option>
                  <option value="command_line.html">Rails å‘½ä»¤åˆ—</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="autoloading_and_reloading_constants.html">è‡ªå‹•è¼‰å…¥å’Œé‡æ–°è¼‰å…¥å¸¸é‡</option>
                  <option value="caching_with_rails.html">ä½¿ç”¨ Rails å¿«å–</option>
                  <option value="api_app.html">å°‡ Rails ç”¨æ–¼åƒ… API çš„æ‡‰ç”¨ç¨‹å¼</option>
              </optgroup>
              <optgroup label="æ“´å…… rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">å»ºç«‹å’Œè‡ªå®šç¾© Rails ç”¢ç”Ÿå™¨å’Œæ¨¡æ¿</option>
              </optgroup>
              <optgroup label="è²¢ç»">
                  <option value="contributing_to_ruby_on_rails.html">åœ¨ Rails ä¸Šç‚º Ruby åšè²¢ç»</option>
                  <option value="api_documentation_guidelines.html">API æ–‡ä»¶æŒ‡å—</option>
                  <option value="ruby_on_rails_guides_guidelines.html">æŒ‡å—æŒ‡å—</option>
              </optgroup>
              <optgroup label="æ”¿ç­–">
                  <option value="maintenance_policy.html">ç¶­ä¿®æ”¿ç­–</option>
              </optgroup>
              <optgroup label="ç™¼è¡Œèªªæ˜">
                  <option value="upgrading_ruby_on_rails.html">åœ¨ Rails ä¸Šå‡ç´š Ruby</option>
                  <option value="6_1_release_notes.html">6.1 ç‰ˆ - 2020 å¹´ 12 æœˆ</option>
                  <option value="6_0_release_notes.html">6.0 ç‰ˆ - 2019 å¹´ 8 æœˆ</option>
                  <option value="5_2_release_notes.html">5.2 ç‰ˆ - 2018 å¹´ 4 æœˆ</option>
                  <option value="5_1_release_notes.html">5.1 ç‰ˆ - 2017 å¹´ 4 æœˆ</option>
                  <option value="5_0_release_notes.html">5.0 ç‰ˆ - 2016 å¹´ 6 æœˆ</option>
                  <option value="4_2_release_notes.html">4.2 ç‰ˆ - 2014 å¹´ 12 æœˆ</option>
                  <option value="4_1_release_notes.html">4.1 ç‰ˆ - 2014 å¹´ 4 æœˆ</option>
                  <option value="4_0_release_notes.html">4.0 ç‰ˆ - 2013 å¹´ 6 æœˆ</option>
                  <option value="3_2_release_notes.html">3.2 ç‰ˆ - 2012 å¹´ 1 æœˆ</option>
                  <option value="3_1_release_notes.html">3.1 ç‰ˆ - 2011 å¹´ 8 æœˆ</option>
                  <option value="3_0_release_notes.html">3.0 ç‰ˆ - 2010 å¹´ 8 æœˆ</option>
                  <option value="2_3_release_notes.html">2.3 ç‰ˆ - 2009 å¹´ 3 æœˆ</option>
                  <option value="2_2_release_notes.html">2.2 ç‰ˆ - 2008 å¹´ 11 æœˆ</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>åœ¨ Rails ä¸Šå‡ç´š Ruby</h2><p>æœ¬æŒ‡å—æä¾›äº†åœ¨ Rails ä¸Šå°‡æ‡‰ç”¨ç¨‹åºå‡ç´šåˆ°è¼ƒæ–°ç‰ˆæœ¬çš„ Ruby æ™‚è¦éµå¾ªçš„æ­¥é©Ÿã€‚é€™äº›æ­¥é©Ÿä¹Ÿå¯åœ¨å–®ç¨çš„ç™¼è¡ŒæŒ‡å—ä¸­æ‰¾åˆ°ã€‚</p>

                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#">ä¸€èˆ¬å»ºè­°</a>

<ul>
<li><a href="#">æ¸¬è©¦è¦†è“‹ç‡</a></li>
<li><a href="#ruby">Ruby ç‰ˆæœ¬</a></li>
<li><a href="#">å‡ç´šéç¨‹</a></li>
<li><a href="#">æ›´æ–°ä»»å‹™</a></li>
<li><a href="#">è¨­å®šæ¡†æ¶é è¨­å€¼</a></li>
</ul>
</li>
<li>
<a href="#rails-6-1-rails-7-0">å¾ Rails 6.1 å‡ç´šåˆ° Rails 7.0</a>

<ul>
<li><a href="#rails-6-1-rails-7-0-">å½ˆç°§</a></li>
<li><a href="#zeitwerk">æ‡‰ç”¨ç¨‹å¼éœ€è¦åœ¨ <code>zeitwerk</code> æ¨¡å¼ä¸‹åŸ·è¡Œ</a></li>
<li><a href="#setter-config-autoloader">setter <code>config.autoloader=</code> å·²åˆªé™¤</a></li>
<li><a href="#activesupport-dependencies-api"><code>ActiveSupport::Dependencies</code>ç§æœ‰APIå·²åˆªé™¤</a></li>
<li><a href="#">åˆå§‹åŒ–æœŸé–“è‡ªå‹•è¼‰å…¥</a></li>
<li><a href="#config-autoload-once-paths">èƒ½å¤ è¨­å®š <code>config.autoload_once_paths</code></a></li>
<li><a href="#actiondispatch-request-content-type-content-type"><code>ActionDispatch::Request#content_type</code> ç¾åœ¨åŸæ¨£è¿”å› Content-Type æ¨™é ­ã€‚</a></li>
<li><a href="#key-sha256">Key ç”¢ç”Ÿå™¨æ‘˜è¦é¡æ›´æ”¹ç‚ºä½¿ç”¨ SHA256</a></li>
<li><a href="#activesupport-sha256">ActiveSupport çš„æ‘˜è¦é¡::æ‘˜è¦æ›´æ”¹ç‚º SHA256</a></li>
<li><a href="#activesupport-cache">æ–°çš„ ActiveSupport::Cache åºåˆ—åŒ–æ ¼å¼</a></li>
<li><a href="#activestorage-preview">ActiveStorage è¦–è¨Š preview å½±è±¡ç”¢ç”Ÿ</a></li>
<li><a href="#activestorage-vips">ActiveStorage è®Šé«”è™•ç†å™¨æ›´æ”¹ç‚º :vips</a></li>
</ul>
</li>
<li>
<a href="#rails-6-0-rails-6-1">å¾ Rails 6.0 å‡ç´šåˆ° Rails 6.1</a>

<ul>
<li><a href="#rails-application-config-for-value-keys"><code>Rails.application.config_for</code> è¿”å› value ä¸å†æ”¯æ´ä½¿ç”¨å­—ä¸² keys é€²è¡Œè¨ªå•ã€‚</a></li>
<li><a href="#respond-to-any-content-type">ä½¿ç”¨ <code>respond_to#any</code> æ™‚å›æ‡‰çš„ Content-Type</a></li>
<li><a href="#activesupport-callbacks-halted-callback-hook"><code>ActiveSupport::Callbacks#halted_callback_hook</code> ç¾åœ¨æ¥æ”¶ç¬¬äºŒå€‹å¼•æ•¸</a></li>
<li><a href="#controllers-helper-string-constantize">controllersä¸­çš„<code>helper</code>é¡æ–¹æ³•ä½¿ç”¨çš„æ˜¯<code>String#constantize</code></a></li>
<li><a href="#http-https-308-http">å¾ HTTP é‡å®šå‘åˆ° HTTPS ç¾åœ¨å°‡ä½¿ç”¨ 308 HTTP ç‹€æ…‹ç¨‹å¼ç¢¼</a></li>
<li><a href="#active-storage">Active Storage ç¾åœ¨éœ€è¦å½±è±¡è™•ç†</a></li>
</ul>
</li>
<li>
<a href="#rails-5-2-rails-6-0">å¾ Rails 5.2 å‡ç´šåˆ° Rails 6.0</a>

<ul>
<li><a href="#webpacker">ä½¿ç”¨ Webpacker</a></li>
<li><a href="#ssl">å¼·åˆ¶ SSL</a></li>
<li><a href="#cookies">ç›®çš„å’Œåˆ°æœŸå…ƒè³‡æ–™ç¾åœ¨åµŒå…¥åœ¨ç°½åå’ŒåŠ å¯†çš„ cookies ä¸­ä»¥æé«˜å®‰å…¨æ€§</a></li>
<li><a href="#npm-rails">æ‰€æœ‰ npm åŒ…éƒ½ç§»åˆ°äº† <code>@rails</code> ä½œç”¨åŸŸ</a></li>
<li><a href="#action-cable-javascript-api">Action Cable JavaScript API æ›´æ”¹</a></li>
<li><a href="#actiondispatch-response-content-type-content-type"><code>ActionDispatch::Response#content_type</code> ç¾åœ¨ç„¡éœ€ä¿®æ”¹å³å¯è¿”å› Content-Type æ¨™é ­</a></li>
<li><a href="#">è‡ªå‹•è¼‰å…¥</a></li>
<li><a href="#active-storage">Active Storage è³¦å€¼è¡Œç‚ºæ”¹è®Š</a></li>
</ul>
</li>
<li>
<a href="#rails-5-1-rails-5-2">å¾ Rails 5.1 å‡ç´šåˆ° Rails 5.2</a>

<ul>
<li><a href="#rails-5-1-rails-5-2">è¼‰å…¥ç¨‹å¼</a></li>
<li><a href="#cookie-cookies-values">ç°½åæˆ–åŠ å¯† cookie ä¸­çš„åˆ°æœŸç¾åœ¨åµŒå…¥åœ¨ cookies values ä¸­</a></li>
</ul>
</li>
<li>
<a href="#rails-5-0-rails-5-1">å¾ Rails 5.0 å‡ç´šåˆ° Rails 5.1</a>

<ul>
<li><a href="#hashwithindifferentaccess">é ‚ç´š <code>HashWithIndifferentAccess</code> å·²è»Ÿæ£„ç”¨</a></li>
<li><a href="#application-secrets-keys-symbols"><code>application.secrets</code> ç¾åœ¨è¼‰å…¥äº†æ‰€æœ‰ keys ä½œç‚º symbols</a></li>
<li><a href="#render-text-nothing">åœ¨ <code>render</code> ä¸­åˆªé™¤äº†å° <code>:text</code> å’Œ <code>:nothing</code> çš„æ£„ç”¨æ”¯æ´</a></li>
<li><a href="#redirect-to-back">ç§»é™¤äº†å° <code>redirect_to :back</code> çš„æ£„ç”¨æ”¯æ´</a></li>
</ul>
</li>
<li>
<a href="#rails-4-2-rails-5-0">å¾ Rails 4.2 å‡ç´šåˆ° Rails 5.0</a>

<ul>
<li><a href="#ruby-2-2-2">Ruby 2.2.2+ éœ€è¦</a></li>
<li><a href="#active-record-models-applicationrecord">Active Record Models ç¾åœ¨é è¨­ç¹¼æ‰¿è‡ª ApplicationRecord</a></li>
<li><a href="#throw-abort-callback">é€šé <code>throw(:abort)</code> åœæ­¢ Callback éˆ</a></li>
<li><a href="#activejob-applicationjob">ActiveJob ç¾åœ¨é è¨­ç¹¼æ‰¿è‡ª ApplicationJob</a></li>
<li><a href="#rails-controller">Rails Controller æ¸¬è©¦</a></li>
<li><a href="#">ç”Ÿç”¢ç’°å¢ƒå•Ÿå‹•å¾Œè‡ªå‹•è¼‰å…¥é—œé–‰</a></li>
<li><a href="#xml">XML åºåˆ—åŒ–</a></li>
<li><a href="#mysql">åˆªé™¤äº†å°èˆŠç‰ˆ <code>mysql</code> è³‡æ–™åº«ä»‹é¢å¡çš„æ”¯æ´</a></li>
<li><a href="#">åˆªé™¤äº†å°åµéŒ¯ç¨‹å¼çš„æ”¯æ´</a></li>
<li><a href="#bin-rails">ä½¿ç”¨ <code>bin/rails</code> ä¾†åŸ·è¡Œä»»å‹™å’Œæ¸¬è©¦</a></li>
<li><a href="#actioncontroller-parameters-hashwithindifferentaccess"><code>ActionController::Parameters</code> ä¸å†ç¹¼æ‰¿ <code>HashWithIndifferentAccess</code></a></li>
<li><a href="#protect-from-forgery-prepend-false"><code>protect_from_forgery</code> ç¾åœ¨é è¨­ç‚º <code>prepend: false</code></a></li>
<li><a href="#raw">é è¨­æ¨¡æ¿è™•ç†ç¨‹å¼ç¾åœ¨æ˜¯ RAW</a></li>
<li><a href="#">æ·»åŠ äº†æ¨¡æ¿ä¾è³´çš„è¬ç”¨å­—å…ƒåŒ¹é…</a></li>
<li><a href="#actionview-helpers-recordtaghelper-gem-record-tag-helper"><code>ActionView::Helpers::RecordTagHelper</code> ç§»å‹•åˆ°å¤–éƒ¨ gem (record_tag_helper)</a></li>
<li><a href="#protected-attributes-gem">ç§»é™¤äº†å° <code>protected_attributes</code> Gem çš„æ”¯æ´</a></li>
<li><a href="#activerecord-deprecated-finders-gem">åˆªé™¤äº†å° <code>activerecord-deprecated_finders</code> gem çš„æ”¯æ´</a></li>
<li><a href="#activesupport-testcase"><code>ActiveSupport::TestCase</code> é è¨­æ¸¬è©¦è¨‚å–®ç¾åœ¨æ˜¯éš¨æ©Ÿçš„</a></li>
<li><a href="#actioncontroller-live-concern"><code>ActionController::Live</code> è®Šæˆäº† <code>Concern</code></a></li>
<li><a href="#">æ–°æ¡†æ¶é è¨­å€¼</a></li>
<li><a href="#json-jsonb">JSON/JSONB åºåˆ—åŒ–çš„è®ŠåŒ–</a></li>
</ul>
</li>
<li>
<a href="#rails-4-1-rails-4-2">å¾ Rails 4.1 å‡ç´šåˆ° Rails 4.2</a>

<ul>
<li><a href="#">ç¶²è·¯æ§åˆ¶æª¯</a></li>
<li><a href="#">å›æ‡‰è€…</a></li>
<li><a href="#transaction-callbacks">transaction ä¸­çš„éŒ¯èª¤è™•ç† callbacks</a></li>
<li><a href="#">æ¸¬è©¦ç”¨ä¾‹æ’åº</a></li>
<li><a href="#">åºåˆ—åŒ–å±¬æ€§</a></li>
<li><a href="#">ç”Ÿç”¢æ—¥èªŒç´šåˆ¥</a></li>
<li><a href="#after-bundle-rails"><code>after_bundle</code> åœ¨ Rails æ¨¡æ¿ä¸­</a></li>
<li><a href="#rails-html">Rails HTML æ¶ˆæ¯’åŠ‘</a></li>
<li><a href="#rails-dom">Rails DOM æ¸¬è©¦</a></li>
<li><a href="#tokens">å½è£çœŸå¯¦æ€§ Tokens</a></li>
<li><a href="#action-mailer">Action Mailer</a></li>
<li><a href="#key">åœ‹å¤– Key æ”¯æ´</a></li>
</ul>
</li>
<li>
<a href="#rails-4-0-rails-4-1">å¾ Rails 4.0 å‡ç´šåˆ° Rails 4.1</a>

<ul>
<li><a href="#script-csrf">é ç«¯ <code>&lt;script&gt;</code> æ¨™ç±¤çš„ CSRF ä¿è­·</a></li>
<li><a href="#rails-4-0-rails-4-1">å½ˆç°§</a></li>
<li><a href="#config-secrets-yml"><code>config/secrets.yml</code></a></li>
<li><a href="#helper">æ›´æ”¹ä»¥æ¸¬è©¦ helper</a></li>
<li><a href="#cookies">Cookies åºåˆ—åŒ–å™¨</a></li>
<li><a href="#flash">Flash çµæ§‹è®ŠåŒ–</a></li>
<li><a href="#json">JSON è™•ç†çš„è®ŠåŒ–</a></li>
<li><a href="#callback-return">åœ¨å…§è¯ callback å¡Šä¸­ä½¿ç”¨ <code>return</code></a></li>
<li><a href="#active-record">å®šç¾©åœ¨ Active Record å¤¾å…·ä¸­çš„æ–¹æ³•</a></li>
<li><a href="#i18n">I18n å¼·åˆ¶åŸ·è¡Œå¯ç”¨çš„èªè¨€ç’°å¢ƒ</a></li>
<li><a href="#relation-mutator">å° Relation å‘¼å«çš„ Mutator æ–¹æ³•</a></li>
<li><a href="#">é è¨­ç¯„åœçš„è®ŠåŒ–</a></li>
<li><a href="#">å¾å­—ä¸²æ¸²æŸ“å…§å®¹</a></li>
<li><a href="#postgresql-json-hstore">PostgreSQL json å’Œ hstore è³‡æ–™å‹åˆ¥</a></li>
<li><a href="#activesupport-callbacks"><code>ActiveSupport::Callbacks</code> çš„é¡¯å¼å¡Šä½¿ç”¨</a></li>
</ul>
</li>
<li>
<a href="#rails-3-2-rails-4-0">å¾ Rails 3.2 å‡ç´šåˆ° Rails 4.0</a>

<ul>
<li><a href="#http">HTTP è£œä¸</a></li>
<li><a href="#rails-3-2-rails-4-0-gemfile">Gemfile</a></li>
<li><a href="#rails-3-2-rails-4-0-">ä¾›æ‡‰å•†/å¤–æ›</a></li>
<li><a href="#rails-3-2-rails-4-0-active-record">Active Record</a></li>
<li><a href="#">æ´»å‹•è³‡æº</a></li>
<li><a href="#active-model">Active Model</a></li>
<li><a href="#action-pack">Action Pack</a></li>
<li><a href="#active-support">Active Support</a></li>
<li><a href="#helpers">Helpers è¼‰å…¥é †åº</a></li>
<li><a href="#active-record-observer-action-controller-sweeper">Active Record Observer å’Œ Action Controller Sweeper</a></li>
<li><a href="#rails">éˆè¼ª-rails</a></li>
<li><a href="#sass-rails">sass-rails</a></li>
</ul>
</li>
<li>
<a href="#rails-3-1-rails-3-2">å¾ Rails 3.1 å‡ç´šåˆ° Rails 3.2</a>

<ul>
<li><a href="#rails-3-1-rails-3-2-gemfile">Gemfile</a></li>
<li><a href="#rails-3-1-rails-3-2-development-rb">è¨­å®š/ç’°å¢ƒ/development.rb</a></li>
<li><a href="#rails-3-1-rails-3-2-test-rb">è¨­å®š/ç’°å¢ƒ/test.rb</a></li>
<li><a href="#rails-3-1-rails-3-2">ä¾›æ‡‰å•†/å¤–æ›</a></li>
<li><a href="#rails-3-1-rails-3-2-active-record">Active Record</a></li>
</ul>
</li>
<li>
<a href="#rails-3-0-rails-3-1">å¾ Rails 3.0 å‡ç´šåˆ° Rails 3.1</a>

<ul>
<li><a href="#gemfile">Gemfile</a></li>
<li><a href="#config-application-rb">config/application.rb</a></li>
<li><a href="#rails-3-0-rails-3-1-development-rb">è¨­å®š/ç’°å¢ƒ/development.rb</a></li>
<li><a href="#config-environments-production-rb">config/environments/production.rb</a></li>
<li><a href="#rails-3-0-rails-3-1-test-rb">è¨­å®š/ç’°å¢ƒ/test.rb</a></li>
<li><a href="#config-initializers-wrap-parameters-rb">config/initializers/wrap_parameters.rb</a></li>
<li><a href="#session-store-rb">è¨­å®š/åˆå§‹åŒ–ç¨‹å¼/session_store.rb</a></li>
<li><a href="#views-helpers-cache-concat">ç§»é™¤ views ä¸­è³‡ç”¢ helpers å¼•ç”¨ä¸­çš„ :cache å’Œ :concat é¸é …</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id=""><a class="anchorlink" href="#">1 ä¸€èˆ¬å»ºè­°</a></h3><p>åœ¨å˜—è©¦å‡ç´šç¾æœ‰æ‡‰ç”¨ç¨‹å¼ä¹‹å‰ï¼Œæ‚¨æ‡‰è©²ç¢ºä¿æœ‰å……åˆ†çš„å‡ç´šç†ç”±ã€‚æ‚¨éœ€è¦å¹³è¡¡å¤šå€‹å› ç´ ï¼šå°æ–°åŠŸèƒ½çš„éœ€æ±‚ã€ç‚ºèˆŠç¨‹å¼ç¢¼å°‹æ‰¾æ”¯æ´çš„é›£åº¦è¶Šä¾†è¶Šå¤§ï¼Œä»¥åŠæ‚¨çš„å¯ç”¨æ™‚é–“å’ŒæŠ€èƒ½ï¼Œåƒ…èˆ‰å¹¾ä¾‹ã€‚</p><h4 id=""><a class="anchorlink" href="#">1.1 æ¸¬è©¦è¦†è“‹ç‡</a></h4><p>ç¢ºä¿æ‚¨çš„æ‡‰ç”¨ç¨‹å¼åœ¨å‡ç´šå¾Œä»èƒ½æ­£å¸¸å·¥ä½œçš„æœ€ä½³æ–¹æ³•æ˜¯åœ¨é–‹å§‹è©²éç¨‹ä¹‹å‰å…·æœ‰è‰¯å¥½çš„æ¸¬è©¦è¦†è“‹ç‡ã€‚å¦‚æœæ‚¨æ²’æœ‰è‡ªå‹•æ¸¬è©¦ä¾†æ¸¬è©¦æ‚¨çš„å¤§éƒ¨åˆ†æ‡‰ç”¨ç¨‹å¼ï¼Œæ‚¨å°‡éœ€è¦èŠ±æ™‚é–“æ‰‹å‹•æ¸¬è©¦æ‰€æœ‰å·²æ›´æ”¹çš„éƒ¨åˆ†ã€‚åœ¨ Rails å‡ç´šçš„æƒ…æ³ä¸‹ï¼Œé€™æ„å‘³è‘—æ‡‰ç”¨ç¨‹å¼ä¸­çš„æ¯ä¸€å€‹åŠŸèƒ½ã€‚å¹«è‡ªå·±ä¸€å€‹å¿™ï¼Œç¢ºä¿æ‚¨çš„æ¸¬è©¦è¦†è“‹ç‡è‰¯å¥½<em>åœ¨é–‹å§‹å‡ç´šä¹‹å‰</em>ã€‚</p><h4 id="ruby"><a class="anchorlink" href="#ruby">1.2 Ruby ç‰ˆæœ¬</a></h4><p>Rails åœ¨é‡‹å‡ºæ™‚é€šå¸¸èˆ‡æœ€æ–°ç™¼å¸ƒçš„ Ruby ç‰ˆæœ¬ä¿æŒæ¥è¿‘ï¼š</p>
<ul>
<li>Rails 7 éœ€è¦ Ruby 2.7.0 æˆ–æ›´æ–°ç‰ˆæœ¬ã€‚</li>
<li>Rails 6 éœ€è¦ Ruby 2.5.0 æˆ–æ›´æ–°ç‰ˆæœ¬ã€‚</li>
<li>Rails 5 éœ€è¦ Ruby 2.2.2 æˆ–æ›´æ–°ç‰ˆæœ¬ã€‚</li>
</ul>
<p>æœ€å¥½åˆ†åˆ¥å‡ç´š Ruby å’Œ Railsã€‚å¯ä»¥å…ˆå‡ç´šåˆ°æœ€æ–°çš„Rubyï¼Œç„¶å¾Œå†å‡ç´šRailsã€‚</p><h4 id=""><a class="anchorlink" href="#">1.3 å‡ç´šéç¨‹</a></h4><p>æ›´æ”¹ Rails ç‰ˆæœ¬æ™‚ï¼Œæœ€å¥½ç·©æ…¢ç§»å‹•ï¼Œä¸€æ¬¡ä¸€å€‹æ¬¡è¦ç‰ˆæœ¬ï¼Œä»¥å……åˆ†åˆ©ç”¨æ£„ç”¨è­¦å‘Šã€‚ Rails ç‰ˆæœ¬è™Ÿçš„æ ¼å¼ç‚º Major.Minor.Patchã€‚å…è¨±ä¸»ç‰ˆæœ¬å’Œæ¬¡ç‰ˆæœ¬å°å…¬å…± API é€²è¡Œæ›´æ”¹ï¼Œå› æ­¤é€™å¯èƒ½æœƒå°è‡´æ‚¨çš„æ‡‰ç”¨ç¨‹å¼å‡ºéŒ¯ã€‚è£œä¸ç‰ˆæœ¬åƒ…åŒ…å«éŒ¯èª¤ä¿®å¾©ï¼Œä¸æ›´æ”¹ä»»ä½•å…¬å…± APIã€‚</p><p>è©²éç¨‹æ‡‰å¦‚ä¸‹é€²è¡Œï¼š</p>
<ol>
<li>ç·¨å¯«æ¸¬è©¦ä¸¦ç¢ºä¿å®ƒå€‘é€šéã€‚</li>
<li>ç§»è‡³ç•¶å‰ç‰ˆæœ¬ä¹‹å¾Œçš„æœ€æ–°è£œä¸ç‰ˆæœ¬ã€‚</li>
<li>ä¿®å¾©æ¸¬è©¦å’Œä¸æ¨è–¦ä½¿ç”¨çš„åŠŸèƒ½ã€‚
4.ç§»å‹•åˆ°ä¸‹ä¸€å€‹æ¬¡è¦ç‰ˆæœ¬çš„æœ€æ–°è£œä¸ç‰ˆæœ¬ã€‚</li>
</ol>
<p>é‡è¤‡æ­¤éç¨‹ï¼Œç›´åˆ°é”åˆ°ç›®æ¨™ Rails ç‰ˆæœ¬ã€‚</p><h5 id=""><a class="anchorlink" href="#">1.3.1 åœ¨ç‰ˆæœ¬ä¹‹é–“ç§»å‹•</a></h5><p>è¦åœ¨ç‰ˆæœ¬ä¹‹é–“ç§»å‹•ï¼š</p><p>1.æ›´æ”¹<code>Gemfile</code>ä¸­çš„Railsç‰ˆæœ¬è™Ÿï¼ŒåŸ·è¡Œ<code>bundle update</code>ã€‚
2. æ›´æ”¹ <code>package.json</code> ä¸­ Rails JavaScript åŒ…çš„ç‰ˆæœ¬ä¸¦åŸ·è¡Œ <code>yarn install</code>ï¼ˆå¦‚æœåœ¨ Webpacker ä¸ŠåŸ·è¡Œï¼‰ã€‚
3. åŸ·è¡Œ<a href="#the-update-task">æ›´æ–°ä»»å‹™</a>ã€‚
4. åŸ·è¡Œæ‚¨çš„æ¸¬è©¦ã€‚</p><p>æ‚¨å¯ä»¥åœ¨ <a href="https://rubygems.org/gems/rails/versions">æ­¤è™•</a> ä¸­æ‰¾åˆ°æ‰€æœ‰å·²é‡‹å‡ºçš„ Rails å¯¶çŸ³çš„åˆ—è¡¨ã€‚</p><h4 id=""><a class="anchorlink" href="#">1.4 æ›´æ–°ä»»å‹™</a></h4><p>Rails æä¾›äº† <code>rails app:update</code> å‘½ä»¤ã€‚æ›´æ–°Railsç‰ˆæœ¬å¾Œ
åœ¨ <code>Gemfile</code> ä¸­ï¼ŒåŸ·è¡Œæ­¤å‘½ä»¤ã€‚
é€™å°‡å¹«åŠ©æ‚¨å»ºç«‹æ–°æª”æ¡ˆå’Œæ›´æ”¹èˆŠæª”æ¡ˆ
äº’å‹•å¼sessionã€‚</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>app:update
<span class="go">       exist  config
    conflict  config/application.rb
Overwrite /myapp/config/application.rb? (enter "h" for help) [Ynaqdh]
       force  config/application.rb
      create  config/initializers/new_framework_defaults_7_0.rb
</span><span class="c">...
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails app:update
">Copy</button>
</div>
<p>åˆ¥å¿˜äº† review çš„å·®ç•°ï¼Œçœ‹çœ‹æœ‰æ²’æœ‰ä»€éº¼æ„æƒ³ä¸åˆ°çš„è®ŠåŒ–ã€‚</p><h4 id=""><a class="anchorlink" href="#">1.5 è¨­å®šæ¡†æ¶é è¨­å€¼</a></h4><p>æ–°çš„ Rails ç‰ˆæœ¬å¯èƒ½å…·æœ‰èˆ‡ä»¥å‰ç‰ˆæœ¬ä¸åŒçš„è¨­å®šé è¨­å€¼ã€‚ä½†æ˜¯ï¼Œåœ¨åŸ·è¡Œä¸Šè¿°æ­¥é©Ÿå¾Œï¼Œæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä»å°‡ä½¿ç”¨<em>ä¸Šä¸€å€‹</em> Rails ç‰ˆæœ¬çš„è¨­å®šé è¨­å€¼åŸ·è¡Œã€‚é€™æ˜¯å› ç‚º <code>config/application.rb</code> ä¸­ <code>config.load_defaults</code> çš„ value å°šæœªæ›´æ”¹ã€‚</p><p>ç‚ºäº†è®“æ‚¨ä¸€ä¸€å‡ç´šåˆ°æ–°çš„é è¨­å€¼ï¼Œæ›´æ–°ä»»å‹™å»ºç«‹äº†ä¸€å€‹æª”æ¡ˆ <code>config/initializers/new_framework_defaults_X.Y.rb</code>ï¼ˆæª”åä¸­åŒ…å«æ‰€éœ€çš„ Rails ç‰ˆæœ¬ï¼‰ã€‚æ‚¨æ‡‰è©²é€šéåœ¨æª”æ¡ˆä¸­å–æ¶ˆè¨»é‡‹ä¾†å•Ÿç”¨æ–°çš„è¨­å®šé è¨­å€¼ï¼›é€™å¯ä»¥é€šéå¤šæ¬¡éƒ¨ç½²é€æ­¥å®Œæˆã€‚ä¸€æ—¦æ‚¨çš„æ‡‰ç”¨ç¨‹å¼æº–å‚™å¥½ä»¥æ–°çš„é è¨­å€¼åŸ·è¡Œï¼Œæ‚¨å¯ä»¥åˆªé™¤æ­¤æª”æ¡ˆä¸¦ç¿»è½‰ <code>config.load_defaults</code> valueã€‚</p><h3 id="rails-6-1-rails-7-0"><a class="anchorlink" href="#rails-6-1-rails-7-0">2 å¾ Rails 6.1 å‡ç´šåˆ° Rails 7.0</a></h3><h4 id="rails-6-1-rails-7-0-"><a class="anchorlink" href="#rails-6-1-rails-7-0-">2.1 å½ˆç°§</a></h4><p>å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ Springï¼Œå‰‡è‡³å°‘éœ€è¦å‡ç´šåˆ° 3.0.0 ç‰ˆæœ¬ã€‚å¦å‰‡ä½ æœƒå¾—åˆ°</p><div class="code_container">
<pre><code class="highlight plaintext">undefined method `mechanism=' for ActiveSupport::Dependencies:Module
</code></pre>
<button class="clipboard-button" data-clipboard-text="undefined method `mechanism=' for ActiveSupport::Dependencies:Module
">Copy</button>
</div>
<p>å¦å¤–ï¼Œè«‹ç¢ºä¿åœ¨ <code>config/environments/test.rb</code> ä¸­å°‡ <code>config.cache_classes</code> è¨­å®šç‚º <code>false</code>ã€‚</p><h4 id="zeitwerk"><a class="anchorlink" href="#zeitwerk">2.2 æ‡‰ç”¨ç¨‹å¼éœ€è¦åœ¨ <code>zeitwerk</code> æ¨¡å¼ä¸‹åŸ·è¡Œ</a></h4><p>ä»åœ¨ <code>classic</code> æ¨¡å¼ä¸‹åŸ·è¡Œçš„æ‡‰ç”¨ç¨‹å¼å¿…é ˆåˆ‡æ›åˆ° <code>zeitwerk</code> æ¨¡å¼ã€‚è©³æƒ…è«‹æª¢è¦–<a href="https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#autoloading">Rails 6.0å‡ç´šæŒ‡å—</a>ã€‚</p><h4 id="setter-config-autoloader"><a class="anchorlink" href="#setter-config-autoloader">2.3 setter <code>config.autoloader=</code> å·²åˆªé™¤</a></h4><p>Rails 7ä¸­æ²’æœ‰è¨­å®šè‡ªå‹•è¼‰å…¥æ¨¡å¼çš„è¨­å®šé»ï¼Œåˆªé™¤äº†<code>config.autoloader=</code>ã€‚å¦‚æœæ‚¨å‡ºæ–¼æŸç¨®åŸå› å°‡å…¶è¨­å®šç‚º <code>:zeitwerk</code>ï¼Œåªéœ€å°‡å…¶åˆªé™¤å³å¯ã€‚</p><h4 id="activesupport-dependencies-api"><a class="anchorlink" href="#activesupport-dependencies-api">2.4 <code>ActiveSupport::Dependencies</code>ç§æœ‰APIå·²åˆªé™¤</a></h4><p><code>ActiveSupport::Dependencies</code> çš„ç§æœ‰ API å·²è¢«åˆªé™¤ã€‚é€™åŒ…æ‹¬åƒ <code>hook!</code>ã€<code>unhook!</code>ã€<code>depend_on</code>ã€<code>require_or_load</code>ã€<code>mechanism</code> ç­‰æ–¹æ³•ã€‚</p><p>å¹¾å€‹äº®é»ï¼š</p>
<ul>
<li>å¦‚æœæ‚¨ä½¿ç”¨ <code>ActiveSupport::Dependencies.constantize</code> æˆ– `<code>ActiveSupport::Dependencies.safe_constantize</code>, just change them to <code>String#constantize</code> or <code>String#safe_constantize</code>ã€‚</li>
</ul>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="p">.</span><span class="nf">constantize</span><span class="p">(</span><span class="s2">"User"</span><span class="p">)</span> <span class="c1"># NO LONGER POSSIBLE</span>
  <span class="s2">"User"</span><span class="p">.</span><span class="nf">constantize</span> <span class="c1"># ğŸ‘</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='  ActiveSupport::Dependencies.constantize("User") # NO LONGER POSSIBLE
  "User".constantize # ğŸ‘
'>Copy</button>
</div>

<ul>
<li><p>ä»»ä½•å° <code>ActiveSupport::Dependencies.mechanism</code>ã€reader æˆ– writer çš„ä½¿ç”¨éƒ½å¿…é ˆè¢«ç›¸æ‡‰åœ°è¨ªå• <code>config.cache_classes</code> æ›¿æ›ã€‚</p></li>
<li><p>å¦‚æœè¦è·Ÿè¹¤è‡ªå‹•è¼‰å…¥å™¨çš„æ´»å‹•ï¼Œ<code>ActiveSupport::Dependencies.verbose=</code> ä¸å†å¯ç”¨ï¼Œåªéœ€å°‡ <code>Rails.autoloaders.log!</code> æ‰”åˆ° <code>config/application.rb</code> ä¸­å³å¯ã€‚</p></li>
</ul>
<p>è¼”åŠ©å…§éƒ¨é¡æˆ– modules ä¹Ÿæ²’æœ‰äº†ï¼Œä¾‹å¦‚ <code>ActiveSupport::Dependencies::Reference</code>ã€<code>ActiveSupport::Dependencies::Blamable</code> ç­‰ã€‚</p><h4 id=""><a class="anchorlink" href="#">2.5 åˆå§‹åŒ–æœŸé–“è‡ªå‹•è¼‰å…¥</a></h4><p>åœ¨ <code>to_prepare</code> å¡Šä¹‹å¤–çš„åˆå§‹åŒ–æœŸé–“è‡ªå‹•è¼‰å…¥å¯éè¼‰å¸¸é‡çš„æ‡‰ç”¨ç¨‹å¼è§£é™¤å®‰è£äº†é€™äº›å¸¸é‡ï¼Œä¸¦ä¸”è‡ª Rails 6.0 ä»¥ä¾†ç™¼å‡ºäº†æ­¤è­¦å‘Šï¼š</p><div class="code_container">
<pre><code class="highlight plaintext">DEPRECATION WARNING: Initialization autoloaded the constant ....

Being able to do this is deprecated. Autoloading during initialization is going
to be an error condition in future versions of Rails.

...
</code></pre>
<button class="clipboard-button" data-clipboard-text="DEPRECATION WARNING: Initialization autoloaded the constant ....

Being able to do this is deprecated. Autoloading during initialization is going
to be an error condition in future versions of Rails.

...
">Copy</button>
</div>
<p>å¦‚æœæ‚¨ä»ç„¶åœ¨æ—¥èªŒä¸­æ”¶åˆ°æ­¤è­¦å‘Šï¼Œè«‹æª¢è¦– <a href="https://guides.rubyonrails.org/v7.0/autoloading_and_reloading_constants.html#autoloading-when-the-application-boots">è‡ªå‹•è¼‰å…¥æŒ‡å—</a> ä¸­æœ‰é—œæ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚è‡ªå‹•è¼‰å…¥çš„éƒ¨åˆ†ã€‚å¦å‰‡ï¼Œæ‚¨å°‡åœ¨ Rails 7 ä¸­ç²å¾— <code>NameError</code>ã€‚</p><h4 id="config-autoload-once-paths"><a class="anchorlink" href="#config-autoload-once-paths">2.6 èƒ½å¤ è¨­å®š <code>config.autoload_once_paths</code></a></h4><p><code>config.autoload_once_paths</code> å¯ä»¥åœ¨ <code>config/application.rb</code> ä¸­å®šç¾©çš„æ‡‰ç”¨ç¨‹å¼é¡çš„ä¸»é«”ä¸­è¨­å®šï¼Œä¹Ÿå¯ä»¥åœ¨ <code>config/environments/*</code> ä¸­çš„ç’°å¢ƒè¨­å®šä¸­è¨­å®šã€‚</p><p>é¡ä¼¼åœ°ï¼Œå¼•æ“å¯ä»¥åœ¨å¼•æ“é¡çš„é¡ä¸»é«”æˆ–ç’°å¢ƒè¨­å®šä¸­è¨­å®šè©²é›†åˆã€‚</p><p>ä¹‹å¾Œï¼Œé›†åˆè¢«å‡çµï¼Œæ‚¨å¯ä»¥å¾é€™äº›è·¯å¾‘è‡ªå‹•è¼‰å…¥ã€‚ç‰¹åˆ¥æ˜¯ï¼Œæ‚¨å¯ä»¥åœ¨åˆå§‹åŒ–æœŸé–“å¾é‚£è£¡è‡ªå‹•è¼‰å…¥ã€‚å®ƒå€‘ç”± <code>Rails.autoloaders.once</code> è‡ªå‹•è¼‰å…¥å™¨ç®¡ç†ï¼Œå®ƒä¸æœƒé‡æ–°è¼‰å…¥ï¼Œåªæœƒè‡ªå‹•è¼‰å…¥/æ€¥åˆ‡è¼‰å…¥ã€‚</p><p>å¦‚æœæ‚¨åœ¨è™•ç†ç’°å¢ƒè¨­å®šå¾Œè¨­å®šäº†æ­¤è¨­å®šä¸¦ä¸”æ­£åœ¨ç²å– <code>FrozenError</code>ï¼Œè«‹ç§»å‹•ç¨‹å¼ç¢¼ã€‚</p><h4 id="actiondispatch-request-content-type-content-type"><a class="anchorlink" href="#actiondispatch-request-content-type-content-type">2.7 <code>ActionDispatch::Request#content_type</code> ç¾åœ¨åŸæ¨£è¿”å› Content-Type æ¨™é ­ã€‚</a></h4><p>ä»¥å‰ï¼Œ <code>ActionDispatch::Request#content_type</code> è¿”å›çš„ value ä¸åŒ…å«å­—ç¬¦é›†éƒ¨åˆ†ã€‚
æ­¤è¡Œç‚ºæ›´æ”¹ç‚ºè¿”å›çš„åŒ…å«å­—ç¬¦é›†éƒ¨åˆ†çš„ Content-Type æ¨™é ­ã€‚</p><p>å¦‚æœæ‚¨åªéœ€è¦ MIME å‹åˆ¥ï¼Œè«‹æ”¹ç”¨ <code>ActionDispatch::Request#media_type</code>ã€‚</p><p>å‰ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">request</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"CONTENT_TYPE"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">,</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='request = ActionDispatch::Request.new("CONTENT_TYPE" =&gt; "text/csv; header=present; charset=utf-16", "REQUEST_METHOD" =&gt; "GET")
request.content_type #=&gt; "text/csv"
'>Copy</button>
</div>
<p>å¾Œï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">request</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">,</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present; charset=utf-16"</span>
<span class="n">request</span><span class="p">.</span><span class="nf">media_type</span>   <span class="c1">#=&gt; "text/csv"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='request = ActionDispatch::Request.new("Content-Type" =&gt; "text/csv; header=present; charset=utf-16", "REQUEST_METHOD" =&gt; "GET")
request.content_type #=&gt; "text/csv; header=present; charset=utf-16"
request.media_type   #=&gt; "text/csv"
'>Copy</button>
</div>
<h4 id="key-sha256"><a class="anchorlink" href="#key-sha256">2.8 Key ç”¢ç”Ÿå™¨æ‘˜è¦é¡æ›´æ”¹ç‚ºä½¿ç”¨ SHA256</a></h4><p>key ç”¢ç”Ÿå™¨çš„é è¨­æ‘˜è¦é¡æ­£åœ¨å¾ SHA1 æ›´æ”¹ç‚º SHA256ã€‚
é€™æœƒå° Rails ç”¢ç”Ÿçš„ä»»ä½•åŠ å¯†è¨Šæ¯ç”¢ç”Ÿå½±éŸ¿ï¼ŒåŒ…æ‹¬
åŠ å¯†çš„ cookiesã€‚</p><p>ç‚ºäº†èƒ½å¤ ä½¿ç”¨èˆŠçš„æ‘˜è¦é¡è®€å–è¨Šæ¯ï¼Œæœ‰å¿…è¦
è¨»å†Šä¸€å€‹æ—‹è½‰å™¨ã€‚</p><p>ä»¥ä¸‹æ˜¯åŠ å¯†çš„ cookies çš„æ—‹è½‰å™¨ç¤ºä¾‹ã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">cookies_rotations</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">cookies</span><span class="o">|</span>
  <span class="n">salt</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">authenticated_encrypted_cookie_salt</span>
  <span class="n">secret_key_base</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">.</span><span class="nf">secret_key_base</span>

  <span class="n">key_generator</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">KeyGenerator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
    <span class="n">secret_key_base</span><span class="p">,</span> <span class="ss">iterations: </span><span class="mi">1000</span><span class="p">,</span> <span class="ss">hash_digest_class: </span><span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span>
  <span class="p">)</span>
  <span class="n">key_len</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">MessageEncryptor</span><span class="p">.</span><span class="nf">key_len</span>
  <span class="n">secret</span> <span class="o">=</span> <span class="n">key_generator</span><span class="p">.</span><span class="nf">generate_key</span><span class="p">(</span><span class="n">salt</span><span class="p">,</span> <span class="n">key_len</span><span class="p">)</span>

  <span class="n">cookies</span><span class="p">.</span><span class="nf">rotate</span> <span class="ss">:encrypted</span><span class="p">,</span> <span class="n">secret</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.config.action_dispatch.cookies_rotations.tap do |cookies|
  salt = Rails.application.config.action_dispatch.authenticated_encrypted_cookie_salt
  secret_key_base = Rails.application.secrets.secret_key_base

  key_generator = ActiveSupport::KeyGenerator.new(
    secret_key_base, iterations: 1000, hash_digest_class: OpenSSL::Digest::SHA1
  )
  key_len = ActiveSupport::MessageEncryptor.key_len
  secret = key_generator.generate_key(salt, key_len)

  cookies.rotate :encrypted, secret
end
">Copy</button>
</div>
<h4 id="activesupport-sha256"><a class="anchorlink" href="#activesupport-sha256">2.9 ActiveSupport çš„æ‘˜è¦é¡::æ‘˜è¦æ›´æ”¹ç‚º SHA256</a></h4><p>ActiveSupport::Digest çš„é è¨­æ‘˜è¦é¡å¾ SHA1 æ›´æ”¹ç‚º SHA256ã€‚
é€™æœƒå° Etags ä¹‹é¡çš„æ±è¥¿ç”¢ç”Ÿå½±éŸ¿ï¼Œé€™äº›æ±è¥¿ä¹Ÿæœƒæ”¹è®Šå’Œå¿«å– keysã€‚
æ›´æ”¹é€™äº› keys æœƒå½±éŸ¿å¿«å–å‘½ä¸­ç‡ï¼Œæ‰€ä»¥è¦å°å¿ƒè¬¹æ…
ç‚ºæ­¤ï¼Œåœ¨å‡ç´šåˆ°æ–°é›œæ¹Šæ™‚ã€‚</p><h4 id="activesupport-cache"><a class="anchorlink" href="#activesupport-cache">2.10 æ–°çš„ ActiveSupport::Cache åºåˆ—åŒ–æ ¼å¼</a></h4><p>å¼•å…¥äº†æ›´å¿«ã€æ›´ç·Šæ¹Šçš„åºåˆ—åŒ–æ ¼å¼ã€‚</p><p>è¦å•Ÿç”¨å®ƒï¼Œæ‚¨å¿…é ˆè¨­å®š <code>config.active_support.cache_format_version = 7.0</code>ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># è¨­å®š/æ‡‰ç”¨ç¨‹å¼.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.1</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">cache_format_version</span> <span class="o">=</span> <span class="mf">7.0</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# è¨­å®š/æ‡‰ç”¨ç¨‹å¼.rb

config.load_defaults 6.1
config.active_support.cache_format_version = 7.0
">Copy</button>
</div>
<p>æˆ–è€…ä¹¾è„†ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># è¨­å®š/æ‡‰ç”¨ç¨‹å¼.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">7.0</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# è¨­å®š/æ‡‰ç”¨ç¨‹å¼.rb

config.load_defaults 7.0
">Copy</button>
</div>
<p>ä½†æ˜¯ Rails 6.1 æ‡‰ç”¨ç¨‹å¼ç„¡æ³•è®€å–é€™ç¨®æ–°çš„åºåˆ—åŒ–æ ¼å¼ï¼Œ
æ‰€ä»¥ç‚ºäº†ç¢ºä¿ç„¡ç¸«å‡ç´šï¼Œæ‚¨å¿…é ˆé¦–å…ˆéƒ¨ç½² Rails 7.0 å‡ç´š
<code>config.active_support.cache_format_version = 6.1</code>ï¼Œç„¶å¾Œåªæœ‰ä¸€æ¬¡å…¨éƒ¨ Rails
æµç¨‹å·²æ›´æ–°æ‚¨å¯ä»¥è¨­å®š<code>config.active_support.cache_format_version = 7.0</code>ã€‚</p><p>Rails 7.0 èƒ½å¤ è®€å–é€™å…©ç¨®æ ¼å¼ï¼Œå› æ­¤å¿«å–ä¸æœƒåœ¨
å‡ç´šã€‚</p><h4 id="activestorage-preview"><a class="anchorlink" href="#activestorage-preview">2.11 ActiveStorage è¦–è¨Š preview å½±è±¡ç”¢ç”Ÿ</a></h4><p>è¦–è¨Š preview å½±è±¡ç”¢ç”Ÿç¾åœ¨ä½¿ç”¨ FFmpeg çš„å ´æ™¯è®ŠåŒ–æª¢æ¸¬ä¾†ç”¢ç”Ÿ
æ›´æœ‰æ„ç¾©çš„ preview å½±è±¡ã€‚ä»¥å‰å°‡ä½¿ç”¨è¦–è¨Šçš„ç¬¬ä¸€å¹€
å¦‚æœè¦–è¨Šå¾é»‘è‰²æ·¡å…¥ï¼Œå°±æœƒå°è‡´å•é¡Œã€‚é€™ç¨®è®ŠåŒ–éœ€è¦
FFmpeg v3.4+ã€‚</p><h4 id="activestorage-vips"><a class="anchorlink" href="#activestorage-vips">2.12 ActiveStorage è®Šé«”è™•ç†å™¨æ›´æ”¹ç‚º :vips</a></h4><p>å½±è±¡è½‰æ›ç¾åœ¨å°‡ä½¿ç”¨ libvips è€Œä¸æ˜¯ ImageMagickã€‚é€™å°‡æ¸›å°‘
ç”¢ç”Ÿè®Šé«”æ‰€éœ€çš„æ™‚é–“ä»¥åŠ CPU å’Œè¨˜æ†¶é«”ä½¿ç”¨ç‡ï¼Œå¾è€Œæ”¹å–„å›æ‡‰
ä¾è³´ active storage ä¾†æä¾›å½±è±¡çš„æ‡‰ç”¨ç¨‹å¼ä¸­çš„æ¬¡æ•¸ã€‚</p><p><code>:mini_magick</code> é¸é …æ²’æœ‰è¢«æ£„ç”¨ï¼Œæ‰€ä»¥å¯ä»¥ç¹¼çºŒä½¿ç”¨å®ƒã€‚</p><p>é·ç§»åˆ° libvips éœ€è¦å°‡ç¾æœ‰çš„å½±è±¡è½‰æ›ç¨‹å¼ç¢¼æ›´æ”¹ç‚º
<code>image_processing</code> å·¨é›†ï¼Œä¸¦ç”¨ libvips çš„é¸é …æ›¿æ› ImageMagick çš„é¸é …ã€‚</p><h5 id="resize-to-limit-resize"><a class="anchorlink" href="#resize-to-limit-resize">2.12.1 ç”¨ resize_to_limit æ›¿æ› resize</a></h5><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(resize: "100x")
</span><span class="gi">+ variant(resize_to_limit: [100, nil])
</span></code></pre>
<button class="clipboard-button" data-clipboard-text='- variant(resize: "100x")
+ variant(resize_to_limit: [100, nil])
'>Copy</button>
</div>
<p>å¦‚æœä½ å¿˜è¨˜é€™æ¨£åšï¼Œç•¶ä½ åˆ‡æ›åˆ°vipsæ™‚ä½ æœƒçœ‹åˆ°é€™å€‹éŒ¯èª¤ï¼š<code>no implicit conversion to float from string</code>ã€‚</p><h5 id=""><a class="anchorlink" href="#">2.12.2 è£å‰ªæ™‚ä½¿ç”¨é™£åˆ—</a></h5><div class="code_container">
<pre><code class="highlight diff"><span class="gd">- variant(crop: "1920x1080+0+0")
</span><span class="gi">+ variant(crop: [0, 0, 1920, 1080])
</span></code></pre>
<button class="clipboard-button" data-clipboard-text='- variant(crop: "1920x1080+0+0")
+ variant(crop: [0, 0, 1920, 1080])
'>Copy</button>
</div>
<p>å¦‚æœä½ å¿˜è¨˜é€™æ¨£åšï¼Œç•¶ä½ åˆ‡æ›åˆ°vipsæ™‚ä½ æœƒçœ‹åˆ°é€™å€‹éŒ¯èª¤ï¼š<code>unable to call crop: you supplied 2 arguments, but operation needs 5</code>ã€‚</p><h5 id="values"><a class="anchorlink" href="#values">2.12.3 å¤¾ä½ä½ çš„ä½œç‰© valuesï¼š</a></h5><p>Vips åœ¨è£å‰ªæ–¹é¢æ¯” ImageMagick æ›´åš´æ ¼ï¼š
1. å¦‚æœ <code>x</code> å’Œ/æˆ– <code>y</code> ç‚ºè²  valuesï¼Œå‰‡ä¸æœƒè£å‰ªã€‚ä¾‹å¦‚ï¼š<code>[-10, -10, 100, 100]</code>
2.å¦‚æœä½ç½®ï¼ˆ<code>x</code>æˆ–<code>y</code>ï¼‰åŠ ä¸Šè£å‰ªå°ºå¯¸ï¼ˆ<code>width</code>ï¼Œ<code>height</code>ï¼‰å¤§æ–¼å½±è±¡ï¼Œå‰‡ä¸æœƒè£å‰ªã€‚ä¾‹å¦‚ï¼šä¸€å€‹ 125x125 çš„å½±è±¡å’Œä¸€å€‹ <code>[50, 50, 100, 100]</code> çš„è£å‰ª</p><p>å¦‚æœä½ å¿˜è¨˜é€™æ¨£åšï¼Œç•¶ä½ åˆ‡æ›åˆ°vipsæ™‚ä½ æœƒçœ‹åˆ°é€™å€‹éŒ¯èª¤ï¼š<code>extract_area: bad extract area</code></p><h5 id="resize-pad"><a class="anchorlink" href="#resize-pad">2.12.4 èª¿æ•´resizeå’Œpadä½¿ç”¨çš„èƒŒæ™¯è‰²</a></h5><p>Vips ä½¿ç”¨é»‘è‰²ä½œç‚ºé è¨­èƒŒæ™¯è‰² <code>resize_and_pad</code>ï¼Œè€Œä¸æ˜¯åƒ ImageMagick é‚£æ¨£çš„ç™½è‰²ã€‚ä½¿ç”¨ <code>background</code> é¸é …ä¿®å¾©è©²å•é¡Œï¼š
<code>diff
- variant(resize_and_pad: [300, 300])
+ variant(resize_and_pad: [300, 300, background: [255]])
</code></p><h5 id="exif"><a class="anchorlink" href="#exif">2.12.5 åˆªé™¤ä»»ä½•æ ¹æ“š EXIF çš„æ—‹è½‰</a></h5><p>Vips å°‡åœ¨è™•ç†è®Šé«”æ™‚ä½¿ç”¨ EXIF å€¼è‡ªå‹•æ—‹è½‰å½±è±¡ã€‚å¦‚æœæ‚¨å¾ä½¿ç”¨è€…ä¸Šå‚³çš„ç…§ç‰‡ä¸­å„²å­˜æ—‹è½‰ values ä»¥ä½¿ç”¨ ImageMagick æ‡‰ç”¨æ—‹è½‰ï¼Œå‰‡å¿…é ˆåœæ­¢é€™æ¨£åšï¼š
<code>diff
- variant(format: :jpg, rotate: rotation_value)
+ variant(format: :jpg)
</code></p><h5 id=""><a class="anchorlink" href="#">2.12.6 ç”¨è‰²å½©ç©ºé–“æ›¿æ›å–®è‰²</a></h5><p>Vips ä½¿ç”¨ä¸åŒçš„é¸é …ä¾†è£½ä½œå–®è‰²å½±è±¡ï¼š
<code>diff
- variant(monochrome: true)
+ variant(colourspace: "b-w")
</code></p><h5 id="libvips"><a class="anchorlink" href="#libvips">2.12.7 åˆ‡æ›åˆ°ç”¨æ–¼å£“ç¸®å½±è±¡çš„ libvips é¸é …</a></h5><p>JPEGæ ¼å¼
<code>diff
- variant(strip: true, quality: 80, interlace: "JPEG", sampling_factor: "4:2:0", colorspace: "sRGB")
+ variant(saver: { strip: true, quality: 80, interlace: true })
</code></p><p>PNG
<code>diff
- variant(strip: true, quality: 75)
+ variant(saver: { strip: true, compression: 9 })
</code></p><p>ç¶²è·¯
<code>diff
- variant(strip: true, quality: 75, define: { webp: { lossless: false, alpha_quality: 85, thread_level: 1 } })
+ variant(saver: { strip: true, quality: 75, lossless: false, alpha_q: 85, reduction_effort: 6, smart_subsample: true })
</code></p><p>å‹•åœ–
<code>diff
- variant(layers: "Optimize")
+ variant(saver: { optimize_gif_frames: true, optimize_gif_transparency: true })
</code></p><h5 id=""><a class="anchorlink" href="#">2.12.8 éƒ¨ç½²åˆ°ç”Ÿç”¢</a></h5><p>Active Storage å°‡å¿…é ˆåŸ·è¡Œçš„è½‰æ›åˆ—è¡¨ç·¨ç¢¼åˆ°å½±è±¡çš„ url ä¸­ã€‚
å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼æ­£åœ¨å¿«å–é€™äº› urlï¼Œå‰‡åœ¨æ‚¨å°‡æ–°ç¨‹å¼ç¢¼éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒå¾Œï¼Œæ‚¨çš„å½±è±¡å°‡ä¸­æ–·ã€‚
å› æ­¤ï¼Œæ‚¨å¿…é ˆæ‰‹å‹•ä½¿å—å½±éŸ¿çš„å¿«å– keys ç„¡æ•ˆã€‚</p><p>ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åœ¨ view ä¸­æœ‰é€™æ¨£çš„å…§å®¹ï¼š
<code>rhtml
&lt;% @products.each do |product| %&gt;
  &lt;% cache product do %&gt;
    &lt;%= image_tag product.cover_photo.variant(resize: "200x") %&gt;
  &lt;% end %&gt;
&lt;% end %&gt;
</code></p><p>æ‚¨å¯ä»¥é€šéè§¸æ§ç”¢å“æˆ–æ›´æ”¹å¿«å– key ä¾†ä½¿å¿«å–ç„¡æ•ˆï¼š
<code>rhtml
&lt;% @products.each do |product| %&gt;
  &lt;% cache ["v2", product] do %&gt;
    &lt;%= image_tag product.cover_photo.variant(resize_to_limit: [200, nill]) %&gt;
  &lt;% end %&gt;
&lt;% end %&gt;
</code></p><h3 id="rails-6-0-rails-6-1"><a class="anchorlink" href="#rails-6-0-rails-6-1">3 å¾ Rails 6.0 å‡ç´šåˆ° Rails 6.1</a></h3><p>æœ‰é—œå° Rails 6.1 æ‰€åšæ›´æ”¹çš„æ›´å¤šè³‡è¨Šï¼Œè«‹åƒé–± <a href="6_1_release_notes.html">ç™¼è¡Œèªªæ˜</a>ã€‚</p><h4 id="rails-application-config-for-value-keys"><a class="anchorlink" href="#rails-application-config-for-value-keys">3.1 <code>Rails.application.config_for</code> è¿”å› value ä¸å†æ”¯æ´ä½¿ç”¨å­—ä¸² keys é€²è¡Œè¨ªå•ã€‚</a></h4><p>çµ¦å®šä¸€å€‹é€™æ¨£çš„è¨­å®šæª”æ¡ˆï¼š</p><div class="code_container">
<pre><code class="highlight yaml"><span class="c1"># è¨­å®š/example.yml</span>
<span class="na">development</span><span class="pi">:</span>
  <span class="na">options</span><span class="pi">:</span>
    <span class="na">key</span><span class="pi">:</span> <span class="s">value</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# è¨­å®š/example.yml
development:
  options:
    key: value
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config_for</span><span class="p">(</span><span class="ss">:example</span><span class="p">).</span><span class="nf">options</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.config_for(:example).options
">Copy</button>
</div>
<p>é€™ç”¨æ–¼è¿”å›ä¸€å€‹é›œæ¹Šï¼Œæ‚¨å¯ä»¥åœ¨è©²é›œæ¹Šä¸Šä½¿ç”¨å­—ä¸² keys è¨ªå• valuesã€‚é€™åœ¨ 6.0 ä¸­å·²è¢«æ£„ç”¨ï¼Œç¾åœ¨ä¸å†èµ·ä½œç”¨ã€‚</p><p>å¦‚æœæ‚¨ä»ç„¶æƒ³ä½¿ç”¨å­—ä¸² keys è¨ªå• valuesï¼Œæ‚¨å¯ä»¥åœ¨ <code>config_for</code> çš„è¿”å›å€¼ä¸Šå‘¼å« <code>with_indifferent_access</code>ï¼Œä¾‹å¦‚ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config_for</span><span class="p">(</span><span class="ss">:example</span><span class="p">).</span><span class="nf">with_indifferent_access</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s1">'options'</span><span class="p">,</span> <span class="s1">'key'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.config_for(:example).with_indifferent_access.dig('options', 'key')
">Copy</button>
</div>
<h4 id="respond-to-any-content-type"><a class="anchorlink" href="#respond-to-any-content-type">3.2 ä½¿ç”¨ <code>respond_to#any</code> æ™‚å›æ‡‰çš„ Content-Type</a></h4><p>å›æ‡‰ä¸­è¿”å›çš„ Content-Type æ¨™é ­å¯èƒ½èˆ‡ Rails 6.0 è¿”å›çš„ä¸åŒï¼Œ
æ›´å…·é«”åœ°èªªï¼Œå¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ <code>respond_to { |format| format.any }</code>ã€‚
Content-Type ç¾åœ¨å°‡æ ¹æ“šçµ¦å®šçš„å¡Šè€Œä¸æ˜¯è«‹æ±‚çš„æ ¼å¼ã€‚</p><p>ä¾‹å­ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">my_action</span>
  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
    <span class="nb">format</span><span class="p">.</span><span class="nf">any</span> <span class="p">{</span> <span class="n">render</span><span class="p">(</span><span class="ss">json: </span><span class="p">{</span> <span class="ss">foo: </span><span class="s1">'bar'</span> <span class="p">})</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="def my_action
  respond_to do |format|
    format.any { render(json: { foo: 'bar' }) }
  end
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span><span class="p">(</span><span class="s1">'my_action.csv'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="get('my_action.csv')
">Copy</button>
</div>
<p>ä»¥å‰çš„è¡Œç‚ºæ˜¯è¿”å› <code>text/csv</code> å›æ‡‰çš„ Content-Typeï¼Œé€™æ˜¯ä¸æº–ç¢ºçš„ï¼Œå› ç‚ºæ­£åœ¨å‘ˆç¾ JSON å›æ‡‰ã€‚
ç•¶å‰è¡Œç‚ºæ­£ç¢ºè¿”å› <code>application/json</code> å›æ‡‰çš„å…§å®¹å‹åˆ¥ã€‚</p><p>å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä¾è³´æ–¼ä¹‹å‰çš„éŒ¯èª¤è¡Œç‚ºï¼Œæˆ‘å€‘é¼“å‹µæ‚¨æŒ‡å®š
æ‚¨çš„ action æ¥å—å“ªç¨®æ ¼å¼ï¼Œå³</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">format</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="ss">:xml</span><span class="p">,</span> <span class="ss">:json</span><span class="p">)</span> <span class="p">{</span> <span class="n">render</span> <span class="n">request</span><span class="p">.</span><span class="nf">format</span><span class="p">.</span><span class="nf">to_sym</span> <span class="o">=&gt;</span> <span class="vi">@people</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="format.any(:xml, :json) { render request.format.to_sym =&gt; @people }
">Copy</button>
</div>
<h4 id="activesupport-callbacks-halted-callback-hook"><a class="anchorlink" href="#activesupport-callbacks-halted-callback-hook">3.3 <code>ActiveSupport::Callbacks#halted_callback_hook</code> ç¾åœ¨æ¥æ”¶ç¬¬äºŒå€‹å¼•æ•¸</a></h4><p>Active Support å…è¨±æ‚¨åœ¨ callback æ™‚è¦†è“‹ <code>halted_callback_hook</code>
åœæ­¢éˆæ¢ã€‚æ­¤æ–¹æ³•ç¾åœ¨æ¥æ”¶ç¬¬äºŒå€‹å¼•æ•¸ï¼Œå³è¢«æš«åœçš„ callback çš„åç¨±ã€‚
å¦‚æœæ‚¨æœ‰è¦†è“‹æ­¤æ–¹æ³•çš„é¡ï¼Œè«‹ç¢ºä¿å®ƒæ¥å—å…©å€‹å¼•æ•¸ã€‚è«‹æ³¨æ„ï¼Œé€™æ˜¯ä¸€ç®‡ä¸­æ–·
åœ¨æ²’æœ‰é å…ˆæ£„ç”¨é€±æœŸçš„æƒ…æ³ä¸‹æ›´æ”¹ï¼ˆå‡ºæ–¼æ•ˆèƒ½åŸå› ï¼‰ã€‚</p><p>ä¾‹å­ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before_create</span> <span class="p">{</span> <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="p">}</span>

  <span class="k">def</span> <span class="nf">halted_callback_hook</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">callback_name</span><span class="p">)</span> <span class="c1"># =&gt; This method now accepts 2 arguments instead of 1</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Book couldn't be </span><span class="si">#{</span><span class="n">callback_name</span><span class="si">}</span><span class="s2">d"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  before_save { throw(:abort) }
  before_create { throw(:abort) }

  def halted_callback_hook(filter, callback_name) # =&gt; This method now accepts 2 arguments instead of 1
    Rails.logger.info(&quot;Book couldn't be #{callback_name}d&quot;)
  end
end
">Copy</button>
</div>
<h4 id="controllers-helper-string-constantize"><a class="anchorlink" href="#controllers-helper-string-constantize">3.4 controllersä¸­çš„<code>helper</code>é¡æ–¹æ³•ä½¿ç”¨çš„æ˜¯<code>String#constantize</code></a></h4><p>å¾æ¦‚å¿µä¸Šè¬›ï¼Œåœ¨ Rails 6.1 ä¹‹å‰</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">helper</span> <span class="s2">"foo/bar"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='helper "foo/bar"
'>Copy</button>
</div>
<p>å°è‡´</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">require_dependency</span> <span class="s2">"foo/bar_helper"</span>
<span class="n">module_name</span> <span class="o">=</span> <span class="s2">"foo/bar_helper"</span><span class="p">.</span><span class="nf">camelize</span>
<span class="n">module_name</span><span class="p">.</span><span class="nf">constantize</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='require_dependency "foo/bar_helper"
module_name = "foo/bar_helper".camelize
module_name.constantize
'>Copy</button>
</div>
<p>ç¾åœ¨å®ƒæ”¹ç‚ºé€™æ¨£åšï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">prefix</span> <span class="o">=</span> <span class="s2">"foo/bar"</span><span class="p">.</span><span class="nf">camelize</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">Helper"</span><span class="p">.</span><span class="nf">constantize</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='prefix = "foo/bar".camelize
"#{prefix}Helper".constantize
'>Copy</button>
</div>
<p>æ­¤æ›´æ”¹å‘å¾Œç›¸å®¹å¤§å¤šæ•¸æ‡‰ç”¨ç¨‹å¼ï¼Œåœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œæ‚¨ç„¡éœ€åŸ·è¡Œä»»ä½•æ“ä½œã€‚</p><p>ä½†æ˜¯ï¼Œå¾æŠ€è¡“ä¸Šè¬›ï¼Œcontrollers å¯ä»¥å°‡ <code>helpers_path</code> è¨­å®šç‚ºæŒ‡å‘ <code>$LOAD_PATH</code> ä¸­ä¸åœ¨è‡ªå‹•è¼‰å…¥è·¯å¾‘ä¸­çš„ç›®éŒ„ã€‚é–‹ç®±å³ç”¨ä¸å†æ”¯æ´è©²ç”¨ä¾‹ã€‚å¦‚æœ helper module ä¸å¯è‡ªå‹•è¼‰å…¥ï¼Œå‰‡æ‡‰ç”¨ç¨‹å¼è² è²¬åœ¨å‘¼å« <code>helper</code> ä¹‹å‰è¼‰å…¥å®ƒã€‚</p><h4 id="http-https-308-http"><a class="anchorlink" href="#http-https-308-http">3.5 å¾ HTTP é‡å®šå‘åˆ° HTTPS ç¾åœ¨å°‡ä½¿ç”¨ 308 HTTP ç‹€æ…‹ç¨‹å¼ç¢¼</a></h4><p>å°‡é GET/HEAD è«‹æ±‚å¾ HTTP é‡å®šå‘åˆ° HTTPS æ™‚ï¼Œåœ¨ <code>ActionDispatch::SSL</code> ä¸­ä½¿ç”¨çš„é è¨­ HTTP ç‹€æ…‹ç¨‹å¼ç¢¼å·²æ›´æ”¹ç‚º <a href="https://tools.ietf.org/html/rfc7538">https://tools.ietf.org/html/rfc7538</a> ä¸­å®šç¾©çš„ <code>308</code>ã€‚</p><h4 id="active-storage"><a class="anchorlink" href="#active-storage">3.6 Active Storage ç¾åœ¨éœ€è¦å½±è±¡è™•ç†</a></h4><p>åœ¨ Active Storage ä¸­è™•ç†è®Šé«”æ™‚ï¼Œç¾åœ¨éœ€è¦æ†ç¶ <a href="https://github.com/janko-m/image_processing">image_processing gem</a> è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ <code>mini_magick</code>ã€‚å½±è±¡è™•ç†é è¨­è¨­å®šç‚ºåœ¨å¹•å¾Œä½¿ç”¨ <code>mini_magick</code>ï¼Œå› æ­¤æœ€ç°¡å–®çš„å‡ç´šæ–¹æ³•æ˜¯å°‡ <code>mini_magick</code> gem æ›¿æ›ç‚º <code>image_processing</code> gemï¼Œä¸¦ç¢ºä¿åˆªé™¤ <code>combine_options</code> çš„é¡¯å¼ä½¿ç”¨ï¼Œå› ç‚ºå®ƒä¸å†éœ€è¦ã€‚</p><p>ç‚ºäº†ä¾¿æ–¼é–±è®€ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å°‡åŸå§‹ <code>resize</code> å‘¼å«æ›´æ”¹ç‚º <code>image_processing</code> å·¨é›†ã€‚ä¾‹å¦‚ï¼Œè€Œä¸æ˜¯ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100"</span><span class="p">)</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100&gt;"</span><span class="p">)</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100^"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='video.preview(resize: "100x100")
video.preview(resize: "100x100&gt;")
video.preview(resize: "100x100^")
'>Copy</button>
</div>
<p>ä½ å¯ä»¥åˆ†åˆ¥åšï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_fit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_fill: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="video.preview(resize_to_fit: [100, 100])
video.preview(resize_to_limit: [100, 100])
video.preview(resize_to_fill: [100, 100])
">Copy</button>
</div>
<h3 id="rails-5-2-rails-6-0"><a class="anchorlink" href="#rails-5-2-rails-6-0">4 å¾ Rails 5.2 å‡ç´šåˆ° Rails 6.0</a></h3><p>æœ‰é—œå° Rails 6.0 æ‰€åšæ›´æ”¹çš„æ›´å¤šè³‡è¨Šï¼Œè«‹åƒé–± <a href="6_0_release_notes.html">ç™¼è¡Œèªªæ˜</a>ã€‚</p><h4 id="webpacker"><a class="anchorlink" href="#webpacker">4.1 ä½¿ç”¨ Webpacker</a></h4><p><a href="https://github.com/rails/webpacker">Webpacker</a>
æ˜¯ Rails 6 çš„é è¨­ JavaScript ç·¨è­¯å™¨ã€‚ä½†æ˜¯å¦‚æœæ‚¨æ­£åœ¨å‡ç´šæ‡‰ç”¨ç¨‹å¼ï¼Œå‰‡é è¨­æƒ…æ³ä¸‹ä¸æœƒå•Ÿç”¨å®ƒã€‚
å¦‚æœæ‚¨æƒ³ä½¿ç”¨ Webpackerï¼Œè«‹å°‡å…¶åŒ…å«åœ¨æ‚¨çš„ Gemfile ä¸­ä¸¦å®‰è£å®ƒï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s2">"webpacker"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='gem "webpacker"
'>Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>webpacker:install
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails webpacker:install
">Copy</button>
</div>
<h4 id="ssl"><a class="anchorlink" href="#ssl">4.2 å¼·åˆ¶ SSL</a></h4><p>controllers ä¸Šçš„ <code>force_ssl</code> æ–¹æ³•å·²è¢«æ£„ç”¨ï¼Œå°‡åœ¨
Rails 6.1ã€‚é¼“å‹µæ‚¨å•Ÿç”¨ <code>config.force_ssl</code> ä»¥å¼·åˆ¶åŸ·è¡Œ HTTPS
æ•´å€‹æ‡‰ç”¨ç¨‹å¼çš„é€£ç·šã€‚å¦‚æœæ‚¨éœ€è¦å…é™¤æŸäº›ç«¯é»
å¾é‡å®šå‘ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <code>config.ssl_options</code> ä¾†è¨­å®šè©²è¡Œç‚ºã€‚</p><h4 id="cookies"><a class="anchorlink" href="#cookies">4.3 ç›®çš„å’Œåˆ°æœŸå…ƒè³‡æ–™ç¾åœ¨åµŒå…¥åœ¨ç°½åå’ŒåŠ å¯†çš„ cookies ä¸­ä»¥æé«˜å®‰å…¨æ€§</a></h4><p>ç‚ºäº†æé«˜å®‰å…¨æ€§ï¼ŒRails å°‡ç”¨é€”å’Œåˆ°æœŸå…ƒè³‡æ–™åµŒå…¥åˆ°åŠ å¯†æˆ–ç°½åçš„ cookies value ä¸­ã€‚</p><p>Rails ç„¶å¾Œå¯ä»¥é˜»æ­¢è©¦åœ–è¤‡è£½ç°½å/åŠ å¯†çš„ value çš„æ”»æ“Š
ä¸€å€‹ cookie ä¸¦å°‡å…¶ç”¨ä½œå¦ä¸€å€‹ cookie çš„ valueã€‚</p><p>é€™å€‹æ–°çš„åµŒå…¥å…ƒè³‡æ–™ä½¿é‚£äº› cookies èˆ‡æ—©æ–¼ 6.0 çš„ Rails ç‰ˆæœ¬ä¸ç›¸å®¹ã€‚</p><p>å¦‚æœæ‚¨éœ€è¦ cookies 5.2 åŠæ›´æ—©ç‰ˆæœ¬è®€å– cookiesï¼Œæˆ–è€…æ‚¨ä»åœ¨é©—è­‰ 6.0 éƒ¨ç½²ä¸¦å¸Œæœ›
èƒ½å¤ å›æ»¾è¨­å®š
<code>Rails.application.config.action_dispatch.use_cookies_with_metadata</code> åˆ° <code>false</code>ã€‚</p><h4 id="npm-rails"><a class="anchorlink" href="#npm-rails">4.4 æ‰€æœ‰ npm åŒ…éƒ½ç§»åˆ°äº† <code>@rails</code> ä½œç”¨åŸŸ</a></h4><p>å¦‚æœæ‚¨ä¹‹å‰è¼‰å…¥äº† <code>actioncable</code>ã€<code>activestorage</code> ä¸­çš„ä»»ä½•ä¸€å€‹ï¼Œ
æˆ–è€… <code>rails-ujs</code> åŒ…é€šé npm/yarnï¼Œä½ å¿…é ˆæ›´æ–°é€™äº›çš„åå­—
å°‡ä¾è³´é …å‡ç´šåˆ° <code>6.0.0</code> ä¹‹å‰ï¼š</p><div class="code_container">
<pre><code class="highlight plaintext">actioncable   â†’ @rails/actioncable
activestorage â†’ @rails/activestorage
rails-ujs     â†’ @rails/ujs
</code></pre>
<button class="clipboard-button" data-clipboard-text="actioncable   â†’ @rails/actioncable
activestorage â†’ @rails/activestorage
rails-ujs     â†’ @rails/ujs
">Copy</button>
</div>
<h4 id="action-cable-javascript-api"><a class="anchorlink" href="#action-cable-javascript-api">4.5 Action Cable JavaScript API æ›´æ”¹</a></h4><p>Action Cable JavaScript åŒ…å·²å¾ CoffeeScript è½‰æ›è€Œä¾†
åˆ° ES2015ï¼Œæˆ‘å€‘ç¾åœ¨åœ¨ npm ç™¼è¡Œç‰ˆä¸­é‡‹å‡ºåŸå§‹ç¢¼ã€‚</p><p>æ­¤ç‰ˆæœ¬åŒ…æ‹¬å°å¯é¸éƒ¨åˆ†çš„ä¸€äº›é‡å¤§æ›´æ”¹
Action Cable JavaScript APIï¼š</p>
<ul>
<li>
<p>WebSocket ä»‹é¢å¡å’Œè¨˜éŒ„å™¨ä»‹é¢å¡çš„è¨­å®šå·²è¢«ç§»å‹•
å¾ <code>ActionCable</code> çš„å±¬æ€§åˆ° <code>ActionCable.adapters</code> çš„å±¬æ€§ã€‚
å¦‚æœæ‚¨æ­£åœ¨è¨­å®šé€™äº›ä»‹é¢å¡ï¼Œæ‚¨å°‡éœ€è¦è£½ä½œ
é€™äº›è®ŠåŒ–ï¼š</p>
<div class="code_container">
<pre><code class="highlight diff"><span class="gd">-    ActionCable.WebSocket = MyWebSocket
</span><span class="gi">+    ActionCable.adapters.WebSocket = MyWebSocket
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="-    ActionCable.WebSocket = MyWebSocket
+    ActionCable.adapters.WebSocket = MyWebSocket
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight diff"><span class="gd">-    ActionCable.logger = myLogger
</span><span class="gi">+    ActionCable.adapters.logger = myLogger
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="-    ActionCable.logger = myLogger
+    ActionCable.adapters.logger = myLogger
">Copy</button>
</div>
</li>
<li>
<p><code>ActionCable.startDebugging()</code> å’Œ <code>ActionCable.stopDebugging()</code>
æ–¹æ³•å·²è¢«åˆªé™¤ä¸¦æ›¿æ›ç‚ºå±¬æ€§
<code>ActionCable.logger.enabled</code>ã€‚å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨é€™äº›æ–¹æ³•
å°‡éœ€è¦é€²è¡Œé€™äº›æ›´æ”¹ï¼š</p>
<div class="code_container">
<pre><code class="highlight diff"><span class="gd">-    ActionCable.startDebugging()
</span><span class="gi">+    ActionCable.logger.enabled = true
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="-    ActionCable.startDebugging()
+    ActionCable.logger.enabled = true
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight diff"><span class="gd">-    ActionCable.stopDebugging()
</span><span class="gi">+    ActionCable.logger.enabled = false
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="-    ActionCable.stopDebugging()
+    ActionCable.logger.enabled = false
">Copy</button>
</div>
</li>
</ul>
<h4 id="actiondispatch-response-content-type-content-type"><a class="anchorlink" href="#actiondispatch-response-content-type-content-type">4.6 <code>ActionDispatch::Response#content_type</code> ç¾åœ¨ç„¡éœ€ä¿®æ”¹å³å¯è¿”å› Content-Type æ¨™é ­</a></h4><p>ä»¥å‰ï¼Œ <code>ActionDispatch::Response#content_type</code> çš„è¿”å› value ä¸åŒ…å«å­—ç¬¦é›†éƒ¨åˆ†ã€‚
æ­¤è¡Œç‚ºå·²æ›´æ”¹ç‚ºåŒ…æ‹¬å…ˆå‰çœç•¥çš„å­—ç¬¦é›†éƒ¨åˆ†ã€‚</p><p>å¦‚æœæ‚¨åªéœ€è¦ MIME å‹åˆ¥ï¼Œè«‹æ”¹ç”¨ <code>ActionDispatch::Response#media_type</code>ã€‚</p><p>å‰ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resp</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='resp = ActionDispatch::Response.new(200, "Content-Type" =&gt; "text/csv; header=present; charset=utf-16")
resp.content_type #=&gt; "text/csv; header=present"
'>Copy</button>
</div>
<p>å¾Œï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resp</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present; charset=utf-16"</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">media_type</span>   <span class="c1">#=&gt; "text/csv"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='resp = ActionDispatch::Response.new(200, "Content-Type" =&gt; "text/csv; header=present; charset=utf-16")
resp.content_type #=&gt; "text/csv; header=present; charset=utf-16"
resp.media_type   #=&gt; "text/csv"
'>Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">4.7 è‡ªå‹•è¼‰å…¥</a></h4><p>Rails 6 é è¨­è¨­å®š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># è¨­å®š/æ‡‰ç”¨ç¨‹å¼.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.0</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# è¨­å®š/æ‡‰ç”¨ç¨‹å¼.rb

config.load_defaults 6.0
">Copy</button>
</div>
<p>åœ¨ CRuby ä¸Šå•Ÿç”¨ <code>zeitwerk</code> è‡ªå‹•è¼‰å…¥æ¨¡å¼ã€‚åœ¨é€™ç¨®æ¨¡å¼ä¸‹ï¼Œè‡ªå‹•è¼‰å…¥ã€é‡æ–°è¼‰å…¥å’Œé å…ˆè¼‰å…¥ç”± <a href="https://github.com/fxn/zeitwerk">Zeitwerk</a> ç®¡ç†ã€‚</p><h5 id=""><a class="anchorlink" href="#">4.7.1 å…¬å…±ä»‹é¢</a></h5><p>ä¸€èˆ¬ä¾†èªªï¼Œæ‡‰ç”¨ç¨‹å¼ä¸éœ€è¦ç›´æ¥ä½¿ç”¨ Zeitwerk çš„ APIã€‚ Rails æ ¹æ“šç¾æœ‰åˆç´„é€²è¡Œè¨­å®šï¼š<code>config.autoload_paths</code>ã€<code>config.cache_classes</code> ç­‰ã€‚</p><p>é›–ç„¶æ‡‰ç”¨ç¨‹å¼æ‡‰è©²å …æŒè©²ä»‹é¢ï¼Œä½†å¯¦éš›çš„ Zeitwerk è¼‰å…¥å™¨ç‰©ä»¶å¯ä»¥ä½œç‚º</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">main</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.autoloaders.main
">Copy</button>
</div>
<p>ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨éœ€è¦é è¼‰å…¥å–®è¡¨ç¹¼æ‰¿ (STI) é¡æˆ–è¨­å®šè‡ªå®šç¾©è®Šå½¢å™¨ï¼Œé€™å¯èƒ½æœƒå¾ˆæ–¹ä¾¿ã€‚</p><h5 id=""><a class="anchorlink" href="#">4.7.2 å°ˆæ¡ˆçµæ§‹</a></h5><p>å¦‚æœæ­£åœ¨å‡ç´šçš„æ‡‰ç”¨ç¨‹å¼æ­£ç¢ºè‡ªå‹•è¼‰å…¥ï¼Œå‰‡å°ˆæ¡ˆçµæ§‹æ‡‰è©²å·²ç¶“åŸºæœ¬ç›¸å®¹ã€‚</p><p>ä½†æ˜¯ï¼Œ<code>classic</code> æ¨¡å¼å¾ç¼ºå°‘çš„å¸¸é‡å (<code>underscore</code>) æ¨æ–·æª”åï¼Œè€Œ <code>zeitwerk</code> æ¨¡å¼å¾æª”å (<code>camelize</code>) æ¨æ–·å¸¸é‡åã€‚é€™äº› helpers ä¸¦ä¸ç¸½æ˜¯å½¼æ­¤ç›¸åï¼Œå°¤å…¶æ˜¯åœ¨æ¶‰åŠé¦–å­—æ¯ç¸®ç•¥è©æ™‚ã€‚ä¾‹å¦‚ï¼Œ<code>"FOO".underscore</code> æ˜¯ <code>"foo"</code>ï¼Œä½† <code>"foo".camelize</code> æ˜¯ <code>"Foo"</code>ï¼Œè€Œä¸æ˜¯ <code>"FOO"</code>ã€‚</p><p>å¯ä»¥ä½¿ç”¨ <code>zeitwerk:check</code> ä»»å‹™æª¢æŸ¥ç›¸å®¹æ€§ï¼š</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>zeitwerk:check
<span class="go">Hold on, I am eager loading the application.
All is good!
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails zeitwerk:check
">Copy</button>
</div>
<h5 id="require-dependency"><a class="anchorlink" href="#require-dependency">4.7.3 require_dependency</a></h5><p><code>require_dependency</code> çš„æ‰€æœ‰å·²çŸ¥ç”¨ä¾‹éƒ½å·²æ¶ˆé™¤ï¼Œæ‚¨æ‡‰è©² grep å°ˆæ¡ˆä¸¦åˆªé™¤å®ƒå€‘ã€‚</p><p>å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨å–®è¡¨ç¹¼æ‰¿ï¼Œè«‹åƒé–±è‡ªå‹•è¼‰å…¥å’Œé‡æ–°è¼‰å…¥å¸¸é‡ï¼ˆZeitwerk æ¨¡å¼ï¼‰æŒ‡å—çš„<a href="autoloading_and_reloading_constants.html#single-table-inheritance">å–®è¡¨ç¹¼æ‰¿éƒ¨åˆ†</a>ã€‚</p><h5 id="module"><a class="anchorlink" href="#module">4.7.4 é¡ä¸­çš„é™å®šåç¨±å’Œ module å®šç¾©</a></h5><p>æ‚¨ç¾åœ¨å¯ä»¥åœ¨é¡å’Œ module å®šç¾©ä¸­ç©©å¥åœ°ä½¿ç”¨å¸¸é‡è·¯å¾‘ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># é€™å€‹é¡çš„ä¸»é«”ä¸­çš„è‡ªå‹•è¼‰å…¥ç¾åœ¨åŒ¹é… Ruby èªç¾©ã€‚</span>
<span class="k">class</span> <span class="nc">Admin::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# é€™å€‹é¡çš„ä¸»é«”ä¸­çš„è‡ªå‹•è¼‰å…¥ç¾åœ¨åŒ¹é… Ruby èªç¾©ã€‚
class Admin::UsersController &lt; ApplicationController
  # ...
end
">Copy</button>
</div>
<p>éœ€è¦æ³¨æ„çš„ä¸€å€‹å•é¡Œæ˜¯ï¼Œæ ¹æ“šåŸ·è¡Œé †åºï¼Œç¶“å…¸çš„è‡ªå‹•è¼‰å…¥å™¨æœ‰æ™‚å¯ä»¥è‡ªå‹•è¼‰å…¥ <code>Foo::Wadus</code></p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Foo::Bar</span>
  <span class="nc">Wadus</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Foo::Bar
  Wadus
end
">Copy</button>
</div>
<p>é€™èˆ‡ Ruby èªç¾©ä¸åŒ¹é…ï¼Œå› ç‚º <code>Foo</code> ä¸åœ¨å·¢ç‹€ä¸­ï¼Œä¸¦ä¸”åœ¨ <code>zeitwerk</code> æ¨¡å¼ä¸‹æ ¹æœ¬ä¸èµ·ä½œç”¨ã€‚å¦‚æœæ‚¨ç™¼ç¾é€™æ¨£çš„æ¥µç«¯æƒ…æ³ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨é™å®šåç¨± <code>Foo::Wadus</code>ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Foo::Bar</span>
  <span class="nc">Foo::Wadus</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Foo::Bar
  Foo::Wadus
end
">Copy</button>
</div>
<p>æˆ–å°‡ <code>Foo</code> æ–°å¢åˆ°å·¢ç‹€ä¸­ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Foo</span>
  <span class="k">class</span> <span class="nc">Bar</span>
    <span class="no">Wadus</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module Foo
  class Bar
    Wadus
  end
end
">Copy</button>
</div>
<h5 id=""><a class="anchorlink" href="#">4.7.5 é—œæ³¨é»</a></h5><p>æ‚¨å¯ä»¥å¾æ¨™æº–çµæ§‹è‡ªå‹•è¼‰å…¥å’Œé å…ˆè¼‰å…¥ï¼Œä¾‹å¦‚</p><div class="code_container">
<pre><code class="highlight plaintext">app/models
app/models/concerns
</code></pre>
<button class="clipboard-button" data-clipboard-text="app/models
app/models/concerns
">Copy</button>
</div>
<p>åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œ<code>app/models/concerns</code> è¢«å‡å®šç‚ºæ ¹ç›®éŒ„ï¼ˆå› ç‚ºå®ƒå±¬æ–¼è‡ªå‹•è¼‰å…¥è·¯å¾‘ï¼‰ï¼Œä¸¦ä¸”å®ƒä½œç‚ºåç¨±ç©ºé–“è¢«å¿½ç•¥ã€‚æ‰€ä»¥ï¼Œ<code>app/models/concerns/foo.rb</code> æ‡‰è©²å®šç¾© <code>Foo</code>ï¼Œè€Œä¸æ˜¯ <code>Concerns::Foo</code>ã€‚</p><p><code>Concerns::</code> åç¨±ç©ºé–“èˆ‡ç¶“å…¸è‡ªå‹•è¼‰å…¥å™¨ä¸€èµ·ä½œç‚ºå¯¦ç¾çš„å‰¯ä½œç”¨ï¼Œä½†é€™ä¸¦ä¸æ˜¯çœŸæ­£çš„é æœŸè¡Œç‚ºã€‚ä½¿ç”¨ <code>Concerns::</code> çš„æ‡‰ç”¨ç¨‹å¼éœ€è¦é‡æ–°å‘½åé€™äº›é¡å’Œ modules æ‰èƒ½åœ¨ <code>zeitwerk</code> æ¨¡å¼ä¸‹åŸ·è¡Œã€‚</p><h5 id="app"><a class="anchorlink" href="#app">4.7.6 åœ¨è‡ªå‹•è¼‰å…¥è·¯å¾‘ä¸­æœ‰ <code>app</code></a></h5><p>ä¸€äº›å°ˆæ¡ˆæƒ³è¦åƒ <code>app/api/base.rb</code> é€™æ¨£çš„æ±è¥¿ä¾†å®šç¾© <code>API::Base</code>ï¼Œä¸¦å°‡ <code>app</code> æ–°å¢åˆ°è‡ªå‹•è¼‰å…¥è·¯å¾‘ä¸­ä»¥åœ¨ <code>classic</code> æ¨¡å¼ä¸‹å®Œæˆã€‚ç”±æ–¼Railsè‡ªå‹•å°‡<code>app</code>çš„æ‰€æœ‰å­ç›®éŒ„æ–°å¢åˆ°è‡ªå‹•è¼‰å…¥è·¯å¾‘ä¸­ï¼Œæˆ‘å€‘é‚„æœ‰å¦ä¸€ç¨®æƒ…æ³ï¼Œå…¶ä¸­å­˜åœ¨å·¢ç‹€çš„æ ¹ç›®éŒ„ï¼Œå› æ­¤è¨­å®šä¸å†èµ·ä½œç”¨ã€‚é¡ä¼¼çš„åŸç†æˆ‘å€‘åœ¨ä¸Šé¢ç”¨ <code>concerns</code> è§£é‡‹éã€‚</p><p>å¦‚æœè¦ä¿ç•™è©²çµæ§‹ï¼Œå‰‡éœ€è¦å¾åˆå§‹åŒ–ç¨‹å¼çš„è‡ªå‹•è¼‰å…¥è·¯å¾‘ä¸­åˆªé™¤å­ç›®éŒ„ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="p">.</span><span class="nf">autoload_paths</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/app/api"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='ActiveSupport::Dependencies.autoload_paths.delete("#{Rails.root}/app/api")
'>Copy</button>
</div>
<h5 id=""><a class="anchorlink" href="#">4.7.7 è‡ªå‹•è¼‰å…¥å¸¸é‡å’Œé¡¯å¼åç¨±ç©ºé–“</a></h5><p>å¦‚æœåœ¨æª”æ¡ˆä¸­å®šç¾©äº†åç¨±ç©ºé–“ï¼Œå‰‡æ­¤è™•ç‚º <code>Hotel</code>ï¼š</p><div class="code_container">
<pre><code class="highlight plaintext">app/models/hotel.rb         # Defines Hotel.
app/models/hotel/pricing.rb # Defines Hotel::Pricing.
</code></pre>
<button class="clipboard-button" data-clipboard-text="app/models/hotel.rb         # Defines Hotel.
app/models/hotel/pricing.rb # Defines Hotel::Pricing.
">Copy</button>
</div>
<p>å¿…é ˆä½¿ç”¨ <code>class</code> æˆ– <code>module</code> keywords è¨­å®š <code>Hotel</code> å¸¸é‡ã€‚ä¾‹å¦‚ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Hotel</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Hotel
end
">Copy</button>
</div>
<p>å¾ˆå¥½ã€‚</p><p>æ›¿ä»£å“ï¼Œå¦‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Hotel</span> <span class="o">=</span> <span class="no">Class</span><span class="p">.</span><span class="nf">new</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Hotel = Class.new
">Copy</button>
</div>
<p>æˆ–è€…</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Hotel</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Hotel = Struct.new
">Copy</button>
</div>
<p>ä¸æœƒå·¥ä½œï¼Œä¸æœƒæ‰¾åˆ°åƒ <code>Hotel::Pricing</code> é€™æ¨£çš„å­ç‰©ä»¶ã€‚</p><p>æ­¤é™åˆ¶åƒ…é©ç”¨æ–¼é¡¯å¼åç¨±ç©ºé–“ã€‚æ²’æœ‰å®šç¾©åç¨±ç©ºé–“çš„é¡å’Œ modules å¯ä»¥ä½¿ç”¨é€™äº›ç¿’èªä¾†å®šç¾©ã€‚</p><h5 id=""><a class="anchorlink" href="#">4.7.8 ä¸€å€‹æª”æ¡ˆï¼Œä¸€å€‹å¸¸é‡ï¼ˆåœ¨åŒä¸€å€‹é ‚å±¤ï¼‰</a></h5><p>åœ¨ <code>classic</code> æ¨¡å¼ä¸‹ï¼Œæ‚¨å¯ä»¥åœ¨æŠ€è¡“ä¸Šåœ¨åŒä¸€é ‚ç´šå®šç¾©å¹¾å€‹å¸¸é‡ï¼Œä¸¦é‡æ–°è¼‰å…¥å®ƒå€‘ã€‚ä¾‹å¦‚ï¼Œçµ¦å®š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/foo.rb</span>

<span class="k">class</span> <span class="nc">Foo</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Bar</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/models/foo.rb

class Foo
end

class Bar
end
">Copy</button>
</div>
<p>é›–ç„¶ <code>Bar</code> ç„¡æ³•è‡ªå‹•è¼‰å…¥ï¼Œä½†è‡ªå‹•è¼‰å…¥ <code>Foo</code> ä¹Ÿæœƒå°‡ <code>Bar</code> æ¨™è¨˜ç‚ºè‡ªå‹•è¼‰å…¥ã€‚ <code>zeitwerk</code>æ¨¡å¼ä¸‹ä¸æ˜¯é€™æ¨£ï¼Œéœ€è¦å°‡<code>Bar</code>ç§»å‹•åˆ°è‡ªå·±çš„æª”æ¡ˆ<code>bar.rb</code>ä¸­ã€‚ä¸€å€‹æª”æ¡ˆï¼Œä¸€å€‹å¸¸é‡ã€‚</p><p>é€™åƒ…å½±éŸ¿èˆ‡ä¸Šé¢ç¤ºä¾‹ä¸­ç›¸åŒçš„é ‚å±¤çš„å¸¸é‡ã€‚å…§éƒ¨é¡å’Œ modules å¾ˆå¥½ã€‚ä¾‹å¦‚ï¼Œè€ƒæ…®</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/foo.rb</span>

<span class="k">class</span> <span class="nc">Foo</span>
  <span class="k">class</span> <span class="nc">InnerClass</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/models/foo.rb

class Foo
  class InnerClass
  end
end
">Copy</button>
</div>
<p>å¦‚æœæ‡‰ç”¨ç¨‹å¼é‡æ–°è¼‰å…¥ <code>Foo</code>ï¼Œå®ƒä¹Ÿæœƒé‡æ–°è¼‰å…¥ <code>Foo::InnerClass</code>ã€‚</p><h5 id="spring-test"><a class="anchorlink" href="#spring-test">4.7.9 Spring å’Œ <code>test</code> ç’°å¢ƒ</a></h5><p>å¦‚æœç™¼ç”Ÿè®ŠåŒ–ï¼ŒSpring æœƒé‡æ–°è¼‰å…¥æ‡‰ç”¨ç¨‹å¼ç¨‹å¼ç¢¼ã€‚åœ¨ <code>test</code> ç’°å¢ƒä¸­ï¼Œæ‚¨éœ€è¦å•Ÿç”¨é‡æ–°è¼‰å…¥æ‰èƒ½æ­£å¸¸å·¥ä½œï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># è¨­å®š/ç’°å¢ƒ/test.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">cache_classes</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# è¨­å®š/ç’°å¢ƒ/test.rb

config.cache_classes = false
">Copy</button>
</div>
<p>å¦å‰‡ä½ æœƒå¾—åˆ°é€™å€‹éŒ¯èª¤ï¼š</p><div class="code_container">
<pre><code class="highlight plaintext">reloading is disabled because config.cache_classes is true
</code></pre>
<button class="clipboard-button" data-clipboard-text="reloading is disabled because config.cache_classes is true
">Copy</button>
</div>
<h5 id="-"><a class="anchorlink" href="#-">4.7.10 è¼‰å…¥ç¨‹å¼</a></h5><p>Bootsnap è‡³å°‘æ‡‰ç‚º 1.4.2 ç‰ˆã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœåŸ·è¡Œ Ruby 2.5ï¼Œç”±æ–¼ç›´è­¯å™¨ä¸­çš„éŒ¯èª¤ï¼ŒBootsnap éœ€è¦ç¦ç”¨ iseq å¿«å–ã€‚åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œè«‹ç¢ºä¿è‡³å°‘ä¾è³´ Bootsnap 1.4.4ã€‚</p><h5 id="config-add-autoload-paths-to-load-path"><a class="anchorlink" href="#config-add-autoload-paths-to-load-path">4.7.11 <code>config.add_autoload_paths_to_load_path</code></a></h5><p>æ–°çš„è¨­å®šé»</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">add_autoload_paths_to_load_path</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.add_autoload_paths_to_load_path
">Copy</button>
</div>
<p>é è¨­æƒ…æ³ä¸‹ç‚º <code>true</code> ä»¥å¯¦ç¾å‘å¾Œç›¸å®¹æ€§ï¼Œä½†å…è¨±æ‚¨é¸æ“‡é€€å‡ºå°‡è‡ªå‹•è¼‰å…¥è·¯å¾‘æ–°å¢åˆ° <code>$LOAD_PATH</code>ã€‚</p><p>é€™åœ¨å¤§å¤šæ•¸æ‡‰ç”¨ç¨‹å¼ä¸­æ˜¯æœ‰æ„ç¾©çš„ï¼Œå› ç‚ºæ‚¨æ°¸é ä¸æ‡‰è©²éœ€è¦ <code>app/models</code> ä¸­çš„æª”æ¡ˆï¼Œä¾‹å¦‚ï¼ŒZeitwerk åƒ…åœ¨å…§éƒ¨ä½¿ç”¨çµ•å°æª”åã€‚</p><p>é€šéé¸æ“‡é€€å‡ºï¼Œæ‚¨å¯ä»¥å„ªåŒ– <code>$LOAD_PATH</code> æŸ¥è©¢ï¼ˆè¦æª¢æŸ¥çš„ç›®éŒ„æ›´å°‘ï¼‰ï¼Œä¸¦ç¯€çœ Bootsnap å·¥ä½œå’Œè¨˜æ†¶é«”æ¶ˆè€—ï¼Œå› ç‚ºå®ƒä¸éœ€è¦ç‚ºé€™äº›ç›®éŒ„æ§‹å»ºç´¢å¼•ã€‚</p><h5 id=""><a class="anchorlink" href="#">4.7.12 åŸ·è¡Œç·’å®‰å…¨</a></h5><p>åœ¨ç¶“å…¸æ¨¡å¼ä¸‹ï¼Œå¸¸é‡è‡ªå‹•è¼‰å…¥ä¸æ˜¯åŸ·è¡Œç·’å®‰å…¨çš„ï¼Œå„˜ç®¡ Rails æœ‰é–å®šï¼Œä¾‹å¦‚åœ¨å•Ÿç”¨è‡ªå‹•è¼‰å…¥æ™‚ä½¿ Web è«‹æ±‚åŸ·è¡Œç·’å®‰å…¨ï¼Œå› ç‚ºå®ƒåœ¨é–‹ç™¼ç’°å¢ƒä¸­å¾ˆå¸¸è¦‹ã€‚</p><p>æ†å®šè‡ªå‹•è¼‰å…¥åœ¨ <code>zeitwerk</code> æ¨¡å¼ä¸‹æ˜¯åŸ·è¡Œç·’å®‰å…¨çš„ã€‚ä¾‹å¦‚ï¼Œæ‚¨ç¾åœ¨å¯ä»¥åœ¨ç”± <code>runner</code> å‘½ä»¤åŸ·è¡Œçš„å¤šåŸ·è¡Œç·’æŒ‡ä»¤ç¢¼ä¸­è‡ªå‹•è¼‰å…¥ã€‚</p><h5 id="config-autoload-paths-glob"><a class="anchorlink" href="#config-autoload-paths-glob">4.7.13 config.autoload_paths ä¸­çš„ Glob</a></h5><p>ç•¶å¿ƒåƒé€™æ¨£çš„è¨­å®š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">+=</span> <span class="no">Dir</span><span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib/**/"</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='config.autoload_paths += Dir["#{config.root}/lib/**/"]
'>Copy</button>
</div>
<p><code>config.autoload_paths</code> çš„æ¯å€‹å…ƒç´ éƒ½æ‡‰è©²ä»£è¡¨é ‚ç´šåç¨±ç©ºé–“ï¼ˆ<code>Object</code>ï¼‰ï¼Œå› æ­¤å®ƒå€‘ä¸èƒ½å·¢ç‹€ï¼ˆé™¤äº†ä¸Šé¢è§£é‡‹çš„ <code>concerns</code> ç›®éŒ„ï¼‰ã€‚</p><p>è¦è§£æ±ºæ­¤å•é¡Œï¼Œåªéœ€åˆªé™¤è¬ç”¨å­—å…ƒï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="si">#{</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='config.autoload_paths &lt;&lt; "#{config.root}/lib"
'>Copy</button>
</div>
<h5 id="eager"><a class="anchorlink" href="#eager">4.7.14 Eager è¼‰å…¥å’Œè‡ªå‹•è¼‰å…¥æ˜¯ä¸€è‡´çš„</a></h5><p>åœ¨ <code>classic</code> æ¨¡å¼ä¸‹ï¼Œå¦‚æœ <code>app/models/foo.rb</code> å®šç¾©äº† <code>Bar</code>ï¼Œæ‚¨å°‡ç„¡æ³•è‡ªå‹•è¼‰å…¥è©²æª”æ¡ˆï¼Œä½†å¿«é€Ÿè¼‰å…¥æœƒèµ·ä½œç”¨ï¼Œå› ç‚ºå®ƒæœƒç›²ç›®åœ°éè¿´è¼‰å…¥æª”æ¡ˆã€‚å¦‚æœæ‚¨é¦–å…ˆæ¸¬è©¦æ€¥åˆ‡è¼‰å…¥ï¼Œé€™å¯èƒ½æ˜¯éŒ¯èª¤çš„ä¾†æºï¼Œç¨å¾ŒåŸ·è¡Œå¯èƒ½æœƒå¤±æ•—è‡ªå‹•è¼‰å…¥ã€‚</p><p>åœ¨ <code>zeitwerk</code> æ¨¡å¼ä¸‹ï¼Œå…©ç¨®è¼‰å…¥æ¨¡å¼æ˜¯ä¸€è‡´çš„ï¼Œå®ƒå€‘åœ¨åŒä¸€å€‹æª”æ¡ˆä¸­å¤±æ•—å’Œå‡ºéŒ¯ã€‚</p><h5 id="rails-6-classic-autoloader"><a class="anchorlink" href="#rails-6-classic-autoloader">4.7.15 å¦‚ä½•åœ¨ Rails 6 ä¸­ä½¿ç”¨ Classic Autoloader</a></h5><p>æ‡‰ç”¨ç¨‹å¼å¯ä»¥è¼‰å…¥ Rails 6 å€‹é è¨­å€¼ï¼Œä¸¦é€šéä»¥é€™ç¨®æ–¹å¼è¨­å®š <code>config.autoloader</code> ä»ç„¶ä½¿ç”¨ç¶“å…¸çš„è‡ªå‹•è¼‰å…¥å™¨ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># è¨­å®š/æ‡‰ç”¨ç¨‹å¼.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.0</span>
<span class="n">config</span><span class="p">.</span><span class="nf">autoloader</span> <span class="o">=</span> <span class="ss">:classic</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# è¨­å®š/æ‡‰ç”¨ç¨‹å¼.rb

config.load_defaults 6.0
config.autoloader = :classic
">Copy</button>
</div>
<p>åœ¨ Rails 6 æ‡‰ç”¨ç¨‹å¼ä¸­ä½¿ç”¨ Classic Autoloader æ™‚ï¼Œç”±æ–¼åŸ·è¡Œç·’å®‰å…¨å•é¡Œï¼Œå»ºè­°åœ¨é–‹ç™¼ç’°å¢ƒä¸­å°‡ Web ä¼ºæœå™¨å’Œå¾Œè‡ºè™•ç†å™¨çš„å¹³è¡Œè¨ˆç®—ç´šåˆ¥è¨­å®šç‚º 1ã€‚</p><h4 id="active-storage"><a class="anchorlink" href="#active-storage">4.8 Active Storage è³¦å€¼è¡Œç‚ºæ”¹è®Š</a></h4><p>ä½¿ç”¨ Rails 5.2 çš„é è¨­è¨­å®šï¼Œåˆ†é…çµ¦ä½¿ç”¨ <code>has_many_attached</code> å®£å‘Šçš„é™„ä»¶é›†åˆæœƒé™„åŠ æ–°æª”æ¡ˆï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many_attached</span> <span class="ss">:highlights</span>
<span class="k">end</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"funky.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>

<span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">highlights: </span><span class="p">[</span> <span class="n">blob</span> <span class="p">])</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 2</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "funky.jpg"</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">second</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class User &lt; ApplicationRecord
  has_many_attached :highlights
end

user.highlights.attach(filename: "funky.jpg", ...)
user.highlights.count # =&gt; 1

blob = ActiveStorage::Blob.create_after_upload!(filename: "town.jpg", ...)
user.update!(highlights: [ blob ])

user.highlights.count # =&gt; 2
user.highlights.first.filename # =&gt; "funky.jpg"
user.highlights.second.filename # =&gt; "town.jpg"
'>Copy</button>
</div>
<p>ä½¿ç”¨ Rails 6.0 çš„é è¨­è¨­å®šï¼Œåˆ†é…çµ¦é™„ä»¶é›†åˆæœƒæ›¿æ›ç¾æœ‰æª”æ¡ˆè€Œä¸æ˜¯é™„åŠ åˆ°å®ƒå€‘ã€‚é€™èˆ‡åˆ†é…çµ¦é›†åˆ association æ™‚çš„ Active Record è¡Œç‚ºåŒ¹é…ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"funky.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>

<span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">highlights: </span><span class="p">[</span> <span class="n">blob</span> <span class="p">])</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='user.highlights.attach(filename: "funky.jpg", ...)
user.highlights.count # =&gt; 1

blob = ActiveStorage::Blob.create_after_upload!(filename: "town.jpg", ...)
user.update!(highlights: [ blob ])

user.highlights.count # =&gt; 1
user.highlights.first.filename # =&gt; "town.jpg"
'>Copy</button>
</div>
<p><code>#attach</code> å¯ç”¨æ–¼æ–°å¢æ–°é™„ä»¶è€Œä¸åˆªé™¤ç¾æœ‰é™„ä»¶ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 2</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "funky.jpg"</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">second</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='blob = ActiveStorage::Blob.create_after_upload!(filename: "town.jpg", ...)
user.highlights.attach(blob)

user.highlights.count # =&gt; 2
user.highlights.first.filename # =&gt; "funky.jpg"
user.highlights.second.filename # =&gt; "town.jpg"
'>Copy</button>
</div>
<p>ç¾æœ‰æ‡‰ç”¨ç¨‹å¼å¯ä»¥é€šéå°‡ <code>config.active_storage.replace_on_assign_to_many</code> è¨­å®šç‚º <code>true</code> ä¾†é¸æ“‡åŠ å…¥æ­¤æ–°è¡Œç‚ºã€‚èˆŠè¡Œç‚ºå°‡åœ¨ Rails 7.0 ä¸­æ£„ç”¨ï¼Œä¸¦åœ¨ Rails 7.1 ä¸­åˆªé™¤ã€‚</p><h3 id="rails-5-1-rails-5-2"><a class="anchorlink" href="#rails-5-1-rails-5-2">5 å¾ Rails 5.1 å‡ç´šåˆ° Rails 5.2</a></h3><p>æœ‰é—œå° Rails 5.2 æ‰€åšæ›´æ”¹çš„æ›´å¤šè³‡è¨Šï¼Œè«‹åƒé–± <a href="5_2_release_notes.html">ç™¼è¡Œèªªæ˜</a>ã€‚</p><h4 id="rails-5-1-rails-5-2"><a class="anchorlink" href="#rails-5-1-rails-5-2">5.1 è¼‰å…¥ç¨‹å¼</a></h4><p>Rails 5.2 åœ¨<a href="https://github.com/rails/rails/pull/29313">æ–°ç”¢ç”Ÿçš„æ‡‰ç”¨ç¨‹å¼çš„ Gemfile</a> ä¸­æ·»åŠ äº† bootsnap gemã€‚
<code>app:update</code> å‘½ä»¤åœ¨ <code>boot.rb</code> ä¸­è¨­å®šå®ƒã€‚å¦‚æœä½ æƒ³ä½¿ç”¨å®ƒï¼Œç„¶å¾Œå°‡å®ƒæ–°å¢åˆ° Gemfile ä¸­ï¼Œ
å¦å‰‡æ›´æ”¹ <code>boot.rb</code> ä»¥ä¸ä½¿ç”¨å¼•å°å¿«ç…§ã€‚</p><h4 id="cookie-cookies-values"><a class="anchorlink" href="#cookie-cookies-values">5.2 ç°½åæˆ–åŠ å¯† cookie ä¸­çš„åˆ°æœŸç¾åœ¨åµŒå…¥åœ¨ cookies values ä¸­</a></h4><p>ç‚ºäº†æé«˜å®‰å…¨æ€§ï¼ŒRails ç¾åœ¨ä¹Ÿå°‡åˆ°æœŸè³‡è¨ŠåµŒå…¥åˆ°åŠ å¯†æˆ–ç°½åçš„ cookies value ä¸­ã€‚</p><p>é€™å€‹æ–°çš„åµŒå…¥è³‡è¨Šä½¿é‚£äº› cookies èˆ‡æ—©æ–¼ 5.2 çš„ Rails ç‰ˆæœ¬ä¸ç›¸å®¹ã€‚</p><p>å¦‚æœæ‚¨éœ€è¦ 5.1 åŠæ›´æ—©ç‰ˆæœ¬è®€å– cookiesï¼Œæˆ–è€…æ‚¨ä»åœ¨é©—è­‰ 5.2 éƒ¨ç½²ä¸¦å¸Œæœ›
å…è¨±æ‚¨å›æ»¾è¨­å®š
<code>Rails.application.config.action_dispatch.use_authenticated_cookie_encryption</code> åˆ° <code>false</code>ã€‚</p><h3 id="rails-5-0-rails-5-1"><a class="anchorlink" href="#rails-5-0-rails-5-1">6 å¾ Rails 5.0 å‡ç´šåˆ° Rails 5.1</a></h3><p>æœ‰é—œå° Rails 5.1 æ‰€åšæ›´æ”¹çš„æ›´å¤šè³‡è¨Šï¼Œè«‹åƒé–± <a href="5_1_release_notes.html">ç™¼è¡Œèªªæ˜</a>ã€‚</p><h4 id="hashwithindifferentaccess"><a class="anchorlink" href="#hashwithindifferentaccess">6.1 é ‚ç´š <code>HashWithIndifferentAccess</code> å·²è»Ÿæ£„ç”¨</a></h4><p>å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨é ‚ç´š <code>HashWithIndifferentAccess</code> é¡ï¼Œæ‚¨
æ‡‰è©²æ…¢æ…¢ç§»å‹•ä½ çš„ç¨‹å¼ç¢¼ä¾†ä»£æ›¿ä½¿ç”¨ <code>ActiveSupport::HashWithIndifferentAccess</code>ã€‚</p><p>å®ƒåªæ˜¯è»Ÿæ£„ç”¨ï¼Œé€™æ„å‘³è‘—æ‚¨çš„ç¨‹å¼ç¢¼ä¸æœƒåœ¨
æ™‚åˆ»ï¼Œä¸æœƒé¡¯ç¤ºæ£„ç”¨è­¦å‘Šï¼Œä½†é€™å€‹å¸¸é‡å°‡æ˜¯
å°‡ä¾†åˆªé™¤ã€‚</p><p>æ­¤å¤–ï¼Œå¦‚æœæ‚¨æœ‰åŒ…å«æ­¤é¡ç‰©ä»¶è½‰å„²çš„éå¸¸èˆŠçš„ YAML æ–‡ä»¶ï¼Œ
æ‚¨å¯èƒ½éœ€è¦å†æ¬¡è¼‰å…¥å’Œè½‰å„²å®ƒå€‘ä»¥ç¢ºä¿å®ƒå€‘å¼•ç”¨
æ­£ç¢ºçš„å¸¸é‡ï¼Œä¸¦ä¸”è¼‰å…¥å®ƒå€‘å°‡ä¾†ä¸æœƒä¸­æ–·ã€‚</p><h4 id="application-secrets-keys-symbols"><a class="anchorlink" href="#application-secrets-keys-symbols">6.2 <code>application.secrets</code> ç¾åœ¨è¼‰å…¥äº†æ‰€æœ‰ keys ä½œç‚º symbols</a></h4><p>å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼å°‡å·¢ç‹€è¨­å®šå„²å­˜åœ¨ <code>config/secrets.yml</code> ä¸­ï¼Œå‰‡æ‰€æœ‰ keys
ç¾åœ¨è¼‰å…¥ç‚º symbolsï¼Œå› æ­¤æ‡‰è©²æ›´æ”¹ä½¿ç”¨å­—ä¸²çš„è¨ªå•ã€‚</p><p>å¾ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">[</span><span class="ss">:smtp_settings</span><span class="p">][</span><span class="s2">"address"</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Rails.application.secrets[:smtp_settings]["address"]
'>Copy</button>
</div>
<p>åˆ°ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">[</span><span class="ss">:smtp_settings</span><span class="p">][</span><span class="ss">:address</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.secrets[:smtp_settings][:address]
">Copy</button>
</div>
<h4 id="render-text-nothing"><a class="anchorlink" href="#render-text-nothing">6.3 åœ¨ <code>render</code> ä¸­åˆªé™¤äº†å° <code>:text</code> å’Œ <code>:nothing</code> çš„æ£„ç”¨æ”¯æ´</a></h4><p>å¦‚æœæ‚¨çš„ controllers æ­£åœ¨ä½¿ç”¨ <code>render :text</code>ï¼Œå®ƒå€‘å°‡ä¸å†èµ·ä½œç”¨ã€‚æ–°æ–¹æ³•
ä½¿ç”¨ <code>text/plain</code> çš„ MIME å‹åˆ¥æ¸²æŸ“æ–‡å­—çš„æ–¹æ³•æ˜¯ä½¿ç”¨ <code>render :plain</code>ã€‚</p><p>åŒæ¨£ï¼Œ<code>render :nothing</code> ä¹Ÿè¢«åˆªé™¤ï¼Œä½ æ‡‰è©²ä½¿ç”¨ <code>head</code> æ–¹æ³•
å‚³é€åƒ…åŒ…å«æ¨™é ­çš„å›æ‡‰ã€‚ä¾‹å¦‚ï¼Œ<code>head :ok</code> å‚³é€ä¸€å€‹
200 å›æ‡‰ï¼Œæ²’æœ‰è¦å‘ˆç¾çš„æ­£æ–‡ã€‚</p><h4 id="redirect-to-back"><a class="anchorlink" href="#redirect-to-back">6.4 ç§»é™¤äº†å° <code>redirect_to :back</code> çš„æ£„ç”¨æ”¯æ´</a></h4><p>åœ¨ Rails 5.0 ä¸­ï¼Œä¸æ¨è–¦ä½¿ç”¨ <code>redirect_to :back</code>ã€‚åœ¨ Rails 5.1 ä¸­ï¼Œå®ƒè¢«å®Œå…¨åˆªé™¤ã€‚</p><p>ä½œç‚ºæ›¿ä»£ï¼Œä½¿ç”¨ <code>redirect_back</code>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ <code>redirect_back</code> ä¹Ÿéœ€è¦
ä¸€å€‹ <code>fallback_location</code> é¸é …ï¼Œå°‡åœ¨ <code>HTTP_REFERER</code> ç¼ºå¤±çš„æƒ…æ³ä¸‹ä½¿ç”¨ã€‚</p><div class="code_container">
<pre><code class="highlight plaintext">redirect_back(fallback_location: root_path)
</code></pre>
<button class="clipboard-button" data-clipboard-text="redirect_back(fallback_location: root_path)
">Copy</button>
</div>
<h3 id="rails-4-2-rails-5-0"><a class="anchorlink" href="#rails-4-2-rails-5-0">7 å¾ Rails 4.2 å‡ç´šåˆ° Rails 5.0</a></h3><p>æœ‰é—œå° Rails 5.0 æ‰€åšæ›´æ”¹çš„æ›´å¤šè³‡è¨Šï¼Œè«‹åƒé–± <a href="5_0_release_notes.html">ç™¼è¡Œèªªæ˜</a>ã€‚</p><h4 id="ruby-2-2-2"><a class="anchorlink" href="#ruby-2-2-2">7.1 Ruby 2.2.2+ éœ€è¦</a></h4><p>å¾ Ruby åˆ° Rails 5.0 ä»¥å¾Œï¼ŒRuby 2.2.2+ æ˜¯å”¯ä¸€æ”¯æ´çš„ Ruby ç‰ˆæœ¬ã€‚
åœ¨ç¹¼çºŒä¹‹å‰ï¼Œè«‹ç¢ºä¿æ‚¨ä½¿ç”¨çš„æ˜¯ Ruby 2.2.2 ç‰ˆæœ¬æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</p><h4 id="active-record-models-applicationrecord"><a class="anchorlink" href="#active-record-models-applicationrecord">7.2 Active Record Models ç¾åœ¨é è¨­ç¹¼æ‰¿è‡ª ApplicationRecord</a></h4><p>åœ¨ Rails 4.2 ä¸­ï¼Œä¸€å€‹ Active Record model ç¹¼æ‰¿è‡ª <code>ActiveRecord::Base</code>ã€‚åœ¨ Rails 5.0 ä¸­ï¼Œ
æ‰€æœ‰çš„ models éƒ½ç¹¼æ‰¿è‡ª <code>ApplicationRecord</code>ã€‚</p><p><code>ApplicationRecord</code> æ˜¯æ‰€æœ‰ app models çš„æ–°è¶…é¡ï¼Œé¡ä¼¼æ–¼ app
controllers å­é¡åŒ– <code>ApplicationController</code> è€Œä¸æ˜¯
<code>ActionController::Base</code>ã€‚é€™ç‚ºæ‡‰ç”¨ç¨‹å¼æä¾›äº†ä¸€å€‹è¨­å®šæ‡‰ç”¨ç¨‹å¼ç¯„åœçš„å–®ä¸€ä½ç½®
model è¡Œç‚ºã€‚</p><p>å¾Rails 4.2å‡ç´šåˆ°Rails 5.0æ™‚ï¼Œéœ€è¦å»ºç«‹ä¸€å€‹
åœ¨ <code>app/models/</code> ä¸­çš„ <code>application_record.rb</code> æª”æ¡ˆä¸¦æ–°å¢ä»¥ä¸‹å…§å®¹ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ApplicationRecord &lt; ActiveRecord::Base
  self.abstract_class = true
end
">Copy</button>
</div>
<p>ç„¶å¾Œç¢ºä¿æ‚¨æ‰€æœ‰çš„ models éƒ½ç¹¼æ‰¿è‡ªå®ƒã€‚</p><h4 id="throw-abort-callback"><a class="anchorlink" href="#throw-abort-callback">7.3 é€šé <code>throw(:abort)</code> åœæ­¢ Callback éˆ</a></h4><p>åœ¨ Rails 4.2 ä¸­ï¼Œç•¶â€œä¹‹å‰â€ callback åœ¨ Active Record ä¸­è¿”å› <code>false</code> æ™‚
å’Œ Active Modelï¼Œé‚£éº¼æ•´å€‹ callback éˆå°±åœæ­¢äº†ã€‚æ›å¥è©±èªªï¼Œ
é€£çºŒçš„â€œä¹‹å‰â€ callbacks ä¸æœƒè¢«åŸ·è¡Œï¼Œä¸¦ä¸” action ä¹Ÿä¸æœƒè¢«åŒ…è£
åœ¨ callbacksã€‚</p><p>åœ¨ Rails 5.0 ä¸­ï¼Œåœ¨ Active Record æˆ– Active Model callback ä¸­è¿”å› <code>false</code>
ä¸æœƒæœ‰åœæ­¢ callback éˆçš„å‰¯ä½œç”¨ã€‚ç›¸åï¼Œcallback
éˆå¿…é ˆé€šéå‘¼å« <code>throw(:abort)</code> é¡¯å¼åœæ­¢ã€‚</p><p>ç•¶æ‚¨å¾ Rails 4.2 å‡ç´šåˆ° Rails 5.0 æ™‚ï¼Œè¿”å› <code>false</code> çš„é‚£ç¨®
callbacks ä»å°‡åœæ­¢å›å‘¼éˆï¼Œä½†æ‚¨å°‡æ”¶åˆ°æ£„ç”¨
è­¦å‘Šå³å°‡ç™¼ç”Ÿçš„è®ŠåŒ–ã€‚</p><p>æº–å‚™å¥½å¾Œï¼Œæ‚¨å¯ä»¥é¸æ“‡åŠ å…¥æ–°è¡Œç‚ºä¸¦åˆªé™¤æ£„ç”¨
é€šéå°‡ä»¥ä¸‹è¨­å®šæ–°å¢åˆ°æ‚¨çš„ <code>config/application.rb</code> ä¾†è­¦å‘Šï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">halt_callback_chains_on_return_false</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="ActiveSupport.halt_callback_chains_on_return_false = false
">Copy</button>
</div>
<p>è«‹æ³¨æ„ï¼Œæ­¤é¸é …ä¸æœƒå½±éŸ¿ Active Support callbacks å› ç‚ºå®ƒå€‘å¾ä¸
ç•¶è¿”å›ä»»ä½• value æ™‚åœæ­¢éˆã€‚</p><p>æœ‰é—œæ›´å¤šè©³ç´°è³‡è¨Šï¼Œè«‹åƒé–± <a href="https://github.com/rails/rails/pull/17227">#17227</a>ã€‚</p><h4 id="activejob-applicationjob"><a class="anchorlink" href="#activejob-applicationjob">7.4 ActiveJob ç¾åœ¨é è¨­ç¹¼æ‰¿è‡ª ApplicationJob</a></h4><p>åœ¨ Rails 4.2 ä¸­ï¼Œä¸€å€‹ Active Job ç¹¼æ‰¿è‡ª <code>ActiveJob::Base</code>ã€‚åœ¨ Rails 5.0 ä¸­ï¼Œé€™å€‹
è¡Œç‚ºå·²æ›´æ”¹ç‚ºç¾åœ¨å¾ <code>ApplicationJob</code> ç¹¼æ‰¿ã€‚</p><p>å¾Rails 4.2å‡ç´šåˆ°Rails 5.0æ™‚ï¼Œéœ€è¦å»ºç«‹ä¸€å€‹
åœ¨ <code>app/jobs/</code> ä¸­çš„ <code>application_job.rb</code> æª”æ¡ˆä¸¦æ–°å¢ä»¥ä¸‹å…§å®¹ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ApplicationJob &lt; ActiveJob::Base
end
">Copy</button>
</div>
<p>ç„¶å¾Œç¢ºä¿æ‚¨çš„æ‰€æœ‰ä½œæ¥­é¡éƒ½ç¹¼æ‰¿è‡ªå®ƒã€‚</p><p>æœ‰é—œæ›´å¤šè©³ç´°è³‡è¨Šï¼Œè«‹åƒé–± <a href="https://github.com/rails/rails/pull/19034">#19034</a>ã€‚</p><h4 id="rails-controller"><a class="anchorlink" href="#rails-controller">7.5 Rails Controller æ¸¬è©¦</a></h4><h5 id="helper-extraction-rails-controller-testing"><a class="anchorlink" href="#helper-extraction-rails-controller-testing">7.5.1 ä¸€äº› helper æ–¹æ³•çš„ Extraction åˆ° <code>rails-controller-testing</code></a></h5><p><code>assigns</code> å’Œ <code>assert_template</code> å·²è¢«æå–åˆ° <code>rails-controller-testing</code> gemã€‚åˆ°
ç¹¼çºŒåœ¨ controller æ¸¬è©¦ä¸­ä½¿ç”¨é€™äº›æ–¹æ³•ï¼Œå°‡ <code>gem 'rails-controller-testing'</code> æ–°å¢åˆ°
æ‚¨çš„ <code>Gemfile</code>ã€‚</p><p>å¦‚æœæ‚¨ä½¿ç”¨ RSpec é€²è¡Œæ¸¬è©¦ï¼Œè«‹åƒé–± gem ä¸­æ‰€éœ€çš„é¡å¤–è¨­å®š
æ–‡ä»¶ã€‚</p><h5 id=""><a class="anchorlink" href="#">7.5.2 ä¸Šå‚³æª”æ¡ˆæ™‚çš„æ–°è¡Œç‚º</a></h5><p>å¦‚æœæ‚¨åœ¨æ¸¬è©¦ä¸­ä½¿ç”¨ <code>ActionDispatch::Http::UploadedFile</code>
ä¸Šå‚³æª”æ¡ˆï¼Œä½ éœ€è¦æ”¹ç”¨é¡ä¼¼çš„<code>Rack::Test::UploadedFile</code>
é¡ä»£æ›¿ã€‚</p><p>æœ‰é—œæ›´å¤šè©³ç´°è³‡è¨Šï¼Œè«‹åƒé–± <a href="https://github.com/rails/rails/issues/26404">#26404</a>ã€‚</p><h4 id=""><a class="anchorlink" href="#">7.6 ç”Ÿç”¢ç’°å¢ƒå•Ÿå‹•å¾Œè‡ªå‹•è¼‰å…¥é—œé–‰</a></h4><p>ç¾åœ¨é€šéä»¥ä¸‹æ–¹å¼åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­å•Ÿå‹•å¾Œç¦ç”¨è‡ªå‹•è¼‰å…¥
é è¨­ã€‚</p><p>ç†±åˆ‡è¼‰å…¥æ‡‰ç”¨ç¨‹å¼æ˜¯å•Ÿå‹•éç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤é ‚ç´š
å¸¸é‡å¾ˆå¥½ä¸¦ä¸”ä»ç„¶æœƒè‡ªå‹•è¼‰å…¥ï¼Œä¸éœ€è¦éœ€è¦å®ƒå€‘çš„æª”æ¡ˆã€‚</p><p>æ›´æ·±çš„åœ°æ–¹çš„å¸¸é‡åªåœ¨åŸ·è¡Œæ™‚åŸ·è¡Œï¼Œæ¯”å¦‚æ­£å¸¸æ–¹æ³•é«”ï¼Œ
ä¹Ÿå¾ˆå¥½ï¼Œå› ç‚ºå®šç¾©å®ƒå€‘çš„æª”æ¡ˆå°‡åœ¨å•Ÿå‹•æ™‚é å…ˆè¼‰å…¥ã€‚</p><p>å°æ–¼çµ•å¤§å¤šæ•¸æ‡‰ç”¨ç¨‹å¼ï¼Œæ­¤æ›´æ”¹ä¸éœ€è¦ actionã€‚ä½†åœ¨
æ‚¨çš„æ‡‰ç”¨ç¨‹å¼åœ¨åŸ·è¡Œæ™‚éœ€è¦è‡ªå‹•è¼‰å…¥çš„éå¸¸ç½•è¦‹çš„äº‹ä»¶
ç”Ÿç”¢ï¼Œå°‡ <code>Rails.application.config.enable_dependency_loading</code> è¨­å®šç‚º trueã€‚</p><h4 id="xml"><a class="anchorlink" href="#xml">7.7 XML åºåˆ—åŒ–</a></h4><p><code>ActiveModel::Serializers::Xml</code> å·²ç¶“å¾ Rails æå–åˆ° <code>activemodel-serializers-xml</code>
å¯¶çŸ³ã€‚è¦ç¹¼çºŒåœ¨æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä¸­ä½¿ç”¨ XML åºåˆ—åŒ–ï¼Œè«‹æ–°å¢ <code>gem 'activemodel-serializers-xml'</code>
åˆ°æ‚¨çš„ <code>Gemfile</code>ã€‚</p><h4 id="mysql"><a class="anchorlink" href="#mysql">7.8 åˆªé™¤äº†å°èˆŠç‰ˆ <code>mysql</code> è³‡æ–™åº«ä»‹é¢å¡çš„æ”¯æ´</a></h4><p>Rails 5 åˆªé™¤äº†å°èˆŠç‰ˆ <code>mysql</code> è³‡æ–™åº«ä»‹é¢å¡çš„æ”¯æ´ã€‚å¤§å¤šæ•¸ä½¿ç”¨è€…æ‡‰è©²èƒ½å¤ 
ä½¿ç”¨ <code>mysql2</code> ä»£æ›¿ã€‚æ‰¾äººç¶­è­·æ™‚æœƒè½‰æˆå–®ç¨çš„gem
å®ƒã€‚</p><h4 id=""><a class="anchorlink" href="#">7.9 åˆªé™¤äº†å°åµéŒ¯ç¨‹å¼çš„æ”¯æ´</a></h4><p>Ruby 2.2 ä¸æ”¯æ´ <code>debugger</code>ï¼Œè€Œ Rails éœ€è¦ Rails 5ã€‚è«‹æ”¹ç”¨ <code>byebug</code>ã€‚</p><h4 id="bin-rails"><a class="anchorlink" href="#bin-rails">7.10 ä½¿ç”¨ <code>bin/rails</code> ä¾†åŸ·è¡Œä»»å‹™å’Œæ¸¬è©¦</a></h4><p>Rails 5 å¢åŠ äº†é€šé <code>bin/rails</code> è€Œä¸æ˜¯ rake åŸ·è¡Œä»»å‹™å’Œæ¸¬è©¦çš„èƒ½åŠ›ã€‚ä¸€èˆ¬ä¾†èªª
é€™äº›è®ŠåŒ–èˆ‡ rake ä¸¦è¡Œï¼Œä½†æœ‰äº›è¢«å®Œå…¨ç§»æ¤ã€‚</p><p>è¦ä½¿ç”¨æ–°çš„æ¸¬è©¦åŸ·è¡Œå™¨ï¼Œåªéœ€è¼¸å…¥ <code>bin/rails test</code>ã€‚</p><p><code>rake dev:cache</code> ç¾åœ¨æ˜¯ <code>bin/rails dev:cache</code>ã€‚</p><p>åœ¨æ‡‰ç”¨ç¨‹å¼çš„æ ¹ç›®éŒ„ä¸­åŸ·è¡Œ <code>bin/rails</code> ä»¥æª¢è¦–å¯ç”¨å‘½ä»¤åˆ—è¡¨ã€‚</p><h4 id="actioncontroller-parameters-hashwithindifferentaccess"><a class="anchorlink" href="#actioncontroller-parameters-hashwithindifferentaccess">7.11 <code>ActionController::Parameters</code> ä¸å†ç¹¼æ‰¿ <code>HashWithIndifferentAccess</code></a></h4><p>åœ¨æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä¸­å‘¼å« <code>params</code> ç¾åœ¨å°‡è¿”å›ä¸€å€‹ç‰©ä»¶è€Œä¸æ˜¯é›œæ¹Šã€‚å¦‚æœä½ çš„
å¼•æ•¸å·²ç¶“è¢«å…è¨±ï¼Œé‚£éº¼æ‚¨å°‡ä¸éœ€è¦é€²è¡Œä»»ä½•æ›´æ”¹ã€‚å¦‚æœæ‚¨ä½¿ç”¨ <code>map</code>
ä»¥åŠå…¶ä»–ä¾è³´æ–¼èƒ½å¤ è®€å–é›œæ¹Šçš„æ–¹æ³•ï¼Œè€Œä¸ç®¡ <code>permitted?</code> ä½ æœƒ
éœ€è¦å‡ç´šæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä»¥é¦–å…ˆå…è¨±ç„¶å¾Œè½‰æ›ç‚ºé›œæ¹Šã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">([</span><span class="ss">:proceed_to</span><span class="p">,</span> <span class="ss">:return_to</span><span class="p">]).</span><span class="nf">to_h</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="params.permit([:proceed_to, :return_to]).to_h
">Copy</button>
</div>
<h4 id="protect-from-forgery-prepend-false"><a class="anchorlink" href="#protect-from-forgery-prepend-false">7.12 <code>protect_from_forgery</code> ç¾åœ¨é è¨­ç‚º <code>prepend: false</code></a></h4><p><code>protect_from_forgery</code> é è¨­ç‚º <code>prepend: false</code> é€™æ„å‘³è‘—å®ƒå°‡è¢«æ’å…¥åˆ°
callback éˆåœ¨æ‚¨åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­å‘¼å«å®ƒçš„é»ã€‚å¦‚æœä½ æƒ³
<code>protect_from_forgery</code> å§‹çµ‚é¦–å…ˆåŸ·è¡Œï¼Œç„¶å¾Œæ‚¨æ‡‰è©²æ›´æ”¹æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä»¥ä½¿ç”¨
<code>protect_from_forgery prepend: true</code>ã€‚</p><h4 id="raw"><a class="anchorlink" href="#raw">7.13 é è¨­æ¨¡æ¿è™•ç†ç¨‹å¼ç¾åœ¨æ˜¯ RAW</a></h4><p>æ“´å……å¥—ä»¶ä¸­æ²’æœ‰æ¨¡æ¿è™•ç†ç¨‹å¼çš„æª”æ¡ˆå°‡ä½¿ç”¨åŸå§‹è™•ç†ç¨‹å¼å‘ˆç¾ã€‚
ä»¥å‰ Rails å°‡ä½¿ç”¨ ERB æ¨¡æ¿è™•ç†ç¨‹å¼å‘ˆç¾æª”æ¡ˆã€‚</p><p>å¦‚æœæ‚¨ä¸å¸Œæœ›é€šéåŸå§‹è™•ç†ç¨‹å¼è™•ç†æ‚¨çš„æª”æ¡ˆï¼Œæ‚¨æ‡‰è©²æ–°å¢ä¸€å€‹å‰¯æª”å
åˆ°å¯ä»¥ç”±é©ç•¶çš„æ¨¡æ¿è™•ç†ç¨‹å¼è§£æçš„æª”æ¡ˆã€‚</p><h4 id=""><a class="anchorlink" href="#">7.14 æ·»åŠ äº†æ¨¡æ¿ä¾è³´çš„è¬ç”¨å­—å…ƒåŒ¹é…</a></h4><p>æ‚¨ç¾åœ¨å¯ä»¥å°æ¨¡æ¿ä¾è³´é …ä½¿ç”¨è¬ç”¨å­—å…ƒåŒ¹é…ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æ˜¯
åƒé€™æ¨£å®šç¾©ä½ çš„æ¨¡æ¿ï¼š</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/subscribers_changed </span><span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/completed </span><span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/uncompleted </span><span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;% # Template Dependency: recordings/threads/events/subscribers_changed %&gt;
&lt;% # Template Dependency: recordings/threads/events/completed %&gt;
&lt;% # Template Dependency: recordings/threads/events/uncompleted %&gt;
">Copy</button>
</div>
<p>æ‚¨ç¾åœ¨å¯ä»¥ä½¿ç”¨è¬ç”¨å­—å…ƒå‘¼å«ä¾è³´é …ä¸€æ¬¡ã€‚</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/* </span><span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;% # Template Dependency: recordings/threads/events/* %&gt;
">Copy</button>
</div>
<h4 id="actionview-helpers-recordtaghelper-gem-record-tag-helper"><a class="anchorlink" href="#actionview-helpers-recordtaghelper-gem-record-tag-helper">7.15 <code>ActionView::Helpers::RecordTagHelper</code> ç§»å‹•åˆ°å¤–éƒ¨ gem (record_tag_helper)</a></h4><p><code>content_tag_for</code> å’Œ <code>div_for</code> å·²è¢«åˆªé™¤ï¼Œä»¥æ”¯æ´åƒ…ä½¿ç”¨ <code>content_tag</code>ã€‚è¦ç¹¼çºŒä½¿ç”¨èˆŠæ–¹æ³•ï¼Œè«‹å°‡ <code>record_tag_helper</code> gem æ–°å¢åˆ°æ‚¨çš„ <code>Gemfile</code>ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'record_tag_helper'</span><span class="p">,</span> <span class="s1">'~&gt; 1.0'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="gem 'record_tag_helper', '~&gt; 1.0'
">Copy</button>
</div>
<p>æœ‰é—œæ›´å¤šè©³ç´°è³‡è¨Šï¼Œè«‹åƒé–± <a href="https://github.com/rails/rails/pull/18411">#18411</a>ã€‚</p><h4 id="protected-attributes-gem"><a class="anchorlink" href="#protected-attributes-gem">7.16 ç§»é™¤äº†å° <code>protected_attributes</code> Gem çš„æ”¯æ´</a></h4><p>Rails 5 ä¸å†æ”¯æ´ <code>protected_attributes</code> gemã€‚</p><h4 id="activerecord-deprecated-finders-gem"><a class="anchorlink" href="#activerecord-deprecated-finders-gem">7.17 åˆªé™¤äº†å° <code>activerecord-deprecated_finders</code> gem çš„æ”¯æ´</a></h4><p>Rails 5 ä¸å†æ”¯æ´ <code>activerecord-deprecated_finders</code> gemã€‚</p><h4 id="activesupport-testcase"><a class="anchorlink" href="#activesupport-testcase">7.18 <code>ActiveSupport::TestCase</code> é è¨­æ¸¬è©¦è¨‚å–®ç¾åœ¨æ˜¯éš¨æ©Ÿçš„</a></h4><p>åœ¨æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä¸­åŸ·è¡Œæ¸¬è©¦æ™‚ï¼Œé è¨­é †åºç¾åœ¨æ˜¯ <code>:random</code>
è€Œä¸æ˜¯ <code>:sorted</code>ã€‚ä½¿ç”¨ä»¥ä¸‹è¨­å®šé¸é …å°‡å…¶è¨­å®šå› <code>:sorted</code>ã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># è¨­å®š/ç’°å¢ƒ/test.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">test_order</span> <span class="o">=</span> <span class="ss">:sorted</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# è¨­å®š/ç’°å¢ƒ/test.rb
Rails.application.configure do
  config.active_support.test_order = :sorted
end
">Copy</button>
</div>
<h4 id="actioncontroller-live-concern"><a class="anchorlink" href="#actioncontroller-live-concern">7.19 <code>ActionController::Live</code> è®Šæˆäº† <code>Concern</code></a></h4><p>å¦‚æœæ‚¨åœ¨ controller ä¸­åŒ…å«çš„å¦ä¸€å€‹ module ä¸­åŒ…å« <code>ActionController::Live</code>ï¼Œé‚£éº¼æ‚¨
é‚„æ‡‰è©²ä½¿ç”¨ <code>ActiveSupport::Concern</code> æ“´å……å¥—ä»¶ moduleã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <code>self.included</code> æ›è¼‰æ©Ÿåˆ¶
ä¸€æ—¦åŒ…å« <code>StreamingSupport</code>ï¼Œå°‡ <code>ActionController::Live</code> ç›´æ¥åŒ…å«åˆ° controller ä¸­ã€‚</p><p>é€™æ„å‘³è‘—å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼æ›¾ç¶“æœ‰è‡ªå·±çš„æµåª’é«” moduleï¼Œå‰‡ä»¥ä¸‹ç¨‹å¼ç¢¼
æœƒåœ¨ç”Ÿç”¢ä¸­ä¸­æ–·ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># é€™æ˜¯æµå¼ controllers ä½¿ç”¨ Warden/Devise åŸ·è¡Œèº«ä»½é©—è­‰çš„è®Šé€šæ–¹æ³•ã€‚</span>
<span class="c1"># è¦‹ https://github.com/plataformatec/devise/issues/2332</span>
<span class="c1"># åœ¨è·¯ç”±å™¨ä¸­é€²è¡Œèº«ä»½é©—è­‰æ˜¯è©²å•é¡Œä¸­å»ºè­°çš„å¦ä¸€ç¨®è§£æ±ºæ–¹æ¡ˆ</span>
<span class="k">class</span> <span class="nc">StreamingSupport</span>
  <span class="kp">include</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Live</span> <span class="c1"># this won't work in production for Rails 5</span>
  <span class="c1"># extend ActiveSupport::Concern # unless you uncomment this line.</span>

  <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="k">super</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">ArgumentError</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span> <span class="o">==</span> <span class="s1">'uncaught throw :warden'</span>
      <span class="kp">throw</span> <span class="ss">:warden</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="n">e</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# é€™æ˜¯æµå¼ controllers ä½¿ç”¨ Warden/Devise åŸ·è¡Œèº«ä»½é©—è­‰çš„è®Šé€šæ–¹æ³•ã€‚
# è¦‹ https://github.com/plataformatec/devise/issues/2332
# åœ¨è·¯ç”±å™¨ä¸­é€²è¡Œèº«ä»½é©—è­‰æ˜¯è©²å•é¡Œä¸­å»ºè­°çš„å¦ä¸€ç¨®è§£æ±ºæ–¹æ¡ˆ
class StreamingSupport
  include ActionController::Live # this won't work in production for Rails 5
  # extend ActiveSupport::Concern # unless you uncomment this line.

  def process(name)
    super(name)
  rescue ArgumentError =&gt; e
    if e.message == 'uncaught throw :warden'
      throw :warden
    else
      raise e
    end
  end
end
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">7.20 æ–°æ¡†æ¶é è¨­å€¼</a></h4><h5 id="active-record-belongs-to"><a class="anchorlink" href="#active-record-belongs-to">7.20.1 Active Record <code>belongs_to</code> é è¨­é¸é …éœ€è¦</a></h5><p>å¦‚æœ association ä¸å­˜åœ¨ï¼Œå‰‡ <code>belongs_to</code> ç¾åœ¨é è¨­æœƒè§¸ç™¼é©—è­‰éŒ¯èª¤ã€‚</p><p>é€™å¯ä»¥é€šé <code>optional: true</code> é—œé–‰ per-associationã€‚</p><p>æ­¤é è¨­å€¼å°‡åœ¨æ–°æ‡‰ç”¨ç¨‹å¼ä¸­è‡ªå‹•è¨­å®šã€‚å¦‚æœç¾æœ‰æ‡‰ç”¨
è¦æ–°å¢æ­¤åŠŸèƒ½ï¼Œéœ€è¦åœ¨åˆå§‹åŒ–ç¨‹å¼ä¸­é–‹å•Ÿå®ƒï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.active_record.belongs_to_required_by_default = true
">Copy</button>
</div>
<p>é è¨­æƒ…æ³ä¸‹ï¼Œæ‚¨çš„æ‰€æœ‰ models çš„è¨­å®šéƒ½æ˜¯å…¨åŸŸæ€§çš„ï¼Œä½†æ‚¨å¯ä»¥
åœ¨æ¯å€‹æ¨¡å‹çš„åŸºç¤ä¸Šè¦†è“‹å®ƒã€‚é€™æ‡‰è©²å¯ä»¥å¹«åŠ©æ‚¨é·ç§»æ‰€æœ‰ models ä»¥æ“æœ‰å®ƒå€‘
associations é è¨­éœ€è¦ã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># model is not yet ready to have its association required by default</span>

  <span class="nb">self</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="n">belongs_to</span><span class="p">(</span><span class="ss">:author</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># model is ready to have its association required by default</span>

  <span class="nb">self</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">belongs_to</span><span class="p">(</span><span class="ss">:pilot</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  # model is not yet ready to have its association required by default

  self.belongs_to_required_by_default = false
  belongs_to(:author)
end

class Car &lt; ApplicationRecord
  # model is ready to have its association required by default

  self.belongs_to_required_by_default = true
  belongs_to(:pilot)
end
">Copy</button>
</div>
<h5 id="csrf-tokens"><a class="anchorlink" href="#csrf-tokens">7.20.2 åŸ·è¡Œè¡¨å–® CSRF Tokens</a></h5><p>Rails 5 ç¾åœ¨æ”¯æ´ per-form CSRF tokens ä»¥æ¸›è¼•ä½¿ç”¨è¡¨å–®çš„ç¨‹å¼ç¢¼æ³¨å…¥æ”»æ“Š
ç”± JavaScript å»ºç«‹ã€‚å•Ÿç”¨æ­¤é¸é …å¾Œï¼Œæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä¸­çš„æ¯å€‹è¡¨å–®éƒ½æœƒæœ‰è‡ªå·±çš„
è‡ªå·±çš„ CSRF token ç‰¹å®šæ–¼ action å’Œè©²è¡¨å–®çš„æ–¹æ³•ã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">per_form_csrf_tokens</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.action_controller.per_form_csrf_tokens = true
">Copy</button>
</div>
<h5 id=""><a class="anchorlink" href="#">7.20.3 å¸¶æœ‰åŸç”¢åœ°æª¢æŸ¥çš„å½é€ ä¿è­·</a></h5><p>æ‚¨ç¾åœ¨å¯ä»¥è¨­å®šæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä»¥æª¢æŸ¥æ˜¯å¦æ‡‰æª¢æŸ¥ HTTP <code>Origin</code> æ¨™é ­
åå°ç«™é»çš„èµ·æºä½œç‚ºé¡å¤–çš„ CSRF é˜²ç¦¦ã€‚åœ¨æ‚¨çš„è¨­å®šä¸­è¨­å®šä»¥ä¸‹å…§å®¹
çœŸçš„ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">forgery_protection_origin_check</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.action_controller.forgery_protection_origin_check = true
">Copy</button>
</div>
<h5 id="action-mailer"><a class="anchorlink" href="#action-mailer">7.20.4 å…è¨±è¨­å®š Action Mailer ä½‡åˆ—åç¨±</a></h5><p>é è¨­çš„éƒµä»¶ä½‡åˆ—åç¨±æ˜¯ <code>mailers</code>ã€‚æ­¤è¨­å®šé¸é …å…è¨±æ‚¨å…¨åŸŸæ€§æ›´æ”¹
ä½‡åˆ—åç¨±ã€‚åœ¨æ‚¨çš„è¨­å®šä¸­è¨­å®šä»¥ä¸‹å…§å®¹ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">deliver_later_queue_name</span> <span class="o">=</span> <span class="ss">:new_queue_name</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.action_mailer.deliver_later_queue_name = :new_queue_name
">Copy</button>
</div>
<h5 id="action-mailer-views"><a class="anchorlink" href="#action-mailer-views">7.20.5 æ”¯æ´ Action Mailer ä¸­çš„ç‰‡æ®µå¿«å– Views</a></h5><p>åœ¨æ‚¨çš„è¨­å®šä¸­è¨­å®š <code>config.action_mailer.perform_caching</code> ä»¥ç¢ºå®šæ‚¨çš„ Action Mailer views
æ‡‰è©²æ”¯æ´å¿«å–ã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">perform_caching</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.action_mailer.perform_caching = true
">Copy</button>
</div>
<h5 id="db-structure-dump"><a class="anchorlink" href="#db-structure-dump">7.20.6 è¨­å®š<code>db:structure:dump</code>çš„è¼¸å‡º</a></h5><p>å¦‚æœæ‚¨ä½¿ç”¨ <code>schema_search_path</code> æˆ–å…¶ä»– PostgreSQL æ“´å……å¥—ä»¶ï¼Œæ‚¨å¯ä»¥æ§åˆ¶æ¶æ§‹çš„æ–¹å¼
å‚¾å€’ã€‚è¨­å®šç‚º <code>:all</code> ä»¥ç”¢ç”Ÿæ‰€æœ‰è½‰å„²ï¼Œæˆ–è¨­å®šç‚º <code>:schema_search_path</code> ä»¥å¾æ¨¡å¼æœå°‹è·¯å¾‘ç”¢ç”Ÿã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">dump_schemas</span> <span class="o">=</span> <span class="ss">:all</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.active_record.dump_schemas = :all
">Copy</button>
</div>
<h5 id="ssl-hsts"><a class="anchorlink" href="#ssl-hsts">7.20.7 è¨­å®š SSL é¸é …ä»¥å•Ÿç”¨å­åŸŸçš„ HSTS</a></h5><p>åœ¨æ‚¨çš„è¨­å®šä¸­è¨­å®šä»¥ä¸‹å…§å®¹ä»¥åœ¨ä½¿ç”¨å­åŸŸæ™‚å•Ÿç”¨ HSTSï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">ssl_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">hsts: </span><span class="p">{</span> <span class="ss">subdomains: </span><span class="kp">true</span> <span class="p">}</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.ssl_options = { hsts: { subdomains: true } }
">Copy</button>
</div>
<h5 id=""><a class="anchorlink" href="#">7.20.8 ä¿ç•™æ¥æ”¶è€…çš„æ™‚å€</a></h5><p>ä½¿ç”¨ Ruby 2.4 æ™‚ï¼Œå¯ä»¥åœ¨å‘¼å« <code>to_time</code> æ™‚ä¿ç•™æ¥æ”¶è€…çš„æ™‚å€ã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">to_time_preserves_timezone</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="ActiveSupport.to_time_preserves_timezone = false
">Copy</button>
</div>
<h4 id="json-jsonb"><a class="anchorlink" href="#json-jsonb">7.21 JSON/JSONB åºåˆ—åŒ–çš„è®ŠåŒ–</a></h4><p>åœ¨ Rails 5.0 ä¸­ï¼ŒJSON/JSONB å±¬æ€§çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹å¼ç™¼ç”Ÿäº†è®ŠåŒ–ã€‚ç¾åœ¨ï¼Œå¦‚æœ
æ‚¨è¨­å®šçš„åˆ—ç­‰æ–¼ <code>String</code>ï¼ŒActive Record å°‡ä¸å†è½‰å‹•è©²å­—ä¸²
é€²å…¥ <code>Hash</code>ï¼Œè€Œåªæœƒè¿”å›å­—ä¸²ã€‚é€™ä¸åƒ…é™æ–¼ç¨‹å¼ç¢¼
èˆ‡ models äº’å‹•ï¼Œä½†ä¹Ÿæœƒå½±éŸ¿ <code>db/schema.rb</code> ä¸­çš„ <code>:default</code> åˆ—è¨­å®šã€‚
å»ºè­°æ‚¨ä¸è¦å°‡åˆ—è¨­å®šç‚ºç­‰æ–¼ <code>String</code>ï¼Œè€Œæ˜¯å‚³éä¸€å€‹ <code>Hash</code>
ç›¸åï¼Œå®ƒå°‡è‡ªå‹•èˆ‡ JSON å­—ä¸²ç›¸äº’è½‰æ›ã€‚</p><h3 id="rails-4-1-rails-4-2"><a class="anchorlink" href="#rails-4-1-rails-4-2">8 å¾ Rails 4.1 å‡ç´šåˆ° Rails 4.2</a></h3><h4 id=""><a class="anchorlink" href="#">8.1 ç¶²è·¯æ§åˆ¶æª¯</a></h4><p>é¦–å…ˆï¼Œå°‡ <code>gem 'web-console', '~&gt; 2.0'</code> æ–°å¢åˆ° <code>Gemfile</code> ä¸­çš„ <code>:development</code> çµ„ä¸¦åŸ·è¡Œ <code>bundle install</code>ï¼ˆå‡ç´š Rails æ™‚ä¸æœƒåŒ…å«å®ƒï¼‰ã€‚å®‰è£å®Œæˆå¾Œï¼Œæ‚¨å¯ä»¥ç°¡å–®åœ°å°‡æ§åˆ¶æª¯ helperï¼ˆå³ <code>&lt;%= console %&gt;</code>ï¼‰çš„å¼•ç”¨æ”¾å…¥è¦å•Ÿç”¨å®ƒçš„ä»»ä½• view ä¸­ã€‚æ‚¨åœ¨é–‹ç™¼ç’°å¢ƒä¸­çš„ view çš„ä»»ä½•éŒ¯èª¤é é¢ä¸Šä¹Ÿæœƒæä¾›ä¸€å€‹æ§åˆ¶æª¯ã€‚</p><h4 id=""><a class="anchorlink" href="#">8.2 å›æ‡‰è€…</a></h4><p><code>respond_with</code> å’Œé¡ç´šåˆ¥çš„ <code>respond_to</code> æ–¹æ³•å·²æå–åˆ° <code>responders</code> gemã€‚è¦ä½¿ç”¨å®ƒå€‘ï¼Œåªéœ€å°‡ <code>gem 'responders', '~&gt; 2.0'</code> æ–°å¢åˆ°æ‚¨çš„ <code>Gemfile</code>ã€‚å¦‚æœä¸å°‡ <code>responders</code> gem åŒ…å«åœ¨æ‚¨çš„ä¾è³´é …ä¸­ï¼Œå‰‡å° <code>respond_with</code> å’Œ <code>respond_to</code> çš„å‘¼å«ï¼ˆå†æ¬¡åœ¨é¡ç´šåˆ¥ï¼‰å°‡ä¸å†èµ·ä½œç”¨ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/controllers/users_controller.rb</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:json</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/controllers/users_controller.rb

class UsersController &lt; ApplicationController
  respond_to :html, :json

  def show
    @user = User.find(params[:id])
    respond_with @user
  end
end
">Copy</button>
</div>
<p>å¯¦ä¾‹ç´š <code>respond_to</code> ä¸å—å½±éŸ¿ï¼Œä¸éœ€è¦é¡å¤–çš„ gemï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/controllers/users_controller.rb</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/controllers/users_controller.rb

class UsersController &lt; ApplicationController
  def show
    @user = User.find(params[:id])
    respond_to do |format|
      format.html
      format.json { render json: @user }
    end
  end
end
">Copy</button>
</div>
<p>æœ‰é—œæ›´å¤šè©³ç´°è³‡è¨Šï¼Œè«‹åƒé–± <a href="https://github.com/rails/rails/pull/16526">#16526</a>ã€‚</p><h4 id="transaction-callbacks"><a class="anchorlink" href="#transaction-callbacks">8.3 transaction ä¸­çš„éŒ¯èª¤è™•ç† callbacks</a></h4><p>ç›®å‰ï¼ŒActive Record æŠ‘åˆ¶å¼•ç™¼çš„éŒ¯èª¤
åœ¨ <code>after_rollback</code> æˆ– <code>after_commit</code> callbacks å…§ï¼Œåªå°‡å®ƒå€‘åˆ—å°åˆ°
æ—¥èªŒã€‚åœ¨ä¸‹ä¸€å€‹ç‰ˆæœ¬ä¸­ï¼Œé€™äº›éŒ¯èª¤å°‡ä¸å†è¢«æŠ‘åˆ¶ã€‚
ç›¸åï¼ŒéŒ¯èª¤æœƒåƒå…¶ä»– Active ä¸€æ¨£æ­£å¸¸å‚³æ’­
è¨˜éŒ„ callbacksã€‚</p><p>ç•¶æ‚¨å®šç¾© <code>after_rollback</code> æˆ– <code>after_commit</code> callback æ™‚ï¼Œæ‚¨
å°‡æ”¶åˆ°æœ‰é—œæ­¤å³å°‡ç™¼ç”Ÿçš„æ›´æ”¹çš„æ£„ç”¨è­¦å‘Šã€‚ä»€éº¼æ™‚å€™
ä½ æº–å‚™å¥½äº†ï¼Œä½ å¯ä»¥é¸æ“‡åŠ å…¥æ–°çš„è¡Œç‚ºä¸¦åˆªé™¤
é€šéå°‡ä»¥ä¸‹è¨­å®šæ–°å¢åˆ°æ‚¨çš„
<code>config/application.rb</code>ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">raise_in_transactional_callbacks</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.active_record.raise_in_transactional_callbacks = true
">Copy</button>
</div>
<p>è¦‹ <a href="https://github.com/rails/rails/pull/14488">#14488</a> å’Œ
<a href="https://github.com/rails/rails/pull/16537">#16537</a> ç­è§£æ›´å¤šè©³æƒ…ã€‚</p><h4 id=""><a class="anchorlink" href="#">8.4 æ¸¬è©¦ç”¨ä¾‹æ’åº</a></h4><p>åœ¨ Rails 5.0 ä¸­ï¼Œé è¨­æƒ…æ³ä¸‹æœƒä»¥éš¨æ©Ÿé †åºåŸ·è¡Œæ¸¬è©¦ç”¨ä¾‹ã€‚åœ¨
æœŸå¾…é€™å€‹è®ŠåŒ–ï¼ŒRails 4.2 å¼•å…¥äº†ä¸€å€‹æ–°çš„è¨­å®šé¸é …
<code>active_support.test_order</code> ç”¨æ–¼æ˜ç¢ºæŒ‡å®šæ¸¬è©¦é †åºã€‚é€™
å…è¨±æ‚¨é€šéå°‡é¸é …è¨­å®šç‚ºé–å®šç•¶å‰è¡Œç‚º
<code>:sorted</code>ï¼Œæˆ–è€…é€šéå°‡é¸é …è¨­å®šç‚º <code>:random</code> ä¾†é¸æ“‡æœªä¾†çš„è¡Œç‚ºã€‚</p><p>å¦‚æœæ‚¨æ²’æœ‰ç‚ºæ­¤é¸é …æŒ‡å®š valueï¼Œå‰‡æœƒå‡ºç¾æ£„ç”¨è­¦å‘Š
ç™¼å‡ºã€‚ç‚ºé¿å…é€™ç¨®æƒ…æ³ï¼Œè«‹å°‡ä»¥ä¸‹è¡Œæ–°å¢åˆ°æ‚¨çš„æ¸¬è©¦ç’°å¢ƒä¸­ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># è¨­å®š/ç’°å¢ƒ/test.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">test_order</span> <span class="o">=</span> <span class="ss">:sorted</span> <span class="c1"># or `:random` if you prefer</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# è¨­å®š/ç’°å¢ƒ/test.rb
Rails.application.configure do
  config.active_support.test_order = :sorted # or `:random` if you prefer
end
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">8.5 åºåˆ—åŒ–å±¬æ€§</a></h4><p>ä½¿ç”¨è‡ªå®šç¾©ç·¨ç¢¼å™¨ï¼ˆä¾‹å¦‚ <code>serialize :metadata, JSON</code>ï¼‰æ™‚ï¼Œ
å°‡ <code>nil</code> åˆ†é…çµ¦åºåˆ—åŒ–çš„å±¬æ€§æœƒå°‡å…¶å„²å­˜åˆ°è³‡æ–™åº«ä¸­
ä½œç‚º <code>NULL</code> è€Œä¸æ˜¯é€šéç·¨ç¢¼å™¨å‚³é <code>nil</code> valueï¼ˆä¾‹å¦‚ <code>"null"</code>
ä½¿ç”¨ <code>JSON</code> ç·¨ç¢¼å™¨æ™‚ï¼‰ã€‚</p><h4 id=""><a class="anchorlink" href="#">8.6 ç”Ÿç”¢æ—¥èªŒç´šåˆ¥</a></h4><p>Rails 5ä¸­ï¼Œå°‡æ›´æ”¹ç”Ÿç”¢ç’°å¢ƒçš„é è¨­æ—¥èªŒç´šåˆ¥
åˆ° <code>:debug</code>ï¼ˆå¾ <code>:info</code>ï¼‰ã€‚è¦ä¿ç•™ç•¶å‰é è¨­å€¼ï¼Œè«‹æ–°å¢ä»¥ä¸‹å…§å®¹
ç·šåˆ°æ‚¨çš„ <code>production.rb</code>ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># è¨­å®šç‚º `:info` ä»¥åŒ¹é…ç•¶å‰é è¨­å€¼ï¼Œæˆ–è¨­å®šç‚º `:debug` ä»¥é¸æ“‡åŠ å…¥</span>
<span class="c1"># æœªä¾†çš„é è¨­å€¼ã€‚</span>
<span class="n">config</span><span class="p">.</span><span class="nf">log_level</span> <span class="o">=</span> <span class="ss">:info</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# è¨­å®šç‚º `:info` ä»¥åŒ¹é…ç•¶å‰é è¨­å€¼ï¼Œæˆ–è¨­å®šç‚º `:debug` ä»¥é¸æ“‡åŠ å…¥
# æœªä¾†çš„é è¨­å€¼ã€‚
config.log_level = :info
">Copy</button>
</div>
<h4 id="after-bundle-rails"><a class="anchorlink" href="#after-bundle-rails">8.7 <code>after_bundle</code> åœ¨ Rails æ¨¡æ¿ä¸­</a></h4><p>å¦‚æœæ‚¨æœ‰ä¸€å€‹åœ¨ç‰ˆæœ¬æ§åˆ¶ä¸­æ–°å¢æ‰€æœ‰æª”æ¡ˆçš„ Rails æ¨¡æ¿ï¼Œå®ƒ
æ–°å¢ç”¢ç”Ÿçš„ binstub å¤±æ•—ï¼Œå› ç‚ºå®ƒåœ¨ Bundler ä¹‹å‰åŸ·è¡Œï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># æ¨¡æ¿.rb</span>
<span class="n">generate</span><span class="p">(</span><span class="ss">:scaffold</span><span class="p">,</span> <span class="s2">"person name:string"</span><span class="p">)</span>
<span class="n">route</span> <span class="s2">"root to: 'people#index'"</span>
<span class="n">rake</span><span class="p">(</span><span class="s2">"db:migrate"</span><span class="p">)</span>

<span class="n">git</span> <span class="ss">:init</span>
<span class="n">git</span> <span class="ss">add: </span><span class="s2">"."</span>
<span class="n">git</span> <span class="ss">commit: </span><span class="sx">%Q{ -m 'Initial commit' }</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# æ¨¡æ¿.rb
generate(:scaffold, &quot;person name:string&quot;)
route &quot;root to: 'people#index'&quot;
rake(&quot;db:migrate&quot;)

git :init
git add: &quot;.&quot;
git commit: %Q{ -m 'Initial commit' }
">Copy</button>
</div>
<p>æ‚¨ç¾åœ¨å¯ä»¥å°‡ <code>git</code> å‘¼å«åŒ…è£åœ¨ <code>after_bundle</code> å¡Šä¸­ã€‚å®ƒå°‡åŸ·è¡Œ
åœ¨ç”¢ç”Ÿ binstub ä¹‹å¾Œã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># æ¨¡æ¿.rb</span>
<span class="n">generate</span><span class="p">(</span><span class="ss">:scaffold</span><span class="p">,</span> <span class="s2">"person name:string"</span><span class="p">)</span>
<span class="n">route</span> <span class="s2">"root to: 'people#index'"</span>
<span class="n">rake</span><span class="p">(</span><span class="s2">"db:migrate"</span><span class="p">)</span>

<span class="n">after_bundle</span> <span class="k">do</span>
  <span class="n">git</span> <span class="ss">:init</span>
  <span class="n">git</span> <span class="ss">add: </span><span class="s2">"."</span>
  <span class="n">git</span> <span class="ss">commit: </span><span class="sx">%Q{ -m 'Initial commit' }</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# æ¨¡æ¿.rb
generate(:scaffold, &quot;person name:string&quot;)
route &quot;root to: 'people#index'&quot;
rake(&quot;db:migrate&quot;)

after_bundle do
  git :init
  git add: &quot;.&quot;
  git commit: %Q{ -m 'Initial commit' }
end
">Copy</button>
</div>
<h4 id="rails-html"><a class="anchorlink" href="#rails-html">8.8 Rails HTML æ¶ˆæ¯’åŠ‘</a></h4><p>æ¸…ç†æ‡‰ç”¨ç¨‹å¼ä¸­çš„ HTML ç‰‡æ®µæœ‰äº†æ–°çš„é¸æ“‡ã€‚é€™
å¤è€çš„ html-scanner æ–¹æ³•ç¾åœ¨æ­£å¼è¢«æ£„ç”¨ï¼Œä»¥æ”¯æ´
<a href="https://github.com/rails/rails-html-sanitizer"><code>Rails HTML Sanitizer</code></a>ã€‚</p><p>é€™æ„å‘³è‘—æ–¹æ³• <code>sanitize</code>ã€<code>sanitize_css</code>ã€<code>strip_tags</code> å’Œ
<code>strip_links</code> ç”±ä¸€å€‹æ–°çš„å¯¦ç¾æ”¯æ´ã€‚</p><p>é€™ç¨®æ–°çš„æ¶ˆæ¯’åŠ‘åœ¨å…§éƒ¨ä½¿ç”¨ <a href="https://github.com/flavorjones/loofah">Loofah</a>ã€‚çµ²ç“œçµ¡åéä¾†ä½¿ç”¨ Nokogiriï¼Œå®ƒ
åŒ…è£ç”¨ C å’Œ Java ç·¨å¯«çš„ XML è§£æå™¨ï¼Œå› æ­¤æ¸…ç†æ‡‰è©²æ›´å¿«
ç„¡è«–æ‚¨åŸ·è¡Œå“ªå€‹ Ruby ç‰ˆæœ¬ã€‚</p><p>æ–°ç‰ˆæœ¬æ›´æ–°äº†<code>sanitize</code>ï¼Œæ‰€ä»¥å¯ä»¥å–ä¸€å€‹<code>Loofah::Scrubber</code>
å¼·åŠ›æ“¦æ´—ã€‚
<a href="https://github.com/flavorjones/loofah#loofahscrubber">åœ¨æ­¤è™•æª¢è¦–æ´—æ»Œå™¨çš„ä¸€äº›ç¤ºä¾‹</a>ã€‚</p><p>é‚„æ·»åŠ äº†å…©å€‹æ–°çš„æ´—æ»Œå™¨ï¼š<code>PermitScrubber</code> å’Œ <code>TargetScrubber</code>ã€‚
é–±è®€ <a href="https://github.com/rails/rails-html-sanitizer">gem çš„è‡ªè¿°æª”æ¡ˆ</a> ç­è§£æ›´å¤šè³‡è¨Šã€‚</p><p><code>PermitScrubber</code> å’Œ <code>TargetScrubber</code> çš„æ–‡ä»¶è§£é‡‹äº†æ‚¨å¦‚ä½•
å¯ä»¥å®Œå…¨æ§åˆ¶ä½•æ™‚ä»¥åŠå¦‚ä½•å‰é›¢å…ƒç´ ã€‚</p><p>å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼éœ€è¦ä½¿ç”¨èˆŠçš„ sanitizer å¯¦ç¾ï¼Œè«‹åœ¨æ‚¨çš„ <code>Gemfile</code> ä¸­åŒ…å« <code>rails-deprecated_sanitizer</code>ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'rails-deprecated_sanitizer'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="gem 'rails-deprecated_sanitizer'
">Copy</button>
</div>
<h4 id="rails-dom"><a class="anchorlink" href="#rails-dom">8.9 Rails DOM æ¸¬è©¦</a></h4><p><a href="https://api.rubyonrails.org/v4.1/classes/ActionDispatch/Assertions/TagAssertions.html"><code>TagAssertions</code> module</a>ï¼ˆåŒ…å«è«¸å¦‚<code>assert_tag</code>ä¹‹é¡çš„æ–¹æ³•ï¼‰ï¼Œ<a href="https://github.com/rails/rails/blob/6061472b8c310158a2a2e8e9a6b81a1aef6b60fe/actionpack/lib/action_dispatch/testing/assertions/dom.rb">å·²æ£„ç”¨</a>æ”¯æ´ZHTW_3_19_WTHZ_WTHZ_1_WTHZ_WTHZ_<code>assert_tag</code><em>1_WTHZæ–¹æ³•ä¸­çš„<code>assert_select</code>æ–¹æ³•ï¼Œå…¶ä¸­ZHTW_3_1_ZHWTZ_WTHZ_1_WTHZ_WTHZ_1</em>WTHWT_WTHZ_test_zh_THâ€‹â€‹ZWHTZ_test_zh_1_ZHWTWT_test_zh_TWZ_1_ZHWT_WTHZ_test_1</p><h4 id="tokens"><a class="anchorlink" href="#tokens">8.10 å½è£çœŸå¯¦æ€§ Tokens</a></h4><p>ç‚ºäº†æ¸›è¼• SSL æ”»æ“Šï¼Œ<code>form_authenticity_token</code> ç¾åœ¨è¢«é®è”½ï¼Œä»¥ä¾¿å®ƒéš¨æ¯å€‹è«‹æ±‚è€Œè®ŠåŒ–ã€‚å› æ­¤ï¼Œtokens é€šéå–æ¶ˆé®è”½ç„¶å¾Œè§£å¯†ä¾†é©—è­‰ã€‚å› æ­¤ï¼Œä»»ä½•ç”¨æ–¼é©—è­‰ä¾†è‡ªé rails è¡¨å–®ä¸”ä¾è³´æ–¼éœæ…‹ session CSRF ä»¤ç‰Œçš„è«‹æ±‚çš„ç­–ç•¥éƒ½å¿…é ˆè€ƒæ…®åˆ°é€™ä¸€é»ã€‚</p><h4 id="action-mailer"><a class="anchorlink" href="#action-mailer">8.11 Action Mailer</a></h4><p>ä»¥å‰ï¼Œåœ¨éƒµä»¶ç¨‹å¼é¡ä¸Šå‘¼å«éƒµä»¶ç¨‹å¼æ–¹æ³•å°‡å°è‡´
ç›´æ¥åŸ·è¡Œå°æ‡‰çš„å¯¦ä¾‹æ–¹æ³•ã€‚éš¨è‘—å¼•é€²
Active Job å’Œ <code>#deliver_later</code>ï¼Œé€™ä¸å†æ˜¯çœŸçš„ã€‚åœ¨ Rails 4.2 ä¸­ï¼Œ
å¯¦ä¾‹æ–¹æ³•çš„å‘¼å«è¢«æ¨é²åˆ° <code>deliver_now</code> æˆ–
<code>deliver_later</code> è¢«å‘¼å«ã€‚ä¾‹å¦‚ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Notifier</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Called"</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Notifier &lt; ActionMailer::Base
  def notify(user, ...)
    puts "Called"
    mail(to: user.email, ...)
  end
end
'>Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">mail</span> <span class="o">=</span> <span class="no">Notifier</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="c1"># Notifier#notify is not yet called at this point</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">mail</span><span class="p">.</span><span class="nf">deliver_now</span>           <span class="c1"># Prints "Called"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='mail = Notifier.notify(user, ...) # Notifier#notify is not yet called at this point
mail = mail.deliver_now           # Prints "Called"
'>Copy</button>
</div>
<p>å°æ–¼å¤§å¤šæ•¸æ‡‰ç”¨ç¨‹å¼ï¼Œé€™ä¸æ‡‰å°è‡´ä»»ä½•æ˜é¡¯å·®ç•°ã€‚
ä½†æ˜¯ï¼Œå¦‚æœæ‚¨éœ€è¦åŒæ­¥åŸ·è¡Œä¸€äº›ééƒµä»¶ç¨‹å¼æ–¹æ³•ï¼Œä¸¦ä¸”
æ‚¨ä»¥å‰ä¾è³´åŒæ­¥ä»£ç†è¡Œç‚ºï¼Œæ‚¨æ‡‰è©²
ç›´æ¥åœ¨éƒµä»¶ç¨‹å¼é¡ä¸Šå°‡å®ƒå€‘å®šç¾©ç‚ºé¡æ–¹æ³•ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Notifier</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">broadcast_notifications</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="n">users</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="no">Notifier</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Notifier &lt; ActionMailer::Base
  def self.broadcast_notifications(users, ...)
    users.each { |user| Notifier.notify(user, ...) }
  end
end
">Copy</button>
</div>
<h4 id="key"><a class="anchorlink" href="#key">8.12 åœ‹å¤– Key æ”¯æ´</a></h4><p>migration DSL å·²æ“´å……å¥—ä»¶ç‚ºæ”¯æ´å¤–éƒ¨ key å®šç¾©ã€‚å¦‚æœ
æ‚¨ä¸€ç›´åœ¨ä½¿ç”¨ Foreigner gemï¼Œæ‚¨å¯èƒ½éœ€è¦è€ƒæ…®å°‡å…¶åˆªé™¤ã€‚
æ³¨æ„ Rails çš„å¤–éƒ¨ key æ”¯æ´æ˜¯ Foreigner çš„å­é›†ã€‚é€™æ„å‘³è‘—
ä¸¦éæ¯å€‹ Foreigner å®šç¾©éƒ½å¯ä»¥å®Œå…¨æ›¿æ›ç‚ºå…¶ Rails
migration DSL å°æ‡‰ã€‚</p><p>migration éç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¾ <code>Gemfile</code> ä¸­åˆªé™¤ <code>gem "foreigner"</code>ã€‚</li>
<li>åŸ·è¡Œ <code>bundle install</code>ã€‚</li>
<li>åŸ·è¡Œ <code>bin/rake db:schema:dump</code>ã€‚</li>
<li>ç¢ºä¿ <code>db/schema.rb</code> åŒ…å«æ¯å€‹å¤–éƒ¨ key å®šç¾©
å¿…è¦çš„é¸é …ã€‚</li>
</ol>
<h3 id="rails-4-0-rails-4-1"><a class="anchorlink" href="#rails-4-0-rails-4-1">9 å¾ Rails 4.0 å‡ç´šåˆ° Rails 4.1</a></h3><h4 id="script-csrf"><a class="anchorlink" href="#script-csrf">9.1 é ç«¯ <code>&lt;script&gt;</code> æ¨™ç±¤çš„ CSRF ä¿è­·</a></h4><p>æˆ–è€…ï¼Œâ€œæˆ‘çš„æ¸¬è©¦å¤±æ•—äº†ï¼ï¼ï¼ï¼Ÿâ€æˆ–â€œæˆ‘çš„ <code>&lt;script&gt;</code> å°éƒ¨ä»¶è¢«ç ´å£äº†ï¼ï¼â€</p><p>è·¨ç«™é»è«‹æ±‚å½é€  (CSRF) ä¿è­·ç¾åœ¨åŒ…å« GET è«‹æ±‚
JavaScript å›æ‡‰ä¹Ÿæ˜¯å¦‚æ­¤ã€‚é€™å¯ä»¥é˜²æ­¢ç¬¬ä¸‰æ–¹ç«™é»é ç«¯è¨ªå•
ä½¿ç”¨ <code>&lt;script&gt;</code> æ¨™è¨˜å¼•ç”¨æ‚¨çš„ JavaScript ä»¥æå–æ•æ„Ÿè³‡æ–™ã€‚</p><p>é€™æ„å‘³è‘—æ‚¨ä½¿ç”¨çš„åŠŸèƒ½å’Œæ•´åˆæ¸¬è©¦</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">format: :js</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="get :index, format: :js
">Copy</button>
</div>
<p>ç¾åœ¨å°‡è§¸ç™¼ CSRF ä¿è­·ã€‚åˆ‡æ›åˆ°</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">xhr</span> <span class="ss">:get</span><span class="p">,</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">format: :js</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="xhr :get, :index, format: :js
">Copy</button>
</div>
<p>é¡¯å¼æ¸¬è©¦ <code>XmlHttpRequest</code>ã€‚</p><div class="note"><p>æ‚¨è‡ªå·±çš„ <code>&lt;script&gt;</code> æ¨™ç±¤è¢«è¦–ç‚ºè·¨æºä¸¦è¢«
é è¨­ä¹Ÿæ˜¯ã€‚å¦‚æœæ‚¨çœŸçš„æƒ³å¾ <code>&lt;script&gt;</code> æ¨™ç±¤è¼‰å…¥ JavaScriptï¼Œ
æ‚¨ç¾åœ¨å¿…é ˆæ˜ç¢ºè·³éé‚£äº› actions ä¸Šçš„ CSRF ä¿è­·ã€‚</p></div><h4 id="rails-4-0-rails-4-1"><a class="anchorlink" href="#rails-4-0-rails-4-1">9.2 å½ˆç°§</a></h4><p>å¦‚æœæ‚¨æƒ³ä½¿ç”¨ Spring ä½œç‚ºæ‚¨çš„æ‡‰ç”¨ç¨‹å¼é è¼‰å…¥å™¨ï¼Œæ‚¨éœ€è¦ï¼š</p>
<ol>
<li>å°‡ <code>gem 'spring', group: :development</code> æ–°å¢åˆ°æ‚¨çš„ <code>Gemfile</code>ã€‚</li>
<li>ä½¿ç”¨ <code>bundle install</code> å®‰è£å½ˆç°§ã€‚</li>
<li>ä½¿ç”¨ <code>bundle exec spring binstub</code> ç”¢ç”Ÿ Spring binstubã€‚</li>
</ol>
<div class="note"><p>ä½¿ç”¨è€…å®šç¾©çš„ rake ä»»å‹™å°‡åœ¨ <code>development</code> ç’°å¢ƒä¸­åŸ·è¡Œ
é è¨­ã€‚å¦‚æœæ‚¨å¸Œæœ›å®ƒå€‘åœ¨å…¶ä»–ç’°å¢ƒä¸­åŸ·è¡Œï¼Œè«‹åƒé–±
<a href="https://github.com/rails/spring#rake">Spring README</a>ã€‚</p></div><h4 id="config-secrets-yml"><a class="anchorlink" href="#config-secrets-yml">9.3 <code>config/secrets.yml</code></a></h4><p>å¦‚æœæ‚¨æƒ³ä½¿ç”¨æ–°çš„ <code>secrets.yml</code> ç´„å®šä¾†å„²å­˜æ‡‰ç”¨ç¨‹å¼çš„
ç¥•å¯†ï¼Œä½ éœ€è¦ï¼š</p>
<ol>
<li>
<p>åœ¨ <code>config</code> è³‡æ–™å¤¾ä¸­å»ºç«‹ä¸€å€‹ <code>secrets.yml</code> æª”æ¡ˆï¼Œå…§å®¹å¦‚ä¸‹ï¼š</p>
<div class="code_container">
<pre><code class="highlight yaml"><span class="na">development</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span>

<span class="na">production</span><span class="pi">:</span>
  <span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='development:
  secret_key_base:

test:
  secret_key_base:

production:
  secret_key_base: &lt;%= ENV["SECRET_KEY_BASE"] %&gt;
'>Copy</button>
</div>
</li>
<li><p>ä½¿ç”¨ä¾†è‡ª <code>secret_token.rb</code> åˆå§‹å€¼è¨­å®šé …çš„ç¾æœ‰ <code>secret_key_base</code>
ç‚ºåŸ·è¡Œè©²ç¨‹å¼çš„ä»»ä½•ä½¿ç”¨è€…è¨­å®š <code>SECRET_KEY_BASE</code> ç’°å¢ƒè®Šæ•¸
Rails æ‡‰ç”¨ç¨‹å¼åœ¨ç”Ÿç”¢ä¸­ã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥ç°¡å–®åœ°è¤‡è£½ç¾æœ‰çš„
<code>secret_key_base</code> å¾ <code>secret_token.rb</code> åˆå§‹åŒ–å™¨åˆ° <code>secrets.yml</code>
åœ¨ <code>production</code> éƒ¨åˆ†ä¸‹ï¼Œæ›¿æ› <code>&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</code>ã€‚</p></li>
<li><p>ç§»é™¤ <code>secret_token.rb</code> åˆå§‹å€¼è¨­å®šé …ã€‚</p></li>
<li><p>ä½¿ç”¨ <code>rake secret</code> ç‚º <code>development</code> å’Œ <code>test</code> éƒ¨åˆ†ç”¢ç”Ÿæ–°çš„ keysã€‚</p></li>
<li><p>é‡æ–°å•Ÿå‹•æ‚¨çš„ä¼ºæœå™¨ã€‚</p></li>
</ol>
<h4 id="helper"><a class="anchorlink" href="#helper">9.4 æ›´æ”¹ä»¥æ¸¬è©¦ helper</a></h4><p>å¦‚æœæ‚¨çš„æ¸¬è©¦ helper åŒ…å«å°
<code>ActiveRecord::Migration.check_pending!</code> é€™å€‹å¯ä»¥å»æ‰ã€‚æ”¯ç¥¨
ç¾åœ¨ç•¶ä½  <code>require "rails/test_help"</code> æ™‚è‡ªå‹•å®Œæˆï¼Œé›–ç„¶
å°‡æ­¤è¡Œç•™åœ¨æ‚¨çš„ helper ä¸­æ²’æœ‰ä»»ä½•å±å®³ã€‚</p><h4 id="cookies"><a class="anchorlink" href="#cookies">9.5 Cookies åºåˆ—åŒ–å™¨</a></h4><p>Rails 4.1 ä¹‹å‰å»ºç«‹çš„æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ <code>Marshal</code> å°‡ cookie values åºåˆ—åŒ–ç‚º
ç°½åå’ŒåŠ å¯†çš„ cookie ç½å­ã€‚å¦‚æœè¦ä½¿ç”¨æ–°çš„æ ¹æ“š <code>JSON</code> çš„æ ¼å¼
åœ¨æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œæ‚¨å¯ä»¥æ–°å¢ä¸€å€‹åŒ…å«ä»¥ä¸‹å…§å®¹çš„åˆå§‹åŒ–æª”æ¡ˆï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">cookies_serializer</span> <span class="o">=</span> <span class="ss">:hybrid</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.application.config.action_dispatch.cookies_serializer = :hybrid
">Copy</button>
</div>
<p>é€™æœƒå°‡æ‚¨ç¾æœ‰çš„ <code>Marshal</code> åºåˆ—åŒ– cookies é€æ˜åœ°é·ç§»åˆ°
æ–°çš„æ ¹æ“š <code>JSON</code> çš„æ ¼å¼ã€‚</p><p>ä½¿ç”¨ <code>:json</code> æˆ– <code>:hybrid</code> åºåˆ—åŒ–ç¨‹å¼æ™‚ï¼Œæ‚¨æ‡‰è©²æ³¨æ„ä¸¦éæ‰€æœ‰
Ruby ç‰©ä»¶å¯ä»¥åºåˆ—åŒ–ç‚º JSONã€‚ä¾‹å¦‚ï¼Œ<code>Date</code> å’Œ <code>Time</code> ç‰©ä»¶
å°‡è¢«åºåˆ—åŒ–ç‚ºå­—ä¸²ï¼Œä¸¦ä¸” <code>Hash</code>es å°‡å…¶ keys å­—ä¸²åŒ–ã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CookiesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">set_cookie</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:expiration_date</span><span class="p">]</span> <span class="o">=</span> <span class="no">Date</span><span class="p">.</span><span class="nf">tomorrow</span> <span class="c1"># =&gt; Thu, 20 Mar 2014</span>
    <span class="n">redirect_to</span> <span class="ss">action: </span><span class="s1">'read_cookie'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">read_cookie</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:expiration_date</span><span class="p">]</span> <span class="c1"># =&gt; "2014-03-20"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CookiesController &lt; ApplicationController
  def set_cookie
    cookies.encrypted[:expiration_date] = Date.tomorrow # =&gt; Thu, 20 Mar 2014
    redirect_to action: 'read_cookie'
  end

  def read_cookie
    cookies.encrypted[:expiration_date] # =&gt; &quot;2014-03-20&quot;
  end
end
">Copy</button>
</div>
<p>å»ºè­°æ‚¨åªåœ¨ cookies ä¸­å„²å­˜ç°¡å–®è³‡æ–™ï¼ˆå­—ä¸²å’Œæ•¸å­—ï¼‰ã€‚
å¦‚æœå¿…é ˆå„²å­˜è¤‡é›œçš„ç‰©ä»¶ï¼Œå‰‡éœ€è¦è™•ç†è½‰æ›
åœ¨å¾ŒçºŒè«‹æ±‚ä¸­è®€å– values æ™‚æ‰‹å‹•ã€‚</p><p>å¦‚æœæ‚¨ä½¿ç”¨ cookie session å„²å­˜ï¼Œé€™å°‡é©ç”¨æ–¼ <code>session</code> å’Œ
<code>flash</code> é›œæ¹Šä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p><h4 id="flash"><a class="anchorlink" href="#flash">9.6 Flash çµæ§‹è®ŠåŒ–</a></h4><p>Flash è¨Šæ¯ keys æ˜¯
<a href="https://github.com/rails/rails/commit/a668beffd64106a1e1fedb71cc25eaaa11baf0c1">æ¨™æº–åŒ–ç‚ºå­—ä¸²</a>ã€‚ä»–å€‘
ä»ç„¶å¯ä»¥ä½¿ç”¨ symbols æˆ–å­—ä¸²è¨ªå•ã€‚è¿´åœˆé€šéé–ƒå…‰ç‡ˆ
å°‡å§‹çµ‚ç”¢ç”Ÿå­—ä¸² keysï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">flash</span><span class="p">[</span><span class="s2">"string"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"a string"</span>
<span class="n">flash</span><span class="p">[</span><span class="ss">:symbol</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"a symbol"</span>

<span class="c1"># Rails &lt; 4.1</span>
<span class="n">flash</span><span class="p">.</span><span class="nf">keys</span> <span class="c1"># =&gt; ["string", :symbol]</span>

<span class="c1"># Rails &gt;= 4.1</span>
<span class="n">flash</span><span class="p">.</span><span class="nf">keys</span> <span class="c1"># =&gt; ["string", "symbol"]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='flash["string"] = "a string"
flash[:symbol] = "a symbol"

# Rails &lt; 4.1
flash.keys # =&gt; ["string", :symbol]

# Rails &gt;= 4.1
flash.keys # =&gt; ["string", "symbol"]
'>Copy</button>
</div>
<p>ç¢ºä¿å°‡ Flash è¨Šæ¯ keys èˆ‡å­—ä¸²é€²è¡Œæ¯”è¼ƒã€‚</p><h4 id="json"><a class="anchorlink" href="#json">9.7 JSON è™•ç†çš„è®ŠåŒ–</a></h4><p>Rails 4.1 ä¸­æœ‰ä¸€äº›èˆ‡ JSON è™•ç†ç›¸é—œçš„é‡å¤§æ›´æ”¹ã€‚</p><h5 id="multijson"><a class="anchorlink" href="#multijson">9.7.1 MultiJSON ç§»é™¤</a></h5><p>MultiJSON å·²é”åˆ°å…¶ <a href="https://github.com/rails/rails/pull/10576">end-of-life</a>
ä¸¦å·²å¾ Rails ä¸­ç§»é™¤ã€‚</p><p>å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ç•¶å‰ç›´æ¥ä¾è³´ MultiJSONï¼Œæ‚¨æœ‰å¹¾å€‹é¸æ“‡ï¼š</p>
<ol>
<li><p>å°‡â€œmulti_jsonâ€æ–°å¢åˆ°æ‚¨çš„ <code>Gemfile</code>ã€‚è«‹æ³¨æ„ï¼Œé€™å¯èƒ½æœƒåœ¨æœªä¾†åœæ­¢å·¥ä½œ</p></li>
<li><p>ä½¿ç”¨ <code>obj.to_json</code> å’Œ <code>JSON.parse(str)</code> å¾ MultiJSON é·ç§»ã€‚</p></li>
</ol>
<div class="warning"><p>ä¸è¦ç°¡å–®åœ°å°‡ <code>MultiJson.dump</code> å’Œ <code>MultiJson.load</code> æ›¿æ›ç‚º
<code>JSON.dump</code> å’Œ <code>JSON.load</code>ã€‚é€™äº› JSON gem API ç”¨æ–¼åºåˆ—åŒ–å’Œ
ååºåˆ—åŒ–ä»»æ„ Ruby ç‰©ä»¶ï¼Œé€šå¸¸æ˜¯ <a href="https://ruby-doc.org/stdlib-2.2.2/libdoc/json/rdoc/JSON.html#method-i-load">ä¸å®‰å…¨çš„</a>ã€‚</p></div><h5 id="json-gem"><a class="anchorlink" href="#json-gem">9.7.2 JSON gem ç›¸å®¹æ€§</a></h5><p>å¾æ­·å²ä¸Šçœ‹ï¼ŒRails èˆ‡ JSON gem å­˜åœ¨ä¸€äº›ç›¸å®¹æ€§å•é¡Œã€‚ä½¿ç”¨
Rails æ‡‰ç”¨ç¨‹å¼ä¸­çš„ <code>JSON.generate</code> å’Œ <code>JSON.dump</code> å¯ä»¥ç”¢ç”Ÿ
æ„å¤–éŒ¯èª¤ã€‚</p><p>Rails 4.1 é€šéå°‡è‡ªå·±çš„ç·¨ç¢¼å™¨èˆ‡ JSON gem éš”é›¢ä¾†è§£æ±ºé€™äº›å•é¡Œã€‚é€™
JSON gem API å°‡æ­£å¸¸åŸ·è¡Œï¼Œä½†å®ƒå€‘å°‡ç„¡æ³•è¨ªå•ä»»ä½•
Rails ç‰¹å®šçš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">FooBar</span>
  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="p">{</span> <span class="ss">foo: </span><span class="s1">'bar'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class FooBar
  def as_json(options = nil)
    { foo: 'bar' }
  end
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">FooBar</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">to_json</span>
<span class="p">=&gt;</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">foo</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">bar</span><span class="se">\"</span><span class="s2">}"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="no">FooBar</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span> <span class="ss">quirks_mode: </span><span class="kp">true</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">#&lt;FooBar:0x007fa80a481610&gt;</span><span class="se">\"</span><span class="s2">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="FooBar.new.to_json
JSON.generate(FooBar.new, quirks_mode: true)
">Copy</button>
</div>
<h5 id="json"><a class="anchorlink" href="#json">9.7.3 æ–°çš„ JSON ç·¨ç¢¼å™¨</a></h5><p>Rails 4.1 ä¸­çš„ JSON ç·¨ç¢¼å™¨å·²è¢«é‡å¯«ä»¥åˆ©ç”¨ JSON
å¯¶çŸ³ã€‚å°æ–¼å¤§å¤šæ•¸æ‡‰ç”¨ç¨‹å¼ï¼Œé€™æ‡‰è©²æ˜¯ä¸€å€‹é€æ˜çš„æ›´æ”¹ã€‚ç„¶è€Œï¼Œä½œç‚º
åœ¨é‡å¯«çš„ä¸€éƒ¨åˆ†ä¸­ï¼Œä»¥ä¸‹åŠŸèƒ½å·²å¾ç·¨ç¢¼å™¨ä¸­åˆªé™¤ï¼š</p><p>1.è¿´åœˆè³‡æ–™çµæ§‹æª¢æ¸¬
2.æ”¯æ´<code>encode_json</code>æ›è¼‰æ©Ÿåˆ¶
3. å°‡ <code>BigDecimal</code> ç‰©ä»¶ç·¨ç¢¼ç‚ºæ•¸å­—è€Œä¸æ˜¯å­—ä¸²çš„é¸é …</p><p>å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä¾è³´æ–¼é€™äº›åŠŸèƒ½ä¹‹ä¸€ï¼Œæ‚¨å¯ä»¥é€šé
æ–°å¢ <a href="https://github.com/rails/activesupport-json_encoder"><code>activesupport-json_encoder</code></a>
å¯¶çŸ³åˆ°æ‚¨çš„ <code>Gemfile</code>ã€‚</p><h5 id="time-json"><a class="anchorlink" href="#time-json">9.7.4 Time ç‰©ä»¶çš„ JSON è¡¨ç¤º</a></h5><p><code>#as_json</code> ç”¨æ–¼å…·æœ‰æ™‚é–“åˆ†é‡çš„ç‰©ä»¶ï¼ˆ<code>Time</code>ã€<code>DateTime</code>ã€<code>ActiveSupport::TimeWithZone</code>ï¼‰
ç¾åœ¨é è¨­è¿”å›æ¯«ç§’ç²¾åº¦ã€‚å¦‚æœæ‚¨éœ€è¦ä¿æŒæ²’æœ‰æ¯«ç§’çš„èˆŠè¡Œç‚º
ç²¾åº¦ï¼Œåœ¨åˆå§‹åŒ–ç¨‹å¼ä¸­è¨­å®šä»¥ä¸‹å…§å®¹ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">JSON</span><span class="o">::</span><span class="no">Encoding</span><span class="p">.</span><span class="nf">time_precision</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="ActiveSupport::JSON::Encoding.time_precision = 0
">Copy</button>
</div>
<h4 id="callback-return"><a class="anchorlink" href="#callback-return">9.8 åœ¨å…§è¯ callback å¡Šä¸­ä½¿ç”¨ <code>return</code></a></h4><p>ä»¥å‰ï¼ŒRails å…è¨±å…§è¯ callback å¡Šä»¥é€™ç¨®æ–¹å¼ä½¿ç”¨ <code>return</code>ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="k">return</span> <span class="kp">false</span> <span class="p">}</span> <span class="c1"># BAD</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ReadOnlyModel &lt; ActiveRecord::Base
  before_save { return false } # BAD
end
">Copy</button>
</div>
<p>é€™ç¨®è¡Œç‚ºå¾æœªè¢«æœ‰æ„æ”¯æ´ã€‚ç”±æ–¼å…§éƒ¨çµæ§‹çš„è®ŠåŒ–
<code>ActiveSupport::Callbacks</code> çš„ï¼Œåœ¨ Rails 4.1 ä¸­ä¸å†å…è¨±ã€‚ç”¨ä¸€å€‹
å…§è¯ callback å¡Šä¸­çš„ <code>return</code> èªå¥å°è‡´ <code>LocalJumpError</code>
åŸ·è¡Œ callback æ™‚å¼•ç™¼ã€‚</p><p>å¯ä»¥é‡æ§‹ä½¿ç”¨ <code>return</code> çš„å…§è¯ callback å¡Šä»¥è©•ä¼°ç‚º
è¿”å› valueï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="kp">false</span> <span class="p">}</span> <span class="c1"># GOOD</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ReadOnlyModel &lt; ActiveRecord::Base
  before_save { false } # GOOD
end
">Copy</button>
</div>
<p>æˆ–è€…ï¼Œå¦‚æœé¦–é¸ <code>return</code>ï¼Œå‰‡å»ºè­°æ˜ç¢ºå®šç¾©
ä¸€å€‹æ–¹æ³•ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="ss">:before_save_callback</span> <span class="c1"># GOOD</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">before_save_callback</span>
      <span class="k">return</span> <span class="kp">false</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ReadOnlyModel &lt; ActiveRecord::Base
  before_save :before_save_callback # GOOD

  private
    def before_save_callback
      return false
    end
end
">Copy</button>
</div>
<p>æ­¤æ›´æ”¹é©ç”¨æ–¼ Rails ä¸­ä½¿ç”¨ callbacks çš„å¤§å¤šæ•¸åœ°æ–¹ï¼ŒåŒ…æ‹¬
Active Record å’Œ Active Model callbacksï¼Œä»¥åŠ Action ä¸­çš„éæ¿¾å™¨
Controllerï¼ˆä¾‹å¦‚ <code>before_action</code>ï¼‰ã€‚</p><p>è«‹åƒé–± <a href="https://github.com/rails/rails/pull/13271">æ­¤æ‹‰å–è«‹æ±‚</a> ç­è§£æ›´å¤š
ç´°ç¯€ã€‚</p><h4 id="active-record"><a class="anchorlink" href="#active-record">9.9 å®šç¾©åœ¨ Active Record å¤¾å…·ä¸­çš„æ–¹æ³•</a></h4><p>Rails 4.1 åœ¨å–®ç¨çš„ä¸Šä¸‹æ–‡ä¸­è©•ä¼°æ¯å€‹è£ç½®çš„ ERBï¼Œå› æ­¤ helper æ–¹æ³•
åœ¨ä¸€å€‹è£ç½®ä¸­å®šç¾©çš„åœ¨å…¶ä»–è£ç½®ä¸­ä¸å¯ç”¨ã€‚</p><p>å¤šå€‹å¤¾å…·ä¸­ä½¿ç”¨çš„ Helper æ–¹æ³•æ‡‰åœ¨ modules ä¸Šå®šç¾©
åŒ…å«åœ¨æ–°å¼•å…¥çš„ <code>ActiveRecord::FixtureSet.context_class</code> ä¸­ï¼Œåœ¨
<code>test_helper.rb</code>ã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">FixtureFileHelpers</span>
  <span class="k">def</span> <span class="nf">file_sha</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA256</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'test/fixtures'</span><span class="p">,</span> <span class="n">path</span><span class="p">)))</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">FixtureSet</span><span class="p">.</span><span class="nf">context_class</span><span class="p">.</span><span class="nf">include</span> <span class="no">FixtureFileHelpers</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module FixtureFileHelpers
  def file_sha(path)
    OpenSSL::Digest::SHA256.hexdigest(File.read(Rails.root.join('test/fixtures', path)))
  end
end

ActiveRecord::FixtureSet.context_class.include FixtureFileHelpers
">Copy</button>
</div>
<h4 id="i18n"><a class="anchorlink" href="#i18n">9.10 I18n å¼·åˆ¶åŸ·è¡Œå¯ç”¨çš„èªè¨€ç’°å¢ƒ</a></h4><p>Rails 4.1 ç¾åœ¨é è¨­ I18n é¸é … <code>enforce_available_locales</code> ç‚º <code>true</code>ã€‚é€™
æ„å‘³è‘—å®ƒå°‡ç¢ºä¿å‚³éçµ¦å®ƒçš„æ‰€æœ‰èªè¨€ç’°å¢ƒéƒ½å¿…é ˆåœ¨
<code>available_locales</code> åˆ—è¡¨ã€‚</p><p>è¦ç¦ç”¨å®ƒï¼ˆä¸¦å…è¨± I18n æ¥å— <em>any</em> èªè¨€ç’°å¢ƒé¸é …ï¼‰ï¼Œè«‹æ–°å¢ä»¥ä¸‹å…§å®¹
è¨­å®šåˆ°æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">i18n</span><span class="p">.</span><span class="nf">enforce_available_locales</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.i18n.enforce_available_locales = false
">Copy</button>
</div>
<p>è«‹æ³¨æ„ï¼Œæ­¤é¸é …æ˜¯ä½œç‚ºå®‰å…¨æªæ–½æ–°å¢çš„ï¼Œä»¥ç¢ºä¿ä½¿ç”¨è€…è¼¸å…¥
é™¤éäº‹å…ˆçŸ¥é“ï¼Œå¦å‰‡ä¸èƒ½ç”¨ä½œå€åŸŸè¨­å®šè³‡è¨Šã€‚æ‰€ä»¥ï¼Œ
é™¤éæ‚¨æœ‰å……åˆ†çš„ç†ç”±ï¼Œå¦å‰‡å»ºè­°ä¸è¦ç¦ç”¨æ­¤é¸é …
é€™æ¨£åšã€‚</p><h4 id="relation-mutator"><a class="anchorlink" href="#relation-mutator">9.11 å° Relation å‘¼å«çš„ Mutator æ–¹æ³•</a></h4><p><code>Relation</code> ä¸å†æœ‰åƒ <code>#map!</code> å’Œ <code>#delete_if</code> é€™æ¨£çš„ä¿®æ”¹å™¨æ–¹æ³•ã€‚å…Œæ›
åœ¨ä½¿ç”¨é€™äº›æ–¹æ³•ä¹‹å‰é€šéå‘¼å« <code>#to_a</code> åˆ° <code>Array</code>ã€‚</p><p>å®ƒçš„ç›®æ¨™åœ¨æ–¼é˜²æ­¢å‘¼å« mutator çš„ç¨‹å¼ç¢¼ä¸­å‡ºç¾å¥‡æ€ªçš„éŒ¯èª¤å’Œæ··æ·†
æ–¹æ³•ç›´æ¥æ”¾åœ¨ <code>Relation</code> ä¸Šã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># è€Œä¸æ˜¯é€™å€‹</span>
<span class="no">Author</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Hank Moody'</span><span class="p">).</span><span class="nf">compact!</span>

<span class="c1"># ç¾åœ¨ä½ å¿…é ˆé€™æ¨£åš</span>
<span class="n">authors</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Hank Moody'</span><span class="p">).</span><span class="nf">to_a</span>
<span class="n">authors</span><span class="p">.</span><span class="nf">compact!</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# è€Œä¸æ˜¯é€™å€‹
Author.where(name: 'Hank Moody').compact!

# ç¾åœ¨ä½ å¿…é ˆé€™æ¨£åš
authors = Author.where(name: 'Hank Moody').to_a
authors.compact!
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">9.12 é è¨­ç¯„åœçš„è®ŠåŒ–</a></h4><p>é è¨­ç¯„åœä¸å†è¢«é€£çµæ¢ä»¶è¦†è“‹ã€‚</p><p>åœ¨ä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œç•¶æ‚¨åœ¨ model ä¸­å®šç¾© <code>default_scope</code> æ™‚
å®ƒè¢«åŒä¸€æ¬„ä½ä¸­çš„é€£çµæ¢ä»¶è¦†è“‹ã€‚ç¾åœ¨å®ƒ
åƒä»»ä½•å…¶ä»–ç¯„åœä¸€æ¨£åˆä½µã€‚</p><p>å‰ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'pending'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'active'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'inactive'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s1">'inactive'</span><span class="p">)</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ActiveRecord::Base
  default_scope { where state: 'pending' }
  scope :active, -&gt; { where state: 'active' }
  scope :inactive, -&gt; { where state: 'inactive' }
end

User.all
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'pending'

User.active
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'active'

User.where(state: 'inactive')
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'inactive'
">Copy</button>
</div>
<p>å¾Œï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'pending'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'active'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'inactive'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s1">'inactive'</span><span class="p">)</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'inactive'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ActiveRecord::Base
  default_scope { where state: 'pending' }
  scope :active, -&gt; { where state: 'active' }
  scope :inactive, -&gt; { where state: 'inactive' }
end

User.all
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'pending'

User.active
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'pending' AND &quot;users&quot;.&quot;state&quot; = 'active'

User.where(state: 'inactive')
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'pending' AND &quot;users&quot;.&quot;state&quot; = 'inactive'
">Copy</button>
</div>
<p>è¦ç²å¾—ä»¥å‰çš„è¡Œç‚ºï¼Œéœ€è¦æ˜ç¢ºåˆªé™¤
<code>default_scope</code> æ¢ä»¶ä½¿ç”¨ <code>unscoped</code>ã€<code>unscope</code>ã€<code>rewhere</code> æˆ–
<code>except</code>ã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s1">'pending'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">unscope</span><span class="p">(</span><span class="ss">where: :state</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s1">'active'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">rewhere</span> <span class="ss">state: </span><span class="s1">'inactive'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">inactive</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ActiveRecord::Base
  default_scope { where state: 'pending' }
  scope :active, -&gt; { unscope(where: :state).where(state: 'active') }
  scope :inactive, -&gt; { rewhere state: 'inactive' }
end

User.all
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'pending'

User.active
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'active'

User.inactive
# SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = 'inactive'
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">9.13 å¾å­—ä¸²æ¸²æŸ“å…§å®¹</a></h4><p>Rails 4.1 å‘ <code>render</code> å¼•å…¥äº† <code>:plain</code>ã€<code>:html</code> å’Œ <code>:body</code> é¸é …ã€‚é‚£äº›
é¸é …ç¾åœ¨æ˜¯å‘ˆç¾æ ¹æ“šå­—ä¸²çš„å…§å®¹çš„é¦–é¸æ–¹å¼ï¼Œå› ç‚ºå®ƒå…è¨±
æ‚¨æŒ‡å®šæ‚¨å¸Œæœ›å›æ‡‰å‚³é€çš„å…§å®¹å‹åˆ¥ã€‚</p>
<ul>
<li>
<code>render :plain</code> å°‡è¨­å®šå…§å®¹å‹åˆ¥ç‚º <code>text/plain</code>
</li>
<li>
<code>render :html</code> å°‡è¨­å®šå…§å®¹å‹åˆ¥ç‚º <code>text/html</code>
</li>
<li>
<code>render :body</code> å°‡<em>ä¸</em>è¨­å®šå…§å®¹å‹åˆ¥æ¨™é¡Œã€‚</li>
</ul>
<p>å¾å®‰å…¨çš„è§’åº¦ä¾†çœ‹ï¼Œå¦‚æœæ‚¨ä¸å¸Œæœ›åœ¨æ‚¨çš„
å›æ‡‰æ­£æ–‡ï¼Œæ‚¨æ‡‰è©²ä½¿ç”¨ <code>render :plain</code> å› ç‚ºå¤§å¤šæ•¸ç€è¦½å™¨éƒ½æœƒè½‰ç¾©
å°æ‚¨çš„å›æ‡‰ä¸­åŒ…å«ä¸å®‰å…¨çš„å…§å®¹ã€‚</p><p>æˆ‘å€‘å°‡åœ¨æœªä¾†ç‰ˆæœ¬ä¸­æ£„ç”¨ <code>render :text</code>ã€‚æ‰€ä»¥ï¼Œè«‹
é–‹å§‹ä½¿ç”¨æ›´ç²¾ç¢ºçš„ <code>:plain</code>ã€<code>:html</code> å’Œ <code>:body</code> é¸é …ã€‚
ä½¿ç”¨ <code>render :text</code> å¯èƒ½æœƒå¸¶ä¾†å®‰å…¨é¢¨éšªï¼Œå› ç‚ºå…§å®¹æ˜¯ä½œç‚º
<code>text/html</code>ã€‚</p><h4 id="postgresql-json-hstore"><a class="anchorlink" href="#postgresql-json-hstore">9.14 PostgreSQL json å’Œ hstore è³‡æ–™å‹åˆ¥</a></h4><p>Rails 4.1 å°‡ <code>json</code> å’Œ <code>hstore</code> åˆ—å°æ˜ åˆ°å­—ä¸²-keyed Ruby <code>Hash</code>ã€‚
åœ¨æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨äº† <code>HashWithIndifferentAccess</code>ã€‚é€™æ„å‘³è‘—
ä¸å†æ”¯æ´ symbol è¨ªå•ã€‚é€™ä¹Ÿé©ç”¨æ–¼
<code>store_accessors</code> æ ¹æ“š <code>json</code> æˆ– <code>hstore</code> åˆ—çš„é ‚éƒ¨ã€‚ç¢ºä¿ä½¿ç”¨
å­—ä¸² keys ä¸€è‡´ã€‚</p><h4 id="activesupport-callbacks"><a class="anchorlink" href="#activesupport-callbacks">9.15 <code>ActiveSupport::Callbacks</code> çš„é¡¯å¼å¡Šä½¿ç”¨</a></h4><p>Rails 4.1 ç¾åœ¨æœŸæœ›åœ¨å‘¼å«æ™‚å‚³éä¸€å€‹é¡¯å¼å¡Š
<code>ActiveSupport::Callbacks.set_callback</code>ã€‚é€™ç¨®è®ŠåŒ–æºæ–¼
<code>ActiveSupport::Callbacks</code> åœ¨ 4.1 ç‰ˆæœ¬ä¸­è¢«å¤§é‡é‡å¯«ã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># ä»¥å‰åœ¨ Rails 4.0</span>
<span class="n">set_callback</span> <span class="ss">:save</span><span class="p">,</span> <span class="ss">:around</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span> <span class="n">stuff</span><span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">;</span> <span class="n">stuff</span> <span class="p">}</span>

<span class="c1"># ç¾åœ¨åœ¨ Rails 4.1</span>
<span class="n">set_callback</span> <span class="ss">:save</span><span class="p">,</span> <span class="ss">:around</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span> <span class="p">{</span> <span class="n">stuff</span><span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">;</span> <span class="n">stuff</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# ä»¥å‰åœ¨ Rails 4.0
set_callback :save, :around, -&gt;(r, &amp;block) { stuff; result = block.call; stuff }

# ç¾åœ¨åœ¨ Rails 4.1
set_callback :save, :around, -&gt;(r, block) { stuff; result = block.call; stuff }
">Copy</button>
</div>
<h3 id="rails-3-2-rails-4-0"><a class="anchorlink" href="#rails-3-2-rails-4-0">10 å¾ Rails 3.2 å‡ç´šåˆ° Rails 4.0</a></h3><p>å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ç•¶å‰åœ¨ä»»ä½•æ—©æ–¼ 3.2.x çš„ Rails ç‰ˆæœ¬ä¸Šï¼Œæ‚¨æ‡‰è©²å…ˆå‡ç´šåˆ° Rails 3.2ï¼Œç„¶å¾Œå†å˜—è©¦å‡ç´šåˆ° Rails 4.0ã€‚</p><p>ä»¥ä¸‹æ›´æ”¹çš„ç›®æ¨™åœ¨æ–¼å°‡æ‚¨çš„æ‡‰ç”¨ç¨‹åºå‡ç´šåˆ° Rails 4.0ã€‚</p><h4 id="http"><a class="anchorlink" href="#http">10.1 HTTP è£œä¸</a></h4><p>Rails 4 ç¾åœ¨ä½¿ç”¨ <code>PATCH</code> ä½œç‚º RESTful æ›´æ–°çš„ä¸»è¦ HTTP å‹•è©
è³‡æºåœ¨ <code>config/routes.rb</code> ä¸­å®£å‘Šã€‚ <code>update</code> action ä»åœ¨ä½¿ç”¨ï¼Œ
ä¸¦ä¸” <code>PUT</code> è«‹æ±‚ä¹Ÿå°‡ç¹¼çºŒè·¯ç”±åˆ° <code>update</code> actionã€‚
å› æ­¤ï¼Œå¦‚æœæ‚¨åƒ…ä½¿ç”¨æ¨™æº– RESTful è·¯ç”±ï¼Œå‰‡ç„¡éœ€é€²è¡Œä»»ä½•æ›´æ”¹ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:users</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="resources :users
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="vi">@user</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= form_for @user do |f| %&gt;
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="c1"># No change needed; PATCH will be preferred, and PUT will still work.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class UsersController &lt; ApplicationController
  def update
    # No change needed; PATCH will be preferred, and PUT will still work.
  end
end
">Copy</button>
</div>
<p>ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä½¿ç”¨ <code>form_for</code> é€²è¡Œæ›´æ–°ï¼Œå‰‡éœ€è¦é€²è¡Œæ›´æ”¹
ä½¿ç”¨ <code>PUT</code> HTTP æ–¹æ³•å°‡è³‡æºèˆ‡è‡ªå®šç¾©è·¯ç”±çµåˆä½¿ç”¨ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">put</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="ss">on: :member</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="resources :users do
  put :update_name, on: :member
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="p">[</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="vi">@user</span> <span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= form_for [ :update_name, @user ] do |f| %&gt;
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">update_name</span>
    <span class="c1"># Change needed; form_for will try to use a non-existent PATCH route.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class UsersController &lt; ApplicationController
  def update_name
    # Change needed; form_for will try to use a non-existent PATCH route.
  end
end
">Copy</button>
</div>
<p>å¦‚æœå…¬å…± API ä¸­æœªä½¿ç”¨ action ä¸¦ä¸”æ‚¨å¯ä»¥è‡ªç”±æ›´æ”¹
HTTP æ–¹æ³•ï¼Œæ‚¨å¯ä»¥æ›´æ–°æ‚¨çš„è·¯ç”±ä»¥ä½¿ç”¨ <code>patch</code> è€Œä¸æ˜¯ <code>put</code>ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">patch</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="ss">on: :member</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="resources :users do
  patch :update_name, on: :member
end
">Copy</button>
</div>
<p><code>PUT</code> å° Rails 4 ä¸­çš„ <code>/users/:id</code> çš„è«‹æ±‚è¢«è·¯ç”±åˆ° <code>update</code>ï¼Œå› ç‚ºå®ƒå€‘æ˜¯
ä»Šå¤©ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æœ‰ä¸€å€‹å¯ä»¥ç²å–çœŸå¯¦ PUT è«‹æ±‚çš„ APIï¼Œå®ƒå°±æœƒèµ·ä½œç”¨ã€‚
è·¯ç”±å™¨é‚„å°‡ <code>PATCH</code> è«‹æ±‚è·¯ç”±åˆ° <code>/users/:id</code> åˆ° <code>update</code> actionã€‚</p><p>å¦‚æœåœ¨å…¬å…± API ä¸­ä½¿ç”¨ action ä¸¦ä¸”æ‚¨ç„¡æ³•æ›´æ”¹ç‚º HTTP æ–¹æ³•
æ­£åœ¨ä½¿ç”¨ï¼Œæ‚¨å¯ä»¥æ›´æ–°è¡¨å–®ä»¥ä½¿ç”¨ <code>PUT</code> æ–¹æ³•ï¼š</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="p">[</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="vi">@user</span> <span class="p">],</span> <span class="ss">method: :put</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= form_for [ :update_name, @user ], method: :put do |f| %&gt;
">Copy</button>
</div>
<p>æœ‰é—œ PATCH çš„æ›´å¤šè³‡è¨Šä»¥åŠé€²è¡Œæ­¤æ›´æ”¹çš„åŸå› ï¼Œè«‹åƒé–± <a href="https://weblog.rubyonrails.org/2012/2/26/edge-rails-patch-is-the-new-primary-http-method-for-updates/">é€™ç¯‡æ–‡ç« </a>
åœ¨ Rails éƒ¨è½æ ¼ä¸Šã€‚</p><h5 id=""><a class="anchorlink" href="#">10.1.1 é—œæ–¼åª’é«”å‹åˆ¥çš„èªªæ˜</a></h5><p><code>PATCH</code> å‹•è©çš„å‹˜èª¤è¡¨ <a href="http://www.rfc-editor.org/errata_search.php?rfc=5789">æŒ‡å®š'diff' åª’é«”å‹åˆ¥æ‡‰è©²æ˜¯
èˆ‡ <code>PATCH</code> ä¸€èµ·ä½¿ç”¨</a>ã€‚ä¸€
é€™ç¨®æ ¼å¼æ˜¯<a href="https://tools.ietf.org/html/rfc6902">JSON Patch</a>ã€‚è€Œ Rails
æœ¬èº«ä¸æ”¯æ´ JSON Patchï¼Œæ–°å¢æ”¯æ´å¾ˆå®¹æ˜“ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># åœ¨æ‚¨çš„ controller ä¸­ï¼š</span>
<span class="k">def</span> <span class="nf">update</span>
  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
    <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="k">do</span>
      <span class="c1"># perform a partial update</span>
      <span class="vi">@article</span><span class="p">.</span><span class="nf">update</span> <span class="n">params</span><span class="p">[</span><span class="ss">:article</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="nb">format</span><span class="p">.</span><span class="nf">json_patch</span> <span class="k">do</span>
      <span class="c1"># perform sophisticated change</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# åœ¨æ‚¨çš„ controller ä¸­ï¼š
def update
  respond_to do |format|
    format.json do
      # perform a partial update
      @article.update params[:article]
    end

    format.json_patch do
      # perform sophisticated change
    end
  end
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/json_patch.rb</span>
<span class="no">Mime</span><span class="o">::</span><span class="no">Type</span><span class="p">.</span><span class="nf">register</span> <span class="s1">'application/json-patch+json'</span><span class="p">,</span> <span class="ss">:json_patch</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/initializers/json_patch.rb
Mime::Type.register 'application/json-patch+json', :json_patch
">Copy</button>
</div>
<p>ç”±æ–¼ JSON Patch æœ€è¿‘æ‰è¢«è£½ä½œæˆ RFCï¼Œæ‰€ä»¥æ²’æœ‰å¾ˆå¤šå¾ˆæ£’çš„
Ruby åº«é‚„æ²’æœ‰ã€‚äºå€«å¸•ç‰¹æ£®çš„
<a href="https://github.com/tenderlove/hana">hana</a> å°±æ˜¯é€™æ¨£ä¸€ç¨®å¯¶çŸ³ï¼Œä½†æ²’æœ‰
å®Œå…¨æ”¯æ´è¦ç¯„ä¸­çš„æœ€å¾Œå¹¾å€‹æ›´æ”¹ã€‚</p><h4 id="rails-3-2-rails-4-0-gemfile"><a class="anchorlink" href="#rails-3-2-rails-4-0-gemfile">10.2 Gemfile</a></h4><p>Rails 4.0 å¾ <code>Gemfile</code> ä¸­åˆªé™¤äº† <code>assets</code> çµ„ã€‚ä½ éœ€è¦åˆªé™¤å®ƒ
å‡ç´šæ™‚å¾ <code>Gemfile</code> è¡Œã€‚æ‚¨é‚„æ‡‰è©²æ›´æ–°æ‚¨çš„æ‡‰ç”¨ç¨‹å¼
æª”æ¡ˆï¼ˆåœ¨ <code>config/application.rb</code> ä¸­ï¼‰ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># éœ€è¦ Gemfile ä¸­åˆ—å‡ºçš„å¯¶çŸ³ï¼ŒåŒ…æ‹¬ä»»ä½•å¯¶çŸ³</span>
<span class="c1"># ä½ åªé™æ–¼:testã€:development æˆ–:productionã€‚</span>
<span class="no">Bundler</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="o">*</span><span class="no">Rails</span><span class="p">.</span><span class="nf">groups</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# éœ€è¦ Gemfile ä¸­åˆ—å‡ºçš„å¯¶çŸ³ï¼ŒåŒ…æ‹¬ä»»ä½•å¯¶çŸ³
# ä½ åªé™æ–¼:testã€:development æˆ–:productionã€‚
Bundler.require(*Rails.groups)
">Copy</button>
</div>
<h4 id="rails-3-2-rails-4-0-"><a class="anchorlink" href="#rails-3-2-rails-4-0-">10.3 ä¾›æ‡‰å•†/å¤–æ›</a></h4><p>Rails 4.0 ä¸å†æ”¯æ´å¾ <code>vendor/plugins</code> è¼‰å…¥å¤–æ›ã€‚æ‚¨å¿…é ˆé€šéå°‡å®ƒå€‘æå–åˆ° gems ä¸¦å°‡å®ƒå€‘æ–°å¢åˆ°æ‚¨çš„ <code>Gemfile</code> ä¾†æ›¿æ›ä»»ä½•å¤–æ›ã€‚å¦‚æœæ‚¨é¸æ“‡ä¸è®“å®ƒå€‘æˆç‚ºå¯¶çŸ³ï¼Œæ‚¨å¯ä»¥å°‡å®ƒå€‘ç§»å‹•åˆ° <code>lib/my_plugin/*</code> ä¸­ï¼Œä¸¦åœ¨ <code>config/initializers/my_plugin.rb</code> ä¸­æ–°å¢é©ç•¶çš„åˆå§‹åŒ–ç¨‹å¼ã€‚</p><h4 id="rails-3-2-rails-4-0-active-record"><a class="anchorlink" href="#rails-3-2-rails-4-0-active-record">10.4 Active Record</a></h4>
<ul>
<li><p>Rails 4.0 å·²ç¶“å¾ Active Record ä¸­åˆªé™¤äº†èº«ä»½å°æ˜ ï¼Œå› ç‚º<a href="https://github.com/rails/rails/commit/302c912bf6bcd0fa200d964ec2dc4a44abe328a6">èˆ‡ associations çš„ä¸€äº›ä¸ä¸€è‡´</a>ã€‚å¦‚æœæ‚¨å·²åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­æ‰‹å‹•å•Ÿç”¨å®ƒï¼Œå‰‡å¿…é ˆåˆªé™¤ä»¥ä¸‹ä¸å†èµ·ä½œç”¨çš„è¨­å®šï¼š<code>config.active_record.identity_map</code>ã€‚</p></li>
<li><p>associations é›†åˆä¸­çš„ <code>delete</code> æ–¹æ³•ç¾åœ¨å¯ä»¥æ¥æ”¶ <code>Integer</code> æˆ– <code>String</code> å¼•æ•¸ä½œç‚ºè¨˜éŒ„ IDï¼Œé™¤äº†è¨˜éŒ„ä¹‹å¤–ï¼Œèˆ‡ <code>destroy</code> æ–¹æ³•éå¸¸ç›¸ä¼¼ã€‚ä»¥å‰å®ƒç‚ºæ­¤é¡å¼•æ•¸å¼•ç™¼äº† <code>ActiveRecord::AssociationTypeMismatch</code>ã€‚å¾ Rails 4.0 é–‹å§‹ï¼Œ<code>delete</code> æœƒåœ¨åˆªé™¤ä¹‹å‰è‡ªå‹•å˜—è©¦æŸ¥è©¢èˆ‡çµ¦å®š id åŒ¹é…çš„è¨˜éŒ„ã€‚</p></li>
<li><p>åœ¨ Rails 4.0 ä¸­ï¼Œç•¶åˆ—æˆ–è¡¨è¢«é‡æ–°å‘½åæ™‚ï¼Œç›¸é—œç´¢å¼•ä¹Ÿè¢«é‡æ–°å‘½åã€‚å¦‚æœæ‚¨æœ‰é‡æ–°å‘½åç´¢å¼•çš„ migrationsï¼Œå‰‡ä¸å†éœ€è¦å®ƒå€‘ã€‚</p></li>
<li><p>Rails 4.0 å·²å°‡ <code>serialized_attributes</code> å’Œ <code>attr_readonly</code> æ›´æ”¹ç‚ºåƒ…é¡æ–¹æ³•ã€‚æ‚¨ä¸æ‡‰è©²ä½¿ç”¨å¯¦ä¾‹æ–¹æ³•ï¼Œå› ç‚ºå®ƒç¾åœ¨å·²è¢«æ£„ç”¨ã€‚æ‚¨æ‡‰è©²å°‡å®ƒå€‘æ›´æ”¹ç‚ºä½¿ç”¨é¡æ–¹æ³•ï¼Œä¾‹å¦‚<code>self.serialized_attributes</code> åˆ° <code>self.class.serialized_attributes</code>ã€‚</p></li>
<li><p>ä½¿ç”¨é è¨­ç·¨ç¢¼å™¨æ™‚ï¼Œå°‡ <code>nil</code> åˆ†é…çµ¦åºåˆ—åŒ–å±¬æ€§å°‡å„²å­˜å®ƒ
åˆ°è³‡æ–™åº«ä½œç‚º <code>NULL</code> è€Œä¸æ˜¯é€šé YAML (<code>"--- \n...\n"</code>) å‚³é <code>nil</code> valueã€‚</p></li>
<li><p>Rails 4.0 åˆªé™¤äº† <code>attr_accessible</code> å’Œ <code>attr_protected</code> åŠŸèƒ½ï¼Œæ”¯æ´å¼·å¼•æ•¸ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ <a href="https://github.com/rails/protected_attributes">Protected Attributes gem</a> ç²å¾—å¹³æ»‘çš„å‡ç´šè·¯å¾‘ã€‚</p></li>
<li><p>å¦‚æœæ‚¨æ²’æœ‰ä½¿ç”¨å—ä¿è­·çš„å±¬æ€§ï¼Œæ‚¨å¯ä»¥åˆªé™¤ä»»ä½•ç›¸é—œçš„é¸é …
é€™å€‹ gem å¦‚ <code>whitelist_attributes</code> æˆ– <code>mass_assignment_sanitizer</code> é¸é …ã€‚</p></li>
<li>
<p>Rails 4.0 è¦æ±‚ä½œç”¨åŸŸä½¿ç”¨å¯å‘¼å«ç‰©ä»¶ï¼Œä¾‹å¦‚ Proc æˆ– lambdaï¼š</p>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="n">where</span><span class="p">(</span><span class="ss">active: </span><span class="kp">true</span><span class="p">)</span>

  <span class="c1"># becomes</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="  scope :active, where(active: true)

  # becomes
  scope :active, -&gt; { where active: true }
">Copy</button>
</div>
</li>
<li><p>Rails 4.0 å·²æ£„ç”¨ <code>ActiveRecord::Fixtures</code> è€Œæ”¯æ´ <code>ActiveRecord::FixtureSet</code>ã€‚</p></li>
<li><p>Rails 4.0 å·²æ£„ç”¨ <code>ActiveRecord::TestCase</code> è€Œæ”¯æ´ <code>ActiveSupport::TestCase</code>ã€‚</p></li>
<li><p>Rails 4.0 å·²æ£„ç”¨èˆŠå¼æ ¹æ“šé›œæ¹Šçš„æŸ¥è©¢å™¨ APIã€‚é€™æ„å‘³è‘—
ä»¥å‰æ¥å—â€œæŸ¥è©¢å™¨é¸é …â€çš„æ–¹æ³•ä¸å†é©ç”¨ã€‚ä¾‹å¦‚ï¼Œ<code>Book.find(:all, conditions: { name: '1984' })</code> å·²è¢«æ£„ç”¨ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ <code>Book.where(name: '1984')</code></p></li>
<li>
<p>é™¤ <code>find_by_...</code> å’Œ <code>find_by_...!</code> ä¹‹å¤–çš„æ‰€æœ‰å‹•æ…‹æ–¹æ³•å‡å·²æ£„ç”¨ã€‚
ä»¥ä¸‹æ˜¯è™•ç†æ›´æ”¹çš„æ–¹æ³•ï¼š</p>
<ul>
<li>
<code>find_all_by_...</code> è®Šæˆ <code>where(...)</code>ã€‚</li>
<li>
<code>find_last_by_...</code> è®Šæˆ <code>where(...).last</code>ã€‚</li>
<li>
<code>scoped_by_...</code> è®Šæˆ <code>where(...)</code>ã€‚</li>
<li>
<code>find_or_initialize_by_...</code> è®Šæˆ <code>find_or_initialize_by(...)</code>ã€‚</li>
<li>
<code>find_or_create_by_...</code> è®Šæˆ <code>find_or_create_by(...)</code>ã€‚</li>
</ul>
</li>
<li><p>è«‹æ³¨æ„ï¼Œ<code>where(...)</code> è¿”å›ä¸€å€‹é—œä¿‚ï¼Œè€Œä¸æ˜¯åƒèˆŠæŸ¥è©¢å™¨é‚£æ¨£çš„é™£åˆ—ã€‚å¦‚æœæ‚¨éœ€è¦ <code>Array</code>ï¼Œè«‹ä½¿ç”¨ <code>where(...).to_a</code>ã€‚</p></li>
<li><p>é€™äº›ç­‰æ•ˆæ–¹æ³•å¯èƒ½ä¸æœƒåŸ·è¡Œèˆ‡å…ˆå‰å¯¦ç¾ç›¸åŒçš„ SQLã€‚</p></li>
<li><p>è¦é‡æ–°å•Ÿç”¨èˆŠçš„æŸ¥è©¢å™¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <a href="https://github.com/rails/activerecord-deprecated_finders">activerecord-deprecated_finders gem</a>ã€‚</p></li>
<li>
<p>Rails 4.0 å·²æ›´æ”¹ç‚º <code>has_and_belongs_to_many</code> é—œä¿‚çš„é è¨­é€£ç·šè¡¨ï¼Œä»¥å»é™¤ç¬¬äºŒå€‹è¡¨åçš„å…¬å…±å­—é¦–ã€‚å¿…é ˆä½¿ç”¨ <code>join_table</code> é¸é …æŒ‡å®š models èˆ‡å…¬å…±å­—é¦–ä¹‹é–“çš„ä»»ä½•ç¾æœ‰ <code>has_and_belongs_to_many</code> é—œä¿‚ã€‚ä¾‹å¦‚ï¼š</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="no">CatalogCategory</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:catalog_products</span><span class="p">,</span> <span class="ss">join_table: </span><span class="s1">'catalog_categories_catalog_products'</span>
<span class="k">end</span>

<span class="no">CatalogProduct</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:catalog_categories</span><span class="p">,</span> <span class="ss">join_table: </span><span class="s1">'catalog_categories_catalog_products'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="CatalogCategory &lt; ActiveRecord::Base
  has_and_belongs_to_many :catalog_products, join_table: 'catalog_categories_catalog_products'
end

CatalogProduct &lt; ActiveRecord::Base
  has_and_belongs_to_many :catalog_categories, join_table: 'catalog_categories_catalog_products'
end
">Copy</button>
</div>
</li>
<li><p>æ³¨æ„å­—é¦–ä¹Ÿè€ƒæ…®äº†ä½œç”¨åŸŸï¼Œæ‰€ä»¥ <code>Catalog::Category</code> å’Œ <code>Catalog::Product</code> æˆ– <code>Catalog::Category</code> å’Œ <code>CatalogProduct</code> ä¹‹é–“çš„é—œä¿‚éœ€è¦é¡ä¼¼åœ°æ›´æ–°ã€‚</p></li>
</ul>
<h4 id=""><a class="anchorlink" href="#">10.5 æ´»å‹•è³‡æº</a></h4><p>Rails 4.0 å°‡ Active Resource æå–åˆ°è‡ªå·±çš„ gem ä¸­ã€‚å¦‚æœæ‚¨ä»ç„¶éœ€è¦è©²åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥åœ¨æ‚¨çš„ <code>Gemfile</code> ä¸­æ–°å¢ <a href="https://github.com/rails/activeresource">Active Resource gem</a>ã€‚</p><h4 id="active-model"><a class="anchorlink" href="#active-model">10.6 Active Model</a></h4>
<ul>
<li><p>Rails 4.0 æ”¹è®Šäº†éŒ¯èª¤é™„åŠ åˆ° <code>ActiveModel::Validations::ConfirmationValidator</code> çš„æ–¹å¼ã€‚ç¾åœ¨ï¼Œç•¶ç¢ºèªé©—è­‰å¤±æ•—æ™‚ï¼ŒéŒ¯èª¤å°‡é™„åŠ åˆ° <code>:#{attribute}_confirmation</code> è€Œä¸æ˜¯ <code>attribute</code>ã€‚</p></li>
<li>
<p>Rails 4.0 å·²å°‡ <code>ActiveModel::Serializers::JSON.include_root_in_json</code> é è¨­ value æ›´æ”¹ç‚º <code>false</code>ã€‚ç¾åœ¨ï¼ŒActive Model Serializers å’Œ Active Record ç‰©ä»¶å…·æœ‰ç›¸åŒçš„é è¨­è¡Œç‚ºã€‚é€™æ„å‘³è‘—æ‚¨å¯ä»¥åœ¨ <code>config/initializers/wrap_parameters.rb</code> æª”æ¡ˆä¸­è¨»é‡‹æˆ–åˆªé™¤ä»¥ä¸‹é¸é …ï¼š</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Disable root element in JSON by default.</span>
<span class="c1"># ActiveSupport.on_load(:active_record) do</span>
<span class="c1">#   self.include_root_in_json = false</span>
<span class="c1"># end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Disable root element in JSON by default.
# ActiveSupport.on_load(:active_record) do
#   self.include_root_in_json = false
# end
">Copy</button>
</div>
</li>
</ul>
<h4 id="action-pack"><a class="anchorlink" href="#action-pack">10.7 Action Pack</a></h4>
<ul>
<li>
<p>Rails 4.0 å¼•å…¥äº† <code>ActiveSupport::KeyGenerator</code> ä¸¦å°‡å…¶ç”¨ä½œç”¢ç”Ÿå’Œé©—è­‰å·²ç°½åçš„ cookiesï¼ˆé™¤å…¶ä»–å¤–ï¼‰çš„åŸºç¤ã€‚å¦‚æœæ‚¨ä¿ç•™ç¾æœ‰çš„ <code>secret_token</code> ä¸¦æ–°å¢æ–°çš„ <code>secret_key_base</code>ï¼Œå‰‡ä½¿ç”¨ Rails 3.x ç”¢ç”Ÿçš„ç¾æœ‰ç°½å cookies å°‡é€æ˜å‡ç´šã€‚</p>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="c1"># config/initializers/secret_token.rb</span>
  <span class="no">Myapp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">secret_token</span> <span class="o">=</span> <span class="s1">'existing secret token'</span>
  <span class="no">Myapp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">secret_key_base</span> <span class="o">=</span> <span class="s1">'new secret key base'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="  # config/initializers/secret_token.rb
  Myapp::Application.config.secret_token = 'existing secret token'
  Myapp::Application.config.secret_key_base = 'new secret key base'
">Copy</button>
</div>
<p>è«‹æ³¨æ„ï¼Œæ‚¨æ‡‰è©²ç­‰åˆ° Rails 4.x ä¸Šæ“æœ‰ 100% çš„ä½¿ç”¨è€…ç¾¤ä½µåˆç†ç¢ºå®šæ‚¨ä¸éœ€è¦å›æ»¾åˆ° Rails 3.x æ™‚å†è¨­å®š <code>secret_key_base</code>ã€‚é€™æ˜¯å› ç‚ºæ ¹æ“š Rails 4.x ä¸­æ–°çš„ <code>secret_key_base</code> ç°½åçš„ cookies ä¸å‘å¾Œç›¸å®¹ Rails 3.xã€‚æ‚¨å¯ä»¥éš¨æ„ä¿ç•™ç¾æœ‰çš„ <code>secret_token</code>ï¼Œè€Œä¸æ˜¯è¨­å®šæ–°çš„ <code>secret_key_base</code>ï¼Œä¸¦å¿½ç•¥æ£„ç”¨è­¦å‘Šï¼Œç›´åˆ°æ‚¨æœ‰ç†ç”±ç¢ºå®šå‡ç´šå·²å®Œæˆã€‚</p>
<p>å¦‚æœæ‚¨ä¾è³´æ–¼å¤–éƒ¨æ‡‰ç”¨ç¨‹å¼æˆ– JavaScript èƒ½å¤ è®€å– Rails æ‡‰ç”¨ç¨‹å¼çš„å·²ç°½å session cookiesï¼ˆæˆ–ä¸€èˆ¬å·²ç°½å cookiesï¼‰çš„èƒ½åŠ›ï¼Œå‰‡åœ¨è§£é™¤é€™äº›å•é¡Œä¹‹å‰ä¸æ‡‰è¨­å®š <code>secret_key_base</code>ã€‚</p>
</li>
<li>
<p>å¦‚æœè¨­å®šäº† <code>secret_key_base</code>ï¼ŒRails 4.0 æœƒåŠ å¯†æ ¹æ“š cookie çš„ sessions çš„å…§å®¹ã€‚ Rails 3.x å·²ç°½åä½†æœªåŠ å¯†æ ¹æ“š cookie çš„æœƒè©±çš„å…§å®¹ã€‚ç°½åçš„ cookies æ˜¯â€œå®‰å…¨çš„â€ï¼Œå› ç‚ºå®ƒå€‘ç¶“éé©—è­‰æ˜¯ç”±æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ç”¢ç”Ÿçš„ä¸¦ä¸”æ˜¯é˜²ç¯¡æ”¹çš„ã€‚ä½†æ˜¯ï¼Œçµ‚ç«¯ä½¿ç”¨è€…å¯ä»¥å°å…§å®¹é€²è¡Œ viewedï¼Œä¸¦ä¸”å°å…§å®¹é€²è¡ŒåŠ å¯†å¯ä»¥æ¶ˆé™¤é€™ç¨®è­¦å‘Š/æ“”æ†‚ï¼Œè€Œä¸æœƒé¡¯è‘—é™ä½æ•ˆèƒ½ã€‚</p>
<p>è«‹é–±è®€ <a href="https://github.com/rails/rails/pull/9978">Pull Request #9978</a> ä»¥ç­è§£æœ‰é—œé·ç§»åˆ°åŠ å¯† session cookies çš„è©³ç´°è³‡è¨Šã€‚</p>
</li>
<li><p>Rails 4.0 åˆªé™¤äº† <code>ActionController::Base.asset_path</code> é¸é …ã€‚ä½¿ç”¨è³‡ç”¢ç®¡é“åŠŸèƒ½ã€‚</p></li>
<li><p>Rails 4.0 å·²æ£„ç”¨ <code>ActionController::Base.page_cache_extension</code> é¸é …ã€‚è«‹æ”¹ç”¨ <code>ActionController::Base.default_static_extension</code>ã€‚</p></li>
<li><p>Rails 4.0 å¾ Action Pack ä¸­ç§»é™¤äº† Action å’Œé é¢å¿«å–ã€‚æ‚¨éœ€è¦æ–°å¢ <code>actionpack-action_caching</code> gem æ‰èƒ½åœ¨ controllers ä¸­ä½¿ç”¨ <code>caches_action</code> å’Œ <code>actionpack-page_caching</code> ä»¥ä½¿ç”¨ <code>caches_page</code>ã€‚</p></li>
<li><p>Rails 4.0 ç§»é™¤äº† XML å¼•æ•¸è§£æå™¨ã€‚å¦‚æœæ‚¨éœ€è¦æ­¤åŠŸèƒ½ï¼Œå‰‡éœ€è¦æ–°å¢ <code>actionpack-xml_parser</code> gemã€‚</p></li>
<li><p>Rails 4.0 ä½¿ç”¨ symbols æˆ–è¿”å› nil çš„éç¨‹æ›´æ”¹äº†é è¨­çš„ <code>layout</code> æŸ¥è©¢é›†ã€‚è¦ç²å¾—â€œç„¡ä½ˆå±€â€è¡Œç‚ºï¼Œè«‹è¿”å› false è€Œä¸æ˜¯ nilã€‚</p></li>
<li><p>Rails 4.0 å°‡é è¨­çš„ memcached å®¢æˆ¶ç«¯å¾ <code>memcache-client</code> æ›´æ”¹ç‚º <code>dalli</code>ã€‚è¦å‡ç´šï¼Œåªéœ€å°‡ <code>gem 'dalli'</code> æ–°å¢åˆ°æ‚¨çš„ <code>Gemfile</code>ã€‚</p></li>
<li><p>Rails 4.0 æ£„ç”¨äº† controllers ä¸­çš„ <code>dom_id</code> å’Œ <code>dom_class</code> æ–¹æ³•ï¼ˆå®ƒå€‘åœ¨ views ä¸­å¾ˆå¥½ï¼‰ã€‚æ‚¨éœ€è¦åœ¨éœ€è¦æ­¤åŠŸèƒ½çš„ controllers ä¸­åŒ…å« <code>ActionView::RecordIdentifier</code> moduleã€‚</p></li>
<li><p>Rails 4.0 æ£„ç”¨äº† <code>link_to</code> helper çš„ <code>:confirm</code> é¸é …ã€‚ä½ æ‡‰è©²
è€Œæ˜¯ä¾è³´æ–¼è³‡æ–™å±¬æ€§ï¼ˆä¾‹å¦‚ <code>data: { confirm: 'Are you sure?' }</code>ï¼‰ã€‚
æ­¤æ£„ç”¨é‚„æ¶‰åŠæ ¹æ“šæ­¤çš„ helpersï¼ˆä¾‹å¦‚ <code>link_to_if</code>
æˆ– <code>link_to_unless</code>ï¼‰ã€‚</p></li>
<li><p>Rails 4.0 æ”¹è®Šäº† <code>assert_generates</code>ã€<code>assert_recognizes</code> å’Œ <code>assert_routing</code> çš„å·¥ä½œæ–¹å¼ã€‚ç¾åœ¨æ‰€æœ‰é€™äº›æ–·è¨€éƒ½å¼•ç™¼äº† <code>Assertion</code> è€Œä¸æ˜¯ <code>ActionController::RoutingError</code>ã€‚</p></li>
<li>
<p>å¦‚æœå®šç¾©äº†è¡çªçš„å‘½åè·¯ç”±ï¼ŒRails 4.0 æœƒå¼•ç™¼ <code>ArgumentError</code>ã€‚é€™å¯ä»¥ç”±é¡¯å¼å®šç¾©çš„å‘½åè·¯ç”±æˆ– <code>resources</code> æ–¹æ³•è§¸ç™¼ã€‚ä»¥ä¸‹æ˜¯å…©å€‹èˆ‡åç‚º <code>example_path</code> çš„è·¯ç”±è¡çªçš„ç¤ºä¾‹ï¼š</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="s1">'one'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
<span class="n">get</span> <span class="s1">'two'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="get 'one' =&gt; 'test#example', as: :example
get 'two' =&gt; 'test#example', as: :example
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">resources</span> <span class="ss">:examples</span>
<span class="n">get</span> <span class="s1">'clashing/:id'</span> <span class="o">=&gt;</span> <span class="s1">'test#example'</span><span class="p">,</span> <span class="ss">as: :example</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="resources :examples
get 'clashing/:id' =&gt; 'test#example', as: :example
">Copy</button>
</div>
<p>åœ¨ç¬¬ä¸€ç¨®æƒ…æ³ä¸‹ï¼Œæ‚¨å¯ä»¥ç°¡å–®åœ°é¿å…å°å¤šå€‹ä½¿ç”¨ç›¸åŒçš„åç¨±
è·¯ç·šã€‚åœ¨ç¬¬äºŒç¨®ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æä¾›çš„ <code>only</code> æˆ– <code>except</code> é¸é …
<code>resources</code> æ–¹æ³•ä¾†é™åˆ¶å»ºç«‹çš„è·¯ç”±ï¼Œè©³è¦‹
<a href="routing.html#restricting-the-routes-created">è·¯ç”±æŒ‡å—</a>ã€‚</p>
</li>
<li>
<p>Rails 4.0 ä¹Ÿæ”¹è®Šäº† unicode å­—å…ƒè·¯å¾‘çš„ç¹ªè£½æ–¹å¼ã€‚ç¾åœ¨æ‚¨å¯ä»¥ç›´æ¥ç¹ªè£½ unicode å­—å…ƒè·¯ç”±ã€‚å¦‚æœæ‚¨å·²ç¶“ç¹ªè£½äº†æ­¤é¡è·¯ç·šï¼Œå‰‡å¿…é ˆå°å…¶é€²è¡Œæ›´æ”¹ï¼Œä¾‹å¦‚ï¼š</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="s1">'ã“ã‚“ã«ã¡ã¯'</span><span class="p">),</span> <span class="ss">controller: </span><span class="s1">'welcome'</span><span class="p">,</span> <span class="ss">action: </span><span class="s1">'index'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="get Rack::Utils.escape('ã“ã‚“ã«ã¡ã¯'), controller: 'welcome', action: 'index'
">Copy</button>
</div>
<p>è®Šæˆ</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="s1">'ã“ã‚“ã«ã¡ã¯'</span><span class="p">,</span> <span class="ss">controller: </span><span class="s1">'welcome'</span><span class="p">,</span> <span class="ss">action: </span><span class="s1">'index'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="get 'ã“ã‚“ã«ã¡ã¯', controller: 'welcome', action: 'index'
">Copy</button>
</div>
</li>
<li>
<p>Rails 4.0 è¦æ±‚ä½¿ç”¨ <code>match</code> çš„è·¯ç”±å¿…é ˆæŒ‡å®šè«‹æ±‚æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="c1"># Rails 3.x</span>
  <span class="n">match</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="s1">'root#index'</span>

  <span class="c1"># becomes</span>
  <span class="n">match</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="s1">'root#index'</span><span class="p">,</span> <span class="ss">via: :get</span>

  <span class="c1"># or</span>
  <span class="n">get</span> <span class="s1">'/'</span> <span class="o">=&gt;</span> <span class="s1">'root#index'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="  # Rails 3.x
  match '/' =&gt; 'root#index'

  # becomes
  match '/' =&gt; 'root#index', via: :get

  # or
  get '/' =&gt; 'root#index'
">Copy</button>
</div>
</li>
<li>
<p>Rails 4.0 å·²åˆªé™¤ <code>ActionDispatch::BestStandardsSupport</code> ä¸­ä»‹è»Ÿé«”ï¼Œ<code>&lt;!DOCTYPE html&gt;</code> å·²æ ¹æ“š <a href="https://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx</a> è§¸ç™¼æ¨™æº–æ¨¡å¼ï¼ŒChromeFrame æ¨™é ­å·²ç§»è‡³ <code>config.action_dispatch.default_headers</code>ã€‚</p>
<p>è«‹è¨˜ä½ï¼Œæ‚¨é‚„å¿…é ˆå¾æ‡‰ç”¨ç¨‹å¼ç¨‹å¼ç¢¼ä¸­åˆªé™¤å°ä¸­ä»‹è»Ÿé«”çš„ä»»ä½•å¼•ç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Raise exception</span>
<span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span><span class="p">(</span><span class="no">Rack</span><span class="o">::</span><span class="no">Lock</span><span class="p">,</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">BestStandardsSupport</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Raise exception
config.middleware.insert_before(Rack::Lock, ActionDispatch::BestStandardsSupport)
">Copy</button>
</div>
<p>é‚„è¦æª¢æŸ¥ <code>config.action_dispatch.best_standards_support</code> çš„ç’°å¢ƒè¨­å®šä¸¦åˆªé™¤å®ƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚</p>
</li>
<li>
<p>Rails 4.0 å…è¨±é€šéè¨­å®š <code>config.action_dispatch.default_headers</code> ä¾†è¨­å®š HTTP æ¨™é ­ã€‚é è¨­å€¼å¦‚ä¸‹ï¼š</p>
<div class="code_container">
<pre><code class="highlight ruby">  <span class="n">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">default_headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'X-Frame-Options'</span> <span class="o">=&gt;</span> <span class="s1">'SAMEORIGIN'</span><span class="p">,</span>
    <span class="s1">'X-XSS-Protection'</span> <span class="o">=&gt;</span> <span class="s1">'1; mode=block'</span>
  <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="  config.action_dispatch.default_headers = {
    'X-Frame-Options' =&gt; 'SAMEORIGIN',
    'X-XSS-Protection' =&gt; '1; mode=block'
  }
">Copy</button>
</div>
<p>è«‹æ³¨æ„ï¼Œå¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä¾è³´æ–¼åœ¨ <code>&lt;frame&gt;</code> æˆ– <code>&lt;iframe&gt;</code> ä¸­è¼‰å…¥æŸäº›é é¢ï¼Œé‚£éº¼æ‚¨å¯èƒ½éœ€è¦å°‡ <code>X-Frame-Options</code> é¡¯å¼è¨­å®šç‚º <code>ALLOW-FROM ...</code> æˆ– <code>ALLOWALL</code>ã€‚</p>
</li>
<li><p>åœ¨ Rails 4.0 ä¸­ï¼Œé ç·¨è­¯è³‡ç”¢ä¸å†è‡ªå‹•å¾ <code>vendor/assets</code> å’Œ <code>lib/assets</code> è¤‡è£½é JS/CSS è³‡ç”¢ã€‚ Rails æ‡‰ç”¨å’Œå¼•æ“é–‹ç™¼è€…æ‡‰è©²å°‡é€™äº›è³‡ç”¢æ”¾åœ¨ <code>app/assets</code> æˆ–è¨­å®š <code>config.assets.precompile</code>ã€‚</p></li>
<li><p>åœ¨ Rails 4.0 ä¸­ï¼Œç•¶ action ä¸è™•ç†è«‹æ±‚æ ¼å¼æ™‚ï¼Œæœƒå¼•ç™¼ <code>ActionController::UnknownFormat</code>ã€‚é è¨­æƒ…æ³ä¸‹ï¼Œé€šéå›æ‡‰ 406 Not Acceptable ä¾†è™•ç†ç•°å¸¸ï¼Œä½†æ‚¨ç¾åœ¨å¯ä»¥è¦†è“‹å®ƒã€‚åœ¨ Rails 3 ä¸­ï¼Œç¸½æ˜¯è¿”å› 406 Not Acceptableã€‚æ²’æœ‰è¦†è“‹ã€‚</p></li>
<li><p>åœ¨ Rails 4.0 ä¸­ï¼Œç•¶ <code>ParamsParser</code> ç„¡æ³•è§£æè«‹æ±‚å¼•æ•¸æ™‚ï¼Œæœƒå¼•ç™¼é€šç”¨çš„ <code>ActionDispatch::ParamsParser::ParseError</code> ç•°å¸¸ã€‚ä¾‹å¦‚ï¼Œæ‚¨å°‡æƒ³è¦æ‹¯æ•‘é€™å€‹ç•°å¸¸è€Œä¸æ˜¯ä½ç´šåˆ¥çš„ <code>MultiJson::DecodeError</code>ã€‚</p></li>
<li><p>åœ¨ Rails 4.0 ä¸­ï¼Œç•¶å¼•æ“å®‰è£åœ¨å¾ URL å­—é¦–æä¾›çš„æ‡‰ç”¨ç¨‹å¼ä¸Šæ™‚ï¼Œ<code>SCRIPT_NAME</code> æ­£ç¢ºå·¢ç‹€ã€‚æ‚¨ä¸å†éœ€è¦è¨­å®š <code>default_url_options[:script_name]</code> ä¾†è§£æ±ºè¦†è“‹çš„ URL å­—é¦–ã€‚</p></li>
<li><p>Rails 4.0 æ£„ç”¨äº† <code>ActionController::Integration</code> è€Œæ”¯æ´ <code>ActionDispatch::Integration</code>ã€‚</p></li>
<li><p>Rails 4.0 æ£„ç”¨äº† <code>ActionController::IntegrationTest</code> è€Œæ”¯æ´ <code>ActionDispatch::IntegrationTest</code>ã€‚</p></li>
<li><p>Rails 4.0 æ£„ç”¨äº† <code>ActionController::PerformanceTest</code> è€Œæ”¯æ´ <code>ActionDispatch::PerformanceTest</code>ã€‚</p></li>
<li><p>Rails 4.0 æ£„ç”¨äº† <code>ActionController::AbstractRequest</code> è€Œæ”¯æ´ <code>ActionDispatch::Request</code>ã€‚</p></li>
<li><p>Rails 4.0 æ£„ç”¨äº† <code>ActionController::Request</code> è€Œæ”¯æ´ <code>ActionDispatch::Request</code>ã€‚</p></li>
<li><p>Rails 4.0 æ£„ç”¨äº† <code>ActionController::AbstractResponse</code> è€Œæ”¯æ´ <code>ActionDispatch::Response</code>ã€‚</p></li>
<li><p>Rails 4.0 æ£„ç”¨äº† <code>ActionController::Response</code> è€Œæ”¯æ´ <code>ActionDispatch::Response</code>ã€‚</p></li>
<li><p>Rails 4.0 æ£„ç”¨äº† <code>ActionController::Routing</code> è€Œæ”¯æ´ <code>ActionDispatch::Routing</code>ã€‚</p></li>
</ul>
<h4 id="active-support"><a class="anchorlink" href="#active-support">10.8 Active Support</a></h4><p>Rails 4.0 åˆªé™¤äº† <code>ERB::Util#json_escape</code> çš„ <code>j</code> åˆ¥åï¼Œå› ç‚º <code>j</code> å·²ç¶“ç”¨æ–¼ <code>ActionView::Helpers::JavaScriptHelper#escape_javascript</code>ã€‚</p><h5 id=""><a class="anchorlink" href="#">10.8.1 å¿«å–</a></h5><p>å¿«å–æ–¹æ³•åœ¨ Rails 3.x å’Œ 4.0 ä¹‹é–“ç™¼ç”Ÿäº†è®ŠåŒ–ã€‚æ‚¨æ‡‰è©²<a href="https://guides.rubyonrails.org/caching_with_rails.html#activesupport-cache-store">æ›´æ”¹å¿«å–åç¨±ç©ºé–“</a> ä¸¦ä½¿ç”¨å†·å¿«å–æ¨å‡ºã€‚</p><h4 id="helpers"><a class="anchorlink" href="#helpers">10.9 Helpers è¼‰å…¥é †åº</a></h4><p>å¾å¤šå€‹ç›®éŒ„è¼‰å…¥ helpers çš„é †åºåœ¨ Rails 4.0 ä¸­ç™¼ç”Ÿäº†è®ŠåŒ–ã€‚ä»¥å‰ï¼Œå®ƒå€‘è¢«æ”¶é›†èµ·ä¾†ï¼Œç„¶å¾ŒæŒ‰å­—æ¯é †åºæ’åºã€‚å‡ç´šåˆ° Rails 4.0 å¾Œï¼Œhelpers å°‡ä¿ç•™è¼‰å…¥ç›®éŒ„çš„é †åºï¼Œä¸¦ä¸”åªæœƒåœ¨æ¯å€‹ç›®éŒ„ä¸­æŒ‰å­—æ¯é †åºæ’åºã€‚é™¤éæ‚¨æ˜ç¢ºä½¿ç”¨ <code>helpers_path</code> å¼•æ•¸ï¼Œå¦å‰‡æ­¤æ›´æ”¹åªæœƒå½±éŸ¿å¾å¼•æ“è¼‰å…¥ helpers çš„æ–¹å¼ã€‚å¦‚æœæ‚¨ä¾è³´æ’åºï¼Œå‰‡æ‡‰æª¢æŸ¥å‡ç´šå¾Œæ˜¯å¦æœ‰æ­£ç¢ºçš„æ–¹æ³•å¯ç”¨ã€‚å¦‚æœä½ æƒ³æ”¹è®Šå¼•æ“è¼‰å…¥çš„é †åºï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>config.railties_order=</code> æ–¹æ³•ã€‚</p><h4 id="active-record-observer-action-controller-sweeper"><a class="anchorlink" href="#active-record-observer-action-controller-sweeper">10.10 Active Record Observer å’Œ Action Controller Sweeper</a></h4><p><code>ActiveRecord::Observer</code> å’Œ <code>ActionController::Caching::Sweeper</code> å·²è¢«æå–åˆ° <code>rails-observers</code> gemã€‚å¦‚æœæ‚¨éœ€è¦é€™äº›åŠŸèƒ½ï¼Œæ‚¨å°‡éœ€è¦æ–°å¢ <code>rails-observers</code> gemã€‚</p><h4 id="rails"><a class="anchorlink" href="#rails">10.11 éˆè¼ª-rails</a></h4>
<ul>
<li>
<code>assets:precompile:primary</code> å’Œ <code>assets:precompile:all</code> å·²è¢«åˆªé™¤ã€‚è«‹æ”¹ç”¨ <code>assets:precompile</code>ã€‚</li>
<li>
<p>æ‡‰å°‡ <code>config.assets.compress</code> é¸é …æ›´æ”¹ç‚º <code>config.assets.js_compressor</code>ï¼Œä¾‹å¦‚ï¼š</p>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">js_compressor</span> <span class="o">=</span> <span class="ss">:uglifier</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.js_compressor = :uglifier
">Copy</button>
</div>
</li>
</ul>
<h4 id="sass-rails"><a class="anchorlink" href="#sass-rails">10.12 sass-rails</a></h4>
<ul>
<li>ä¸æ¨è–¦ä½¿ç”¨å¸¶æœ‰å…©å€‹å¼•æ•¸çš„ <code>asset-url</code>ã€‚ä¾‹å¦‚ï¼š<code>asset-url("rails.png", image)</code> è®Šç‚º <code>asset-url("rails.png")</code>ã€‚</li>
</ul>
<h3 id="rails-3-1-rails-3-2"><a class="anchorlink" href="#rails-3-1-rails-3-2">11 å¾ Rails 3.1 å‡ç´šåˆ° Rails 3.2</a></h3><p>å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ç•¶å‰åœ¨ä»»ä½•æ—©æ–¼ 3.1.x çš„ Rails ç‰ˆæœ¬ä¸Šï¼Œæ‚¨
åœ¨å˜—è©¦æ›´æ–°åˆ° Rails 3.2 ä¹‹å‰ï¼Œæ‡‰è©²å…ˆå‡ç´šåˆ° Rails 3.1ã€‚</p><p>ä»¥ä¸‹æ›´æ”¹çš„ç›®æ¨™åœ¨æ–¼å°‡æ‚¨çš„æ‡‰ç”¨ç¨‹åºå‡ç´šåˆ°æœ€æ–°ç‰ˆæœ¬
Rails çš„ 3.2.x ç‰ˆæœ¬ã€‚</p><h4 id="rails-3-1-rails-3-2-gemfile"><a class="anchorlink" href="#rails-3-1-rails-3-2-gemfile">11.1 Gemfile</a></h4><p>å° <code>Gemfile</code> é€²è¡Œä»¥ä¸‹æ›´æ”¹ã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'3.2.21'</span>

<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span>   <span class="s1">'~&gt; 3.2.6'</span>
  <span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 3.2.2'</span>
  <span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span>     <span class="s1">'&gt;= 1.0.3'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="gem 'rails', '3.2.21'

group :assets do
  gem 'sass-rails',   '~&gt; 3.2.6'
  gem 'coffee-rails', '~&gt; 3.2.2'
  gem 'uglifier',     '&gt;= 1.0.3'
end
">Copy</button>
</div>
<h4 id="rails-3-1-rails-3-2-development-rb"><a class="anchorlink" href="#rails-3-1-rails-3-2-development-rb">11.2 è¨­å®š/ç’°å¢ƒ/development.rb</a></h4><p>æ‚¨æ‡‰è©²å°‡å¹¾å€‹æ–°çš„è¨­å®šè¨­å®šæ–°å¢åˆ°æ‚¨çš„é–‹ç™¼ç’°å¢ƒä¸­ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># å° Active Record models çš„æ‰¹é‡è³¦å€¼ä¿è­·å¼•ç™¼ç•°å¸¸</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">mass_assignment_sanitizer</span> <span class="o">=</span> <span class="ss">:strict</span>

<span class="c1"># è¨˜éŒ„æŸ¥è©¢æ™‚é–“è¶…éé€™å€‹çš„æŸ¥è©¢è¨ˆåŠƒï¼ˆæœ‰æ•ˆ</span>
<span class="c1"># ä½¿ç”¨ SQLiteã€MySQL å’Œ PostgreSQL)</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">auto_explain_threshold_in_seconds</span> <span class="o">=</span> <span class="mf">0.5</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# å° Active Record models çš„æ‰¹é‡è³¦å€¼ä¿è­·å¼•ç™¼ç•°å¸¸
config.active_record.mass_assignment_sanitizer = :strict

# è¨˜éŒ„æŸ¥è©¢æ™‚é–“è¶…éé€™å€‹çš„æŸ¥è©¢è¨ˆåŠƒï¼ˆæœ‰æ•ˆ
# ä½¿ç”¨ SQLiteã€MySQL å’Œ PostgreSQL)
config.active_record.auto_explain_threshold_in_seconds = 0.5
">Copy</button>
</div>
<h4 id="rails-3-1-rails-3-2-test-rb"><a class="anchorlink" href="#rails-3-1-rails-3-2-test-rb">11.3 è¨­å®š/ç’°å¢ƒ/test.rb</a></h4><p><code>mass_assignment_sanitizer</code> è¨­å®šè¨­å®šä¹Ÿæ‡‰è©²æ–°å¢åˆ° <code>config/environments/test.rb</code>ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># å° Active Record models çš„æ‰¹é‡è³¦å€¼ä¿è­·å¼•ç™¼ç•°å¸¸</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">mass_assignment_sanitizer</span> <span class="o">=</span> <span class="ss">:strict</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# å° Active Record models çš„æ‰¹é‡è³¦å€¼ä¿è­·å¼•ç™¼ç•°å¸¸
config.active_record.mass_assignment_sanitizer = :strict
">Copy</button>
</div>
<h4 id="rails-3-1-rails-3-2"><a class="anchorlink" href="#rails-3-1-rails-3-2">11.4 ä¾›æ‡‰å•†/å¤–æ›</a></h4><p>Rails 3.2 æ£„ç”¨ <code>vendor/plugins</code> å’Œ Rails 4.0 å°‡å®Œå…¨åˆªé™¤å®ƒå€‘ã€‚é›–ç„¶ä½œç‚º Rails 3.2 å‡ç´šçš„ä¸€éƒ¨åˆ†ä¸¦ä¸æ˜¯çµ•å°å¿…è¦çš„ï¼Œä½†æ‚¨å¯ä»¥é€šéå°‡å®ƒå€‘æå–åˆ° gem ä¸¦å°‡å®ƒå€‘æ–°å¢åˆ°æ‚¨çš„ <code>Gemfile</code> ä¾†é–‹å§‹æ›¿æ›ä»»ä½•å¤–æ›ã€‚å¦‚æœæ‚¨é¸æ“‡ä¸è®“å®ƒå€‘æˆç‚ºå¯¶çŸ³ï¼Œæ‚¨å¯ä»¥å°‡å®ƒå€‘ç§»å‹•åˆ° <code>lib/my_plugin/*</code> ä¸­ï¼Œä¸¦åœ¨ <code>config/initializers/my_plugin.rb</code> ä¸­æ–°å¢é©ç•¶çš„åˆå§‹åŒ–ç¨‹å¼ã€‚</p><h4 id="rails-3-1-rails-3-2-active-record"><a class="anchorlink" href="#rails-3-1-rails-3-2-active-record">11.5 Active Record</a></h4><p>é¸é … <code>:dependent =&gt; :restrict</code> å·²å¾ <code>belongs_to</code> ä¸­åˆªé™¤ã€‚å¦‚æœä½ æƒ³é˜»æ­¢åˆªé™¤ç‰©ä»¶ï¼Œå¦‚æœæœ‰ä»»ä½•é—œè¯ç‰©ä»¶ï¼Œä½ å¯ä»¥è¨­å®š <code>:dependent =&gt; :destroy</code> ä¸¦åœ¨å¾ä»»ä½•é—œè¯ç‰©ä»¶çš„éŠ·ç‡¬ callbacks æª¢æŸ¥æ˜¯å¦å­˜åœ¨ association å¾Œè¿”å› <code>false</code>ã€‚</p><h3 id="rails-3-0-rails-3-1"><a class="anchorlink" href="#rails-3-0-rails-3-1">12 å¾ Rails 3.0 å‡ç´šåˆ° Rails 3.1</a></h3><p>å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ç•¶å‰åœ¨ä»»ä½•æ—©æ–¼ 3.0.x çš„ Rails ç‰ˆæœ¬ä¸Šï¼Œæ‚¨æ‡‰è©²åœ¨å˜—è©¦æ›´æ–°åˆ° Rails 3.1 ä¹‹å‰å‡ç´šåˆ° Rails 3.0ã€‚</p><p>ä»¥ä¸‹æ›´æ”¹çš„ç›®æ¨™åœ¨æ–¼å°‡æ‚¨çš„æ‡‰ç”¨ç¨‹åºå‡ç´šåˆ° Rails 3.1.12ï¼Œå³ Rails çš„æœ€å¾Œä¸€å€‹ 3.1.x ç‰ˆæœ¬ã€‚</p><h4 id="gemfile"><a class="anchorlink" href="#gemfile">12.1 Gemfile</a></h4><p>å° <code>Gemfile</code> é€²è¡Œä»¥ä¸‹æ›´æ”¹ã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'3.1.12'</span>
<span class="n">gem</span> <span class="s1">'mysql2'</span>

<span class="c1"># æ–°çš„ asset pipeline éœ€è¦</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span>   <span class="s1">'~&gt; 3.1.7'</span>
  <span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 3.1.1'</span>
  <span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span>     <span class="s1">'&gt;= 1.0.3'</span>
<span class="k">end</span>

<span class="c1"># jQuery æ˜¯ Rails 3.1 ä¸­é è¨­çš„ JavaScript åº«</span>
<span class="n">gem</span> <span class="s1">'jquery-rails'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="gem 'rails', '3.1.12'
gem 'mysql2'

# æ–°çš„ asset pipeline éœ€è¦
group :assets do
  gem 'sass-rails',   '~&gt; 3.1.7'
  gem 'coffee-rails', '~&gt; 3.1.1'
  gem 'uglifier',     '&gt;= 1.0.3'
end

# jQuery æ˜¯ Rails 3.1 ä¸­é è¨­çš„ JavaScript åº«
gem 'jquery-rails'
">Copy</button>
</div>
<h4 id="config-application-rb"><a class="anchorlink" href="#config-application-rb">12.2 config/application.rb</a></h4><p>asset pipeline éœ€è¦æ–°å¢ä»¥ä¸‹å…§å®¹ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">version</span> <span class="o">=</span> <span class="s1">'1.0'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.assets.enabled = true
config.assets.version = '1.0'
">Copy</button>
</div>
<p>å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼å°è³‡æºä½¿ç”¨â€œ/assetsâ€è·¯ç”±ï¼Œæ‚¨å¯èƒ½éœ€è¦æ›´æ”¹ç”¨æ–¼è³‡ç”¢çš„å­—é¦–ä»¥é¿å…è¡çªï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># é è¨­ç‚º'/assets'</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">prefix</span> <span class="o">=</span> <span class="s1">'/asset-files'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# é è¨­ç‚º'/assets'
config.assets.prefix = '/asset-files'
">Copy</button>
</div>
<h4 id="rails-3-0-rails-3-1-development-rb"><a class="anchorlink" href="#rails-3-0-rails-3-1-development-rb">12.3 è¨­å®š/ç’°å¢ƒ/development.rb</a></h4><p>åˆªé™¤ RJS è¨­å®š <code>config.action_view.debug_rjs = true</code>ã€‚</p><p>å¦‚æœå•Ÿç”¨ asset pipelineï¼Œè«‹æ–°å¢é€™äº›è¨­å®šï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># ä¸å£“ç¸®è³‡ç”¢</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compress</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># å±•é–‹è¼‰å…¥è³‡ç”¢çš„è¡Œ</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">debug</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# ä¸å£“ç¸®è³‡ç”¢
config.assets.compress = false

# å±•é–‹è¼‰å…¥è³‡ç”¢çš„è¡Œ
config.assets.debug = true
">Copy</button>
</div>
<h4 id="config-environments-production-rb"><a class="anchorlink" href="#config-environments-production-rb">12.4 config/environments/production.rb</a></h4><p>åŒæ¨£ï¼Œä¸‹é¢çš„å¤§éƒ¨åˆ†æ›´æ”¹éƒ½æ˜¯é‡å° asset pipeline çš„ã€‚æ‚¨å¯ä»¥åœ¨ <a href="asset_pipeline.html">Asset Pipeline</a> æŒ‡å—ä¸­é–±è®€æœ‰é—œé€™äº›çš„æ›´å¤šè³‡è¨Šã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># å£“ç¸® JavaScript å’Œ CSS</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compress</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># å¦‚æœç¼ºå°‘é ç·¨è­¯è³‡ç”¢ï¼Œä¸è¦å›é€€åˆ°è³‡ç”¢ç®¡é“</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compile</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># ç‚ºè³‡ç”¢ URL ç”¢ç”Ÿæ‘˜è¦</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">digest</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># é è¨­ç‚º Rails.root.join("public/assets")</span>
<span class="c1"># config.assets.manifest = YOUR_PATH</span>

<span class="c1"># é ç·¨è­¯é™„åŠ è³‡ç”¢ï¼ˆapplication.jsã€application.css å’Œæ‰€æœ‰é JS/CSS éƒ½å·²æ–°å¢ï¼‰</span>
<span class="c1"># config.assets.precompile += %w( admin.js admin.css )</span>

<span class="c1"># å¼·åˆ¶é€šé SSL è¨ªå•æ‡‰ç”¨ç¨‹å¼ï¼Œä½¿ç”¨ Strict-Transport-Securityï¼Œä¸¦ä½¿ç”¨å®‰å…¨çš„ cookiesã€‚</span>
<span class="c1"># config.force_ssl = true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# å£“ç¸® JavaScript å’Œ CSS
config.assets.compress = true

# å¦‚æœç¼ºå°‘é ç·¨è­¯è³‡ç”¢ï¼Œä¸è¦å›é€€åˆ°è³‡ç”¢ç®¡é“
config.assets.compile = false

# ç‚ºè³‡ç”¢ URL ç”¢ç”Ÿæ‘˜è¦
config.assets.digest = true

# é è¨­ç‚º Rails.root.join("public/assets")
# config.assets.manifest = YOUR_PATH

# é ç·¨è­¯é™„åŠ è³‡ç”¢ï¼ˆapplication.jsã€application.css å’Œæ‰€æœ‰é JS/CSS éƒ½å·²æ–°å¢ï¼‰
# config.assets.precompile += %w( admin.js admin.css )

# å¼·åˆ¶é€šé SSL è¨ªå•æ‡‰ç”¨ç¨‹å¼ï¼Œä½¿ç”¨ Strict-Transport-Securityï¼Œä¸¦ä½¿ç”¨å®‰å…¨çš„ cookiesã€‚
# config.force_ssl = true
'>Copy</button>
</div>
<h4 id="rails-3-0-rails-3-1-test-rb"><a class="anchorlink" href="#rails-3-0-rails-3-1-test-rb">12.5 è¨­å®š/ç’°å¢ƒ/test.rb</a></h4><p>æ‚¨å¯ä»¥é€šéåœ¨æ¸¬è©¦ç’°å¢ƒä¸­æ–°å¢é€™äº›å…§å®¹ä¾†å¹«åŠ©æ¸¬è©¦æ•ˆèƒ½ï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># è¨­å®šéœæ…‹è³‡æºä¼ºæœå™¨ä»¥ä½¿ç”¨ Cache-Control é€²è¡Œæ•ˆèƒ½æ¸¬è©¦</span>
<span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'Cache-Control'</span> <span class="o">=&gt;</span> <span class="s1">'public, max-age=3600'</span>
<span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# è¨­å®šéœæ…‹è³‡æºä¼ºæœå™¨ä»¥ä½¿ç”¨ Cache-Control é€²è¡Œæ•ˆèƒ½æ¸¬è©¦
config.public_file_server.enabled = true
config.public_file_server.headers = {
  'Cache-Control' =&gt; 'public, max-age=3600'
}
">Copy</button>
</div>
<h4 id="config-initializers-wrap-parameters-rb"><a class="anchorlink" href="#config-initializers-wrap-parameters-rb">12.6 config/initializers/wrap_parameters.rb</a></h4><p>å¦‚æœæ‚¨å¸Œæœ›å°‡å¼•æ•¸åŒ…è£åˆ°å·¢ç‹€é›œæ¹Šä¸­ï¼Œè«‹ä½¿ç”¨ä»¥ä¸‹å…§å®¹æ–°å¢æ­¤æª”æ¡ˆã€‚é€™åœ¨æ–°æ‡‰ç”¨ç¨‹å¼ä¸­é è¨­é–‹å•Ÿã€‚</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># ä¿®æ”¹é€™å€‹æª”æ¡ˆçš„æ™‚å€™ä¸€å®šè¦é‡å•Ÿä¼ºæœå™¨ã€‚</span>
<span class="c1"># è©²æª”æ¡ˆåŒ…å« ActionController::ParamsWrapper çš„è¨­å®š</span>
<span class="c1"># é è¨­å•Ÿç”¨ã€‚</span>

<span class="c1"># ç‚º JSON å•Ÿç”¨å¼•æ•¸åŒ…è£ã€‚æ‚¨å¯ä»¥é€šéå°‡ :format è¨­å®šç‚ºç©ºé™£åˆ—ä¾†ç¦ç”¨æ­¤åŠŸèƒ½ã€‚</span>
<span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:action_controller</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">wrap_parameters</span> <span class="ss">format: </span><span class="p">[</span><span class="ss">:json</span><span class="p">]</span>
<span class="k">end</span>

<span class="c1"># é è¨­ç¦ç”¨ JSON ä¸­çš„æ ¹å…ƒç´ ã€‚</span>
<span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:active_record</span><span class="p">)</span> <span class="k">do</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">include_root_in_json</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# ä¿®æ”¹é€™å€‹æª”æ¡ˆçš„æ™‚å€™ä¸€å®šè¦é‡å•Ÿä¼ºæœå™¨ã€‚
# è©²æª”æ¡ˆåŒ…å« ActionController::ParamsWrapper çš„è¨­å®š
# é è¨­å•Ÿç”¨ã€‚

# ç‚º JSON å•Ÿç”¨å¼•æ•¸åŒ…è£ã€‚æ‚¨å¯ä»¥é€šéå°‡ :format è¨­å®šç‚ºç©ºé™£åˆ—ä¾†ç¦ç”¨æ­¤åŠŸèƒ½ã€‚
ActiveSupport.on_load(:action_controller) do
  wrap_parameters format: [:json]
end

# é è¨­ç¦ç”¨ JSON ä¸­çš„æ ¹å…ƒç´ ã€‚
ActiveSupport.on_load(:active_record) do
  self.include_root_in_json = false
end
">Copy</button>
</div>
<h4 id="session-store-rb"><a class="anchorlink" href="#session-store-rb">12.7 è¨­å®š/åˆå§‹åŒ–ç¨‹å¼/session_store.rb</a></h4><p>æ‚¨éœ€è¦å°‡æœƒè©± key æ›´æ”¹ç‚ºæ–°çš„å…§å®¹ï¼Œæˆ–åˆªé™¤æ‰€æœ‰ sessionsï¼š</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># åœ¨ config/initializers/session_store.rb</span>
<span class="no">AppName</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">session_store</span> <span class="ss">:cookie_store</span><span class="p">,</span> <span class="ss">key: </span><span class="s1">'SOMETHINGNEW'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# åœ¨ config/initializers/session_store.rb
AppName::Application.config.session_store :cookie_store, key: 'SOMETHINGNEW'
">Copy</button>
</div>
<p>æˆ–è€…</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span>bin/rake db:sessions:clear
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rake db:sessions:clear
">Copy</button>
</div>
<h4 id="views-helpers-cache-concat"><a class="anchorlink" href="#views-helpers-cache-concat">12.8 ç§»é™¤ views ä¸­è³‡ç”¢ helpers å¼•ç”¨ä¸­çš„ :cache å’Œ :concat é¸é …</a></h4>
<ul>
<li>å°æ–¼ Asset Pipelineï¼Œä¸å†ä½¿ç”¨ :cache å’Œ :concat é¸é …ï¼Œè«‹å¾ views ä¸­åˆªé™¤é€™äº›é¸é …ã€‚</li>
</ul>


        <h3>å›é¥‹</h3>
        <p>
          æˆ‘å€‘é¼“å‹µæ‚¨å¹«åŠ©æé«˜æœ¬æŒ‡å—çš„å“è³ªã€‚
        </p>
        <p>
          å¦‚æœæ‚¨ç™¼ç¾ä»»ä½•æ‹¼å¯«éŒ¯èª¤æˆ–è³‡è¨ŠéŒ¯èª¤ï¼Œè«‹æä¾›å›é¥‹ã€‚
          è¦é–‹å§‹å›é¥‹ï¼Œæ‚¨å¯ä»¥é–±è®€æˆ‘å€‘çš„ <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">å›é¥‹</a> éƒ¨åˆ†ã€‚
        </p>
        <p>
          æ‚¨é‚„å¯èƒ½æœƒç™¼ç¾ä¸å®Œæ•´çš„å…§å®¹æˆ–ä¸æ˜¯æœ€æ–°çš„å…§å®¹ã€‚
          è«‹å‹™å¿…ç‚º main æ–°å¢ä»»ä½•éºæ¼çš„æ–‡ä»¶ã€‚å‡è¨­æ˜¯
          <a href="https://edgeguides.rubyonrails.org">éç©©å®šç‰ˆæŒ‡å—(edge guides)</a> è«‹å…ˆé©—è­‰å•é¡Œæ˜¯å¦å·²ç¶“åœ¨ä¸»åˆ†æ”¯ä¸Šè§£æ±ºã€‚
          è«‹å‰å¾€ <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails æŒ‡å—å¯«ä½œæº–å‰‡</a> æŸ¥çœ‹å¯«ä½œé¢¨æ ¼å’Œæ…£ä¾‹ã€‚
        </p>
        <p>
          å¦‚æœç”±æ–¼æŸç¨®åŸå› æ‚¨ç™¼ç¾è¦ä¿®å¾©çš„å…§å®¹ä½†ç„¡æ³•è‡ªè¡Œä¿®è£œï¼Œè«‹æ‚¨ <a href="https://github.com/rails/rails/issues">æå‡º issue</a>ã€‚
        </p>
        <p>é—œæ–¼ Ruby on Rails çš„ä»»ä½•é¡å‹çš„è¨è«–æ­¡è¿æä¾›ä»»ä½•æ–‡ä»¶è‡³ <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">rubyonrails-docs è¨è«–å€</a>ã€‚
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>æœ¬ä½œå“å·²ç²å¾—<a href="https://creativecommons.org/licenses/by-sa/4.0/">çŸ¥è­˜å…±äº«ç½²å-ç›¸åŒæ–¹å¼å…±äº« 4.0 åœ‹éš›</a>è¨±å¯</p>
<p>â€œRailsâ€ã€â€œRuby on Railsâ€å’Œ Rails æ¨™èªŒæ˜¯ David Heinemeier Hansson çš„å•†æ¨™ã€‚ ä¿ç•™æ‰€æœ‰æ¬Šåˆ©ã€‚</p>
    </div>
  </div>
</body>
</html>
