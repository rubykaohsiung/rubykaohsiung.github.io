<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Active Record Associations — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Active Record Associations — Ruby on Rails Guides" />
  <meta name="description" content="Active Record Associations本指南包含了 Active Record 的 association 功能。閱讀本指南後，您將瞭解： 如何在 Active Record models 之間宣告 associations。 如何理解各種型別的Active Record associations。 如何使用透過建立 associations 新增到 models 的方法。" />
  <meta property="og:description" content="Active Record Associations本指南包含了 Active Record 的 association 功能。閱讀本指南後，您將瞭解： 如何在 Active Record models 之間宣告 associations。 如何理解各種型別的Active Record associations。 如何使用透過建立 associations 新增到 models 的方法。" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.0</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多資訊請前往 <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        更多在 Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">部落格</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">指南</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">論壇</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">在 GitHub 上做出貢獻</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="返回首頁">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">首頁</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">手冊目錄</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>從這裡開始</dt>
                  <dd><a href="getting_started.html">Rails 入門</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record 基礎</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record 遷移 (Migrations)</a></dd>
                  <dd><a href="active_record_validations.html">Active Record 驗證 (Validations)</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record 回呼 (Callbacks)</a></dd>
                  <dd><a href="association_basics.html">Active Record 關聯 (Associations)</a></dd>
                  <dd><a href="active_record_querying.html">Active Record 查詢介面</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="layouts_and_rendering.html">Rails 中的版面配置(Layouts)和算繪(Rendering)</a></dd>
                  <dd><a href="form_helpers.html">Action View 表單 Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller 概述</a></dd>
                  <dd><a href="routing.html">Rails 從外到內路由</a></dd>
                </div>
                <div class="guides-section">
                  <dt>其他元件</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support 核心擴充套件</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer 基礎知識</a></dd>
                  <dd><a href="active_job_basics.html">Active Job 基礎</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage 概述</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable 概述</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>深入研究</dt>
                  <dd><a href="i18n.html">Rails 國際化 (I18n) API</a></dd>
                  <dd><a href="testing.html">測試 Rails 應用程式</a></dd>
                  <dd><a href="security.html">保護 Rails 應用程式</a></dd>
                  <dd><a href="debugging_rails_applications.html">除錯 Rails 應用程式</a></dd>
                  <dd><a href="configuring.html">設定 Rails 應用程式</a></dd>
                  <dd><a href="command_line.html">Rails 命令列</a></dd>
                  <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">自動載入和重新載入常量</a></dd>
                  <dd><a href="caching_with_rails.html">使用 Rails 快取</a></dd>
                  <dd><a href="api_app.html">將 Rails 用於僅 API 的應用程式</a></dd>
                </div>
                <div class="guides-section">
                  <dt>擴充 rails</dt>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">建立和自定義 Rails 產生器和模板</a></dd>
                </div>
                <div class="guides-section">
                  <dt>貢獻</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API 文件指南</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">指南指南</a></dd>
                </div>
                <div class="guides-section">
                  <dt>政策</dt>
                  <dd><a href="maintenance_policy.html">維修政策</a></dd>
                </div>
                <div class="guides-section">
                  <dt>發行說明</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</a></dd>
                  <dd><a href="6_1_release_notes.html">6.1 版 - 2020 年 12 月</a></dd>
                  <dd><a href="6_0_release_notes.html">6.0 版 - 2019 年 8 月</a></dd>
                  <dd><a href="5_2_release_notes.html">5.2 版 - 2018 年 4 月</a></dd>
                  <dd><a href="5_1_release_notes.html">5.1 版 - 2017 年 4 月</a></dd>
                  <dd><a href="5_0_release_notes.html">5.0 版 - 2016 年 6 月</a></dd>
                  <dd><a href="4_2_release_notes.html">4.2 版 - 2014 年 12 月</a></dd>
                  <dd><a href="4_1_release_notes.html">4.1 版 - 2014 年 4 月</a></dd>
                  <dd><a href="4_0_release_notes.html">4.0 版 - 2013 年 6 月</a></dd>
                  <dd><a href="3_2_release_notes.html">3.2 版 - 2012 年 1 月</a></dd>
                  <dd><a href="3_1_release_notes.html">3.1 版 - 2011 年 8 月</a></dd>
                  <dd><a href="3_0_release_notes.html">3.0 版 - 2010 年 8 月</a></dd>
                  <dd><a href="2_3_release_notes.html">2.3 版 - 2009 年 3 月</a></dd>
                  <dd><a href="2_2_release_notes.html">2.2 版 - 2008 年 11 月</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">貢獻</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">手冊目錄</option>
              <optgroup label="從這裡開始">
                  <option value="getting_started.html">Rails 入門</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record 基礎</option>
                  <option value="active_record_migrations.html">Active Record 遷移 (Migrations)</option>
                  <option value="active_record_validations.html">Active Record 驗證 (Validations)</option>
                  <option value="active_record_callbacks.html">Active Record 回呼 (Callbacks)</option>
                  <option value="association_basics.html">Active Record 關聯 (Associations)</option>
                  <option value="active_record_querying.html">Active Record 查詢介面</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Rails 中的版面配置(Layouts)和算繪(Rendering)</option>
                  <option value="form_helpers.html">Action View 表單 Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller 概述</option>
                  <option value="routing.html">Rails 從外到內路由</option>
              </optgroup>
              <optgroup label="其他元件">
                  <option value="active_support_core_extensions.html">Active Support 核心擴充套件</option>
                  <option value="action_mailer_basics.html">Action Mailer 基礎知識</option>
                  <option value="active_job_basics.html">Active Job 基礎</option>
                  <option value="active_storage_overview.html">Active Storage 概述</option>
                  <option value="action_cable_overview.html">Action Cable 概述</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="深入研究">
                  <option value="i18n.html">Rails 國際化 (I18n) API</option>
                  <option value="testing.html">測試 Rails 應用程式</option>
                  <option value="security.html">保護 Rails 應用程式</option>
                  <option value="debugging_rails_applications.html">除錯 Rails 應用程式</option>
                  <option value="configuring.html">設定 Rails 應用程式</option>
                  <option value="command_line.html">Rails 命令列</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="autoloading_and_reloading_constants.html">自動載入和重新載入常量</option>
                  <option value="caching_with_rails.html">使用 Rails 快取</option>
                  <option value="api_app.html">將 Rails 用於僅 API 的應用程式</option>
              </optgroup>
              <optgroup label="擴充 rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">建立和自定義 Rails 產生器和模板</option>
              </optgroup>
              <optgroup label="貢獻">
                  <option value="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</option>
                  <option value="api_documentation_guidelines.html">API 文件指南</option>
                  <option value="ruby_on_rails_guides_guidelines.html">指南指南</option>
              </optgroup>
              <optgroup label="政策">
                  <option value="maintenance_policy.html">維修政策</option>
              </optgroup>
              <optgroup label="發行說明">
                  <option value="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</option>
                  <option value="6_1_release_notes.html">6.1 版 - 2020 年 12 月</option>
                  <option value="6_0_release_notes.html">6.0 版 - 2019 年 8 月</option>
                  <option value="5_2_release_notes.html">5.2 版 - 2018 年 4 月</option>
                  <option value="5_1_release_notes.html">5.1 版 - 2017 年 4 月</option>
                  <option value="5_0_release_notes.html">5.0 版 - 2016 年 6 月</option>
                  <option value="4_2_release_notes.html">4.2 版 - 2014 年 12 月</option>
                  <option value="4_1_release_notes.html">4.1 版 - 2014 年 4 月</option>
                  <option value="4_0_release_notes.html">4.0 版 - 2013 年 6 月</option>
                  <option value="3_2_release_notes.html">3.2 版 - 2012 年 1 月</option>
                  <option value="3_1_release_notes.html">3.1 版 - 2011 年 8 月</option>
                  <option value="3_0_release_notes.html">3.0 版 - 2010 年 8 月</option>
                  <option value="2_3_release_notes.html">2.3 版 - 2009 年 3 月</option>
                  <option value="2_2_release_notes.html">2.2 版 - 2008 年 11 月</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Active Record Associations</h2><p>本指南包含了 Active Record 的 association 功能。</p><p>閱讀本指南後，您將瞭解：</p>
<ul>
<li>如何在 Active Record models 之間宣告 associations。</li>
<li>如何理解各種型別的Active Record associations。</li>
<li>如何使用透過建立 associations 新增到 models 的方法。</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#associations">為什麼是 Associations？</a></li>
<li>
<a href="#association">Association 的型別</a>

<ul>
<li><a href="#belongs-to-association"><code>belongs_to</code> Association</a></li>
<li><a href="#has-one-association"><code>has_one</code> Association</a></li>
<li><a href="#has-many-association"><code>has_many</code> Association</a></li>
<li><a href="#has-many-through-association"><code>has_many :through</code> Association</a></li>
<li><a href="#has-one-through-association"><code>has_one :through</code> Association</a></li>
<li><a href="#has-and-belongs-to-many-association"><code>has_and_belongs_to_many</code> Association</a></li>
<li><a href="#belongs-to-has-one">在 <code>belongs_to</code> 和 <code>has_one</code> 之間進行選擇</a></li>
<li><a href="#has-many-through-has-and-belongs-to-many">在 <code>has_many :through</code> 和 <code>has_and_belongs_to_many</code> 之間進行選擇</a></li>
<li><a href="#associations">多型 Associations</a></li>
<li><a href="#">自加入</a></li>
</ul>
</li>
<li>
<a href="#">提示、技巧和警告</a>

<ul>
<li><a href="#">控制快取</a></li>
<li><a href="#">避免名稱衝突</a></li>
<li><a href="#">更新架構</a></li>
<li><a href="#association">控制 Association 範圍</a></li>
<li><a href="#associations">雙向 Associations</a></li>
</ul>
</li>
<li>
<a href="#association">詳細的Association參考</a>

<ul>
<li><a href="#belongs-to-association"><code>belongs_to</code> Association 參考</a></li>
<li><a href="#has-one-association"><code>has_one</code> Association 參考</a></li>
<li><a href="#has-many-association"><code>has_many</code> Association 參考</a></li>
<li><a href="#has-and-belongs-to-many-association"><code>has_and_belongs_to_many</code> Association 參考</a></li>
<li><a href="#association-callbacks">Association Callbacks</a></li>
<li><a href="#association">Association 擴充套件</a></li>
</ul>
</li>
<li><a href="#sti">單表繼承 (STI)</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="associations"><a class="anchorlink" href="#associations">1 為什麼是 Associations？</a></h3><p>在 Rails 中，一個 <em>association</em> 是兩個 Active Record models 之間的連線。為什麼我們在 models 之間需要 associations？因為它們使您的程式碼中的常見操作變得更加簡單和容易。例如，考慮一個簡單的 Rails 應用程式，其中包括一個作者模型和一個書籍模型。每個作者可以擁有多本書。如果沒有 associations，模型宣告將如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
end

class Book &lt; ApplicationRecord
end
">Copy</button>
</div>
<p>現在，假設我們想為現有作者新增一本新書。我們需要做這樣的事情：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book = Book.create(published_at: Time.now, author_id: @author.id)
">Copy</button>
</div>
<p>或者考慮刪除作者，並確保其所有書籍也被刪除：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
<span class="vi">@books</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
  <span class="n">book</span><span class="p">.</span><span class="nf">destroy</span>
<span class="k">end</span>
<span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@books = Book.where(author_id: @author.id)
@books.each do |book|
  book.destroy
end
@author.destroy
">Copy</button>
</div>
<p>使用 Active Record associations，我們可以透過宣告性地告訴 Rails 兩個 models 之間存在連線來簡化這些 - 以及其他 - 操作。這是用於設定作者和書籍的修訂程式碼：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, dependent: :destroy
end

class Book &lt; ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>透過此更改，為特定作者建立新書變得更加容易：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book = @author.books.create(published_at: Time.now)
">Copy</button>
</div>
<p>刪除作者及其所有書籍<em>容易</em>得多：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.destroy
">Copy</button>
</div>
<p>要了解有關不同型別 associations 的更多資訊，請閱讀本指南的下一部分。接下來是使用 associations 的一些提示和技巧，然後是對 Rails 中 associations 的方法和選項的完整參考。</p><h3 id="association"><a class="anchorlink" href="#association">2 Association 的型別</a></h3><p>Rails 支援六種型別的 associations：</p>
<ul>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many :through</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one :through</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a></li>
</ul>
<p>Association 是使用宏樣式呼叫實現的，因此您可以宣告性地向 models 新增功能。例如，透過宣告一個模型 <code>belongs_to</code> 另一個，您指示 Rails 維護 <a href="https://en.wikipedia.org/wiki/Unique_key">Primary Key</a>-<a href="https://en.wikipedia.org/wiki/Foreign_key">Foreign Key</a> 兩個 models 實例之間的資訊，並且您還添加了您的實用方法的模型數量。</p><p>在本指南的其餘部分，您將學習如何宣告和使用各種形式的 associations。但首先，快速介紹每種關聯型別適用的情況。</p><h4 id="belongs-to-association"><a class="anchorlink" href="#belongs-to-association">2.1 <code>belongs_to</code> Association</a></h4><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a> association 與另一個 model 建立連線，這樣宣告的 model 的每個實例“屬於”另一個 model 的一個實例。例如，如果您的應用程式包含作者和書籍，並且每本書都可以分配給一個作者，那麼您可以這樣宣告書籍 model：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p><img src="images/association_basics/belongs_to.png" alt="belongs_to Association 圖"></p><div class="note"><p><code>belongs_to</code> associations <em>必須</em>使用單數術語。如果您在上述示例中對 <code>Book</code> model 中的 <code>author</code> 關聯使用複數形式，並嘗試透過 <code>Book.create(authors: @author)</code> 建立實例，則會告訴您有一個“未初始化的常量 Book::Authors”。這是因為 Rails 會自動從關聯名稱推斷類名稱。如果關聯名稱被錯誤地複數化，那麼推斷的類也會被錯誤地複數化。</p></div><p>相應的 migration 可能如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateBooks &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :authors do |t|
      t.string :name
      t.timestamps
    end

    create_table :books do |t|
      t.belongs_to :author
      t.datetime :published_at
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>單獨使用時，<code>belongs_to</code> 產生一個單向的一對一連線。因此，上例中的每本書都“知道”其作者，但作者不知道他們的書。
要設定 <a href="#bi-directional-associations">雙向關聯</a> - 將 <code>belongs_to</code> 與另一個 model 上的 <code>has_one</code> 或 <code>has_many</code> 結合使用。</p><p><code>belongs_to</code> 不保證引用一致性，因此根據用例，您可能還需要在引用列上新增資料庫級別的外部 key 約束，如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :books do |t|
  t.belongs_to :author, foreign_key: true
  # ...
end
">Copy</button>
</div>
<h4 id="has-one-association"><a class="anchorlink" href="#has-one-association">2.2 <code>has_one</code> Association</a></h4><p>A <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a> association 表示另一個 model 引用了這個 model。那個 model 可以透過這個 association 獲取。</p><p>例如，如果您的應用程式中的每個供應商只有一個帳戶，您可以像這樣宣告供應商 model：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account
end
">Copy</button>
</div>
<p>與 <code>belongs_to</code> 的主要差別在於連結列 <code>supplier_id</code> 位於另一個表中：</p><p><img src="images/association_basics/has_one.png" alt="has_one Association 圖"></p><p>相應的 migration 可能如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateSuppliers &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.belongs_to :supplier
      t.string :account_number
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>根據用例，您可能還需要建立唯一索引和/或
帳戶表的供應商列上的外部 key 約束。在這
在這種情況下，列定義可能如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">index: </span><span class="p">{</span> <span class="ss">unique: </span><span class="kp">true</span> <span class="p">},</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :accounts do |t|
  t.belongs_to :supplier, index: { unique: true }, foreign_key: true
  # ...
end
">Copy</button>
</div>
<p>當與另一個 model 上的 <code>belongs_to</code> 結合使用時，這種關係可以是 <a href="#bi-directional-associations">雙向</a>。</p><h4 id="has-many-association"><a class="anchorlink" href="#has-many-association">2.3 <code>has_many</code> Association</a></h4><p>A <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a> association 類似於 <code>has_one</code>，但表示與另一個 model 是一對多連線。您經常會在 <code>belongs_to</code> association 的“另一側”找到此 association。這個 association 表示 model 的每個實例都有零個或多個另一個 model 的實例。例如，在包含作者和書籍的應用程式中，作者 model 可以這樣宣告：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<div class="note"><p>另一個model的名字在宣告一個<code>has_many</code> association的時候是複數的。</p></div><p><img src="images/association_basics/has_many.png" alt="has_many Association 圖"></p><p>相應的 migration 可能如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAuthors</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAuthors &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :authors do |t|
      t.string :name
      t.timestamps
    end

    create_table :books do |t|
      t.belongs_to :author
      t.datetime :published_at
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>根據用例，建立非唯一索引和可選的索引通常是個好主意
書籍表的作者列上的外部 key 約束：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="create_table :books do |t|
  t.belongs_to :author, index: true, foreign_key: true
  # ...
end
">Copy</button>
</div>
<h4 id="has-many-through-association"><a class="anchorlink" href="#has-many-through-association">2.4 <code>has_many :through</code> Association</a></h4><p>A <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many :through</code></a> association 通常用於與另一個 model 建立多對多連線。這個 association 表明宣告的 model 可以透過<em>透過</em>第三個 model 與另一個 model 的零個或多個實例匹配。例如，考慮患者預約看醫生的醫療實踐。相關的 association 宣告可能如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Physician</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:patients</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Appointment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:physician</span>
  <span class="n">belongs_to</span> <span class="ss">:patient</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Patient</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:physicians</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Physician &lt; ApplicationRecord
  has_many :appointments
  has_many :patients, through: :appointments
end

class Appointment &lt; ApplicationRecord
  belongs_to :physician
  belongs_to :patient
end

class Patient &lt; ApplicationRecord
  has_many :appointments
  has_many :physicians, through: :appointments
end
">Copy</button>
</div>
<p><img src="images/association_basics/has_many_through.png" alt="has_many :through Association 圖"></p><p>相應的 migration 可能如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAppointments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:physicians</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:patients</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:appointments</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:physician</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:patient</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:appointment_date</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAppointments &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :physicians do |t|
      t.string :name
      t.timestamps
    end

    create_table :patients do |t|
      t.string :name
      t.timestamps
    end

    create_table :appointments do |t|
      t.belongs_to :physician
      t.belongs_to :patient
      t.datetime :appointment_date
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p>可以透過 <a href="#has-many-association-reference"><code>has_many</code> association 方法</a> 管理 join models 的集合。
例如，如果您分配：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">physician</span><span class="p">.</span><span class="nf">patients</span> <span class="o">=</span> <span class="n">patients</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="physician.patients = patients
">Copy</button>
</div>
<p>然後為新關聯的物件自動建立新的聯接 models。
如果以前存在的一些現在丟失，則它們的連線行將被自動刪除。</p><div class="warning"><p>自動刪除加入 models 是直接的，不會觸發 callbacks 銷燬。</p></div><p><code>has_many :through</code> 關聯對於透過巢狀的 <code>has_many</code> associations 設定“快捷方式”也很有用。例如，如果一個文件有很多節，而一個節有很多段落，您有時可能想要獲取文件中所有段落的簡單集合。你可以這樣設定：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Document</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:sections</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span><span class="p">,</span> <span class="ss">through: :sections</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Section</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:document</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paragraph</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:section</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Document &lt; ApplicationRecord
  has_many :sections
  has_many :paragraphs, through: :sections
end

class Section &lt; ApplicationRecord
  belongs_to :document
  has_many :paragraphs
end

class Paragraph &lt; ApplicationRecord
  belongs_to :section
end
">Copy</button>
</div>
<p>指定 <code>through: :sections</code> 後，Rails 現在將理解：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@document</span><span class="p">.</span><span class="nf">paragraphs</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@document.paragraphs
">Copy</button>
</div>
<h4 id="has-one-through-association"><a class="anchorlink" href="#has-one-through-association">2.5 <code>has_one :through</code> Association</a></h4><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one :through</code></a> association 與另一個 model 建立一對一連線。這個 association 表示
透過繼續<em>透過</em>第三個 model，宣告的 model 可以與另一個 model 的一個實例匹配。
例如，如果每個供應商都有一個帳戶，並且每個帳戶都關聯一個帳戶歷史記錄，則
供應商 model 可能如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span><span class="p">,</span> <span class="ss">through: :account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">AccountHistory</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account
  has_one :account_history, through: :account
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
  has_one :account_history
end

class AccountHistory &lt; ApplicationRecord
  belongs_to :account
end
">Copy</button>
</div>
<p><img src="images/association_basics/has_one_through.png" alt="has_one :through Association 圖"></p><p>相應的 migration 可能如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAccountHistories</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:account_histories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:account</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:credit_rating</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAccountHistories &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.belongs_to :supplier
      t.string :account_number
      t.timestamps
    end

    create_table :account_histories do |t|
      t.belongs_to :account
      t.integer :credit_rating
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<h4 id="has-and-belongs-to-many-association"><a class="anchorlink" href="#has-and-belongs-to-many-association">2.6 <code>has_and_belongs_to_many</code> Association</a></h4><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a> association 建立與另一個 model 的直接多對多連線，沒有中間的 model。
這個 association 表示宣告的 model 的每個實例引用另一個 model 的零個或多個實例。
例如，如果您的應用程式包括裝配體和零件，每個裝配體都有許多零件並且每個零件出現在許多裝配體中，您可以這樣宣告 models：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly &lt; ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p><img src="images/association_basics/habtm.png" alt="has_and_belongs_to_many Association 圖"></p><p>相應的 migration 可能如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesAndParts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:assembly</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:part</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAssembliesAndParts &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :assemblies do |t|
      t.string :name
      t.timestamps
    end

    create_table :parts do |t|
      t.string :part_number
      t.timestamps
    end

    create_table :assemblies_parts, id: false do |t|
      t.belongs_to :assembly
      t.belongs_to :part
    end
  end
end
">Copy</button>
</div>
<h4 id="belongs-to-has-one"><a class="anchorlink" href="#belongs-to-has-one">2.7 在 <code>belongs_to</code> 和 <code>has_one</code> 之間進行選擇</a></h4><p>如果要在兩個 models 之間建立一對一的關係，則需要將 <code>belongs_to</code> 新增到一個，並將 <code>has_one</code> 新增到另一個。你怎麼知道哪個是哪個？</p><p>差別在於您放置外部 key 的位置（它在宣告 <code>belongs_to</code> association 的類的表上），但您也應該考慮一下資料的實際含義。 <code>has_one</code> 關係表明某物是你的——也就是說，某物指向你。例如，說一個供應商擁有一個賬戶比一個賬戶擁有一個供應商更有意義。這表明正確的關係是這樣的：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
end
">Copy</button>
</div>
<p>相應的 migration 可能如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span>  <span class="ss">:supplier_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">:supplier_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateSuppliers &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :suppliers do |t|
      t.string :name
      t.timestamps
    end

    create_table :accounts do |t|
      t.bigint  :supplier_id
      t.string  :account_number
      t.timestamps
    end

    add_index :accounts, :supplier_id
  end
end
">Copy</button>
</div>
<div class="note"><p>使用 <code>t.bigint :supplier_id</code> 使外部 key 命名變得明顯和明確。在當前版本的 Rails 中，您可以透過使用 <code>t.references :supplier</code> 來抽象出這個實現細節。</p></div><h4 id="has-many-through-has-and-belongs-to-many"><a class="anchorlink" href="#has-many-through-has-and-belongs-to-many">2.8 在 <code>has_many :through</code> 和 <code>has_and_belongs_to_many</code> 之間進行選擇</a></h4><p>Rails 提供了兩種不同的方式來宣告 models 之間的多對多關係。第一種方式是使用<code>has_and_belongs_to_many</code>，它可以讓你直接製作association：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly &lt; ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p>第二種宣告多對多關係的方法是使用 <code>has_many :through</code>。這使得 association 間接透過一個 join model：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:parts</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Manifest</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:assembly</span>
  <span class="n">belongs_to</span> <span class="ss">:part</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly &lt; ApplicationRecord
  has_many :manifests
  has_many :parts, through: :manifests
end

class Manifest &lt; ApplicationRecord
  belongs_to :assembly
  belongs_to :part
end

class Part &lt; ApplicationRecord
  has_many :manifests
  has_many :assemblies, through: :manifests
end
">Copy</button>
</div>
<p>最簡單的經驗法則是，如果您需要將關係 model 作為獨立實體處理，則應設定 <code>has_many :through</code> 關係。如果您不需要對 model 關係做任何事情，那麼設定 <code>has_and_belongs_to_many</code> 關係可能更簡單（儘管您需要記住在資料庫中建立連線表）。</p><p>如果您需要驗證、callbacks 或連線 model 的額外屬性，則應使用 <code>has_many :through</code>。</p><h4 id="associations"><a class="anchorlink" href="#associations">2.9 多型 Associations</a></h4><p>associations 的一個更高階的轉折是<em>多型關聯</em>。使用多型 associations，一個 model 可以在單個關聯上屬於多個其他 model。例如，您可能有一張屬於員工 model 或產品 model 的圖片 model。以下是如何宣告：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Picture</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Picture &lt; ApplicationRecord
  belongs_to :imageable, polymorphic: true
end

class Employee &lt; ApplicationRecord
  has_many :pictures, as: :imageable
end

class Product &lt; ApplicationRecord
  has_many :pictures, as: :imageable
end
">Copy</button>
</div>
<p>您可以將多型 <code>belongs_to</code> 宣告視為設定任何其他 model 可以使用的介面。從 <code>Employee</code> model 的實例中，您可以檢索一組圖片：<code>@employee.pictures</code>。</p><p>同樣，您可以檢索 <code>@product.pictures</code>。</p><p>如果您有 <code>Picture</code> model 的實例，則可以透過 <code>@picture.imageable</code> 訪問其父級。為了使這個工作，你需要在 model 中宣告一個外部的 key 列和一個宣告多型介面的型別列：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span>  <span class="ss">:imageable_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:imageable_type</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="p">[</span><span class="ss">:imageable_type</span><span class="p">,</span> <span class="ss">:imageable_id</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreatePictures &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :pictures do |t|
      t.string  :name
      t.bigint  :imageable_id
      t.string  :imageable_type
      t.timestamps
    end

    add_index :pictures, [:imageable_type, :imageable_id]
  end
end
">Copy</button>
</div>
<p>這個 migration 可以透過使用 <code>t.references</code> 形式來簡化：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreatePictures &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :pictures do |t|
      t.string :name
      t.references :imageable, polymorphic: true
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<p><img src="images/association_basics/polymorphic.png" alt="多型Association圖"></p><h4 id=""><a class="anchorlink" href="#">2.10 自加入</a></h4><p>在設計一個數據 model 時，你有時會發現一個 model 應該和它自己有關係。例如，您可能希望將所有員工儲存在單個數據庫 model 中，但能夠跟蹤諸如經理和下屬之間的關係。這種情況可以用自加入associations進行modeled：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:subordinates</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span>
                          <span class="ss">foreign_key: </span><span class="s2">"manager_id"</span>

  <span class="n">belongs_to</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span> <span class="ss">optional: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Employee &lt; ApplicationRecord
  has_many :subordinates, class_name: "Employee",
                          foreign_key: "manager_id"

  belongs_to :manager, class_name: "Employee", optional: true
end
'>Copy</button>
</div>
<p>透過此設定，您可以檢索 <code>@employee.subordinates</code> 和 <code>@employee.manager</code>。</p><p>在您的 migrations/架構中，您將向 model 本身新增一個引用列。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateEmployees</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:employees</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">to_table: :employees</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateEmployees &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :employees do |t|
      t.references :manager, foreign_key: { to_table: :employees }
      t.timestamps
    end
  end
end
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">3 提示、技巧和警告</a></h3><p>為了在 Rails 應用程式中有效使用 Active Record associations，您應該瞭解以下幾點：</p>
<ul>
<li>控制快取</li>
<li>避免名稱衝突</li>
<li>更新架構</li>
<li>控制 association 範圍</li>
<li>雙向associations</li>
</ul>
<h4 id=""><a class="anchorlink" href="#">3.1 控制快取</a></h4><p>所有的 association 方法都是圍繞快取構建的，它使最新查詢的結果可用於進一步的操作。快取甚至可以跨方法共享。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 從資料庫中檢索書籍</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">load</span>

<span class="c1"># 使用快取的書籍副本</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>

<span class="c1"># 使用快取的書籍副本</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 從資料庫中檢索書籍
author.books.load

# 使用快取的書籍副本
author.books.size

# 使用快取的書籍副本
author.books.empty?
">Copy</button>
</div>
<p>但是如果您想重新載入快取怎麼辦，因為應用程式的其他部分可能已經更改了資料？只需在 association 上呼叫 <code>reload</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 從資料庫中檢索書籍</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">load</span>

<span class="c1"># 使用快取的書籍副本</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>

<span class="c1"># 丟棄快取的書籍副本並返回到資料庫</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 從資料庫中檢索書籍
author.books.load

# 使用快取的書籍副本
author.books.size

# 丟棄快取的書籍副本並返回到資料庫
author.books.reload.empty?
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">3.2 避免名稱衝突</a></h4><p>您不能隨意為 associations 使用任何名稱。因為建立關聯會將具有該名稱的方法新增到 model，所以給關聯一個已經用於 <code>ActiveRecord::Base</code> 實例方法的名稱是一個壞主意。關聯方法將覆蓋基本方法並破壞事物。例如，<code>attributes</code> 或 <code>connection</code> 是 associations 的壞名稱。</p><h4 id=""><a class="anchorlink" href="#">3.3 更新架構</a></h4><p>Association 非常有用，但它們並不神奇。您負責維護您的資料庫架構以匹配您的關聯。實際上，這意味著兩件事，具體取決於您要建立的關聯型別。對於 <code>belongs_to</code> 關聯，您需要建立外部 keys，對於 <code>has_and_belongs_to_many</code> 關聯，您需要建立適當的連線表。</p><h5 id="belongs-to-association-key"><a class="anchorlink" href="#belongs-to-association-key">3.3.1 為 <code>belongs_to</code> Association 建立外部 Key</a></h5><p>當你宣告一個<code>belongs_to</code> association時，你需要根據情況建立外部的keys。例如，考慮這個 model：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>這個宣告需要得到books表中對應的外部key列的支援。對於全新的表，migration 可能如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span>   <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>     <span class="ss">:book_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:author</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateBooks &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :books do |t|
      t.datetime   :published_at
      t.string     :book_number
      t.references :author
    end
  end
end
">Copy</button>
</div>
<p>而對於現有表，它可能如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AddAuthorToBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_reference</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:author</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class AddAuthorToBooks &lt; ActiveRecord::Migration[7.0]
  def change
    add_reference :books, :author
  end
end
">Copy</button>
</div>
<div class="note"><p>如果您希望<a href="/active_record_migrations.html#foreign-keys">在資料庫級別實施參照完整性</a>，請將 <code>foreign_key: true</code> 選項新增到上面的“reference”列宣告中。</p></div><h5 id="has-and-belongs-to-many-association"><a class="anchorlink" href="#has-and-belongs-to-many-association">3.3.2 為 <code>has_and_belongs_to_many</code> Association 建立連線表</a></h5><p>如果建立了 <code>has_and_belongs_to_many</code> association，則需要顯式建立聯接表。除非使用 <code>:join_table</code> 選項顯式指定連線表的名稱，否則 Active Record 將使用類名稱的詞法順序建立名稱。因此，author 和 book models 之間的連線將給出預設的連線表名稱“authors_books”，因為“a”在詞法排序中高於“b”。</p><div class="warning"><p>model 名稱之間的優先順序是使用 <code>String</code> 的 <code>&lt;=&gt;</code> 運算子計算的。這意味著，如果字串的長度不同，並且在與最短長度相比時字串相等，那麼較長的字串被認為比較短的字串具有更高的詞彙優先順序。例如，由於名稱“paper_boxes”的長度，人們會期望表“paper_boxes”和“papers”生成“papers_paper_boxes”的連線表名稱，但實際上它生成的連線表名稱為“paper_boxes_papers”（因為下劃線 '_' 在字典上比普通編碼中的 's' 少）​​。</p></div><p>無論名稱如何，您都必須使用適當的 migration 手動生成連線表。例如，考慮這些 associations：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Assembly &lt; ApplicationRecord
  has_and_belongs_to_many :parts
end

class Part &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p>這些需要由 migration 備份以建立 <code>assemblies_parts</code> 表。這個表應該在沒有主 key 的情況下建立：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:part_id</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:assembly_id</span>
    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:part_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAssembliesPartsJoinTable &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :assemblies_parts, id: false do |t|
      t.bigint :assembly_id
      t.bigint :part_id
    end

    add_index :assemblies_parts, :assembly_id
    add_index :assemblies_parts, :part_id
  end
end
">Copy</button>
</div>
<p>我們將 <code>id: false</code> 傳遞給 <code>create_table</code>，因為該表不代表 model。這是 association 正常工作所必需的。如果您在 <code>has_and_belongs_to_many</code> association 中觀察到任何奇怪的行為，例如損壞的 model ID，或者有關衝突 ID 的異常，那麼您很可能忘記了這一點。</p><p>您也可以使用方法 <code>create_join_table</code></p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_join_table</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:part_id</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class CreateAssembliesPartsJoinTable &lt; ActiveRecord::Migration[7.0]
  def change
    create_join_table :assemblies, :parts do |t|
      t.index :assembly_id
      t.index :part_id
    end
  end
end
">Copy</button>
</div>
<h4 id="association"><a class="anchorlink" href="#association">3.4 控制 Association 範圍</a></h4><p>預設情況下，associations 僅在當前 module 的範圍內查詢物件。當您在 module 中宣告 Active Record models 時，這一點很重要。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module MyApplication
  module Business
    class Supplier &lt; ApplicationRecord
      has_one :account
    end

    class Account &lt; ApplicationRecord
      belongs_to :supplier
    end
  end
end
">Copy</button>
</div>
<p>這會正常工作，因為 <code>Supplier</code> 和 <code>Account</code> 類都定義在同一範圍內。但以下將<em>不</em>工作，因為 <code>Supplier</code> 和 <code>Account</code> 定義在不同的範圍內：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module MyApplication
  module Business
    class Supplier &lt; ApplicationRecord
      has_one :account
    end
  end

  module Billing
    class Account &lt; ApplicationRecord
      belongs_to :supplier
    end
  end
end
">Copy</button>
</div>
<p>要將 model 與不同名稱空間中的 model 關聯，您必須在 association 宣告中指定完整的類名：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Billing::Account"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Business::Supplier"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module MyApplication
  module Business
    class Supplier &lt; ApplicationRecord
      has_one :account,
        class_name: "MyApplication::Billing::Account"
    end
  end

  module Billing
    class Account &lt; ApplicationRecord
      belongs_to :supplier,
        class_name: "MyApplication::Business::Supplier"
    end
  end
end
'>Copy</button>
</div>
<h4 id="associations"><a class="anchorlink" href="#associations">3.5 雙向 Associations</a></h4><p>associations 工作在兩個方向是正常的，需要在兩個不同的 models 上宣告：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books
end

class Book &lt; ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p>Active Record 將嘗試根據 association 名稱自動識別這兩個 models 共享一個雙向 association。這樣，Active Record 將只加載 <code>Author</code> 物件的一個​​副本，使您的應用程式更高效並防止資料不一致：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">first_name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s1">'David'</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">first_name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="a = Author.first
b = a.books.first
a.first_name == b.author.first_name
a.first_name = 'David'
a.first_name == b.author.first_name
">Copy</button>
</div>
<p>Active Record 支援對大多數 associations 標準名稱的自動識別。但是，Active Record 不會自動識別包含範圍或以下任何選項的雙向 associations：</p>
<ul>
<li><code>:through</code></li>
<li><code>:foreign_key</code></li>
</ul>
<p>例如，考慮以下 model 宣告：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Author'</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books
end

class Book &lt; ApplicationRecord
  belongs_to :writer, class_name: 'Author', foreign_key: 'author_id'
end
">Copy</button>
</div>
<p>Active Record 將不再自動識別雙向 association：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">first_name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s1">'David'</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">first_name</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="a = Author.first
b = a.books.first
a.first_name == b.writer.first_name
a.first_name = 'David'
a.first_name == b.writer.first_name
">Copy</button>
</div>
<p>Active Record 提供了 <code>:inverse_of</code> 選項，因此您可以顯式宣告雙向 associations：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: </span><span class="s1">'writer'</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s1">'Author'</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s1">'author_id'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, inverse_of: 'writer'
end

class Book &lt; ApplicationRecord
  belongs_to :writer, class_name: 'Author', foreign_key: 'author_id'
end
">Copy</button>
</div>
<p>透過在 <code>has_many</code> association 宣告中包含 <code>:inverse_of</code> 選項，Active Record 現在將識別雙向 association：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">first_name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s1">'David'</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">==</span> <span class="n">b</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">first_name</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="a = Author.first
b = a.books.first
a.first_name == b.writer.first_name
a.first_name = 'David'
a.first_name == b.writer.first_name
">Copy</button>
</div>
<h3 id="association"><a class="anchorlink" href="#association">4 詳細的Association參考</a></h3><p>以下部分提供了每種型別的 association 的詳細資訊，包括它們新增的方法以及宣告 association 時可以使用的選項。</p><h4 id="belongs-to-association"><a class="anchorlink" href="#belongs-to-association">4.1 <code>belongs_to</code> Association 參考</a></h4><p>在資料庫術語中，<code>belongs_to</code> association 表示這個 model 的表包含一個表示對另一個表的引用的列。
這可用於設定一對一或一對多關係，具體取決於設定。
如果另一個類的表包含一對一關係的引用，那麼您應該使用 <code>has_one</code> 代替。</p><h5 id="belongs-to"><a class="anchorlink" href="#belongs-to">4.1.1 方法由 <code>belongs_to</code> 新增</a></h5><p>當你宣告一個 <code>belongs_to</code> association 時，宣告類會自動獲得 8 個與 association 相關的方法：</p>
<ul>
<li><code>association</code></li>
<li><code>association=(associate)</code></li>
<li><code>build_association(attributes = {})</code></li>
<li><code>create_association(attributes = {})</code></li>
<li><code>create_association!(attributes = {})</code></li>
<li><code>reload_association</code></li>
<li><code>association_changed?</code></li>
<li><code>association_previously_changed?</code></li>
</ul>
<p>在所有這些方法中，<code>association</code> 被替換為作為第一個引數傳遞給 <code>belongs_to</code> 的 symbol。例如，給定宣告：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author
end
">Copy</button>
</div>
<p><code>Book</code> model 的每個實例都有這些方法：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">author</span>
<span class="n">author</span><span class="o">=</span>
<span class="n">build_author</span>
<span class="n">create_author</span>
<span class="n">create_author!</span>
<span class="n">reload_author</span>
<span class="n">author_changed?</span>
<span class="n">author_previously_changed?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author
author=
build_author
create_author
create_author!
reload_author
author_changed?
author_previously_changed?
">Copy</button>
</div>
<div class="note"><p>初始化新的 <code>has_one</code> 或 <code>belongs_to</code> 關聯時，您必須使用 <code>build_</code> 字首來構建關聯，而不是用於 <code>has_many</code> 或 <code>has_and_belongs_to_many</code> ZHTW_13 的 <code>association.build</code> 方法。要建立一個，請使用 <code>create_</code> 字首。</p></div><h6 id="belongs-to-association"><a class="anchorlink" href="#belongs-to-association">4.1.1.1 <code>association</code></a></h6><p><code>association</code> 方法返回關聯的物件（如果有）。如果未找到關聯物件，則返回 <code>nil</code>。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author = @book.author
">Copy</button>
</div>
<p>如果已為此物件從資料庫中檢索到關聯物件，則將返回快取版本。要覆蓋此行為（並強制讀取資料庫），請在父物件上呼叫 <code>#reload_association</code>。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">reload_author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author = @book.reload_author
">Copy</button>
</div>
<h6 id="belongs-to-association-associate"><a class="anchorlink" href="#belongs-to-association-associate">4.1.1.2 <code>association=(associate)</code></a></h6><p><code>association=</code> 方法將關聯的物件分配給該物件。在幕後，這意味著從關聯物件中提取主 key 並將此物件的外部 key 設定為相同的 value。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="vi">@author</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book.author = @author
">Copy</button>
</div>
<h6 id="belongs-to-build-association-attributes"><a class="anchorlink" href="#belongs-to-build-association-attributes">4.1.1.3 <code>build_association(attributes = {})</code></a></h6><p><code>build_association</code> 方法返回關聯型別的新物件。這個物件將從傳遞的屬性中實例化，並且透過這個物件的外部 key 的連結將被設定，但關聯的物件將<em>不</em>被儲存。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">build_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                             <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@author = @book.build_author(author_number: 123,
                             author_name: "John Doe")
'>Copy</button>
</div>
<h6 id="belongs-to-create-association-attributes"><a class="anchorlink" href="#belongs-to-create-association-attributes">4.1.1.4 <code>create_association(attributes = {})</code></a></h6><p><code>create_association</code> 方法返回關聯型別的新物件。這個物件將從傳遞的屬性中實例化，透過這個物件的外部 key 的連結將被設定，並且一旦它透過關聯的 model 上指定的所有驗證，關聯的物件<em>將</em>被儲存。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">create_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                              <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@author = @book.create_author(author_number: 123,
                              author_name: "John Doe")
'>Copy</button>
</div>
<h6 id="belongs-to-create-association-bang-attributes"><a class="anchorlink" href="#belongs-to-create-association-bang-attributes">4.1.1.5 <code>create_association!(attributes = {})</code></a></h6><p>與上面的 <code>create_association</code> 相同，但如果記錄無效，則會引發 <code>ActiveRecord::RecordInvalid</code>。</p><h6 id="association-changed-questionmark"><a class="anchorlink" href="#association-changed-questionmark">4.1.1.6 <code>association_changed?</code></a></h6><p>如果已分配新的關聯物件，則 <code>association_changed?</code> 方法返回 true，並且外部 key 將在下次儲存時更新。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="c1"># =&gt; #&lt;Book author_number: 123, author_name: "John Doe"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; false</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">second</span> <span class="c1"># =&gt; #&lt;Book author_number: 456, author_name: "Jane Smith"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; true</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">save!</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@book.author # =&gt; #&lt;Book author_number: 123, author_name: "John Doe"&gt;
@book.author_changed? # =&gt; false

@book.author = Author.second # =&gt; #&lt;Book author_number: 456, author_name: "Jane Smith"&gt;
@book.author_changed? # =&gt; true

@book.save!
@book.author_changed? # =&gt; false
'>Copy</button>
</div>
<h6 id="association-previously-changed-questionmark"><a class="anchorlink" href="#association-previously-changed-questionmark">4.1.1.7 <code>association_previously_changed?</code></a></h6><p>如果之前的儲存更新了 association 以引用新的關聯物件，則 <code>association_previously_changed?</code> 方法返回 true。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="c1"># =&gt; #&lt;Book author_number: 123, author_name: "John Doe"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_previously_changed?</span> <span class="c1"># =&gt; false</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">second</span> <span class="c1"># =&gt; #&lt;Book author_number: 456, author_name: "Jane Smith"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">save!</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_previously_changed?</span> <span class="c1"># =&gt; true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@book.author # =&gt; #&lt;Book author_number: 123, author_name: "John Doe"&gt;
@book.author_previously_changed? # =&gt; false

@book.author = Author.second # =&gt; #&lt;Book author_number: 456, author_name: "Jane Smith"&gt;
@book.save!
@book.author_previously_changed? # =&gt; true
'>Copy</button>
</div>
<h5 id="belongs-to"><a class="anchorlink" href="#belongs-to">4.1.2 <code>belongs_to</code> 的選項</a></h5><p>儘管 Rails 使用在大多數情況下都能很好地工作的智慧預設值，但有時您可能希望自定義 <code>belongs_to</code> association 引用的行為。透過在建立 association 時傳遞選項和範圍塊，可以輕鬆完成此類自定義。例如，這個 association 使用兩個這樣的選項：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span><span class="p">,</span>
    <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, touch: :books_updated_at,
    counter_cache: true
end
">Copy</button>
</div>
<p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to"><code>belongs_to</code></a> association 支援以下選項：</p>
<ul>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:counter_cache</code></li>
<li><code>:dependent</code></li>
<li><code>:foreign_key</code></li>
<li><code>:primary_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:polymorphic</code></li>
<li><code>:touch</code></li>
<li><code>:validate</code></li>
<li><code>:optional</code></li>
</ul>
<h6 id="belongs-to-autosave"><a class="anchorlink" href="#belongs-to-autosave">4.1.2.1 <code>:autosave</code></a></h6><p>如果您將 <code>:autosave</code> 選項設定為 <code>true</code>，Rails 將儲存任何載入的 association 成員，並在您儲存父物件時銷燬標記為銷燬的成員。將 <code>:autosave</code> 設定為 <code>false</code> 與不設定 <code>:autosave</code> 選項不同。如果 <code>:autosave</code> 選項不存在，則將儲存新的關聯物件，但不會儲存更新的關聯物件。</p><h6 id="belongs-to-class-name"><a class="anchorlink" href="#belongs-to-class-name">4.1.2.2 <code>:class_name</code></a></h6><p>如果其他 model 的名稱無法從 association 名稱派生，您可以使用 <code>:class_name</code> 選項來提供 model 名稱。例如，如果一本書屬於作者，但包含作者的 model 的實際名稱是 <code>Patron</code>，您可以這樣設定：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Patron"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Book &lt; ApplicationRecord
  belongs_to :author, class_name: "Patron"
end
'>Copy</button>
</div>
<h6 id="belongs-to-counter-cache"><a class="anchorlink" href="#belongs-to-counter-cache">4.1.2.3 <code>:counter_cache</code></a></h6><p><code>:counter_cache</code> 選項可用於更有效地查詢所屬物件的數量。考慮這些 models：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author
end

class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>透過這些宣告，請求 <code>@author.books.size</code> 的 value 需要呼叫資料庫來執行 <code>COUNT(*)</code> 查詢。為避免此呼叫，您可以向 <em>belonging</em> model 新增計數器快取：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, counter_cache: true
end

class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>有了這個宣告，Rails 將保持快取 value 是最新的，然後返回 value 以回應 <code>size</code> 方法。</p><p>儘管在 model 上指定了 <code>:counter_cache</code> 選項，其中包括
<code>belongs_to</code> 宣告，實際列必須新增到
<em>相關</em> (<code>has_many</code>) model。在上述情況下，您需要新增一個
名為 <code>books_count</code> 的列到 <code>Author</code> model。</p><p>您可以透過在中指定自定義列名來覆蓋預設列名
<code>counter_cache</code> 宣告而不是 <code>true</code>。例如，要使用
<code>count_of_books</code> 而不是 <code>books_count</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: :count_of_books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, counter_cache: :count_of_books
end

class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<div class="note"><p>你只需要在 <code>belongs_to</code> 上指定 <code>:counter_cache</code> 選項
association 的一側。</p></div><p>計數器快取列透過 <code>attr_readonly</code> 新增到包含 model 的只讀屬性列表中。</p><h6 id="belongs-to-dependent"><a class="anchorlink" href="#belongs-to-dependent">4.1.2.4 <code>:dependent</code></a></h6><p>如果您將 <code>:dependent</code> 選項設定為：</p>
<ul>
<li>
<code>:destroy</code>，當物件被銷燬時，會在其上呼叫<code>destroy</code>
關聯的物件。</li>
<li>
<code>:delete</code>，當物件被銷燬時，其關聯的所有物件都會被銷燬
直接從資料庫中刪除而不呼叫他們的 <code>destroy</code> 方法。</li>
<li>
<code>:destroy_async</code>：當物件被銷燬時，一個 <code>ActiveRecord::DestroyAssociationAsyncJob</code>
作業已入隊，它將對其關聯的物件呼叫銷燬。 Active Job 必須設定
為了這個工作。</li>
</ul>
<div class="warning"><p>您不應在與其他類上的 <code>has_many</code> association 連線的 <code>belongs_to</code> association 上指定此選項。這樣做可能會導致資料庫中出現孤立記錄。</p></div><h6 id="belongs-to-foreign-key"><a class="anchorlink" href="#belongs-to-foreign-key">4.1.2.5 <code>:foreign_key</code></a></h6><p>按照慣例，Rails 假定用於儲存此 model 上的外部 key 的列是新增字尾 <code>_id</code> 的 association 的名稱。 <code>:foreign_key</code> 選項可以讓你直接設定外部 key 的名稱：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Patron"</span><span class="p">,</span>
                      <span class="ss">foreign_key: </span><span class="s2">"patron_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Book &lt; ApplicationRecord
  belongs_to :author, class_name: "Patron",
                      foreign_key: "patron_id"
end
'>Copy</button>
</div>
<p>提示：在任何情況下，Rails 都不會為您建立外部 key 列。您需要將它們明確定義為 migrations 的一部分。</p><h6 id="belongs-to-primary-key"><a class="anchorlink" href="#belongs-to-primary-key">4.1.2.6 <code>:primary_key</code></a></h6><p>按照慣例，Rails 假定 <code>id</code> 列用於儲存主要的 key
它的表。 <code>:primary_key</code> 選項允許您指定不同的列。</p><p>例如，假設我們有一個 <code>users</code> 表，其中 <code>guid</code> 作為主 key。如果我們想要一個單獨的 <code>todos</code> 表來儲存 <code>guid</code> 列中的外部 key <code>user_id</code>，那麼我們可以像這樣使用 <code>primary_key</code> 來實現：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="s1">'guid'</span> <span class="c1"># primary key is guid and not id</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Todo</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">primary_key: </span><span class="s1">'guid'</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ApplicationRecord
  self.primary_key = 'guid' # primary key is guid and not id
end

class Todo &lt; ApplicationRecord
  belongs_to :user, primary_key: 'guid'
end
">Copy</button>
</div>
<p>當我們執行 <code>@user.todos.create</code> 時，<code>@todo</code> 記錄將有它的
<code>user_id</code> value 作為 <code>@user</code> 的 <code>guid</code> value。</p><h6 id="belongs-to-inverse-of"><a class="anchorlink" href="#belongs-to-inverse-of">4.1.2.7 <code>:inverse_of</code></a></h6><p><code>:inverse_of</code> 選項指定 <code>has_many</code> 或 <code>has_one</code> association 的名稱，它是此 association 的倒數。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: :author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">inverse_of: :books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, inverse_of: :author
end

class Book &lt; ApplicationRecord
  belongs_to :author, inverse_of: :books
end
">Copy</button>
</div>
<h6 id="polymorphic"><a class="anchorlink" href="#polymorphic">4.1.2.8 <code>:polymorphic</code></a></h6><p>將 <code>true</code> 傳遞給 <code>:polymorphic</code> 選項表明這是一個多型關聯。 <a href="#polymorphic-associations">本指南前面</a>詳細討論了多型 associations。</p><h6 id="belongs-to-touch"><a class="anchorlink" href="#belongs-to-touch">4.1.2.9 <code>:touch</code></a></h6><p>如果您將 <code>:touch</code> 選項設定為 <code>true</code>，那麼每當此物件被儲存或銷燬時，關聯物件上的 <code>updated_at</code> 或 <code>updated_on</code> 時間戳將設定為當前時間：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, touch: true
end

class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>在這種情況下，儲存或銷燬一本書將更新相關作者的時間戳。您還可以指定要更新的特定時間戳屬性：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, touch: :books_updated_at
end
">Copy</button>
</div>
<h6 id="belongs-to-validate"><a class="anchorlink" href="#belongs-to-validate">4.1.2.10 <code>:validate</code></a></h6><p>如果您將 <code>:validate</code> 選項設定為 <code>true</code>，則每當您儲存此物件時，都會驗證新的關聯物件。預設情況下，這是 <code>false</code>：儲存此物件時不會驗證新的關聯物件。</p><h6 id="optional"><a class="anchorlink" href="#optional">4.1.2.11 <code>:optional</code></a></h6><p>如果將 <code>:optional</code> 選項設定為 <code>true</code>，則關聯的存在
物件不會被驗證。預設情況下，此選項設定為 <code>false</code>。</p><h5 id="belongs-to"><a class="anchorlink" href="#belongs-to">4.1.3 <code>belongs_to</code> 的範圍</a></h5><p>有時您可能希望自定義 <code>belongs_to</code> 使用的查詢。此類自定義可以透過範圍塊實現。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, -&gt; { where active: true }
end
">Copy</button>
</div>
<p>您可以在範圍塊內使用任何標準的 <a href="active_record_querying.html">查詢方法</a>。下面討論以下內容：</p>
<ul>
<li><code>where</code></li>
<li><code>includes</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
</ul>
<h6 id="belongs-to-where"><a class="anchorlink" href="#belongs-to-where">4.1.3.1 <code>where</code></a></h6><p><code>where</code> 方法允許您指定關聯物件必須滿足的條件。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :author, -&gt; { where active: true }
end
">Copy</button>
</div>
<h6 id="belongs-to-includes"><a class="anchorlink" href="#belongs-to-includes">4.1.3.2 <code>includes</code></a></h6><p>您可以使用 <code>includes</code> 方法指定使用此關聯時應立即載入的二階 associations。例如，考慮這些 models：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Chapter &lt; ApplicationRecord
  belongs_to :book
end

class Book &lt; ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p>如果您經常直接從章節 (<code>@chapter.book.author</code>) 中檢索作者，那麼您可以透過在從章節到書籍的 association 中包含作者來使您的程式碼更加高效：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:author</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Chapter &lt; ApplicationRecord
  belongs_to :book, -&gt; { includes :author }
end

class Book &lt; ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<div class="note"><p>不需要使用 <code>includes</code> 來立即使用 associations——也就是說，如果你有 <code>Book belongs_to :author</code>，那麼作者會在需要時自動載入。</p></div><h6 id="belongs-to-readonly"><a class="anchorlink" href="#belongs-to-readonly">4.1.3.3 <code>readonly</code></a></h6><p>如果您使用 <code>readonly</code>，則關聯物件在透過 association 檢索時將是隻讀的。</p><h6 id="belongs-to-select"><a class="anchorlink" href="#belongs-to-select">4.1.3.4 <code>select</code></a></h6><p><code>select</code> 方法允許您覆蓋用於檢索有關關聯物件的資料的 SQL <code>SELECT</code> 子句。預設情況下，Rails 檢索所有列。</p><p>提示：如果您在 <code>belongs_to</code> association 上使用 <code>select</code> 方法，您還應該設定 <code>:foreign_key</code> 選項以保證正確的結果。</p><h5 id="belongs-to-association-"><a class="anchorlink" href="#belongs-to-association-">4.1.4 是否存在任何關聯物件？</a></h5><p>您可以使用 <code>association.nil?</code> 方法檢視是否存在任何關聯物件：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">if</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No author found for this book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='if @book.author.nil?
  @msg = "No author found for this book"
end
'>Copy</button>
</div>
<h5 id="belongs-to-association-"><a class="anchorlink" href="#belongs-to-association-">4.1.5 什麼時候儲存物件？</a></h5><p>將物件分配給 <code>belongs_to</code> association 不會_自動儲存物件。它也不儲存關聯的物件。</p><h4 id="has-one-association"><a class="anchorlink" href="#has-one-association">4.2 <code>has_one</code> Association 參考</a></h4><p><code>has_one</code> association 建立與另一個 model 的一對一匹配。在資料庫術語中，這個 association 表示另一個類包含外部 key。如果此類包含外部 key，則應改用 <code>belongs_to</code>。</p><h5 id="has-one"><a class="anchorlink" href="#has-one">4.2.1 方法由 <code>has_one</code> 新增</a></h5><p>當你宣告一個 <code>has_one</code> association 時，宣告類會自動獲得 6 個與 association 相關的方法：</p>
<ul>
<li><code>association</code></li>
<li><code>association=(associate)</code></li>
<li><code>build_association(attributes = {})</code></li>
<li><code>create_association(attributes = {})</code></li>
<li><code>create_association!(attributes = {})</code></li>
<li><code>reload_association</code></li>
</ul>
<p>在所有這些方法中，<code>association</code> 被替換為作為第一個引數傳遞給 <code>has_one</code> 的 symbol。例如，給定宣告：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account
end
">Copy</button>
</div>
<p><code>Supplier</code> model 的每個實例都有這些方法：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">account</span>
<span class="n">account</span><span class="o">=</span>
<span class="n">build_account</span>
<span class="n">create_account</span>
<span class="n">create_account!</span>
<span class="n">reload_account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="account
account=
build_account
create_account
create_account!
reload_account
">Copy</button>
</div>
<div class="note"><p>初始化新的 <code>has_one</code> 或 <code>belongs_to</code> 關聯時，您必須使用 <code>build_</code> 字首來構建關聯，而不是用於 <code>has_many</code> 或 <code>has_and_belongs_to_many</code> ZHTW_13 的 <code>association.build</code> 方法。要建立一個，請使用 <code>create_</code> 字首。</p></div><h6 id="has-one-association"><a class="anchorlink" href="#has-one-association">4.2.1.1 <code>association</code></a></h6><p><code>association</code> 方法返回關聯的物件（如果有）。如果未找到關聯物件，則返回 <code>nil</code>。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@account = @supplier.account
">Copy</button>
</div>
<p>如果已為此物件從資料庫中檢索到關聯物件，則將返回快取版本。要覆蓋此行為（並強制讀取資料庫），請在父物件上呼叫 <code>#reload_association</code>。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">reload_account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@account = @supplier.reload_account
">Copy</button>
</div>
<h6 id="has-one-association-associate"><a class="anchorlink" href="#has-one-association-associate">4.2.1.2 <code>association=(associate)</code></a></h6><p><code>association=</code> 方法將關聯的物件分配給該物件。在幕後，這意味著從該物件中提取主 key，並將關聯物件的外部 key 設定為相同的 value。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span> <span class="o">=</span> <span class="vi">@account</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@supplier.account = @account
">Copy</button>
</div>
<h6 id="has-one-build-association-attributes"><a class="anchorlink" href="#has-one-build-association-attributes">4.2.1.3 <code>build_association(attributes = {})</code></a></h6><p><code>build_association</code> 方法返回關聯型別的新物件。該物件將從傳遞的屬性中實例化，並透過其外部 key 的連結將被設定，但關聯的物件將<em>不</em>被儲存。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">build_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@account = @supplier.build_account(terms: "Net 30")
'>Copy</button>
</div>
<h6 id="has-one-create-association-attributes"><a class="anchorlink" href="#has-one-create-association-attributes">4.2.1.4 <code>create_association(attributes = {})</code></a></h6><p><code>create_association</code> 方法返回關聯型別的新物件。該物件將從傳遞的屬性中實例化，透過其外部 key 的連結將被設定，並且一旦它透過關聯的 model 上指定的所有驗證，關聯的物件<em>將</em>被儲存。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">create_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@account = @supplier.create_account(terms: "Net 30")
'>Copy</button>
</div>
<h6 id="has-one-create-association-bang-attributes"><a class="anchorlink" href="#has-one-create-association-bang-attributes">4.2.1.5 <code>create_association!(attributes = {})</code></a></h6><p>與上面的 <code>create_association</code> 相同，但如果記錄無效，則會引發 <code>ActiveRecord::RecordInvalid</code>。</p><h5 id="has-one"><a class="anchorlink" href="#has-one">4.2.2 <code>has_one</code> 的選項</a></h5><p>儘管 Rails 使用在大多數情況下都能很好地工作的智慧預設值，但有時您可能希望自定義 <code>has_one</code> association 引用的行為。透過在建立 association 時傳遞選項，可以輕鬆完成此類自定義。例如，這個 association 使用兩個這樣的選項：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Billing"</span><span class="p">,</span> <span class="ss">dependent: :nullify</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Supplier &lt; ApplicationRecord
  has_one :account, class_name: "Billing", dependent: :nullify
end
'>Copy</button>
</div>
<p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one"><code>has_one</code></a> association 支援以下選項：</p>
<ul>
<li><code>:as</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:dependent</code></li>
<li><code>:foreign_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:primary_key</code></li>
<li><code>:source</code></li>
<li><code>:source_type</code></li>
<li><code>:through</code></li>
<li><code>:touch</code></li>
<li><code>:validate</code></li>
</ul>
<h6 id="has-one-as"><a class="anchorlink" href="#has-one-as">4.2.2.1 <code>:as</code></a></h6><p>設定 <code>:as</code> 選項表明這是一個多型關聯。 <a href="#polymorphic-associations">本指南前面部分</a> 詳細討論了多型 associations。</p><h6 id="has-one-autosave"><a class="anchorlink" href="#has-one-autosave">4.2.2.2 <code>:autosave</code></a></h6><p>如果您將 <code>:autosave</code> 選項設定為 <code>true</code>，Rails 將儲存任何載入的 association 成員，並在您儲存父物件時銷燬標記為銷燬的成員。將 <code>:autosave</code> 設定為 <code>false</code> 與不設定 <code>:autosave</code> 選項不同。如果 <code>:autosave</code> 選項不存在，則將儲存新的關聯物件，但不會儲存更新的關聯物件。</p><h6 id="has-one-class-name"><a class="anchorlink" href="#has-one-class-name">4.2.2.3 <code>:class_name</code></a></h6><p>如果其他 model 的名稱無法從 association 名稱派生，您可以使用 <code>:class_name</code> 選項來提供 model 名稱。例如，如果供應商有一個帳戶，但包含帳戶的 model 的實際名稱是 <code>Billing</code>，您可以這樣設定：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Billing"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Supplier &lt; ApplicationRecord
  has_one :account, class_name: "Billing"
end
'>Copy</button>
</div>
<h6 id="has-one-dependent"><a class="anchorlink" href="#has-one-dependent">4.2.2.4 <code>:dependent</code></a></h6><p>控制關聯物件在其所有者被銷燬時發生的情況：</p>
<ul>
<li>
<code>:destroy</code> 導致關聯物件也被銷燬</li>
<li>
<code>:delete</code> 導致關聯的物件直接從資料庫中刪除（所以 callbacks 不會執行）</li>
<li>
<code>:destroy_async</code>：當物件被銷燬時，一個 <code>ActiveRecord::DestroyAssociationAsyncJob</code> 作業被排隊，這將呼叫其關聯物件上的銷燬。必須設定 Active Job 才能使其工作。</li>
<li>
<code>:nullify</code> 導致外部 key 被設定為 <code>NULL</code>。多型型別列在多型 associations 上也無效。 Callbacks 不執行。</li>
<li>
<code>:restrict_with_exception</code> 如果有關聯記錄，則引發 <code>ActiveRecord::DeleteRestrictionError</code> 異常</li>
<li>
<code>:restrict_with_error</code> 導致錯誤新增到所有者如果有關聯的物件</li>
</ul>
<p>有必要不要為那些 associations 設定或離開 <code>:nullify</code> 選項
具有 <code>NOT NULL</code> 資料庫約束的。如果您沒有將 <code>dependent</code> 設定為
銷燬此類 associations 您將無法更改關聯物件
因為初始關聯物件的外部 key 將被設定為
不允許的 <code>NULL</code> value。</p><h6 id="has-one-foreign-key"><a class="anchorlink" href="#has-one-foreign-key">4.2.2.5 <code>:foreign_key</code></a></h6><p>按照慣例，Rails 假定用於在另一個 model 上儲存外部 key 的列是這個 model 的名稱，並添加了字尾 <code>_id</code>。 <code>:foreign_key</code> 選項可以讓你直接設定外部 key 的名稱：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"supp_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Supplier &lt; ApplicationRecord
  has_one :account, foreign_key: "supp_id"
end
'>Copy</button>
</div>
<p>提示：在任何情況下，Rails 都不會為您建立外部 key 列。您需要將它們明確定義為 migrations 的一部分。</p><h6 id="has-one-inverse-of"><a class="anchorlink" href="#has-one-inverse-of">4.2.2.6 <code>:inverse_of</code></a></h6><p><code>:inverse_of</code> 選項指定 <code>belongs_to</code> association 的名稱，它是此 association 的倒數。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">inverse_of: :supplier</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">inverse_of: :account</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account, inverse_of: :supplier
end

class Account &lt; ApplicationRecord
  belongs_to :supplier, inverse_of: :account
end
">Copy</button>
</div>
<h6 id="has-one-primary-key"><a class="anchorlink" href="#has-one-primary-key">4.2.2.7 <code>:primary_key</code></a></h6><p>按照慣例，Rails 假定用於儲存此 model 的主要 key 的列是 <code>id</code>。您可以覆蓋它並使用 <code>:primary_key</code> 選項顯式指定主要 key。</p><h6 id="has-one-source"><a class="anchorlink" href="#has-one-source">4.2.2.8 <code>:source</code></a></h6><p><code>:source</code> 選項為 <code>has_one :through</code> association 指定源 association 名稱。</p><h6 id="has-one-source-type"><a class="anchorlink" href="#has-one-source-type">4.2.2.9 <code>:source_type</code></a></h6><p><code>:source_type</code> 選項為 <code>has_one :through</code> association 指定源 association 型別，該型別透過多型 association 進行。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:book</span>
  <span class="n">has_one</span> <span class="ss">:hardback</span><span class="p">,</span> <span class="ss">through: :book</span><span class="p">,</span> <span class="ss">source: :format</span><span class="p">,</span> <span class="ss">source_type: </span><span class="s2">"Hardback"</span>
  <span class="n">has_one</span> <span class="ss">:dust_jacket</span><span class="p">,</span> <span class="ss">through: :hardback</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paperback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>

<span class="k">class</span> <span class="nc">Hardback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:dust_jacket</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">DustJacket</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_one :book
  has_one :hardback, through: :book, source: :format, source_type: "Hardback"
  has_one :dust_jacket, through: :hardback
end

class Book &lt; ApplicationRecord
  belongs_to :format, polymorphic: true
end

class Paperback &lt; ApplicationRecord; end

class Hardback &lt; ApplicationRecord
  has_one :dust_jacket
end

class DustJacket &lt; ApplicationRecord; end
'>Copy</button>
</div>
<h6 id="has-one-through"><a class="anchorlink" href="#has-one-through">4.2.2.10 <code>:through</code></a></h6><p><code>:through</code> 選項指定了一個連線 model，透過它來執行查詢。 <code>has_one :through</code> associations [本指南前面部分]（#the-has-one-through-association）進行了詳細討論。</p><h6 id="has-one-touch"><a class="anchorlink" href="#has-one-touch">4.2.2.11 <code>:touch</code></a></h6><p>如果您將 <code>:touch</code> 選項設定為 <code>true</code>，那麼每當此物件被儲存或銷燬時，關聯物件上的 <code>updated_at</code> 或 <code>updated_on</code> 時間戳將設定為當前時間：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account, touch: true
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
end
">Copy</button>
</div>
<p>在這種情況下，儲存或銷燬供應商將更新關聯帳戶上的時間戳。您還可以指定要更新的特定時間戳屬性：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">touch: :suppliers_updated_at</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account, touch: :suppliers_updated_at
end
">Copy</button>
</div>
<h6 id="has-one-validate"><a class="anchorlink" href="#has-one-validate">4.2.2.12 <code>:validate</code></a></h6><p>如果您將 <code>:validate</code> 選項設定為 <code>true</code>，則每當您儲存此物件時，都會驗證新的關聯物件。預設情況下，這是 <code>false</code>：儲存此物件時不會驗證新的關聯物件。</p><h5 id="has-one"><a class="anchorlink" href="#has-one">4.2.3 <code>has_one</code> 的範圍</a></h5><p>有時您可能希望自定義 <code>has_one</code> 使用的查詢。此類自定義可以透過範圍塊實現。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account, -&gt; { where active: true }
end
">Copy</button>
</div>
<p>您可以在範圍塊內使用任何標準的 <a href="active_record_querying.html">查詢方法</a>。下面討論以下內容：</p>
<ul>
<li><code>where</code></li>
<li><code>includes</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
</ul>
<h6 id="has-one-where"><a class="anchorlink" href="#has-one-where">4.2.3.1 <code>where</code></a></h6><p><code>where</code> 方法允許您指定關聯物件必須滿足的條件。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"confirmed = 1"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Supplier &lt; ApplicationRecord
  has_one :account, -&gt; { where "confirmed = 1" }
end
'>Copy</button>
</div>
<h6 id="has-one-includes"><a class="anchorlink" href="#has-one-includes">4.2.3.2 <code>includes</code></a></h6><p>您可以使用 <code>includes</code> 方法指定使用此關聯時應立即載入的二階 associations。例如，考慮這些 models：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
  belongs_to :representative
end

class Representative &lt; ApplicationRecord
  has_many :accounts
end
">Copy</button>
</div>
<p>如果您經常直接從供應商 (<code>@supplier.account.representative</code>) 檢索代表，那麼您可以透過在 association 中包含從供應商到客戶的代表來使您的程式碼更加高效：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:representative</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account, -&gt; { includes :representative }
end

class Account &lt; ApplicationRecord
  belongs_to :supplier
  belongs_to :representative
end

class Representative &lt; ApplicationRecord
  has_many :accounts
end
">Copy</button>
</div>
<h6 id="has-one-readonly"><a class="anchorlink" href="#has-one-readonly">4.2.3.3 <code>readonly</code></a></h6><p>如果您使用 <code>readonly</code> 方法，則關聯物件在透過 association 檢索時將是隻讀的。</p><h6 id="has-one-select"><a class="anchorlink" href="#has-one-select">4.2.3.4 <code>select</code></a></h6><p><code>select</code> 方法允許您覆蓋用於檢索有關關聯物件的資料的 SQL <code>SELECT</code> 子句。預設情況下，Rails 檢索所有列。</p><h5 id="has-one-association"><a class="anchorlink" href="#has-one-association">4.2.4 是否存在任何關聯物件？</a></h5><p>您可以使用 <code>association.nil?</code> 方法檢視是否存在任何關聯物件：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">if</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No account found for this supplier"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='if @supplier.account.nil?
  @msg = "No account found for this supplier"
end
'>Copy</button>
</div>
<h5 id="has-one-association"><a class="anchorlink" href="#has-one-association">4.2.5 什麼時候儲存物件？</a></h5><p>當您將物件分配給 <code>has_one</code> association 時，該物件會自動儲存（以更新其外部 key）。此外，任何被替換的物件也會自動儲存，因為它的外部 key 也會發生變化。</p><p>如果這些儲存中的任何一個由於驗證錯誤而失敗，則賦值語句返回 <code>false</code> 並且賦值本身被取消。</p><p>如果父物件（宣告 <code>has_one</code> association 的物件）未儲存（即 <code>new_record?</code> 返回 <code>true</code>），則不儲存子物件。它們會在父物件被儲存時自動進行。</p><p>如果要將物件分配給 <code>has_one</code> association 而不儲存該物件，請使用 <code>build_association</code> 方法。</p><h4 id="has-many-association"><a class="anchorlink" href="#has-many-association">4.3 <code>has_many</code> Association 參考</a></h4><p><code>has_many</code> association 與另一個 model 建立一對多關係。在資料庫術語中，這個 association 表示另一個類將有一個引用這個類的實例的外部 key。</p><h5 id="has-many"><a class="anchorlink" href="#has-many">4.3.1 方法由 <code>has_many</code> 新增</a></h5><p>當你宣告一個 <code>has_many</code> association 時，宣告類會自動獲得 17 個與 association 相關的方法：</p>
<ul>
<li><code>collection</code></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;(object, ...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete(object, ...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy(object, ...)</code></a></li>
<li><code>collection=(objects)</code></li>
<li><code>collection_singular_ids</code></li>
<li><code>collection_singular_ids=(ids)</code></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find(...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where(...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?(...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build(attributes = {})</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create(attributes = {})</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create-21"><code>collection.create!(attributes = {})</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a></li>
</ul>
<p>在所有這些方法中，<code>collection</code> 被替換為作為第一個引數傳遞給 <code>has_many</code> 的 symbol，而 <code>collection_singular</code> 被替換為該 symbol 的單數版本。例如，給定宣告：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books
end
">Copy</button>
</div>
<p><code>Author</code> model 的每個實例都有這些方法：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">books</span>
<span class="n">books</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="o">=</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
<span class="n">book_ids</span>
<span class="n">book_ids</span><span class="o">=</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">clear</span>
<span class="n">books</span><span class="p">.</span><span class="nf">empty?</span>
<span class="n">books</span><span class="p">.</span><span class="nf">size</span>
<span class="n">books</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">...</span><span class="p">)</span>
<span class="n">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">books</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">books</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="books
books&lt;&lt;(object, ...)
books.delete(object, ...)
books.destroy(object, ...)
books=(objects)
book_ids
book_ids=(ids)
books.clear
books.empty?
books.size
books.find(...)
books.where(...)
books.exists?(...)
books.build(attributes = {}, ...)
books.create(attributes = {})
books.create!(attributes = {})
books.reload
">Copy</button>
</div>
<h6 id="has-many-collection"><a class="anchorlink" href="#has-many-collection">4.3.1.1 <code>collection</code></a></h6><p><code>collection</code> 方法返回所有關聯物件的 Relation。如果沒有關聯的物件，則返回一個空的 Relation。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@books = @author.books
">Copy</button>
</div>
<h6 id="has-many-collection-object"><a class="anchorlink" href="#has-many-collection-object">4.3.1.2 <code>collection&lt;&lt;(object, ...)</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;</code></a> 方法透過將一個或多個物件的外部 keys 設定為呼叫 model 的主鍵，將一個或多個物件新增到集合中。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span> <span class="o">&lt;&lt;</span> <span class="vi">@book1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books &lt;&lt; @book1
">Copy</button>
</div>
<h6 id="has-many-collection-delete-object"><a class="anchorlink" href="#has-many-collection-delete-object">4.3.1.3 <code>collection.delete(object, ...)</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete</code></a> 方法透過將一個或多個物件的外部 keys 設定為 <code>NULL</code> 從集合中刪除一個或多個物件。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books.delete(@book1)
">Copy</button>
</div>
<div class="warning"><p>此外，如果物件與 <code>dependent: :destroy</code> 相關聯，則物件將被銷燬，如果它們與 <code>dependent: :delete_all</code> 相關聯，則物件將被刪除。</p></div><h6 id="has-many-collection-destroy-object"><a class="anchorlink" href="#has-many-collection-destroy-object">4.3.1.4 <code>collection.destroy(object, ...)</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy</code></a> 方法透過在每個物件上執行 <code>destroy</code> 從集合中刪除一個或多個物件。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books.destroy(@book1)
">Copy</button>
</div>
<div class="warning"><p>物件將<em>總是</em>從資料庫中刪除，忽略 <code>:dependent</code> 選項。</p></div><h6 id="has-many-collection-objects"><a class="anchorlink" href="#has-many-collection-objects">4.3.1.5 <code>collection=(objects)</code></a></h6><p><code>collection=</code> 方法透過適當地新增和刪除，使集合只包含提供的物件。更改將持久儲存到資料庫中。</p><h6 id="has-many-collection-singular-ids"><a class="anchorlink" href="#has-many-collection-singular-ids">4.3.1.6 <code>collection_singular_ids</code></a></h6><p><code>collection_singular_ids</code> 方法返回集合中物件的 id 陣列。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book_ids</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">book_ids</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book_ids = @author.book_ids
">Copy</button>
</div>
<h6 id="has-many-collection-singular-ids-ids"><a class="anchorlink" href="#has-many-collection-singular-ids-ids">4.3.1.7 <code>collection_singular_ids=(ids)</code></a></h6><p><code>collection_singular_ids=</code> 方法透過適當地新增和刪除，使集合僅包含由提供的主 key values 標識的物件。更改將持久儲存到資料庫中。</p><h6 id="has-many-collection-clear"><a class="anchorlink" href="#has-many-collection-clear">4.3.1.8 <code>collection.clear</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a> 方法根據 <code>dependent</code> 選項指定的策略從集合中刪除所有物件。如果沒有給出選項，則遵循預設策略。 <code>has_many :through</code> associations的預設策略是<code>delete_all</code>，<code>has_many</code> associations的預設策略是將外部的keys設定為<code>NULL</code>。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">clear</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@author.books.clear
">Copy</button>
</div>
<div class="warning"><p>與 <code>dependent: :destroy</code> 或 <code>dependent: :destroy_async</code> 關聯的物件將被刪除，
就像 <code>dependent: :delete_all</code> 一樣。</p></div><h6 id="has-many-collection-empty-questionmark"><a class="anchorlink" href="#has-many-collection-empty-questionmark">4.3.1.9 <code>collection.empty?</code></a></h6><p>如果集合不包含任何關聯物件，則 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a> 方法返回 <code>true</code>。</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
  No Books Found
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;% if @author.books.empty? %&gt;
  No Books Found
&lt;% end %&gt;
">Copy</button>
</div>
<h6 id="has-many-collection-size"><a class="anchorlink" href="#has-many-collection-size">4.3.1.10 <code>collection.size</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a> 方法返回集合中的物件數。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book_count</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@book_count = @author.books.size
">Copy</button>
</div>
<h6 id="has-many-collection-find"><a class="anchorlink" href="#has-many-collection-find">4.3.1.11 <code>collection.find(...)</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find</code></a> 方法在集合的表中查詢物件。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@available_book = @author.books.find(1)
">Copy</button>
</div>
<h6 id="has-many-collection-where"><a class="anchorlink" href="#has-many-collection-where">4.3.1.12 <code>collection.where(...)</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where</code></a> 方法根據提供的條件在集合中查詢物件，但物件是延遲載入的，這意味著僅在訪問物件時才查詢資料庫。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@available_books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">available: </span><span class="kp">true</span><span class="p">)</span> <span class="c1"># No query yet</span>
<span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@available_books</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Now the database will be queried</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@available_books = @author.books.where(available: true) # No query yet
@available_book = @available_books.first # Now the database will be queried
">Copy</button>
</div>
<h6 id="has-many-collection-exists-questionmark"><a class="anchorlink" href="#has-many-collection-exists-questionmark">4.3.1.13 <code>collection.exists?(...)</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?</code></a> 方法檢查物件是否滿足提供的
條件存在於集合的表中。</p><h6 id="has-many-collection-build-attributes"><a class="anchorlink" href="#has-many-collection-build-attributes">4.3.1.14 <code>collection.build(attributes = {})</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build</code></a> 方法返回關聯型別的單個或新物件陣列。物件將從傳遞的屬性中實例化，並透過它們的外部 key 的連結將被建立，但關聯的物件將<em>不</em>被儲存。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                            <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@book = @author.books.build(published_at: Time.now,
                            book_number: "A12345")

@books = @author.books.build([
  { published_at: Time.now, book_number: "A12346" },
  { published_at: Time.now, book_number: "A12347" }
])
'>Copy</button>
</div>
<h6 id="has-many-collection-create-attributes"><a class="anchorlink" href="#has-many-collection-create-attributes">4.3.1.15 <code>collection.create(attributes = {})</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create</code></a> 方法返回關聯型別的單個或新物件陣列。物件將從傳遞的屬性中實例化，將建立透過其外部 key 的連結，並且一旦它透過關聯的 model 上指定的所有驗證，關聯的物件 <em>will</em> 將被儲存。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                             <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@book = @author.books.create(published_at: Time.now,
                             book_number: "A12345")

@books = @author.books.create([
  { published_at: Time.now, book_number: "A12346" },
  { published_at: Time.now, book_number: "A12347" }
])
'>Copy</button>
</div>
<h6 id="has-many-collection-create-bang-attributes"><a class="anchorlink" href="#has-many-collection-create-bang-attributes">4.3.1.16 <code>collection.create!(attributes = {})</code></a></h6><p>與上面的 <code>collection.create</code> 相同，但如果記錄無效，則會引發 <code>ActiveRecord::RecordInvalid</code>。</p><h6 id="has-many-collection-reload"><a class="anchorlink" href="#has-many-collection-reload">4.3.1.17 <code>collection.reload</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a> 方法返回所有關聯物件的 Relation，強制讀取資料庫。如果沒有關聯的物件，則返回一個空的 Relation。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@books = @author.books.reload
">Copy</button>
</div>
<h5 id="has-many"><a class="anchorlink" href="#has-many">4.3.2 <code>has_many</code> 的選項</a></h5><p>儘管 Rails 使用在大多數情況下都能很好地工作的智慧預設值，但有時您可能希望自定義 <code>has_many</code> association 引用的行為。透過在建立 association 時傳遞選項，可以輕鬆完成此類自定義。例如，這個 association 使用兩個這樣的選項：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">dependent: :delete_all</span><span class="p">,</span> <span class="ss">validate: </span><span class="kp">false</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, dependent: :delete_all, validate: false
end
">Copy</button>
</div>
<p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many"><code>has_many</code></a> association 支援以下選項：</p>
<ul>
<li><code>:as</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:counter_cache</code></li>
<li><code>:dependent</code></li>
<li><code>:foreign_key</code></li>
<li><code>:inverse_of</code></li>
<li><code>:primary_key</code></li>
<li><code>:source</code></li>
<li><code>:source_type</code></li>
<li><code>:through</code></li>
<li><code>:validate</code></li>
</ul>
<h6 id="has-many-as"><a class="anchorlink" href="#has-many-as">4.3.2.1 <code>:as</code></a></h6><p>設定 <code>:as</code> 選項表明這是一個多型關聯，如<a href="#polymorphic-associations">本指南前面部分</a> 所討論的。</p><h6 id="has-many-autosave"><a class="anchorlink" href="#has-many-autosave">4.3.2.2 <code>:autosave</code></a></h6><p>如果您將 <code>:autosave</code> 選項設定為 <code>true</code>，Rails 將儲存任何載入的 association 成員，並在您儲存父物件時銷燬標記為銷燬的成員。將 <code>:autosave</code> 設定為 <code>false</code> 與不設定 <code>:autosave</code> 選項不同。如果 <code>:autosave</code> 選項不存在，則將儲存新的關聯物件，但不會儲存更新的關聯物件。</p><h6 id="has-many-class-name"><a class="anchorlink" href="#has-many-class-name">4.3.2.3 <code>:class_name</code></a></h6><p>如果其他 model 的名稱無法從 association 名稱派生，您可以使用 <code>:class_name</code> 選項來提供 model 名稱。例如，如果作者有很多書，但包含書籍的 model 的實際名稱是 <code>Transaction</code>，您可以這樣設定：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Transaction"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_many :books, class_name: "Transaction"
end
'>Copy</button>
</div>
<h6 id="has-many-counter-cache"><a class="anchorlink" href="#has-many-counter-cache">4.3.2.4 <code>:counter_cache</code></a></h6><p>此選項可用於設定名為 <code>:counter_cache</code> 的自定義。只有在 <a href="#options-for-belongs-to">belongs_to association</a> 上自定義 <code>:counter_cache</code> 的名稱時才需要此選項。</p><h6 id="dependent"><a class="anchorlink" href="#dependent">4.3.2.5 <code>:dependent</code></a></h6><p>控制關聯物件的所有者被銷燬時發生的情況：</p>
<ul>
<li>
<code>:destroy</code> 導致所有關聯的物件也被銷燬</li>
<li>
<code>:delete_all</code> 導致直接從資料庫中刪除所有關聯的物件（因此 callbacks 不會執行）</li>
<li>
<code>:destroy_async</code>：當物件被銷燬時，一個 <code>ActiveRecord::DestroyAssociationAsyncJob</code> 作業被排隊，這將呼叫其關聯物件上的銷燬。必須設定 Active Job 才能使其工作。</li>
<li>
<code>:nullify</code> 導致外部 key 被設定為 <code>NULL</code>。多型型別列在多型 associations 上也無效。 Callbacks 不執行。</li>
<li>如果有任何關聯的記錄，<code>:restrict_with_exception</code> 會導致引發 <code>ActiveRecord::DeleteRestrictionError</code> 異常</li>
<li>
<code>:restrict_with_error</code> 如果有任何關聯的物件，則會導致將錯誤新增到所有者</li>
</ul>
<p><code>:destroy</code> 和 <code>:delete_all</code> 選項也會影響 <code>collection.delete</code> 和 <code>collection=</code> 方法的語義，因為它們會在從集合中刪除關聯物件時銷燬它們。</p><h6 id="has-many-foreign-key"><a class="anchorlink" href="#has-many-foreign-key">4.3.2.6 <code>:foreign_key</code></a></h6><p>按照慣例，Rails 假定用於在另一個 model 上儲存外部 key 的列是這個 model 的名稱，並添加了字尾 <code>_id</code>。 <code>:foreign_key</code> 選項可以讓你直接設定外部 key 的名稱：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"cust_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_many :books, foreign_key: "cust_id"
end
'>Copy</button>
</div>
<p>提示：在任何情況下，Rails 都不會為您建立外部 key 列。您需要將它們明確定義為 migrations 的一部分。</p><h6 id="inverse-of"><a class="anchorlink" href="#inverse-of">4.3.2.7 <code>:inverse_of</code></a></h6><p><code>:inverse_of</code> 選項指定 <code>belongs_to</code> association 的名稱，它是此 association 的倒數。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: :author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">inverse_of: :books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, inverse_of: :author
end

class Book &lt; ApplicationRecord
  belongs_to :author, inverse_of: :books
end
">Copy</button>
</div>
<h6 id="primary-key"><a class="anchorlink" href="#primary-key">4.3.2.8 <code>:primary_key</code></a></h6><p>按照慣例，Rails 假定用於儲存 association 的主要 key 的列是 <code>id</code>。您可以覆蓋它並使用 <code>:primary_key</code> 選項顯式指定主要 key。</p><p>假設 <code>users</code> 表有 <code>id</code> 作為主_key 但它也
有一個 <code>guid</code> 列。要求是 <code>todos</code> 表應該
持有 <code>guid</code> 列 value 作為外部 key 而不是 <code>id</code>
value。這可以像這樣實現：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:todos</span><span class="p">,</span> <span class="ss">primary_key: :guid</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ApplicationRecord
  has_many :todos, primary_key: :guid
end
">Copy</button>
</div>
<p>現在如果我們執行 <code>@todo = @user.todos.create</code> 那麼 <code>@todo</code>
記錄的 <code>user_id</code> value 將是 <code>@user</code> 的 <code>guid</code> value。</p><h6 id="has-many-source"><a class="anchorlink" href="#has-many-source">4.3.2.9 <code>:source</code></a></h6><p><code>:source</code> 選項為 <code>has_many :through</code> association 指定源 association 名稱。僅當無法從 association 名稱自動推斷出源 association 的名稱時，才需要使用此選項。</p><h6 id="has-many-source-type"><a class="anchorlink" href="#has-many-source-type">4.3.2.10 <code>:source_type</code></a></h6><p><code>:source_type</code> 選項為 <code>has_many :through</code> association 指定源 association 型別，該型別透過多型 association 進行。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">has_many</span> <span class="ss">:paperbacks</span><span class="p">,</span> <span class="ss">through: :books</span><span class="p">,</span> <span class="ss">source: :format</span><span class="p">,</span> <span class="ss">source_type: </span><span class="s2">"Paperback"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Hardback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">Paperback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_many :books
  has_many :paperbacks, through: :books, source: :format, source_type: "Paperback"
end

class Book &lt; ApplicationRecord
  belongs_to :format, polymorphic: true
end

class Hardback &lt; ApplicationRecord; end
class Paperback &lt; ApplicationRecord; end
'>Copy</button>
</div>
<h6 id="has-many-through"><a class="anchorlink" href="#has-many-through">4.3.2.11 <code>:through</code></a></h6><p><code>:through</code> 選項指定了一個連線 model，透過它來執行查詢。 <code>has_many :through</code> associations 提供了一種實現多對多關係的方法，如<a href="#the-has-many-through-association">本指南前面部分</a> 所討論的。</p><h6 id="has-many-validate"><a class="anchorlink" href="#has-many-validate">4.3.2.12 <code>:validate</code></a></h6><p>如果將 <code>:validate</code> 選項設定為 <code>false</code>，則無論何時儲存此物件，都不會驗證新的關聯物件。預設情況下，這是 <code>true</code>：儲存此物件時將驗證新的關聯物件。</p><h5 id="has-many"><a class="anchorlink" href="#has-many">4.3.3 <code>has_many</code> 的範圍</a></h5><p>有時您可能希望自定義 <code>has_many</code> 使用的查詢。此類自定義可以透過範圍塊實現。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">processed: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, -&gt; { where processed: true }
end
">Copy</button>
</div>
<p>您可以在範圍塊內使用任何標準的 <a href="active_record_querying.html">查詢方法</a>。下面討論以下內容：</p>
<ul>
<li><code>where</code></li>
<li><code>extending</code></li>
<li><code>group</code></li>
<li><code>includes</code></li>
<li><code>limit</code></li>
<li><code>offset</code></li>
<li><code>order</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
<li><code>distinct</code></li>
</ul>
<h6 id="has-many-where"><a class="anchorlink" href="#has-many-where">4.3.3.1 <code>where</code></a></h6><p><code>where</code> 方法允許您指定關聯物件必須滿足的條件。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:confirmed_books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"confirmed = 1"</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_many :confirmed_books, -&gt; { where "confirmed = 1" },
    class_name: "Book"
end
'>Copy</button>
</div>
<p>您還可以透過雜湊設定條件：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:confirmed_books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">confirmed: </span><span class="kp">true</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_many :confirmed_books, -&gt; { where confirmed: true },
    class_name: "Book"
end
'>Copy</button>
</div>
<p>如果您使用雜湊樣式的 <code>where</code> 選項，則透過此 association 建立的記錄將使用雜湊自動確定範圍。在這種情況下，使用 <code>@author.confirmed_books.create</code> 或 <code>@author.confirmed_books.build</code> 將建立確認列具有 value <code>true</code> 的書籍。</p><h6 id="has-many-extending"><a class="anchorlink" href="#has-many-extending">4.3.3.2 <code>extending</code></a></h6><p><code>extending</code> 方法指定一個命名的 module 來擴充套件關聯代理。 Association 擴充套件在<a href="#association-extensions">本指南後面</a> 中進行了詳細討論。</p><h6 id="has-many-group"><a class="anchorlink" href="#has-many-group">4.3.3.3 <code>group</code></a></h6><p><code>group</code> 方法使用查詢程式 SQL 中的 <code>GROUP BY</code> 子句提供一個屬性名稱來對結果集進行分組。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s1">'books.id'</span> <span class="p">},</span>
                      <span class="ss">through: :books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :chapters, -&gt; { group 'books.id' },
                      through: :books
end
">Copy</button>
</div>
<h6 id="has-many-includes"><a class="anchorlink" href="#has-many-includes">4.3.3.4 <code>includes</code></a></h6><p>您可以使用 <code>includes</code> 方法指定使用此關聯時應立即載入的二階 associations。例如，考慮這些 models：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books
end

class Book &lt; ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Chapter &lt; ApplicationRecord
  belongs_to :book
end
">Copy</button>
</div>
<p>如果您經常直接從作者 (<code>@author.books.chapters</code>) 處檢索章節，那麼您可以透過在 association 中包含從作者到書籍的章節來提高程式碼效率：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:chapters</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:chapters</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Chapter</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, -&gt; { includes :chapters }
end

class Book &lt; ApplicationRecord
  belongs_to :author
  has_many :chapters
end

class Chapter &lt; ApplicationRecord
  belongs_to :book
end
">Copy</button>
</div>
<h6 id="has-many-limit"><a class="anchorlink" href="#has-many-limit">4.3.3.5 <code>limit</code></a></h6><p><code>limit</code> 方法允許您限制將透過 association 獲取的物件總數。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:recent_books</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">'published_at desc'</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="p">},</span>
    <span class="ss">class_name: </span><span class="s2">"Book"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :recent_books,
    -&gt; { order('published_at desc').limit(100) },
    class_name: &quot;Book&quot;
end
">Copy</button>
</div>
<h6 id="has-many-offset"><a class="anchorlink" href="#has-many-offset">4.3.3.6 <code>offset</code></a></h6><p><code>offset</code> 方法允許您指定透過 association 獲取物件的起始偏移量。例如，<code>-&gt; { offset(11) }</code> 將跳過前 11 條記錄。</p><h6 id="has-many-order"><a class="anchorlink" href="#has-many-order">4.3.3.7 <code>order</code></a></h6><p><code>order</code> 方法規定了接收關聯物件的順序（在 SQL <code>ORDER BY</code> 子句使用的語法中）。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">"date_confirmed DESC"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Author &lt; ApplicationRecord
  has_many :books, -&gt; { order "date_confirmed DESC" }
end
'>Copy</button>
</div>
<h6 id="has-many-readonly"><a class="anchorlink" href="#has-many-readonly">4.3.3.8 <code>readonly</code></a></h6><p>如果您使用 <code>readonly</code> 方法，那麼透過 association 檢索時關聯的物件將是隻讀的。</p><h6 id="has-many-select"><a class="anchorlink" href="#has-many-select">4.3.3.9 <code>select</code></a></h6><p><code>select</code> 方法允許您覆蓋用於檢索有關關聯物件的資料的 SQL <code>SELECT</code> 子句。預設情況下，Rails 檢索所有列。</p><div class="warning"><p>如果您指定自己的 <code>select</code>，請確保包含關聯的 model 的主要 key 和外部 key 列。如果不這樣做，Rails 將丟擲錯誤。</p></div><h6 id="has-many-distinct"><a class="anchorlink" href="#has-many-distinct">4.3.3.10 <code>distinct</code></a></h6><p>使用 <code>distinct</code> 方法保持集合沒有重複。這是
與 <code>:through</code> 選項一起使用最有用。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">through: :readings</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  has_many :readings
  has_many :articles, through: :readings
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'John'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Article</span> <span class="ss">id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"a1"</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Article</span> <span class="ss">id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"a1"</span><span class="kt">&gt;</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">12</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">5</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">13</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">5</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create(name: 'John')
article = Article.create(name: 'a1')
person.articles &lt;&lt; article
person.articles &lt;&lt; article
person.articles.to_a
Reading.all.to_a
">Copy</button>
</div>
<p>在上面的例子中，有兩個讀數，<code>person.articles</code> 帶出兩個
即使這些記錄指向同一篇文章。</p><p>現在讓我們設定 <code>distinct</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">distinct</span> <span class="p">},</span> <span class="ss">through: :readings</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person
  has_many :readings
  has_many :articles, -&gt; { distinct }, through: :readings
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Article</span> <span class="ss">id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"a1"</span><span class="kt">&gt;</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">16</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">7</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">17</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">7</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create(name: 'Honda')
article = Article.create(name: 'a1')
person.articles &lt;&lt; article
person.articles &lt;&lt; article
person.articles.to_a
Reading.all.to_a
">Copy</button>
</div>
<p>在上述情況下，仍然有兩個讀數。但是 <code>person.articles</code> 顯示
只有一篇文章，因為該集合僅載入唯一記錄。</p><p>如果您想確保在插入時，
持久化的 association 是不同的（這樣你就可以確定當你
檢查 association 你永遠不會發現重複記錄），你應該
在表本身上新增唯一索引。例如，如果您有一個名為的表
<code>readings</code> 並且您想確保文章只能新增到一個人一次，
您可以在 migration 中新增以下內容：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">add_index</span> <span class="ss">:readings</span><span class="p">,</span> <span class="p">[</span><span class="ss">:person_id</span><span class="p">,</span> <span class="ss">:article_id</span><span class="p">],</span> <span class="ss">unique: </span><span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="add_index :readings, [:person_id, :article_id], unique: true
">Copy</button>
</div>
<p>一旦你有了這個唯一的索引，嘗試將文章新增到一個人兩次
將引發 <code>ActiveRecord::RecordNotUnique</code> 錯誤：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="go">ActiveRecord::RecordNotUnique
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create(name: 'Honda')
article = Article.create(name: 'a1')
person.articles &lt;&lt; article
person.articles &lt;&lt; article
">Copy</button>
</div>
<p>請注意，使用 <code>include?</code> 之類的東西檢查唯一性是主題
競爭條件。不要嘗試使用 <code>include?</code> 來強制區分
在 association 中。例如，使用上面的文章示例，
下面的程式碼會很活潑，因為多個使用者可能正在嘗試這個
同時：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span> <span class="k">unless</span> <span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person.articles &lt;&lt; article unless person.articles.include?(article)
">Copy</button>
</div>
<h5 id="has-many-association-"><a class="anchorlink" href="#has-many-association-">4.3.4 什麼時候儲存物件？</a></h5><p>當您將物件分配給 <code>has_many</code> association 時，該物件會自動儲存（以更新其外部 key）。如果在一個語句中分配多個物件，則它們都將被儲存。</p><p>如果這些儲存中的任何一個由於驗證錯誤而失敗，則賦值語句返回 <code>false</code> 並且賦值本身被取消。</p><p>如果父物件（宣告 <code>has_many</code> association 的物件）未儲存（即 <code>new_record?</code> 返回 <code>true</code>），則在新增子物件時不會儲存它們。 association 中所有未儲存的成員會在父儲存時自動儲存。</p><p>如果要將物件分配給 <code>has_many</code> association 而不儲存該物件，請使用 <code>collection.build</code> 方法。</p><h4 id="has-and-belongs-to-many-association"><a class="anchorlink" href="#has-and-belongs-to-many-association">4.4 <code>has_and_belongs_to_many</code> Association 參考</a></h4><p><code>has_and_belongs_to_many</code> association 與另一個 model 建立多對多關係。在資料庫術語中，這透過一箇中間連線表關聯兩個類，其中包含引用每個類的外部 keys。</p><h5 id="has-and-belongs-to-many"><a class="anchorlink" href="#has-and-belongs-to-many">4.4.1 方法由 <code>has_and_belongs_to_many</code> 新增</a></h5><p>當你宣告一個 <code>has_and_belongs_to_many</code> association 時，宣告類會自動獲得幾個與 association 相關的方法：</p>
<ul>
<li><code>collection</code></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;(object, ...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete(object, ...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy(object, ...)</code></a></li>
<li><code>collection=(objects)</code></li>
<li><code>collection_singular_ids</code></li>
<li><code>collection_singular_ids=(ids)</code></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find(...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where(...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?(...)</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build(attributes = {})</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create(attributes = {})</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create-21"><code>collection.create!(attributes = {})</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a></li>
</ul>
<p>在所有這些方法中，<code>collection</code> 被替換為作為第一個引數傳遞給 <code>has_and_belongs_to_many</code> 的 symbol，而 <code>collection_singular</code> 被替換為該 symbol 的單數版本。例如，給定宣告：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Part &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies
end
">Copy</button>
</div>
<p><code>Part</code> model 的每個實例都有這些方法：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">assemblies</span>
<span class="n">assemblies</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="o">=</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
<span class="n">assembly_ids</span>
<span class="n">assembly_ids</span><span class="o">=</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">clear</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">empty?</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">size</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">...</span><span class="p">)</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
<span class="n">assemblies</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="assemblies
assemblies&lt;&lt;(object, ...)
assemblies.delete(object, ...)
assemblies.destroy(object, ...)
assemblies=(objects)
assembly_ids
assembly_ids=(ids)
assemblies.clear
assemblies.empty?
assemblies.size
assemblies.find(...)
assemblies.where(...)
assemblies.exists?(...)
assemblies.build(attributes = {}, ...)
assemblies.create(attributes = {})
assemblies.create!(attributes = {})
assemblies.reload
">Copy</button>
</div>
<h6 id=""><a class="anchorlink" href="#">4.4.1.1 附加列方法</a></h6><p>如果 <code>has_and_belongs_to_many</code> association 的連線表除了兩個外部 keys 之外還有其他列，這些列將作為屬性新增到透過該 association 檢索的記錄中。帶有附加屬性的記錄將始終是隻讀的，因為 Rails 無法儲存對這些屬性的更改。</p><div class="warning"><p>不推薦在 <code>has_and_belongs_to_many</code> association 中的連線表上使用額外屬性。如果您需要在以多對多關係連線兩個 models 的表上進行這種複雜的行為，您應該使用 <code>has_many :through</code> association 而不是 <code>has_and_belongs_to_many</code>。</p></div><h6 id="has-and-belongs-to-many-collection"><a class="anchorlink" href="#has-and-belongs-to-many-collection">4.4.1.2 <code>collection</code></a></h6><p><code>collection</code> 方法返回所有關聯物件的 Relation。如果沒有關聯的物件，則返回一個空的 Relation。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assemblies = @part.assemblies
">Copy</button>
</div>
<h6 id="has-and-belongs-to-many-collection-object"><a class="anchorlink" href="#has-and-belongs-to-many-collection-object">4.4.1.3 <code>collection&lt;&lt;(object, ...)</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C"><code>collection&lt;&lt;</code></a> 方法透過在連線表中建立記錄將一個或多個物件新增到集合中。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span> <span class="o">&lt;&lt;</span> <span class="vi">@assembly1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@part.assemblies &lt;&lt; @assembly1
">Copy</button>
</div>
<div class="note"><p>此方法別名為 <code>collection.concat</code> 和 <code>collection.push</code>。</p></div><h6 id="has-and-belongs-to-many-collection-delete-object"><a class="anchorlink" href="#has-and-belongs-to-many-collection-delete-object">4.4.1.4 <code>collection.delete(object, ...)</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete"><code>collection.delete</code></a> 方法透過刪除連線表中的記錄從集合中刪除一個或多個物件。這不會破壞物件。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@part.assemblies.delete(@assembly1)
">Copy</button>
</div>
<h6 id="has-and-belongs-to-many-collection-destroy-object"><a class="anchorlink" href="#has-and-belongs-to-many-collection-destroy-object">4.4.1.5 <code>collection.destroy(object, ...)</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy"><code>collection.destroy</code></a> 方法透過刪除連線表中的記錄從集合中刪除一個或多個物件。這不會破壞物件。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@part.assemblies.destroy(@assembly1)
">Copy</button>
</div>
<h6 id="has-and-belongs-to-many-collection-objects"><a class="anchorlink" href="#has-and-belongs-to-many-collection-objects">4.4.1.6 <code>collection=(objects)</code></a></h6><p><code>collection=</code> 方法透過適當地新增和刪除，使集合只包含提供的物件。更改將持久儲存到資料庫中。</p><h6 id="has-and-belongs-to-many-collection-singular-ids"><a class="anchorlink" href="#has-and-belongs-to-many-collection-singular-ids">4.4.1.7 <code>collection_singular_ids</code></a></h6><p><code>collection_singular_ids</code> 方法返回集合中物件的 id 陣列。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly_ids</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assembly_ids</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly_ids = @part.assembly_ids
">Copy</button>
</div>
<h6 id="has-and-belongs-to-many-collection-singular-ids-ids"><a class="anchorlink" href="#has-and-belongs-to-many-collection-singular-ids-ids">4.4.1.8 <code>collection_singular_ids=(ids)</code></a></h6><p><code>collection_singular_ids=</code> 方法透過適當地新增和刪除，使集合僅包含由提供的主 key values 標識的物件。更改將持久儲存到資料庫中。</p><h6 id="has-and-belongs-to-many-collection-clear"><a class="anchorlink" href="#has-and-belongs-to-many-collection-clear">4.4.1.9 <code>collection.clear</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear"><code>collection.clear</code></a> 方法透過從連線表中刪除行來從集合中刪除每個物件。這不會破壞關聯的物件。</p><h6 id="has-and-belongs-to-many-collection-empty-questionmark"><a class="anchorlink" href="#has-and-belongs-to-many-collection-empty-questionmark">4.4.1.10 <code>collection.empty?</code></a></h6><p>如果集合不包含任何關聯物件，則 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F"><code>collection.empty?</code></a> 方法返回 <code>true</code>。</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
  This part is not used in any assemblies
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;% if @part.assemblies.empty? %&gt;
  This part is not used in any assemblies
&lt;% end %&gt;
">Copy</button>
</div>
<h6 id="has-and-belongs-to-many-collection-size"><a class="anchorlink" href="#has-and-belongs-to-many-collection-size">4.4.1.11 <code>collection.size</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size"><code>collection.size</code></a> 方法返回集合中的物件數。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly_count</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">size</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly_count = @part.assemblies.size
">Copy</button>
</div>
<h6 id="has-and-belongs-to-many-collection-find"><a class="anchorlink" href="#has-and-belongs-to-many-collection-find">4.4.1.12 <code>collection.find(...)</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find"><code>collection.find</code></a> 方法在集合的表中查詢物件。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assembly = @part.assemblies.find(1)
">Copy</button>
</div>
<h6 id="has-and-belongs-to-many-collection-where"><a class="anchorlink" href="#has-and-belongs-to-many-collection-where">4.4.1.13 <code>collection.where(...)</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>collection.where</code></a> 方法根據提供的條件在集合中查詢物件，但物件是延遲載入的，這意味著僅在訪問物件時才查詢資料庫。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@new_assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@new_assemblies = @part.assemblies.where("created_at &gt; ?", 2.days.ago)
'>Copy</button>
</div>
<h6 id="has-and-belongs-to-many-collection-exists-questionmark"><a class="anchorlink" href="#has-and-belongs-to-many-collection-exists-questionmark">4.4.1.14 <code>collection.exists?(...)</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>collection.exists?</code></a> 方法檢查物件是否滿足提供的
條件存在於集合的表中。</p><h6 id="has-and-belongs-to-many-collection-build-attributes"><a class="anchorlink" href="#has-and-belongs-to-many-collection-build-attributes">4.4.1.15 <code>collection.build(attributes = {})</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build"><code>collection.build</code></a> 方法返回關聯型別的新物件。該物件將從傳遞的屬性中實例化，並且將建立透過連線表的連結，但關聯的物件將<em>不</em>被儲存。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">build</span><span class="p">({</span><span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span><span class="p">})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@assembly = @part.assemblies.build({assembly_name: "Transmission housing"})
'>Copy</button>
</div>
<h6 id="has-and-belongs-to-many-collection-create-attributes"><a class="anchorlink" href="#has-and-belongs-to-many-collection-create-attributes">4.4.1.16 <code>collection.create(attributes = {})</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create"><code>collection.create</code></a> 方法返回關聯型別的新物件。這個物件將從傳遞的屬性中實例化，透過連線表的連結將被建立，並且一旦它透過關聯的 model 上指定的所有驗證，關聯的物件<em>將</em>被儲存。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">create</span><span class="p">({</span><span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span><span class="p">})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='@assembly = @part.assemblies.create({assembly_name: "Transmission housing"})
'>Copy</button>
</div>
<h6 id="has-and-belongs-to-many-collection-create-bang-attributes"><a class="anchorlink" href="#has-and-belongs-to-many-collection-create-bang-attributes">4.4.1.17 <code>collection.create!(attributes = {})</code></a></h6><p>與 <code>collection.create</code> 相同，但如果記錄無效則引發 <code>ActiveRecord::RecordInvalid</code>。</p><h6 id="has-and-belongs-to-many-collection-reload"><a class="anchorlink" href="#has-and-belongs-to-many-collection-reload">4.4.1.18 <code>collection.reload</code></a></h6><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload"><code>collection.reload</code></a> 方法返回所有關聯物件的 Relation，強制讀取資料庫。如果沒有關聯的物件，則返回一個空的 Relation。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="@assemblies = @part.assemblies.reload
">Copy</button>
</div>
<h5 id="has-and-belongs-to-many"><a class="anchorlink" href="#has-and-belongs-to-many">4.4.2 <code>has_and_belongs_to_many</code> 的選項</a></h5><p>儘管 Rails 使用在大多數情況下都能很好地工作的智慧預設值，但有時您可能希望自定義 <code>has_and_belongs_to_many</code> association 引用的行為。透過在建立 association 時傳遞選項，可以輕鬆完成此類自定義。例如，這個 association 使用兩個這樣的選項：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">readonly</span> <span class="p">},</span>
                                       <span class="ss">autosave: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies, -&gt; { readonly },
                                       autosave: true
end
">Copy</button>
</div>
<p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many"><code>has_and_belongs_to_many</code></a> association 支援以下選項：</p>
<ul>
<li><code>:association_foreign_key</code></li>
<li><code>:autosave</code></li>
<li><code>:class_name</code></li>
<li><code>:foreign_key</code></li>
<li><code>:join_table</code></li>
<li><code>:validate</code></li>
</ul>
<h6 id="association-foreign-key"><a class="anchorlink" href="#association-foreign-key">4.4.2.1 <code>:association_foreign_key</code></a></h6><p>按照慣例，Rails 假定連線表中用於儲存指向另一個 model 的外部 key 的列是該 model 的名稱，並添加了字尾 <code>_id</code>。 <code>:association_foreign_key</code> 選項可以讓你直接設定外部 key 的名稱：</p><p>提示：在設定多對多自聯接時，<code>:foreign_key</code> 和 <code>:association_foreign_key</code> 選項很有用。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:friends</span><span class="p">,</span>
      <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span>
      <span class="ss">foreign_key: </span><span class="s2">"this_user_id"</span><span class="p">,</span>
      <span class="ss">association_foreign_key: </span><span class="s2">"other_user_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class User &lt; ApplicationRecord
  has_and_belongs_to_many :friends,
      class_name: "User",
      foreign_key: "this_user_id",
      association_foreign_key: "other_user_id"
end
'>Copy</button>
</div>
<h6 id="has-and-belongs-to-many-autosave"><a class="anchorlink" href="#has-and-belongs-to-many-autosave">4.4.2.2 <code>:autosave</code></a></h6><p>如果您將 <code>:autosave</code> 選項設定為 <code>true</code>，Rails 將儲存任何載入的 association 成員，並在您儲存父物件時銷燬標記為銷燬的成員。將 <code>:autosave</code> 設定為 <code>false</code> 與不設定 <code>:autosave</code> 選項不同。如果 <code>:autosave</code> 選項不存在，則將儲存新的關聯物件，但不會儲存更新的關聯物件。</p><h6 id="has-and-belongs-to-many-class-name"><a class="anchorlink" href="#has-and-belongs-to-many-class-name">4.4.2.3 <code>:class_name</code></a></h6><p>如果其他 model 的名稱無法從 association 名稱派生，您可以使用 <code>:class_name</code> 選項來提供 model 名稱。例如，如果一個零件有許多元件，但包含元件的 model 的實際名稱是 <code>Gadget</code>，您可以這樣設定：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Gadget"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies, class_name: "Gadget"
end
'>Copy</button>
</div>
<h6 id="has-and-belongs-to-many-foreign-key"><a class="anchorlink" href="#has-and-belongs-to-many-foreign-key">4.4.2.4 <code>:foreign_key</code></a></h6><p>按照慣例，Rails 假設連線表中用於儲存指向此 model 的外部 key 的列是此 model 的名稱，並添加了字尾 <code>_id</code>。 <code>:foreign_key</code> 選項可以讓你直接設定外部 key 的名稱：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:friends</span><span class="p">,</span>
      <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span>
      <span class="ss">foreign_key: </span><span class="s2">"this_user_id"</span><span class="p">,</span>
      <span class="ss">association_foreign_key: </span><span class="s2">"other_user_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class User &lt; ApplicationRecord
  has_and_belongs_to_many :friends,
      class_name: "User",
      foreign_key: "this_user_id",
      association_foreign_key: "other_user_id"
end
'>Copy</button>
</div>
<h6 id="join-table"><a class="anchorlink" href="#join-table">4.4.2.5 <code>:join_table</code></a></h6><p>如果根據詞法排序的連線表的預設名稱不是您想要的，您可以使用 <code>:join_table</code> 選項來覆蓋預設值。</p><h6 id="has-and-belongs-to-many-validate"><a class="anchorlink" href="#has-and-belongs-to-many-validate">4.4.2.6 <code>:validate</code></a></h6><p>如果將 <code>:validate</code> 選項設定為 <code>false</code>，則無論何時儲存此物件，都不會驗證新的關聯物件。預設情況下，這是 <code>true</code>：儲存此物件時將驗證新的關聯物件。</p><h5 id="has-and-belongs-to-many"><a class="anchorlink" href="#has-and-belongs-to-many">4.4.3 <code>has_and_belongs_to_many</code> 的範圍</a></h5><p>有時您可能希望自定義 <code>has_and_belongs_to_many</code> 使用的查詢。此類自定義可以透過範圍塊實現。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies, -&gt; { where active: true }
end
">Copy</button>
</div>
<p>您可以在範圍塊內使用任何標準的 <a href="active_record_querying.html">查詢方法</a>。下面討論以下內容：</p>
<ul>
<li><code>where</code></li>
<li><code>extending</code></li>
<li><code>group</code></li>
<li><code>includes</code></li>
<li><code>limit</code></li>
<li><code>offset</code></li>
<li><code>order</code></li>
<li><code>readonly</code></li>
<li><code>select</code></li>
<li><code>distinct</code></li>
</ul>
<h6 id="has-and-belongs-to-many-where"><a class="anchorlink" href="#has-and-belongs-to-many-where">4.4.3.1 <code>where</code></a></h6><p><code>where</code> 方法允許您指定關聯物件必須滿足的條件。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"factory = 'Seattle'"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -&gt; { where &quot;factory = 'Seattle'&quot; }
end
">Copy</button>
</div>
<p>您還可以透過雜湊設定條件：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">factory: </span><span class="s1">'Seattle'</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -&gt; { where factory: 'Seattle' }
end
">Copy</button>
</div>
<p>如果您使用雜湊樣式 <code>where</code>，則透過此 association 建立的記錄將使用雜湊自動確定範圍。在這種情況下，使用 <code>@parts.assemblies.create</code> 或 <code>@parts.assemblies.build</code> 將建立其中 <code>factory</code> 列具有 value“西雅圖”的訂單。</p><h6 id="has-and-belongs-to-many-extending"><a class="anchorlink" href="#has-and-belongs-to-many-extending">4.4.3.2 <code>extending</code></a></h6><p><code>extending</code> 方法指定一個命名的 module 來擴充套件關聯代理。 Association 擴充套件在<a href="#association-extensions">本指南後面</a> 中進行了詳細討論。</p><h6 id="has-and-belongs-to-many-group"><a class="anchorlink" href="#has-and-belongs-to-many-group">4.4.3.3 <code>group</code></a></h6><p><code>group</code> 方法使用查詢程式 SQL 中的 <code>GROUP BY</code> 子句提供一個屬性名稱來對結果集進行分組。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s2">"factory"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies, -&gt; { group "factory" }
end
'>Copy</button>
</div>
<h6 id="has-and-belongs-to-many-includes"><a class="anchorlink" href="#has-and-belongs-to-many-includes">4.4.3.4 <code>includes</code></a></h6><p>您可以使用 <code>includes</code> 方法指定使用此關聯時應立即載入的二階 associations。</p><h6 id="has-and-belongs-to-many-limit"><a class="anchorlink" href="#has-and-belongs-to-many-limit">4.4.3.5 <code>limit</code></a></h6><p><code>limit</code> 方法允許您限制將透過 association 獲取的物件總數。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s2">"created_at DESC"</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -&gt; { order("created_at DESC").limit(50) }
end
'>Copy</button>
</div>
<h6 id="has-and-belongs-to-many-offset"><a class="anchorlink" href="#has-and-belongs-to-many-offset">4.4.3.6 <code>offset</code></a></h6><p><code>offset</code> 方法允許您指定透過 association 獲取物件的起始偏移量。例如，如果您設定 <code>offset(11)</code>，它將跳過前 11 條記錄。</p><h6 id="has-and-belongs-to-many-order"><a class="anchorlink" href="#has-and-belongs-to-many-order">4.4.3.7 <code>order</code></a></h6><p><code>order</code> 方法規定了接收關聯物件的順序（在 SQL <code>ORDER BY</code> 子句使用的語法中）。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">"assembly_name ASC"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Parts &lt; ApplicationRecord
  has_and_belongs_to_many :assemblies,
    -&gt; { order "assembly_name ASC" }
end
'>Copy</button>
</div>
<h6 id="has-and-belongs-to-many-readonly"><a class="anchorlink" href="#has-and-belongs-to-many-readonly">4.4.3.8 <code>readonly</code></a></h6><p>如果您使用 <code>readonly</code> 方法，那麼透過 association 檢索時關聯的物件將是隻讀的。</p><h6 id="has-and-belongs-to-many-select"><a class="anchorlink" href="#has-and-belongs-to-many-select">4.4.3.9 <code>select</code></a></h6><p><code>select</code> 方法允許您覆蓋用於檢索有關關聯物件的資料的 SQL <code>SELECT</code> 子句。預設情況下，Rails 檢索所有列。</p><h6 id="has-and-belongs-to-many-distinct"><a class="anchorlink" href="#has-and-belongs-to-many-distinct">4.4.3.10 <code>distinct</code></a></h6><p>使用 <code>distinct</code> 方法從集合中刪除重複項。</p><h5 id="has-and-belongs-to-many-association"><a class="anchorlink" href="#has-and-belongs-to-many-association">4.4.4 什麼時候儲存物件？</a></h5><p>當您將物件分配給 <code>has_and_belongs_to_many</code> association 時，該物件會自動儲存（以更新連線表）。如果在一個語句中分配多個物件，則它們都將被儲存。</p><p>如果這些儲存中的任何一個由於驗證錯誤而失敗，則賦值語句返回 <code>false</code> 並且賦值本身被取消。</p><p>如果父物件（宣告 <code>has_and_belongs_to_many</code> association 的物件）未儲存（即 <code>new_record?</code> 返回 <code>true</code>），則在新增子物件時不會儲存它們。 association 中所有未儲存的成員會在父儲存時自動儲存。</p><p>如果要將物件分配給 <code>has_and_belongs_to_many</code> association 而不儲存該物件，請使用 <code>collection.build</code> 方法。</p><h4 id="association-callbacks"><a class="anchorlink" href="#association-callbacks">4.5 Association Callbacks</a></h4><p>正常的 callbacks 掛鉤到 Active Record 物件的生命週期中，允許您在各個點使用這些物件。例如，您可以使用 <code>:before_save</code> 回呼在儲存物件之前使某些事情發生。</p><p>Association callbacks 與普通的 callbacks 類似，但它們是由集合生命週期中的事件觸發的。 callbacks 有四種可用的關聯：</p>
<ul>
<li><code>before_add</code></li>
<li><code>after_add</code></li>
<li><code>before_remove</code></li>
<li><code>after_remove</code></li>
</ul>
<p>您可以透過向 association 宣告新增選項來定義 association callbacks。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">before_add: :check_credit_limit</span>

  <span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, before_add: :check_credit_limit

  def check_credit_limit(book)
    # ...
  end
end
">Copy</button>
</div>
<p>Rails 將要新增或刪除的物件傳遞給 callback。</p><p>您可以將 callbacks 作為陣列傳遞給單個事件：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span>
    <span class="ss">before_add: </span><span class="p">[</span><span class="ss">:check_credit_limit</span><span class="p">,</span> <span class="ss">:calculate_shipping_charges</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">calculate_shipping_charges</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books,
    before_add: [:check_credit_limit, :calculate_shipping_charges]

  def check_credit_limit(book)
    # ...
  end

  def calculate_shipping_charges(book)
    # ...
  end
end
">Copy</button>
</div>
<p>如果 <code>before_add</code> callback 丟擲 <code>:abort</code>，則該物件不會被新增到
集合。類似地，如果一個 <code>before_remove</code> callback 丟擲 <code>:abort</code>，則
物件不會從集合中刪除：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 如果已達到限制，則不會新增圖書</span>
<span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
  <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="k">if</span> <span class="n">limit_reached?</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 如果已達到限制，則不會新增圖書
def check_credit_limit(book)
  throw(:abort) if limit_reached?
end
">Copy</button>
</div>
<div class="note"><p>這些 callbacks 僅在透過 association 集合新增或刪除關聯物件時呼叫：</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 觸發 `before_add` callback</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span> <span class="o">&lt;&lt;</span> <span class="n">book</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span> <span class="o">=</span> <span class="p">[</span><span class="n">book</span><span class="p">,</span> <span class="n">book2</span><span class="p">]</span>

<span class="c1"># 不觸發 `before_add` callback</span>
<span class="n">book</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">author_id: </span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 觸發 `before_add` callback
author.books &lt;&lt; book
author.books = [book, book2]

# 不觸發 `before_add` callback
book.update(author_id: 1)
">Copy</button>
</div>
<h4 id="association"><a class="anchorlink" href="#association">4.6 Association 擴充套件</a></h4><p>您不僅限於 Rails 自動構建到 association 代理物件中的功能。您還可以透過匿名 modules 擴充套件這些物件，新增新的發現者、建立者或其他方法。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">find_by_book_prefix</span><span class="p">(</span><span class="n">book_number</span><span class="p">)</span>
      <span class="n">find_by</span><span class="p">(</span><span class="ss">category_id: </span><span class="n">book_number</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books do
    def find_by_book_prefix(book_number)
      find_by(category_id: book_number[0..2])
    end
  end
end
">Copy</button>
</div>
<p>如果你有一個應該被很多 associations 共享的擴充套件，你可以使用一個命名的擴充套件 module。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">FindRecentExtension</span>
  <span class="k">def</span> <span class="nf">find_recent</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">5</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:deliveries</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module FindRecentExtension
  def find_recent
    where("created_at &gt; ?", 5.days.ago)
  end
end

class Author &lt; ApplicationRecord
  has_many :books, -&gt; { extending FindRecentExtension }
end

class Supplier &lt; ApplicationRecord
  has_many :deliveries, -&gt; { extending FindRecentExtension }
end
'>Copy</button>
</div>
<p>擴充套件可以使用 <code>proxy_association</code> 訪問器的這三個屬性來引用 association 代理的內部：</p>
<ul>
<li>
<code>proxy_association.owner</code> 返回 association 所屬的物件。</li>
<li>
<code>proxy_association.reflection</code> 返回描述 association 的反射物件。</li>
<li>
<code>proxy_association.target</code> 返回 <code>belongs_to</code> 或 <code>has_one</code> 的關聯物件，或 <code>has_many</code> 或 <code>has_and_belongs_to_many</code> 的關聯物件的集合。</li>
</ul>
<h3 id="sti"><a class="anchorlink" href="#sti">5 單表繼承 (STI)</a></h3><p>有時，您可能希望在不同的 models 之間共享欄位和行為。
假設我們有汽車、摩托車和腳踏車 models。我們會想要分享
<code>color</code> 和 <code>price</code> 欄位以及所有這些欄位的一些方法，但有一些
每個的特定行為，並且也將 controllers 分開。</p><p>首先，讓我們生成基礎 Vehicle model：</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model vehicle <span class="nb">type</span>:string color:string price:decimal<span class="o">{</span>10.2<span class="o">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model vehicle type:string color:string price:decimal{10.2}
">Copy</button>
</div>
<p>您是否注意到我們正在新增“型別”欄位？由於所有 models 將儲存在一個
單個數據庫表，Rails 將在此列中儲存 model 的名稱
正在被拯救。在我們的示例中，這可以是“汽車”、“摩托車”或“腳踏車”。
如果表中沒有“型別”欄位，STI 將無法工作。</p><p>接下來，我們將生成繼承自 Vehicle 的 Car model。為了這，
我們可以使用 <code>--parent=PARENT</code> 選項，它將生成一個 model
從指定的父級繼承並且沒有等效的 migration（因為
表已經存在）。</p><p>例如，要生成 Car model：</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate model car <span class="nt">--parent</span><span class="o">=</span>Vehicle
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model car --parent=Vehicle
">Copy</button>
</div>
<p>生成的 model 將如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">Vehicle</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Car &lt; Vehicle
end
">Copy</button>
</div>
<p>這意味著新增到 Vehicle 的所有行為也可用於 Car ，因為
associations、公共方法等</p><p>建立汽車會將其儲存在 <code>vehicles</code> 表中，“汽車”作為 <code>type</code> 欄位：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Car</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">color: </span><span class="s1">'Red'</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">10000</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Car.create(color: 'Red', price: 10000)
">Copy</button>
</div>
<p>將生成以下 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"vehicles"</span> <span class="p">(</span><span class="nv">"type"</span><span class="p">,</span> <span class="nv">"color"</span><span class="p">,</span> <span class="nv">"price"</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">,</span> <span class="s1">'Red'</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="INSERT INTO &quot;vehicles&quot; (&quot;type&quot;, &quot;color&quot;, &quot;price&quot;) VALUES ('Car', 'Red', 10000)
">Copy</button>
</div>
<p>查詢汽車記錄只會搜尋屬於汽車的車輛：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Car</span><span class="p">.</span><span class="nf">all</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Car.all
">Copy</button>
</div>
<p>將執行如下查詢：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"vehicles"</span> <span class="k">WHERE</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="nv">"type"</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT &quot;vehicles&quot;.* FROM &quot;vehicles&quot; WHERE &quot;vehicles&quot;.&quot;type&quot; IN ('Car')
">Copy</button>
</div>


        <h3>回饋</h3>
        <p>
          我們鼓勵您幫助提高本指南的品質。
        </p>
        <p>
          如果您發現任何拼寫錯誤或資訊錯誤，請提供回饋。
          要開始回饋，您可以閱讀我們的 <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">回饋</a> 部分。
        </p>
        <p>
          您還可能會發現不完整的內容或不是最新的內容。
          請務必為 main 新增任何遺漏的文件。假設是
          <a href="https://edgeguides.rubyonrails.org">非穩定版指南(edge guides)</a> 請先驗證問題是否已經在主分支上解決。
          請前往 <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南寫作準則</a> 查看寫作風格和慣例。
        </p>
        <p>
          如果由於某種原因您發現要修復的內容但無法自行修補，請您 <a href="https://github.com/rails/rails/issues">提出 issue</a>。
        </p>
        <p>關於 Ruby on Rails 的任何類型的討論歡迎提供任何文件至 <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">rubyonrails-docs 討論區</a>。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>本作品已獲得<a href="https://creativecommons.org/licenses/by-sa/4.0/">知識共享署名-相同方式共享 4.0 國際</a>許可</p>
<p>“Rails”、“Ruby on Rails”和 Rails 標誌是 David Heinemeier Hansson 的商標。 保留所有權利。</p>
    </div>
  </div>
</body>
</html>
