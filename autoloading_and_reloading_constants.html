<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>自動載入和重新載入常量 — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="自動載入和重新載入常量 — Ruby on Rails Guides" />
  <meta name="description" content="自動載入和重新載入常量本指南記錄了在 zeitwerk 模式下自動載入和重新載入的工作原理。閱讀本指南後，您將瞭解： 相關的 Rails 設定 專案結構 自動載入、重新載入和預先載入 單表繼承 和更多" />
  <meta property="og:description" content="自動載入和重新載入常量本指南記錄了在 zeitwerk 模式下自動載入和重新載入的工作原理。閱讀本指南後，您將瞭解： 相關的 Rails 設定 專案結構 自動載入、重新載入和預先載入 單表繼承 和更多" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.0</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多資訊請前往 <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        更多在 Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">部落格</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">指南</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">論壇</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">在 GitHub 上做出貢獻</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="返回首頁">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">首頁</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">手冊目錄</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>從這裡開始</dt>
                  <dd><a href="getting_started.html">Rails 入門</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record 基礎</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record 遷移 (Migrations)</a></dd>
                  <dd><a href="active_record_validations.html">Active Record 驗證 (Validations)</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record 回呼 (Callbacks)</a></dd>
                  <dd><a href="association_basics.html">Active Record 關聯 (Associations)</a></dd>
                  <dd><a href="active_record_querying.html">Active Record 查詢介面</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="layouts_and_rendering.html">Rails 中的版面配置(Layouts)和算繪(Rendering)</a></dd>
                  <dd><a href="form_helpers.html">Action View 表單 Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller 概述</a></dd>
                  <dd><a href="routing.html">Rails 從外到內路由</a></dd>
                </div>
                <div class="guides-section">
                  <dt>其他元件</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support 核心擴充套件</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer 基礎知識</a></dd>
                  <dd><a href="active_job_basics.html">Active Job 基礎</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage 概述</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable 概述</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>深入研究</dt>
                  <dd><a href="i18n.html">Rails 國際化 (I18n) API</a></dd>
                  <dd><a href="testing.html">測試 Rails 應用程式</a></dd>
                  <dd><a href="security.html">保護 Rails 應用程式</a></dd>
                  <dd><a href="debugging_rails_applications.html">除錯 Rails 應用程式</a></dd>
                  <dd><a href="configuring.html">設定 Rails 應用程式</a></dd>
                  <dd><a href="command_line.html">Rails 命令列</a></dd>
                  <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">自動載入和重新載入常量</a></dd>
                  <dd><a href="caching_with_rails.html">使用 Rails 快取</a></dd>
                  <dd><a href="api_app.html">將 Rails 用於僅 API 的應用程式</a></dd>
                </div>
                <div class="guides-section">
                  <dt>擴充 rails</dt>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">建立和自定義 Rails 產生器和模板</a></dd>
                </div>
                <div class="guides-section">
                  <dt>貢獻</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API 文件指南</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">指南指南</a></dd>
                </div>
                <div class="guides-section">
                  <dt>政策</dt>
                  <dd><a href="maintenance_policy.html">維修政策</a></dd>
                </div>
                <div class="guides-section">
                  <dt>發行說明</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</a></dd>
                  <dd><a href="6_1_release_notes.html">6.1 版 - 2020 年 12 月</a></dd>
                  <dd><a href="6_0_release_notes.html">6.0 版 - 2019 年 8 月</a></dd>
                  <dd><a href="5_2_release_notes.html">5.2 版 - 2018 年 4 月</a></dd>
                  <dd><a href="5_1_release_notes.html">5.1 版 - 2017 年 4 月</a></dd>
                  <dd><a href="5_0_release_notes.html">5.0 版 - 2016 年 6 月</a></dd>
                  <dd><a href="4_2_release_notes.html">4.2 版 - 2014 年 12 月</a></dd>
                  <dd><a href="4_1_release_notes.html">4.1 版 - 2014 年 4 月</a></dd>
                  <dd><a href="4_0_release_notes.html">4.0 版 - 2013 年 6 月</a></dd>
                  <dd><a href="3_2_release_notes.html">3.2 版 - 2012 年 1 月</a></dd>
                  <dd><a href="3_1_release_notes.html">3.1 版 - 2011 年 8 月</a></dd>
                  <dd><a href="3_0_release_notes.html">3.0 版 - 2010 年 8 月</a></dd>
                  <dd><a href="2_3_release_notes.html">2.3 版 - 2009 年 3 月</a></dd>
                  <dd><a href="2_2_release_notes.html">2.2 版 - 2008 年 11 月</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">貢獻</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">手冊目錄</option>
              <optgroup label="從這裡開始">
                  <option value="getting_started.html">Rails 入門</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record 基礎</option>
                  <option value="active_record_migrations.html">Active Record 遷移 (Migrations)</option>
                  <option value="active_record_validations.html">Active Record 驗證 (Validations)</option>
                  <option value="active_record_callbacks.html">Active Record 回呼 (Callbacks)</option>
                  <option value="association_basics.html">Active Record 關聯 (Associations)</option>
                  <option value="active_record_querying.html">Active Record 查詢介面</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Rails 中的版面配置(Layouts)和算繪(Rendering)</option>
                  <option value="form_helpers.html">Action View 表單 Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller 概述</option>
                  <option value="routing.html">Rails 從外到內路由</option>
              </optgroup>
              <optgroup label="其他元件">
                  <option value="active_support_core_extensions.html">Active Support 核心擴充套件</option>
                  <option value="action_mailer_basics.html">Action Mailer 基礎知識</option>
                  <option value="active_job_basics.html">Active Job 基礎</option>
                  <option value="active_storage_overview.html">Active Storage 概述</option>
                  <option value="action_cable_overview.html">Action Cable 概述</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="深入研究">
                  <option value="i18n.html">Rails 國際化 (I18n) API</option>
                  <option value="testing.html">測試 Rails 應用程式</option>
                  <option value="security.html">保護 Rails 應用程式</option>
                  <option value="debugging_rails_applications.html">除錯 Rails 應用程式</option>
                  <option value="configuring.html">設定 Rails 應用程式</option>
                  <option value="command_line.html">Rails 命令列</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="autoloading_and_reloading_constants.html">自動載入和重新載入常量</option>
                  <option value="caching_with_rails.html">使用 Rails 快取</option>
                  <option value="api_app.html">將 Rails 用於僅 API 的應用程式</option>
              </optgroup>
              <optgroup label="擴充 rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">建立和自定義 Rails 產生器和模板</option>
              </optgroup>
              <optgroup label="貢獻">
                  <option value="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</option>
                  <option value="api_documentation_guidelines.html">API 文件指南</option>
                  <option value="ruby_on_rails_guides_guidelines.html">指南指南</option>
              </optgroup>
              <optgroup label="政策">
                  <option value="maintenance_policy.html">維修政策</option>
              </optgroup>
              <optgroup label="發行說明">
                  <option value="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</option>
                  <option value="6_1_release_notes.html">6.1 版 - 2020 年 12 月</option>
                  <option value="6_0_release_notes.html">6.0 版 - 2019 年 8 月</option>
                  <option value="5_2_release_notes.html">5.2 版 - 2018 年 4 月</option>
                  <option value="5_1_release_notes.html">5.1 版 - 2017 年 4 月</option>
                  <option value="5_0_release_notes.html">5.0 版 - 2016 年 6 月</option>
                  <option value="4_2_release_notes.html">4.2 版 - 2014 年 12 月</option>
                  <option value="4_1_release_notes.html">4.1 版 - 2014 年 4 月</option>
                  <option value="4_0_release_notes.html">4.0 版 - 2013 年 6 月</option>
                  <option value="3_2_release_notes.html">3.2 版 - 2012 年 1 月</option>
                  <option value="3_1_release_notes.html">3.1 版 - 2011 年 8 月</option>
                  <option value="3_0_release_notes.html">3.0 版 - 2010 年 8 月</option>
                  <option value="2_3_release_notes.html">2.3 版 - 2009 年 3 月</option>
                  <option value="2_2_release_notes.html">2.2 版 - 2008 年 11 月</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>自動載入和重新載入常量</h2><p>本指南記錄了在 <code>zeitwerk</code> 模式下自動載入和重新載入的工作原理。</p><p>閱讀本指南後，您將瞭解：</p>
<ul>
<li>相關的 Rails 設定</li>
<li>專案結構</li>
<li>自動載入、重新載入和預先載入</li>
<li>單表繼承</li>
<li>和更多</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#">介紹</a></li>
<li><a href="#">專案結構</a></li>
<li><a href="#config-autoload-paths">config.autoload_paths</a></li>
<li><a href="#config-autoload-once-paths">config.autoload_once_paths</a></li>
<li><a href="#load-path">$LOAD_PATH</a></li>
<li>
<a href="#">重灌</a>

<ul>
<li><a href="#">重新載入和陳舊的物件</a></li>
</ul>
</li>
<li>
<a href="#">應用程式啟動時自動載入</a>

<ul>
<li><a href="#1">用例 1：在引導期間，載入可重新載入的程式碼</a></li>
<li><a href="#2">用例 2：在引導期間，載入保持快取的程式碼</a></li>
</ul>
</li>
<li><a href="#">急切載入</a></li>
<li><a href="#">單表繼承</a></li>
<li><a href="#">自定義變化</a></li>
<li><a href="#">自動載入和引擎</a></li>
<li><a href="#">故障排除</a></li>
<li><a href="#rails-autoloaders">Rails.autoloaders</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id=""><a class="anchorlink" href="#">1 介紹</a></h3><p>資訊。本指南記錄了 Rails 應用程式中的自動載入、重新載入和預先載入。</p><p>在普通的 Ruby 程式中，依賴需要手動載入。例如，以下 controller 使用類 <code>ApplicationController</code> 和 <code>Post</code>，通常您需要為它們放置 <code>require</code> 呼叫：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="err">＃</span> <span class="err">不要這樣做。</span>
<span class="nb">require</span> <span class="s2">"application_controller"</span>
<span class="nb">require</span> <span class="s2">"post"</span>
<span class="err">＃</span> <span class="err">不要這樣做。</span>

<span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='＃ 不要這樣做。
require "application_controller"
require "post"
＃ 不要這樣做。

class PostsController &lt; ApplicationController
  def index
    @posts = Post.all
  end
end
'>Copy</button>
</div>
<p>這不是 Rails 應用程式的情況，應用程式類和 modules 隨處可用：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@posts</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class PostsController &lt; ApplicationController
  def index
    @posts = Post.all
  end
end
">Copy</button>
</div>
<p>慣用的 Rails 應用程式僅發出 <code>require</code> 呼叫以從其 <code>lib</code> 目錄、Ruby 標準庫、Ruby gems 等載入內容。也就是說，任何不屬於其自動載入路徑的內容，如下所述。</p><p>為了提供此功能，Rails 代表您管理了幾個 <a href="https://github.com/fxn/zeitwerk">Zeitwerk</a> 載入器。</p><h3 id=""><a class="anchorlink" href="#">2 專案結構</a></h3><p>在 Rails 應用程式中，檔名必須與它們定義的常量匹配，目錄充當名稱空間。</p><p>例如，檔案 <code>app/helpers/users_helper.rb</code> 應定義 <code>UsersHelper</code>，檔案 <code>app/controllers/admin/payments_controller.rb</code> 應定義 <code>Admin::PaymentsController</code>。</p><p>預設情況下，Rails 將 Zeitwerk 設定為使用 <code>String#camelize</code> 來改變檔名。例如，它期望 <code>app/controllers/users_controller.rb</code> 定義常量 <code>UsersController</code> 因為</p><div class="code_container">
<pre><code class="highlight ruby"><span class="s2">"users_controller"</span><span class="p">.</span><span class="nf">camelize</span> <span class="c1"># =&gt; UsersController</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='"users_controller".camelize # =&gt; UsersController
'>Copy</button>
</div>
<p>下面的 <em>Customizing Inflections</em> 部分記錄了覆蓋此預設值的方法。</p><p>請檢視 <a href="https://github.com/fxn/zeitwerk#file-structure">Zeitwerk 文件</a> 瞭解更多詳情。</p><h3 id="config-autoload-paths"><a class="anchorlink" href="#config-autoload-paths">3 config.autoload_paths</a></h3><p>我們將其內容要自動載入和（可選）重新載入的應用程式目錄列表​​稱為<em>自動載入路徑</em>。例如，<code>app/models</code>。這樣的目錄代表根名稱空間：<code>Object</code>。</p><p>資訊。自動載入路徑在 Zeitwerk 文件中稱為 <em>root 目錄</em>，但我們將在本指南中使用“自動載入路徑”。</p><p>在自動載入路徑中，檔名必須與它們定義的常量相匹配 <a href="https://github.com/fxn/zeitwerk#file-structure">此處</a>。</p><p>預設情況下，應用程式的自動載入路徑由應用程式啟動時存在的 <code>app</code> 的所有子目錄組成---除了 <code>assets</code>、<code>javascript</code> 和 <code>views</code>---加上它可能依賴的引擎的自動載入路徑。</p><p>例如，如果 <code>UsersHelper</code> 在 <code>app/helpers/users_helper.rb</code> 中實現，則 module 是可自動載入的，您不需要（也不應該編寫）對它的 <code>require</code> 呼叫：</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>runner <span class="s1">'p UsersHelper'</span>
<span class="go">UsersHelper
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails runner 'p UsersHelper'
">Copy</button>
</div>
<p>Rails 會自動將 <code>app</code> 下的自定義目錄新增到自動載入路徑中。例如，如果您的應用程式具有 <code>app/presenters</code>，則您無需設定任何內容即可自動載入演示者，它開箱即用。</p><p>預設自動載入路徑陣列可以透過在 <code>config/application.rb</code> 或 <code>config/environments/*.rb</code> 中推送到 <code>config.autoload_paths</code> 來擴充套件。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="si">#{</span><span class="n">root</span><span class="si">}</span><span class="s2">/extras"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module MyApplication
  class Application &lt; Rails::Application
    config.autoload_paths &lt;&lt; "#{root}/extras"
  end
end
'>Copy</button>
</div>
<p>此外，引擎可以推入引擎類的主體和它們自己的 <code>config/environments/*.rb</code>。</p><p>警告。請不要變異<code>ActiveSupport::Dependencies.autoload_paths</code>；更改自動載入路徑的公共介面是 <code>config.autoload_paths</code>。</p><div class="warning"><p>在應用程式啟動時，您不能在自動載入路徑中自動載入程式碼。特別是，直接在<code>config/initializers/*.rb</code>。請檢查 <a href="#autoloading-when-the-application-boots"><em>Autoloading when the application boots</em></a> 下面的有效方法。</p></div><p>自動載入路徑由 <code>Rails.autoloaders.main</code> 自動載入器管理。</p><h3 id="config-autoload-once-paths"><a class="anchorlink" href="#config-autoload-once-paths">4 config.autoload_once_paths</a></h3><p>您可能希望無需重新載入即可自動載入類和 modules。自動載入一次路徑儲存可以自動載入但不會重新載入的程式碼。</p><p>預設情況下，此集合為空，但您可以將其擴充套件到 <code>config.autoload_once_paths</code>。您可以在 <code>config/application.rb</code> 或 <code>config/environments/*.rb</code> 中執行此操作。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">autoload_once_paths</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="si">#{</span><span class="n">root</span><span class="si">}</span><span class="s2">/app/serializers"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module MyApplication
  class Application &lt; Rails::Application
    config.autoload_once_paths &lt;&lt; "#{root}/app/serializers"
  end
end
'>Copy</button>
</div>
<p>此外，引擎可以推入引擎類的主體和它們自己的 <code>config/environments/*.rb</code>。</p><p>資訊。如果 <code>app/serializers</code> 被推送到 <code>config.autoload_once_paths</code>，Rails 不再認為這是一個自動載入路徑，儘管它是 <code>app</code> 下的自定義目錄。此設定會覆蓋該規則。</p><p>這是用於類的 key 和快取在重新載入後仍然存在的位置的 modules，例如 Rails 框架本身。</p><p>例如，Active Job 序列化器儲存在 Active Job 中：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/custom_serializers.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">active_job</span><span class="p">.</span><span class="nf">custom_serializers</span> <span class="o">&lt;&lt;</span> <span class="no">MoneySerializer</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/initializers/custom_serializers.rb
Rails.application.config.active_job.custom_serializers &lt;&lt; MoneySerializer
">Copy</button>
</div>
<p>並且 Active Job 本身不會在重新載入時重新載入，只有自動載入路徑中的應用程式和引擎程式碼才會重新載入。</p><p>使 <code>MoneySerializer</code> 可重新載入會令人困惑，因為重新載入編輯過的版本不會影響儲存在 Active Job 中的類物件。事實上，如果 <code>MoneySerializer</code> 是可重新載入的，那麼從 Rails 7 開始，這樣的初始化器會引發一個 <code>NameError</code>。</p><p>另一個用例是引擎裝飾框架類：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">initializer</span> <span class="s2">"decorate ActionController::Base"</span> <span class="k">do</span>
  <span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:action_controller_base</span><span class="p">)</span> <span class="k">do</span>
    <span class="kp">include</span> <span class="no">MyDecoration</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='initializer "decorate ActionController::Base" do
  ActiveSupport.on_load(:action_controller_base) do
    include MyDecoration
  end
end
'>Copy</button>
</div>
<p>在那裡，在初始化程式執行時儲存在 <code>MyDecoration</code> 中的 module 物件成為 <code>ActionController::Base</code> 的祖先，並且重新載入 <code>MyDecoration</code> 沒有意義，它不會影響該祖先鏈。</p><p>來自自動載入一次路徑的類和 modules 可以在 <code>config/initializers</code> 中自動載入。因此，使用該設定可以正常工作：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/custom_serializers.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">active_job</span><span class="p">.</span><span class="nf">custom_serializers</span> <span class="o">&lt;&lt;</span> <span class="no">MoneySerializer</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/initializers/custom_serializers.rb
Rails.application.config.active_job.custom_serializers &lt;&lt; MoneySerializer
">Copy</button>
</div>
<p>資訊：從技術上講，您可以在 <code>:bootstrap_hook</code> 之後執行的任何初始化程式中自動載入由 <code>once</code> 自動載入器管理的類和 modules。</p><p>一旦路徑由 <code>Rails.autoloaders.once</code> 管理，則自動載入。</p><h3 id="load-path"><a class="anchorlink" href="#load-path">5 $LOAD_PATH</a></h3><p>自動載入路徑預設新增到 <code>$LOAD_PATH</code>。但是，Zeitwerk 在內部使用絕對檔名，並且您的應用程式不應為可自動載入的檔案發出 <code>require</code> 呼叫，因此實際上不需要這些目錄。您可以選擇退出此標誌：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">add_autoload_paths_to_load_path</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.add_autoload_paths_to_load_path = false
">Copy</button>
</div>
<p>由於查詢次數較少，這可能會加快合法的 <code>require</code> 呼叫速度。此外，如果您的應用程式使用 <a href="https://github.com/Shopify/bootsnap">Bootsnap</a>，則可以避免庫構建不必要的索引，並節省它們所需的 RAM。</p><h3 id=""><a class="anchorlink" href="#">6 重灌</a></h3><p>如果自動載入路徑中的應用程式檔案發生更改，Rails 會自動重新載入類和 modules。</p><p>更準確地說，如果 Web 伺服器正在執行並且應用程式檔案已被修改，Rails 會在處理下一個請求之前解除安裝由 <code>main</code> 自動載入器管理的所有自動載入常量。這樣，在該請求期間使用的應用程式類或 modules 將再次自動載入，從而在檔案系統中獲取它們當前的實現。</p><p>可以啟用或禁用重新載入。控制此行為的設定是 <code>config.cache_classes</code>，在 <code>development</code> 模式下預設為 false（啟用重新載入），在 <code>production</code> 模式下預設為 true（禁用重新載入）。</p><p>預設情況下，Rails 使用事件檔案監視器來檢測檔案更改。它可以設定為透過遍歷自動載入路徑來檢測檔案更改。這由 <code>config.file_watcher</code> 設定控制。</p><p>在 Rails 控制檯中，無論 <code>config.cache_classes</code> 的 value 是什麼，都沒有檔案觀察器處於活動狀態。這是因為，通常情況下，在控制檯 session 中間重新載入程式碼會令人困惑。與單個請求類似，您通常希望控制檯 session 由一組一致的、不變的應用程式類和 modules 提供服務。</p><p>但是，您可以透過執行 <code>reload!</code> 在控制檯中強制重新載入：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb(main):001:0&gt;</span><span class="w"> </span><span class="no">User</span><span class="p">.</span><span class="nf">object_id</span>
<span class="p">=&gt;</span> <span class="mi">70136277390120</span>
<span class="gp">irb(main):002:0&gt;</span><span class="w"> </span><span class="n">reload!</span>
<span class="go">Reloading...
</span><span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb(main):003:0&gt;</span><span class="w"> </span><span class="no">User</span><span class="p">.</span><span class="nf">object_id</span>
<span class="p">=&gt;</span> <span class="mi">70136284426020</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="User.object_id
reload!
User.object_id
">Copy</button>
</div>
<p>可以看到，過載後存放在<code>User</code>常量中的類物件是不同的。</p><h4 id=""><a class="anchorlink" href="#">6.1 重新載入和陳舊的物件</a></h4><p>理解 Ruby 沒有辦法在記憶體中真正重新載入類和 modules 並且在它們已經使用的任何地方都反映這一點非常重要。從技術上講，“解除安裝” <code>User</code> 類意味著透過 <code>Object.send(:remove_const, "User")</code> 刪除 <code>User</code> 常量。</p><p>例如，檢視這個 Rails 控制檯 session：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">joe</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">reload!</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">alice</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">joe</span><span class="p">.</span><span class="nf">class</span> <span class="o">==</span> <span class="n">alice</span><span class="p">.</span><span class="nf">class</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="joe = User.new
reload!
alice = User.new
joe.class == alice.class
">Copy</button>
</div>
<p><code>joe</code> 是原始 <code>User</code> 類的實例。當有重新載入時， <code>User</code> 常量然後評估為不同的、重新載入的類。 <code>alice</code> 是新載入的 <code>User</code> 的實例，但 <code>joe</code> 不是——他的類是陳舊的。你可以再次定義 <code>joe</code>，啟動一個 IRB subsession，或者只是啟動一個新的控制檯而不是呼叫 <code>reload!</code>。</p><p>您可能會發現此問題的另一種情況是在未重新載入的位置對可重新載入的類進行子類化：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># lib/vip_user.rb</span>
<span class="k">class</span> <span class="nc">VipUser</span> <span class="o">&lt;</span> <span class="no">User</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# lib/vip_user.rb
class VipUser &lt; User
end
">Copy</button>
</div>
<p>如果重新載入 <code>User</code>，由於 <code>VipUser</code> 不是，因此 <code>VipUser</code> 的超類是原始的陳舊類物件。</p><p>底線：<strong>不要快取可重新載入的類或 modules</strong>。</p><h3 id=""><a class="anchorlink" href="#">7 應用程式啟動時自動載入</a></h3><p>啟動時，應用程式可以從自動載入一次路徑自動載入，這些路徑由 <code>once</code> 自動載入器管理。請檢查上面的 <a href="#config-autoload-once-paths"><code>config.autoload_once_paths</code></a> 部分。</p><p>但是，您不能從由 <code>main</code> 自動載入器管理的自動載入路徑自動載入。這適用於 <code>config/initializers</code> 中的程式碼以及應用程式或引擎初始值設定項。</p><p>為什麼？初始化程式僅在應用程式啟動時執行一次。如果您重新啟動伺服器，它們會在新程序中再次執行，但重新載入不會重新啟動伺服器，並且初始化程式不會再次執行。讓我們看看兩個主要用例。</p><h4 id="1"><a class="anchorlink" href="#1">7.1 用例 1：在引導期間，載入可重新載入的程式碼</a></h4><p>讓我們想象一下 <code>ApiGateway</code> 是一個來自 <code>app/services</code> 的可過載類，由 <code>main</code> 自動載入器管理，你需要在應用程式啟動時設定它的端點：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/api_gateway_setup.rb</span>
<span class="no">ApiGateway</span><span class="p">.</span><span class="nf">endpoint</span> <span class="o">=</span> <span class="s2">"https://example.com"</span> <span class="c1"># DO NOT DO THIS</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# config/initializers/api_gateway_setup.rb
ApiGateway.endpoint = "https://example.com" # DO NOT DO THIS
'>Copy</button>
</div>
<p>重新載入的 <code>ApiGateway</code> 將有一個 <code>nil</code> 端點，因為上面的程式碼不會再次執行。</p><p>您仍然可以在啟動期間進行設定，但您需要將它們包裝在一個 <code>to_prepare</code> 塊中，該塊在啟動時和每次重新載入後執行：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/api_gateway_setup.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">to_prepare</span> <span class="k">do</span>
  <span class="no">ApiGateway</span><span class="p">.</span><span class="nf">endpoint</span> <span class="o">=</span> <span class="s2">"https://example.com"</span> <span class="c1"># CORRECT</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# config/initializers/api_gateway_setup.rb
Rails.application.config.to_prepare do
  ApiGateway.endpoint = "https://example.com" # CORRECT
end
'>Copy</button>
</div>
<div class="note"><p>由於歷史原因，這個 callback 可能會執行兩次。它執行的程式碼必須是冪等的。</p></div><h4 id="2"><a class="anchorlink" href="#2">7.2 用例 2：在引導期間，載入保持快取的程式碼</a></h4><p>某些設定採用類或 module 物件，並將其儲存在不會重新載入的位置。</p><p>一個例子是中介軟體：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">use</span> <span class="no">MyApp</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">Foo</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.middleware.use MyApp::Middleware::Foo
">Copy</button>
</div>
<p>重新載入時，中介軟體堆疊不受影響，因此，啟動時儲存在 <code>MyApp::Middleware::Foo</code> 中的任何物件都將保持陳舊狀態。</p><p>另一個例子是 Active Job 序列化器：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/custom_serializers.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">active_job</span><span class="p">.</span><span class="nf">custom_serializers</span> <span class="o">&lt;&lt;</span> <span class="no">MoneySerializer</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/initializers/custom_serializers.rb
Rails.application.config.active_job.custom_serializers &lt;&lt; MoneySerializer
">Copy</button>
</div>
<p>任何 <code>MoneySerializer</code> 在初始化期間評估的結果都會被推送到自定義序列化程式。如果這是可重新載入的，則初始物件仍將在 Active Job 內，不會反映您的更改。</p><p>另一個例子是透過包含 modules 來裝飾框架類的 railties 或引擎。例如， <a href="https://github.com/hotwired/turbo-rails"><code>turbo-rails</code></a> 以這種方式裝飾 <code>ActiveRecord::Base</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">initializer</span> <span class="s2">"turbo.broadcastable"</span> <span class="k">do</span>
  <span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:active_record</span><span class="p">)</span> <span class="k">do</span>
    <span class="kp">include</span> <span class="no">Turbo</span><span class="o">::</span><span class="no">Broadcastable</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='initializer "turbo.broadcastable" do
  ActiveSupport.on_load(:active_record) do
    include Turbo::Broadcastable
  end
end
'>Copy</button>
</div>
<p>這將一個 module 物件新增到 <code>ActiveRecord::Base</code> 的祖先鏈中。如果重新載入，<code>Turbo::Broadcastable</code> 中的更改將不起作用，祖先鏈仍將具有原始鏈。</p><p>推論：那些類或 modules <strong>不能重新載入</strong>。</p><p>在引導期間引用這些類或 modules 的最簡單方法是將它們定義在不屬於自動載入路徑的目錄中。例如，<code>lib</code> 是一個慣用的選擇。預設情況下它不屬於自動載入路徑，但它屬於 <code>$LOAD_PATH</code>。只需執行正常的 <code>require</code> 即可載入並完成。</p><p>如上所述，另一種選擇是在自動載入一次路徑和自動載入中使用定義它們的目錄。有關詳細資訊，請檢視 <a href="https://edgeguides.rubyonrails.org/autoloading_and_reloading_constants.html#config-autoload-once-paths">關於 config.autoload_once_paths 的部分</a>。</p><h3 id=""><a class="anchorlink" href="#">8 急切載入</a></h3><p>在類似生產的環境中，通常最好在應用程式啟動時載入所有應用程式程式碼。 Eager loading 把所有東西都放在記憶體中，準備好立即處理請求，而且它也是 <a href="https://en.wikipedia.org/wiki/Copy-on-write">CoW</a> 友好的。</p><p>預載入由標誌 <code>config.eager_load</code> 控制，該標誌在 <code>production</code> 模式下預設啟用。</p><p>檔案急切載入的順序是未定義的。</p><p>如果定義了 <code>Zeitwerk</code> 常量，則無論應用程式自動載入模式如何，Rails 都會呼叫 <code>Zeitwerk::Loader.eager_load_all</code>。這確保了 Zeitwerk 管理的依賴項是預先載入的。</p><h3 id=""><a class="anchorlink" href="#">9 單表繼承</a></h3><p>Single Table Inheritance 是一個不能很好地與延遲載入配合使用的特性。原因是：它的 API 通常需要能夠列舉 STI 層次結構才能正常工作，而延遲載入會延遲載入類，直到它們被引用。您無法列舉尚未引用的內容。</p><p>從某種意義上說，無論載入模式如何，應用程式都需要預先載入 STI 層次結構。</p><p>當然，如果應用程式在啟動時立即載入，那已經完成了。如果沒有，在實踐中實例化資料庫中的現有型別就足夠了，這在開發或測試模式下通常很好。一種方法是在您的 <code>lib</code> 目錄中包含一個 STI 預載入 module：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">StiPreload</span>
  <span class="k">unless</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">eager_load</span>
    <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

    <span class="n">included</span> <span class="k">do</span>
      <span class="n">cattr_accessor</span> <span class="ss">:preloaded</span><span class="p">,</span> <span class="ss">instance_accessor: </span><span class="kp">false</span>
    <span class="k">end</span>

    <span class="n">class_methods</span> <span class="k">do</span>
      <span class="k">def</span> <span class="nf">descendants</span>
        <span class="n">preload_sti</span> <span class="k">unless</span> <span class="n">preloaded</span>
        <span class="k">super</span>
      <span class="k">end</span>

      <span class="c1"># Constantizes all types present in the database. There might be more on</span>
      <span class="c1"># disk, but that does not matter in practice as far as the STI API is</span>
      <span class="c1"># concerned.</span>
      <span class="c1">#</span>
      <span class="c1"># Assumes store_full_sti_class is true, the default.</span>
      <span class="k">def</span> <span class="nf">preload_sti</span>
        <span class="n">types_in_db</span> <span class="o">=</span> <span class="p">\</span>
          <span class="n">base_class</span><span class="p">.</span>
            <span class="nf">unscoped</span><span class="p">.</span>
            <span class="nf">select</span><span class="p">(</span><span class="n">inheritance_column</span><span class="p">).</span>
            <span class="nf">distinct</span><span class="p">.</span>
            <span class="nf">pluck</span><span class="p">(</span><span class="n">inheritance_column</span><span class="p">).</span>
            <span class="nf">compact</span>

        <span class="n">types_in_db</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">type</span><span class="o">|</span>
          <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="s2">"Preloading STI type </span><span class="si">#{</span><span class="n">type</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
          <span class="n">type</span><span class="p">.</span><span class="nf">constantize</span>
        <span class="k">end</span>

        <span class="nb">self</span><span class="p">.</span><span class="nf">preloaded</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module StiPreload
  unless Rails.application.config.eager_load
    extend ActiveSupport::Concern

    included do
      cattr_accessor :preloaded, instance_accessor: false
    end

    class_methods do
      def descendants
        preload_sti unless preloaded
        super
      end

      # Constantizes all types present in the database. There might be more on
      # disk, but that does not matter in practice as far as the STI API is
      # concerned.
      #
      # Assumes store_full_sti_class is true, the default.
      def preload_sti
        types_in_db = \
          base_class.
            unscoped.
            select(inheritance_column).
            distinct.
            pluck(inheritance_column).
            compact

        types_in_db.each do |type|
          logger.debug("Preloading STI type #{type}")
          type.constantize
        end

        self.preloaded = true
      end
    end
  end
end
'>Copy</button>
</div>
<p>然後將其包含在專案的 STI 根類中：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/shape.rb</span>
<span class="nb">require</span> <span class="s2">"sti_preload"</span>

<span class="k">class</span> <span class="nc">Shape</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">StiPreload</span> <span class="c1"># Only in the root class.</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# app/models/shape.rb
require "sti_preload"

class Shape &lt; ApplicationRecord
  include StiPreload # Only in the root class.
end
'>Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/polygon.rb</span>
<span class="k">class</span> <span class="nc">Polygon</span> <span class="o">&lt;</span> <span class="no">Shape</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/models/polygon.rb
class Polygon &lt; Shape
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/triangle.rb</span>
<span class="k">class</span> <span class="nc">Triangle</span> <span class="o">&lt;</span> <span class="no">Polygon</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/models/triangle.rb
class Triangle &lt; Polygon
end
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">10 自定義變化</a></h3><p>預設情況下，Rails 使用 <code>String#camelize</code> 來知道給定的檔案或目錄名稱應該定義哪個常量。例如， <code>posts_controller.rb</code> 應該定義 <code>PostsController</code> 因為這是 <code>"posts_controller".camelize</code> 返回的內容。</p><p>可能是某些特定檔案或目錄名稱沒有按照您的意願變形。例如， <code>html_parser.rb</code> 預計預設定義 <code>HtmlParser</code>。如果你更喜歡 <code>HTMLParser</code> 這個類怎麼辦？有幾種方法可以自定義它。</p><p>最簡單的方法是在 <code>config/initializers/inflections.rb</code> 中定義首字母縮略詞：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Inflector</span><span class="p">.</span><span class="nf">inflections</span><span class="p">(</span><span class="ss">:en</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">inflect</span><span class="o">|</span>
  <span class="n">inflect</span><span class="p">.</span><span class="nf">acronym</span> <span class="s2">"HTML"</span>
  <span class="n">inflect</span><span class="p">.</span><span class="nf">acronym</span> <span class="s2">"SSL"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='ActiveSupport::Inflector.inflections(:en) do |inflect|
  inflect.acronym "HTML"
  inflect.acronym "SSL"
end
'>Copy</button>
</div>
<p>這樣做會影響 Active Support 如何全域性變化。這在某些應用程式中可能沒問題，但您也可以透過將覆蓋集合傳遞給預設變形器來自定義如何獨立於 Active Support 自定義單個基本名稱：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/zeitwerk.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">autoloader</span><span class="o">|</span>
  <span class="n">autoloader</span><span class="p">.</span><span class="nf">inflector</span><span class="p">.</span><span class="nf">inflect</span><span class="p">(</span>
    <span class="s2">"html_parser"</span> <span class="o">=&gt;</span> <span class="s2">"HTMLParser"</span><span class="p">,</span>
    <span class="s2">"ssl_error"</span>   <span class="o">=&gt;</span> <span class="s2">"SSLError"</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# config/initializers/zeitwerk.rb
Rails.autoloaders.each do |autoloader|
  autoloader.inflector.inflect(
    "html_parser" =&gt; "HTMLParser",
    "ssl_error"   =&gt; "SSLError"
  )
end
'>Copy</button>
</div>
<p>但是，該技術仍然取決於 <code>String#camelize</code>，因為這是預設變形器用作後備的。如果您不想完全不依賴 Active Support 變形並擁有對變形的絕對控制，請將變形器設定為 <code>Zeitwerk::Inflector</code> 的實例：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/zeitwerk.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">autoloader</span><span class="o">|</span>
  <span class="n">autoloader</span><span class="p">.</span><span class="nf">inflector</span> <span class="o">=</span> <span class="no">Zeitwerk</span><span class="o">::</span><span class="no">Inflector</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">autoloader</span><span class="p">.</span><span class="nf">inflector</span><span class="p">.</span><span class="nf">inflect</span><span class="p">(</span>
    <span class="s2">"html_parser"</span> <span class="o">=&gt;</span> <span class="s2">"HTMLParser"</span><span class="p">,</span>
    <span class="s2">"ssl_error"</span>   <span class="o">=&gt;</span> <span class="s2">"SSLError"</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# config/initializers/zeitwerk.rb
Rails.autoloaders.each do |autoloader|
  autoloader.inflector = Zeitwerk::Inflector.new
  autoloader.inflector.inflect(
    "html_parser" =&gt; "HTMLParser",
    "ssl_error"   =&gt; "SSLError"
  )
end
'>Copy</button>
</div>
<p>沒有可以影響所述實例的全域性設定；它們是確定性的。</p><p>您甚至可以定義自定義變形器以獲得完全的靈活性。請檢視 <a href="https://github.com/fxn/zeitwerk#custom-inflector">Zeitwerk 文件</a> 瞭解更多詳情。</p><h3 id=""><a class="anchorlink" href="#">11 自動載入和引擎</a></h3><p>引擎在父應用程式的上下文中執行，它們的程式碼由父應用程式自動載入、重新載入和預先載入。如果應用程式執行在 <code>zeitwerk</code> 模式下，引擎程式碼以 <code>zeitwerk</code> 模式載入。如果應用程式執行在 <code>classic</code> 模式下，引擎程式碼以 <code>classic</code> 模式載入。</p><p>Rails 啟動時，引擎目錄被新增到自動載入路徑中，從自動載入器的 view 點來看，沒有差別。自動載入器的主要輸入是自動載入路徑，它們是屬於應用程式原始碼樹還是某個引擎原始碼樹是無關緊要的。</p><p>例如，這個應用程式使用 <a href="https://github.com/heartcombo/devise">Devise</a>：</p><div class="code_container">
<pre><code class="highlight plaintext">% bin/rails runner 'pp ActiveSupport::Dependencies.autoload_paths'
[".../app/controllers",
 ".../app/controllers/concerns",
 ".../app/helpers",
 ".../app/models",
 ".../app/models/concerns",
 ".../gems/devise-4.8.0/app/controllers",
 ".../gems/devise-4.8.0/app/helpers",
 ".../gems/devise-4.8.0/app/mailers"]
</code></pre>
<button class="clipboard-button" data-clipboard-text="% bin/rails runner 'pp ActiveSupport::Dependencies.autoload_paths'
[&quot;.../app/controllers&quot;,
 &quot;.../app/controllers/concerns&quot;,
 &quot;.../app/helpers&quot;,
 &quot;.../app/models&quot;,
 &quot;.../app/models/concerns&quot;,
 &quot;.../gems/devise-4.8.0/app/controllers&quot;,
 &quot;.../gems/devise-4.8.0/app/helpers&quot;,
 &quot;.../gems/devise-4.8.0/app/mailers&quot;]
">Copy</button>
</div>
<p>如果引擎控制其父應用程式的自動載入模式，則可以照常編寫引擎。</p><p>但是，如果引擎支援 Rails 6 或 Rails 6.1 並且不控制其父應用程式，則它必須準備好在 <code>classic</code> 或 <code>zeitwerk</code> 模式下執行。需要考慮的事項：</p>
<ol>
<li><p>如果 <code>classic</code> 模式需要一個 <code>require_dependency</code> 呼叫來確保在某個時刻載入一些常量，請寫下它。雖然 <code>zeitwerk</code> 不需要它，但它不會受到傷害，它也可以在 <code>zeitwerk</code> 模式下工作。</p></li>
<li><p><code>classic</code>模式下劃線常量名("User" -&gt; "user.rb")，<code>zeitwerk</code>模式駱駝化檔名("user.rb" -&gt; "User")。它們在大多數情況下是一致的，但如果像“HTMLParser”那樣有一系列連續的大寫字母，它們就不會。相容的最簡單方法是避免使用此類名稱。在這種情況下，最好選擇“HtmlParser”。</p></li>
<li><p>在<code>classic</code>模式下，檔案<code>app/model/concerns/foo.rb</code>允許定義<code>Foo</code>和<code>Concerns::Foo</code>。在 <code>zeitwerk</code> 模式下，只有一種選擇：必須定義 <code>Foo</code>。為了相容，定義<code>Foo</code>。</p></li>
</ol>
<h3 id=""><a class="anchorlink" href="#">12 故障排除</a></h3><p>跟蹤裝載機正在做什麼的最好方法是檢查他們的活動。</p><p>最簡單的方法是包括</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">log!</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.autoloaders.log!
">Copy</button>
</div>
<p>在載入框架預設值後在 <code>config/application.rb</code> 中。這會將跟蹤列印到標準輸出。</p><p>如果您更喜歡記錄到檔案，請設定它：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/log/autoloading.log"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Rails.autoloaders.logger = Logger.new("#{Rails.root}/log/autoloading.log")
'>Copy</button>
</div>
<p>當 <code>config/application.rb</code> 執行時，Rails 記錄器還不可用。如果您更喜歡使用 Rails 記錄器，請在初始化程式中設定此設定：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># config/initializers/log_autoloaders.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/initializers/log_autoloaders.rb
Rails.autoloaders.logger = Rails.logger
">Copy</button>
</div>
<h3 id="rails-autoloaders"><a class="anchorlink" href="#rails-autoloaders">13 Rails.autoloaders</a></h3><p>管理您的應用程式的 Zeitwerk 實例可在</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">main</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">once</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.autoloaders.main
Rails.autoloaders.once
">Copy</button>
</div>
<p>謂詞</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">zeitwerk_enabled?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Rails.autoloaders.zeitwerk_enabled?
">Copy</button>
</div>
<p>在 Rails 7 應用程式中仍然可用，並返回 <code>true</code>。</p>

        <h3>回饋</h3>
        <p>
          我們鼓勵您幫助提高本指南的品質。
        </p>
        <p>
          如果您發現任何拼寫錯誤或資訊錯誤，請提供回饋。
          要開始回饋，您可以閱讀我們的 <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">回饋</a> 部分。
        </p>
        <p>
          您還可能會發現不完整的內容或不是最新的內容。
          請務必為 main 新增任何遺漏的文件。假設是
          <a href="https://edgeguides.rubyonrails.org">非穩定版指南(edge guides)</a> 請先驗證問題是否已經在主分支上解決。
          請前往 <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南寫作準則</a> 查看寫作風格和慣例。
        </p>
        <p>
          如果由於某種原因您發現要修復的內容但無法自行修補，請您 <a href="https://github.com/rails/rails/issues">提出 issue</a>。
        </p>
        <p>關於 Ruby on Rails 的任何類型的討論歡迎提供任何文件至 <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">rubyonrails-docs 討論區</a>。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>本作品已獲得<a href="https://creativecommons.org/licenses/by-sa/4.0/">知識共享署名-相同方式共享 4.0 國際</a>許可</p>
<p>“Rails”、“Ruby on Rails”和 Rails 標誌是 David Heinemeier Hansson 的商標。 保留所有權利。</p>
    </div>
  </div>
</body>
</html>
