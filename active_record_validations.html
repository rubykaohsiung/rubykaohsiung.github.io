<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Active Record 驗證 — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Active Record 驗證 — Ruby on Rails Guides" />
  <meta name="description" content="Active Record 驗證本指南教您如何在物件進入之前驗證物件的狀態 資料庫使用Active Record 的驗證功能。閱讀本指南後，您將瞭解： 如何使用內建的Active Record 驗證helpers。 如何建立您自己的自定義驗證方法。 如何處理驗證過程生成的錯誤訊息。" />
  <meta property="og:description" content="Active Record 驗證本指南教您如何在物件進入之前驗證物件的狀態 資料庫使用Active Record 的驗證功能。閱讀本指南後，您將瞭解： 如何使用內建的Active Record 驗證helpers。 如何建立您自己的自定義驗證方法。 如何處理驗證過程生成的錯誤訊息。" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v6.1.4</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多訊息請訪問 <a href="https://rubyonrails.org/">rubyonrails.org：</a> </strong>
      <span class="red-button more-info-button">
        更多 Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">部落格</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">指南</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">論壇</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">在 GitHub 上做出貢獻</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="返回首頁">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">首頁</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">指南索引</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>從這裡開始</dt>
                  <dd><a href="getting_started.html">Rails 入門</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record 基礎知識</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record 驗證</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record 查詢介面</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="layouts_and_rendering.html">Rails 中的佈局和渲染</a></dd>
                  <dd><a href="form_helpers.html">Action View 表單 Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller結束view</a></dd>
                  <dd><a href="routing.html">Rails 從外到內路由</a></dd>
                </div>
                <div class="guides-section">
                  <dt>其他元件</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support 核心擴充套件</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer 基礎知識</a></dd>
                  <dd><a href="active_job_basics.html">現役工作基礎</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage 結束view</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable 結束 view</a></dd>
                  <dd><a href="webpacker.html">打包機</a></dd>
                </div>
                <div class="guides-section">
                  <dt>深層發掘</dt>
                  <dd><a href="i18n.html">Rails 國際化 (I18n) API</a></dd>
                  <dd><a href="testing.html">測試 Rails 應用程式</a></dd>
                  <dd><a href="security.html">保護 Rails 應用程式</a></dd>
                  <dd><a href="debugging_rails_applications.html">除錯 Rails 應用程式</a></dd>
                  <dd><a href="configuring.html">配置 Rails 應用程式</a></dd>
                  <dd><a href="command_line.html">Rails 命令列</a></dd>
                  <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">自動載入和重新載入常量</a></dd>
                  <dd><a href="caching_with_rails.html">使用 Rails 快取：結束view</a></dd>
                  <dd><a href="api_app.html">將 Rails 用於僅 API 的應用程式</a></dd>
                </div>
                <div class="guides-section">
                  <dt>延伸導軌</dt>
                  <dd><a href="rails_on_rack.html">機架上的導軌</a></dd>
                  <dd><a href="generators.html">建立和自定義 Rails 生成器和模板</a></dd>
                </div>
                <div class="guides-section">
                  <dt>貢獻</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API 文件指南</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">指南指南</a></dd>
                </div>
                <div class="guides-section">
                  <dt>政策</dt>
                  <dd><a href="maintenance_policy.html">維修政策</a></dd>
                </div>
                <div class="guides-section">
                  <dt>發行說明</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</a></dd>
                  <dd><a href="6_1_release_notes.html">版本 6.1 - 2020 年 12 月</a></dd>
                  <dd><a href="6_0_release_notes.html">6.0 版 - 2019 年 8 月</a></dd>
                  <dd><a href="5_2_release_notes.html">5.2 版 - 2018 年 4 月</a></dd>
                  <dd><a href="5_1_release_notes.html">5.1 版 - 2017 年 4 月</a></dd>
                  <dd><a href="5_0_release_notes.html">5.0 版 - 2016 年 6 月</a></dd>
                  <dd><a href="4_2_release_notes.html">4.2 版 - 2014 年 12 月</a></dd>
                  <dd><a href="4_1_release_notes.html">4.1 版 - 2014 年 4 月</a></dd>
                  <dd><a href="4_0_release_notes.html">4.0 版 - 2013 年 6 月</a></dd>
                  <dd><a href="3_2_release_notes.html">3.2 版 - 2012 年 1 月</a></dd>
                  <dd><a href="3_1_release_notes.html">3.1 版 - 2011 年 8 月</a></dd>
                  <dd><a href="3_0_release_notes.html">3.0 版 - 2010 年 8 月</a></dd>
                  <dd><a href="2_3_release_notes.html">2.3 版 - 2009 年 3 月</a></dd>
                  <dd><a href="2_2_release_notes.html">2.2 版 - 2008 年 11 月</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">貢獻</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">指南索引</option>
              <optgroup label="從這裡開始">
                  <option value="getting_started.html">Rails 入門</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record 基礎知識</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record 驗證</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record 查詢介面</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Rails 中的佈局和渲染</option>
                  <option value="form_helpers.html">Action View 表單 Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller結束view</option>
                  <option value="routing.html">Rails 從外到內路由</option>
              </optgroup>
              <optgroup label="其他元件">
                  <option value="active_support_core_extensions.html">Active Support 核心擴充套件</option>
                  <option value="action_mailer_basics.html">Action Mailer 基礎知識</option>
                  <option value="active_job_basics.html">現役工作基礎</option>
                  <option value="active_storage_overview.html">Active Storage 結束view</option>
                  <option value="action_cable_overview.html">Action Cable 結束 view</option>
                  <option value="webpacker.html">打包機</option>
              </optgroup>
              <optgroup label="深層發掘">
                  <option value="i18n.html">Rails 國際化 (I18n) API</option>
                  <option value="testing.html">測試 Rails 應用程式</option>
                  <option value="security.html">保護 Rails 應用程式</option>
                  <option value="debugging_rails_applications.html">除錯 Rails 應用程式</option>
                  <option value="configuring.html">配置 Rails 應用程式</option>
                  <option value="command_line.html">Rails 命令列</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="autoloading_and_reloading_constants.html">自動載入和重新載入常量</option>
                  <option value="caching_with_rails.html">使用 Rails 快取：結束view</option>
                  <option value="api_app.html">將 Rails 用於僅 API 的應用程式</option>
              </optgroup>
              <optgroup label="延伸導軌">
                  <option value="rails_on_rack.html">機架上的導軌</option>
                  <option value="generators.html">建立和自定義 Rails 生成器和模板</option>
              </optgroup>
              <optgroup label="貢獻">
                  <option value="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</option>
                  <option value="api_documentation_guidelines.html">API 文件指南</option>
                  <option value="ruby_on_rails_guides_guidelines.html">指南指南</option>
              </optgroup>
              <optgroup label="政策">
                  <option value="maintenance_policy.html">維修政策</option>
              </optgroup>
              <optgroup label="發行說明">
                  <option value="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</option>
                  <option value="6_1_release_notes.html">版本 6.1 - 2020 年 12 月</option>
                  <option value="6_0_release_notes.html">6.0 版 - 2019 年 8 月</option>
                  <option value="5_2_release_notes.html">5.2 版 - 2018 年 4 月</option>
                  <option value="5_1_release_notes.html">5.1 版 - 2017 年 4 月</option>
                  <option value="5_0_release_notes.html">5.0 版 - 2016 年 6 月</option>
                  <option value="4_2_release_notes.html">4.2 版 - 2014 年 12 月</option>
                  <option value="4_1_release_notes.html">4.1 版 - 2014 年 4 月</option>
                  <option value="4_0_release_notes.html">4.0 版 - 2013 年 6 月</option>
                  <option value="3_2_release_notes.html">3.2 版 - 2012 年 1 月</option>
                  <option value="3_1_release_notes.html">3.1 版 - 2011 年 8 月</option>
                  <option value="3_0_release_notes.html">3.0 版 - 2010 年 8 月</option>
                  <option value="2_3_release_notes.html">2.3 版 - 2009 年 3 月</option>
                  <option value="2_2_release_notes.html">2.2 版 - 2008 年 11 月</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Active Record 驗證</h2><p>本指南教您如何在物件進入之前驗證物件的狀態
資料庫使用Active Record 的驗證功能。</p><p>閱讀本指南後，您將瞭解：</p>
<ul>
<li>如何使用內建的Active Record 驗證helpers。</li>
<li>如何建立您自己的自定義驗證方法。</li>
<li>如何處理驗證過程生成的錯誤訊息。</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#view">驗證View</a>

<ul>
<li><a href="#">為什麼要使用驗證？</a></li>
<li><a href="#">驗證何時發生？</a></li>
<li><a href="#">跳過驗證</a></li>
<li><a href="#"><code>有效？</code> 和<code>無效？</code></a></li>
<li><a href="#view-"><code>錯誤[]</code></a></li>
</ul>
</li>
<li>
<a href="#helpers">驗證Helpers</a>

<ul>
<li><a href="#"><code>接受</code></a></li>
<li><a href="#validates-related"><code>validates_related</code></a></li>
<li><a href="#"><code>確認</code></a></li>
<li><a href="#"><code>比較</code></a></li>
<li><a href="#"><code>排除</code></a></li>
<li><a href="#"><code>格式</code></a></li>
<li><a href="#"><code>包容性</code></a></li>
<li><a href="#"><code>長度</code></a></li>
<li><a href="#"><code>數值性</code></a></li>
<li><a href="#"><code>存在</code></a></li>
<li><a href="#"><code>缺席</code></a></li>
<li><a href="#"><code>唯一性</code></a></li>
<li><a href="#validates-with"><code>validates_with</code></a></li>
<li><a href="#validates-each"><code>validates_each</code></a></li>
</ul>
</li>
<li>
<a href="#">常用驗證選項</a>

<ul>
<li><a href="#allow-nil"><code>:allow_nil</code></a></li>
<li><a href="#allow-blank"><code>:allow_blank</code></a></li>
<li><a href="#message"><code>:message</code></a></li>
<li><a href="#on"><code>:on</code></a></li>
</ul>
</li>
<li><a href="#">嚴格的驗證</a></li>
<li>
<a href="#">條件驗證</a>

<ul>
<li><a href="#if-unless-symbol">使用帶有 <code>:if</code> 和 <code>:unless</code> 的 symbol</a></li>
<li><a href="#if-unless-proc">使用帶有 <code>:if</code> 和 <code>:unless</code> 的 proc</a></li>
<li><a href="#">分組條件驗證</a></li>
<li><a href="#">結合驗證條件</a></li>
</ul>
</li>
<li>
<a href="#">執行自定義驗證</a>

<ul>
<li><a href="#">自定義驗證器</a></li>
<li><a href="#">自定義方法</a></li>
</ul>
</li>
<li>
<a href="#">處理驗證錯誤</a>

<ul>
<li><a href="#"><code>錯誤</code></a></li>
<li><a href="#"><code>錯誤[]</code></a></li>
<li><a href="#errors-where"><code>errors.where</code> 和錯誤物件</a></li>
<li><a href="#errors-add"><code>errors.add</code></a></li>
<li><a href="#base"><code>錯誤[:base]</code></a></li>
<li><a href="#errors-clear"><code>errors.clear</code></a></li>
<li><a href="#errors-size"><code>errors.size</code></a></li>
</ul>
</li>
<li><a href="#views">在Views 中顯示驗證錯誤</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="view"><a class="anchorlink" href="#view">1 驗證View</a></h3><p>這是一個非常簡單的驗證示例：</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, presence: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, presence: true
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">).</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="kp">nil</span><span class="p">).</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Person.create(name: "John Doe").valid?
Person.create(name: nil).valid?
'>Copy</button>
</div>
<p>如您所見，我們的驗證讓我們知道我們的 <code>Person</code> 無效
沒有 <code>name</code> 屬性。第二個<code>Person</code>不會被持久化到
資料庫。</p><p>在我們深入研究更多細節之前，讓我們先談談驗證如何適應
您的應用程式的大圖。</p><h4 id=""><a class="anchorlink" href="#">1.1 為什麼要使用驗證？</a></h4><p>驗證用於確保僅將有效資料儲存到您的
資料庫。例如，確保您的應用程式
每個使用者都提供一個有效的電子郵件地址和郵寄地址。 Model 級
驗證是確保僅將有效資料儲存到您的
資料庫。它們與資料庫無關，終端使用者無法繞過，並且
方便測試和維護。 rails 提供了內建的Helpers 用於常見的
需要，並允許您建立自己的驗證方法。</p><p>還有其他幾種方法可以在將資料儲存到您的
資料庫，包括本機資料庫約束、客戶端驗證和
Controller 級驗證。以下是優缺點的總結：</p>
<ul>
<li>資料庫約束和/或儲存過程構成驗證機制
依賴於資料庫，並且會使測試和維護更加困難。
但是，如果您的資料庫被其他應用程式使用，這可能是一個不錯的選擇
在資料庫級別使用一些約束的想法。此外，
資料庫級驗證可以安全地處理某些事情（例如唯一性
在頻繁使用的表中），否則很難實現。</li>
<li>客戶端驗證可能很有用，但如果使用則通常不可靠
獨自的。如果它們是使用 JavaScript 實現的，則它們可能會被繞過
使用者瀏覽器中的 JavaScript 已關閉。但是，如果結合
其他技術，客戶端驗證可以是一種方便的方式來提供
使用者在使用您的網站時獲得即時反饋。</li>
<li>Controller 級驗證可能很容易使用，但通常會變成
笨重且難以測試和維護。只要有可能，這是一個很好的
保持Controllers 瘦的想法，因為它會使您的應用程式成為
從長遠來看，很高興與之合作。</li>
</ul>
<p>在某些特定情況下選擇這些。這是 Rails 團隊的意見
Model 級別的驗證在大多數情況下是最合適的。</p><h4 id=""><a class="anchorlink" href="#">1.2 驗證何時發生？</a></h4><p>有兩種Active Record 物件：對應於一行的物件
在您的資料庫中和那些沒有的。當您建立一個新物件時，對於
使用<code>new</code>方法的示例，該物件不屬於資料庫
然而。一旦你對該物件呼叫 <code>save</code> ，它就會被儲存到
適當的資料庫表。 Active Record 使用 <code>new_record?</code> 例項
方法來確定一個物件是否已經在資料庫中。
考慮以下Active Record 類：</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
end
">Copy</button>
</div>
<p>我們可以透過檢視一些 <code>bin/rails 控制檯</code> 輸出來瞭解它是如何工作的：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="nb">p</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Person</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">,</span> <span class="ss">created_at: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="kp">nil</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="nb">p</span><span class="p">.</span><span class="nf">new_record?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="nb">p</span><span class="p">.</span><span class="nf">save</span>
<span class="p">=&gt;</span> <span class="kp">true</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="nb">p</span><span class="p">.</span><span class="nf">new_record?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='p = Person.new(name: "John Doe")
p.new_record?
p.save
p.new_record?
'>Copy</button>
</div>
<p>建立和儲存新記錄將傳送一個 SQL <code>INSERT</code> 操作到
資料庫。更新現有記錄將傳送 SQL <code>UPDATE</code> 操作
反而。驗證通常在這些命令傳送到
資料庫。如果任何驗證失敗，該物件將被標記為無效並
Active Record 不會執行 <code>insert</code> 或 <code>update</code> 操作。這避免了
在資料庫中儲存無效物件。您可以選擇具有特定的
在建立、儲存或更新物件時執行驗證。</p><p>注意： 有多種方法可以更改資料庫中物件的狀態。
有些方法會觸發驗證，但有些方法不會。這意味著它是
如果您不是，則可以將資料庫中的物件以無效狀態儲存
小心。</p><p>以下方法觸發驗證，並將物件儲存到
僅當物件有效時才使用資料庫：</p><p>*<code>建立</code>
*<code>建立！</code>
*<code>儲存</code>
*<code>儲存！</code>
*<code>更新</code>
*<code>更新！</code></p><p>如果記錄無效，bang 版本（例如<code>save!</code>）會引發異常。
非 bang 版本不會：<code>save</code> 和 <code>update</code> 返回 <code>false</code>，並且
<code>create</code> 返回物件。</p><h4 id=""><a class="anchorlink" href="#">1.3 跳過驗證</a></h4><p>以下方法跳過驗證，並將物件儲存到
資料庫而不管其有效性。應謹慎使用它們。</p>
<ul>
<li>
<code>遞減！</code>
*<code>遞減計數器</code>
</li>
<li><code>增量！</code></li>
<li><code>增量計數器</code></li>
<li>
<code>插入</code>
*<code>插入！</code>
</li>
<li><code>insert_all</code></li>
<li>
<code>insert_all!</code>
*<code>切換！</code>
*<code>觸控</code>
</li>
<li><code>touch_all</code></li>
<li><code>update_all</code></li>
<li><code>update_attribute</code></li>
<li><code>update_column</code></li>
<li><code>update_columns</code></li>
<li><code>update_counters</code></li>
<li><code>更新插入</code></li>
<li><code>upsert_all</code></li>
</ul>
<p>請注意，如果通過了 <code>validate</code>，<code>save</code> 也可以跳過驗證：
false` 作為引數。應謹慎使用此技術。</p><p>*<code>儲存（驗證：假）</code></p><h4 id=""><a class="anchorlink" href="#">1.4 <code>有效？</code> 和<code>無效？</code></a></h4><p>在儲存 Active Record 物件之前，rails 會執行您的驗證。
如果這些驗證產生任何錯誤，Rails 不會儲存該物件。</p><p>您也可以自己執行這些驗證。 [<code>valid?</code>][] 觸發你的驗證
如果在物件中沒有發現錯誤，則返回真，否則返回假。
正如你在上面看到的：</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, presence: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, presence: true
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">).</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="kp">nil</span><span class="p">).</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Person.create(name: "John Doe").valid?
Person.create(name: nil).valid?
'>Copy</button>
</div>
<p>Active Record 執行驗證後，可以訪問發現的任何錯誤
透過 [<code>errors</code>][] 例項方法，該方法返回錯誤集合。
根據定義，如果此集合在執行後為空，則物件是有效的
驗證。</p><p>注意用<code>new</code>例項化的物件不會報錯
即使它在技術上無效，因為驗證是自動執行的
僅當物件被儲存時，例如使用 <code>create</code> 或 <code>save</code> 方法。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, presence: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, presence: true
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="nb">p</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Person</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">name: </span><span class="kp">nil</span><span class="kt">&gt;</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="nb">p</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">size</span>
<span class="p">=&gt;</span> <span class="mi">0</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="nb">p</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="nb">p</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">objects</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">full_message</span>
<span class="p">=&gt;</span> <span class="s2">"Name can't be blank"</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="nb">p</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Person</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">name: </span><span class="kp">nil</span><span class="kt">&gt;</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="nb">p</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">objects</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">full_message</span>
<span class="p">=&gt;</span> <span class="s2">"Name can't be blank"</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="nb">p</span><span class="p">.</span><span class="nf">save</span>
<span class="p">=&gt;</span> <span class="kp">false</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="nb">p</span><span class="p">.</span><span class="nf">save!</span>
<span class="go">ActiveRecord::RecordInvalid: Validation failed: Name can't be blank
</span><span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Person</span><span class="p">.</span><span class="nf">create!</span>
<span class="go">ActiveRecord::RecordInvalid: Validation failed: Name can't be blank
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="p = Person.new
p.errors.size
p.valid?
p.errors.objects.first.full_message
p = Person.create
p.errors.objects.first.full_message
p.save
p.save!
Person.create!
">Copy</button>
</div>
<p>[<code>invalid?</code>][] 是 <code>valid?</code> 的倒數。它會觸發您的驗證，
如果在物件中發現任何錯誤，則返回 true，否則返回 false。</p><p>[<code>errors</code>]：<a href="https://api.Rubyonrails.org/classes/activemodel/validations.html#method-i-errors">https://api.Rubyonrails.org/classes/activemodel/validations.html#method-i-errors</a>
[<code>無效？</code>]：<a href="https://api.Rubyonrails.org/classes/activemodel/validations.html#method-i-invalid-3f">https://api.Rubyonrails.org/classes/activemodel/validations.html#method-i-invalid-3f</a>
[<code>valid?</code>]：<a href="https://api.Rubyonrails.org/classes/activerecord/validations.html#method-i-valid-3f">https://api.Rubyonrails.org/classes/activerecord/validations.html#method-i-valid-3f</a></p><h4 id="view-"><a class="anchorlink" href="#view-">1.5 <code>錯誤[]</code></a></h4><p>要驗證物件的特定屬性是否有效，您可以
使用 [<code>errors[:attribute]</code>][Errors#squarebrackets]。它返回所有錯誤訊息的陣列
<code>：屬性</code>。如果指定的屬性沒有錯誤，則為空陣列
被退回。</p><p>此方法僅在 <em>after</em> 驗證已執行時有用，因為它僅
檢查錯誤集合並且本身不會觸發驗證。它是
與上面解釋的 <code>ActiveRecord::Base#invalid?</code> 方法不同，因為
它不驗證整個物件的有效性。它只會檢查以檢視
是否在物件的單個屬性上發現錯誤。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, presence: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, presence: true
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">errors</span><span class="p">[</span><span class="ss">:name</span><span class="p">].</span><span class="nf">any?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">.</span><span class="nf">errors</span><span class="p">[</span><span class="ss">:name</span><span class="p">].</span><span class="nf">any?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Person.new.errors[:name].any?
Person.create.errors[:name].any?
">Copy</button>
</div>
<p>我們將在 <a href="#working-with-validation-errors">使用驗證
錯誤</a> 部分。</p><p>[errors#squarebrackets]：<a href="https://api.Rubyonrails.org/classes/activemodel/errors.html#method-i-5b-5d">https://api.Rubyonrails.org/classes/activemodel/errors.html#method-i-5b-5d</a></p><h3 id="helpers"><a class="anchorlink" href="#helpers">2 驗證Helpers</a></h3><p>Active Record 提供了許多您可以使用的預定義驗證 helper
直接在您的類定義中。這些Helper 提供通用驗證
規則。每次驗證失敗時，都會向物件的
<code>errors</code> 集合，這與屬性相關聯
驗證。</p><p>每個Helper 接受任意數量的屬性名稱，因此使用單個
在一行程式碼中，您可以向多個屬性新增相同型別的驗證。</p><p>它們都接受 <code>:on</code> 和 <code>:message</code> 選項，它們定義何時
應該執行驗證並且應該將什麼訊息新增到 <code>errors</code>
如果失敗，則分別收集。 <code>:on</code> 選項採用以下值之一
<code>:create</code> 或 <code>:update</code>。存在預設錯誤
每個驗證Helper 的訊息。這些訊息用於
未指定 <code>:message</code> 選項。讓我們來看看每一個
可用Helpers。</p><h4 id=""><a class="anchorlink" href="#">2.1 <code>接受</code></a></h4><p>此方法驗證使用者介面上的複選框在
表格已提交。這通常用於使用者需要同意您的
應用程式的服務條款，確認已閱讀某些文字，或任何類似的
概念。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :terms_of_service, acceptance: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :terms_of_service, acceptance: true
end
">Copy</button>
</div>
<p>僅當 <code>terms_of_service</code> 不是 <code>nil</code> 時才執行此檢查。
此Helper 的預設錯誤訊息是<em>“必須接受”</em>。
您還可以透過 <code>message</code> 選項傳入自定義訊息。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :terms_of_service, acceptance: { message: 'must be abided' }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :terms_of_service, acceptance: { message: 'must be abided' }
end
">Copy</button>
</div>
<p>它還可以接收一個 <code>:accept</code> 選項，它決定了允許的值
這將被視為接受。它預設為 <code>['1', true]</code> 並且可以是
容易改變。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :terms_of_service, acceptance: { accept: 'yes' }
  validates :eula, acceptance: { accept: ['TRUE', 'accepted'] }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :terms_of_service, acceptance: { accept: 'yes' }
  validates :eula, acceptance: { accept: ['TRUE', 'accepted'] }
end
">Copy</button>
</div>
<p>此驗證非常特定於 Web 應用程式，這
“接受”不需要記錄在您的資料庫中的任何位置。如果你
如果沒有欄位，Helper 將建立一個虛擬屬性。如果
該欄位確實存在於您的資料庫中，必須將 <code>accept</code> 選項設定為
或包含 <code>true</code> 否則驗證將不會執行。</p><h4 id="validates-related"><a class="anchorlink" href="#validates-related">2.2 <code>validates_related</code></a></h4><p>當您的Model 與其他Model 有association 時，您應該使用此helper
他們也需要得到驗證。當您嘗試儲存物件時，“有效嗎？”
將呼叫每個相關聯的物件。</p><div class="code_container">
<pre><code class="highlight plaintext">class Library &lt; ApplicationRecord
  has_many :books
  validates_associated :books
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Library &lt; ApplicationRecord
  has_many :books
  validates_associated :books
end
">Copy</button>
</div>
<p>此驗證適用於所有 Association 型別。</p><p>注意：不要在 Association 的兩端使用 <code>validates_associated</code>。
他們會在無限迴圈中互相呼叫。</p><p>[<code>validates_related</code>][] 的預設錯誤訊息是 <em>"is invalid"</em>。筆記
每個關聯的物件都將包含自己的“錯誤”集合；錯誤做
不要冒泡到呼叫Model。</p><p>[<code>validates_related</code>]：<a href="https://api.Rubyonrails.org/classes/activerecord/validations/classmethods.html#method-i-validates_associated">https://api.Rubyonrails.org/classes/activerecord/validations/classmethods.html#method-i-validates_associated</a></p><h4 id=""><a class="anchorlink" href="#">2.3 <code>確認</code></a></h4><p>當您有兩個應接收的文字欄位時，您應該使用此 Helper
完全一樣的內容。例如，您可能想要確認電子郵件地址
或密碼。此驗證建立一個虛擬屬性，其名稱是
必須附加“_confirmation”確認的欄位名稱。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :email, confirmation: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :email, confirmation: true
end
">Copy</button>
</div>
<p>在您的View 模板中，您可以使用類似</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">text_field</span> <span class="ss">:person</span><span class="p">,</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">text_field</span> <span class="ss">:person</span><span class="p">,</span> <span class="ss">:email_confirmation</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= text_field :person, :email %&gt;
&lt;%= text_field :person, :email_confirmation %&gt;
">Copy</button>
</div>
<p>僅當 <code>email_confirmation</code> 不是 <code>nil</code> 時才執行此檢查。要求
確認，確保為確認屬性新增存在檢查
（我們稍後將在本指南中介紹“存在”）：</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :email, confirmation: true
  validates :email_confirmation, presence: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :email, confirmation: true
  validates :email_confirmation, presence: true
end
">Copy</button>
</div>
<p>還有一個 <code>:case_sensitive</code> 選項可以用來定義
確認約束將區分大小寫。該選項預設為
真的。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :email, confirmation: { case_sensitive: false }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :email, confirmation: { case_sensitive: false }
end
">Copy</button>
</div>
<p>此Helper 的預設錯誤訊息是<em>“不匹配確認”</em>。</p><h4 id=""><a class="anchorlink" href="#">2.4 <code>比較</code></a></h4><p>此檢查將驗證任何兩個可比較值之間的比較。
驗證器需要提供一個比較選項。每個選項都接受一個
值、過程或Symbol。任何包含可比較的類都可以進行比較。</p><div class="code_container">
<pre><code class="highlight plaintext">class Promotion &lt; ApplicationRecord
  validates :start_date, comparison: { greater_than: :end_date }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Promotion &lt; ApplicationRecord
  validates :start_date, comparison: { greater_than: :end_date }
end
">Copy</button>
</div>
<p>這些選項都受支援：</p>
<ul>
<li>
<code>:greater_than</code> - 指定值必須大於提供的值
價值。此選項的預設錯誤訊息是 <em>"必須大於
％{數數}”</em>。</li>
<li>
<code>:greater_than_or_equal_to</code> - 指定值必須大於或
等於提供的值。此選項的預設錯誤訊息是
<em>"必須大於或等於 %{count}"</em>。</li>
<li>
<code>:equal_to</code> - 指定值必須等於提供的值。這
此選項的預設錯誤訊息是 <em>"必須等於 %{count}"</em>。</li>
<li>
<code>:less_than</code> - 指定值必須小於提供的值。這
此選項的預設錯誤訊息是 <em>"必須小於 %{count}"</em>。</li>
<li>
<code>:less_than_or_equal_to</code> - 指定值必須小於或等於
提供的值。此選項的預設錯誤訊息是 <em>"must be
小於或等於 %{count}"</em>。</li>
<li>
<code>:other_than</code> - 指定值必須不是提供的值。
此選項的預設錯誤訊息是 <em>"必須不是 %{count}"</em>。</li>
</ul>
<h4 id=""><a class="anchorlink" href="#">2.5 <code>排除</code></a></h4><p>這個Helper 驗證屬性的值不包含在給定的
放。事實上，這個集合可以是任何可列舉的物件。</p><div class="code_container">
<pre><code class="highlight plaintext">class Account &lt; ApplicationRecord
  validates :subdomain, exclusion: { in: %w(www us ca jp),
    message: "%{value} is reserved." }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Account &lt; ApplicationRecord
  validates :subdomain, exclusion: { in: %w(www us ca jp),
    message: "%{value} is reserved." }
end
'>Copy</button>
</div>
<p><code>exclusion</code> Helper 有一個選項 <code>:in</code>，它接收一組值
將不接受已驗證的屬性。 <code>:in</code> 選項有一個
如果您願意，可以將別名稱為 <code>:within</code>，您可以將其用於相同的目的。
這個例子使用了 <code>:message</code> 選項來展示你可以如何包含
屬性的值。有關訊息引數的完整選項，請參閱
<a href="#message">訊息文件</a>。</p><p>預設錯誤訊息是 <em>"is reserved"</em>。</p><h4 id=""><a class="anchorlink" href="#">2.6 <code>格式</code></a></h4><p>this Helper 透過測試屬性值是否匹配
給定的正則表示式，使用 <code>:with</code> 選項指定。</p><div class="code_container">
<pre><code class="highlight plaintext">class Product &lt; ApplicationRecord
  validates :legacy_code, format: { with: /\A[a-zA-Z]+\z/,
    message: "only allows letters" }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Product &lt; ApplicationRecord
  validates :legacy_code, format: { with: /\A[a-zA-Z]+\z/,
    message: "only allows letters" }
end
'>Copy</button>
</div>
<p>或者，您可以使用<code>:without</code> 選項要求指定的屬性<em>不</em>匹配正則表示式。</p><p>預設錯誤訊息是<em>“無效”</em>。</p><h4 id=""><a class="anchorlink" href="#">2.7 <code>包容性</code></a></h4><p>this Helper 驗證屬性的值是否包含在給定的集合中。
事實上，這個集合可以是任何可列舉的物件。</p><div class="code_container">
<pre><code class="highlight plaintext">class Coffee &lt; ApplicationRecord
  validates :size, inclusion: { in: %w(small medium large),
    message: "%{value} is not a valid size" }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Coffee &lt; ApplicationRecord
  validates :size, inclusion: { in: %w(small medium large),
    message: "%{value} is not a valid size" }
end
'>Copy</button>
</div>
<p><code>inclusion</code> Helper 有一個選項 <code>:in</code>，它接收一組值
將被接受。 <code>:in</code> 選項有一個名為 <code>:within</code> 的別名，你可以
如果您願意，也可以用於相同的目的。前面的例子使用
<code>:message</code> 選項顯示如何包含屬性的值。對於完整
選項請參閱<a href="#message">訊息文件</a>。</p><p>此Helper 的預設錯誤訊息是 <em>"未包含在列表中"</em>。</p><h4 id=""><a class="anchorlink" href="#">2.8 <code>長度</code></a></h4><p>這個Helper 驗證屬性值的長度。它提供了一個
多種選項，因此您可以以不同方式指定長度約束：</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, length: { minimum: 2 }
  validates :bio, length: { maximum: 500 }
  validates :password, length: { in: 6..20 }
  validates :registration_number, length: { is: 6 }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, length: { minimum: 2 }
  validates :bio, length: { maximum: 500 }
  validates :password, length: { in: 6..20 }
  validates :registration_number, length: { is: 6 }
end
">Copy</button>
</div>
<p>可能的長度約束選項是：</p>
<ul>
<li>
<code>:minimum</code> - 屬性不能小於指定的長度。</li>
<li>
<code>:maximum</code> - 屬性不能超過指定的長度。</li>
<li>
<code>:in</code>（或 <code>:within</code>） - 屬性長度必須包含在給定的
間隔。此選項的值必須是一個範圍。</li>
<li>
<code>:is</code> - 屬性長度必須等於給定值。</li>
</ul>
<p>預設錯誤訊息取決於長度驗證的型別
執行。您可以使用 <code>:wrong_length</code> 自定義這些訊息，
<code>:too_long</code> 和 <code>:too_short</code> 選項和 <code>%{count}</code> 作為佔位符
與正在使用的長度約束相對應的數字。您仍然可以使用
<code>:message</code> 選項指定錯誤訊息。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :bio, length: { maximum: 1000,
    too_long: "%{count} characters is the maximum allowed" }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Person &lt; ApplicationRecord
  validates :bio, length: { maximum: 1000,
    too_long: "%{count} characters is the maximum allowed" }
end
'>Copy</button>
</div>
<p>請注意，預設錯誤訊息是複數形式（例如，“太短（最少
是 %{count} 個字元）”）。因此，當 <code>:minimum</code> 為 1 時，您應該
提供自定義訊息或使用 <code>presence: true</code> 代替。什麼時候
<code>:in</code> 或 <code>:within</code> 的下限為 1，您應該提供一個
自定義訊息或在 <code>length</code> 之前呼叫 <code>presence</code>。</p><h4 id=""><a class="anchorlink" href="#">2.9 <code>數值性</code></a></h4><p>這個Helper 驗證您的屬性只有數字值。經過
預設情況下，它將匹配一個可選符號，後跟一個整數或浮點數
點數。</p><p>要指定只允許整數，
將 <code>:only_integer</code> 設定為 true。然後它將使用</p><div class="code_container">
<pre><code class="highlight plaintext">/\A[+-]?\d+\z/
</code></pre>
<button class="clipboard-button" data-clipboard-text="/\A[+-]?\d+\z/
">Copy</button>
</div>
<p>正則表示式來驗證屬性的值。否則，它會嘗試
使用“Float”將值轉換為數字。 <code>Float</code>s 使用列的精度值或 15 轉換為 <code>BigDecimal</code>。</p><div class="code_container">
<pre><code class="highlight plaintext">class Player &lt; ApplicationRecord
  validates :points, numericality: true
  validates :games_played, numericality: { only_integer: true }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Player &lt; ApplicationRecord
  validates :points, numericality: true
  validates :games_played, numericality: { only_integer: true }
end
">Copy</button>
</div>
<p><code>:only_integer</code> 的預設錯誤資訊是 <em>"must be an integer"</em>。</p><p>除了<code>:only_integer</code>，這個Helper 還接受以下選項來新增
可接受值的約束：</p>
<ul>
<li>
<code>:greater_than</code> - 指定值必須大於提供的值
價值。此選項的預設錯誤訊息是 <em>"必須大於
％{數數}”</em>。</li>
<li>
<code>:greater_than_or_equal_to</code> - 指定值必須大於或
等於提供的值。此選項的預設錯誤訊息是
<em>"必須大於或等於 %{count}"</em>。</li>
<li>
<code>:equal_to</code> - 指定值必須等於提供的值。這
此選項的預設錯誤訊息是 <em>"必須等於 %{count}"</em>。</li>
<li>
<code>:less_than</code> - 指定值必須小於提供的值。這
此選項的預設錯誤訊息是 <em>"必須小於 %{count}"</em>。</li>
<li>
<code>:less_than_or_equal_to</code> - 指定值必須小於或等於
提供的值。此選項的預設錯誤訊息是 <em>"must be
小於或等於 %{count}"</em>。</li>
<li>
<code>:other_than</code> - 指定值必須不是提供的值。
此選項的預設錯誤訊息是 <em>"必須不是 %{count}"</em>。</li>
<li>
<code>:in</code> - 指定值必須在提供的範圍內。
此選項的預設錯誤訊息是 <em>"must be in %{count}"</em>。</li>
<li>
<code>:odd</code> - 如果設定為 true，則指定值必須是奇數。這
此選項的預設錯誤訊息是 <em>“必須是奇數”</em>。</li>
<li>
<code>:even</code> - 如果設定為 true，則指定值必須是偶數。這
此選項的預設錯誤訊息是 <em>“必須是偶數”</em>。</li>
</ul>
<p>注意：預設情況下，<code>numericality</code> 不允許使用 <code>nil</code> 值。您可以使用 <code>allow_nil: true</code> 選項來允許它。</p><p>未指定選項時的預設錯誤訊息是 <em>"is not a number"</em>。</p><h4 id=""><a class="anchorlink" href="#">2.10 <code>存在</code></a></h4><p>this Helper 驗證指定的屬性不為空。它使用
<code>blank?</code> 方法來檢查值是 <code>nil</code> 還是一個空白字串，即
是一個空字串或由空格組成的字串。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, :login, :email, presence: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, :login, :email, presence: true
end
">Copy</button>
</div>
<p>如果你想確保Association 存在，你需要測試
是否存在關聯物件本身，而不是使用的外來鍵
對映Association。這樣，不僅檢查外來鍵
不為空，而且引用的物件存在。</p><div class="code_container">
<pre><code class="highlight plaintext">class Supplier &lt; ApplicationRecord
  has_one :account
  validates :account, presence: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_one :account
  validates :account, presence: true
end
">Copy</button>
</div>
<p>為了驗證需要存在的關聯記錄，您必須
為Association 指定<code>:inverse_of</code> 選項：</p><p>注意：如果你想確保Association 既存在又有效，你還需要使用<code>validates_associated</code>。</p><div class="code_container">
<pre><code class="highlight plaintext">class Order &lt; ApplicationRecord
  has_many :line_items, inverse_of: :order
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Order &lt; ApplicationRecord
  has_many :line_items, inverse_of: :order
end
">Copy</button>
</div>
<p>如果您驗證透過<code>has_one</code> 或
<code>has_many</code> 關係，它會檢查物件既不是 <code>blank?</code> 也不是
<code>marked_for_destruction？</code>。</p><p>由於 <code>false.blank?</code> 是真的，如果你想驗證一個布林值的存在
您應該使用以下驗證之一：</p><div class="code_container">
<pre><code class="highlight plaintext">validates :boolean_field_name, inclusion: [true, false]
validates :boolean_field_name, exclusion: [nil]
</code></pre>
<button class="clipboard-button" data-clipboard-text="validates :boolean_field_name, inclusion: [true, false]
validates :boolean_field_name, exclusion: [nil]
">Copy</button>
</div>
<p>透過使用這些驗證之一，您將確保該值不會是“nil”
在大多數情況下，這將導致“NULL”值。</p><h4 id=""><a class="anchorlink" href="#">2.11 <code>缺席</code></a></h4><p>this Helper 驗證指定的屬性不存在。它使用
<code>present?</code> 方法來檢查值是否不是 nil 或空白字串，即
是一個空字串或由空格組成的字串。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, :login, :email, absence: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, :login, :email, absence: true
end
">Copy</button>
</div>
<p>如果你想確保 Association 不存在，你需要測試
關聯物件本身是否不存在，而不是使用的外來鍵
對映Association。</p><div class="code_container">
<pre><code class="highlight plaintext">class LineItem &lt; ApplicationRecord
  belongs_to :order
  validates :order, absence: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class LineItem &lt; ApplicationRecord
  belongs_to :order
  validates :order, absence: true
end
">Copy</button>
</div>
<p>為了驗證需要缺席的相關記錄，您必須
為Association 指定<code>:inverse_of</code> 選項：</p><div class="code_container">
<pre><code class="highlight plaintext">class Order &lt; ApplicationRecord
  has_many :line_items, inverse_of: :order
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Order &lt; ApplicationRecord
  has_many :line_items, inverse_of: :order
end
">Copy</button>
</div>
<p>如果您驗證不存在透過 <code>has_one</code> 關聯的物件或
<code>has_many</code> 關係，它會檢查物件既不存在也不存在
<code>marked_for_destruction？</code>。</p><p>由於 <code>false.present?</code> 是假的，如果你想驗證一個布林值的缺失
您應該使用<code>validates :field_name, exclude: { in: [true, false] }</code>。</p><p>預設錯誤訊息是<em>“必須為空”</em>。</p><h4 id=""><a class="anchorlink" href="#">2.12 <code>唯一性</code></a></h4><p>這個Helper 驗證屬性的值在
物件被儲存。它不會在資料庫中建立唯一性約束，
所以可能會發生兩個不同的資料庫連線建立兩個記錄
對於您打算唯一的列具有相同的值。為了避免這種情況，
您必須在資料庫中的該列上建立唯一索引。</p><div class="code_container">
<pre><code class="highlight plaintext">class Account &lt; ApplicationRecord
  validates :email, uniqueness: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Account &lt; ApplicationRecord
  validates :email, uniqueness: true
end
">Copy</button>
</div>
<p>驗證透過對Model 的表執行 sql 查詢來進行，
在該屬性中搜索具有相同值的現有記錄。</p><p>有一個 <code>:scope</code> 選項可以用來指定一個或多個屬性
用於限制唯一性檢查：</p><div class="code_container">
<pre><code class="highlight plaintext">class Holiday &lt; ApplicationRecord
  validates :name, uniqueness: { scope: :year,
    message: "should happen once per year" }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Holiday &lt; ApplicationRecord
  validates :name, uniqueness: { scope: :year,
    message: "should happen once per year" }
end
'>Copy</button>
</div>
<p>如果您希望使用 <code>:scope</code> 選項建立資料庫約束以防止可能違反唯一性驗證，則必須在資料庫的兩列上建立唯一索引。有關多列索引的更多詳細資訊，請參閱 <a href="https://dev.mysql.com/doc/refman/en/multiple-column-indexes.html">MySQL 手冊</a> 或 <a href="https://www%20.postgresql.org/docs/current/static/ddl-constraints.html">PostgreSQL 手冊</a> 獲取引用一組列的唯一約束的示例。</p><p>還有一個 <code>:case_sensitive</code> 選項可以用來定義
唯一性約束將區分大小寫。該選項預設為
真的。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, uniqueness: { case_sensitive: false }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, uniqueness: { case_sensitive: false }
end
">Copy</button>
</div>
<p>警告。請注意，某些資料庫配置為不區分大小寫
無論如何搜尋。</p><p>預設的錯誤資訊是<em>“已經被佔用”</em>。</p><h4 id="validates-with"><a class="anchorlink" href="#validates-with">2.13 <code>validates_with</code></a></h4><p>這個Helper 將記錄傳遞給一個單獨的類進行驗證。</p><div class="code_container">
<pre><code class="highlight plaintext">class goodnessvalidator &lt; activeModel::validator
  def validate(record)
    if record.first_name == "Evil"
      record.errors.add :base, "This person is evil"
    end
  end
end

class Person &lt; ApplicationRecord
  validates_with GoodnessValidator
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class goodnessvalidator &lt; activeModel::validator
  def validate(record)
    if record.first_name == "Evil"
      record.errors.add :base, "This person is evil"
    end
  end
end

class Person &lt; ApplicationRecord
  validates_with GoodnessValidator
end
'>Copy</button>
</div>
<p>注意：新增到 <code>record.errors[:base]</code> 的錯誤與記錄的狀態有關
作為一個整體，而不是特定的屬性。</p><p>[<code>validates_with</code>][] Helper 接受一個類，或者一個類列表來使用
驗證。 <code>validates_with</code> 沒有預設錯誤訊息。你必須
手動將錯誤新增到驗證器類中記錄的錯誤集合中。</p><p>要實現驗證方法，您必須定義一個 <code>record</code> 引數，
這是要驗證的記錄。</p><p>像所有其他驗證一樣，<code>validates_with</code> 接受 <code>:if</code>、<code>:unless</code> 和
<code>:on</code> 選項。如果您傳遞任何其他選項，它會將這些選項傳送到
驗證器類作為<code>options</code>：</p><div class="code_container">
<pre><code class="highlight plaintext">class goodnessvalidator &lt; activeModel::validator
  def validate(record)
    if options[:fields].any? { |field| record.send(field) == "Evil" }
      record.errors.add :base, "This person is evil"
    end
  end
end

class Person &lt; ApplicationRecord
  validates_with GoodnessValidator, fields: [:first_name, :last_name]
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class goodnessvalidator &lt; activeModel::validator
  def validate(record)
    if options[:fields].any? { |field| record.send(field) == "Evil" }
      record.errors.add :base, "This person is evil"
    end
  end
end

class Person &lt; ApplicationRecord
  validates_with GoodnessValidator, fields: [:first_name, :last_name]
end
'>Copy</button>
</div>
<p>請注意，驗證器將在整個應用程式中<em>僅初始化一次</em>
生命週期，而不是在每次驗證執行時，所以要小心使用例項
裡面的變數。</p><p>如果您的驗證器足夠複雜以至於您需要例項變數，您可以
輕鬆地使用普通的舊 Ruby 物件代替：</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validate do |person|
    GoodnessValidator.new(person).validate
  end
end

class GoodnessValidator
  def initialize(person)
    @person = person
  end

  def validate
    if some_complex_condition_involving_ivars_and_private_methods?
      @person.errors.add :base, "This person is evil"
    end
  end

  # ...
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Person &lt; ApplicationRecord
  validate do |person|
    GoodnessValidator.new(person).validate
  end
end

class GoodnessValidator
  def initialize(person)
    @person = person
  end

  def validate
    if some_complex_condition_involving_ivars_and_private_methods?
      @person.errors.add :base, "This person is evil"
    end
  end

  # ...
end
'>Copy</button>
</div>
<p>[<code>validates_with</code>]：<a href="https://api.Rubyonrails.org/classes/activemodel/validations/classmethods.html#method-i-validates_with">https://api.Rubyonrails.org/classes/activemodel/validations/classmethods.html#method-i-validates_with</a></p><h4 id="validates-each"><a class="anchorlink" href="#validates-each">2.14 <code>validates_each</code></a></h4><p>this Helper 針對塊驗證屬性。它沒有預定義
驗證功能。您應該使用塊建立一個，並且每個屬性
傳遞給 [<code>validates_each</code>][] 將對其進行測試。在下面的例子中，
我們不希望名字和姓氏以小寫開頭。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates_each :name, :surname do |record, attr, value|
    record.errors.add(attr, 'must start with upper case') if value =~ /\A[[:lower:]]/
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates_each :name, :surname do |record, attr, value|
    record.errors.add(attr, 'must start with upper case') if value =~ /\A[[:lower:]]/
  end
end
">Copy</button>
</div>
<p>該塊接收記錄、屬性名稱和屬性值。
你可以做任何你喜歡檢查塊內有效資料的事情。如果你的
驗證失敗，您應該向Model 新增錯誤，因此
使其無效。</p><p>[<code>validates_each</code>]：<a href="https://api.Rubyonrails.org/classes/activemodel/validations/classmethods.html#method-i-validates_each">https://api.Rubyonrails.org/classes/activemodel/validations/classmethods.html#method-i-validates_each</a></p><h3 id=""><a class="anchorlink" href="#">3 常用驗證選項</a></h3><p>這些是常見的驗證選項：</p><h4 id="allow-nil"><a class="anchorlink" href="#allow-nil">3.1 <code>:allow_nil</code></a></h4><p><code>:allow_nil</code> 選項在被驗證的值是
<code>零</code>。</p><div class="code_container">
<pre><code class="highlight plaintext">class Coffee &lt; ApplicationRecord
  validates :size, inclusion: { in: %w(small medium large),
    message: "%{value} is not a valid size" }, allow_nil: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Coffee &lt; ApplicationRecord
  validates :size, inclusion: { in: %w(small medium large),
    message: "%{value} is not a valid size" }, allow_nil: true
end
'>Copy</button>
</div>
<p>有關訊息引數的完整選項，請參閱
<a href="#message">訊息文件</a>。</p><h4 id="allow-blank"><a class="anchorlink" href="#allow-blank">3.2 <code>:allow_blank</code></a></h4><p><code>:allow_blank</code> 選項類似於 <code>:allow_nil</code> 選項。這個選項
如果屬性的值為‘blank?’，比如‘nil’或an
例如空字串。</p><div class="code_container">
<pre><code class="highlight plaintext">class Topic &lt; ApplicationRecord
  validates :title, length: { is: 5 }, allow_blank: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Topic &lt; ApplicationRecord
  validates :title, length: { is: 5 }, allow_blank: true
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Topic</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s2">""</span><span class="p">).</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Topic</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="kp">nil</span><span class="p">).</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Topic.create(title: "").valid?
Topic.create(title: nil).valid?
'>Copy</button>
</div>
<h4 id="message"><a class="anchorlink" href="#message">3.3 <code>:message</code></a></h4><p>正如你已經看到的，<code>:message</code> 選項讓你指定訊息
當驗證失敗時，將被新增到 <code>errors</code> 集合中。當這
未使用選項，Active Record 將使用各自的預設錯誤訊息
對於每個驗證Helper。 <code>:message</code> 選項接受一個 <code>string</code> 或 <code>proc</code>。</p><p><code>String</code> <code>:message</code> 值可以選擇包含任何/所有 <code>%{value}</code>，
<code>%{attribute}</code> 和 <code>%{Model}</code> 將在以下情況下被動態替換
驗證失敗。此替換是使用 I18n gem 完成的，並且
佔位符必須完全匹配，不允許有空格。</p><p><code>Proc</code> <code>:message</code> 值有兩個引數：被驗證的物件，以及
一個帶有 <code>:Model</code>、<code>:attribute</code> 和 <code>:value</code> 鍵值對的雜湊。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  # Hard-coded message
  validates :name, presence: { message: "must be given please" }

  # Message with dynamic attribute value. %{value} will be replaced
  # with the actual value of the attribute. %{attribute} and %{Model}
  # are also available.
  validates :age, numericality: { message: "%{value} seems wrong" }

  # Proc
  validates :username,
    uniqueness: {
      # object = person object being validated
      # data = { Model: "person", attribute: "username", value: &lt;username&gt; }
      message: -&gt;(object, data) do
        "Hey #{object.name}, #{data[:value]} is already taken."
      end
    }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Person &lt; ApplicationRecord
  # Hard-coded message
  validates :name, presence: { message: "must be given please" }

  # Message with dynamic attribute value. %{value} will be replaced
  # with the actual value of the attribute. %{attribute} and %{Model}
  # are also available.
  validates :age, numericality: { message: "%{value} seems wrong" }

  # Proc
  validates :username,
    uniqueness: {
      # object = person object being validated
      # data = { Model: "person", attribute: "username", value: &lt;username&gt; }
      message: -&gt;(object, data) do
        "Hey #{object.name}, #{data[:value]} is already taken."
      end
    }
end
'>Copy</button>
</div>
<h4 id="on"><a class="anchorlink" href="#on">3.4 <code>:on</code></a></h4><p><code>:on</code> 選項讓你指定驗證應該發生的時間。這
所有內建驗證 Helper 的預設行為是在儲存時執行
（無論是在建立新記錄時還是在更新記錄時）。如果你
想要改變它，你可以使用 <code>on::create</code> 來執行驗證，只有當
新記錄被建立或<code>on::update</code> 只在有記錄時執行驗證
已更新。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  # it will be possible to update email with a duplicated value
  validates :email, uniqueness: true, on: :create

  # it will be possible to create the record with a non-numerical age
  validates :age, numericality: true, on: :update

  # the default (validates on both create and update)
  validates :name, presence: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  # it will be possible to update email with a duplicated value
  validates :email, uniqueness: true, on: :create

  # it will be possible to create the record with a non-numerical age
  validates :age, numericality: true, on: :update

  # the default (validates on both create and update)
  validates :name, presence: true
end
">Copy</button>
</div>
<p>您還可以使用 <code>on:</code> 來定義自定義上下文。自定義上下文需要
透過將上下文的名稱傳遞給 <code>valid?</code> 來顯式觸發，
<code>無效？</code>，或<code>儲存</code>。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :email, uniqueness: true, on: :account_setup
  validates :age, numericality: true, on: :account_setup
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :email, uniqueness: true, on: :account_setup
  validates :age, numericality: true, on: :account_setup
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">age: </span><span class="s1">'thirty-three'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">valid?</span><span class="p">(</span><span class="ss">:account_setup</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">messages</span>
<span class="p">=&gt;</span> <span class="p">{</span><span class="ss">:email</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"has already been taken"</span><span class="p">],</span> <span class="ss">:age</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"is not a number"</span><span class="p">]}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.new(age: 'thirty-three')
person.valid?
person.valid?(:account_setup)
person.errors.messages
">Copy</button>
</div>
<p><code>person.valid?(:account_setup)</code> 執行兩個驗證而不儲存
Model。 <code>person.save(context::account_setup)</code> 在
儲存前的“account_setup”上下文。</p><p>當由顯式上下文觸發時，會針對該上下文執行驗證，
以及任何<em>沒有</em>上下文的驗證。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :email, uniqueness: true, on: :account_setup
  validates :age, numericality: true, on: :account_setup
  validates :name, presence: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :email, uniqueness: true, on: :account_setup
  validates :age, numericality: true, on: :account_setup
  validates :name, presence: true
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">valid?</span><span class="p">(</span><span class="ss">:account_setup</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">messages</span>
<span class="p">=&gt;</span> <span class="p">{</span><span class="ss">:email</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"has already been taken"</span><span class="p">],</span> <span class="ss">:age</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"is not a number"</span><span class="p">],</span> <span class="ss">:name</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"can't be blank"</span><span class="p">]}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.new
person.valid?(:account_setup)
person.errors.messages
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">4 嚴格的驗證</a></h3><p>您還可以將驗證指定為嚴格並提高
<code>activeModel::strictvalidationfailed</code> 當物件無效時。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, presence: { strict: true }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, presence: { strict: true }
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">valid?</span>
<span class="go">activeModel::strictvalidationfailed: name can't be blank
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Person.new.valid?
">Copy</button>
</div>
<p>還可以將自定義異常傳遞給 <code>:strict</code> 選項。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :Token, presence: true, uniqueness: true, strict: Tokengenerationexception
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :Token, presence: true, uniqueness: true, strict: Tokengenerationexception
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">valid?</span>
<span class="go">Tokengenerationexception: Token can't be blank
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Person.new.valid?
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">5 條件驗證</a></h3><p>有時只有在給定謂詞時才驗證物件才有意義
很滿意。你可以透過使用 <code>:if</code> 和 <code>:unless</code> 選項來做到這一點，它們
可以採用Symbol、<code>proc</code> 或<code>array</code>。你可以使用<code>:if</code>
當您想要指定驗證 ** 應該 ** 發生的時間時的選項。如果你
想要指定驗證<strong>不應該</strong>發生的時間，那麼您可以使用
<code>:除非</code> 選項。</p><h4 id="if-unless-symbol"><a class="anchorlink" href="#if-unless-symbol">5.1 使用帶有 <code>:if</code> 和 <code>:unless</code> 的 symbol</a></h4><p>您可以將 <code>:if</code> 和 <code>:unless</code> 選項與對應的 Symbol
到將在驗證發生之前被呼叫的方法的名稱。
這是最常用的選項。</p><div class="code_container">
<pre><code class="highlight plaintext">class Order &lt; ApplicationRecord
  validates :card_number, presence: true, if: :paid_with_card?

  def paid_with_card?
    payment_type == "card"
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Order &lt; ApplicationRecord
  validates :card_number, presence: true, if: :paid_with_card?

  def paid_with_card?
    payment_type == "card"
  end
end
'>Copy</button>
</div>
<h4 id="if-unless-proc"><a class="anchorlink" href="#if-unless-proc">5.2 使用帶有 <code>:if</code> 和 <code>:unless</code> 的 proc</a></h4><p>可以將 <code>:if</code> 和 <code>:unless</code> 與一個 <code>Proc</code> 物件相關聯
這將被呼叫。使用 <code>Proc</code> 物件可以讓你編寫一個
內聯條件而不是單獨的方法。此選項最適合
單襯。</p><div class="code_container">
<pre><code class="highlight plaintext">class Account &lt; ApplicationRecord
  validates :password, confirmation: true,
    unless: Proc.new { |a| a.password.blank? }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Account &lt; ApplicationRecord
  validates :password, confirmation: true,
    unless: Proc.new { |a| a.password.blank? }
end
">Copy</button>
</div>
<p>由於 <code>Lambdas</code> 是一種 <code>Proc</code>，它們也可以用於編寫內聯
條件更短。</p><div class="code_container">
<pre><code class="highlight plaintext">validates :password, confirmation: true, unless: -&gt; { password.blank? }
</code></pre>
<button class="clipboard-button" data-clipboard-text="validates :password, confirmation: true, unless: -&gt; { password.blank? }
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">5.3 分組條件驗證</a></h4><p>有時讓多個驗證使用一個條件很有用。它可以
使用 [<code>with_options</code>][] 可以輕鬆實現。</p><div class="code_container">
<pre><code class="highlight plaintext">class User &lt; ApplicationRecord
  with_options if: :is_admin? do |admin|
    admin.validates :password, length: { minimum: 10 }
    admin.validates :email, presence: true
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ApplicationRecord
  with_options if: :is_admin? do |admin|
    admin.validates :password, length: { minimum: 10 }
    admin.validates :email, presence: true
  end
end
">Copy</button>
</div>
<p><code>with_options</code> 塊內的所有驗證都將自動具有
透過條件<code>if: :is_admin?</code></p><p>[<code>with_options</code>]：<a href="https://api.Rubyonrails.org/classes/object.html#method-i-with_options">https://api.Rubyonrails.org/classes/object.html#method-i-with_options</a></p><h4 id=""><a class="anchorlink" href="#">5.4 結合驗證條件</a></h4><p>另一方面，當多個條件定義是否驗證
應該發生，可以使用<code>Array</code>。此外，您可以同時應用 <code>:if</code> 和
<code>:unless</code> 到相同的驗證。</p><div class="code_container">
<pre><code class="highlight plaintext">class Computer &lt; ApplicationRecord
  validates :mouse, presence: true,
                    if: [Proc.new { |c| c.market.retail? }, :desktop?],
                    unless: Proc.new { |c| c.trackpad.present? }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Computer &lt; ApplicationRecord
  validates :mouse, presence: true,
                    if: [Proc.new { |c| c.market.retail? }, :desktop?],
                    unless: Proc.new { |c| c.trackpad.present? }
end
">Copy</button>
</div>
<p>驗證僅在所有 <code>:if</code> 條件滿足且沒有任何條件時執行
<code>:unless</code> 條件被評估為 <code>true</code>。</p><h3 id=""><a class="anchorlink" href="#">6 執行自定義驗證</a></h3><p>當內建驗證 Helper 不足以滿足您的需求時，您可以
根據需要編寫自己的驗證器或驗證方法。</p><h4 id=""><a class="anchorlink" href="#">6.1 自定義驗證器</a></h4><p>自定義驗證器是從 [<code>activeModel::validator</code>][] 繼承的類。這些
類必須實現<code>validate</code> 方法，該方法將記錄作為引數
並對其進行驗證。自定義驗證器使用
<code>validates_with</code> 方法。</p><div class="code_container">
<pre><code class="highlight plaintext">class myvalidator &lt; activeModel::validator
  def validate(record)
    unless record.name.start_with? 'X'
      record.errors.add :name, "Need a name starting with X please!"
    end
  end
end

class Person
  include activeModel::validations
  validates_with MyValidator
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class myvalidator &lt; activeModel::validator
  def validate(record)
    unless record.name.start_with? 'X'
      record.errors.add :name, &quot;Need a name starting with X please!&quot;
    end
  end
end

class Person
  include activeModel::validations
  validates_with MyValidator
end
">Copy</button>
</div>
<p>新增自定義驗證器以驗證單個屬性的最簡單方法
使用方便的 [<code>activeModel::eachvalidator</code>][]。在這種情況下，自定義
驗證器類必須實現一個 <code>validate_each</code> 方法，該方法需要三個
引數：記錄、屬性和值。這些對應於例項，
要驗證的屬性，以及傳入的屬性值
例項。</p><div class="code_container">
<pre><code class="highlight plaintext">class emailvalidator &lt; activeModel::eachvalidator
  def validate_each(record, attribute, value)
    unless value =~ /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i
      record.errors.add attribute, (options[:message] || "is not an email")
    end
  end
end

class Person &lt; ApplicationRecord
  validates :email, presence: true, email: true
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class emailvalidator &lt; activeModel::eachvalidator
  def validate_each(record, attribute, value)
    unless value =~ /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i
      record.errors.add attribute, (options[:message] || "is not an email")
    end
  end
end

class Person &lt; ApplicationRecord
  validates :email, presence: true, email: true
end
'>Copy</button>
</div>
<p>如示例所示，您還可以將標準驗證與您的
自己的自定義驗證器。</p><p>[<code>activemodel::eachvalidator</code>]：<a href="https://api.Rubyonrails.org/classes/activemodel/eachvalidator.html">https://api.Rubyonrails.org/classes/activemodel/eachvalidator.html</a>
[<code>activemodel::validator</code>]：<a href="https://api.Rubyonrails.org/classes/activemodel/validator.html">https://api.Rubyonrails.org/classes/activemodel/validator.html</a></p><h4 id=""><a class="anchorlink" href="#">6.2 自定義方法</a></h4><p>您還可以建立驗證Model 狀態的方法並新增
<code>errors</code> 集合無效時的錯誤。那麼你必須
使用 [<code>validate</code>][] 註冊這些方法
類方法，傳入Symbols 作為驗證方法的名稱。</p><p>您可以為每個類方法和各自的方法傳遞多個Symbol
驗證將按照與註冊相同的順序執行。</p><p><code>valid?</code> 方法將驗證錯誤集合是否為空，
所以你的自定義驗證方法應該在你
希望驗證失敗：</p><div class="code_container">
<pre><code class="highlight plaintext">class Invoice &lt; ApplicationRecord
  validate :expiration_date_cannot_be_in_the_past,
    :discount_cannot_be_greater_than_total_value

  def expiration_date_cannot_be_in_the_past
    if expiration_date.present? &amp;&amp; expiration_date &lt; Date.today
      errors.add(:expiration_date, "can't be in the past")
    end
  end

  def discount_cannot_be_greater_than_total_value
    if discount &gt; total_value
      errors.add(:discount, "can't be greater than total value")
    end
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Invoice &lt; ApplicationRecord
  validate :expiration_date_cannot_be_in_the_past,
    :discount_cannot_be_greater_than_total_value

  def expiration_date_cannot_be_in_the_past
    if expiration_date.present? &amp;&amp; expiration_date &lt; Date.today
      errors.add(:expiration_date, &quot;can't be in the past&quot;)
    end
  end

  def discount_cannot_be_greater_than_total_value
    if discount &gt; total_value
      errors.add(:discount, &quot;can't be greater than total value&quot;)
    end
  end
end
">Copy</button>
</div>
<p>預設情況下，每次呼叫“valid?”時都會執行此類驗證。
或儲存物件。但是也可以控制何時執行這些
透過為 <code>validate</code> 方法提供 <code>:on</code> 選項來自定義驗證，
使用：<code>:create</code> 或 <code>:update</code>。</p><div class="code_container">
<pre><code class="highlight plaintext">class Invoice &lt; ApplicationRecord
  validate :active_customer, on: :create

  def active_customer
    errors.add(:customer_id, "is not active") unless customer.active?
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Invoice &lt; ApplicationRecord
  validate :active_customer, on: :create

  def active_customer
    errors.add(:customer_id, "is not active") unless customer.active?
  end
end
'>Copy</button>
</div>
<p>[<code>validate</code>]：<a href="https://api.Rubyonrails.org/classes/activemodel/validations/classmethods.html#method-i-validate">https://api.Rubyonrails.org/classes/activemodel/validations/classmethods.html#method-i-validate</a></p><h3 id=""><a class="anchorlink" href="#">7 處理驗證錯誤</a></h3><p>[<code>valid?</code>][] 和 [<code>invalid?</code>][] 方法僅提供有效性的摘要狀態。但是，您可以使用 [<code>errors</code>][] 集合中的各種方法深入挖掘每個錯誤。</p><p>以下是最常用的方法列表。有關所有可用方法的列表，請參閱 [<code>activeModel::errors</code>][] 文件。</p><p>[<code>activemodel::errors</code>]：<a href="https://api.Rubyonrails.org/classes/activemodel/errors.html">https://api.Rubyonrails.org/classes/activemodel/errors.html</a></p><h4 id=""><a class="anchorlink" href="#">7.1 <code>錯誤</code></a></h4><p>您可以透過該閘道器深入瞭解每個錯誤的各種詳細資訊。</p><p>這將返回包含所有錯誤的類 <code>activeModel::errors</code> 的例項，
每個錯誤都由一個 <a href="https://api.Rubyonrails.org/classes/activemodel/error.html"><code>activeModel::error</code></a> 物件表示。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, presence: true, length: { minimum: 3 }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, presence: true, length: { minimum: 3 }
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"Name can't be blank"</span><span class="p">,</span> <span class="s2">"Name is too short (minimum is 3 characters)"</span><span class="p">]</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span>
<span class="p">=&gt;</span> <span class="p">[]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='person = Person.new
person.valid?
person.errors.full_messages
person = Person.new(name: "John Doe")
person.valid?
person.errors.full_messages
'>Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">7.2 <code>錯誤[]</code></a></h4><p>[<code>errors[]</code>][Errors#squarebrackets] 用於檢查特定屬性的錯誤訊息。它返回一個字串陣列，其中包含給定屬性的所有錯誤訊息，每個字串包含一個錯誤訊息。如果沒有與屬性相關的錯誤，則返回一個空陣列。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, presence: true, length: { minimum: 3 }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, presence: true, length: { minimum: 3 }
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span>
<span class="p">=&gt;</span> <span class="p">[]</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"JD"</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"is too short (minimum is 3 characters)"</span><span class="p">]</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"can't be blank"</span><span class="p">,</span> <span class="s2">"is too short (minimum is 3 characters)"</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='person = Person.new(name: "John Doe")
person.valid?
person.errors[:name]
person = Person.new(name: "JD")
person.valid?
person.errors[:name]
person = Person.new
person.valid?
person.errors[:name]
'>Copy</button>
</div>
<h4 id="errors-where"><a class="anchorlink" href="#errors-where">7.3 <code>errors.where</code> 和錯誤物件</a></h4><p>有時，除了訊息之外，我們可能還需要有關每個錯誤的更多資訊。每個錯誤都封裝為一個<code>activeModel::error</code>物件，[<code>where</code>][]方法是最常見的訪問方式。</p><p><code>where</code> 返回一個錯誤物件陣列，按不同程度的條件過濾。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, presence: true, length: { minimum: 3 }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, presence: true, length: { minimum: 3 }
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="p">[</span> <span class="o">...</span> <span class="p">]</span> <span class="c1"># all errors for :name attribute</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:too_short</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="p">[</span> <span class="o">...</span> <span class="p">]</span> <span class="c1"># :too_short errors for :name attribute</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.new
person.valid?
person.errors.where(:name)
person.errors.where(:name, :too_short)
">Copy</button>
</div>
<p>您可以從這些錯誤物件中讀取各種資訊：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">error</span> <span class="o">=</span> <span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:name</span><span class="p">).</span><span class="nf">last</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="nf">attribute</span>
<span class="p">=&gt;</span> <span class="ss">:name</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="nf">type</span>
<span class="p">=&gt;</span> <span class="ss">:too_short</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="nf">options</span><span class="p">[</span><span class="ss">:count</span><span class="p">]</span>
<span class="p">=&gt;</span> <span class="mi">3</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="error = person.errors.where(:name).last
error.attribute
error.type
error.options[:count]
">Copy</button>
</div>
<p>您還可以生成錯誤訊息：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="nf">message</span>
<span class="p">=&gt;</span> <span class="s2">"is too short (minimum is 3 characters)"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="nf">full_message</span>
<span class="p">=&gt;</span> <span class="s2">"Name is too short (minimum is 3 characters)"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="error.message
error.full_message
">Copy</button>
</div>
<p>[<code>full_message</code>][] 方法生成一個更加使用者友好的訊息，帶有大寫的屬性名稱。</p><p>[<code>full_message</code>]：<a href="https://api.Rubyonrails.org/classes/activemodel/errors.html#method-i-full_message">https://api.Rubyonrails.org/classes/activemodel/errors.html#method-i-full_message</a>
[<code>where</code>]：<a href="https://api.Rubyonrails.org/classes/activemodel/errors.html#method-i-where">https://api.Rubyonrails.org/classes/activemodel/errors.html#method-i-where</a></p><h4 id="errors-add"><a class="anchorlink" href="#errors-add">7.4 <code>errors.add</code></a></h4><p>[<code>add</code>][] 方法透過獲取 <code>attribute</code>、錯誤 <code>type</code> 和附加選項雜湊來建立錯誤物件。這對於編寫自己的驗證器很有用。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validate do |person|
    errors.add :name, :too_plain, message: "is not cool enough"
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Person &lt; ApplicationRecord
  validate do |person|
    errors.add :name, :too_plain, message: "is not cool enough"
  end
end
'>Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:name</span><span class="p">).</span><span class="nf">first</span><span class="p">.</span><span class="nf">type</span>
<span class="p">=&gt;</span> <span class="ss">:too_plain</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:name</span><span class="p">).</span><span class="nf">first</span><span class="p">.</span><span class="nf">full_message</span>
<span class="p">=&gt;</span> <span class="s2">"Name is not cool enough"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create
person.errors.where(:name).first.type
person.errors.where(:name).first.full_message
">Copy</button>
</div>
<p>[<code>add</code>]：<a href="https://api.Rubyonrails.org/classes/activemodel/errors.html#method-i-add">https://api.Rubyonrails.org/classes/activemodel/errors.html#method-i-add</a></p><h4 id="base"><a class="anchorlink" href="#base">7.5 <code>錯誤[:base]</code></a></h4><p>您可以新增與物件整體狀態相關的錯誤，而不是與特定屬性相關的錯誤。當你想說物件無效時，你可以向 <code>:base</code> 新增錯誤，不管它的屬性值如何。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validate do |person|
    errors.add :base, :invalid, message: "This person is invalid because ..."
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Person &lt; ApplicationRecord
  validate do |person|
    errors.add :base, :invalid, message: "This person is invalid because ..."
  end
end
'>Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:base</span><span class="p">).</span><span class="nf">first</span><span class="p">.</span><span class="nf">full_message</span>
<span class="p">=&gt;</span> <span class="s2">"This person is invalid because ..."</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.create
person.errors.where(:base).first.full_message
">Copy</button>
</div>
<h4 id="errors-clear"><a class="anchorlink" href="#errors-clear">7.6 <code>errors.clear</code></a></h4><p>當您有意清除“錯誤”集合時，可以使用“clear”方法。當然，在無效物件上呼叫 <code>errors.clear</code> 實際上不會使其有效：<code>errors</code> 集合現在將為空，但是下次你呼叫 <code>valid?</code> 或任何試圖儲存此物件的方法時到資料庫，驗證將再次執行。如果任何驗證失敗，將再次填充 <code>errors</code> 集合。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, presence: true, length: { minimum: 3 }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, presence: true, length: { minimum: 3 }
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">empty?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">clear</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">empty?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">save</span>
<span class="p">=&gt;</span> <span class="kp">false</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">empty?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="person = Person.new
person.valid?
person.errors.empty?
person.errors.clear
person.errors.empty?
person.save
person.errors.empty?
">Copy</button>
</div>
<h4 id="errors-size"><a class="anchorlink" href="#errors-size">7.7 <code>errors.size</code></a></h4><p><code>size</code> 方法返回物件的錯誤總數。</p><div class="code_container">
<pre><code class="highlight plaintext">class Person &lt; ApplicationRecord
  validates :name, presence: true, length: { minimum: 3 }
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Person &lt; ApplicationRecord
  validates :name, presence: true, length: { minimum: 3 }
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">size</span>
<span class="p">=&gt;</span> <span class="mi">2</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Andrea"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"andrea@example.com"</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">valid?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">size</span>
<span class="p">=&gt;</span> <span class="mi">0</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='person = Person.new
person.valid?
person.errors.size
person = Person.new(name: "Andrea", email: "andrea@example.com")
person.valid?
person.errors.size
'>Copy</button>
</div>
<h3 id="views"><a class="anchorlink" href="#views">8 在Views 中顯示驗證錯誤</a></h3><p>一旦您建立了 Model 並添加了驗證，如果 Model 是透過建立的
Web 表單，您可能希望在以下情況之一時顯示錯誤訊息
驗證失敗。</p><p>因為每個應用程式處理這種事情的方式都不一樣，所以 Rails 是這樣做的
不包含任何View helper 以幫助您直接生成這些訊息。
然而，由於 Rails 為您提供了豐富的互動方法
一般驗證，您可以構建自己的。此外，當
生成一個Scaffold，rails 會將一些 erb 放入 <code>_form.html.erb</code> 中
它生成顯示該Model 上的完整錯誤列表。</p><p>假設我們有一個 Model 儲存在一個名為的例項變數中
<code>@article</code>，它看起來像這樣：</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"error_explanation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@article</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">count</span><span class="p">,</span> <span class="s2">"error"</span><span class="p">)</span> <span class="cp">%&gt;</span> prohibited this article from being saved:<span class="nt">&lt;/h2&gt;</span>

    <span class="nt">&lt;ul&gt;</span>
      <span class="cp">&lt;%</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">error</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">error</span><span class="p">.</span><span class="nf">full_message</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;% if @article.errors.any? %&gt;
  &lt;div id="error_explanation"&gt;
    &lt;h2&gt;&lt;%= pluralize(@article.errors.count, "error") %&gt; prohibited this article from being saved:&lt;/h2&gt;

    &lt;ul&gt;
      &lt;% @article.errors.each do |error| %&gt;
        &lt;li&gt;&lt;%= error.full_message %&gt;&lt;/li&gt;
      &lt;% end %&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
&lt;% end %&gt;
'>Copy</button>
</div>
<p>此外，如果您使用 rails 表單 Helpers 生成表單，則當
欄位上發生驗證錯誤，它會在周圍生成一個額外的 <code>&lt;div&gt;</code>
入口。</p><div class="code_container">
<pre><code class="highlight html"><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field_with_errors"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"article_title"</span> <span class="na">name=</span><span class="s">"article[title]"</span> <span class="na">size=</span><span class="s">"30"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">""</span><span class="nt">&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;div class="field_with_errors"&gt;
  &lt;input id="article_title" name="article[title]" size="30" type="text" value=""&gt;
&lt;/div&gt;
'>Copy</button>
</div>
<p>然後，您可以隨意設定此 div 的樣式。預設Scaffold
例如，Rails 生成添加了以下 CSS 規則：</p><div class="code_container">
<pre><code class="highlight css"><span class="nc">.field_with_errors</span> <span class="p">{</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">2px</span><span class="p">;</span>
  <span class="nl">background-color</span><span class="p">:</span> <span class="no">red</span><span class="p">;</span>
  <span class="nl">display</span><span class="p">:</span> <span class="n">table</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text=".field_with_errors {
  padding: 2px;
  background-color: red;
  display: table;
}
">Copy</button>
</div>
<p>這意味著任何有錯誤的欄位都會以 2 畫素的紅色邊框結束。</p>

        <h3>反饋</h3>
        <p>
          我們鼓勵您幫助提高本指南的質量。
        </p>
        <p>
          如果您發現任何拼寫錯誤或事實錯誤，請貢獻。
          首先，您可以閱讀我們的 <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">文檔貢獻</a> 部分。
        </p>
        <p>
          您還可能會發現不完整的內容或不是最新的內容。
          請務必為 main 添加任何缺失的文檔。確保檢查
          <a href="https://edgeguides.rubyonrails.org">Edge Guides</a> 先驗證
          如果問題已經在主分支上解決。
          檢查 <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南指南</a>
          風格和慣例。
        </p>
        <p>
          如果由於某種原因您發現需要修復但無法自行修補的內容，請
          <a href="https://github.com/rails/rails/issues">open an issue</a>。
        </p>
        <p>最後但並非最不重要的是，關於 Ruby on Rails 的任何討論
          <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">rubyonrails-docs 郵件列表</a> 上的文檔非常受歡迎。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>本作品已獲得<a href="https://creativecommons.org/licenses/by-sa/4.0/">知識共享署名-相同方式共享 4.0 國際</a>許可</p>
<p>“Rails”、“Ruby on Rails”和 Rails 標誌是 David Heinemeier Hansson 的商標。 保留所有權利。</p>
    </div>
  </div>
</body>
</html>
