<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Multiple Databases with Active Record — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Multiple Databases with Active Record — Ruby on Rails Guides" />
  <meta name="description" content="Multiple Databases with Active RecordThis guide covers using multiple databases with your Rails application.After reading this guide you will know: How to set up your application for multiple databases. How automatic connection switching works. How to use horizontal sharding for multiple databases. What features are supported and what&#39;s still a work in progress." />
  <meta property="og:description" content="Multiple Databases with Active RecordThis guide covers using multiple databases with your Rails application.After reading this guide you will know: How to set up your application for multiple databases. How automatic connection switching works. How to use horizontal sharding for multiple databases. What features are supported and what&#39;s still a work in progress." />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多在 <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        更多關於 Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">部落格</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">手冊</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">討論</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">貢獻</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="返回首頁">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">首頁</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">手冊索引</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>從這裡開始</dt>
                  <dd><a href="getting_started.html">Rails 入門</a></dd>
                </div>
                <div class="guides-section">
                  <dt>模型（Models）</dt>
                  <dd><a href="active_record_basics.html">Active Record 基礎</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record 遷移</a></dd>
                  <dd><a href="active_record_validations.html">Active Record 驗證</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record 回呼</a></dd>
                  <dd><a href="association_basics.html">Active Record 關聯</a></dd>
                  <dd><a href="active_record_querying.html">Active Record 查詢介面</a></dd>
                </div>
                <div class="guides-section">
                  <dt>畫面（Views）</dt>
                  <dd><a href="layouts_and_rendering.html">Rails 中的佈局和渲染</a></dd>
                  <dd><a href="form_helpers.html">Action View 表單 Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>控制器（Controllers）</dt>
                  <dd><a href="action_controller_overview.html">Action Controller 概述</a></dd>
                  <dd><a href="routing.html">Routing 路由</a></dd>
                </div>
                <div class="guides-section">
                  <dt>其他元件</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer 基礎</a></dd>
                  <dd><a href="active_job_basics.html">Active Job 基礎</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage 概述</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable 概述</a></dd>
                </div>
                <div class="guides-section">
                  <dt>進階功能</dt>
                  <dd><a href="i18n.html">Rails 國際化（I18n）API</a></dd>
                  <dd><a href="testing.html">測試 Rails 應用程式</a></dd>
                  <dd><a href="security.html">保護 Rails 應用程式</a></dd>
                  <dd><a href="debugging_rails_applications.html">測試 Rails 應用程式</a></dd>
                  <dd><a href="configuration.html">設定 Rails 應用程式</a></dd>
                  <dd><a href="command_line.html">Rails 命令列</a></dd>
                  <dd><a href="asset_pipeline.html">Asset Pipeline 資產管道</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">自動執行和重新讀取變數（Zeitwerk模式）</a></dd>
                  <dd><a href="autoloading_and_reloading_constants_classic_mode.html">自動執行和重新執行常數（經典模式）</a></dd>
                  <dd><a href="caching_with_rails.html">使用Rails進行快取: 概述</a></dd>
                  <dd><a href="api_app.html">將 Rails 用於僅 API 的應用程式</a></dd>
                </div>
                <div class="guides-section">
                  <dt>延伸閱讀</dt>
                  <dd><a href="rails_on_rack.html">Rack 上的 Rails</a></dd>
                  <dd><a href="generators.html">建立客製化的 Rails 產生器和樣板</a></dd>
                </div>
                <div class="guides-section">
                  <dt>捐款</dt>
                  <dd><a href="tribution_to_ruby_on_rails.html">為 Ruby on Rails 貢獻</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API文檔準則</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">指南指南</a></dd>
                </div>
                <div class="guides-section">
                  <dt>政策</dt>
                  <dd><a href="maintenance_policy.html">維修政策</a></dd>
                </div>
                <div class="guides-section">
                  <dt>發行說明</dt>
                  <dd><a href="upgrade_ruby_on_rails.html">升級 Ruby on Rails</a></dd>
                  <dd><a href="6_0_release_notes.html">6.0版-2019年8月</a></dd>
                  <dd><a href="5_2_release_notes.html">5.2版-2018年4月</a></dd>
                  <dd><a href="5_1_release_notes.html">5.1版-2017年4月</a></dd>
                  <dd><a href="5_0_release_notes.html">5.0版-2016年6月</a></dd>
                  <dd><a href="4_2_release_notes.html">4.2版-2014年12月</a></dd>
                  <dd><a href="4_1_release_notes.html">4.1版-2014年4月</a></dd>
                  <dd><a href="4_0_release_notes.html">4.0版-2013年6月</a></dd>
                  <dd><a href="3_2_release_notes.html">3.2版-2012年1月</a></dd>
                  <dd><a href="3_1_release_notes.html">3.1版-2011年8月</a></dd>
                  <dd><a href="3_0_release_notes.html">3.0版-2010年8月</a></dd>
                  <dd><a href="2_3_release_notes.html">2.3版-2009年3月</a></dd>
                  <dd><a href="2_2_release_notes.html">2.2版-2008年11月</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">貢獻</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">手冊索引</option>
              <optgroup label="從這裡開始">
                  <option value="getting_started.html">Rails 入門</option>
              </optgroup>
              <optgroup label="模型（Models）">
                  <option value="active_record_basics.html">Active Record 基礎</option>
                  <option value="active_record_migrations.html">Active Record 遷移</option>
                  <option value="active_record_validations.html">Active Record 驗證</option>
                  <option value="active_record_callbacks.html">Active Record 回呼</option>
                  <option value="association_basics.html">Active Record 關聯</option>
                  <option value="active_record_querying.html">Active Record 查詢介面</option>
              </optgroup>
              <optgroup label="畫面（Views）">
                  <option value="layouts_and_rendering.html">Rails 中的佈局和渲染</option>
                  <option value="form_helpers.html">Action View 表單 Helpers</option>
              </optgroup>
              <optgroup label="控制器（Controllers）">
                  <option value="action_controller_overview.html">Action Controller 概述</option>
                  <option value="routing.html">Routing 路由</option>
              </optgroup>
              <optgroup label="其他元件">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer 基礎</option>
                  <option value="active_job_basics.html">Active Job 基礎</option>
                  <option value="active_storage_overview.html">Active Storage 概述</option>
                  <option value="action_cable_overview.html">Action Cable 概述</option>
              </optgroup>
              <optgroup label="進階功能">
                  <option value="i18n.html">Rails 國際化（I18n）API</option>
                  <option value="testing.html">測試 Rails 應用程式</option>
                  <option value="security.html">保護 Rails 應用程式</option>
                  <option value="debugging_rails_applications.html">測試 Rails 應用程式</option>
                  <option value="configuration.html">設定 Rails 應用程式</option>
                  <option value="command_line.html">Rails 命令列</option>
                  <option value="asset_pipeline.html">Asset Pipeline 資產管道</option>
                  <option value="autoloading_and_reloading_constants.html">自動執行和重新讀取變數（Zeitwerk模式）</option>
                  <option value="autoloading_and_reloading_constants_classic_mode.html">自動執行和重新執行常數（經典模式）</option>
                  <option value="caching_with_rails.html">使用Rails進行快取: 概述</option>
                  <option value="api_app.html">將 Rails 用於僅 API 的應用程式</option>
              </optgroup>
              <optgroup label="延伸閱讀">
                  <option value="rails_on_rack.html">Rack 上的 Rails</option>
                  <option value="generators.html">建立客製化的 Rails 產生器和樣板</option>
              </optgroup>
              <optgroup label="捐款">
                  <option value="tribution_to_ruby_on_rails.html">為 Ruby on Rails 貢獻</option>
                  <option value="api_documentation_guidelines.html">API文檔準則</option>
                  <option value="ruby_on_rails_guides_guidelines.html">指南指南</option>
              </optgroup>
              <optgroup label="政策">
                  <option value="maintenance_policy.html">維修政策</option>
              </optgroup>
              <optgroup label="發行說明">
                  <option value="upgrade_ruby_on_rails.html">升級 Ruby on Rails</option>
                  <option value="6_0_release_notes.html">6.0版-2019年8月</option>
                  <option value="5_2_release_notes.html">5.2版-2018年4月</option>
                  <option value="5_1_release_notes.html">5.1版-2017年4月</option>
                  <option value="5_0_release_notes.html">5.0版-2016年6月</option>
                  <option value="4_2_release_notes.html">4.2版-2014年12月</option>
                  <option value="4_1_release_notes.html">4.1版-2014年4月</option>
                  <option value="4_0_release_notes.html">4.0版-2013年6月</option>
                  <option value="3_2_release_notes.html">3.2版-2012年1月</option>
                  <option value="3_1_release_notes.html">3.1版-2011年8月</option>
                  <option value="3_0_release_notes.html">3.0版-2010年8月</option>
                  <option value="2_3_release_notes.html">2.3版-2009年3月</option>
                  <option value="2_2_release_notes.html">2.2版-2008年11月</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Multiple Databases with Active Record</h2><p>This guide covers using multiple databases with your Rails application.</p><p>After reading this guide you will know:</p>
<ul>
<li>How to set up your application for multiple databases.</li>
<li>How automatic connection switching works.</li>
<li>How to use horizontal sharding for multiple databases.</li>
<li>What features are supported and what&#39;s still a work in progress.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#setting-up-your-application">Setting up your application</a></li>
<li><a href="#generators-migrations">Generators &amp; Migrations</a></li>
<li><a href="#activating-automatic-connection-switching">Activating automatic connection switching</a></li>
<li><a href="#using-manual-connection-switching">Using manual connection switching</a></li>
<li><a href="#horizontal-sharding">Horizontal sharding</a></li>
<li><a href="#granular-database-connection-switching">Granular Database Connection Switching</a></li>
<li>
<a href="#caveats">Caveats</a>

<ul>
<li><a href="#automatic-swapping-for-horizontal-sharding">Automatic swapping for horizontal sharding</a></li>
<li><a href="#load-balancing-replicas">Load Balancing Replicas</a></li>
<li><a href="#joining-across-databases">Joining Across Databases</a></li>
<li><a href="#schema-cache">Schema Cache</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <p>As an application grows in popularity and usage you'll need to scale the application
to support your new users and their data. One way in which your application may need
to scale is on the database level. Rails now has support for multiple databases
so you don't have to store your data all in one place.</p><p>At this time the following features are supported:</p>
<ul>
<li>Multiple writer databases and a replica for each</li>
<li>Automatic connection switching for the model you're working with</li>
<li>Automatic swapping between the writer and replica depending on the HTTP verb
and recent writes</li>
<li>Rails tasks for creating, dropping, migrating, and interacting with the multiple
databases</li>
</ul>
<p>The following features are not (yet) supported:</p>
<ul>
<li>Automatic swapping for horizontal sharding</li>
<li>Joining across clusters</li>
<li>Load balancing replicas</li>
<li>Dumping schema caches for multiple databases</li>
</ul>
<h3 id="setting-up-your-application"><a class="anchorlink" href="#setting-up-your-application">1 Setting up your application</a></h3><p>While Rails tries to do most of the work for you there are still some steps you'll
need to do to get your application ready for multiple databases.</p><p>Let's say we have an application with a single writer database and we need to add a
new database for some new tables we're adding. The name of the new database will be
"animals".</p><p>The <code>database.yml</code> looks like this:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">production</span><span class="pi">:</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-aca35c0fc59ae3d22719ed15523f01a8">production:
  database: my_primary_database
  user: root
  adapter: mysql
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-aca35c0fc59ae3d22719ed15523f01a8">Copy</button>
</div>
<p>Let's add a replica for the first configuration, and a second database called animals and a
replica for that as well. To do this we need to change our <code>database.yml</code> from a 2-tier
to a 3-tier config.</p><p>If a primary configuration is provided this will be used as the "default" configuration. If
there is no configuration named "primary" Rails will use the first configuration for an
environment. The default configurations will use the default Rails filenames. For example
primary configurations will use <code>schema.rb</code> for the schema file whereas all other entries
will use <code>[CONFIGURATION_NAMESPACE]_schema.rb</code> for the filename.</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">production</span><span class="pi">:</span>
  <span class="na">primary</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">root</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">primary_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">root_readonly</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">animals</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_animals_database</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">animals_root</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">migrations_paths</span><span class="pi">:</span> <span class="s">db/animals_migrate</span>
  <span class="na">animals_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_animals_database</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">animals_readonly</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="no">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-5fa67e08301cd2e05ad73a2f03fe2db4">production:
  primary:
    database: my_primary_database
    user: root
    adapter: mysql
  primary_replica:
    database: my_primary_database
    user: root_readonly
    adapter: mysql
    replica: true
  animals:
    database: my_animals_database
    user: animals_root
    adapter: mysql
    migrations_paths: db/animals_migrate
  animals_replica:
    database: my_animals_database
    user: animals_readonly
    adapter: mysql
    replica: true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-5fa67e08301cd2e05ad73a2f03fe2db4">Copy</button>
</div>
<p>When using multiple databases there are a few important settings.</p><p>First, the database name for the <code>primary</code> and <code>primary_replica</code> should be the same because they contain
the same data. This is also the case for <code>animals</code> and <code>animals_replica</code>.</p><p>Second, the username for the writers and replicas should be different, and the
replica user's permissions should be set to only read and not write.</p><p>When using a replica database you need to add a <code>replica: true</code> entry to the replica in the
<code>database.yml</code>. This is because Rails otherwise has no way of knowing which one is a replica
and which one is the writer.</p><p>Lastly, for new writer databases you need to set the <code>migrations_paths</code> to the directory
where you will store migrations for that database. We'll look more at <code>migrations_paths</code>
later on in this guide.</p><p>Now that we have a new database, let's set up the connection model. In order to use the
new database we need to create a new abstract class and connect to the animals databases.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AnimalsRecord</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :animals</span><span class="p">,</span> <span class="ss">reading: :animals_replica</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f795fafb6aff8f73b9236b829d1c3530">class AnimalsRecord &lt; ApplicationRecord
  self.abstract_class = true

  connects_to database: { writing: :animals, reading: :animals_replica }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f795fafb6aff8f73b9236b829d1c3530">Copy</button>
</div>
<p>Then we need to update <code>ApplicationRecord</code> to be aware of our new replica.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :primary</span><span class="p">,</span> <span class="ss">reading: :primary_replica</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f94e517fd18afd306fc07bb053e270c3">class ApplicationRecord &lt; ActiveRecord::Base
  self.abstract_class = true

  connects_to database: { writing: :primary, reading: :primary_replica }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f94e517fd18afd306fc07bb053e270c3">Copy</button>
</div>
<p>Classes that connect to primary/primary_replica can inherit from <code>ApplicationRecord</code> like
standard Rails applications:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-672ef1c0e419e229541897d314289bb9">class Person &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-672ef1c0e419e229541897d314289bb9">Copy</button>
</div>
<p>By default Rails expects the database roles to be <code>writing</code> and <code>reading</code> for the primary
and replica respectively. If you have a legacy system you may already have roles set up that
you don't want to change. In that case you can set a new role name in your application config.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">writing_role</span> <span class="o">=</span> <span class="ss">:default</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">reading_role</span> <span class="o">=</span> <span class="ss">:readonly</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-dc3cef26a2fdbefa5016a1c5bb52ea4c">config.active_record.writing_role = :default
config.active_record.reading_role = :readonly
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-dc3cef26a2fdbefa5016a1c5bb52ea4c">Copy</button>
</div>
<p>It's important to connect to your database in a single model and then inherit from that model
for the tables rather than connect multiple individual models to the same database. Database
clients have a limit to the number of open connections there can be and if you do this it will
multiply the number of connections you have since Rails uses the model class name for the
connection specification name.</p><p>Now that we have the <code>database.yml</code> and the new model set up it's time to create the databases.
Rails 6.0 ships with all the rails tasks you need to use multiple databases in Rails.</p><p>You can run <code>bin/rails -T</code> to see all the commands you're able to run. You should see the following:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails</span> <span class="nt">-T</span>
<span class="gp">rails db:create                          #</span><span class="w"> </span>Creates the database from DATABASE_URL or config/database.yml <span class="k">for </span>the ...
<span class="gp">rails db:create:animals                  #</span><span class="w"> </span>Create animals database <span class="k">for </span>current environment
<span class="gp">rails db:create:primary                  #</span><span class="w"> </span>Create primary database <span class="k">for </span>current environment
<span class="gp">rails db:drop                            #</span><span class="w"> </span>Drops the database from DATABASE_URL or config/database.yml <span class="k">for </span>the cu...
<span class="gp">rails db:drop:animals                    #</span><span class="w"> </span>Drop animals database <span class="k">for </span>current environment
<span class="gp">rails db:drop:primary                    #</span><span class="w"> </span>Drop primary database <span class="k">for </span>current environment
<span class="gp">rails db:migrate                         #</span><span class="w"> </span>Migrate the database <span class="o">(</span>options: <span class="nv">VERSION</span><span class="o">=</span>x, <span class="nv">VERBOSE</span><span class="o">=</span><span class="nb">false</span>, <span class="nv">SCOPE</span><span class="o">=</span>blog<span class="o">)</span>
<span class="gp">rails db:migrate:animals                 #</span><span class="w"> </span>Migrate animals database <span class="k">for </span>current environment
<span class="gp">rails db:migrate:primary                 #</span><span class="w"> </span>Migrate primary database <span class="k">for </span>current environment
<span class="gp">rails db:migrate:status                  #</span><span class="w"> </span>Display status of migrations
<span class="gp">rails db:migrate:status:animals          #</span><span class="w"> </span>Display status of migrations <span class="k">for </span>animals database
<span class="gp">rails db:migrate:status:primary          #</span><span class="w"> </span>Display status of migrations <span class="k">for </span>primary database
<span class="gp">rails db:rollback                        #</span><span class="w"> </span>Rolls the schema back to the previous version <span class="o">(</span>specify steps w/ <span class="nv">STEP</span><span class="o">=</span>n<span class="o">)</span>
<span class="gp">rails db:rollback:animals                #</span><span class="w"> </span>Rollback animals database <span class="k">for </span>current environment <span class="o">(</span>specify steps w/ <span class="nv">STEP</span><span class="o">=</span>n<span class="o">)</span>
<span class="gp">rails db:rollback:primary                #</span><span class="w"> </span>Rollback primary database <span class="k">for </span>current environment <span class="o">(</span>specify steps w/ <span class="nv">STEP</span><span class="o">=</span>n<span class="o">)</span>
<span class="gp">rails db:schema:dump                     #</span><span class="w"> </span>Creates a database schema file <span class="o">(</span>either db/schema.rb or db/structure.sql  ...
<span class="gp">rails db:schema:dump:animals             #</span><span class="w"> </span>Creates a database schema file <span class="o">(</span>either db/schema.rb or db/structure.sql  ...
<span class="gp">rails db:schema:dump:primary             #</span><span class="w"> </span>Creates a db/schema.rb file that is portable against any DB supported  ...
<span class="gp">rails db:schema:load                     #</span><span class="w"> </span>Loads a database schema file <span class="o">(</span>either db/schema.rb or db/structure.sql  ...
<span class="gp">rails db:schema:load:animals             #</span><span class="w"> </span>Loads a database schema file <span class="o">(</span>either db/schema.rb or db/structure.sql  ...
<span class="gp">rails db:schema:load:primary             #</span><span class="w"> </span>Loads a database schema file <span class="o">(</span>either db/schema.rb or db/structure.sql  ...
</code></pre>
<textarea class="clipboard-content" id="clipboard-99b1a67d702d113cbaeb786094e3ff8d">bin/rails -T
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-99b1a67d702d113cbaeb786094e3ff8d">Copy</button>
</div>
<p>Running a command like <code>bin/rails db:create</code> will create both the primary and animals databases.
Note that there is no command for creating the users and you'll need to do that manually
to support the readonly users for your replicas. If you want to create just the animals
database you can run <code>bin/rails db:create:animals</code>.</p><h3 id="generators-migrations"><a class="anchorlink" href="#generators-migrations">2 Generators &amp; Migrations</a></h3><p>Migrations for multiple databases should live in their own folders prefixed with the
name of the database key in the configuration.</p><p>You also need to set the <code>migrations_paths</code> in the database configurations to tell Rails
where to find the migrations.</p><p>For example the <code>animals</code> database would look for migrations in the <code>db/animals_migrate</code> directory and
<code>primary</code> would look in <code>db/migrate</code>. Rails generators now take a <code>--database</code> option
so that the file is generated in the correct directory. The command can be run like so:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate migration CreateDogs name:string <span class="nt">--database</span> animals
</code></pre>
<textarea class="clipboard-content" id="clipboard-669440635b655bcde67d6bb0198e9300">bin/rails generate migration CreateDogs name:string --database animals
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-669440635b655bcde67d6bb0198e9300">Copy</button>
</div>
<p>If you are using Rails generators, the scaffold and model generators will create the abstract
class for you. Simply pass the database key to the command line</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate scaffold Dog name:string <span class="nt">--database</span> animals
</code></pre>
<textarea class="clipboard-content" id="clipboard-f11a6d84b96f8d317e23666acf41c017">bin/rails generate scaffold Dog name:string --database animals
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f11a6d84b96f8d317e23666acf41c017">Copy</button>
</div>
<p>A class with the database name and <code>Record</code> will be created. In this example
the database is <code>Animals</code> so we end up with <code>AnimalsRecord</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">AnimalsRecord</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :animals</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-455dcc995304a49db69ec3e9c851459e">class AnimalsRecord &lt; ApplicationRecord
  self.abstract_class = true

  connects_to database: { writing: :animals }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-455dcc995304a49db69ec3e9c851459e">Copy</button>
</div>
<p>The generated model will automatically inherit from <code>AnimalsRecord</code>.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Dog</span> <span class="o">&lt;</span> <span class="no">AnimalsRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d6527ceda027ca2dbbe4a6b44ae61010">class Dog &lt; AnimalsRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d6527ceda027ca2dbbe4a6b44ae61010">Copy</button>
</div>
<p>Note: Since Rails doesn't know which database is the replica for your writer you will need to
add this to the abstract class after you're done.</p><p>Rails will only generate the new class once. It will not be overwritten by new scaffolds
or deleted if the scaffold is deleted.</p><p>If you already have an abstract class and its name differs from <code>AnimalsRecord</code> you can pass
the <code>--parent</code> option to indicate you want a different abstract class:</p><div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate scaffold Dog name:string <span class="nt">--database</span> animals <span class="nt">--parent</span> Animals::Record
</code></pre>
<textarea class="clipboard-content" id="clipboard-247395d4de6312c83c3ff886f3c3021e">bin/rails generate scaffold Dog name:string --database animals --parent Animals::Record
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-247395d4de6312c83c3ff886f3c3021e">Copy</button>
</div>
<p>This will skip generating <code>AnimalsRecord</code> since you've indicated to Rails that you want to
use a different parent class.</p><h3 id="activating-automatic-connection-switching"><a class="anchorlink" href="#activating-automatic-connection-switching">3 Activating automatic connection switching</a></h3><p>Finally, in order to use the read-only replica in your application you'll need to activate
the middleware for automatic switching.</p><p>Automatic switching allows the application to switch from the writer to replica or replica
to writer based on the HTTP verb and whether there was a recent write.</p><p>If the application is receiving a POST, PUT, DELETE, or PATCH request the application will
automatically write to the writer database. For the specified time after the write, the
application will read from the primary. For a GET or HEAD request the application will read
from the replica unless there was a recent write.</p><p>To activate the automatic connection switching middleware, add or uncomment the following
lines in your application config.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_selector</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">delay: </span><span class="mi">2</span><span class="p">.</span><span class="nf">seconds</span> <span class="p">}</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver_context</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span><span class="o">::</span><span class="no">Session</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f56f3a6af61e852a253c710845514294">config.active_record.database_selector = { delay: 2.seconds }
config.active_record.database_resolver = ActiveRecord::Middleware::DatabaseSelector::Resolver
config.active_record.database_resolver_context = ActiveRecord::Middleware::DatabaseSelector::Resolver::Session
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f56f3a6af61e852a253c710845514294">Copy</button>
</div>
<p>Rails guarantees "read your own write" and will send your GET or HEAD request to the
writer if it's within the <code>delay</code> window. By default the delay is set to 2 seconds. You
should change this based on your database infrastructure. Rails doesn't guarantee "read
a recent write" for other users within the delay window and will send GET and HEAD requests
to the replicas unless they wrote recently.</p><p>The automatic connection switching in Rails is relatively primitive and deliberately doesn't
do a whole lot. The goal is a system that demonstrates how to do automatic connection
switching that was flexible enough to be customizable by app developers.</p><p>The setup in Rails allows you to easily change how the switching is done and what
parameters it's based on. Let's say you want to use a cookie instead of a session to
decide when to swap connections. You can write your own class:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">MyCookieResolver</span>
  <span class="c1"># code for your cookie class</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7493603436a27145b6a762b859dd48f6">class MyCookieResolver
  # code for your cookie class
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7493603436a27145b6a762b859dd48f6">Copy</button>
</div>
<p>And then pass it to the middleware:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_selector</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">delay: </span><span class="mi">2</span><span class="p">.</span><span class="nf">seconds</span> <span class="p">}</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver_context</span> <span class="o">=</span> <span class="no">MyCookieResolver</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f93d452ef88d1616bcd12510bd69d9aa">config.active_record.database_selector = { delay: 2.seconds }
config.active_record.database_resolver = ActiveRecord::Middleware::DatabaseSelector::Resolver
config.active_record.database_resolver_context = MyCookieResolver
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f93d452ef88d1616bcd12510bd69d9aa">Copy</button>
</div>
<h3 id="using-manual-connection-switching"><a class="anchorlink" href="#using-manual-connection-switching">4 Using manual connection switching</a></h3><p>There are some cases where you may want your application to connect to a writer or a replica
and the automatic connection switching isn't adequate. For example, you may know that for a
particular request you always want to send the request to a replica, even when you are in a
POST request path.</p><p>To do this Rails provides a <code>connected_to</code> method that will switch to the connection you
need.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># all code in this block will be connected to the reading role</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-54b0c113042708dafebff91398e36d61">ActiveRecord::Base.connected_to(role: :reading) do
  # all code in this block will be connected to the reading role
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-54b0c113042708dafebff91398e36d61">Copy</button>
</div>
<p>The "role" in the <code>connected_to</code> call looks up the connections that are connected on that
connection handler (or role). The <code>reading</code> connection handler will hold all the connections
that were connected via <code>connects_to</code> with the role name of <code>reading</code>.</p><p>Note that <code>connected_to</code> with a role will look up an existing connection and switch
using the connection specification name. This means that if you pass an unknown role
like <code>connected_to(role: :nonexistent)</code> you will get an error that says
<code>ActiveRecord::ConnectionNotEstablished (No connection pool with 'AnimalsBase' found
for the 'nonexistent' role.)</code></p><h3 id="horizontal-sharding"><a class="anchorlink" href="#horizontal-sharding">5 Horizontal sharding</a></h3><p>Horizontal sharding is when you split up your database to reduce the number of rows on each
database server, but maintain the same schema across "shards". This is commonly called "multi-tenant"
sharding.</p><p>The API for supporting horizontal sharding in Rails is similar to the multiple database / vertical
sharding API that's existed since Rails 6.0.</p><p>Shards are declared in the three-tier config like this:</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">production</span><span class="pi">:</span>
  <span class="na">primary</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">primary_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">primary_shard_one</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_shard_one</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">primary_shard_one_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_shard_one</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="no">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e43ae238c09141955c7413207e5b04d5">production:
  primary:
    database: my_primary_database
    adapter: mysql
  primary_replica:
    database: my_primary_database
    adapter: mysql
    replica: true
  primary_shard_one:
    database: my_primary_shard_one
    adapter: mysql
  primary_shard_one_replica:
    database: my_primary_shard_one
    adapter: mysql
    replica: true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e43ae238c09141955c7413207e5b04d5">Copy</button>
</div>
<p>Models are then connected with the <code>connects_to</code> API via the <code>shards</code> key:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">shards: </span><span class="p">{</span>
    <span class="ss">default: </span><span class="p">{</span> <span class="ss">writing: :primary</span><span class="p">,</span> <span class="ss">reading: :primary_replica</span> <span class="p">},</span>
    <span class="ss">shard_one: </span><span class="p">{</span> <span class="ss">writing: :primary_shard_one</span><span class="p">,</span> <span class="ss">reading: :primary_shard_one_replica</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e4e497d05730d66db438c77810d6e029">class ApplicationRecord &lt; ActiveRecord::Base
  self.abstract_class = true

  connects_to shards: {
    default: { writing: :primary, reading: :primary_replica },
    shard_one: { writing: :primary_shard_one, reading: :primary_shard_one_replica }
  }
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e4e497d05730d66db438c77810d6e029">Copy</button>
</div>
<p>Then models can swap connections manually via the <code>connected_to</code> API. If
using sharding both a <code>role</code> and <code>shard</code> must be passed:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :writing</span><span class="p">,</span> <span class="ss">shard: :default</span><span class="p">)</span> <span class="k">do</span>
  <span class="vi">@id</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create!</span> <span class="c1"># Creates a record in shard default</span>
<span class="k">end</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :writing</span><span class="p">,</span> <span class="ss">shard: :shard_one</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="vi">@id</span><span class="p">)</span> <span class="c1"># Can't find record, doesn't exist because it was created</span>
                   <span class="c1"># in the default shard</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8c7933cc66ffa39496e0af301f0742ef">ActiveRecord::Base.connected_to(role: :writing, shard: :default) do
  @id = Person.create! # Creates a record in shard default
end

ActiveRecord::Base.connected_to(role: :writing, shard: :shard_one) do
  Person.find(@id) # Can't find record, doesn't exist because it was created
                   # in the default shard
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8c7933cc66ffa39496e0af301f0742ef">Copy</button>
</div>
<p>The horizontal sharding API also supports read replicas. You can swap the
role and the shard with the <code>connected_to</code> API.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="ss">shard: :shard_one</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Lookup record from read replica of shard one</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-21de4cb3ff19ab171b55216f94dfdcef">ActiveRecord::Base.connected_to(role: :reading, shard: :shard_one) do
  Person.first # Lookup record from read replica of shard one
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-21de4cb3ff19ab171b55216f94dfdcef">Copy</button>
</div>
<h3 id="granular-database-connection-switching"><a class="anchorlink" href="#granular-database-connection-switching">6 Granular Database Connection Switching</a></h3><p>In Rails 6.1 it's possible to switch connections for one database instead of
all databases globally. To use this feature you must first set
<code>config.active_record.legacy_connection_handling</code> to <code>false</code> in your application
configuration. The majority of applications should not need to make any other
changes since the public APIs have the same behavior.</p><p>With <code>legacy_connection_handling</code> set to false, any abstract connection class
will be able to switch connections without affecting other connections. This
is useful for switching your <code>AnimalsRecord</code> queries to read from the replica
while ensuring your <code>ApplicationRecord</code> queries go to the primary.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">AnimalsRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Dog</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Reads from animals_replica</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">first</span>  <span class="c1"># Reads from primary</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f840da76229b9fe792035b8c79d90145">AnimalsRecord.connected_to(role: :reading) do
  Dog.first # Reads from animals_replica
  Person.first  # Reads from primary
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f840da76229b9fe792035b8c79d90145">Copy</button>
</div>
<p>It's also possible to swap connections granularly for shards.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">AnimalsRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="ss">shard: :shard_one</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Dog</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Will read from shard_one_replica. If no connection exists for shard_one_replica,</span>
  <span class="c1"># a ConnectionNotEstablished error will be raised</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Will read from primary writer</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ea0f3bba996f1e316078d583709ef085">AnimalsRecord.connected_to(role: :reading, shard: :shard_one) do
  Dog.first # Will read from shard_one_replica. If no connection exists for shard_one_replica,
  # a ConnectionNotEstablished error will be raised
  Person.first # Will read from primary writer
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ea0f3bba996f1e316078d583709ef085">Copy</button>
</div>
<p>To switch only the primary database cluster use <code>ApplicationRecord</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ApplicationRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="ss">shard: :shard_one</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Reads from primary_shard_one_replica</span>
  <span class="no">Dog</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Reads from animals_primary</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-c9b5b29b98c19c9d741431bda8dcbd54">ApplicationRecord.connected_to(role: :reading, shard: :shard_one) do
  Person.first # Reads from primary_shard_one_replica
  Dog.first # Reads from animals_primary
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-c9b5b29b98c19c9d741431bda8dcbd54">Copy</button>
</div>
<p><code>ActiveRecord::Base.connected_to</code> maintains the ability to switch
connections globally.</p><h3 id="caveats"><a class="anchorlink" href="#caveats">7 Caveats</a></h3><h4 id="automatic-swapping-for-horizontal-sharding"><a class="anchorlink" href="#automatic-swapping-for-horizontal-sharding">7.1 Automatic swapping for horizontal sharding</a></h4><p>While Rails now supports an API for connecting to and swapping connections of shards, it does
not yet support an automatic swapping strategy. Any shard swapping will need to be done manually
in your app via a middleware or <code>around_action</code>.</p><h4 id="load-balancing-replicas"><a class="anchorlink" href="#load-balancing-replicas">7.2 Load Balancing Replicas</a></h4><p>Rails also doesn't support automatic load balancing of replicas. This is very
dependent on your infrastructure. We may implement basic, primitive load balancing
in the future, but for an application at scale this should be something your application
handles outside of Rails.</p><h4 id="joining-across-databases"><a class="anchorlink" href="#joining-across-databases">7.3 Joining Across Databases</a></h4><p>Applications cannot join across databases. Rails 6.1 will support using <code>has_many</code>
relationships and creating 2 queries instead of joining, but Rails 6.0 will require
you to split the joins into 2 selects manually.</p><h4 id="schema-cache"><a class="anchorlink" href="#schema-cache">7.4 Schema Cache</a></h4><p>If you use a schema cache and multiple databases you'll need to write an initializer
that loads the schema cache from your app. This wasn't an issue we could resolve in
time for Rails 6.0 but hope to have it in a future version soon.</p>

        <h3>回饋</h3>
        <p>
          我們鼓勵您幫助提高本指南的質量。
        </p>
        <p>
          如果您發現任何錯別字或事實錯誤，請做出貢獻。
          首先，您可以閱讀我們的 <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">文件貢獻</a> 部分。
        </p>
        <p>
          您可能還會發現內容不完整或不是最新的內容。請為母版添加任何缺少的文檔。確保首先檢查
          <a href="https://edgeguides.rubyonrails.org">Edge Guides</a> 以驗證問題是否已在master分支上解決。
          查看 <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a> 的樣式和約定。
        </p>
        <p>
          如果出於任何原因您發現了要修復的東西但自己無法修補，請 <a href="https://github.com/rails/rails/issues">建立一個 issue</a>.
        </p>
        <p>最後但並非最不重要的一點是，在 <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">rubyonrails-docs 郵件列表</a> 上非常歡迎進行有關Ruby on Rails文檔的任何討論。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>該著作已根據 <a href="https://creativecommons.org/licenses/by-sa/4.0/">知識共享署名-相同方式共享 4.0 國際版</a> 許可</ p>
<p> “Rails”、“Ruby on Rails” 和 “Rails 標誌” 是 David Heinemeier Hansson 的註冊商標。保留所有權利。</ p>
    </div>
  </div>
</body>
</html>
