<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>active storage 結束View — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="active storage 結束View — Ruby on Rails Guides" />
  <meta name="description" content="active storage 結束View本指南介紹瞭如何將檔案附加到您的 active record Model。閱讀本指南後，您將瞭解： 如何將一個或多個檔案附加到記錄中。 如何刪除附加檔案。 如何連結到附加檔案。 如何使用變體來轉換影象。 如何生成非影象檔案的影象表示，例如 PDF 或影片。 如何將檔案上傳直接從瀏覽器傳送到儲存服務， 繞過您的應用程式伺服器。 如何清理測試期間儲存的檔案。 如何實現對附加儲存服務的支援。" />
  <meta property="og:description" content="active storage 結束View本指南介紹瞭如何將檔案附加到您的 active record Model。閱讀本指南後，您將瞭解： 如何將一個或多個檔案附加到記錄中。 如何刪除附加檔案。 如何連結到附加檔案。 如何使用變體來轉換影象。 如何生成非影象檔案的影象表示，例如 PDF 或影片。 如何將檔案上傳直接從瀏覽器傳送到儲存服務， 繞過您的應用程式伺服器。 如何清理測試期間儲存的檔案。 如何實現對附加儲存服務的支援。" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v6.1.4</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多訊息請訪問 <a href="https://rubyonrails.org/">rubyonrails.org：</a> </strong>
      <span class="red-button more-info-button">
        更多 Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">部落格</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">指南</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">論壇</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">在 GitHub 上做出貢獻</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="返回首頁">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">首頁</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">指南索引</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>從這裡開始</dt>
                  <dd><a href="getting_started.html">Rails 入門</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record 基礎知識</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record 驗證</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record 查詢介面</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="layouts_and_rendering.html">Rails 中的佈局和渲染</a></dd>
                  <dd><a href="form_helpers.html">Action View 表單 Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller結束view</a></dd>
                  <dd><a href="routing.html">Rails 從外到內路由</a></dd>
                </div>
                <div class="guides-section">
                  <dt>其他元件</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support 核心擴充套件</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer 基礎知識</a></dd>
                  <dd><a href="active_job_basics.html">現役工作基礎</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage 結束view</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable 結束 view</a></dd>
                  <dd><a href="webpacker.html">打包機</a></dd>
                </div>
                <div class="guides-section">
                  <dt>深層發掘</dt>
                  <dd><a href="i18n.html">Rails 國際化 (I18n) API</a></dd>
                  <dd><a href="testing.html">測試 Rails 應用程式</a></dd>
                  <dd><a href="security.html">保護 Rails 應用程式</a></dd>
                  <dd><a href="debugging_rails_applications.html">除錯 Rails 應用程式</a></dd>
                  <dd><a href="configuring.html">配置 Rails 應用程式</a></dd>
                  <dd><a href="command_line.html">Rails 命令列</a></dd>
                  <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">自動載入和重新載入常量</a></dd>
                  <dd><a href="caching_with_rails.html">使用 Rails 快取：結束view</a></dd>
                  <dd><a href="api_app.html">將 Rails 用於僅 API 的應用程式</a></dd>
                </div>
                <div class="guides-section">
                  <dt>延伸導軌</dt>
                  <dd><a href="rails_on_rack.html">機架上的導軌</a></dd>
                  <dd><a href="generators.html">建立和自定義 Rails 生成器和模板</a></dd>
                </div>
                <div class="guides-section">
                  <dt>貢獻</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API 文件指南</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">指南指南</a></dd>
                </div>
                <div class="guides-section">
                  <dt>政策</dt>
                  <dd><a href="maintenance_policy.html">維修政策</a></dd>
                </div>
                <div class="guides-section">
                  <dt>發行說明</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</a></dd>
                  <dd><a href="6_1_release_notes.html">版本 6.1 - 2020 年 12 月</a></dd>
                  <dd><a href="6_0_release_notes.html">6.0 版 - 2019 年 8 月</a></dd>
                  <dd><a href="5_2_release_notes.html">5.2 版 - 2018 年 4 月</a></dd>
                  <dd><a href="5_1_release_notes.html">5.1 版 - 2017 年 4 月</a></dd>
                  <dd><a href="5_0_release_notes.html">5.0 版 - 2016 年 6 月</a></dd>
                  <dd><a href="4_2_release_notes.html">4.2 版 - 2014 年 12 月</a></dd>
                  <dd><a href="4_1_release_notes.html">4.1 版 - 2014 年 4 月</a></dd>
                  <dd><a href="4_0_release_notes.html">4.0 版 - 2013 年 6 月</a></dd>
                  <dd><a href="3_2_release_notes.html">3.2 版 - 2012 年 1 月</a></dd>
                  <dd><a href="3_1_release_notes.html">3.1 版 - 2011 年 8 月</a></dd>
                  <dd><a href="3_0_release_notes.html">3.0 版 - 2010 年 8 月</a></dd>
                  <dd><a href="2_3_release_notes.html">2.3 版 - 2009 年 3 月</a></dd>
                  <dd><a href="2_2_release_notes.html">2.2 版 - 2008 年 11 月</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">貢獻</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">指南索引</option>
              <optgroup label="從這裡開始">
                  <option value="getting_started.html">Rails 入門</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record 基礎知識</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record 驗證</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record 查詢介面</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Rails 中的佈局和渲染</option>
                  <option value="form_helpers.html">Action View 表單 Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller結束view</option>
                  <option value="routing.html">Rails 從外到內路由</option>
              </optgroup>
              <optgroup label="其他元件">
                  <option value="active_support_core_extensions.html">Active Support 核心擴充套件</option>
                  <option value="action_mailer_basics.html">Action Mailer 基礎知識</option>
                  <option value="active_job_basics.html">現役工作基礎</option>
                  <option value="active_storage_overview.html">Active Storage 結束view</option>
                  <option value="action_cable_overview.html">Action Cable 結束 view</option>
                  <option value="webpacker.html">打包機</option>
              </optgroup>
              <optgroup label="深層發掘">
                  <option value="i18n.html">Rails 國際化 (I18n) API</option>
                  <option value="testing.html">測試 Rails 應用程式</option>
                  <option value="security.html">保護 Rails 應用程式</option>
                  <option value="debugging_rails_applications.html">除錯 Rails 應用程式</option>
                  <option value="configuring.html">配置 Rails 應用程式</option>
                  <option value="command_line.html">Rails 命令列</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="autoloading_and_reloading_constants.html">自動載入和重新載入常量</option>
                  <option value="caching_with_rails.html">使用 Rails 快取：結束view</option>
                  <option value="api_app.html">將 Rails 用於僅 API 的應用程式</option>
              </optgroup>
              <optgroup label="延伸導軌">
                  <option value="rails_on_rack.html">機架上的導軌</option>
                  <option value="generators.html">建立和自定義 Rails 生成器和模板</option>
              </optgroup>
              <optgroup label="貢獻">
                  <option value="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</option>
                  <option value="api_documentation_guidelines.html">API 文件指南</option>
                  <option value="ruby_on_rails_guides_guidelines.html">指南指南</option>
              </optgroup>
              <optgroup label="政策">
                  <option value="maintenance_policy.html">維修政策</option>
              </optgroup>
              <optgroup label="發行說明">
                  <option value="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</option>
                  <option value="6_1_release_notes.html">版本 6.1 - 2020 年 12 月</option>
                  <option value="6_0_release_notes.html">6.0 版 - 2019 年 8 月</option>
                  <option value="5_2_release_notes.html">5.2 版 - 2018 年 4 月</option>
                  <option value="5_1_release_notes.html">5.1 版 - 2017 年 4 月</option>
                  <option value="5_0_release_notes.html">5.0 版 - 2016 年 6 月</option>
                  <option value="4_2_release_notes.html">4.2 版 - 2014 年 12 月</option>
                  <option value="4_1_release_notes.html">4.1 版 - 2014 年 4 月</option>
                  <option value="4_0_release_notes.html">4.0 版 - 2013 年 6 月</option>
                  <option value="3_2_release_notes.html">3.2 版 - 2012 年 1 月</option>
                  <option value="3_1_release_notes.html">3.1 版 - 2011 年 8 月</option>
                  <option value="3_0_release_notes.html">3.0 版 - 2010 年 8 月</option>
                  <option value="2_3_release_notes.html">2.3 版 - 2009 年 3 月</option>
                  <option value="2_2_release_notes.html">2.2 版 - 2008 年 11 月</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>active storage 結束View</h2><p>本指南介紹瞭如何將檔案附加到您的 active record Model。</p><p>閱讀本指南後，您將瞭解：</p>
<ul>
<li>如何將一個或多個檔案附加到記錄中。</li>
<li>如何刪除附加檔案。</li>
<li>如何連結到附加檔案。</li>
<li>如何使用變體來轉換影象。</li>
<li>如何生成非影象檔案的影象表示，例如 PDF 或影片。</li>
<li>如何將檔案上傳直接從瀏覽器傳送到儲存服務，
繞過您的應用程式伺服器。</li>
<li>如何清理測試期間儲存的檔案。</li>
<li>如何實現對附加儲存服務的支援。</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#active-storage">什麼是Active Storage？</a>

<ul>
<li><a href="#">要求</a></li>
</ul>
</li>
<li>
<a href="#">設定</a>

<ul>
<li><a href="#">磁碟服務</a></li>
<li><a href="#s3-s3-s3-api">s3 服務（亞馬遜 s3 和 s3 相容的 api）</a></li>
<li><a href="#azure">微軟 azure 儲存服務</a></li>
<li><a href="#">谷歌雲端儲存服務</a></li>
<li><a href="#">映象服務</a></li>
<li><a href="#">公共訪問</a></li>
</ul>
</li>
<li>
<a href="#">將檔案附加到記錄</a>

<ul>
<li><a href="#has-one-attached"><code>has_one_attached</code></a></li>
<li><a href="#has-many-attached"><code>has_many_attached</code></a></li>
<li><a href="#io">附加檔案/io 物件</a></li>
</ul>
</li>
<li><a href="#">刪除檔案</a></li>
<li>
<a href="#">提供檔案</a>

<ul>
<li><a href="#">重定向模式</a></li>
<li><a href="#">代理模式</a></li>
<li><a href="#controllers">已驗證 controllers</a></li>
</ul>
</li>
<li><a href="#">下載檔案</a></li>
<li><a href="#">分析檔案</a></li>
<li>
<a href="#pdf">顯示影象、影片和 PDF</a>

<ul>
<li><a href="#vs">延遲載入 vs 立即載入</a></li>
<li><a href="#">轉換影象</a></li>
<li><a href="#view">預view 檔案</a></li>
</ul>
</li>
<li>
<a href="#">直接上傳</a>

<ul>
<li><a href="#">用法</a></li>
<li><a href="#cors">跨域資源共享（cors）配置</a></li>
<li><a href="#javascript">直接上傳javascript事件</a></li>
<li><a href="#">示例</a></li>
<li><a href="#">與庫或框架整合</a></li>
</ul>
</li>
<li>
<a href="#">測試</a>

<ul>
<li><a href="#">丟棄測試期間建立的檔案</a></li>
<li><a href="#">為燈具新增附件</a></li>
</ul>
</li>
<li><a href="#">實施對其他雲服務的支援</a></li>
<li><a href="#">清除未附加的上傳</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="active-storage"><a class="anchorlink" href="#active-storage">1 什麼是Active Storage？</a></h3><p>Active Storage 有助於將檔案上傳到雲端儲存服務，例如
Amazon S3、Google Cloud Storage 或 Microsoft Azure Storage 並附加這些
檔案到Active Record 物件。它帶有基於本地磁碟的服務，用於
開發測試，支援映象檔案到下級服務
備份和Migrations。</p><p>使用Active Storage，應用程式可以轉換影象上傳或生成影象
非影象上傳（如 PDF 和影片）的表示，並從中提取元資料
任意檔案。</p><h4 id=""><a class="anchorlink" href="#">1.1 要求</a></h4><p>Active Storage 的各種功能依賴於第三方軟體
不會安裝，必須單獨安裝：</p>
<ul>
<li>
<a href="https://github.com/libvips/libvips">libvips</a> 或 <a href="https://imagemagick.org/index.php">ImageMagick</a> v8.6+ 用於影象分析和轉換</li>
<li>
<a href="http://ffmpeg.org/">ffmpeg</a> v3.4+ 用於影片/音訊分析和影片預Views</li>
<li>
<a href="https://poppler.freedesktop.org/">poppler</a> 或 <a href="https://mupdf.com/">mupdf</a> for pdf preViews</li>
</ul>
<p>影象分析和轉換也需要<code>image_processing</code> gem。在你的 <code>Gemfile</code> 中取消註釋，或者在必要時新增它：</p><div class="code_container">
<pre><code class="highlight plaintext">gem "image_processing", "&gt;= 1.2"
</code></pre>
<button class="clipboard-button" data-clipboard-text='gem "image_processing", "&gt;= 1.2"
'>Copy</button>
</div>
<p>提示：與 libvips 相比，ImageMagick 更為人所知且使用範圍更廣。但是，libvips 可以<a href="https://github.com/libvips/libvips/wiki/Speed-and-memory-use">最多快 10 倍並消耗 1/10 的記憶體</a>。對於 JPEG 檔案，這可以透過將 <code>libjpeg-dev</code> 替換為 <code>libjpeg-turbo-dev</code> 來進一步改進，這是 <a href="https://libjpeg-turbo.org/About/Performance">快 2-7 倍</a>。</p><p>警告：在安裝和使用第三方軟體之前，請確保您瞭解這樣做的許可含義。特別是 MuPDF，根據 AGPL 獲得許可，並且某些用途需要商業許可。</p><h3 id=""><a class="anchorlink" href="#">2 設定</a></h3><p>Active Storage 使用應用程式資料庫中的三個表，名為
<code>active_storage_blobs</code>、<code>active_storage_variant_records</code>
和<code>active_storage_attachments</code>。建立新的後
應用程式（或將您的應用程序升級到 Rails 5.2），執行
<code>bin/rails active_storage:install</code> 生成遷移，建立這些
表。使用<code>bin/rails db:migrate</code> 來執行遷移。</p><p>警告：<code>active_storage_attachments</code> 是一個多型連線表，用於儲存Model 的類名。如果您的Model 的類名發生更改，您將需要在此表上執行遷移以將基礎 <code>record_type</code> 更新為您的Model 的新類名。</p><p>警告：如果您使用 uuids 而不是整數作為 Models 上的主鍵，您將需要相應地更改生成的遷移中 <code>active_storage_attachments.record_id</code> 和 <code>active_storage_variant_records.id</code> 的列型別。</p><p>在 <code>config/storage.yml</code> 中宣告 Active Storage 服務。對於每項服務，您的
應用程式使用，提供名稱和必要的配置。這個例子
下面聲明瞭三個名為“local”、“test”和“amazon”的服務：</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">local</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">Disk</span>
  <span class="na">root</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("storage") %&gt;</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">Disk</span>
  <span class="na">root</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("tmp/storage") %&gt;</span>

<span class="na">amazon</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="na">access_key_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span> <span class="c1"># e.g. 'us-east-1'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="local:
  service: Disk
  root: &lt;%= Rails.root.join(&quot;storage&quot;) %&gt;

test:
  service: Disk
  root: &lt;%= Rails.root.join(&quot;tmp/storage&quot;) %&gt;

amazon:
  service: S3
  access_key_id: &quot;&quot;
  secret_access_key: &quot;&quot;
  bucket: &quot;&quot;
  region: &quot;&quot; # e.g. 'us-east-1'
">Copy</button>
</div>
<p>透過設定告訴Active Storage 使用哪個服務
<code>Rails.application.config.active_storage.service</code>。因為每個環境都會
可能使用不同的服務，建議在
每個環境的基礎。要使用前面示例中的磁碟服務
開發環境，您將新增以下內容
<code>config/environments/development.rb</code>：</p><div class="code_container">
<pre><code class="highlight plaintext"># Store files locally.
config.active_storage.service = :local
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Store files locally.
config.active_storage.service = :local
">Copy</button>
</div>
<p>要在生產中使用 S3 服務，請將以下內容新增到
<code>config/environments/production.rb</code>：</p><div class="code_container">
<pre><code class="highlight plaintext"># Store files on Amazon S3.
config.active_storage.service = :amazon
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Store files on Amazon S3.
config.active_storage.service = :amazon
">Copy</button>
</div>
<p>要在測試時使用測試服務，將以下內容新增到
<code>配置/環境/test.rb</code>：</p><div class="code_container">
<pre><code class="highlight plaintext"># Store uploaded files on the local file system in a temporary directory.
config.active_storage.service = :test
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Store uploaded files on the local file system in a temporary directory.
config.active_storage.service = :test
">Copy</button>
</div>
<p>繼續閱讀有關內建服務介面卡的更多資訊（例如
<code>Disk</code> 和 <code>S3</code>) 以及它們需要的配置。</p><p>注意：特定於環境的配置檔案將優先：
在生產中，例如，<code>config/storage/production.yml</code> 檔案（如果存在）
將優先於 <code>config/storage.yml</code> 檔案。</p><p>建議在bucket名稱中使用<code>Rails.env</code>，以進一步降低意外破壞生產資料的風險。</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">amazon</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="c1"># ...</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s">your_own_bucket-&lt;%= Rails.env %&gt;</span>

<span class="na">google</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="c1"># ...</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s">your_own_bucket-&lt;%= Rails.env %&gt;</span>

<span class="na">azure</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">AzureStorage</span>
  <span class="c1"># ...</span>
  <span class="na">container</span><span class="pi">:</span> <span class="s">your_container_name-&lt;%= Rails.env %&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="amazon:
  service: S3
  # ...
  bucket: your_own_bucket-&lt;%= Rails.env %&gt;

google:
  service: GCS
  # ...
  bucket: your_own_bucket-&lt;%= Rails.env %&gt;

azure:
  service: AzureStorage
  # ...
  container: your_container_name-&lt;%= Rails.env %&gt;
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">2.1 磁碟服務</a></h4><p>在 <code>config/storage.yml</code> 中宣告一個磁碟服務：</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">local</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">Disk</span>
  <span class="na">root</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("storage") %&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='local:
  service: Disk
  root: &lt;%= Rails.root.join("storage") %&gt;
'>Copy</button>
</div>
<h4 id="s3-s3-s3-api"><a class="anchorlink" href="#s3-s3-s3-api">2.2 s3 服務（亞馬遜 s3 和 s3 相容的 api）</a></h4><p>要連線到 Amazon S3，請在 <code>config/storage.yml</code> 中宣告一個 S3 服務：</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">amazon</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="na">access_key_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='amazon:
  service: S3
  access_key_id: ""
  secret_access_key: ""
  region: ""
  bucket: ""
'>Copy</button>
</div>
<p>（可選）提供客戶端和上傳選項：</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">amazon</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="na">access_key_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">http_open_timeout</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">http_read_timeout</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">retry_limit</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">upload</span><span class="pi">:</span>
    <span class="na">server_side_encryption</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span> <span class="c1"># 'aws:kms' or 'AES256'</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="amazon:
  service: S3
  access_key_id: &quot;&quot;
  secret_access_key: &quot;&quot;
  region: &quot;&quot;
  bucket: &quot;&quot;
  http_open_timeout: 0
  http_read_timeout: 0
  retry_limit: 0
  upload:
    server_side_encryption: &quot;&quot; # 'aws:kms' or 'AES256'
">Copy</button>
</div>
<p>提示：為您的應用程式設定合理的客戶端 HTTP 超時和重試限制。在某些故障情況下，預設的 AWS 客戶端配置可能會導致連線最多保持幾分鐘並導致請求排隊。</p><p>將 <a href="https://github.com/aws/aws-sdk-Ruby"><code>aws-sdk-s3</code></a> gem 新增到您的 <code>gemfile</code>：</p><div class="code_container">
<pre><code class="highlight plaintext">gem "aws-sdk-s3", require: false
</code></pre>
<button class="clipboard-button" data-clipboard-text='gem "aws-sdk-s3", require: false
'>Copy</button>
</div>
<p>注意：Active Storage 的核心功能需要以下許可權：<code>s3:listbucket</code>、<code>s3:putobject</code>、<code>s3:getobject</code> 和 <code>s3:deleteobject</code>。 <a href="#public-access">公共訪問</a> 還需要<code>s3:putobjectacl</code>。如果您配置了額外的上傳選項，例如設定 acls，則可能需要額外的許可權。</p><p>注意：如果要使用環境變數、標準 SDK 配置檔案、配置檔案、
IAM 例項配置檔案或任務角色，您可以省略 <code>access_key_id</code>、<code>secret_access_key</code>，
和上例中的<code>region</code>鍵。 S3 服務支援所有
<a href="https://docs.aws.amazon.com/sdk-for-Ruby/v3/developer-guide/setup-config.html">aws sdk 文件</a> 中描述的身份驗證選項。</p><p>要連線到 S3 相容的物件儲存 API，例如 DigitalOcean Spaces，請提供“端點”：</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">digitalocean</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="na">endpoint</span><span class="pi">:</span> <span class="s">https://nyc3.digitaloceanspaces.com</span>
  <span class="na">access_key_id</span><span class="pi">:</span> <span class="s">...</span>
  <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s">...</span>
  <span class="c1"># ...and other options</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="digitalocean:
  service: S3
  endpoint: https://nyc3.digitaloceanspaces.com
  access_key_id: ...
  secret_access_key: ...
  # ...and other options
">Copy</button>
</div>
<p>還有許多其他選項可用。您可以在 <a href="https://docs.aws.amazon.com/sdk-for-Ruby/v3/api/aws/s3/client.html#initialize-instance_method">aws s3 客戶端</a> 文件中檢視它們。</p><h4 id="azure"><a class="anchorlink" href="#azure">2.3 微軟 azure 儲存服務</a></h4><p>在 <code>config/storage.yml</code> 中宣告一個 Azure 儲存服務：</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">azure</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">AzureStorage</span>
  <span class="na">storage_account_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">storage_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">container</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='azure:
  service: AzureStorage
  storage_account_name: ""
  storage_access_key: ""
  container: ""
'>Copy</button>
</div>
<p>將 <a href="https://github.com/azure/azure-storage-Ruby"><code>azure-storage-blob</code></a> gem 新增到您的 <code>gemfile</code>：</p><div class="code_container">
<pre><code class="highlight plaintext">gem "azure-storage-blob", require: false
</code></pre>
<button class="clipboard-button" data-clipboard-text='gem "azure-storage-blob", require: false
'>Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">2.4 谷歌雲端儲存服務</a></h4><p>在 <code>config/storage.yml</code> 中宣告一個 Google Cloud Storage 服務：</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">google</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="na">credentials</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("path/to/keyfile.json") %&gt;</span>
  <span class="na">project</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='google:
  service: GCS
  credentials: &lt;%= Rails.root.join("path/to/keyfile.json") %&gt;
  project: ""
  bucket: ""
'>Copy</button>
</div>
<p>（可選）提供憑證雜湊而不是金鑰檔案路徑：</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">google</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="na">credentials</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">service_account"</span>
    <span class="na">project_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">private_key_id</span><span class="pi">:</span> <span class="s">&lt;%= Rails.application.credentials.dig(:gcs, :private_key_id) %&gt;</span>
    <span class="na">private_key</span><span class="pi">:</span> <span class="s">&lt;%= Rails.application.credentials.dig(:gcs, :private_key).dump %&gt;</span>
    <span class="na">client_email</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">client_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
    <span class="na">auth_uri</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://accounts.google.com/o/oauth2/auth"</span>
    <span class="na">Token_uri</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://accounts.google.com/o/oauth2/Token"</span>
    <span class="na">auth_provider_x509_cert_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://www.googleapis.com/oauth2/v1/certs"</span>
    <span class="na">client_x509_cert_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">project</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='google:
  service: GCS
  credentials:
    type: "service_account"
    project_id: ""
    private_key_id: &lt;%= Rails.application.credentials.dig(:gcs, :private_key_id) %&gt;
    private_key: &lt;%= Rails.application.credentials.dig(:gcs, :private_key).dump %&gt;
    client_email: ""
    client_id: ""
    auth_uri: "https://accounts.google.com/o/oauth2/auth"
    Token_uri: "https://accounts.google.com/o/oauth2/Token"
    auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs"
    client_x509_cert_url: ""
  project: ""
  bucket: ""
'>Copy</button>
</div>
<p>（可選）提供快取控制元資料以在上傳的資產上設定：</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">google</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="s">...</span>
  <span class="na">cache_control</span><span class="pi">:</span> <span class="s2">"</span><span class="s">public,</span><span class="nv"> </span><span class="s">max-age=3600"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='google:
  service: GCS
  ...
  cache_control: "public, max-age=3600"
'>Copy</button>
</div>
<p>在簽署 URL 時，可以選擇使用 <a href="https://cloud.google.com/storage/docs/access-control/signed-urls#signing-iam">IAM</a> 而不是 <code>credentials</code>。如果您使用 Workload Identity 對 GKE 應用程式進行身份驗證，這將非常有用，請參閱 [這篇 Google Cloud 部落格文章](<a href="https://cloud.google.com/blog/products/containers-kubernetes/introducing-workload-identity-better-authentication">https://cloud.google.com/blog/products/containers-kubernetes/introducing-workload-identity-better-authentication</a> -for-your-gke-applications）瞭解更多資訊。</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">google</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="s">...</span>
  <span class="na">iam</span><span class="pi">:</span> <span class="no">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="google:
  service: GCS
  ...
  iam: true
">Copy</button>
</div>
<p>可以選擇在簽署 URL 時使用特定的 GSA。使用 IAM 時，將聯絡 <a href="https://cloud.google.com/compute/docs/storing-retrieving-metadata">元資料伺服器</a> 以獲取 GSA 電子郵件，但此元資料伺服器並不總是存在（例如本地測試），您可能希望使用非預設 GSA。</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">google</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="s">...</span>
  <span class="na">iam</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">gsa_email</span><span class="pi">:</span> <span class="s2">"</span><span class="s">foobar@baz.iam.gserviceaccount.com"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='google:
  service: GCS
  ...
  iam: true
  gsa_email: "foobar@baz.iam.gserviceaccount.com"
'>Copy</button>
</div>
<p>將 <a href="https://github.com/googlecloudplatform/google-cloud-Ruby/tree/master/google-cloud-storage"><code>google-cloud-storage</code></a> gem 新增到您的 <code>gemfile</code>：</p><div class="code_container">
<pre><code class="highlight plaintext">gem "google-cloud-storage", "~&gt; 1.11", require: false
</code></pre>
<button class="clipboard-button" data-clipboard-text='gem "google-cloud-storage", "~&gt; 1.11", require: false
'>Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">2.5 映象服務</a></h4><p>您可以透過定義映象服務來保持多個服務同步。一面鏡子
服務跨兩個或多個從屬服務複製上傳和刪除。</p><p>映象服務旨在在之間的遷移期間臨時使用
生產中的服務。您可以開始映象到新服務，複製
從舊服務到新服務的預先存在的檔案，然後在新服務上全力以赴
服務。</p><p>注意：映象不是原子的。上傳成功是有可能的
主要服務並在任何從屬服務上失敗。去之前
全在新服務上，驗證所有檔案都已複製。</p><p>如上所述定義要映象的每個服務。參考
定義映象服務時按名稱命名：</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">s3_west_coast</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="na">access_key_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>

<span class="na">s3_east_coast</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">S3</span>
  <span class="na">access_key_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">secret_access_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>

<span class="na">production</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">Mirror</span>
  <span class="na">primary</span><span class="pi">:</span> <span class="s">s3_east_coast</span>
  <span class="na">mirrors</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">s3_west_coast</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='s3_west_coast:
  service: S3
  access_key_id: ""
  secret_access_key: ""
  region: ""
  bucket: ""

s3_east_coast:
  service: S3
  access_key_id: ""
  secret_access_key: ""
  region: ""
  bucket: ""

production:
  service: Mirror
  primary: s3_east_coast
  mirrors:
    - s3_west_coast
'>Copy</button>
</div>
<p>儘管所有輔助服務都接收上傳，但始終會處理下載
透過主要服務。</p><p>映象服務與直接上傳相容。新檔案直接
上傳到主要服務。當直接上傳的檔案附加到
記錄，後臺作業排隊以將其複製到輔助服務。</p><h4 id=""><a class="anchorlink" href="#">2.6 公共訪問</a></h4><p>預設情況下，Active Storage 假定對服務的私有訪問。這意味著為 blob 生成簽名的、一次性使用的 url。如果您想讓 blob 可公開訪問，請在您的應用程式的“config/storage.yml”中指定“public: true”：</p><div class="code_container">
<pre><code class="highlight yaml"><span class="na">gcs</span><span class="pi">:</span> <span class="nl">&amp;gcs</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">GCS</span>
  <span class="na">project</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>

<span class="na">private_gcs</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*gcs</span>
  <span class="na">credentials</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("path/to/private_keyfile.json") %&gt;</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>

<span class="na">public_gcs</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*gcs</span>
  <span class="na">credentials</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("path/to/public_keyfile.json") %&gt;</span>
  <span class="na">bucket</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">public</span><span class="pi">:</span> <span class="no">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='gcs: &amp;gcs
  service: GCS
  project: ""

private_gcs:
  &lt;&lt;: *gcs
  credentials: &lt;%= Rails.root.join("path/to/private_keyfile.json") %&gt;
  bucket: ""

public_gcs:
  &lt;&lt;: *gcs
  credentials: &lt;%= Rails.root.join("path/to/public_keyfile.json") %&gt;
  bucket: ""
  public: true
'>Copy</button>
</div>
<p>確保您的儲存桶已正確配置為公共訪問。請參閱有關如何為 [Amazon S3] 啟用公共讀取許可權的文件（<a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/block-public-access-bucket.html%EF%BC%89%E3%80%81%5BGoogle">https://docs.aws.amazon.com/AmazonS3/latest/user-guide/block-public-access-bucket.html）、[Google</a> Cloud Storage ](<a href="https://cloud.google.com/storage/docs/access-control/making-data-public#buckets">https://cloud.google.com/storage/docs/access-control/making-data-public#buckets</a>) 和 <a href="https://docs.microsoft.com/en-us/azure%20/storage/blobs/storage-manage-access-to-resources#set-container-public-access-level-in-the-azure-portal">Microsoft Azure</a> 儲存服務。 Amazon S3 還要求您擁有 <code>s3:PutObjectAcl</code> 許可權。</p><p>將現有應用程式轉換為使用 <code>public: true</code> 時，請確保在切換之前將儲存桶中的每個檔案都更新為可公開讀取的。</p><h3 id=""><a class="anchorlink" href="#">3 將檔案附加到記錄</a></h3><h4 id="has-one-attached"><a class="anchorlink" href="#has-one-attached">3.1 <code>has_one_attached</code></a></h4><p>[<code>has_one_attached</code>][] 宏在記錄和
檔案。每條記錄可以附加一個檔案。</p><p>例如，假設您的應用程式有一個 <code>user</code> Model。如果您希望每個使用者
有一個頭像，定義 <code>user</code> Model 如下：</p><div class="code_container">
<pre><code class="highlight plaintext">class User &lt; ApplicationRecord
  has_one_attached :avatar
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ApplicationRecord
  has_one_attached :avatar
end
">Copy</button>
</div>
<p>或者，如果您使用的是 rails 6.0+，則可以像這樣執行 Model 生成器命令：</p><div class="code_container">
<pre><code class="highlight plaintext">bin/rails generate Model user avatar:attachment
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate Model user avatar:attachment
">Copy</button>
</div>
<p>您可以使用頭像建立使用者：</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">file_field</span> <span class="ss">:avatar</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= form.file_field :avatar %&gt;
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight plaintext">class signupController &lt; applicationController
  def create
    user = User.create!(user_params)
    Session[:user_id] = user.id
    redirect_to root_path
  end

  private
    def user_params
      params.require(:user).permit(:email_address, :password, :avatar)
    end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class signupController &lt; applicationController
  def create
    user = User.create!(user_params)
    Session[:user_id] = user.id
    redirect_to root_path
  end

  private
    def user_params
      params.require(:user).permit(:email_address, :password, :avatar)
    end
end
">Copy</button>
</div>
<p>呼叫 [<code>avatar.attach</code>][Attached::One#attach] 將頭像附加到現有使用者：</p><div class="code_container">
<pre><code class="highlight plaintext">user.avatar.attach(params[:avatar])
</code></pre>
<button class="clipboard-button" data-clipboard-text="user.avatar.attach(params[:avatar])
">Copy</button>
</div>
<p>呼叫 [<code>avatar.attached?</code>][Attached::One#attached?] 來確定特定使用者是否有頭像：</p><div class="code_container">
<pre><code class="highlight plaintext">user.avatar.attached?
</code></pre>
<button class="clipboard-button" data-clipboard-text="user.avatar.attached?
">Copy</button>
</div>
<p>在某些情況下，您可能希望覆蓋特定附件的預設服務。
您可以使用 <code>service</code> 選項為每個附件配置特定的服務：</p><div class="code_container">
<pre><code class="highlight plaintext">class User &lt; ApplicationRecord
  has_one_attached :avatar, service: :s3
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class User &lt; ApplicationRecord
  has_one_attached :avatar, service: :s3
end
">Copy</button>
</div>
<p>您可以透過在生成的可附加物件上呼叫 <code>variant</code> 方法來為每個附件配置特定的變體：</p><div class="code_container">
<pre><code class="highlight plaintext">class User &lt; ApplicationRecord
  has_one_attached :avatar do |attachable|
    attachable.variant :thumb, resize: "100x100"
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class User &lt; ApplicationRecord
  has_one_attached :avatar do |attachable|
    attachable.variant :thumb, resize: "100x100"
  end
end
'>Copy</button>
</div>
<p>呼叫 <code>avatar.variant(:thumb)</code> 來獲取頭像的拇指變體：</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">:thumb</span><span class="p">)</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= image_tag user.avatar.variant(:thumb) %&gt;
">Copy</button>
</div>
<p>[<code>has_one_attached</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/attached/model.html#method-i-has_one_attached">https://api.Rubyonrails.org/classes/activestorage/attached/model.html#method-i-has_one_attached</a>
[attached::one#attach]：<a href="https://api.Rubyonrails.org/classes/activestorage/attached/one.html#method-i-attach">https://api.Rubyonrails.org/classes/activestorage/attached/one.html#method-i-attach</a>
[attached::one#attached?]：<a href="https://api.Rubyonrails.org/classes/activestorage/attached/one.html#method-i-attached-3f">https://api.Rubyonrails.org/classes/activestorage/attached/one.html#method-i-attached-3f</a></p><h4 id="has-many-attached"><a class="anchorlink" href="#has-many-attached">3.2 <code>has_many_attached</code></a></h4><p>[<code>has_many_attached</code>][] 宏在記錄之間建立一對多關係
和檔案。每條記錄可以附加許多檔案。</p><p>例如，假設您的應用程式有一個 <code>message</code> @{​​17}。如果你想要每個
message 有很多圖片，定義 <code>message</code> @{​​17} 如下：</p><div class="code_container">
<pre><code class="highlight plaintext">class Message &lt; ApplicationRecord
  has_many_attached :images
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Message &lt; ApplicationRecord
  has_many_attached :images
end
">Copy</button>
</div>
<p>或者，如果您使用的是 rails 6.0+，則可以像這樣執行 Model 生成器命令：</p><div class="code_container">
<pre><code class="highlight plaintext">bin/rails generate Model message images:attachments
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate Model message images:attachments
">Copy</button>
</div>
<p>您可以建立帶有影象的訊息：</p><div class="code_container">
<pre><code class="highlight plaintext">class messagesController &lt; applicationController
  def create
    message = Message.create!(message_params)
    redirect_to message
  end

  private
    def message_params
      params.require(:message).permit(:title, :content, images: [])
    end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class messagesController &lt; applicationController
  def create
    message = Message.create!(message_params)
    redirect_to message
  end

  private
    def message_params
      params.require(:message).permit(:title, :content, images: [])
    end
end
">Copy</button>
</div>
<p>呼叫 [<code>images.attach</code>][Attached::Many#attach] 將新影象新增到現有訊息中：</p><div class="code_container">
<pre><code class="highlight plaintext">@message.images.attach(params[:images])
</code></pre>
<button class="clipboard-button" data-clipboard-text="@message.images.attach(params[:images])
">Copy</button>
</div>
<p>呼叫 [<code>images.attached?</code>][Attached::Many#attached?] 來確定特定訊息是否有任何影象：</p><div class="code_container">
<pre><code class="highlight plaintext">@message.images.attached?
</code></pre>
<button class="clipboard-button" data-clipboard-text="@message.images.attached?
">Copy</button>
</div>
<p>透過使用“service”選項，覆蓋預設服務的方式與“has_one_attached”相同：</p><div class="code_container">
<pre><code class="highlight plaintext">class Message &lt; ApplicationRecord
  has_many_attached :images, service: :s3
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Message &lt; ApplicationRecord
  has_many_attached :images, service: :s3
end
">Copy</button>
</div>
<p>配置特定變體的方式與 <code>has_one_attached</code> 相同，透過在產生的可附加物件上呼叫 <code>variant</code> 方法：</p><div class="code_container">
<pre><code class="highlight plaintext">class Message &lt; ApplicationRecord
  has_many_attached :images do |attachable|
    attachable.variant :thumb, resize: "100x100"
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Message &lt; ApplicationRecord
  has_many_attached :images do |attachable|
    attachable.variant :thumb, resize: "100x100"
  end
end
'>Copy</button>
</div>
<p>[<code>has_many_attached</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/attached/model.html#method-i-has_many_attached">https://api.Rubyonrails.org/classes/activestorage/attached/model.html#method-i-has_many_attached</a>
[attached::many#attach]：<a href="https://api.Rubyonrails.org/classes/activestorage/attached/many.html#method-i-attach">https://api.Rubyonrails.org/classes/activestorage/attached/many.html#method-i-attach</a>
[attached::many#attached?]：<a href="https://api.Rubyonrails.org/classes/activestorage/attached/many.html#method-i-attached-3f">https://api.Rubyonrails.org/classes/activestorage/attached/many.html#method-i-attached-3f</a></p><h4 id="io"><a class="anchorlink" href="#io">3.3 附加檔案/io 物件</a></h4><p>有時您需要附加一個不是透過 HTTP 請求到達的檔案。
例如，您可能希望附加在磁碟上生成或下載的檔案
來自使用者提交的 URL。您可能還想在一個資料夾中附加一個夾具檔案
Model 測試。為此，請提供至少包含一個開放 io 物件的雜湊
和一個檔名：</p><div class="code_container">
<pre><code class="highlight plaintext">@message.images.attach(io: File.open('/path/to/file'), filename: 'file.pdf')
</code></pre>
<button class="clipboard-button" data-clipboard-text="@message.images.attach(io: File.open('/path/to/file'), filename: 'file.pdf')
">Copy</button>
</div>
<p>如果可能，還提供內容型別。 Active Storage 試圖
根據資料確定檔案的內容型別。它退回到內容
如果它不能這樣做，請輸入您提供的型別。</p><div class="code_container">
<pre><code class="highlight plaintext">@message.images.attach(io: File.open('/path/to/file'), filename: 'file.pdf', content_type: 'application/pdf')
</code></pre>
<button class="clipboard-button" data-clipboard-text="@message.images.attach(io: File.open('/path/to/file'), filename: 'file.pdf', content_type: 'application/pdf')
">Copy</button>
</div>
<p>您可以透過傳入來繞過資料的內容型別推斷
<code>identify: false</code> 和 <code>content_type</code>。</p><div class="code_container">
<pre><code class="highlight plaintext">@message.images.attach(
  io: File.open('/path/to/file'),
  filename: 'file.pdf',
  content_type: 'application/pdf',
  identify: false
)
</code></pre>
<button class="clipboard-button" data-clipboard-text="@message.images.attach(
  io: File.open('/path/to/file'),
  filename: 'file.pdf',
  content_type: 'application/pdf',
  identify: false
)
">Copy</button>
</div>
<p>如果您不提供內容型別並且 Active Storage 無法確定
檔案的內容型別自動，預設為 application/octet-stream。</p><h3 id=""><a class="anchorlink" href="#">4 刪除檔案</a></h3><p>要從Model 中刪除附件，請呼叫 [<code>purge</code>][attached::one#purge]
依戀。如果您的應用程式設定為使用 Active Job，則可以完成刪除
在後臺呼叫 [<code>purge_later</code>][Attached::One#purge_later]。
清除會從儲存服務中刪除 Blob 和檔案。</p><div class="code_container">
<pre><code class="highlight plaintext"># Synchronously destroy the avatar and actual resource files.
user.avatar.purge

# destroy the associated Models and actual resource files async, via active job.
user.avatar.purge_later
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Synchronously destroy the avatar and actual resource files.
user.avatar.purge

# destroy the associated Models and actual resource files async, via active job.
user.avatar.purge_later
">Copy</button>
</div>
<p>[附加::one#purge]：<a href="https://api.Rubyonrails.org/classes/activestorage/attached/one.html#method-i-purge">https://api.Rubyonrails.org/classes/activestorage/attached/one.html#method-i-purge</a>
[attached::one#purge_later]：<a href="https://api.Rubyonrails.org/classes/activestorage/attached/one.html#method-i-purge_later">https://api.Rubyonrails.org/classes/activestorage/attached/one.html#method-i-purge_later</a></p><h3 id=""><a class="anchorlink" href="#">5 提供檔案</a></h3><p>Active Storage 支援兩種提供檔案的方式：重定向和代理。</p><p>警告：預設情況下，所有active storage Controller 都是可公開訪問的。這
生成的 URL 很難猜測，但在設計上是永久的。如果你的檔案
需要更高級別的保護考慮實施
<a href="#authenticated-Controllers">經過身份驗證的Controllers</a>。</p><h4 id=""><a class="anchorlink" href="#">5.1 重定向模式</a></h4><p>要為 blob 生成永久 URL，您可以將 blob 傳遞給
[<code>url_for</code>][actionView::routingurlfor#url_for] View helper。這會產生一個
帶有 blob [<code>signed_id</code>][ActiveStorage::Blob#signed_id] 的 URL
路由到 blob 的 [<code>redirectController</code>][<code>activestorage::blobs::redirectController</code>]</p><div class="code_container">
<pre><code class="highlight plaintext">url_for(user.avatar)
# =&gt; /rails/active_storage/blobs/:signed_id/my-avatar.png
</code></pre>
<button class="clipboard-button" data-clipboard-text="url_for(user.avatar)
# =&gt; /rails/active_storage/blobs/:signed_id/my-avatar.png
">Copy</button>
</div>
<p><code>redirectController</code> 重定向到實際的服務端點。這個
間接將服務 URL 與實際 URL 分離，並允許
例如，映象不同服務中的附件以獲得高可用性。這
重定向的 HTTP 過期時間為 5 分鐘。</p><p>要建立下載連結，請使用 <code>rails_blob_{path|url}</code> Helper。使用這個
Helper 允許您設定處置。</p><div class="code_container">
<pre><code class="highlight plaintext">rails_blob_path(user.avatar, disposition: "attachment")
</code></pre>
<button class="clipboard-button" data-clipboard-text='rails_blob_path(user.avatar, disposition: "attachment")
'>Copy</button>
</div>
<p>警告：為防止 xss 攻擊，Active Storage 強制使用 content-disposition 標頭
對某種檔案進行“附件”。要更改此行為，請參閱
<a href="configuring.html#configuring-active-storage">配置 Rails 應用程式</a> 中的可用配置選項。</p><p>如果您需要從controller/View 上下文（背景
作業、Cronjobs 等），您可以像這樣訪問 <code>rails_blob_path</code>：</p><div class="code_container">
<pre><code class="highlight plaintext">rails.application.routes.url_Helpers.rails_blob_path(user.avatar, only_path: true)
</code></pre>
<button class="clipboard-button" data-clipboard-text="rails.application.routes.url_Helpers.rails_blob_path(user.avatar, only_path: true)
">Copy</button>
</div>
<p>[actionview::routingurlfor#url_for]：<a href="https://api.Rubyonrails.org/classes/actionview/routingurlfor.html#method-i-url_for">https://api.Rubyonrails.org/classes/actionview/routingurlfor.html#method-i-url_for</a>
[activestorage::blob#signed_id]：<a href="https://api.Rubyonrails.org/classes/activestorage/blob.html#method-i-signed_id">https://api.Rubyonrails.org/classes/activestorage/blob.html#method-i-signed_id</a></p><h4 id=""><a class="anchorlink" href="#">5.2 代理模式</a></h4><p>或者，檔案可以被代理。這意味著您的應用程式伺服器將從儲存服務下載檔案資料以響應請求。這對於從 CDN 提供檔案很有用。</p><p>您可以將 Active Storage 配置為預設使用代理：</p><div class="code_container">
<pre><code class="highlight plaintext"># config/initializers/active_storage.rb
rails.application.config.active_storage.resolve_Model_to_route = :rails_storage_proxy
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/initializers/active_storage.rb
rails.application.config.active_storage.resolve_Model_to_route = :rails_storage_proxy
">Copy</button>
</div>
<p>或者，如果您想顯式代理特定附件，則可以以 <code>rails_storage_proxy_path</code> 和 <code>rails_storage_proxy_url</code> 的形式使用 url Helper。</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">rails_storage_proxy_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">)</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= image_tag rails_storage_proxy_path(@user.avatar) %&gt;
">Copy</button>
</div>
<h5 id="active-storage-cdn"><a class="anchorlink" href="#active-storage-cdn">5.2.1 在 active storage 前面放一個 cdn</a></h5><p>此外，為了將 cdn 用於 active storage 附件，您需要使用代理模式生成 url，以便它們由您的應用提供服務，並且 cdn 將快取附件而無需任何額外配置。這是開箱即用的，因為預設的 active storage 代理 Controller 設定了一個 http 標頭，指示 cdn 快取響應。</p><p>您還應該確保生成的 URL 使用 CDN 主機而不是您的應用程式主機。有多種方法可以實現這一點，但總的來說，它涉及調整您的“config/routes.rb”檔案，以便您可以為附件及其變體生成正確的 URL。例如，您可以新增以下內容：</p><div class="code_container">
<pre><code class="highlight plaintext"># config/routes.rb
direct :cdn_image do |Model, options|
  if Model.respond_to?(:signed_id)
    route_for(
      :rails_service_blob_proxy,
      Model.signed_id,
      Model.filename,
      options.merge(host: ENV['CDN_HOST'])
    )
  else
    signed_blob_id = Model.blob.signed_id
    variation_key  = Model.variation.key
    filename       = Model.blob.filename

    route_for(
      :rails_blob_representation_proxy,
      signed_blob_id,
      variation_key,
      filename,
      options.merge(host: ENV['CDN_HOST'])
    )
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/routes.rb
direct :cdn_image do |Model, options|
  if Model.respond_to?(:signed_id)
    route_for(
      :rails_service_blob_proxy,
      Model.signed_id,
      Model.filename,
      options.merge(host: ENV['CDN_HOST'])
    )
  else
    signed_blob_id = Model.blob.signed_id
    variation_key  = Model.variation.key
    filename       = Model.blob.filename

    route_for(
      :rails_blob_representation_proxy,
      signed_blob_id,
      variation_key,
      filename,
      options.merge(host: ENV['CDN_HOST'])
    )
  end
end
">Copy</button>
</div>
<p>然後生成這樣的路線：</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">cdn_image_url</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">]))</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= cdn_image_url(user.avatar.variant(resize_to_limit: [128, 128])) %&gt;
">Copy</button>
</div>
<h4 id="controllers"><a class="anchorlink" href="#controllers">5.3 已驗證 controllers</a></h4><p>預設情況下，所有active storage Controller 都是可公開訪問的。生成的
URL 使用普通的 [<code>signed_id</code>][ActiveStorage::Blob#signed_id]，這使得它們難以
猜測但永久。任何知道 blob URL 的人都可以訪問它，
即使您的“applicationController”中的“before_action”
需要登入。如果您的檔案需要更高級別的保護，您可以
實現您自己的經過身份驗證的 Controller
[<code>activestorage::blob::redirectController</code>][],
[<code>activestorage::blobs::proxyController</code>][],
[<code>activestorage::representations::redirectController</code>][] 和
[<code>activestorage::representations::proxyController</code>][]</p><p>要僅允許帳戶訪問其自己的徽標，您可以執行以下操作：</p><div class="code_container">
<pre><code class="highlight plaintext"># config/routes.rb
resource :account do
  resource :logo
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="# config/routes.rb
resource :account do
  resource :logo
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight plaintext"># app/Controllers/logos_Controller.rb
class logosController &lt; applicationController
  # through applicationController:
  # include Authenticate, SetCurrentAccount

  def show
    redirect_to Current.account.logo.url
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/Controllers/logos_Controller.rb
class logosController &lt; applicationController
  # through applicationController:
  # include Authenticate, SetCurrentAccount

  def show
    redirect_to Current.account.logo.url
  end
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">account_logo_path</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= image_tag account_logo_path %&gt;
">Copy</button>
</div>
<p>然後你可能想要禁用 Active Storage 預設路由：</p><div class="code_container">
<pre><code class="highlight plaintext">config.active_storage.draw_routes = false
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.active_storage.draw_routes = false
">Copy</button>
</div>
<p>以防止使用可公開訪問的 URL 訪問檔案。</p><p>[<code>activestorage::blobs::redirectcontroller</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/blobs/redirectcontroller.html">https://api.Rubyonrails.org/classes/activestorage/blobs/redirectcontroller.html</a>
[<code>activestorage::blobs::proxycontroller</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/blobs/proxycontroller.html">https://api.Rubyonrails.org/classes/activestorage/blobs/proxycontroller.html</a>
[<code>activestorage::representations::redirectcontroller</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/representations/redirectcontroller.html">https://api.Rubyonrails.org/classes/activestorage/representations/redirectcontroller.html</a>
[<code>activestorage::representations::proxycontroller</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/representations/proxycontroller.html">https://api.Rubyonrails.org/classes/activestorage/representations/proxycontroller.html</a></p><h3 id=""><a class="anchorlink" href="#">6 下載檔案</a></h3><p>有時您需要在上傳後處理 Blob — 例如，要轉換
將其轉換為不同的格式。使用附件的 [<code>download</code>][Blob#download] 方法讀取 blob 的
二進位制資料進入記憶體：</p><div class="code_container">
<pre><code class="highlight plaintext">binary = user.avatar.download
</code></pre>
<button class="clipboard-button" data-clipboard-text="binary = user.avatar.download
">Copy</button>
</div>
<p>您可能希望將 blob 下載到磁碟上的檔案中，以便外部程式（例如
病毒掃描程式或媒體轉碼器）可以對其進行操作。使用附件的
[<code>open</code>][Blob#open] 方法將 blob 下載到磁碟上的臨時檔案：</p><div class="code_container">
<pre><code class="highlight plaintext">message.video.open do |file|
  system '/path/to/virus/scanner', file.path
  # ...
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="message.video.open do |file|
  system '/path/to/virus/scanner', file.path
  # ...
end
">Copy</button>
</div>
<p>重要的是要知道該檔案在 <code>after_create</code> @{​​31} 中尚不可用，而僅在 <code>after_create_commit</code> 中可用。</p><p>[blob#download]：<a href="https://api.Rubyonrails.org/classes/activestorage/blob.html#method-i-download">https://api.Rubyonrails.org/classes/activestorage/blob.html#method-i-download</a>
[blob#open]：<a href="https://api.Rubyonrails.org/classes/activestorage/blob.html#method-i-open">https://api.Rubyonrails.org/classes/activestorage/blob.html#method-i-open</a></p><h3 id=""><a class="anchorlink" href="#">7 分析檔案</a></h3><p>Active Storage 在檔案上傳後透過在活動作業中排隊作業來分析檔案。分析過的檔案將在元資料雜湊中儲存附加資訊，包括“analyzed: true”。你可以透過呼叫 [<code>analyzed?</code>][] 來檢查一個 blob 是否已經被分析過。</p><p>影象分析提供了 <code>width</code> 和 <code>height</code> 屬性。影片分析提供這些，以及 <code>duration</code>、<code>angle</code>、<code>display_aspect_ratio</code> 和 <code>video</code> 和 <code>audio</code> 布林值來指示這些頻道的存在。音訊分析提供 <code>duration</code> 和 <code>bit_rate</code> 屬性。</p><p>[<code>已分析？</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/blob/analyzable.html#method-i-analyzed-3f">https://api.Rubyonrails.org/classes/activestorage/blob/analyzable.html#method-i-analyzed-3f</a></p><h3 id="pdf"><a class="anchorlink" href="#pdf">8 顯示影象、影片和 PDF</a></h3><p>Active Storage 支援表示多種檔案。你可以打電話
[<code>representation</code>][] 在附件上顯示影象變體，或
影片或 pdf 的 preView。在呼叫 <code>representation</code> 之前，檢查是否
附件可以透過呼叫 [<code>representable?</code>] 來表示。一些檔案格式
不能由 active storage 預先View 預active storage 開箱即用（例如 word 文件）；如果
<code>representable?</code> 返回 false 你可能想要 <a href="#serving-files">link to</a>
檔案代替。</p><div class="code_container">
<pre><code class="highlight erb"><span class="nt">&lt;ul&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@message</span><span class="p">.</span><span class="nf">files</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">file</span><span class="p">.</span><span class="nf">representable?</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">file</span><span class="p">.</span><span class="nf">representation</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">rails_blob_path</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="ss">disposition: </span><span class="s2">"attachment"</span><span class="p">)</span> <span class="k">do</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="s2">"placeholder.png"</span><span class="p">,</span> <span class="ss">alt: </span><span class="s2">"Download file"</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;ul&gt;
  &lt;% @message.files.each do |file| %&gt;
    &lt;li&gt;
      &lt;% if file.representable? %&gt;
        &lt;%= image_tag file.representation(resize_to_limit: [100, 100]) %&gt;
      &lt;% else %&gt;
        &lt;%= link_to rails_blob_path(file, disposition: "attachment") do %&gt;
          &lt;%= image_tag "placeholder.png", alt: "Download file" %&gt;
        &lt;% end %&gt;
      &lt;% end %&gt;
    &lt;/li&gt;
  &lt;% end %&gt;
&lt;/ul&gt;
'>Copy</button>
</div>
<p>在內部，<code>representation</code> 為影象呼叫<code>variant</code>，為影象呼叫<code>preView</code>
預View檔案。您也可以直接呼叫這些方法。</p><p>[<code>representable?</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/blob/representable.html#method-i-representable-3f">https://api.Rubyonrails.org/classes/activestorage/blob/representable.html#method-i-representable-3f</a>
[<code>representation</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/blob/representable.html#method-i-representation">https://api.Rubyonrails.org/classes/activestorage/blob/representable.html#method-i-representation</a></p><h4 id="vs"><a class="anchorlink" href="#vs">8.1 延遲載入 vs 立即載入</a></h4><p>預設情況下，Active Storage 將延遲處理表示。這段程式碼：</p><div class="code_container">
<pre><code class="highlight plaintext">image_tag file.representation(resize_to_limit: [100, 100])
</code></pre>
<button class="clipboard-button" data-clipboard-text="image_tag file.representation(resize_to_limit: [100, 100])
">Copy</button>
</div>
<p>將生成一個 <code>&lt;img&gt;</code> 標籤，其中 <code>src</code> 指向
[<code>activestorage::representations::redirectController</code>][]。瀏覽器會
向那個Controller 發出請求，它將返回一個 <code>302</code> 重定向到
遠端服務上的檔案（或在[代理模式]（#proxy-mode）下，返回檔案
內容）。延遲載入檔案允許以下功能
<a href="#public-access">單次使用 URL</a> 可以在不減慢初始頁面載入速度的情況下工作。</p><p>這適用於大多數情況。</p><p>如果你想立即為圖片生成 URL，你可以呼叫 <code>.processed.url</code>：</p><div class="code_container">
<pre><code class="highlight plaintext">image_tag file.representation(resize_to_limit: [100, 100]).processed.url
</code></pre>
<button class="clipboard-button" data-clipboard-text="image_tag file.representation(resize_to_limit: [100, 100]).processed.url
">Copy</button>
</div>
<p>Active Storage 變體跟蹤器透過儲存一個
如果之前處理過請求的表示，則在資料庫中記錄。
因此，上面的程式碼只會對遠端服務（例如 S3）進行 API 呼叫
一次，一旦儲存了一個變體，就會使用它。變體跟蹤器執行
自動，但可以透過 <code>config.active_storage.track_variants</code> 禁用。</p><p>如果您在頁面上渲染大量影象，則上述示例可能會導致
在 N+1 個查詢中載入所有變體記錄。為了避免這些 N+1 查詢，
在 [<code>ActiveStorage::Attachment</code>][] 上使用命名範圍。</p><div class="code_container">
<pre><code class="highlight plaintext">message.images.with_all_variant_records.each do |file|
  image_tag file.representation(resize_to_limit: [100, 100]).processed.url
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="message.images.with_all_variant_records.each do |file|
  image_tag file.representation(resize_to_limit: [100, 100]).processed.url
end
">Copy</button>
</div>
<p>[<code>activestorage::representations::redirectcontroller</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/representations/redirectcontroller.html">https://api.Rubyonrails.org/classes/activestorage/representations/redirectcontroller.html</a>
[<code>activestorage::attachment</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/attachment.html">https://api.Rubyonrails.org/classes/activestorage/attachment.html</a></p><h4 id=""><a class="anchorlink" href="#">8.2 轉換影象</a></h4><p>轉換影象允許您以您選擇的尺寸顯示影象。
要建立影象的變體，請在附件上呼叫 [<code>variant</code>][]。你
可以將變體處理器支援的任何轉換傳遞給方法。
當瀏覽器點選變體 url 時，Active Storage 會懶惰地轉換
將原始 blob 轉換為指定格式並重定向到其新服務
地點。</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= image_tag user.avatar.variant(resize_to_limit: [100, 100]) %&gt;
">Copy</button>
</div>
<p>如果請求變體，Active Storage 將自動應用
轉換取決於影象的格式：</p>
<ol>
<li><p>可變的內容型別（由<code>config.active_storage.variable_content_types</code>決定）
並且不考慮網路影象（如<code>config.active_storage.web_image_content_types</code>所規定），
將被轉換為 PNG。</p></li>
<li><p>如果未指定<code>quality</code>，則將使用變體處理器的格式預設質量。</p></li>
</ol>
<p>Active Storage 的預設處理器是 minimagick，但您也可以使用
[貴賓][]。要切換到 Vips，請將以下內容新增到 <code>config/application.rb</code>：</p><div class="code_container">
<pre><code class="highlight plaintext">config.active_storage.variant_processor = :vips
</code></pre>
<button class="clipboard-button" data-clipboard-text="config.active_storage.variant_processor = :vips
">Copy</button>
</div>
<p>兩個處理器不完全相容，因此在遷移現有應用程式時
使用 MiniMagick 到 Vips，如果使用格式選項，則必須進行一些更改
具體的：</p><div class="code_container">
<pre><code class="highlight rhtml"><span class="c">&lt;!-- MiniMagick --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="ss">format: :jpeg</span><span class="p">,</span> <span class="ss">sampling_factor: </span><span class="s2">"4:2:0"</span><span class="p">,</span> <span class="ss">strip: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">interlace: </span><span class="s2">"JPEG"</span><span class="p">,</span> <span class="ss">colorspace: </span><span class="s2">"sRGB"</span><span class="p">,</span> <span class="ss">quality: </span><span class="mi">80</span><span class="p">)</span> <span class="cp">%&gt;</span>

<span class="c">&lt;!-- Vips --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">user</span><span class="p">.</span><span class="nf">avatar</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="ss">format: :jpeg</span><span class="p">,</span> <span class="ss">saver: </span><span class="p">{</span> <span class="ss">subsample_mode: </span><span class="s2">"on"</span><span class="p">,</span> <span class="ss">strip: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">interlace: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">quality: </span><span class="mi">80</span> <span class="p">})</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;!-- MiniMagick --&gt;
&lt;%= image_tag user.avatar.variant(resize_to_limit: [100, 100], format: :jpeg, sampling_factor: "4:2:0", strip: true, interlace: "JPEG", colorspace: "sRGB", quality: 80) %&gt;

&lt;!-- Vips --&gt;
&lt;%= image_tag user.avatar.variant(resize_to_limit: [100, 100], format: :jpeg, saver: { subsample_mode: "on", strip: true, interlace: true, quality: 80 }) %&gt;
'>Copy</button>
</div>
<p>[<code>variant</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/blob/representable.html#method-i-variant">https://api.Rubyonrails.org/classes/activestorage/blob/representable.html#method-i-variant</a>
[vips]：<a href="https://www.Rubydoc.info/gems/Ruby-vips/vips/image">https://www.Rubydoc.info/gems/Ruby-vips/vips/image</a></p><h4 id="view"><a class="anchorlink" href="#view">8.3 預view 檔案</a></h4><p>一些非影象檔案可以預先{21}編輯：也就是說，它們可以作為影象呈現。
例如，影片檔案可以透過提取其第一幀來預{21}。在......之外
盒子，active storage 支援預View 影片和 pdf 文件。創造
一個指向延遲生成的 preView 的連結，使用附件的 [<code>preView</code>][] 方法：</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">message</span><span class="p">.</span><span class="nf">video</span><span class="p">.</span><span class="nf">preView</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= image_tag message.video.preView(resize_to_limit: [100, 100]) %&gt;
">Copy</button>
</div>
<p>要新增對其他格式的支援，請新增您自己的 preViewer。見
[<code>activestorage::preView</code>][] 文件瞭解更多資訊。</p><p>[<code>preview</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/blob/representable.html#method-i-preview">https://api.Rubyonrails.org/classes/activestorage/blob/representable.html#method-i-preview</a>
[<code>activestorage::preview</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/preview.html">https://api.Rubyonrails.org/classes/activestorage/preview.html</a></p><h3 id=""><a class="anchorlink" href="#">9 直接上傳</a></h3><p>Active Storage，自帶javascript庫，支援上傳
直接從客戶端到雲端。</p><h4 id=""><a class="anchorlink" href="#">9.1 用法</a></h4>
<ol>
<li>
<p>在應用程式的 JavaScript 包中包含 <code>activestorage.js</code>。</p>
<p>使用Asset Pipeline：</p>
<div class="code_container">
<pre><code class="highlight js"><span class="c1">//= 需要活動儲存</span>
<span class="s2">``</span>

<span class="nx">使用</span> <span class="nx">npm</span> <span class="nx">包</span><span class="err">：</span>

<span class="s2">```</span><span class="err">js
從“@rails/activestorage”匯入 * 作為 ActiveStorage
ActiveStorage.start()
</span><span class="s2">``</span><span class="err">
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="//= 需要活動儲存
``

使用 npm 包：

```js
從“@rails/activestorage”匯入 * 作為 ActiveStorage
ActiveStorage.start()
``
">Copy</button>
</div>
</li>
<li>
<p>將 <code>direct_upload: true</code> 新增到您的 <a href="form_Helpers.html#uploading-files">檔案欄位</a>：</p>
<div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">file_field</span> <span class="ss">:attachments</span><span class="p">,</span> <span class="ss">multiple: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">direct_upload: </span><span class="kp">true</span> <span class="cp">%&gt;</span>
``

或者，如果您不使用 `FormBuilder`，請直接新增 data 屬性：

```erb
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">file</span> <span class="na">data-direct-upload-url=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">rails_direct_uploads_url</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="nt">/&gt;</span>
``
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;%= form.file_field :attachments, multiple: true, direct_upload: true %&gt;
``

或者，如果您不使用 `FormBuilder`，請直接新增 data 屬性：

```erb
&lt;input type=file data-direct-upload-url="&lt;%= rails_direct_uploads_url %&gt;" /&gt;
``
'>Copy</button>
</div>
</li>
</ol>
<p>3、在第三方儲存服務上配置CORS，允許直接上傳請求。</p>
<ol>
<li>就是這樣！上傳在表單提交時開始。</li>
</ol>
<h4 id="cors"><a class="anchorlink" href="#cors">9.2 跨域資源共享（cors）配置</a></h4><p>要直接上傳到第三方服務，您需要配置該服務以允許來自您的應用的跨源請求。請參閱您的服務的 CORS 文件：</p>
<ul>
<li><a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/cors.html#how-do-i-enable-cors">S3</a></li>
<li><a href="https://cloud.google.com/storage/docs/configuring-cors">谷歌雲端儲存</a></li>
<li><a href="https://docs.microsoft.com/en-us/rest/api/storageservices/cross-origin-resource-sharing--cors--support-for-the-azure-storage-services">Azure 儲存</a></li>
</ul>
<p>注意允許：</p>
<ul>
<li>訪問您的應用程式的所有來源</li>
<li>
<code>PUT</code> 請求方法</li>
<li>以下標題：
*<code>起源</code>
*<code>內容型別</code>
*<code>內容MD5</code>

<ul>
<li>
<code>Content-Disposition</code>（Azure 儲存除外）</li>
<li>
<code>x-ms-blob-content-disposition</code>（僅適用於 Azure 儲存）</li>
<li>
<code>x-ms-blob-type</code>（僅適用於 Azure 儲存）</li>
<li>
<code>Cache-Control</code>（對於 GCS，僅當設定了 <code>cache_control</code> 時）</li>
</ul>
</li>
</ul>
<p>磁碟服務不需要 CORS 配置，因為它共享您的應用程式的來源。</p><h5 id="s3-cors"><a class="anchorlink" href="#s3-cors">9.2.1 示例：s3 cors 配置</a></h5><div class="code_container">
<pre><code class="highlight json"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"AllowedHeaders"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"*"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"AllowedMethods"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"PUT"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"AllowedOrigins"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"https://www.example.com"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"ExposeHeaders"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"Origin"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Content-Type"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Content-MD5"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"Content-Disposition"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"MaxAgeSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<button class="clipboard-button" data-clipboard-text='[
  {
    "AllowedHeaders": [
      "*"
    ],
    "AllowedMethods": [
      "PUT"
    ],
    "AllowedOrigins": [
      "https://www.example.com"
    ],
    "ExposeHeaders": [
      "Origin",
      "Content-Type",
      "Content-MD5",
      "Content-Disposition"
    ],
    "MaxAgeSeconds": 3600
  }
]
'>Copy</button>
</div>
<h5 id="cors"><a class="anchorlink" href="#cors">9.2.2 例子：谷歌雲端儲存cors配置</a></h5><div class="code_container">
<pre><code class="highlight json"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"origin"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"https://www.example.com"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"PUT"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"responseHeader"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Origin"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Content-Type"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Content-MD5"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Content-Disposition"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"maxAgeSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<button class="clipboard-button" data-clipboard-text='[
  {
    "origin": ["https://www.example.com"],
    "method": ["PUT"],
    "responseHeader": ["Origin", "Content-Type", "Content-MD5", "Content-Disposition"],
    "maxAgeSeconds": 3600
  }
]
'>Copy</button>
</div>
<h5 id="azure-cors"><a class="anchorlink" href="#azure-cors">9.2.3 示例：azure 儲存 cors 配置</a></h5><div class="code_container">
<pre><code class="highlight xml"><span class="nt">&lt;Cors&gt;</span>
  <span class="nt">&lt;CorsRule&gt;</span>
    <span class="nt">&lt;AllowedOrigins&gt;</span>https://www.example.com<span class="nt">&lt;/AllowedOrigins&gt;</span>
    <span class="nt">&lt;AllowedMethods&gt;</span>PUT<span class="nt">&lt;/AllowedMethods&gt;</span>
    <span class="nt">&lt;AllowedHeaders&gt;</span>Origin, Content-Type, Content-MD5, x-ms-blob-content-disposition, x-ms-blob-type<span class="nt">&lt;/AllowedHeaders&gt;</span>
    <span class="nt">&lt;MaxAgeInSeconds&gt;</span>3600<span class="nt">&lt;/MaxAgeInSeconds&gt;</span>
  <span class="nt">&lt;/CorsRule&gt;</span>
<span class="nt">&lt;/Cors&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;Cors&gt;
  &lt;CorsRule&gt;
    &lt;AllowedOrigins&gt;https://www.example.com&lt;/AllowedOrigins&gt;
    &lt;AllowedMethods&gt;PUT&lt;/AllowedMethods&gt;
    &lt;AllowedHeaders&gt;Origin, Content-Type, Content-MD5, x-ms-blob-content-disposition, x-ms-blob-type&lt;/AllowedHeaders&gt;
    &lt;MaxAgeInSeconds&gt;3600&lt;/MaxAgeInSeconds&gt;
  &lt;/CorsRule&gt;
&lt;/Cors&gt;
">Copy</button>
</div>
<h4 id="javascript"><a class="anchorlink" href="#javascript">9.3 直接上傳javascript事件</a></h4>
<table>
<thead>
<tr>
<th>活動名稱</th>
<th>活動目標</th>
<th>事件資料 (<code>event.detail</code>)</th>
<th>說明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>直接上傳：開始</code></td>
<td><code>&lt;表單&gt;</code></td>
<td>無</td>
<td>已提交包含用於直接上傳欄位的檔案的表單。</td>
</tr>
<tr>
<td><code>直接上傳：初始化</code></td>
<td><code>&lt;輸入&gt;</code></td>
<td><code>{id，檔案}</code></td>
<td>提交表單後為每個檔案分派。</td>
</tr>
<tr>
<td><code>直接上傳：開始</code></td>
<td><code>&lt;輸入&gt;</code></td>
<td><code>{id，檔案}</code></td>
<td>開始直接上傳。</td>
</tr>
<tr>
<td><code>直接上傳：之前-blob-請求</code></td>
<td><code>&lt;輸入&gt;</code></td>
<td><code>{id，檔案，xhr}</code></td>
<td>在向您的應用程式請求直接上傳元資料之前。</td>
</tr>
<tr>
<td><code>直接上傳：儲存前請求</code></td>
<td><code>&lt;輸入&gt;</code></td>
<td><code>{id，檔案，xhr}</code></td>
<td>在請求儲存檔案之前。</td>
</tr>
<tr>
<td><code>直接上傳：進度</code></td>
<td><code>&lt;輸入&gt;</code></td>
<td><code>{id，檔案，進度}</code></td>
<td>隨著儲存檔案請求的進展。</td>
</tr>
<tr>
<td><code>直接上傳：錯誤</code></td>
<td><code>&lt;輸入&gt;</code></td>
<td><code>{id，檔案，錯誤}</code></td>
<td>發生錯誤。除非取消此事件，否則將顯示“警報”。</td>
</tr>
<tr>
<td><code>直接上傳：結束</code></td>
<td><code>&lt;輸入&gt;</code></td>
<td><code>{id，檔案}</code></td>
<td>直接上傳已結束。</td>
</tr>
<tr>
<td><code>直接上傳：結束</code></td>
<td><code>&lt;表單&gt;</code></td>
<td>無</td>
<td>所有直接上傳已結束。</td>
</tr>
</tbody>
</table>
<h4 id=""><a class="anchorlink" href="#">9.4 示例</a></h4><p>您可以使用這些事件來顯示上傳進度。</p><p><img src="https://user-images.githubusercontent.com/5355/28694528-16e69d0c-72f8-11e7-91a7-c0b8cfc90391.gif" alt="直接上傳"></p><p>以表格形式顯示上傳的檔案：</p><div class="code_container">
<pre><code class="highlight js"><span class="c1">// direct_uploads.js</span>

<span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload:initialize</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">detail</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">file</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">detail</span>
  <span class="nx">target</span><span class="p">.</span><span class="nx">insertAdjacentHTML</span><span class="p">(</span><span class="dl">"</span><span class="s2">beforebegin</span><span class="dl">"</span><span class="p">,</span> <span class="s2">`</span><span class="err">
    &lt;div id="direct-upload-</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="err">" class="direct-upload direct-upload--pending"&gt;
      &lt;div id="direct-upload-progress-</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="err">" class="direct-upload__progress" style="width: 0%"&gt;&lt;/div&gt;
      &lt;span class="direct-upload__filename"&gt;&lt;/span&gt;
    &lt;/div&gt;
  </span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">target</span><span class="p">.</span><span class="nx">previousElementSibling</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">`</span><span class="err">.direct-upload__filename</span><span class="s2">`</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span>
<span class="p">})</span>

<span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload:start</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span>
  <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">`</span><span class="err">direct-upload-</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload--pending</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload:progress</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">progress</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span>
  <span class="kd">const</span> <span class="nx">progressElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">`</span><span class="err">direct-upload-progress-</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">progressElement</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">progress</span><span class="p">}</span><span class="err">%</span><span class="s2">`</span>
<span class="p">})</span>

<span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload:error</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">error</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span>
  <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">`</span><span class="err">direct-upload-</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload--error</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload:end</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span>
  <span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">`</span><span class="err">direct-upload-</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  <span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">direct-upload--complete</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='// direct_uploads.js

addEventListener("direct-upload:initialize", event =&gt; {
  const { target, detail } = event
  const { id, file } = detail
  target.insertAdjacentHTML("beforebegin", `
    &lt;div id="direct-upload-${id}" class="direct-upload direct-upload--pending"&gt;
      &lt;div id="direct-upload-progress-${id}" class="direct-upload__progress" style="width: 0%"&gt;&lt;/div&gt;
      &lt;span class="direct-upload__filename"&gt;&lt;/span&gt;
    &lt;/div&gt;
  `)
  target.previousElementSibling.querySelector(`.direct-upload__filename`).textContent = file.name
})

addEventListener("direct-upload:start", event =&gt; {
  const { id } = event.detail
  const element = document.getElementById(`direct-upload-${id}`)
  element.classList.remove("direct-upload--pending")
})

addEventListener("direct-upload:progress", event =&gt; {
  const { id, progress } = event.detail
  const progressElement = document.getElementById(`direct-upload-progress-${id}`)
  progressElement.style.width = `${progress}%`
})

addEventListener("direct-upload:error", event =&gt; {
  event.preventDefault()
  const { id, error } = event.detail
  const element = document.getElementById(`direct-upload-${id}`)
  element.classList.add("direct-upload--error")
  element.setAttribute("title", error)
})

addEventListener("direct-upload:end", event =&gt; {
  const { id } = event.detail
  const element = document.getElementById(`direct-upload-${id}`)
  element.classList.add("direct-upload--complete")
})
'>Copy</button>
</div>
<p>新增樣式：</p><div class="code_container">
<pre><code class="highlight css"><span class="c">/* direct_uploads.css */</span>

<span class="nc">.direct-upload</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="n">inline-block</span><span class="p">;</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">relative</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">2px</span> <span class="m">4px</span><span class="p">;</span>
  <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span> <span class="m">3px</span> <span class="m">3px</span> <span class="m">0</span><span class="p">;</span>
  <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="n">rgba</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0.3</span><span class="p">);</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">3px</span><span class="p">;</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">11px</span><span class="p">;</span>
  <span class="nl">line-height</span><span class="p">:</span> <span class="m">13px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.direct-upload--pending</span> <span class="p">{</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.6</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.direct-upload__progress</span> <span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
  <span class="nl">top</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="nl">left</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="nl">bottom</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.2</span><span class="p">;</span>
  <span class="nl">background</span><span class="p">:</span> <span class="m">#0076ff</span><span class="p">;</span>
  <span class="nl">transition</span><span class="p">:</span> <span class="n">width</span> <span class="m">120ms</span> <span class="n">ease-out</span><span class="p">,</span> <span class="n">opacity</span> <span class="m">60ms</span> <span class="m">60ms</span> <span class="n">ease-in</span><span class="p">;</span>
  <span class="nl">transform</span><span class="p">:</span> <span class="n">translate3d</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="nc">.direct-upload--complete</span> <span class="nc">.direct-upload__progress</span> <span class="p">{</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.4</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.direct-upload--error</span> <span class="p">{</span>
  <span class="nl">border-color</span><span class="p">:</span> <span class="no">red</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="nt">file</span><span class="o">][</span><span class="nt">data-direct-upload-url</span><span class="o">][</span><span class="nt">disabled</span><span class="o">]</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="/* direct_uploads.css */

.direct-upload {
  display: inline-block;
  position: relative;
  padding: 2px 4px;
  margin: 0 3px 3px 0;
  border: 1px solid rgba(0, 0, 0, 0.3);
  border-radius: 3px;
  font-size: 11px;
  line-height: 13px;
}

.direct-upload--pending {
  opacity: 0.6;
}

.direct-upload__progress {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  opacity: 0.2;
  background: #0076ff;
  transition: width 120ms ease-out, opacity 60ms 60ms ease-in;
  transform: translate3d(0, 0, 0);
}

.direct-upload--complete .direct-upload__progress {
  opacity: 0.4;
}

.direct-upload--error {
  border-color: red;
}

input[type=file][data-direct-upload-url][disabled] {
  display: none;
}
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">9.5 與庫或框架整合</a></h4><p>如果您想使用 JavaScript 框架中的直接上傳功能，或者
您想整合自定義拖放解決方案，您可以使用
用於此目的的“DirectUpload”類。從您的圖書館收到檔案後
選擇例項化 DirectUpload 並呼叫其 create 方法。建立鏡頭
上傳完成時呼叫的Callback。</p><div class="code_container">
<pre><code class="highlight js"><span class="k">import</span> <span class="p">{</span> <span class="nx">DirectUpload</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rails/activestorage</span><span class="dl">"</span>

<span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">input[type=file]</span><span class="dl">'</span><span class="p">)</span>

<span class="c1">// Bind to file drop - use the ondrop on a parent element or use a</span>
<span class="c1">//  library like Dropzone</span>
<span class="kd">const</span> <span class="nx">onDrop</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
  <span class="kd">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">;</span>
  <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">files</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">file</span> <span class="o">=&gt;</span> <span class="nx">uploadFile</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// Bind to normal file selection</span>
<span class="nx">input</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">files</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">file</span> <span class="o">=&gt;</span> <span class="nx">uploadFile</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span>
  <span class="c1">// you might clear the selected files from the input</span>
  <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span>
<span class="p">})</span>

<span class="kd">const</span> <span class="nx">uploadFile</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// your form needs the file_field direct_upload: true, which</span>
  <span class="c1">//  provides data-direct-upload-url</span>
  <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">directUploadUrl</span>
  <span class="kd">const</span> <span class="nx">upload</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DirectUpload</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span>

  <span class="nx">upload</span><span class="p">.</span><span class="nx">create</span><span class="p">((</span><span class="nx">error</span><span class="p">,</span> <span class="nx">blob</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Handle the error</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Add an appropriately-named hidden input to the form with a</span>
      <span class="c1">//  value of blob.signed_id so that the blob ids will be</span>
      <span class="c1">//  transmitted in the normal upload flow</span>
      <span class="kd">const</span> <span class="nx">hiddenField</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">input</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">hiddenField</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">hiddenField</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">value</span><span class="dl">"</span><span class="p">,</span> <span class="nx">blob</span><span class="p">.</span><span class="nx">signed_id</span><span class="p">);</span>
      <span class="nx">hiddenField</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">name</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">form</span><span class="dl">'</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">hiddenField</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="import { DirectUpload } from &quot;@rails/activestorage&quot;

const input = document.querySelector('input[type=file]')

// Bind to file drop - use the ondrop on a parent element or use a
//  library like Dropzone
const onDrop = (event) =&gt; {
  event.preventDefault()
  const files = event.dataTransfer.files;
  Array.from(files).forEach(file =&gt; uploadFile(file))
}

// Bind to normal file selection
input.addEventListener('change', (event) =&gt; {
  Array.from(input.files).forEach(file =&gt; uploadFile(file))
  // you might clear the selected files from the input
  input.value = null
})

const uploadFile = (file) =&gt; {
  // your form needs the file_field direct_upload: true, which
  //  provides data-direct-upload-url
  const url = input.dataset.directUploadUrl
  const upload = new DirectUpload(file, url)

  upload.create((error, blob) =&gt; {
    if (error) {
      // Handle the error
    } else {
      // Add an appropriately-named hidden input to the form with a
      //  value of blob.signed_id so that the blob ids will be
      //  transmitted in the normal upload flow
      const hiddenField = document.createElement('input')
      hiddenField.setAttribute(&quot;type&quot;, &quot;hidden&quot;);
      hiddenField.setAttribute(&quot;value&quot;, blob.signed_id);
      hiddenField.name = input.name
      document.querySelector('form').appendChild(hiddenField)
    }
  })
}
">Copy</button>
</div>
<p>如果需要跟蹤檔案上傳的進度，可以透過第三個
<code>DirectUpload</code> 建構函式的引數。在上傳過程中，DirectUpload
將呼叫物件的 <code>directUploadWillStoreFileWithXHR</code> 方法。然後你可以
在 XHR 上繫結您自己的進度處理程式。</p><div class="code_container">
<pre><code class="highlight js"><span class="k">import</span> <span class="p">{</span> <span class="nx">DirectUpload</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rails/activestorage</span><span class="dl">"</span>

<span class="kd">class</span> <span class="nx">Uploader</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">upload</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DirectUpload</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">file</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">upload</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">upload</span><span class="p">.</span><span class="nx">create</span><span class="p">((</span><span class="nx">error</span><span class="p">,</span> <span class="nx">blob</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Handle the error</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Add an appropriately-named hidden input to the form</span>
        <span class="c1">// with a value of blob.signed_id</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">directUploadWillStoreFileWithXHR</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">upload</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">progress</span><span class="dl">"</span><span class="p">,</span>
      <span class="nx">event</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">directUploadDidProgress</span><span class="p">(</span><span class="nx">event</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="nx">directUploadDidProgress</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Use event.loaded and event.total to update the progress bar</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='import { DirectUpload } from "@rails/activestorage"

class Uploader {
  constructor(file, url) {
    this.upload = new DirectUpload(this.file, this.url, this)
  }

  upload(file) {
    this.upload.create((error, blob) =&gt; {
      if (error) {
        // Handle the error
      } else {
        // Add an appropriately-named hidden input to the form
        // with a value of blob.signed_id
      }
    })
  }

  directUploadWillStoreFileWithXHR(request) {
    request.upload.addEventListener("progress",
      event =&gt; this.directUploadDidProgress(event))
  }

  directUploadDidProgress(event) {
    // Use event.loaded and event.total to update the progress bar
  }
}
'>Copy</button>
</div>
<p>注意：使用 <a href="#direct-uploads">直接上傳</a> 有時會導致檔案上傳，但永遠不會附加到記錄。考慮<a href="#purging-unattached-uploads">清除未附加的上傳</a>。</p><h3 id=""><a class="anchorlink" href="#">10 測試</a></h3><p>使用 [<code>fixture_file_upload</code>][] 在整合或Controller 測試中測試上傳檔案。
Rails 像處理任何其他引數一樣處理檔案。</p><div class="code_container">
<pre><code class="highlight plaintext">class signupController &lt; actiondispatch::integrationtest
  test "can sign up" do
    post signup_path, params: {
      name: "David",
      avatar: fixture_file_upload("david.png", "image/png")
    }

    user = User.order(:created_at).last
    assert user.avatar.attached?
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class signupController &lt; actiondispatch::integrationtest
  test "can sign up" do
    post signup_path, params: {
      name: "David",
      avatar: fixture_file_upload("david.png", "image/png")
    }

    user = User.order(:created_at).last
    assert user.avatar.attached?
  end
end
'>Copy</button>
</div>
<p>[<code>fixture_file_upload</code>]：<a href="https://api.Rubyonrails.org/classes/actiondispatch/testprocess/fixturefile.html">https://api.Rubyonrails.org/classes/actiondispatch/testprocess/fixturefile.html</a></p><h4 id=""><a class="anchorlink" href="#">10.1 丟棄測試期間建立的檔案</a></h4><h5 id=""><a class="anchorlink" href="#">10.1.1 系統測試</a></h5><p>系統測試透過回滾 transAction 來清理測試資料。因為<code>破壞</code>
永遠不會在物件上呼叫，附加的檔案永遠不會被清除。如果你
想要清除檔案，您可以在 <code>after_teardown</code> Callback 中完成。正在做
此處可確保測試期間建立的所有連線均完整且
您不會收到來自Active Storage 的錯誤訊息，說它找不到檔案。</p><div class="code_container">
<pre><code class="highlight plaintext">class applicationsystemtestcase &lt; Actiondispatch::systemtestcase
  # ...
  def after_teardown
    super
    FileUtils.rm_rf(ActiveStorage::Blob.service.root)
  end
  # ...
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class applicationsystemtestcase &lt; Actiondispatch::systemtestcase
  # ...
  def after_teardown
    super
    FileUtils.rm_rf(ActiveStorage::Blob.service.root)
  end
  # ...
end
">Copy</button>
</div>
<p>如果你使用 [parallel tests][] 和 <code>DiskService</code>，你應該配置每個程序使用它自己的
active storage 的資料夾。這樣，<code>teardown</code>Callback 只會從相關程序中刪除檔案'
測試。</p><div class="code_container">
<pre><code class="highlight plaintext">class applicationsystemtestcase &lt; Actiondispatch::systemtestcase
  # ...
  parallelize_setup do |i|
    ActiveStorage::Blob.service.root = "#{ActiveStorage::Blob.service.root}-#{i}"
  end
  # ...
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class applicationsystemtestcase &lt; Actiondispatch::systemtestcase
  # ...
  parallelize_setup do |i|
    ActiveStorage::Blob.service.root = "#{ActiveStorage::Blob.service.root}-#{i}"
  end
  # ...
end
'>Copy</button>
</div>
<p>如果您的系統測試驗證刪除了帶有附件的 Model 並且您
使用 Active Job，將您的測試環境設定為使用內聯佇列介面卡，以便
清除作業立即執行，而不是在未來的未知時間執行。</p><div class="code_container">
<pre><code class="highlight plaintext"># Use inline job processing to make things happen immediately
config.active_job.queue_adapter = :inline
</code></pre>
<button class="clipboard-button" data-clipboard-text="# Use inline job processing to make things happen immediately
config.active_job.queue_adapter = :inline
">Copy</button>
</div>
<p>[並行測試]：<a href="https://guides.Rubyonrails.org/testing.html#parallel-testing">https://guides.Rubyonrails.org/testing.html#parallel-testing</a></p><h5 id=""><a class="anchorlink" href="#">10.1.2 整合測試</a></h5><p>與系統測試類似，整合測試期間上傳的檔案不會被
自動清理。如果要清除檔案，可以在
<code>拆解</code>Callback。</p><div class="code_container">
<pre><code class="highlight plaintext">class Actiondispatch::integrationtest
  def after_teardown
    super
    FileUtils.rm_rf(ActiveStorage::Blob.service.root)
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Actiondispatch::integrationtest
  def after_teardown
    super
    FileUtils.rm_rf(ActiveStorage::Blob.service.root)
  end
end
">Copy</button>
</div>
<p>如果您使用 [parallel tests][] 和 Disk 服務，您應該將每個程序配置為使用自己的
active storage 的資料夾。這樣，<code>teardown</code>Callback 只會從相關程序中刪除檔案'
測試。</p><div class="code_container">
<pre><code class="highlight plaintext">class Actiondispatch::integrationtest
  parallelize_setup do |i|
    ActiveStorage::Blob.service.root = "#{ActiveStorage::Blob.service.root}-#{i}"
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Actiondispatch::integrationtest
  parallelize_setup do |i|
    ActiveStorage::Blob.service.root = "#{ActiveStorage::Blob.service.root}-#{i}"
  end
end
'>Copy</button>
</div>
<p>[並行測試]：<a href="https://guides.Rubyonrails.org/testing.html#parallel-testing">https://guides.Rubyonrails.org/testing.html#parallel-testing</a></p><h4 id=""><a class="anchorlink" href="#">10.2 為燈具新增附件</a></h4><p>您可以將附件新增到現有的 [裝置][]。首先，您需要建立一個單獨的儲存服務：</p><div class="code_container">
<pre><code class="highlight yml"><span class="c1"># config/storage.yml</span>

<span class="na">test_fixtures</span><span class="pi">:</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">Disk</span>
  <span class="na">root</span><span class="pi">:</span> <span class="s">&lt;%= Rails.root.join("tmp/storage_fixtures") %&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# config/storage.yml

test_fixtures:
  service: Disk
  root: &lt;%= Rails.root.join("tmp/storage_fixtures") %&gt;
'>Copy</button>
</div>
<p>這告訴Active Storage 將夾具檔案“上傳”到哪裡，所以它應該是一個臨時目錄。透過製作
與常規<code>test</code>服務不同的目錄，您可以將夾具檔案與在測試期間上傳的檔案分開
測試。</p><p>接下來，為Active Storage 類建立夾具檔案：</p><div class="code_container">
<pre><code class="highlight yml"><span class="c1"># active_storage/attachments.yml</span>
<span class="na">david_avatar</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">avatar</span>
  <span class="na">record</span><span class="pi">:</span> <span class="s">david (User)</span>
  <span class="na">blob</span><span class="pi">:</span> <span class="s">david_avatar_blob</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# active_storage/attachments.yml
david_avatar:
  name: avatar
  record: david (User)
  blob: david_avatar_blob
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight yml"><span class="c1"># active_storage/blobs.yml</span>
<span class="na">david_avatar_blob</span><span class="pi">:</span> <span class="s">&lt;%= ActiveStorage::FixtureSet.blob filename</span><span class="pi">:</span> <span class="s2">"</span><span class="s">david.png"</span><span class="err">,</span> <span class="na">service_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_fixtures"</span> <span class="err">%</span><span class="pi">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# active_storage/blobs.yml
david_avatar_blob: &lt;%= ActiveStorage::FixtureSet.blob filename: "david.png", service_name: "test_fixtures" %&gt;
'>Copy</button>
</div>
<p>然後在你的fixtures目錄（預設路徑是<code>test/fixtures/files</code>）中放置一個檔案，並帶有相應的檔名。
檢視 [<code>ActiveStorage::FixtureSet</code>][] 文件瞭解更多資訊。</p><p>設定完所有內容後，您將能夠訪問測試中的附件：</p><div class="code_container">
<pre><code class="highlight plaintext">class UserTest &lt; ActiveSupport::TestCase
  def test_avatar
    avatar = users(:david).avatar

    assert avatar.attached?
    assert_not_nil avatar.download
    assert_equal 1000, avatar.byte_size
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class UserTest &lt; ActiveSupport::TestCase
  def test_avatar
    avatar = users(:david).avatar

    assert avatar.attached?
    assert_not_nil avatar.download
    assert_equal 1000, avatar.byte_size
  end
end
">Copy</button>
</div>
<h5 id=""><a class="anchorlink" href="#">10.2.1 清理固定裝置</a></h5><p>雖然在測試中上傳的檔案被清理<a href="#discarding-files-created-during-tests">在每個測試結束時</a>，
你只需要清理一次fixture檔案：當你所有的測試完成時。</p><p>如果您使用並行測試，請呼叫“parallelize_teardown”：</p><div class="code_container">
<pre><code class="highlight plaintext">class ActiveSupport::TestCase
  # ...
  parallelize_teardown do |i|
    FileUtils.rm_rf(ActiveStorage::Blob.services.fetch(:test_fixtures).root)
  end
  # ...
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="class ActiveSupport::TestCase
  # ...
  parallelize_teardown do |i|
    FileUtils.rm_rf(ActiveStorage::Blob.services.fetch(:test_fixtures).root)
  end
  # ...
end
">Copy</button>
</div>
<p>如果您沒有執行並行測試，請使用 <code>Minitest.after_run</code> 或等效的測試
框架（例如 RSpec 的 <code>after(:suite)</code>）：</p><div class="code_container">
<pre><code class="highlight plaintext"># test_Helper.rb

Minitest.after_run do
  FileUtils.rm_rf(ActiveStorage::Blob.services.fetch(:test_fixtures).root)
end
</code></pre>
<button class="clipboard-button" data-clipboard-text="# test_Helper.rb

Minitest.after_run do
  FileUtils.rm_rf(ActiveStorage::Blob.services.fetch(:test_fixtures).root)
end
">Copy</button>
</div>
<p>[夾具]：<a href="https://guides.Rubyonrails.org/testing.html#the-low-down-on-fixtures">https://guides.Rubyonrails.org/testing.html#the-low-down-on-fixtures</a>
[<code>activestorage::fixtureset</code>]：<a href="https://api.Rubyonrails.org/classes/activestorage/fixtureset.html">https://api.Rubyonrails.org/classes/activestorage/fixtureset.html</a></p><h3 id=""><a class="anchorlink" href="#">11 實施對其他雲服務的支援</a></h3><p>如果您需要支援除這些之外的雲服務，您將需要
實施服務。每項服務延伸
<a href="https://api.Rubyonrails.org/classes/activestorage/service.html"><code>activestorage::service</code></a>
透過實施將檔案上傳和下載到雲所需的方法。</p><h3 id=""><a class="anchorlink" href="#">12 清除未附加的上傳</a></h3><p>在某些情況下，檔案已上傳但從未附加到記錄。使用 <a href="#direct-uploads">直接上傳</a> 時可能會發生這種情況。您可以使用 <a href="https://github.com/rails/rails/blob/8ef5bd9ced351162b673904a0b77c7034ca2bc20/activestorage/app/Models/active_storage/blob.rbl">unattached scope</a> 查詢未附加的記錄。下面是一個使用 <a href="command_line.html#custom-rake-tasks">自定義 rake 任務</a> 的示例。</p><div class="code_container">
<pre><code class="highlight plaintext">namespace :active_storage do
  desc "purges unattached Active Storage blobs. run regularly."
  task purge_unattached: :environment do
    ActiveStorage::Blob.unattached.where("active_storage_blobs.created_at &lt;= ?", 2.days.ago).find_each(&amp;:purge_later)
  end
end
</code></pre>
<button class="clipboard-button" data-clipboard-text='namespace :active_storage do
  desc "purges unattached Active Storage blobs. run regularly."
  task purge_unattached: :environment do
    ActiveStorage::Blob.unattached.where("active_storage_blobs.created_at &lt;= ?", 2.days.ago).find_each(&amp;:purge_later)
  end
end
'>Copy</button>
</div>
<p>警告：<code>ActiveStorage::Blob.unattached</code> 生成的查詢可能很慢，並且可能會對具有較大資料庫的應用程式造成破壞。</p>

        <h3>反饋</h3>
        <p>
          我們鼓勵您幫助提高本指南的質量。
        </p>
        <p>
          如果您發現任何拼寫錯誤或事實錯誤，請貢獻。
          首先，您可以閱讀我們的 <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">文檔貢獻</a> 部分。
        </p>
        <p>
          您還可能會發現不完整的內容或不是最新的內容。
          請務必為 main 添加任何缺失的文檔。確保檢查
          <a href="https://edgeguides.rubyonrails.org">Edge Guides</a> 先驗證
          如果問題已經在主分支上解決。
          檢查 <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南指南</a>
          風格和慣例。
        </p>
        <p>
          如果由於某種原因您發現需要修復但無法自行修補的內容，請
          <a href="https://github.com/rails/rails/issues">open an issue</a>。
        </p>
        <p>最後但並非最不重要的是，關於 Ruby on Rails 的任何討論
          <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">rubyonrails-docs 郵件列表</a> 上的文檔非常受歡迎。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>本作品已獲得<a href="https://creativecommons.org/licenses/by-sa/4.0/">知識共享署名-相同方式共享 4.0 國際</a>許可</p>
<p>“Rails”、“Ruby on Rails”和 Rails 標誌是 David Heinemeier Hansson 的商標。 保留所有權利。</p>
    </div>
  </div>
</body>
</html>
