<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rails 初始化過程 — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Rails 初始化過程 — Ruby on Rails Guides" />
  <meta name="description" content="Rails 初始化過程本指南解釋了 Rails 中初始化過程的內部結構。 這是一份非常深入的指南，推薦給高階 Rails 開發人員。閱讀本指南後，您將瞭解： 如何使用 bin/rails server。 Rails&#39;初始化序列的時間線。 啟動順序需要不同的檔案。 Rails::Server 介面是如何定義和使用的。" />
  <meta property="og:description" content="Rails 初始化過程本指南解釋了 Rails 中初始化過程的內部結構。 這是一份非常深入的指南，推薦給高階 Rails 開發人員。閱讀本指南後，您將瞭解： 如何使用 bin/rails server。 Rails&#39;初始化序列的時間線。 啟動順序需要不同的檔案。 Rails::Server 介面是如何定義和使用的。" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.0</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多資訊請前往 <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        更多在 Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">部落格</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">指南</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">論壇</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">在 GitHub 上做出貢獻</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="返回首頁">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">首頁</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">手冊目錄</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>從這裡開始</dt>
                  <dd><a href="getting_started.html">Rails 入門</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record 基礎</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record 遷移 (Migrations)</a></dd>
                  <dd><a href="active_record_validations.html">Active Record 驗證 (Validations)</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record 回呼 (Callbacks)</a></dd>
                  <dd><a href="association_basics.html">Active Record 關聯 (Associations)</a></dd>
                  <dd><a href="active_record_querying.html">Active Record 查詢介面</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="layouts_and_rendering.html">Rails 中的版面配置(Layouts)和算繪(Rendering)</a></dd>
                  <dd><a href="form_helpers.html">Action View 表單 Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller 概述</a></dd>
                  <dd><a href="routing.html">Rails 從外到內路由</a></dd>
                </div>
                <div class="guides-section">
                  <dt>其他元件</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support 核心擴充套件</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer 基礎知識</a></dd>
                  <dd><a href="active_job_basics.html">Active Job 基礎</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage 概述</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable 概述</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>深入研究</dt>
                  <dd><a href="i18n.html">Rails 國際化 (I18n) API</a></dd>
                  <dd><a href="testing.html">測試 Rails 應用程式</a></dd>
                  <dd><a href="security.html">保護 Rails 應用程式</a></dd>
                  <dd><a href="debugging_rails_applications.html">除錯 Rails 應用程式</a></dd>
                  <dd><a href="configuring.html">設定 Rails 應用程式</a></dd>
                  <dd><a href="command_line.html">Rails 命令列</a></dd>
                  <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">自動載入和重新載入常量</a></dd>
                  <dd><a href="caching_with_rails.html">使用 Rails 快取</a></dd>
                  <dd><a href="api_app.html">將 Rails 用於僅 API 的應用程式</a></dd>
                </div>
                <div class="guides-section">
                  <dt>擴充 rails</dt>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">建立和自定義 Rails 產生器和模板</a></dd>
                </div>
                <div class="guides-section">
                  <dt>貢獻</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API 文件指南</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">指南指南</a></dd>
                </div>
                <div class="guides-section">
                  <dt>政策</dt>
                  <dd><a href="maintenance_policy.html">維修政策</a></dd>
                </div>
                <div class="guides-section">
                  <dt>發行說明</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</a></dd>
                  <dd><a href="6_1_release_notes.html">6.1 版 - 2020 年 12 月</a></dd>
                  <dd><a href="6_0_release_notes.html">6.0 版 - 2019 年 8 月</a></dd>
                  <dd><a href="5_2_release_notes.html">5.2 版 - 2018 年 4 月</a></dd>
                  <dd><a href="5_1_release_notes.html">5.1 版 - 2017 年 4 月</a></dd>
                  <dd><a href="5_0_release_notes.html">5.0 版 - 2016 年 6 月</a></dd>
                  <dd><a href="4_2_release_notes.html">4.2 版 - 2014 年 12 月</a></dd>
                  <dd><a href="4_1_release_notes.html">4.1 版 - 2014 年 4 月</a></dd>
                  <dd><a href="4_0_release_notes.html">4.0 版 - 2013 年 6 月</a></dd>
                  <dd><a href="3_2_release_notes.html">3.2 版 - 2012 年 1 月</a></dd>
                  <dd><a href="3_1_release_notes.html">3.1 版 - 2011 年 8 月</a></dd>
                  <dd><a href="3_0_release_notes.html">3.0 版 - 2010 年 8 月</a></dd>
                  <dd><a href="2_3_release_notes.html">2.3 版 - 2009 年 3 月</a></dd>
                  <dd><a href="2_2_release_notes.html">2.2 版 - 2008 年 11 月</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">貢獻</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">手冊目錄</option>
              <optgroup label="從這裡開始">
                  <option value="getting_started.html">Rails 入門</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record 基礎</option>
                  <option value="active_record_migrations.html">Active Record 遷移 (Migrations)</option>
                  <option value="active_record_validations.html">Active Record 驗證 (Validations)</option>
                  <option value="active_record_callbacks.html">Active Record 回呼 (Callbacks)</option>
                  <option value="association_basics.html">Active Record 關聯 (Associations)</option>
                  <option value="active_record_querying.html">Active Record 查詢介面</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Rails 中的版面配置(Layouts)和算繪(Rendering)</option>
                  <option value="form_helpers.html">Action View 表單 Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller 概述</option>
                  <option value="routing.html">Rails 從外到內路由</option>
              </optgroup>
              <optgroup label="其他元件">
                  <option value="active_support_core_extensions.html">Active Support 核心擴充套件</option>
                  <option value="action_mailer_basics.html">Action Mailer 基礎知識</option>
                  <option value="active_job_basics.html">Active Job 基礎</option>
                  <option value="active_storage_overview.html">Active Storage 概述</option>
                  <option value="action_cable_overview.html">Action Cable 概述</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="深入研究">
                  <option value="i18n.html">Rails 國際化 (I18n) API</option>
                  <option value="testing.html">測試 Rails 應用程式</option>
                  <option value="security.html">保護 Rails 應用程式</option>
                  <option value="debugging_rails_applications.html">除錯 Rails 應用程式</option>
                  <option value="configuring.html">設定 Rails 應用程式</option>
                  <option value="command_line.html">Rails 命令列</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="autoloading_and_reloading_constants.html">自動載入和重新載入常量</option>
                  <option value="caching_with_rails.html">使用 Rails 快取</option>
                  <option value="api_app.html">將 Rails 用於僅 API 的應用程式</option>
              </optgroup>
              <optgroup label="擴充 rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">建立和自定義 Rails 產生器和模板</option>
              </optgroup>
              <optgroup label="貢獻">
                  <option value="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</option>
                  <option value="api_documentation_guidelines.html">API 文件指南</option>
                  <option value="ruby_on_rails_guides_guidelines.html">指南指南</option>
              </optgroup>
              <optgroup label="政策">
                  <option value="maintenance_policy.html">維修政策</option>
              </optgroup>
              <optgroup label="發行說明">
                  <option value="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</option>
                  <option value="6_1_release_notes.html">6.1 版 - 2020 年 12 月</option>
                  <option value="6_0_release_notes.html">6.0 版 - 2019 年 8 月</option>
                  <option value="5_2_release_notes.html">5.2 版 - 2018 年 4 月</option>
                  <option value="5_1_release_notes.html">5.1 版 - 2017 年 4 月</option>
                  <option value="5_0_release_notes.html">5.0 版 - 2016 年 6 月</option>
                  <option value="4_2_release_notes.html">4.2 版 - 2014 年 12 月</option>
                  <option value="4_1_release_notes.html">4.1 版 - 2014 年 4 月</option>
                  <option value="4_0_release_notes.html">4.0 版 - 2013 年 6 月</option>
                  <option value="3_2_release_notes.html">3.2 版 - 2012 年 1 月</option>
                  <option value="3_1_release_notes.html">3.1 版 - 2011 年 8 月</option>
                  <option value="3_0_release_notes.html">3.0 版 - 2010 年 8 月</option>
                  <option value="2_3_release_notes.html">2.3 版 - 2009 年 3 月</option>
                  <option value="2_2_release_notes.html">2.2 版 - 2008 年 11 月</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Rails 初始化過程</h2><p>本指南解釋了 Rails 中初始化過程的內部結構。
這是一份非常深入的指南，推薦給高階 Rails 開發人員。</p><p>閱讀本指南後，您將瞭解：</p>
<ul>
<li>如何使用 <code>bin/rails server</code>。</li>
<li>Rails&#39;初始化序列的時間線。</li>
<li>啟動順序需要不同的檔案。</li>
<li>Rails::Server 介面是如何定義和使用的。</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#">發射！</a>

<ul>
<li><a href="#bin-rails"><code>bin/rails</code></a></li>
<li><a href="#config-boot-rb"><code>config/boot.rb</code></a></li>
<li><a href="#rails-commands-rb"><code>rails/commands.rb</code></a></li>
<li><a href="#rails-command-rb"><code>rails/command.rb</code></a></li>
<li><a href="#actionpack-lib-action-dispatch-rb"><code>actionpack/lib/action_dispatch.rb</code></a></li>
<li><a href="#rails-commands-server-server-command-rb"><code>rails/commands/server/server_command.rb</code></a></li>
<li><a href="#rack-lib-rack-server-rb">Rack: <code>lib/rack/server.rb</code></a></li>
<li><a href="#config-application"><code>config/application</code></a></li>
<li><a href="#rails-server-start"><code>Rails::Server#start</code></a></li>
<li><a href="#config-environment-rb"><code>config/environment.rb</code></a></li>
<li><a href="#config-application-rb"><code>config/application.rb</code></a></li>
</ul>
</li>
<li>
<a href="#rails">正在載入 Rails</a>

<ul>
<li><a href="#railties-lib-rails-all-rb"><code>railties/lib/rails/all.rb</code></a></li>
<li><a href="#config-environment-rb">返回 <code>config/environment.rb</code></a></li>
<li><a href="#railties-lib-rails-application-rb"><code>railties/lib/rails/application.rb</code></a></li>
<li><a href="#rack-lib-rack-server-rb">Rack：lib/rack/server.rb</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <p>本指南介紹了每個方法呼叫
需要在 Rails 堆疊上為預設的 Rails 啟動 Ruby
應用程式，沿途詳細解釋每個部分。為了這
指南，我們將關注執行 <code>bin/rails server</code> 時會發生什麼
啟動您的應用程式。</p><p>除非另有說明，本指南中的 NOTE: 路徑與 Rails 或 Rails 應用程式相關。</p><p>提示：如果您想在瀏覽 Rails <a href="https://github.com/rails/rails">源
code</a>，建議使用<code>t</code>
key 繫結開啟GitHub裡面的檔案查詢器，查詢檔案
迅速地。</p><h3 id=""><a class="anchorlink" href="#">1 發射！</a></h3><p>讓我們開始啟動並初始化應用程式。 Rails 應用程式通常是
通過執行 <code>bin/rails console</code> 或 <code>bin/rails server</code> 啟動。</p><h4 id="bin-rails"><a class="anchorlink" href="#bin-rails">1.1 <code>bin/rails</code></a></h4><p>該檔案如下：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1">#!/usr/bin/env ruby</span>
<span class="no">APP_PATH</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../config/application'</span><span class="p">,</span> <span class="n">__dir__</span><span class="p">)</span>
<span class="nb">require_relative</span> <span class="s2">"../config/boot"</span>
<span class="nb">require</span> <span class="s2">"rails/commands"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="#!/usr/bin/env ruby
APP_PATH = File.expand_path('../config/application', __dir__)
require_relative &quot;../config/boot&quot;
require &quot;rails/commands&quot;
">Copy</button>
</div>
<p><code>APP_PATH</code> 常量稍後將在 <code>rails/commands</code> 中使用。這裡引用的 <code>config/boot</code> 檔案就是我們應用中的 <code>config/boot.rb</code> 檔案，負責載入 Bundler 並進行設定。</p><h4 id="config-boot-rb"><a class="anchorlink" href="#config-boot-rb">1.2 <code>config/boot.rb</code></a></h4><p><code>config/boot.rb</code> 包含：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">ENV</span><span class="p">[</span><span class="s1">'BUNDLE_GEMFILE'</span><span class="p">]</span> <span class="o">||=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../Gemfile'</span><span class="p">,</span> <span class="n">__dir__</span><span class="p">)</span>

<span class="nb">require</span> <span class="s2">"bundler/setup"</span> <span class="c1"># Set up gems listed in the Gemfile.</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="ENV['BUNDLE_GEMFILE'] ||= File.expand_path('../Gemfile', __dir__)

require &quot;bundler/setup&quot; # Set up gems listed in the Gemfile.
">Copy</button>
</div>
<p>在標準的 Rails 應用程式中，有一個 <code>Gemfile</code> 宣告所有
應用程式的依賴關係。 <code>config/boot.rb</code> 集
<code>ENV['BUNDLE_GEMFILE']</code> 到這個檔案的位置。如果 <code>Gemfile</code>
存在，則需要 <code>bundler/setup</code>。 Bundler 使用 require 來
為您的 Gemfile 的依賴項設定載入路徑。</p><p>一個標準的 Rails 應用程式依賴於幾個 gem，特別是：</p>
<ul>
<li>actioncable</li>
<li>actionmailer</li>
<li>actionpack</li>
<li>actionview</li>
<li>主動工作</li>
<li>activemodel</li>
<li>活動記錄</li>
<li>主動儲存</li>
<li>主動支援</li>
<li>action郵箱</li>
<li>actiontext</li>
<li>阿雷爾</li>
<li>建造者</li>
<li>捆綁器</li>
<li>erubi</li>
<li>i18n</li>
<li>郵件</li>
<li>啞劇型別</li>
<li>rack</li>
<li>rack-測試</li>
<li>rails</li>
<li>railties</li>
<li>耙子</li>
<li>sqlite3</li>
<li>雷神</li>
<li>資訊</li>
</ul>
<h4 id="rails-commands-rb"><a class="anchorlink" href="#rails-commands-rb">1.3 <code>rails/commands.rb</code></a></h4><p><code>config/boot.rb</code> 完成後，需要的下一個檔案是
<code>rails/commands</code>，有助於擴充套件別名。在目前的情況下，
<code>ARGV</code> 陣列只包含將被傳遞的 <code>server</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"rails/command"</span>

<span class="n">aliases</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">"g"</span>  <span class="o">=&gt;</span> <span class="s2">"generate"</span><span class="p">,</span>
  <span class="s2">"d"</span>  <span class="o">=&gt;</span> <span class="s2">"destroy"</span><span class="p">,</span>
  <span class="s2">"c"</span>  <span class="o">=&gt;</span> <span class="s2">"console"</span><span class="p">,</span>
  <span class="s2">"s"</span>  <span class="o">=&gt;</span> <span class="s2">"server"</span><span class="p">,</span>
  <span class="s2">"db"</span> <span class="o">=&gt;</span> <span class="s2">"dbconsole"</span><span class="p">,</span>
  <span class="s2">"r"</span>  <span class="o">=&gt;</span> <span class="s2">"runner"</span><span class="p">,</span>
  <span class="s2">"t"</span>  <span class="o">=&gt;</span> <span class="s2">"test"</span>
<span class="p">}</span>

<span class="n">command</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">shift</span>
<span class="n">command</span> <span class="o">=</span> <span class="n">aliases</span><span class="p">[</span><span class="n">command</span><span class="p">]</span> <span class="o">||</span> <span class="n">command</span>

<span class="no">Rails</span><span class="o">::</span><span class="no">Command</span><span class="p">.</span><span class="nf">invoke</span> <span class="n">command</span><span class="p">,</span> <span class="no">ARGV</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='require "rails/command"

aliases = {
  "g"  =&gt; "generate",
  "d"  =&gt; "destroy",
  "c"  =&gt; "console",
  "s"  =&gt; "server",
  "db" =&gt; "dbconsole",
  "r"  =&gt; "runner",
  "t"  =&gt; "test"
}

command = ARGV.shift
command = aliases[command] || command

Rails::Command.invoke command, ARGV
'>Copy</button>
</div>
<p>如果我們使用 <code>s</code> 而不是 <code>server</code>，Rails 將使用 <code>aliases</code>
定義here來查詢匹配的命令。</p><h4 id="rails-command-rb"><a class="anchorlink" href="#rails-command-rb">1.4 <code>rails/command.rb</code></a></h4><p>當鍵入 Rails 命令時，<code>invoke</code> 嘗試查詢給定的命令
名稱空間並在找到時執行命令。</p><p>如果 Rails 不能識別該命令，它會將控制權交給 Rake
運行同名任務。</p><p>如圖所示，如果 <code>namespace</code>
是空的。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rails</span>
  <span class="k">module</span> <span class="nn">Command</span>
    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
      <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">full_namespace</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">full_namespace</span> <span class="o">=</span> <span class="n">full_namespace</span><span class="p">.</span><span class="nf">to_s</span>

        <span class="k">if</span> <span class="n">char</span> <span class="o">=</span> <span class="n">namespace</span> <span class="o">=~</span> <span class="sr">/:(\w+)$/</span><span class="err">
          c</span><span class="sr">omm</span><span class="n">and_name</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="vg">$1</span><span class="p">,</span> <span class="n">namespace</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">char</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">command_name</span> <span class="o">=</span> <span class="n">namespace</span>
        <span class="k">end</span>

        <span class="n">command_name</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="s2">"help"</span><span class="p">,</span> <span class="s2">"help"</span> <span class="k">if</span> <span class="n">command_name</span><span class="p">.</span><span class="nf">blank?</span> <span class="o">||</span> <span class="no">HELP_MAPPINGS</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">command_name</span><span class="p">)</span>
        <span class="n">command_name</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="s2">"version"</span><span class="p">,</span> <span class="s2">"version"</span> <span class="k">if</span> <span class="sx">%w( -v --version )</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">command_name</span><span class="p">)</span>

        <span class="n">command</span> <span class="o">=</span> <span class="n">find_by_namespace</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">command_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span> <span class="o">&amp;&amp;</span> <span class="n">command</span><span class="p">.</span><span class="nf">all_commands</span><span class="p">[</span><span class="n">command_name</span><span class="p">]</span>
          <span class="n">command</span><span class="p">.</span><span class="nf">perform</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">find_by_namespace</span><span class="p">(</span><span class="s2">"rake"</span><span class="p">).</span><span class="nf">perform</span><span class="p">(</span><span class="n">full_namespace</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module Rails
  module Command
    class &lt;&lt; self
      def invoke(full_namespace, args = [], **config)
        namespace = full_namespace = full_namespace.to_s

        if char = namespace =~ /:(\w+)$/
          command_name, namespace = $1, namespace.slice(0, char)
        else
          command_name = namespace
        end

        command_name, namespace = "help", "help" if command_name.blank? || HELP_MAPPINGS.include?(command_name)
        command_name, namespace = "version", "version" if %w( -v --version ).include?(command_name)

        command = find_by_namespace(namespace, command_name)
        if command &amp;&amp; command.all_commands[command_name]
          command.perform(command_name, args, config)
        else
          find_by_namespace("rake").perform(full_namespace, args, config)
        end
      end
    end
  end
end
'>Copy</button>
</div>
<p>使用 <code>server</code> 命令，Rails 將進一步執行以下程式碼：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rails</span>
  <span class="k">module</span> <span class="nn">Command</span>
    <span class="k">class</span> <span class="nc">ServerCommand</span> <span class="o">&lt;</span> <span class="no">Base</span> <span class="c1"># :nodoc:</span>
      <span class="k">def</span> <span class="nf">perform</span>
        <span class="n">extract_environment_option_from_argument</span>
        <span class="n">set_application_directory!</span>
        <span class="n">prepare_restart</span>

        <span class="no">Rails</span><span class="o">::</span><span class="no">Server</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">server_options</span><span class="p">).</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
          <span class="c1"># Require application after server sets environment to propagate</span>
          <span class="c1"># the --environment option.</span>
          <span class="nb">require</span> <span class="no">APP_PATH</span>
          <span class="no">Dir</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">root</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="nf">serveable?</span>
            <span class="n">print_boot_information</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="nf">server</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="nf">served_url</span><span class="p">)</span>
            <span class="n">after_stop_callback</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">say</span> <span class="s2">"Exiting"</span> <span class="k">unless</span> <span class="n">options</span><span class="p">[</span><span class="ss">:daemon</span><span class="p">]</span> <span class="p">}</span>
            <span class="n">server</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">after_stop_callback</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="n">say</span> <span class="n">rack_server_suggestion</span><span class="p">(</span><span class="n">using</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module Rails
  module Command
    class ServerCommand &lt; Base # :nodoc:
      def perform
        extract_environment_option_from_argument
        set_application_directory!
        prepare_restart

        Rails::Server.new(server_options).tap do |server|
          # Require application after server sets environment to propagate
          # the --environment option.
          require APP_PATH
          Dir.chdir(Rails.application.root)

          if server.serveable?
            print_boot_information(server.server, server.served_url)
            after_stop_callback = -&gt; { say "Exiting" unless options[:daemon] }
            server.start(after_stop_callback)
          else
            say rack_server_suggestion(using)
          end
        end
      end
    end
  end
end
'>Copy</button>
</div>
<p>這個檔案會變成 Rails 根目錄（一個路徑向上兩個目錄
來自指向 <code>config/application.rb</code> 的 <code>APP_PATH</code>），但前提是
未找到 <code>config.ru</code> 檔案。然後啟動 <code>Rails::Server</code> 類。</p><h4 id="actionpack-lib-action-dispatch-rb"><a class="anchorlink" href="#actionpack-lib-action-dispatch-rb">1.5 <code>actionpack/lib/action_dispatch.rb</code></a></h4><p>Action Dispatch 是 Rails 框架的路由元件。
它添加了路由、session 和通用中介軟體等功能。</p><h4 id="rails-commands-server-server-command-rb"><a class="anchorlink" href="#rails-commands-server-server-command-rb">1.6 <code>rails/commands/server/server_command.rb</code></a></h4><p><code>Rails::Server</code> 類是在這個檔案中定義的，繼承自
<code>Rack::Server</code>。當呼叫 <code>Rails::Server.new</code> 時，這會呼叫 <code>initialize</code>
<code>rails/commands/server/server_command.rb</code> 中的方法：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rails</span>
  <span class="k">class</span> <span class="nc">Server</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Server</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="vi">@default_options</span> <span class="o">=</span> <span class="n">options</span> <span class="o">||</span> <span class="p">{}</span>
      <span class="k">super</span><span class="p">(</span><span class="vi">@default_options</span><span class="p">)</span>
      <span class="n">set_environment</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module Rails
  class Server &lt; ::Rack::Server
    def initialize(options = nil)
      @default_options = options || {}
      super(@default_options)
      set_environment
    end
  end
end
">Copy</button>
</div>
<p>首先，呼叫 <code>super</code> 呼叫 <code>Rack::Server</code> 上的 <code>initialize</code> 方法。</p><h4 id="rack-lib-rack-server-rb"><a class="anchorlink" href="#rack-lib-rack-server-rb">1.7 Rack: <code>lib/rack/server.rb</code></a></h4><p><code>Rack::Server</code> 負責為所有根據 Rack 的應用程式提供一個通用的伺服器介面，現在 Rails 是其中的一部分。</p><p><code>Rack::Server</code> 中的 <code>initialize</code> 方法簡單地設定了幾個變數：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="vi">@ignore_options</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="k">if</span> <span class="n">options</span>
        <span class="vi">@use_default_options</span> <span class="o">=</span> <span class="kp">false</span>
        <span class="vi">@options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="vi">@app</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:app</span><span class="p">]</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:app</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="k">defined?</span><span class="p">(</span><span class="no">SPEC_ARGV</span><span class="p">)</span> <span class="p">?</span> <span class="no">SPEC_ARGV</span> <span class="p">:</span> <span class="no">ARGV</span>
        <span class="vi">@use_default_options</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="vi">@options</span> <span class="o">=</span> <span class="n">parse_options</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module Rack
  class Server
    def initialize(options = nil)
      @ignore_options = []

      if options
        @use_default_options = false
        @options = options
        @app = options[:app] if options[:app]
      else
        argv = defined?(SPEC_ARGV) ? SPEC_ARGV : ARGV
        @use_default_options = true
        @options = parse_options(argv)
      end
    end
  end
end
">Copy</button>
</div>
<p>在這種情況下，返回 <code>Rails::Command::ServerCommand#server_options</code> 的 value 將分配給 <code>options</code>。
當評估 if 語句中的行時，將設定幾個實例變數。</p><p><code>Rails::Command::ServerCommand</code>中的<code>server_options</code>方法定義如下：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rails</span>
  <span class="k">module</span> <span class="nn">Command</span>
    <span class="k">class</span> <span class="nc">ServerCommand</span>
      <span class="n">no_commands</span> <span class="k">do</span>
        <span class="k">def</span> <span class="nf">server_options</span>
          <span class="p">{</span>
            <span class="ss">user_supplied_options: </span><span class="n">user_supplied_options</span><span class="p">,</span>
            <span class="ss">server:                </span><span class="n">using</span><span class="p">,</span>
            <span class="ss">log_stdout:            </span><span class="n">log_to_stdout?</span><span class="p">,</span>
            <span class="no">Port</span><span class="p">:</span>                  <span class="n">port</span><span class="p">,</span>
            <span class="no">Host</span><span class="p">:</span>                  <span class="n">host</span><span class="p">,</span>
            <span class="no">DoNotReverseLookup</span><span class="p">:</span>    <span class="kp">true</span><span class="p">,</span>
            <span class="ss">config:                </span><span class="n">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">],</span>
            <span class="ss">environment:           </span><span class="n">environment</span><span class="p">,</span>
            <span class="ss">daemonize:             </span><span class="n">options</span><span class="p">[</span><span class="ss">:daemon</span><span class="p">],</span>
            <span class="ss">pid:                   </span><span class="n">pid</span><span class="p">,</span>
            <span class="ss">caching:               </span><span class="n">options</span><span class="p">[</span><span class="ss">:dev_caching</span><span class="p">],</span>
            <span class="ss">restart_cmd:           </span><span class="n">restart_command</span><span class="p">,</span>
            <span class="ss">early_hints:           </span><span class="n">early_hints</span>
          <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module Rails
  module Command
    class ServerCommand
      no_commands do
        def server_options
          {
            user_supplied_options: user_supplied_options,
            server:                using,
            log_stdout:            log_to_stdout?,
            Port:                  port,
            Host:                  host,
            DoNotReverseLookup:    true,
            config:                options[:config],
            environment:           environment,
            daemonize:             options[:daemon],
            pid:                   pid,
            caching:               options[:dev_caching],
            restart_cmd:           restart_command,
            early_hints:           early_hints
          }
        end
      end
    end
  end
end
">Copy</button>
</div>
<p>value 將被分配給實例變數 <code>@options</code>。</p><p><code>super</code> 在 <code>Rack::Server</code> 中完成後，我們跳回
<code>rails/commands/server/server_command.rb</code>。此時，<code>set_environment</code>
在 <code>Rails::Server</code> 物件的上下文中呼叫。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rails</span>
  <span class="k">module</span> <span class="nn">Server</span>
    <span class="k">def</span> <span class="nf">set_environment</span>
      <span class="no">ENV</span><span class="p">[</span><span class="s2">"RAILS_ENV"</span><span class="p">]</span> <span class="o">||=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:environment</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module Rails
  module Server
    def set_environment
      ENV["RAILS_ENV"] ||= options[:environment]
    end
  end
end
'>Copy</button>
</div>
<p><code>initialize</code> 完成後，我們跳回伺服器命令
其中 <code>APP_PATH</code>（之前已設定）是必需的。</p><h4 id="config-application"><a class="anchorlink" href="#config-application">1.8 <code>config/application</code></a></h4><p>當 <code>require APP_PATH</code> 被執行時，<code>config/application.rb</code> 被載入（回想一下
<code>APP_PATH</code> 在 <code>bin/rails</code> 中定義）。此檔案存在於您的應用程式中
您可以根據自己的需要免費更改。</p><h4 id="rails-server-start"><a class="anchorlink" href="#rails-server-start">1.9 <code>Rails::Server#start</code></a></h4><p>載入 <code>config/application</code> 後，呼叫 <code>server.start</code>。這種方法是
定義如下：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rails</span>
  <span class="k">class</span> <span class="nc">Server</span> <span class="o">&lt;</span> <span class="o">::</span><span class="no">Rack</span><span class="o">::</span><span class="no">Server</span>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">after_stop_callback</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
      <span class="nb">trap</span><span class="p">(</span><span class="ss">:INT</span><span class="p">)</span> <span class="p">{</span> <span class="nb">exit</span> <span class="p">}</span>
      <span class="n">create_tmp_directories</span>
      <span class="n">setup_dev_caching</span>
      <span class="n">log_to_stdout</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:log_stdout</span><span class="p">]</span>

      <span class="k">super</span><span class="p">()</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>

    <span class="kp">private</span>
      <span class="k">def</span> <span class="nf">setup_dev_caching</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:environment</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"development"</span>
          <span class="no">Rails</span><span class="o">::</span><span class="no">DevCaching</span><span class="p">.</span><span class="nf">enable_by_argument</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="ss">:caching</span><span class="p">])</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">create_tmp_directories</span>
        <span class="sx">%w(cache pids sockets)</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir_to_make</span><span class="o">|</span>
          <span class="no">FileUtils</span><span class="p">.</span><span class="nf">mkdir_p</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">,</span> <span class="s2">"tmp"</span><span class="p">,</span> <span class="n">dir_to_make</span><span class="p">))</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">log_to_stdout</span>
        <span class="n">wrapped_app</span> <span class="c1"># touch the app so the logger is set up</span>

        <span class="n">console</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
        <span class="n">console</span><span class="p">.</span><span class="nf">formatter</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">formatter</span>
        <span class="n">console</span><span class="p">.</span><span class="nf">level</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">level</span>

        <span class="k">unless</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">logger_outputs_to?</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">,</span> <span class="no">STDOUT</span><span class="p">)</span>
          <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="n">console</span><span class="p">))</span>
        <span class="k">end</span>
      <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module Rails
  class Server &lt; ::Rack::Server
    def start(after_stop_callback = nil)
      trap(:INT) { exit }
      create_tmp_directories
      setup_dev_caching
      log_to_stdout if options[:log_stdout]

      super()
      # ...
    end

    private
      def setup_dev_caching
        if options[:environment] == "development"
          Rails::DevCaching.enable_by_argument(options[:caching])
        end
      end

      def create_tmp_directories
        %w(cache pids sockets).each do |dir_to_make|
          FileUtils.mkdir_p(File.join(Rails.root, "tmp", dir_to_make))
        end
      end

      def log_to_stdout
        wrapped_app # touch the app so the logger is set up

        console = ActiveSupport::Logger.new(STDOUT)
        console.formatter = Rails.logger.formatter
        console.level = Rails.logger.level

        unless ActiveSupport::Logger.logger_outputs_to?(Rails.logger, STDOUT)
          Rails.logger.extend(ActiveSupport::Logger.broadcast(console))
        end
      end
  end
end
'>Copy</button>
</div>
<p>此方法為 <code>INT</code> 訊號建立陷阱，因此如果您使用 <code>CTRL-C</code> 伺服器，它將退出該程序。
從這裡的程式碼可以看出，它將建立 <code>tmp/cache</code>，
<code>tmp/pids</code> 和 <code>tmp/sockets</code> 目錄。然後在開發中啟用快取
如果用 <code>--dev-caching</code> 呼叫 <code>bin/rails server</code>。最後，它呼叫 <code>wrapped_app</code> 是
負責在建立和分配實例之前建立 Rack 應用程式
<code>ActiveSupport::Logger</code> 的。</p><p><code>super</code> 方法將呼叫 <code>Rack::Server.start</code>，它的定義如下：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="k">def</span> <span class="nf">start</span> <span class="o">&amp;</span><span class="n">blk</span>
      <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:warn</span><span class="p">]</span>
        <span class="vg">$-w</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">includes</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:include</span><span class="p">]</span>
        <span class="vg">$LOAD_PATH</span><span class="p">.</span><span class="nf">unshift</span><span class="p">(</span><span class="o">*</span><span class="n">includes</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">library</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:require</span><span class="p">]</span>
        <span class="nb">require</span> <span class="n">library</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:debug</span><span class="p">]</span>
        <span class="vg">$DEBUG</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="nb">require</span> <span class="s2">"pp"</span>
        <span class="nb">p</span> <span class="n">options</span><span class="p">[</span><span class="ss">:server</span><span class="p">]</span>
        <span class="n">pp</span> <span class="n">wrapped_app</span>
        <span class="n">pp</span> <span class="n">app</span>
      <span class="k">end</span>

      <span class="n">check_pid!</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:pid</span><span class="p">]</span>

      <span class="c1"># Touch the wrapped app, so that the config.ru is loaded before</span>
      <span class="c1"># daemonization (i.e. before chdir, etc).</span>
      <span class="n">handle_profiling</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="ss">:heapfile</span><span class="p">],</span> <span class="n">options</span><span class="p">[</span><span class="ss">:profile_mode</span><span class="p">],</span> <span class="n">options</span><span class="p">[</span><span class="ss">:profile_file</span><span class="p">])</span> <span class="k">do</span>
        <span class="n">wrapped_app</span>
      <span class="k">end</span>

      <span class="n">daemonize_app</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:daemonize</span><span class="p">]</span>

      <span class="n">write_pid</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:pid</span><span class="p">]</span>

      <span class="nb">trap</span><span class="p">(</span><span class="ss">:INT</span><span class="p">)</span> <span class="k">do</span>
        <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:shutdown</span><span class="p">)</span>
          <span class="n">server</span><span class="p">.</span><span class="nf">shutdown</span>
        <span class="k">else</span>
          <span class="nb">exit</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">server</span><span class="p">.</span><span class="nf">run</span> <span class="n">wrapped_app</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module Rack
  class Server
    def start &amp;blk
      if options[:warn]
        $-w = true
      end

      if includes = options[:include]
        $LOAD_PATH.unshift(*includes)
      end

      if library = options[:require]
        require library
      end

      if options[:debug]
        $DEBUG = true
        require "pp"
        p options[:server]
        pp wrapped_app
        pp app
      end

      check_pid! if options[:pid]

      # Touch the wrapped app, so that the config.ru is loaded before
      # daemonization (i.e. before chdir, etc).
      handle_profiling(options[:heapfile], options[:profile_mode], options[:profile_file]) do
        wrapped_app
      end

      daemonize_app if options[:daemonize]

      write_pid if options[:pid]

      trap(:INT) do
        if server.respond_to?(:shutdown)
          server.shutdown
        else
          exit
        end
      end

      server.run wrapped_app, options, &amp;blk
    end
  end
end
'>Copy</button>
</div>
<p>Rails 應用程式的有趣部分是最後一行，<code>server.run</code>。這裡我們又遇到了 <code>wrapped_app</code> 方法，這一次
我們將探索更多（即使它之前被執行過，並且
因此現在已經記住了）。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="k">def</span> <span class="nf">wrapped_app</span>
      <span class="vi">@wrapped_app</span> <span class="o">||=</span> <span class="n">build_app</span> <span class="n">app</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module Rack
  class Server
    def wrapped_app
      @wrapped_app ||= build_app app
    end
  end
end
">Copy</button>
</div>
<p>這裡的 <code>app</code> 方法定義如下：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="k">def</span> <span class="nf">app</span>
      <span class="vi">@app</span> <span class="o">||=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:builder</span><span class="p">]</span> <span class="p">?</span> <span class="n">build_app_from_string</span> <span class="p">:</span> <span class="n">build_app_and_options_from_config</span>
    <span class="k">end</span>

    <span class="c1"># ...</span>

    <span class="kp">private</span>
      <span class="k">def</span> <span class="nf">build_app_and_options_from_config</span>
        <span class="k">if</span> <span class="o">!::</span><span class="no">File</span><span class="p">.</span><span class="nf">exist?</span> <span class="n">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">]</span>
          <span class="nb">abort</span> <span class="s2">"configuration </span><span class="si">#{</span><span class="n">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found"</span>
        <span class="k">end</span>

        <span class="n">app</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Builder</span><span class="p">.</span><span class="nf">parse_file</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">],</span> <span class="n">opt_parser</span><span class="p">)</span>
        <span class="vi">@options</span><span class="p">.</span><span class="nf">merge!</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="o">|</span> <span class="n">old</span> <span class="p">}</span>
        <span class="n">app</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">build_app_from_string</span>
        <span class="no">Rack</span><span class="o">::</span><span class="no">Builder</span><span class="p">.</span><span class="nf">new_from_string</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">options</span><span class="p">[</span><span class="ss">:builder</span><span class="p">])</span>
      <span class="k">end</span>

  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module Rack
  class Server
    def app
      @app ||= options[:builder] ? build_app_from_string : build_app_and_options_from_config
    end

    # ...

    private
      def build_app_and_options_from_config
        if !::File.exist? options[:config]
          abort "configuration #{options[:config]} not found"
        end

        app, options = Rack::Builder.parse_file(self.options[:config], opt_parser)
        @options.merge!(options) { |key, old, new| old }
        app
      end

      def build_app_from_string
        Rack::Builder.new_from_string(self.options[:builder])
      end

  end
end
'>Copy</button>
</div>
<p><code>options[:config]</code> value 預設為 <code>config.ru</code>，其中包含：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 這個檔案被根據 Rack 的伺服器用來啟動應用程式。</span>

<span class="nb">require_relative</span> <span class="s2">"config/environment"</span>

<span class="n">run</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='# 這個檔案被根據 Rack 的伺服器用來啟動應用程式。

require_relative "config/environment"

run Rails.application
'>Copy</button>
</div>
<p>此處的 <code>Rack::Builder.parse_file</code> 方法從 <code>config.ru</code> 檔案中獲取內容並使用以下程式碼對其進行解析：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Builder</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">load_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="no">Server</span><span class="o">::</span><span class="no">Options</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>
      <span class="c1"># ...</span>
      <span class="n">app</span> <span class="o">=</span> <span class="n">new_from_string</span> <span class="n">cfgfile</span><span class="p">,</span> <span class="n">config</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>

    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">new_from_string</span><span class="p">(</span><span class="n">builder_script</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">"(rackup)"</span><span class="p">)</span>
      <span class="nb">eval</span> <span class="s2">"Rack::Builder.new {</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">builder_script</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">}.to_app"</span><span class="p">,</span>
        <span class="no">TOPLEVEL_BINDING</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module Rack
  class Builder
    def self.load_file(path, opts = Server::Options.new)
      # ...
      app = new_from_string cfgfile, config
      # ...
    end

    # ...

    def self.new_from_string(builder_script, file="(rackup)")
      eval "Rack::Builder.new {\n" + builder_script + "\n}.to_app",
        TOPLEVEL_BINDING, file, 0
    end
  end
end
'>Copy</button>
</div>
<p><code>Rack::Builder</code> 的 <code>initialize</code> 方法將獲取這裡的塊並在 <code>Rack::Builder</code> 的實例中執行它。
這是 Rails 的大部分初始化過程發生的地方。
<code>config.ru</code> 中 <code>config/environment.rb</code> 的 <code>require</code> 行首先執行：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require_relative</span> <span class="s2">"config/environment"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='require_relative "config/environment"
'>Copy</button>
</div>
<h4 id="config-environment-rb"><a class="anchorlink" href="#config-environment-rb">1.10 <code>config/environment.rb</code></a></h4><p>該檔案是<code>config.ru</code>(<code>bin/rails server</code>)和Passenger所需的通用檔案。這就是這兩種執行伺服器的方式相遇的地方；在此之前的所有內容都已設定為 Rack 和 Rails。</p><p>該檔案以要求 <code>config/application.rb</code> 開頭：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require_relative</span> <span class="s2">"application"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='require_relative "application"
'>Copy</button>
</div>
<h4 id="config-application-rb"><a class="anchorlink" href="#config-application-rb">1.11 <code>config/application.rb</code></a></h4><p>該檔案需要 <code>config/boot.rb</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require_relative</span> <span class="s2">"boot"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='require_relative "boot"
'>Copy</button>
</div>
<p>但前提是之前不需要它，在 <code>bin/rails server</code> 中就是這種情況
但<strong>不會</strong>是Passenger的情況。</p><p>然後樂趣開始了！</p><h3 id="rails"><a class="anchorlink" href="#rails">2 正在載入 Rails</a></h3><p><code>config/application.rb</code> 中的下一行是：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"rails/all"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='require "rails/all"
'>Copy</button>
</div>
<h4 id="railties-lib-rails-all-rb"><a class="anchorlink" href="#railties-lib-rails-all-rb">2.1 <code>railties/lib/rails/all.rb</code></a></h4><p>該檔案負責要求 Rails 的所有單獨框架：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"rails"</span>

<span class="sx">%w(
  active_record/railtie
  active_storage/engine
  action_controller/railtie
  action_view/railtie
  action_mailer/railtie
  active_job/railtie
  action_cable/engine
  action_mailbox/engine
  action_text/engine
  rails/test_unit/railtie
  sprockets/railtie
)</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">railtie</span><span class="o">|</span>
  <span class="k">begin</span>
    <span class="nb">require</span> <span class="n">railtie</span>
  <span class="k">rescue</span> <span class="no">LoadError</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='require "rails"

%w(
  active_record/railtie
  active_storage/engine
  action_controller/railtie
  action_view/railtie
  action_mailer/railtie
  active_job/railtie
  action_cable/engine
  action_mailbox/engine
  action_text/engine
  rails/test_unit/railtie
  sprockets/railtie
).each do |railtie|
  begin
    require railtie
  rescue LoadError
  end
end
'>Copy</button>
</div>
<p>這是所有 Rails 框架被載入並製作的地方
可用於應用程式。我們不會詳細說明會發生什麼
在每個框架內，但我們鼓勵您嘗試並
自己探索它們。</p><p>現在，請記住像 Rails 引擎這樣的常見功能，
I18n 和 Rails 設定都在這裡定義。</p><h4 id="config-environment-rb"><a class="anchorlink" href="#config-environment-rb">2.2 返回 <code>config/environment.rb</code></a></h4><p><code>config/application.rb</code> 的其餘部分定義了
<code>Rails::Application</code> 將在應用程式完全執行後使用
初始化。當 <code>config/application.rb</code> 完成載入 Rails 並定義
應用程式名稱空間，我們回到<code>config/environment.rb</code>。在這裡，
應用程式用 <code>Rails.application.initialize!</code> 初始化，即
在 <code>rails/application.rb</code> 中定義。</p><h4 id="railties-lib-rails-application-rb"><a class="anchorlink" href="#railties-lib-rails-application-rb">2.3 <code>railties/lib/rails/application.rb</code></a></h4><p><code>initialize!</code> 方法如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">initialize!</span><span class="p">(</span><span class="n">group</span> <span class="o">=</span> <span class="ss">:default</span><span class="p">)</span> <span class="c1"># :nodoc:</span>
  <span class="k">raise</span> <span class="s2">"Application has been already initialized."</span> <span class="k">if</span> <span class="vi">@initialized</span>
  <span class="n">run_initializers</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
  <span class="vi">@initialized</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="nb">self</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='def initialize!(group = :default) # :nodoc:
  raise "Application has been already initialized." if @initialized
  run_initializers(group, self)
  @initialized = true
  self
end
'>Copy</button>
</div>
<p>您只能初始化一個應用程式一次。 Railtie <a href="configuring.html#initializers">初始化器</a>
通過 <code>run_initializers</code> 方法執行，該方法定義在
<code>railties/lib/rails/initializable.rb</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">run_initializers</span><span class="p">(</span><span class="n">group</span> <span class="o">=</span> <span class="ss">:default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@ran</span><span class="p">)</span>
  <span class="n">initializers</span><span class="p">.</span><span class="nf">tsort_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">initializer</span><span class="o">|</span>
    <span class="n">initializer</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">initializer</span><span class="p">.</span><span class="nf">belongs_to?</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="vi">@ran</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="def run_initializers(group = :default, *args)
  return if instance_variable_defined?(:@ran)
  initializers.tsort_each do |initializer|
    initializer.run(*args) if initializer.belongs_to?(group)
  end
  @ran = true
end
">Copy</button>
</div>
<p><code>run_initializers</code> 程式碼本身很棘手。 Rails 在這裡做的是
遍歷所有的類祖先尋找那些回應
<code>initializers</code> 方法。然後它按名稱對祖先進行排序，並執行它們。
例如， <code>Engine</code> 類將使所有引擎可用
為它們提供 <code>initializers</code> 方法。</p><p><code>Rails::Application</code> 類，在 <code>railties/lib/rails/application.rb</code> 中定義
定義了 <code>bootstrap</code>、<code>railtie</code> 和 <code>finisher</code> 初始值設定項。 <code>bootstrap</code> 初始值設定項
準備應用程式（如初始化記錄器），而 <code>finisher</code>
初始化程式（如構建中介軟體堆疊）最後執行。 <code>railtie</code>
初始值設定項是在 <code>Rails::Application</code> 上定義的初始值設定項
本身並在 <code>bootstrap</code> 和 <code>finishers</code> 之間執行。</p><p><em>注意：</em> 不要將 Railtie 初始化器整體與 <a href="configuring.html#using-initializer-files">load_config_initializers</a> 混淆
<code>config/initializers</code> 中的初始化程式實例或其關聯的設定初始化程式。</p><p>完成後我們回到<code>Rack::Server</code>。</p><h4 id="rack-lib-rack-server-rb"><a class="anchorlink" href="#rack-lib-rack-server-rb">2.4 Rack：lib/rack/server.rb</a></h4><p>上次我們離開時正在定義 <code>app</code> 方法：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="k">def</span> <span class="nf">app</span>
      <span class="vi">@app</span> <span class="o">||=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:builder</span><span class="p">]</span> <span class="p">?</span> <span class="n">build_app_from_string</span> <span class="p">:</span> <span class="n">build_app_and_options_from_config</span>
    <span class="k">end</span>

    <span class="c1"># ...</span>

    <span class="kp">private</span>
      <span class="k">def</span> <span class="nf">build_app_and_options_from_config</span>
        <span class="k">if</span> <span class="o">!::</span><span class="no">File</span><span class="p">.</span><span class="nf">exist?</span> <span class="n">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">]</span>
          <span class="nb">abort</span> <span class="s2">"configuration </span><span class="si">#{</span><span class="n">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found"</span>
        <span class="k">end</span>

        <span class="n">app</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Builder</span><span class="p">.</span><span class="nf">parse_file</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">options</span><span class="p">[</span><span class="ss">:config</span><span class="p">],</span> <span class="n">opt_parser</span><span class="p">)</span>
        <span class="vi">@options</span><span class="p">.</span><span class="nf">merge!</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="o">|</span> <span class="n">old</span> <span class="p">}</span>
        <span class="n">app</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">build_app_from_string</span>
        <span class="no">Rack</span><span class="o">::</span><span class="no">Builder</span><span class="p">.</span><span class="nf">new_from_string</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">options</span><span class="p">[</span><span class="ss">:builder</span><span class="p">])</span>
      <span class="k">end</span>

  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module Rack
  class Server
    def app
      @app ||= options[:builder] ? build_app_from_string : build_app_and_options_from_config
    end

    # ...

    private
      def build_app_and_options_from_config
        if !::File.exist? options[:config]
          abort "configuration #{options[:config]} not found"
        end

        app, options = Rack::Builder.parse_file(self.options[:config], opt_parser)
        @options.merge!(options) { |key, old, new| old }
        app
      end

      def build_app_from_string
        Rack::Builder.new_from_string(self.options[:builder])
      end

  end
end
'>Copy</button>
</div>
<p>此時<code>app</code>就是Rails應用本身（一箇中間件），還有什麼
接下來發生的是 Rack 將呼叫所有提供的中介軟體：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="kp">private</span>
      <span class="k">def</span> <span class="nf">build_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="n">middleware</span><span class="p">[</span><span class="n">options</span><span class="p">[</span><span class="ss">:environment</span><span class="p">]].</span><span class="nf">reverse_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">middleware</span><span class="o">|</span>
          <span class="n">middleware</span> <span class="o">=</span> <span class="n">middleware</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="k">if</span> <span class="n">middleware</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:call</span><span class="p">)</span>
          <span class="k">next</span> <span class="k">unless</span> <span class="n">middleware</span>
          <span class="n">klass</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">middleware</span>
          <span class="n">app</span> <span class="o">=</span> <span class="n">klass</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">app</span>
      <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="module Rack
  class Server
    private
      def build_app(app)
        middleware[options[:environment]].reverse_each do |middleware|
          middleware = middleware.call(self) if middleware.respond_to?(:call)
          next unless middleware
          klass, *args = middleware
          app = klass.new(app, *args)
        end
        app
      end
  end
end
">Copy</button>
</div>
<p>請記住，在 <code>Rack::Server#start</code> 的最後一行呼叫了 <code>build_app</code>（由 <code>wrapped_app</code>）。
這是我們離開時的樣子：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">server</span><span class="p">.</span><span class="nf">run</span> <span class="n">wrapped_app</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="server.run wrapped_app, options, &amp;blk
">Copy</button>
</div>
<p>此時，<code>server.run</code> 的實現將取決於
您正在使用的伺服器。例如，如果您使用的是 Puma，以下是
<code>run</code> 方法如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">module</span> <span class="nn">Rack</span>
  <span class="k">module</span> <span class="nn">Handler</span>
    <span class="k">module</span> <span class="nn">Puma</span>
      <span class="c1"># ...</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
        <span class="n">conf</span>   <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="n">events</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:Silent</span><span class="p">)</span> <span class="p">?</span> <span class="o">::</span><span class="no">Puma</span><span class="o">::</span><span class="no">Events</span><span class="p">.</span><span class="nf">strings</span> <span class="p">:</span> <span class="o">::</span><span class="no">Puma</span><span class="o">::</span><span class="no">Events</span><span class="p">.</span><span class="nf">stdio</span>

        <span class="n">launcher</span> <span class="o">=</span> <span class="o">::</span><span class="no">Puma</span><span class="o">::</span><span class="no">Launcher</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="ss">:events</span> <span class="o">=&gt;</span> <span class="n">events</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">launcher</span> <span class="k">if</span> <span class="nb">block_given?</span>
        <span class="k">begin</span>
          <span class="n">launcher</span><span class="p">.</span><span class="nf">run</span>
        <span class="k">rescue</span> <span class="no">Interrupt</span>
          <span class="nb">puts</span> <span class="s2">"* Gracefully stopping, waiting for requests to finish"</span>
          <span class="n">launcher</span><span class="p">.</span><span class="nf">stop</span>
          <span class="nb">puts</span> <span class="s2">"* Goodbye!"</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='module Rack
  module Handler
    module Puma
      # ...
      def self.run(app, options = {})
        conf   = self.config(app, options)

        events = options.delete(:Silent) ? ::Puma::Events.strings : ::Puma::Events.stdio

        launcher = ::Puma::Launcher.new(conf, :events =&gt; events)

        yield launcher if block_given?
        begin
          launcher.run
        rescue Interrupt
          puts "* Gracefully stopping, waiting for requests to finish"
          launcher.stop
          puts "* Goodbye!"
        end
      end
      # ...
    end
  end
end
'>Copy</button>
</div>
<p>我們不會深入研究伺服器設定本身，但這是
Rails 初始化過程中的最後一段旅程。</p><p>這個高層次的 overview 將幫助您瞭解您的程式碼何時
執行和如何，並總體上成為一個更好的 Rails 開發人員。如果你
還想了解更多，Rails原始碼本身大概就是
接下來最好的去處。</p>

        <h3>回饋</h3>
        <p>
          我們鼓勵您幫助提高本指南的品質。
        </p>
        <p>
          如果您發現任何拼寫錯誤或資訊錯誤，請提供回饋。
          要開始回饋，您可以閱讀我們的 <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">回饋</a> 部分。
        </p>
        <p>
          您還可能會發現不完整的內容或不是最新的內容。
          請務必為 main 新增任何遺漏的文件。假設是
          <a href="https://edgeguides.rubyonrails.org">非穩定版指南(edge guides)</a> 請先驗證問題是否已經在主分支上解決。
          請前往 <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南寫作準則</a> 查看寫作風格和慣例。
        </p>
        <p>
          如果由於某種原因您發現要修復的內容但無法自行修補，請您 <a href="https://github.com/rails/rails/issues">提出 issue</a>。
        </p>
        <p>關於 Ruby on Rails 的任何類型的討論歡迎提供任何文件至 <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">rubyonrails-docs 討論區</a>。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>本作品已獲得<a href="https://creativecommons.org/licenses/by-sa/4.0/">知識共享署名-相同方式共享 4.0 國際</a>許可</p>
<p>“Rails”、“Ruby on Rails”和 Rails 標誌是 David Heinemeier Hansson 的商標。 保留所有權利。</p>
    </div>
  </div>
</body>
</html>
