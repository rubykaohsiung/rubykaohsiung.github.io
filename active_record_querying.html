<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Active Record 查詢介面 — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Active Record 查詢介面 — Ruby on Rails Guides" />
  <meta name="description" content="Active Record 查詢介面本指南介紹了使用 Active Record 從資料庫檢索資料的不同方法。閱讀本指南後，您將瞭解： 如何使用各種方法和條件查詢記錄。 如何指定找到的記錄的順序、檢索屬性、分組和其他屬性。 如何使用預先載入來減少資料檢索所需的資料庫查詢次數。 如何使用動態查詢器方法。 如何使用方法鏈將多個 Active Record 方法一起使用。 如何檢查特定記錄的存在。 如何對 Active Record models 進行各種計算。 如何在關係上執行 EXPLAIN。" />
  <meta property="og:description" content="Active Record 查詢介面本指南介紹了使用 Active Record 從資料庫檢索資料的不同方法。閱讀本指南後，您將瞭解： 如何使用各種方法和條件查詢記錄。 如何指定找到的記錄的順序、檢索屬性、分組和其他屬性。 如何使用預先載入來減少資料檢索所需的資料庫查詢次數。 如何使用動態查詢器方法。 如何使用方法鏈將多個 Active Record 方法一起使用。 如何檢查特定記錄的存在。 如何對 Active Record models 進行各種計算。 如何在關係上執行 EXPLAIN。" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">v7.0.0</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多資訊請前往 <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        更多在 Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://weblog.rubyonrails.org/">部落格</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">指南</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">論壇</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">在 GitHub 上做出貢獻</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="返回首頁">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">首頁</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">手冊目錄</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>從這裡開始</dt>
                  <dd><a href="getting_started.html">Rails 入門</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record 基礎</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record 遷移 (Migrations)</a></dd>
                  <dd><a href="active_record_validations.html">Active Record 驗證 (Validations)</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record 回呼 (Callbacks)</a></dd>
                  <dd><a href="association_basics.html">Active Record 關聯 (Associations)</a></dd>
                  <dd><a href="active_record_querying.html">Active Record 查詢介面</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="layouts_and_rendering.html">Rails 中的版面配置(Layouts)和算繪(Rendering)</a></dd>
                  <dd><a href="form_helpers.html">Action View 表單 Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller 概述</a></dd>
                  <dd><a href="routing.html">Rails 從外到內路由</a></dd>
                </div>
                <div class="guides-section">
                  <dt>其他元件</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support 核心擴充套件</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer 基礎知識</a></dd>
                  <dd><a href="active_job_basics.html">Active Job 基礎</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage 概述</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable 概述</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>深入研究</dt>
                  <dd><a href="i18n.html">Rails 國際化 (I18n) API</a></dd>
                  <dd><a href="testing.html">測試 Rails 應用程式</a></dd>
                  <dd><a href="security.html">保護 Rails 應用程式</a></dd>
                  <dd><a href="debugging_rails_applications.html">除錯 Rails 應用程式</a></dd>
                  <dd><a href="configuring.html">設定 Rails 應用程式</a></dd>
                  <dd><a href="command_line.html">Rails 命令列</a></dd>
                  <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">自動載入和重新載入常量</a></dd>
                  <dd><a href="caching_with_rails.html">使用 Rails 快取</a></dd>
                  <dd><a href="api_app.html">將 Rails 用於僅 API 的應用程式</a></dd>
                </div>
                <div class="guides-section">
                  <dt>擴充 rails</dt>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">建立和自定義 Rails 產生器和模板</a></dd>
                </div>
                <div class="guides-section">
                  <dt>貢獻</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API 文件指南</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">指南指南</a></dd>
                </div>
                <div class="guides-section">
                  <dt>政策</dt>
                  <dd><a href="maintenance_policy.html">維修政策</a></dd>
                </div>
                <div class="guides-section">
                  <dt>發行說明</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</a></dd>
                  <dd><a href="6_1_release_notes.html">6.1 版 - 2020 年 12 月</a></dd>
                  <dd><a href="6_0_release_notes.html">6.0 版 - 2019 年 8 月</a></dd>
                  <dd><a href="5_2_release_notes.html">5.2 版 - 2018 年 4 月</a></dd>
                  <dd><a href="5_1_release_notes.html">5.1 版 - 2017 年 4 月</a></dd>
                  <dd><a href="5_0_release_notes.html">5.0 版 - 2016 年 6 月</a></dd>
                  <dd><a href="4_2_release_notes.html">4.2 版 - 2014 年 12 月</a></dd>
                  <dd><a href="4_1_release_notes.html">4.1 版 - 2014 年 4 月</a></dd>
                  <dd><a href="4_0_release_notes.html">4.0 版 - 2013 年 6 月</a></dd>
                  <dd><a href="3_2_release_notes.html">3.2 版 - 2012 年 1 月</a></dd>
                  <dd><a href="3_1_release_notes.html">3.1 版 - 2011 年 8 月</a></dd>
                  <dd><a href="3_0_release_notes.html">3.0 版 - 2010 年 8 月</a></dd>
                  <dd><a href="2_3_release_notes.html">2.3 版 - 2009 年 3 月</a></dd>
                  <dd><a href="2_2_release_notes.html">2.2 版 - 2008 年 11 月</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">貢獻</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">手冊目錄</option>
              <optgroup label="從這裡開始">
                  <option value="getting_started.html">Rails 入門</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record 基礎</option>
                  <option value="active_record_migrations.html">Active Record 遷移 (Migrations)</option>
                  <option value="active_record_validations.html">Active Record 驗證 (Validations)</option>
                  <option value="active_record_callbacks.html">Active Record 回呼 (Callbacks)</option>
                  <option value="association_basics.html">Active Record 關聯 (Associations)</option>
                  <option value="active_record_querying.html">Active Record 查詢介面</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Rails 中的版面配置(Layouts)和算繪(Rendering)</option>
                  <option value="form_helpers.html">Action View 表單 Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller 概述</option>
                  <option value="routing.html">Rails 從外到內路由</option>
              </optgroup>
              <optgroup label="其他元件">
                  <option value="active_support_core_extensions.html">Active Support 核心擴充套件</option>
                  <option value="action_mailer_basics.html">Action Mailer 基礎知識</option>
                  <option value="active_job_basics.html">Active Job 基礎</option>
                  <option value="active_storage_overview.html">Active Storage 概述</option>
                  <option value="action_cable_overview.html">Action Cable 概述</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="深入研究">
                  <option value="i18n.html">Rails 國際化 (I18n) API</option>
                  <option value="testing.html">測試 Rails 應用程式</option>
                  <option value="security.html">保護 Rails 應用程式</option>
                  <option value="debugging_rails_applications.html">除錯 Rails 應用程式</option>
                  <option value="configuring.html">設定 Rails 應用程式</option>
                  <option value="command_line.html">Rails 命令列</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="autoloading_and_reloading_constants.html">自動載入和重新載入常量</option>
                  <option value="caching_with_rails.html">使用 Rails 快取</option>
                  <option value="api_app.html">將 Rails 用於僅 API 的應用程式</option>
              </optgroup>
              <optgroup label="擴充 rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">建立和自定義 Rails 產生器和模板</option>
              </optgroup>
              <optgroup label="貢獻">
                  <option value="contributing_to_ruby_on_rails.html">在 Rails 上為 Ruby 做貢獻</option>
                  <option value="api_documentation_guidelines.html">API 文件指南</option>
                  <option value="ruby_on_rails_guides_guidelines.html">指南指南</option>
              </optgroup>
              <optgroup label="政策">
                  <option value="maintenance_policy.html">維修政策</option>
              </optgroup>
              <optgroup label="發行說明">
                  <option value="upgrading_ruby_on_rails.html">在 Rails 上升級 Ruby</option>
                  <option value="6_1_release_notes.html">6.1 版 - 2020 年 12 月</option>
                  <option value="6_0_release_notes.html">6.0 版 - 2019 年 8 月</option>
                  <option value="5_2_release_notes.html">5.2 版 - 2018 年 4 月</option>
                  <option value="5_1_release_notes.html">5.1 版 - 2017 年 4 月</option>
                  <option value="5_0_release_notes.html">5.0 版 - 2016 年 6 月</option>
                  <option value="4_2_release_notes.html">4.2 版 - 2014 年 12 月</option>
                  <option value="4_1_release_notes.html">4.1 版 - 2014 年 4 月</option>
                  <option value="4_0_release_notes.html">4.0 版 - 2013 年 6 月</option>
                  <option value="3_2_release_notes.html">3.2 版 - 2012 年 1 月</option>
                  <option value="3_1_release_notes.html">3.1 版 - 2011 年 8 月</option>
                  <option value="3_0_release_notes.html">3.0 版 - 2010 年 8 月</option>
                  <option value="2_3_release_notes.html">2.3 版 - 2009 年 3 月</option>
                  <option value="2_2_release_notes.html">2.2 版 - 2008 年 11 月</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Active Record 查詢介面</h2><p>本指南介紹了使用 Active Record 從資料庫檢索資料的不同方法。</p><p>閱讀本指南後，您將瞭解：</p>
<ul>
<li>如何使用各種方法和條件查詢記錄。</li>
<li>如何指定找到的記錄的順序、檢索屬性、分組和其他屬性。</li>
<li>如何使用預先載入來減少資料檢索所需的資料庫查詢次數。</li>
<li>如何使用動態查詢器方法。</li>
<li>如何使用方法鏈將多個 Active Record 方法一起使用。</li>
<li>如何檢查特定記錄的存在。</li>
<li>如何對 Active Record models 進行各種計算。</li>
<li>如何在關係上執行 EXPLAIN。</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#active-record">Active Record 查詢介面是什麼？</a></li>
<li>
<a href="#">從資料庫中檢索物件</a>

<ul>
<li><a href="#">檢索單個物件</a></li>
<li><a href="#">批次檢索多個物件</a></li>
</ul>
</li>
<li>
<a href="#">條件</a>

<ul>
<li><a href="#">純字串條件</a></li>
<li><a href="#">陣列條件</a></li>
<li><a href="#">雜湊條件</a></li>
<li><a href="#not">NOT 條件</a></li>
<li><a href="#or">OR 條件</a></li>
<li><a href="#and">AND 條件</a></li>
</ul>
</li>
<li><a href="#">訂購</a></li>
<li><a href="#">選擇特定欄位</a></li>
<li><a href="#">限制和偏移</a></li>
<li>
<a href="#">團體</a>

<ul>
<li><a href="#">分組專案總數</a></li>
</ul>
</li>
<li><a href="#">擁有</a></li>
<li>
<a href="#">覆蓋條件</a>

<ul>
<li><a href="#unscope"><code>unscope</code></a></li>
<li><a href="#only"><code>only</code></a></li>
<li><a href="#reselect"><code>reselect</code></a></li>
<li><a href="#reorder"><code>reorder</code></a></li>
<li><a href="#reverse-order"><code>reverse_order</code></a></li>
<li><a href="#rewhere"><code>rewhere</code></a></li>
</ul>
</li>
<li><a href="#">空關係</a></li>
<li><a href="#">只讀物件</a></li>
<li>
<a href="#">鎖定更新記錄</a>

<ul>
<li><a href="#">樂觀鎖</a></li>
<li><a href="#">悲觀鎖</a></li>
</ul>
</li>
<li>
<a href="#">連線表</a>

<ul>
<li><a href="#joins"><code>joins</code></a></li>
<li><a href="#left-outer-joins"><code>left_outer_joins</code></a></li>
</ul>
</li>
<li>
<a href="#associations">急切載入Associations</a>

<ul>
<li><a href="#">包括</a></li>
<li><a href="#">預載入</a></li>
<li><a href="#eager-load">eager_load</a></li>
</ul>
</li>
<li>
<a href="#">範圍</a>

<ul>
<li><a href="#">傳入引數</a></li>
<li><a href="#">使用條件</a></li>
<li><a href="#">應用預設範圍</a></li>
<li><a href="#">合併範圍</a></li>
<li><a href="#">刪除所有範圍</a></li>
</ul>
</li>
<li><a href="#">動態查詢器</a></li>
<li><a href="#">列舉</a></li>
<li>
<a href="#">理解方法鏈</a>

<ul>
<li><a href="#">從多個表中檢索過濾資料</a></li>
<li><a href="#">從多個表中檢索特定資料</a></li>
</ul>
</li>
<li>
<a href="#">查詢或構建新物件</a>

<ul>
<li><a href="#find-or-create-by"><code>find_or_create_by</code></a></li>
<li><a href="#find-or-create-by-bang"><code>find_or_create_by!</code></a></li>
<li><a href="#find-or-initialize-by"><code>find_or_initialize_by</code></a></li>
</ul>
</li>
<li>
<a href="#sql">透過 SQL 查詢</a>

<ul>
<li><a href="#select-all"><code>select_all</code></a></li>
<li><a href="#pluck"><code>pluck</code></a></li>
<li><a href="#ids"><code>ids</code></a></li>
</ul>
</li>
<li><a href="#">物件的存在</a></li>
<li>
<a href="#">計算</a>

<ul>
<li><a href="#">計數</a></li>
<li><a href="#">平均值</a></li>
<li><a href="#">最小值</a></li>
<li><a href="#">最大值</a></li>
<li><a href="#">總和</a></li>
</ul>
</li>
<li>
<a href="#">執行解釋</a>

<ul>
<li><a href="#explain">解釋 EXPLAIN</a></li>
</ul>
</li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="active-record"><a class="anchorlink" href="#active-record">1 Active Record 查詢介面是什麼？</a></h3><p>如果您習慣於使用原始 SQL 查詢資料庫記錄，那麼您通常會發現在 Rails 中有更好的方法來執行相同的操作。 Active Record 使您無需在大多數情況下使用 SQL。</p><p>Active Record 將為您執行資料庫查詢，相容大多數資料庫系統，包括 MySQL、MariaDB、PostgreSQL 和 SQLite。無論您使用哪種資料庫系統，Active Record 方法格式將始終相同。</p><p>本指南中的程式碼示例將引用以下一個或多個 models：</p><p>提示：以下所有 models 都使用 <code>id</code> 作為主 key，除非另有說明。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">year_published: :desc</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, -&gt; { order(year_published: :desc) }
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:reviews</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:orders</span><span class="p">,</span> <span class="ss">join_table: </span><span class="s1">'books_orders'</span>

  <span class="n">scope</span> <span class="ss">:in_print</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:out_of_print</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:old</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">'year_published &lt; ?'</span><span class="p">,</span> <span class="mi">50</span><span class="p">.</span><span class="nf">years</span><span class="p">.</span><span class="nf">ago</span> <span class="p">)}</span>
  <span class="n">scope</span> <span class="ss">:out_of_print_and_expensive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">out_of_print</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'price &gt; 500'</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:costs_more_than</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">'price &gt; ?'</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  belongs_to :supplier
  belongs_to :author
  has_many :reviews
  has_and_belongs_to_many :orders, join_table: 'books_orders'

  scope :in_print, -&gt; { where(out_of_print: false) }
  scope :out_of_print, -&gt; { where(out_of_print: true) }
  scope :old, -&gt; { where('year_published &lt; ?', 50.years.ago )}
  scope :out_of_print_and_expensive, -&gt; { out_of_print.where('price &gt; 500') }
  scope :costs_more_than, -&gt;(amount) { where('price &gt; ?', amount) }
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Customer</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:orders</span>
  <span class="n">has_many</span> <span class="ss">:reviews</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Customer &lt; ApplicationRecord
  has_many :orders
  has_many :reviews
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:customer</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">join_table: </span><span class="s1">'books_orders'</span>

  <span class="n">enum</span> <span class="ss">:status</span><span class="p">,</span> <span class="p">[</span><span class="ss">:shipped</span><span class="p">,</span> <span class="ss">:being_packed</span><span class="p">,</span> <span class="ss">:complete</span><span class="p">,</span> <span class="ss">:cancelled</span><span class="p">]</span>

  <span class="n">scope</span> <span class="ss">:created_before</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">'created_at &lt; ?'</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Order &lt; ApplicationRecord
  belongs_to :customer
  has_and_belongs_to_many :books, join_table: 'books_orders'

  enum :status, [:shipped, :being_packed, :complete, :cancelled]

  scope :created_before, -&gt;(time) { where('created_at &lt; ?', time) }
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Review</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:customer</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>

  <span class="n">enum</span> <span class="ss">:state</span><span class="p">,</span> <span class="p">[</span><span class="ss">:not_reviewed</span><span class="p">,</span> <span class="ss">:published</span><span class="p">,</span> <span class="ss">:hidden</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Review &lt; ApplicationRecord
  belongs_to :customer
  belongs_to :book

  enum :state, [:not_reviewed, :published, :hidden]
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">has_many</span> <span class="ss">:authors</span><span class="p">,</span> <span class="ss">through: :books</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Supplier &lt; ApplicationRecord
  has_many :books
  has_many :authors, through: :books
end
">Copy</button>
</div>
<p><img src="images/active_record_querying/bookstore_models.png" alt="所有書店models圖"></p><h3 id=""><a class="anchorlink" href="#">2 從資料庫中檢索物件</a></h3><p>為了從資料庫中檢索物件，Active Record 提供了幾種查詢器方法。每個 finder 方法都允許您將引數傳遞給它，以便在不編寫原始 SQL 的情況下對資料庫執行某些查詢。</p><p>方法是：</p>
<ul>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-annotate"><code>annotate</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-find"><code>find</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-create_with"><code>create_with</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-distinct"><code>distinct</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-eager_load"><code>eager_load</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-extending"><code>extending</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-extract_related"><code>extract_associated</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-from"><code>from</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-group"><code>group</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-sharing"><code>having</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-includes"><code>includes</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-joins"><code>joins</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-left_outer_joins"><code>left_outer_joins</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-limit"><code>limit</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-lock"><code>lock</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-none"><code>none</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-offset"><code>offset</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-optimizer_hints"><code>optimizer_hints</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-order"><code>order</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-preload"><code>preload</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-readonly"><code>readonly</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-references"><code>references</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-reorder"><code>reorder</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-reselect"><code>reselect</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-reverse_order"><code>reverse_order</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-select"><code>select</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>where</code></a></li>
</ul>
<p>返回集合的 Finder 方法，例如 <code>where</code> 和 <code>group</code>，返回 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Relation.html"><code>ActiveRecord::Relation</code></a> 的實例。查詢單個實體的方法，例如 <code>find</code> 和 <code>first</code>，返回 model 的單個實例。</p><p><code>Model.find(options)</code> 的主要操作可以概括為：</p>
<ul>
<li>將提供的選項轉換為等效的 SQL 查詢。</li>
<li>觸發 SQL 查詢並從資料庫中檢索相應的結果。</li>
<li>為每個結果行實例化相應 model 的等效 Ruby 物件。</li>
<li>執行 <code>after_find</code> 然後 <code>after_initialize</code> callbacks，如果有的話。</li>
</ul>
<h4 id=""><a class="anchorlink" href="#">2.1 檢索單個物件</a></h4><p>Active Record 提供了幾種不同的檢索單個物件的方法。</p><h5 id="find"><a class="anchorlink" href="#find">2.1.1 <code>find</code></a></h5><p>使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-find"><code>find</code></a> 方法，您可以檢索與指定的 <em>primary key</em> 對應的物件，該物件與任何提供的選項匹配。例如：</p><div class="code_container">
<pre><code class="highlight irb"><span class="c"># 找到主 key (id) 10 的客戶。
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">customer</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">10</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Ryan"</span><span class="kt">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="customer = Customer.find(10)
">Copy</button>
</div>
<p>上面的 SQL 等價物是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">customers</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers WHERE (customers.id = 10) LIMIT 1
">Copy</button>
</div>
<p>如果沒有找到匹配的記錄，<code>find</code> 方法將引發 <code>ActiveRecord::RecordNotFound</code> 異常。</p><p>您也可以使用此方法查詢多個物件。呼叫 <code>find</code> 方法並傳入一個主要的 keys 陣列。返回將是一個數組，其中包含提供的 <em>primary keys</em> 的所有匹配記錄。例如：</p><div class="code_container">
<pre><code class="highlight irb"><span class="c"># 找到主 keys 1 和 10 的客戶。
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">customers</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">find</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span> <span class="c1"># OR Customer.find(1, 10)</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Lifo"</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">10</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Ryan"</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="customers = Customer.find([1, 10]) # OR Customer.find(1, 10)
">Copy</button>
</div>
<p>上面的 SQL 等價物是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">customers</span><span class="p">.</span><span class="n">id</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers WHERE (customers.id IN (1,10))
">Copy</button>
</div>
<p>警告： <code>find</code> 方法將引發 <code>ActiveRecord::RecordNotFound</code> 異常，除非為提供的主要 keys 的 <strong>all</strong> 找到匹配記錄。</p><h5 id="take"><a class="anchorlink" href="#take">2.1.2 <code>take</code></a></h5><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-take"><code>take</code></a> 方法在沒有任何隱式排序的情況下檢索記錄。例如：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">customer</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">take</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Lifo"</span><span class="kt">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="customer = Customer.take
">Copy</button>
</div>
<p>上面的 SQL 等價物是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">LIMIT</span> <span class="mi">1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers LIMIT 1
">Copy</button>
</div>
<p>如果沒有找到記錄並且不會引發異常，則 <code>take</code> 方法返回 <code>nil</code>。</p><p>您可以將數字引數傳遞給 <code>take</code> 方法以返回最多該數量的結果。例如</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">customers</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Lifo"</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">220</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Sara"</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="customers = Customer.take(2)
">Copy</button>
</div>
<p>上面的 SQL 等價物是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">LIMIT</span> <span class="mi">2</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers LIMIT 2
">Copy</button>
</div>
<p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-take-21"><code>take!</code></a> 方法的行為與 <code>take</code> 完全相同，不同之處在於如果沒有找到匹配的記錄，它將引發 <code>ActiveRecord::RecordNotFound</code>。</p><p>提示：檢索到的記錄可能因資料庫引擎而異。</p><h5 id="first"><a class="anchorlink" href="#first">2.1.3 <code>first</code></a></h5><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-first"><code>first</code></a> 方法查詢按主 key（預設）排序的第一條記錄。例如：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">customer</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">first</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Lifo"</span><span class="kt">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="customer = Customer.first
">Copy</button>
</div>
<p>上面的 SQL 等價物是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span> <span class="k">ASC</span> <span class="k">LIMIT</span> <span class="mi">1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers ORDER BY customers.id ASC LIMIT 1
">Copy</button>
</div>
<p>如果沒有找到匹配的記錄並且不會引發異常，則 <code>first</code> 方法返回 <code>nil</code>。</p><p>如果您的 <a href="active_record_querying.html#applying-a-default-scope">預設範圍</a> 包含 order 方法，則 <code>first</code> 將根據此排序返回第一條記錄。</p><p>您可以將數字引數傳遞給 <code>first</code> 方法以返回最多該數量的結果。例如</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">customers</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">first</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Lifo"</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Fifo"</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">3</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Filo"</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="customers = Customer.first(3)
">Copy</button>
</div>
<p>上面的 SQL 等價物是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span> <span class="k">ASC</span> <span class="k">LIMIT</span> <span class="mi">3</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers ORDER BY customers.id ASC LIMIT 3
">Copy</button>
</div>
<p>在使用 <code>order</code> 排序的集合上，<code>first</code> 將返回按 <code>order</code> 的指定屬性排序的第一條記錄。</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">customer</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">).</span><span class="nf">first</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Fifo"</span><span class="kt">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="customer = Customer.order(:first_name).first
">Copy</button>
</div>
<p>上面的 SQL 等價物是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customers</span><span class="p">.</span><span class="n">first_name</span> <span class="k">ASC</span> <span class="k">LIMIT</span> <span class="mi">1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers ORDER BY customers.first_name ASC LIMIT 1
">Copy</button>
</div>
<p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-first-21"><code>first!</code></a> 方法的行為與 <code>first</code> 完全相同，不同之處在於如果沒有找到匹配的記錄，它將引發 <code>ActiveRecord::RecordNotFound</code>。</p><h5 id="last"><a class="anchorlink" href="#last">2.1.4 <code>last</code></a></h5><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-last"><code>last</code></a> 方法查詢按主 key（預設）排序的最後一條記錄。例如：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">customer</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">last</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">221</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Russel"</span><span class="kt">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="customer = Customer.last
">Copy</button>
</div>
<p>上面的 SQL 等價物是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers ORDER BY customers.id DESC LIMIT 1
">Copy</button>
</div>
<p>如果沒有找到匹配的記錄並且不會引發異常，則 <code>last</code> 方法返回 <code>nil</code>。</p><p>如果您的 <a href="active_record_querying.html#applying-a-default-scope">預設範圍</a> 包含 order 方法，則 <code>last</code> 將根據此排序返回最後一條記錄。</p><p>您可以將數字引數傳遞給 <code>last</code> 方法以返回最多該數量的結果。例如</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">customers</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">last</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">219</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"James"</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">220</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Sara"</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">221</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Russel"</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="customers = Customer.last(3)
">Copy</button>
</div>
<p>上面的 SQL 等價物是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">3</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers ORDER BY customers.id DESC LIMIT 3
">Copy</button>
</div>
<p>在使用 <code>order</code> 排序的集合上，<code>last</code> 將返回按 <code>order</code> 的指定屬性排序的最後一條記錄。</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">customer</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">).</span><span class="nf">last</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">220</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Sara"</span><span class="kt">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="customer = Customer.order(:first_name).last
">Copy</button>
</div>
<p>上面的 SQL 等價物是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">customers</span><span class="p">.</span><span class="n">first_name</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers ORDER BY customers.first_name DESC LIMIT 1
">Copy</button>
</div>
<p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-last-21"><code>last!</code></a> 方法的行為與 <code>last</code> 完全相同，不同之處在於如果沒有找到匹配的記錄，它將引發 <code>ActiveRecord::RecordNotFound</code>。</p><h5 id="find-by"><a class="anchorlink" href="#find-by">2.1.5 <code>find_by</code></a></h5><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-find_by"><code>find_by</code></a> 方法查詢匹配某些條件的第一條記錄。例如：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">find_by</span> <span class="ss">first_name: </span><span class="s1">'Lifo'</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Lifo"</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">find_by</span> <span class="ss">first_name: </span><span class="s1">'Jon'</span>
<span class="p">=&gt;</span> <span class="kp">nil</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.find_by first_name: 'Lifo'
Customer.find_by first_name: 'Jon'
">Copy</button>
</div>
<p>相當於寫：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Lifo'</span><span class="p">).</span><span class="nf">take</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.where(first_name: 'Lifo').take
">Copy</button>
</div>
<p>上面的 SQL 等價物是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">customers</span><span class="p">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">'Lifo'</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers WHERE (customers.first_name = 'Lifo') LIMIT 1
">Copy</button>
</div>
<p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-find_by-21"><code>find_by!</code></a> 方法的行為與 <code>find_by</code> 完全相同，不同之處在於如果沒有找到匹配的記錄，它將引發 <code>ActiveRecord::RecordNotFound</code>。例如：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">find_by!</span> <span class="ss">first_name: </span><span class="s1">'does not exist'</span>
<span class="go">ActiveRecord::RecordNotFound
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.find_by! first_name: 'does not exist'
">Copy</button>
</div>
<p>這相當於寫：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'does not exist'</span><span class="p">).</span><span class="nf">take!</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.where(first_name: 'does not exist').take!
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">2.2 批次檢索多個物件</a></h4><p>我們經常需要遍歷大量記錄，例如當我們向大量客戶傳送時事通訊時，或者當我們匯出資料時。</p><p>這可能看起來很簡單：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 如果表很大，這可能會消耗太多記憶體。</span>
<span class="no">Customer</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span>
  <span class="no">NewsMailer</span><span class="p">.</span><span class="nf">weekly</span><span class="p">(</span><span class="n">customer</span><span class="p">).</span><span class="nf">deliver_now</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 如果表很大，這可能會消耗太多記憶體。
Customer.all.each do |customer|
  NewsMailer.weekly(customer).deliver_now
end
">Copy</button>
</div>
<p>但是隨著表大小的增加，這種方法變得越來越不切實際，因為 <code>Customer.all.each</code> 指示 Active Record 一次獲取<em>整個表</em>，每行構建一個 model 物件，然後將整個 model 物件陣列儲存在記憶體中。事實上，如果我們有大量的記錄，整個集合可能會超過可用的記憶體量。</p><p>Rails 提供了兩種方法來解決這個問題，將記錄分成記憶體友好的批次進行處理。第一種方法 <code>find_each</code> 檢索一批記錄，然後將 <em>each</em> 記錄作為模型單獨生成到塊中。第二種方法，<code>find_in_batches</code>，檢索一批記錄，然後將<em>整個批次</em>作為 models 的陣列生成到塊中。</p><p>提示： <code>find_each</code> 和 <code>find_in_batches</code> 方法旨在用於批次處理無法一次性全部放入記憶體的大量記錄。如果您只需要迴圈超過一千條記錄，則正常查詢方法是首選選項。</p><h5 id="find-each"><a class="anchorlink" href="#find-each">2.2.1 <code>find_each</code></a></h5><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Batches.html#method-i-find_each"><code>find_each</code></a> 方法批次檢索記錄，然後將 <em>each</em> 1 生成給塊。在以下示例中，<code>find_each</code> 以 1000 個為批次檢索客戶，並將它們一個一個地交給塊：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">find_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span>
  <span class="no">NewsMailer</span><span class="p">.</span><span class="nf">weekly</span><span class="p">(</span><span class="n">customer</span><span class="p">).</span><span class="nf">deliver_now</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.find_each do |customer|
  NewsMailer.weekly(customer).deliver_now
end
">Copy</button>
</div>
<p>重複此過程，根據需要獲取更多批次，直到處理完所有記錄。</p><p><code>find_each</code> 適用於 model 類，如上所示，也適用於關係：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">weekly_subscriber: </span><span class="kp">true</span><span class="p">).</span><span class="nf">find_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span>
  <span class="no">NewsMailer</span><span class="p">.</span><span class="nf">weekly</span><span class="p">(</span><span class="n">customer</span><span class="p">).</span><span class="nf">deliver_now</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.where(weekly_subscriber: true).find_each do |customer|
  NewsMailer.weekly(customer).deliver_now
end
">Copy</button>
</div>
<p>只要他們沒有排序，因為該方法需要強制排序
在內部進行迭代。</p><p>如果接收方中存在訂單，則行為取決於標誌
<code>config.active_record.error_on_ignored_order</code>。如果為真，則 <code>ArgumentError</code> 為
引發，否則該命令將被忽略併發出警告，這是
預設。這可以用選項 <code>:error_on_ignore</code> 覆蓋，解釋
以下。</p><h6 id="find-each"><a class="anchorlink" href="#find-each">2.2.1.1 <code>find_each</code> 的選項</a></h6><p><strong><code>:batch_size</code></strong></p><p><code>:batch_size</code> 選項允許您在單獨傳遞到塊之前指定要在每個批次中檢索的記錄數。例如，要分批檢索 5000 條記錄：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">find_each</span><span class="p">(</span><span class="ss">batch_size: </span><span class="mi">5000</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span>
  <span class="no">NewsMailer</span><span class="p">.</span><span class="nf">weekly</span><span class="p">(</span><span class="n">customer</span><span class="p">).</span><span class="nf">deliver_now</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.find_each(batch_size: 5000) do |customer|
  NewsMailer.weekly(customer).deliver_now
end
">Copy</button>
</div>
<p><strong><code>:start</code></strong></p><p>預設情況下，記錄按主 key 的升序獲取。 <code>:start</code> 選項允許您在最低 ID 不是您需要的 ID 時配置序列的第一個 ID。這將很有用，例如，如果您想恢復中斷的批處理，前提是您將上次處理的 ID 儲存為檢查點。</p><p>例如，要僅向主 key 從 2000 年開始的客戶傳送時事通訊：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">find_each</span><span class="p">(</span><span class="ss">start: </span><span class="mi">2000</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span>
  <span class="no">NewsMailer</span><span class="p">.</span><span class="nf">weekly</span><span class="p">(</span><span class="n">customer</span><span class="p">).</span><span class="nf">deliver_now</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.find_each(start: 2000) do |customer|
  NewsMailer.weekly(customer).deliver_now
end
">Copy</button>
</div>
<p><strong><code>:finish</code></strong></p><p>與 <code>:start</code> 選項類似，<code>:finish</code> 允許您在最高 ID 不是您需要的時配置序列的最後一個 ID。
這將很有用，例如，如果您想使用基於 <code>:start</code> 和 <code>:finish</code> 的記錄子集執行批處理。</p><p>例如，要僅向主 key 從 2000 到 10000 的客戶傳送時事通訊：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">find_each</span><span class="p">(</span><span class="ss">start: </span><span class="mi">2000</span><span class="p">,</span> <span class="ss">finish: </span><span class="mi">10000</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">customer</span><span class="o">|</span>
  <span class="no">NewsMailer</span><span class="p">.</span><span class="nf">weekly</span><span class="p">(</span><span class="n">customer</span><span class="p">).</span><span class="nf">deliver_now</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.find_each(start: 2000, finish: 10000) do |customer|
  NewsMailer.weekly(customer).deliver_now
end
">Copy</button>
</div>
<p>另一個例子是，如果您希望多個工作人員處理相同的
處理佇列。您可以透過設定每個工人處理 10000 條記錄
每個工人的適當 <code>:start</code> 和 <code>:finish</code> 選項。</p><p><strong><code>:error_on_ignore</code></strong></p><p>覆蓋應用程式配置以指定在出現錯誤時是否應引發錯誤
關係中存在順序。</p><h5 id="find-in-batches"><a class="anchorlink" href="#find-in-batches">2.2.2 <code>find_in_batches</code></a></h5><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Batches.html#method-i-find_in_batches"><code>find_in_batches</code></a> 方法與 <code>find_each</code> 類似，因為兩者都檢索批記錄。不同之處在於 <code>find_in_batches</code> 將 <em>batches</em> 作為 models 的陣列生成給塊，而不是單獨生成。以下示例將一次向提供的塊提供最多 1000 個客戶的陣列，最後一個塊包含任何剩餘的客戶：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 一次給 add_customers 一個包含 1000 個客戶的陣列。</span>
<span class="no">Customer</span><span class="p">.</span><span class="nf">find_in_batches</span> <span class="k">do</span> <span class="o">|</span><span class="n">customers</span><span class="o">|</span>
  <span class="n">export</span><span class="p">.</span><span class="nf">add_customers</span><span class="p">(</span><span class="n">customers</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 一次給 add_customers 一個包含 1000 個客戶的陣列。
Customer.find_in_batches do |customers|
  export.add_customers(customers)
end
">Copy</button>
</div>
<p><code>find_in_batches</code> 適用於 model 類，如上所示，也適用於關係：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 一次給 add_customers 一個包含 1000 個最近活躍客戶的陣列。</span>
<span class="no">Customer</span><span class="p">.</span><span class="nf">recently_active</span><span class="p">.</span><span class="nf">find_in_batches</span> <span class="k">do</span> <span class="o">|</span><span class="n">customers</span><span class="o">|</span>
  <span class="n">export</span><span class="p">.</span><span class="nf">add_customers</span><span class="p">(</span><span class="n">customers</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 一次給 add_customers 一個包含 1000 個最近活躍客戶的陣列。
Customer.recently_active.find_in_batches do |customers|
  export.add_customers(customers)
end
">Copy</button>
</div>
<p>只要他們沒有排序，因為該方法需要強制排序
在內部進行迭代。</p><h6 id="find-in-batches"><a class="anchorlink" href="#find-in-batches">2.2.2.1 <code>find_in_batches</code> 的選項</a></h6><p><code>find_in_batches</code> 方法接受與 <code>find_each</code> 相同的選項：</p><p><strong><code>:batch_size</code></strong></p><p>就像 <code>find_each</code> 一樣，<code>batch_size</code> 確定將在每個組中檢索多少記錄。例如，檢索 2500 條記錄的批次可以指定為：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">find_in_batches</span><span class="p">(</span><span class="ss">batch_size: </span><span class="mi">2500</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">customers</span><span class="o">|</span>
  <span class="n">export</span><span class="p">.</span><span class="nf">add_customers</span><span class="p">(</span><span class="n">customers</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.find_in_batches(batch_size: 2500) do |customers|
  export.add_customers(customers)
end
">Copy</button>
</div>
<p><strong><code>:start</code></strong></p><p><code>start</code> 選項允許指定將從中選擇記錄的起始 ID。如前所述，預設情況下，記錄是按主 key 的升序獲取的。例如，要批次檢索從 ID: 5000 開始的客戶，共 2500 條記錄，可以使用以下程式碼：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">find_in_batches</span><span class="p">(</span><span class="ss">batch_size: </span><span class="mi">2500</span><span class="p">,</span> <span class="ss">start: </span><span class="mi">5000</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">customers</span><span class="o">|</span>
  <span class="n">export</span><span class="p">.</span><span class="nf">add_customers</span><span class="p">(</span><span class="n">customers</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.find_in_batches(batch_size: 2500, start: 5000) do |customers|
  export.add_customers(customers)
end
">Copy</button>
</div>
<p><strong><code>:finish</code></strong></p><p><code>finish</code> 選項允許指定要檢索的記錄的結束 ID。下面的程式碼展示了批次檢索客戶的情況，直到ID為7000的客戶：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">find_in_batches</span><span class="p">(</span><span class="ss">finish: </span><span class="mi">7000</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">customers</span><span class="o">|</span>
  <span class="n">export</span><span class="p">.</span><span class="nf">add_customers</span><span class="p">(</span><span class="n">customers</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.find_in_batches(finish: 7000) do |customers|
  export.add_customers(customers)
end
">Copy</button>
</div>
<p><strong><code>:error_on_ignore</code></strong></p><p><code>error_on_ignore</code> 選項覆蓋應用程式配置以指定當關係中存在特定順序時是否應引發錯誤。</p><h3 id=""><a class="anchorlink" href="#">3 條件</a></h3><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-where"><code>where</code></a> 方法允許您指定條件來限制返回的記錄，代表 SQL 語句的 <code>WHERE</code> 部分。條件可以指定為字串、陣列或雜湊。</p><h4 id=""><a class="anchorlink" href="#">3.1 純字串條件</a></h4><p>如果你想在你的發現中新增條件，你可以在那裡指定它們，就像 <code>Book.where("title = 'Introduction to Algorithms'")</code> 一樣。這將找到 <code>title</code> 欄位 value 是“演算法簡介”的所有書籍。</p><p>警告：將您自己的條件構建為純字串可能會使您容易受到 SQL 注入攻擊。例如，<code>Book.where("title LIKE '%#{params[:title]}%'")</code> 是不安全的。有關使用陣列處理條件的首選方法，請參閱下一節。</p><h4 id=""><a class="anchorlink" href="#">3.2 陣列條件</a></h4><p>現在，如果這個標題可能會有所不同，比如從某個地方說出來的論點呢？查詢結果將採用以下形式：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"title = ?"</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:title</span><span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Book.where("title = ?", params[:title])
'>Copy</button>
</div>
<p>Active Record 將第一個引數作為條件字串，任何其他引數將替換其中的問號 <code>(?)</code>。</p><p>如果要指定多個條件：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"title = ? AND out_of_print = ?"</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:title</span><span class="p">],</span> <span class="kp">false</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Book.where("title = ? AND out_of_print = ?", params[:title], false)
'>Copy</button>
</div>
<p>在此示例中，第一個問號將替換為 <code>params[:title]</code> 中的 value，第二個問號將替換為 <code>false</code> 的 SQL 表示，這取決於介面卡。</p><p>此程式碼是非常可取的：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"title = ?"</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:title</span><span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Book.where("title = ?", params[:title])
'>Copy</button>
</div>
<p>到這個程式碼：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"title = </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="ss">:title</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Book.where("title = #{params[:title]}")
'>Copy</button>
</div>
<p>因為論證安全。將變數直接放入條件字串中會將變數<strong>按原樣</strong>傳遞給資料庫。這意味著它將是直接來自可能具有惡意意圖的使用者的未轉義變數。如果你這樣做，你的整個資料庫就會處於危險之中，因為一旦使用者發現他們可以利用你的資料庫，他們幾乎可以對它做任何事情。永遠不要將引數直接放在條件字串中。</p><p>提示：有關 SQL 注入危險的更多資訊，請參閱 <a href="security.html#sql-injection">Ruby on Rails 安全指南</a>。</p><h5 id=""><a class="anchorlink" href="#">3.2.1 佔位符條件</a></h5><p>類似於引數的 <code>(?)</code> 替換樣式，您還可以在條件字串中指定 keys 以及相應的 keys/values 雜湊：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"created_at &gt;= :start_date AND created_at &lt;= :end_date"</span><span class="p">,</span>
  <span class="p">{</span><span class="ss">start_date: </span><span class="n">params</span><span class="p">[</span><span class="ss">:start_date</span><span class="p">],</span> <span class="ss">end_date: </span><span class="n">params</span><span class="p">[</span><span class="ss">:end_date</span><span class="p">]})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Book.where("created_at &gt;= :start_date AND created_at &lt;= :end_date",
  {start_date: params[:start_date], end_date: params[:end_date]})
'>Copy</button>
</div>
<p>如果您有大量可變條件，這將使可讀性更清晰。</p><h4 id=""><a class="anchorlink" href="#">3.3 雜湊條件</a></h4><p>Active Record 還允許您傳入雜湊條件，這可以提高條件語法的可讀性。使用雜湊條件，您可以傳入一個包含您想要限定的欄位的 keys 和您想要如何限定它們的 values 的雜湊：</p><div class="note"><p>雜湊條件只能進行相等、範圍和子集檢查。</p></div><h5 id=""><a class="anchorlink" href="#">3.3.1 相等條件</a></h5><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">true</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.where(out_of_print: true)
">Copy</button>
</div>
<p>這將生成如下 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">books</span><span class="p">.</span><span class="n">out_of_print</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM books WHERE (books.out_of_print = 1)
">Copy</button>
</div>
<p>欄位名稱也可以是字串：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'out_of_print'</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.where('out_of_print' =&gt; true)
">Copy</button>
</div>
<p>在屬於關聯關係的情況下，如果使用 Active Record 物件作為 value，則可以使用 association key 來指定 model。此方法也適用於多型關係。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">author: </span><span class="n">author</span><span class="p">)</span>
<span class="no">Author</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:books</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">books: </span><span class="p">{</span> <span class="ss">author: </span><span class="n">author</span> <span class="p">})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.first
Book.where(author: author)
Author.joins(:books).where(books: { author: author })
">Copy</button>
</div>
<h5 id=""><a class="anchorlink" href="#">3.3.2 範圍條件</a></h5><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">created_at: </span><span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">midnight</span> <span class="o">-</span> <span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">)</span><span class="o">..</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">midnight</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.where(created_at: (Time.now.midnight - 1.day)..Time.now.midnight)
">Copy</button>
</div>
<p>這將使用 <code>BETWEEN</code> SQL 語句查詢昨天建立的所有書籍：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">books</span><span class="p">.</span><span class="n">created_at</span> <span class="k">BETWEEN</span> <span class="s1">'2008-12-21 00:00:00'</span> <span class="k">AND</span> <span class="s1">'2008-12-22 00:00:00'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM books WHERE (books.created_at BETWEEN '2008-12-21 00:00:00' AND '2008-12-22 00:00:00')
">Copy</button>
</div>
<p>這演示了 <a href="#array-conditions">陣列條件</a> 中示例的較短語法</p><h5 id=""><a class="anchorlink" href="#">3.3.3 子集條件</a></h5><p>如果要使用 <code>IN</code> 表示式查詢記錄，可以將陣列傳遞給條件雜湊：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">orders_count: </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.where(orders_count: [1,3,5])
">Copy</button>
</div>
<p>此程式碼將生成如下 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">customers</span><span class="p">.</span><span class="n">orders_count</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers WHERE (customers.orders_count IN (1,3,5))
">Copy</button>
</div>
<h4 id="not"><a class="anchorlink" href="#not">3.4 NOT 條件</a></h4><p><code>NOT</code> SQL 查詢可以透過 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods/WhereChain.html#method-i-not"><code>where.not</code></a> 構建：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">.</span><span class="nf">not</span><span class="p">(</span><span class="ss">orders_count: </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.where.not(orders_count: [1,3,5])
">Copy</button>
</div>
<p>換句話說，這個查詢可以透過不帶引數呼叫 <code>where</code> 來生成，然後立即與 <code>not</code> 連結並傳遞 <code>where</code> 條件。這將生成如下 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">customers</span><span class="p">.</span><span class="n">orders_count</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers WHERE (customers.orders_count NOT IN (1,3,5))
">Copy</button>
</div>
<h4 id="or"><a class="anchorlink" href="#or">3.5 OR 條件</a></h4><p>兩個關係之間的<code>OR</code>條件可以透過在第一個呼叫<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-or"><code>or</code></a>來建立
關係，並將第二個作為引數傳遞。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">last_name: </span><span class="s1">'Smith'</span><span class="p">).</span><span class="nf">or</span><span class="p">(</span><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">orders_count: </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]))</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.where(last_name: 'Smith').or(Customer.where(orders_count: [1,3,5]))
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">customers</span><span class="p">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="s1">'Smith'</span> <span class="k">OR</span> <span class="n">customers</span><span class="p">.</span><span class="n">orders_count</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers WHERE (customers.last_name = 'Smith' OR customers.orders_count IN (1,3,5))
">Copy</button>
</div>
<h4 id="and"><a class="anchorlink" href="#and">3.6 AND 條件</a></h4><p><code>AND</code> 條件可以透過連結 <code>where</code> 條件來構建。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">last_name: </span><span class="s1">'Smith'</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">orders_count: </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]))</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.where(last_name: 'Smith').where(orders_count: [1,3,5]))
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">WHERE</span> <span class="n">customers</span><span class="p">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="s1">'Smith'</span> <span class="k">AND</span> <span class="n">customers</span><span class="p">.</span><span class="n">orders_count</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers WHERE customers.last_name = 'Smith' AND customers.orders_count IN (1,3,5)
">Copy</button>
</div>
<p><code>AND</code> 關係之間的邏輯交集條件可以透過
在第一個關係上呼叫 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-and"><code>and</code></a>，並將第二個作為
爭論。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]).</span><span class="nf">and</span><span class="p">(</span><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.where(id: [1, 2]).and(Customer.where(id: [2, 3]))
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">customers</span><span class="p">.</span><span class="n">id</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">AND</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers WHERE (customers.id IN (1, 2) AND customers.id IN (2, 3))
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">4 訂購</a></h3><p>要以特定順序從資料庫中檢索記錄，您可以使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-order"><code>order</code></a> 方法。</p><p>例如，如果您正在獲取一組記錄並希望按表中的 <code>created_at</code> 欄位以升序對它們進行排序：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span>
<span class="err">＃</span> <span class="err">或者</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"created_at"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Book.order(:created_at)
＃ 或者
Book.order("created_at")
'>Copy</button>
</div>
<p>您也可以指定 <code>ASC</code> 或 <code>DESC</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">created_at: :desc</span><span class="p">)</span>
<span class="err">＃</span> <span class="err">或者</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">created_at: :asc</span><span class="p">)</span>
<span class="err">＃</span> <span class="err">或者</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"created_at DESC"</span><span class="p">)</span>
<span class="err">＃</span> <span class="err">或者</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"created_at ASC"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Book.order(created_at: :desc)
＃ 或者
Book.order(created_at: :asc)
＃ 或者
Book.order("created_at DESC")
＃ 或者
Book.order("created_at ASC")
'>Copy</button>
</div>
<p>或按多個欄位排序：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">title: :asc</span><span class="p">,</span> <span class="ss">created_at: :desc</span><span class="p">)</span>
<span class="err">＃</span> <span class="err">或者</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">created_at: :desc</span><span class="p">)</span>
<span class="err">＃</span> <span class="err">或者</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"title ASC, created_at DESC"</span><span class="p">)</span>
<span class="err">＃</span> <span class="err">或者</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"title ASC"</span><span class="p">,</span> <span class="s2">"created_at DESC"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Book.order(title: :asc, created_at: :desc)
＃ 或者
Book.order(:title, created_at: :desc)
＃ 或者
Book.order("title ASC, created_at DESC")
＃ 或者
Book.order("title ASC", "created_at DESC")
'>Copy</button>
</div>
<p>如果您想多次呼叫 <code>order</code>，後續的訂單將附加到第一個：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"title ASC"</span><span class="p">).</span><span class="nf">order</span><span class="p">(</span><span class="s2">"created_at DESC"</span><span class="p">)</span>
<span class="go">SELECT * FROM books ORDER BY title ASC, created_at DESC
</span></code></pre>
<button class="clipboard-button" data-clipboard-text='Book.order("title ASC").order("created_at DESC")
'>Copy</button>
</div>
<p>警告：在大多數資料庫系統中，使用 <code>select</code>、<code>pluck</code> 和 <code>ids</code> 等方法從結果集中選擇帶有 <code>distinct</code> 的欄位；除非在 <code>order</code> 子句中使用的欄位包含在選擇列表中，否則 <code>order</code> 方法將引發 <code>ActiveRecord::StatementInvalid</code> 異常。請參閱下一節以從結果集中選擇欄位。</p><h3 id=""><a class="anchorlink" href="#">5 選擇特定欄位</a></h3><p>預設情況下，<code>Model.find</code> 使用 <code>select *</code> 從結果集中選擇所有欄位。</p><p>要僅從結果集中選擇欄位的子集，您可以透過 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-select"><code>select</code></a> 方法指定子集。</p><p>例如，僅選擇 <code>isbn</code> 和 <code>out_of_print</code> 列：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:isbn</span><span class="p">,</span> <span class="ss">:out_of_print</span><span class="p">)</span>
<span class="err">＃</span> <span class="err">或者</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"isbn, out_of_print"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Book.select(:isbn, :out_of_print)
＃ 或者
Book.select("isbn, out_of_print")
'>Copy</button>
</div>
<p>此 find 呼叫使​​用的 SQL 查詢將類似於：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="n">isbn</span><span class="p">,</span> <span class="n">out_of_print</span> <span class="k">FROM</span> <span class="n">books</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT isbn, out_of_print FROM books
">Copy</button>
</div>
<p>請小心，因為這也意味著您正在使用您選擇的欄位初始化 model 物件。如果您嘗試訪問不在初始化記錄中的欄位，您將收到：</p><div class="code_container">
<pre><code class="highlight plaintext">ActiveModel::MissingAttributeError: missing attribute: &lt;attribute&gt;
</code></pre>
<button class="clipboard-button" data-clipboard-text="ActiveModel::MissingAttributeError: missing attribute: &lt;attribute&gt;
">Copy</button>
</div>
<p>其中 <code>&lt;attribute&gt;</code> 是您要求的屬性。 <code>id</code> 方法不會提高 <code>ActiveRecord::MissingAttributeError</code>，所以在使用 associations 時要小心，因為它們需要 <code>id</code> 方法才能正常執行。</p><p>如果您只想獲取某個欄位中每個唯一的 value 的單個記錄，您可以使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-distinct"><code>distinct</code></a>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">).</span><span class="nf">distinct</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.select(:last_name).distinct
">Copy</button>
</div>
<p>這將生成如下 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">last_name</span> <span class="k">FROM</span> <span class="n">customers</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT DISTINCT last_name FROM customers
">Copy</button>
</div>
<p>您還可以刪除唯一性約束：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 返回唯一的姓氏</span>
<span class="n">query</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:last_name</span><span class="p">).</span><span class="nf">distinct</span>

<span class="c1"># 返回所有姓氏，即使有重複</span>
<span class="n">query</span><span class="p">.</span><span class="nf">distinct</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 返回唯一的姓氏
query = Customer.select(:last_name).distinct

# 返回所有姓氏，即使有重複
query.distinct(false)
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">6 限制和偏移</a></h3><p>要將 <code>LIMIT</code> 應用於由 <code>Model.find</code> 觸發的 SQL，您可以在關係上使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-limit"><code>limit</code></a> 和 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-offset"><code>offset</code></a> 方法指定 <code>LIMIT</code>。</p><p>您可以使用 <code>limit</code> 指定要檢索的記錄數，並使用 <code>offset</code> 指定開始返回記錄之前要跳過的記錄數。例如</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.limit(5)
">Copy</button>
</div>
<p>將返回最多 5 個客戶，因為它沒有指定偏移量，它將返回表中的前 5 個。它執行的 SQL 如下所示：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">LIMIT</span> <span class="mi">5</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers LIMIT 5
">Copy</button>
</div>
<p>將 <code>offset</code> 新增到其中</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">offset</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.limit(5).offset(30)
">Copy</button>
</div>
<p>從 31 日開始，最多返回 5 位客戶。 SQL 看起來像：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">LIMIT</span> <span class="mi">5</span> <span class="k">OFFSET</span> <span class="mi">30</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers LIMIT 5 OFFSET 30
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">7 團體</a></h3><p>要將 <code>GROUP BY</code> 子句應用於查詢器觸發的 SQL，您可以使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-group"><code>group</code></a> 方法。</p><p>例如，如果您想查詢訂單建立日期的集合：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Order</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"created_at"</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="s2">"created_at"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Order.select("created_at").group("created_at")
'>Copy</button>
</div>
<p>這將為您在資料庫中有訂單的每個日期提供一個 <code>Order</code> 物件。</p><p>將要執行的 SQL 將是這樣的：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="n">created_at</span>
<span class="k">FROM</span> <span class="n">orders</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">created_at</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT created_at
FROM orders
GROUP BY created_at
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">7.1 分組專案總數</a></h4><p>要獲取單個查詢的分組專案總數，請在 <code>group</code> 之後呼叫 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Calculations.html#method-i-count"><code>count</code></a>。</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Order</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:status</span><span class="p">).</span><span class="nf">count</span>
<span class="p">=&gt;</span> <span class="p">{</span><span class="s2">"being_packed"</span><span class="o">=&gt;</span><span class="mi">7</span><span class="p">,</span> <span class="s2">"shipped"</span><span class="o">=&gt;</span><span class="mi">12</span><span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Order.group(:status).count
">Copy</button>
</div>
<p>將要執行的 SQL 將是這樣的：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="k">COUNT</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">count_all</span><span class="p">,</span> <span class="n">status</span> <span class="k">AS</span> <span class="n">status</span>
<span class="k">FROM</span> <span class="n">orders</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">status</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT COUNT (*) AS count_all, status AS status
FROM orders
GROUP BY status
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">8 擁有</a></h3><p>SQL 使用 <code>HAVING</code> 子句在 <code>GROUP BY</code> 欄位上指定條件。您可以透過將 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-sharing"><code>having</code></a> 方法新增到查詢中，將 <code>HAVING</code> 子句新增到由 <code>Model.find</code> 觸發的 SQL。</p><p>例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Order</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"created_at, sum(total) as total_price"</span><span class="p">).</span>
  <span class="nf">group</span><span class="p">(</span><span class="s2">"created_at"</span><span class="p">).</span><span class="nf">having</span><span class="p">(</span><span class="s2">"sum(total) &gt; ?"</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Order.select("created_at, sum(total) as total_price").
  group("created_at").having("sum(total) &gt; ?", 200)
'>Copy</button>
</div>
<p>將要執行的 SQL 將是這樣的：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="n">created_at</span> <span class="k">as</span> <span class="n">ordered_date</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="k">as</span> <span class="n">total_price</span>
<span class="k">FROM</span> <span class="n">orders</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">created_at</span>
<span class="k">HAVING</span> <span class="k">sum</span><span class="p">(</span><span class="n">total</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT created_at as ordered_date, sum(total) as total_price
FROM orders
GROUP BY created_at
HAVING sum(total) &gt; 200
">Copy</button>
</div>
<p>這將返回每個訂單物件的日期和總價，按訂購日期分組，總價超過 200 美元。</p><p>您將為每個返回的訂單物件訪問 <code>total_price</code>，如下所示：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">big_orders</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"created_at, sum(total) as total_price"</span><span class="p">)</span>
                  <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="s2">"created_at"</span><span class="p">)</span>
                  <span class="p">.</span><span class="nf">having</span><span class="p">(</span><span class="s2">"sum(total) &gt; ?"</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

<span class="n">big_orders</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">total_price</span>
<span class="c1"># 返回第一個 Order 物件的總價</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='big_orders = Order.select("created_at, sum(total) as total_price")
                  .group("created_at")
                  .having("sum(total) &gt; ?", 200)

big_orders[0].total_price
# 返回第一個 Order 物件的總價
'>Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">9 覆蓋條件</a></h3><h4 id="unscope"><a class="anchorlink" href="#unscope">9.1 <code>unscope</code></a></h4><p>您可以使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-unscope"><code>unscope</code></a> 方法指定要刪除的某些條件。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'id &gt; 100'</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">20</span><span class="p">).</span><span class="nf">order</span><span class="p">(</span><span class="s1">'id desc'</span><span class="p">).</span><span class="nf">unscope</span><span class="p">(</span><span class="ss">:order</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.where('id &gt; 100').limit(20).order('id desc').unscope(:order)
">Copy</button>
</div>
<p>將要執行的 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">LIMIT</span> <span class="mi">20</span>

<span class="c1">-- Original query without `unscope`</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">id</span> <span class="k">desc</span> <span class="k">LIMIT</span> <span class="mi">20</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM books WHERE id &gt; 100 LIMIT 20

-- Original query without `unscope`
SELECT * FROM books WHERE id &gt; 100 ORDER BY id desc LIMIT 20
">Copy</button>
</div>
<p>您還可以取消特定 <code>where</code> 子句的範圍。例如，這將從 where 子句中刪除 <code>id</code> 條件：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="mi">10</span><span class="p">,</span> <span class="ss">out_of_print: </span><span class="kp">false</span><span class="p">).</span><span class="nf">unscope</span><span class="p">(</span><span class="ss">where: :id</span><span class="p">)</span>
<span class="c1"># SELECT books.* FROM books WHERE out_of_print = 0</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.where(id: 10, out_of_print: false).unscope(where: :id)
# SELECT books.* FROM books WHERE out_of_print = 0
">Copy</button>
</div>
<p>使用 <code>unscope</code> 的關係將影響它合併到的任何關係：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s1">'id desc'</span><span class="p">).</span><span class="nf">merge</span><span class="p">(</span><span class="no">Book</span><span class="p">.</span><span class="nf">unscope</span><span class="p">(</span><span class="ss">:order</span><span class="p">))</span>
<span class="c1"># SELECT books.* FROM books</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.order('id desc').merge(Book.unscope(:order))
# SELECT books.* FROM books
">Copy</button>
</div>
<h4 id="only"><a class="anchorlink" href="#only">9.2 <code>only</code></a></h4><p>您還可以使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/SpawnMethods.html#method-i-only"><code>only</code></a> 方法覆蓋條件。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'id &gt; 10'</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">20</span><span class="p">).</span><span class="nf">order</span><span class="p">(</span><span class="s1">'id desc'</span><span class="p">).</span><span class="nf">only</span><span class="p">(</span><span class="ss">:order</span><span class="p">,</span> <span class="ss">:where</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.where('id &gt; 10').limit(20).order('id desc').only(:order, :where)
">Copy</button>
</div>
<p>將要執行的 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">id</span> <span class="k">DESC</span>

<span class="c1">-- Original query without `only`</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">id</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">20</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM books WHERE id &gt; 10 ORDER BY id DESC

-- Original query without `only`
SELECT * FROM books WHERE id &gt; 10 ORDER BY id DESC LIMIT 20
">Copy</button>
</div>
<h4 id="reselect"><a class="anchorlink" href="#reselect">9.3 <code>reselect</code></a></h4><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-reselect"><code>reselect</code></a> 方法覆蓋現有的選擇語句。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:isbn</span><span class="p">).</span><span class="nf">reselect</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.select(:title, :isbn).reselect(:created_at)
">Copy</button>
</div>
<p>將要執行的 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">`books`</span><span class="p">.</span><span class="nv">`created_at`</span> <span class="k">FROM</span> <span class="nv">`books`</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT `books`.`created_at` FROM `books`
">Copy</button>
</div>
<p>將此與未使用 <code>reselect</code> 子句的情況進行比較：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:isbn</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.select(:title, :isbn).select(:created_at)
">Copy</button>
</div>
<p>執行的 SQL 將是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">`books`</span><span class="p">.</span><span class="nv">`title`</span><span class="p">,</span> <span class="nv">`books`</span><span class="p">.</span><span class="nv">`isbn`</span><span class="p">,</span> <span class="nv">`books`</span><span class="p">.</span><span class="nv">`created_at`</span> <span class="k">FROM</span> <span class="nv">`books`</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT `books`.`title`, `books`.`isbn`, `books`.`created_at` FROM `books`
">Copy</button>
</div>
<h4 id="reorder"><a class="anchorlink" href="#reorder">9.4 <code>reorder</code></a></h4><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-reorder"><code>reorder</code></a> 方法覆蓋預設範圍順序。例如，如果類定義包括：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="ss">year_published: :desc</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Author &lt; ApplicationRecord
  has_many :books, -&gt; { order(year_published: :desc) }
end
">Copy</button>
</div>
<p>你執行這個：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Author</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nf">books</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Author.find(10).books
">Copy</button>
</div>
<p>將要執行的 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">authors</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">LIMIT</span> <span class="mi">1</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="n">author_id</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">year_published</span> <span class="k">DESC</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM authors WHERE id = 10 LIMIT 1
SELECT * FROM books WHERE author_id = 10 ORDER BY year_published DESC
">Copy</button>
</div>
<p>您可以使用 <code>reorder</code> 子句指定不同的圖書訂購方式：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Author</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nf">books</span><span class="p">.</span><span class="nf">reorder</span><span class="p">(</span><span class="s1">'year_published ASC'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Author.find(10).books.reorder('year_published ASC')
">Copy</button>
</div>
<p>將要執行的 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">authors</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">LIMIT</span> <span class="mi">1</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="n">author_id</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">year_published</span> <span class="k">ASC</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM authors WHERE id = 10 LIMIT 1
SELECT * FROM books WHERE author_id = 10 ORDER BY year_published ASC
">Copy</button>
</div>
<h4 id="reverse-order"><a class="anchorlink" href="#reverse-order">9.5 <code>reverse_order</code></a></h4><p>如果指定，<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-reverse_order"><code>reverse_order</code></a> 方法會反轉排序子句。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"author_id &gt; 10"</span><span class="p">).</span><span class="nf">order</span><span class="p">(</span><span class="ss">:year_published</span><span class="p">).</span><span class="nf">reverse_order</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Book.where("author_id &gt; 10").order(:year_published).reverse_order
'>Copy</button>
</div>
<p>將要執行的 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="n">author_id</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">year_published</span> <span class="k">DESC</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM books WHERE author_id &gt; 10 ORDER BY year_published DESC
">Copy</button>
</div>
<p>如果查詢中未指定排序子句，則 <code>reverse_order</code> 按主 key 的相反順序進行排序。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"author_id &gt; 10"</span><span class="p">).</span><span class="nf">reverse_order</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Book.where("author_id &gt; 10").reverse_order
'>Copy</button>
</div>
<p>將要執行的 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="n">author_id</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">books</span><span class="p">.</span><span class="n">id</span> <span class="k">DESC</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM books WHERE author_id &gt; 10 ORDER BY books.id DESC
">Copy</button>
</div>
<p><code>reverse_order</code> 方法接受 <strong>no</strong> 引數。</p><h4 id="rewhere"><a class="anchorlink" href="#rewhere">9.6 <code>rewhere</code></a></h4><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-rewhere"><code>rewhere</code></a> 方法會覆蓋現有的名為 <code>where</code> 的條件。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">true</span><span class="p">).</span><span class="nf">rewhere</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">false</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.where(out_of_print: true).rewhere(out_of_print: false)
">Copy</button>
</div>
<p>將要執行的 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="nv">`out_of_print`</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM books WHERE `out_of_print` = 0
">Copy</button>
</div>
<p>如果沒有使用 <code>rewhere</code> 子句，則 where 子句會被 AND 運算在一起：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">true</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">false</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.where(out_of_print: true).where(out_of_print: false)
">Copy</button>
</div>
<p>執行的 SQL 將是：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="nv">`out_of_print`</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">AND</span> <span class="nv">`out_of_print`</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM books WHERE `out_of_print` = 1 AND `out_of_print` = 0
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">10 空關係</a></h3><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-none"><code>none</code></a> 方法返回一個沒有記錄的可連結關係。連結到返回關係的任何後續條件將繼續生成空關係。這在您需要對可能返回零結果的方法或作用域的可連結回應的場景中非常有用。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">none</span> <span class="c1"># returns an empty Relation and fires no queries.</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.none # returns an empty Relation and fires no queries.
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 下面的 highlight_reviews 方法應該總是返回一個 Relation。</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">highlighted_reviews</span><span class="p">.</span><span class="nf">average</span><span class="p">(</span><span class="ss">:rating</span><span class="p">)</span>
<span class="c1"># =&gt; 返回一本書的平均評分</span>

<span class="k">class</span> <span class="nc">Book</span>
  <span class="c1"># Returns reviews if there are at least 5,</span>
  <span class="c1"># else consider this as non-reviewed book</span>
  <span class="k">def</span> <span class="nf">highlighted_reviews</span>
    <span class="k">if</span> <span class="n">reviews</span><span class="p">.</span><span class="nf">count</span> <span class="o">&gt;</span> <span class="mi">5</span>
      <span class="n">reviews</span>
    <span class="k">else</span>
      <span class="no">Review</span><span class="p">.</span><span class="nf">none</span> <span class="c1"># Does not meet minimum threshold yet</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 下面的 highlight_reviews 方法應該總是返回一個 Relation。
Book.first.highlighted_reviews.average(:rating)
# =&gt; 返回一本書的平均評分

class Book
  # Returns reviews if there are at least 5,
  # else consider this as non-reviewed book
  def highlighted_reviews
    if reviews.count &gt; 5
      reviews
    else
      Review.none # Does not meet minimum threshold yet
    end
  end
end
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">11 只讀物件</a></h3><p>Active Record 在關係上提供 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-readonly"><code>readonly</code></a> 方法以明確禁止修改任何返回的物件。任何更改只讀記錄的嘗試都不會成功，從而引發 <code>ActiveRecord::ReadOnlyRecord</code> 異常。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">customer</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">readonly</span><span class="p">.</span><span class="nf">first</span>
<span class="n">customer</span><span class="p">.</span><span class="nf">visits</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">customer</span><span class="p">.</span><span class="nf">save</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="customer = Customer.readonly.first
customer.visits += 1
customer.save
">Copy</button>
</div>
<p>由於 <code>customer</code> 被顯式設定為只讀物件，當使用更新的 value <em>visits</em> 呼叫 <code>customer.save</code> 時，上述程式碼將引發 <code>ActiveRecord::ReadOnlyRecord</code> 異常。</p><h3 id=""><a class="anchorlink" href="#">12 鎖定更新記錄</a></h3><p>在更新資料庫中的記錄和確保原子更新時，鎖定有助於防止競爭條件。</p><p>Active Record 提供了兩種鎖定機制：</p>
<ul>
<li>樂觀鎖定</li>
<li>悲觀鎖</li>
</ul>
<h4 id=""><a class="anchorlink" href="#">12.1 樂觀鎖</a></h4><p>樂觀鎖定允許多個使用者訪問同一記錄進行編輯，並假設與資料的衝突最小。它透過檢查自開啟記錄以來是否有其他程序對其進行了更改來實現此目的。如果發生這種情況，則會引發 <code>ActiveRecord::StaleObjectError</code> 異常並且忽略更新。</p><p><strong>樂觀鎖柱</strong></p><p>為了使用樂觀鎖定，該表需要有一個名為 <code>lock_version</code> 的整數型別的列。每次更新記錄時，Active Record 都會增加 <code>lock_version</code> 列。如果更新請求中 <code>lock_version</code> 欄位中的 value 低於資料庫中 <code>lock_version</code> 列中的當前值，則更新請求將失敗並顯示 <code>ActiveRecord::StaleObjectError</code>。</p><p>例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">c1</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">c2</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">c1</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s2">"Sandra"</span>
<span class="n">c1</span><span class="p">.</span><span class="nf">save</span>

<span class="n">c2</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s2">"Michael"</span>
<span class="n">c2</span><span class="p">.</span><span class="nf">save</span> <span class="c1"># Raises an ActiveRecord::StaleObjectError</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='c1 = Customer.find(1)
c2 = Customer.find(1)

c1.first_name = "Sandra"
c1.save

c2.first_name = "Michael"
c2.save # Raises an ActiveRecord::StaleObjectError
'>Copy</button>
</div>
<p>然後，您負責透過挽救異常並回滾、合併或以其他方式應用解決衝突所需的業務邏輯來處理衝突。</p><p>可以透過設定 <code>ActiveRecord::Base.lock_optimistically = false</code> 來關閉此行為。</p><p>為了覆蓋 <code>lock_version</code> 列的名稱，<code>ActiveRecord::Base</code> 提供了一個名為 <code>locking_column</code> 的類屬性：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Customer</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">locking_column</span> <span class="o">=</span> <span class="ss">:lock_customer_column</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Customer &lt; ApplicationRecord
  self.locking_column = :lock_customer_column
end
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">12.2 悲觀鎖</a></h4><p>悲觀鎖定使用底層資料庫提供的鎖定機制。在建立關係時使用 <code>lock</code> 會獲得所選行的排他鎖。使用 <code>lock</code> 的關係通常包含在 transaction 中以防止死鎖情況。</p><p>例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">lock</span><span class="p">.</span><span class="nf">first</span>
  <span class="n">book</span><span class="p">.</span><span class="nf">title</span> <span class="o">=</span> <span class="s1">'Algorithms, second edition'</span>
  <span class="n">book</span><span class="p">.</span><span class="nf">save!</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.transaction do
  book = Book.lock.first
  book.title = 'Algorithms, second edition'
  book.save!
end
">Copy</button>
</div>
<p>上面的 session 為 MySQL 後端生成以下 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>   <span class="k">BEGIN</span>
<span class="n">Book</span> <span class="k">Load</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>   <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">`books`</span> <span class="k">LIMIT</span> <span class="mi">1</span> <span class="k">FOR</span> <span class="k">UPDATE</span>
<span class="n">Book</span> <span class="k">Update</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span><span class="n">ms</span><span class="p">)</span>   <span class="k">UPDATE</span> <span class="nv">`books`</span> <span class="k">SET</span> <span class="nv">`updated_at`</span> <span class="o">=</span> <span class="s1">'2009-02-07 18:05:56'</span><span class="p">,</span> <span class="nv">`title`</span> <span class="o">=</span> <span class="s1">'Algorithms, second edition'</span> <span class="k">WHERE</span> <span class="nv">`id`</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="n">ms</span><span class="p">)</span>   <span class="k">COMMIT</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SQL (0.2ms)   BEGIN
Book Load (0.3ms)   SELECT * FROM `books` LIMIT 1 FOR UPDATE
Book Update (0.4ms)   UPDATE `books` SET `updated_at` = '2009-02-07 18:05:56', `title` = 'Algorithms, second edition' WHERE `id` = 1
SQL (0.8ms)   COMMIT
">Copy</button>
</div>
<p>您還可以將原始 SQL 傳遞給 <code>lock</code> 方法以允許不同型別的鎖。例如，MySQL 有一個名為 <code>LOCK IN SHARE MODE</code> 的表示式，您可以在其中鎖定記錄但仍允許其他查詢讀取它。要指定此表示式，只需將其作為鎖定選項傳入：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
  <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">lock</span><span class="p">(</span><span class="s2">"LOCK IN SHARE MODE"</span><span class="p">).</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">book</span><span class="p">.</span><span class="nf">increment!</span><span class="p">(</span><span class="ss">:views</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Book.transaction do
  book = Book.lock("LOCK IN SHARE MODE").find(1)
  book.increment!(:views)
end
'>Copy</button>
</div>
<div class="note"><p>請注意，您的資料庫必須支援傳遞給 <code>lock</code> 方法的原始 SQL。</p></div><p>如果您已經擁有 model 的實例，則可以使用以下程式碼啟動 transaction 並一次性獲取鎖：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">first</span>
<span class="n">book</span><span class="p">.</span><span class="nf">with_lock</span> <span class="k">do</span>
  <span class="c1"># This block is called within a transaction,</span>
  <span class="c1"># book is already locked.</span>
  <span class="n">book</span><span class="p">.</span><span class="nf">increment!</span><span class="p">(</span><span class="ss">:views</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="book = Book.first
book.with_lock do
  # This block is called within a transaction,
  # book is already locked.
  book.increment!(:views)
end
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">13 連線表</a></h3><p>Active Record 提供了兩種 finder 方法來指定 <code>JOIN</code> 上的子句
結果 SQL：<code>joins</code> 和 <code>left_outer_joins</code>。
雖然 <code>joins</code> 應該用於 <code>INNER JOIN</code> 或自定義查詢，
<code>left_outer_joins</code> 用於使用 <code>LEFT OUTER JOIN</code> 的查詢。</p><h4 id="joins"><a class="anchorlink" href="#joins">13.1 <code>joins</code></a></h4><p>有多種方法可以使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-joins"><code>joins</code></a> 方法。</p><h5 id="sql"><a class="anchorlink" href="#sql">13.1.1 使用字串 SQL 片段</a></h5><p>您可以將指定 <code>JOIN</code> 子句的原始 SQL 提供給 <code>joins</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Author</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="s2">"INNER JOIN books ON books.author_id = authors.id AND books.out_of_print = FALSE"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Author.joins("INNER JOIN books ON books.author_id = authors.id AND books.out_of_print = FALSE")
'>Copy</button>
</div>
<p>這將導致以下 SQL：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="n">authors</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="n">authors</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">books</span> <span class="k">ON</span> <span class="n">books</span><span class="p">.</span><span class="n">author_id</span> <span class="o">=</span> <span class="n">authors</span><span class="p">.</span><span class="n">id</span> <span class="k">AND</span> <span class="n">books</span><span class="p">.</span><span class="n">out_of_print</span> <span class="o">=</span> <span class="k">FALSE</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT authors.* FROM authors INNER JOIN books ON books.author_id = authors.id AND books.out_of_print = FALSE
">Copy</button>
</div>
<h5 id="association"><a class="anchorlink" href="#association">13.1.2 使用命名 Association 的陣列/雜湊</a></h5><p>Active Record 允許您使用在 model 上定義的 <a href="association_basics.html">associations</a> 的名稱作為使用 <code>joins</code> 方法時為那些 associations 指定 <code>JOIN</code> 子句的快捷方式。</p><p>以下所有內容都將使用 <code>INNER JOIN</code> 生成預期的連線查詢：</p><h6 id="association"><a class="anchorlink" href="#association">13.1.2.1 加入單個 Association</a></h6><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:reviews</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.joins(:reviews)
">Copy</button>
</div>
<p>這產生：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="n">books</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span>
  <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">reviews</span> <span class="k">ON</span> <span class="n">reviews</span><span class="p">.</span><span class="n">book_id</span> <span class="o">=</span> <span class="n">books</span><span class="p">.</span><span class="n">id</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT books.* FROM books
  INNER JOIN reviews ON reviews.book_id = books.id
">Copy</button>
</div>
<p>或者，在英語中：“使用 reviews 為所有書籍返回一個 Book 物件”。請注意，如果一本書有多個評論，您將看到重複的書。如果你想要獨特的書籍，你可以使用 <code>Book.joins(:reviews).distinct</code>。</p><h5 id="association"><a class="anchorlink" href="#association">13.1.3 加入多個 Association</a></h5><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:author</span><span class="p">,</span> <span class="ss">:reviews</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.joins(:author, :reviews)
">Copy</button>
</div>
<p>這產生：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="n">books</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span>
  <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">authors</span> <span class="k">ON</span> <span class="n">authors</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">books</span><span class="p">.</span><span class="n">author_id</span>
  <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">reviews</span> <span class="k">ON</span> <span class="n">reviews</span><span class="p">.</span><span class="n">book_id</span> <span class="o">=</span> <span class="n">books</span><span class="p">.</span><span class="n">id</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT books.* FROM books
  INNER JOIN authors ON authors.id = books.author_id
  INNER JOIN reviews ON reviews.book_id = books.id
">Copy</button>
</div>
<p>或者，在英語中：“返回所有至少有一個評論的作者的書”。再次注意，有多個 reviews 的書會出現多次。</p><h6 id="association"><a class="anchorlink" href="#association">13.1.3.1 加入巢狀的 Association（單層）</a></h6><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">reviews: :customer</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.joins(reviews: :customer)
">Copy</button>
</div>
<p>這產生：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="n">books</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span>
  <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">reviews</span> <span class="k">ON</span> <span class="n">reviews</span><span class="p">.</span><span class="n">book_id</span> <span class="o">=</span> <span class="n">books</span><span class="p">.</span><span class="n">id</span>
  <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">customers</span> <span class="k">ON</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">reviews</span><span class="p">.</span><span class="n">customer_id</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT books.* FROM books
  INNER JOIN reviews ON reviews.book_id = books.id
  INNER JOIN customers ON customers.id = reviews.customer_id
">Copy</button>
</div>
<p>或者，用英語：“退回所有客戶提供 review 的書籍。”</p><h6 id="associations"><a class="anchorlink" href="#associations">13.1.3.2 加入巢狀的 Associations（多級）</a></h6><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Author</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">books: </span><span class="p">[{</span><span class="ss">reviews: </span><span class="p">{</span> <span class="ss">customer: :orders</span><span class="p">}</span> <span class="p">},</span> <span class="ss">:supplier</span><span class="p">]</span> <span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Author.joins(books: [{reviews: { customer: :orders} }, :supplier] )
">Copy</button>
</div>
<p>這產生：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">authors</span>
  <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">books</span> <span class="k">ON</span> <span class="n">books</span><span class="p">.</span><span class="n">author_id</span> <span class="o">=</span> <span class="n">authors</span><span class="p">.</span><span class="n">id</span>
  <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">reviews</span> <span class="k">ON</span> <span class="n">reviews</span><span class="p">.</span><span class="n">book_id</span> <span class="o">=</span> <span class="n">books</span><span class="p">.</span><span class="n">id</span>
  <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">customers</span> <span class="k">ON</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">reviews</span><span class="p">.</span><span class="n">customer_id</span>
  <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">orders</span> <span class="k">ON</span> <span class="n">orders</span><span class="p">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">suppliers</span> <span class="k">ON</span> <span class="n">suppliers</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">books</span><span class="p">.</span><span class="n">supplier_id</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM authors
  INNER JOIN books ON books.author_id = authors.id
  INNER JOIN reviews ON reviews.book_id = books.id
  INNER JOIN customers ON customers.id = reviews.customer_id
  INNER JOIN orders ON orders.customer_id = customers.id
INNER JOIN suppliers ON suppliers.id = books.supplier_id
">Copy</button>
</div>
<p>或者，用英語：“返回所有擁有 reviews <em>and</em> 書籍的作者，以及這些書籍的供應商。”</p><h5 id=""><a class="anchorlink" href="#">13.1.4 在連線表上指定條件</a></h5><p>您可以使用正常的 <a href="#array-conditions">Array</a> 和 <a href="#pure-string-conditions">String</a> 條件在連線表上指定條件。 <a href="#hash-conditions">雜湊條件</a> 提供了一種特殊的語法來指定連線表的條件：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">time_range</span> <span class="o">=</span> <span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">midnight</span> <span class="o">-</span> <span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">)</span><span class="o">..</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">midnight</span>
<span class="no">Customer</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:orders</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="s1">'orders.created_at'</span> <span class="o">=&gt;</span> <span class="n">time_range</span><span class="p">).</span><span class="nf">distinct</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="time_range = (Time.now.midnight - 1.day)..Time.now.midnight
Customer.joins(:orders).where('orders.created_at' =&gt; time_range).distinct
">Copy</button>
</div>
<p>這將找到所有擁有昨天建立的訂單的客戶，使用 <code>BETWEEN</code> SQL 表示式來比較 <code>created_at</code>。</p><p>另一種更簡潔的語法是巢狀雜湊條件：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">time_range</span> <span class="o">=</span> <span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">midnight</span> <span class="o">-</span> <span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">)</span><span class="o">..</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">midnight</span>
<span class="no">Customer</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:orders</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">orders: </span><span class="p">{</span> <span class="ss">created_at: </span><span class="n">time_range</span> <span class="p">}).</span><span class="nf">distinct</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="time_range = (Time.now.midnight - 1.day)..Time.now.midnight
Customer.joins(:orders).where(orders: { created_at: time_range }).distinct
">Copy</button>
</div>
<p>對於更高階的條件或重用現有的命名範圍，可以使用 <code>Relation#merge</code>。首先，讓我們向訂單 model 新增一個新的命名範圍：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:customer</span>

  <span class="n">scope</span> <span class="ss">:created_in_time_range</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">where</span><span class="p">(</span><span class="ss">created_at: </span><span class="n">time_range</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Order &lt; ApplicationRecord
  belongs_to :customer

  scope :created_in_time_range, -&gt;(time_range) {
    where(created_at: time_range)
  }
end
">Copy</button>
</div>
<p>現在我們可以使用 <code>Relation#merge</code> 在 <code>created_in_time_range</code> 範圍內進行合併：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">time_range</span> <span class="o">=</span> <span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">midnight</span> <span class="o">-</span> <span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">)</span><span class="o">..</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">midnight</span>
<span class="no">Customer</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:orders</span><span class="p">).</span><span class="nf">merge</span><span class="p">(</span><span class="no">Order</span><span class="p">.</span><span class="nf">created_in_time_range</span><span class="p">(</span><span class="n">time_range</span><span class="p">)).</span><span class="nf">distinct</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="time_range = (Time.now.midnight - 1.day)..Time.now.midnight
Customer.joins(:orders).merge(Order.created_in_time_range(time_range)).distinct
">Copy</button>
</div>
<p>這將再次使用 <code>BETWEEN</code> SQL 表示式找到所有擁有昨天建立的訂單的客戶。</p><h4 id="left-outer-joins"><a class="anchorlink" href="#left-outer-joins">13.2 <code>left_outer_joins</code></a></h4><p>如果要選擇一組記錄，無論它們是否關聯
記錄您可以使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-left_outer_joins"><code>left_outer_joins</code></a> 方法。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">left_outer_joins</span><span class="p">(</span><span class="ss">:reviews</span><span class="p">).</span><span class="nf">distinct</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s1">'customers.*, COUNT(reviews.*) AS reviews_count'</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="s1">'customers.id'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.left_outer_joins(:reviews).distinct.select('customers.*, COUNT(reviews.*) AS reviews_count').group('customers.id')
">Copy</button>
</div>
<p>產生：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">customers</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">reviews</span><span class="p">.</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">reviews_count</span> <span class="k">FROM</span> <span class="n">customers</span>
<span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">reviews</span> <span class="k">ON</span> <span class="n">reviews</span><span class="p">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT DISTINCT customers.*, COUNT(reviews.*) AS reviews_count FROM customers
LEFT OUTER JOIN reviews ON reviews.customer_id = customers.id GROUP BY customers.id
">Copy</button>
</div>
<p>這意味著：“返回所有帶有 reviews 計數的客戶，無論他們是否
有任何 reviews”</p><h3 id="associations"><a class="anchorlink" href="#associations">14 急切載入Associations</a></h3><p>Eager loading 是一種使用盡可能少的查詢來載入由 <code>Model.find</code> 返回的物件的關聯記錄的機制。</p><p><strong>N + 1 查詢問題</strong></p><p>考慮以下程式碼，該程式碼查詢 10 本書並列印其作者的姓氏：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">books</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">last_name</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="books = Book.limit(10)

books.each do |book|
  puts book.author.last_name
end
">Copy</button>
</div>
<p>這段程式碼乍一看還不錯。但問題在於執行的查詢總數。上面的程式碼總共執行 1（查詢 10 本書）+ 10（每本書一個以載入作者）= <strong>11</strong> 查詢。</p><p><strong>N+1 查詢問題的解決方案</strong></p><p>Active Record 允許您提前指定所有將要載入的 associations。</p><p>方法是：</p>
<ul>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-includes"><code>includes</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-preload"><code>preload</code></a></li>
<li><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/QueryMethods.html#method-i-eager_load"><code>eager_load</code></a></li>
</ul>
<h4 id=""><a class="anchorlink" href="#">14.1 包括</a></h4><p>使用 <code>includes</code>，Active Record 確保使用盡可能少的查詢次數載入所有指定的 associations。</p><p>使用 <code>includes</code> 方法重新審視上述案例，我們可以將 <code>Book.limit(10)</code> 重寫為急切載入作者：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:author</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">books</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">last_name</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="books = Book.includes(:author).limit(10)

books.each do |book|
  puts book.author.last_name
end
">Copy</button>
</div>
<p>上面的程式碼將只執行 <strong>2</strong> 查詢，而不是前一種情況下的 <strong>11</strong> 查詢：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">`books`</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">`books`</span> <span class="k">LIMIT</span> <span class="mi">10</span>
<span class="k">SELECT</span> <span class="nv">`authors`</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">`authors`</span>
  <span class="k">WHERE</span> <span class="nv">`authors`</span><span class="p">.</span><span class="nv">`book_id`</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT `books`* FROM `books` LIMIT 10
SELECT `authors`.* FROM `authors`
  WHERE `authors`.`book_id` IN (1,2,3,4,5,6,7,8,9,10)
">Copy</button>
</div>
<h5 id="association"><a class="anchorlink" href="#association">14.1.1 熱切載入多個 Association</a></h5><p>Active Record 允許您使用陣列、雜湊或陣列/雜湊的巢狀雜湊和 <code>includes</code> 方法，透過單個 <code>Model.find</code> 呼叫預先載入任意數量的 associations。</p><h5 id="association"><a class="anchorlink" href="#association">14.1.2 多個 Association 陣列</a></h5><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:orders</span><span class="p">,</span> <span class="ss">:reviews</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.includes(:orders, :reviews)
">Copy</button>
</div>
<p>這將載入所有客戶和相關訂單以及每個客戶的 reviews。</p><h6 id="associations"><a class="anchorlink" href="#associations">14.1.2.1 巢狀的 Associations 雜湊</a></h6><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">orders: </span><span class="p">{</span><span class="ss">books: </span><span class="p">[</span><span class="ss">:supplier</span><span class="p">,</span> <span class="ss">:author</span><span class="p">]}).</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.includes(orders: {books: [:supplier, :author]}).find(1)
">Copy</button>
</div>
<p>這將找到 id 為 1 的客戶並急切載入它的所有相關訂單、所有訂單的書籍以及每本書的作者和供應商。</p><h5 id="association"><a class="anchorlink" href="#association">14.1.3 在急切載入的 Association 上指定條件</a></h5><p>儘管 Active Record 允許您在預先載入的 associations 上指定條件，就像 <code>joins</code> 一樣，但推薦的方法是使用 <a href="#joining-tables">joins</a> 代替。</p><p>但是，如果您必須這樣做，您可以像往常一樣使用 <code>where</code>。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Author</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:books</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">books: </span><span class="p">{</span> <span class="ss">out_of_print: </span><span class="kp">true</span> <span class="p">})</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Author.includes(:books).where(books: { out_of_print: true })
">Copy</button>
</div>
<p>這將生成一個包含 <code>LEFT OUTER JOIN</code> 的查詢，而
<code>joins</code> 方法將使用 <code>INNER JOIN</code> 函式生成一個。</p><div class="code_container">
<pre><code class="highlight sql">  <span class="k">SELECT</span> <span class="n">authors</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">t0_r0</span><span class="p">,</span> <span class="p">...</span> <span class="n">books</span><span class="p">.</span><span class="n">updated_at</span> <span class="k">AS</span> <span class="n">t1_r5</span> <span class="k">FROM</span> <span class="n">authors</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="nv">"books"</span> <span class="k">ON</span> <span class="nv">"books"</span><span class="p">.</span><span class="nv">"author_id"</span> <span class="o">=</span> <span class="nv">"authors"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">books</span><span class="p">.</span><span class="n">out_of_print</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='  SELECT authors.id AS t0_r0, ... books.updated_at AS t1_r5 FROM authors LEFT OUTER JOIN "books" ON "books"."author_id" = "authors"."id" WHERE (books.out_of_print = 1)
'>Copy</button>
</div>
<p>如果沒有 <code>where</code> 條件，這將生成兩個查詢的正常集合。</p><div class="note"><p>像這樣使用 <code>where</code> 只會在你傳遞一個雜湊時才有效。為了
您需要使用 <code>references</code> 來強制連線表的 SQL 片段：</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Author</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:books</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="s2">"books.out_of_print = true"</span><span class="p">).</span><span class="nf">references</span><span class="p">(</span><span class="ss">:books</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Author.includes(:books).where("books.out_of_print = true").references(:books)
'>Copy</button>
</div>
<p>如果在這個 <code>includes</code> 查詢的情況下，沒有任何書籍
作者，所有作者仍將被載入。透過使用 <code>joins</code>（一個 INNER
JOIN)，連線條件<strong>必須</strong>匹配，否則將沒有記錄
回。</p><div class="note"><p>如果 association 作為連線的一部分預先載入，則自定義選擇子句中的任何欄位將不會出現在載入的 models 上。
這是因為它們是應該出現在父記錄中還是出現在子記錄中是不明確的。</p></div><h4 id=""><a class="anchorlink" href="#">14.2 預載入</a></h4><p>使用 <code>preload</code>，活動記錄確保為每個指定的 association 使用查詢載入。</p><p>重新審視使​​用 <code>preload</code> 方法發生 N + 1 的情況，我們可以將 <code>Book.limit(10)</code> 重寫給作者：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">preload</span><span class="p">(</span><span class="ss">:author</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">books</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">last_name</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="books = Book.preload(:author).limit(10)

books.each do |book|
  puts book.author.last_name
end
">Copy</button>
</div>
<p>上面的程式碼將只執行 <strong>2</strong> 查詢，而不是前一種情況下的 <strong>11</strong> 查詢：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="nv">`books`</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">`books`</span> <span class="k">LIMIT</span> <span class="mi">10</span>
<span class="k">SELECT</span> <span class="nv">`authors`</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">`authors`</span>
  <span class="k">WHERE</span> <span class="nv">`authors`</span><span class="p">.</span><span class="nv">`book_id`</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT `books`* FROM `books` LIMIT 10
SELECT `authors`.* FROM `authors`
  WHERE `authors`.`book_id` IN (1,2,3,4,5,6,7,8,9,10)
">Copy</button>
</div>
<div class="note"><p><code>preload</code> 方法使用陣列、雜湊或陣列/雜湊的巢狀雜湊，其方式與包含方法相同，可透過單個 <code>Model.find</code> 呼叫載入任意數量的 associations。但是，與 <code>includes</code> 方法不同，無法為急切載入的 associations 指定條件。</p></div><h4 id="eager-load"><a class="anchorlink" href="#eager-load">14.3 eager_load</a></h4><p>使用 <code>eager_load</code>，Active record 確保透過對所有指定的 associations 使用 <code>LEFT OUTER JOIN</code> 來強制載入。</p><p>重新審視使​​用 <code>eager_load</code> 方法發生 N + 1 的情況，我們可以將 <code>Book.limit(10)</code> 重寫給作者：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">eager_load</span><span class="p">(</span><span class="ss">:author</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">books</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">last_name</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="books = Book.eager_load(:author).limit(10)

books.each do |book|
  puts book.author.last_name
end
">Copy</button>
</div>
<p>上面的程式碼將只執行 <strong>2</strong> 查詢，而不是前一種情況下的 <strong>11</strong> 查詢：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="nv">`books`</span><span class="p">.</span><span class="nv">`id`</span> <span class="k">FROM</span> <span class="nv">`books`</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="nv">`authors`</span> <span class="k">ON</span> <span class="nv">`authors`</span><span class="p">.</span><span class="nv">`book_id`</span> <span class="o">=</span> <span class="nv">`books`</span><span class="p">.</span><span class="nv">`id`</span> <span class="k">LIMIT</span> <span class="mi">10</span>
<span class="k">SELECT</span> <span class="nv">`books`</span><span class="p">.</span><span class="nv">`id`</span> <span class="k">AS</span> <span class="n">t0_r0</span><span class="p">,</span> <span class="nv">`books`</span><span class="p">.</span><span class="nv">`last_name`</span> <span class="k">AS</span> <span class="n">t0_r1</span><span class="p">,</span> <span class="p">...</span>
  <span class="k">FROM</span> <span class="nv">`books`</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="nv">`authors`</span> <span class="k">ON</span> <span class="nv">`authors`</span><span class="p">.</span><span class="nv">`book_id`</span> <span class="o">=</span> <span class="nv">`books`</span><span class="p">.</span><span class="nv">`id`</span>
  <span class="k">WHERE</span> <span class="nv">`books`</span><span class="p">.</span><span class="nv">`id`</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT DISTINCT `books`.`id` FROM `books` LEFT OUTER JOIN `authors` ON `authors`.`book_id` = `books`.`id` LIMIT 10
SELECT `books`.`id` AS t0_r0, `books`.`last_name` AS t0_r1, ...
  FROM `books` LEFT OUTER JOIN `authors` ON `authors`.`book_id` = `books`.`id`
  WHERE `books`.`id` IN (1,2,3,4,5,6,7,8,9,10)
">Copy</button>
</div>
<div class="note"><p><code>eager_load</code> 方法使用陣列、雜湊或陣列/雜湊的巢狀雜湊，其方式與 <code>includes</code> 方法相同，可透過單個 <code>Model.find</code> 呼叫載入任意數量的 associations。此外，與 <code>includes</code> 方法一樣，您可以指定預先載入關聯的條件。</p></div><h3 id=""><a class="anchorlink" href="#">15 範圍</a></h3><p>範圍允許您指定常用的查詢，這些查詢可以作為對 association 物件或 models 的方法呼叫進行引用。透過這些範圍，您可以使用之前介紹的每種方法，例如 <code>where</code>、<code>joins</code> 和 <code>includes</code>。所有範圍主體都應返回 <code>ActiveRecord::Relation</code> 或 <code>nil</code> 以允許對其呼叫進一步的方法（例如其他範圍）。</p><p>要定義一個簡單的作用域，我們在類中使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Scoping/Named/ClassMethods.html#method-i-scope"><code>scope</code></a> 方法，傳遞我們希望在呼叫此作用域時執行的查詢：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">scope</span> <span class="ss">:out_of_print</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  scope :out_of_print, -&gt; { where(out_of_print: true) }
end
">Copy</button>
</div>
<p>要呼叫此 <code>out_of_print</code> 範圍，我們可以在任一類上呼叫它：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">out_of_print</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Relation</span><span class="kt">&gt;</span> <span class="c1"># all out of print books</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.out_of_print
">Copy</button>
</div>
<p>或者在由 <code>Book</code> 物件組成的 association 上：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">out_of_print</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Relation</span><span class="kt">&gt;</span> <span class="c1"># all out of print books by `author`</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author = Author.first
author.books.out_of_print
">Copy</button>
</div>
<p>範圍也可以在範圍內連結：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">scope</span> <span class="ss">:out_of_print</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:out_of_print_and_expensive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">out_of_print</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"price &gt; 500"</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Book &lt; ApplicationRecord
  scope :out_of_print, -&gt; { where(out_of_print: true) }
  scope :out_of_print_and_expensive, -&gt; { out_of_print.where("price &gt; 500") }
end
'>Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">15.1 傳入引數</a></h4><p>您的範圍可以接受引數：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">scope</span> <span class="ss">:costs_more_than</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s2">"price &gt; ?"</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Book &lt; ApplicationRecord
  scope :costs_more_than, -&gt;(amount) { where("price &gt; ?", amount) }
end
'>Copy</button>
</div>
<p>像呼叫類方法一樣呼叫作用域：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">costs_more_than</span><span class="p">(</span><span class="mf">100.10</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.costs_more_than(100.10)
">Copy</button>
</div>
<p>但是，這只是複製了類方法提供給您的功能。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">costs_more_than</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"price &gt; ?"</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Book &lt; ApplicationRecord
  def self.costs_more_than(amount)
    where("price &gt; ?", amount)
  end
end
'>Copy</button>
</div>
<p>這些方法仍然可以在 association 物件上訪問：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">costs_more_than</span><span class="p">(</span><span class="mf">100.10</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="author.books.costs_more_than(100.10)
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">15.2 使用條件</a></h4><p>您的範圍可以使用條件：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">scope</span> <span class="ss">:created_before</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s2">"created_at &lt; ?"</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">present?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Order &lt; ApplicationRecord
  scope :created_before, -&gt;(time) { where("created_at &lt; ?", time) if time.present? }
end
'>Copy</button>
</div>
<p>與其他示例一樣，這將類似於類方法。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">created_before</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"created_at &lt; ?"</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="k">if</span> <span class="n">time</span><span class="p">.</span><span class="nf">present?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Order &lt; ApplicationRecord
  def self.created_before(time)
    where("created_at &lt; ?", time) if time.present?
  end
end
'>Copy</button>
</div>
<p>但是，有一個重要的警告：作用域將始終返回 <code>ActiveRecord::Relation</code> 物件，即使條件評估為 <code>false</code>，而類方法將返回 <code>nil</code>。如果任何條件返回 <code>false</code>，則在使用條件連結類方法時，這可能會導致 <code>NoMethodError</code>。</p><h4 id=""><a class="anchorlink" href="#">15.3 應用預設範圍</a></h4><p>如果我們希望將範圍應用於 model 的所有查詢，我們可以使用
<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Scoping/Default/ClassMethods.html#method-i-default_scope"><code>default_scope</code></a> 方法在 model 本身中。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  default_scope { where(out_of_print: false) }
end
">Copy</button>
</div>
<p>當在這個 model 上執行查詢時，SQL 查詢現在看起來像
這：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">books</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">out_of_print</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM books WHERE (out_of_print = false)
">Copy</button>
</div>
<p>如果您需要使用預設範圍做更復雜的事情，您也可以
將其定義為類方法：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">default_scope</span>
    <span class="c1"># Should return an ActiveRecord::Relation.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  def self.default_scope
    # Should return an ActiveRecord::Relation.
  end
end
">Copy</button>
</div>
<div class="note"><p>在建立/建立記錄時也會應用 <code>default_scope</code>
當範圍引數作為 <code>Hash</code> 給出時。它不適用，而
更新記錄。例如。：</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  default_scope { where(out_of_print: false) }
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Book</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">out_of_print: </span><span class="kp">false</span><span class="kt">&gt;</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">unscoped</span><span class="p">.</span><span class="nf">new</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Book</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">out_of_print: </span><span class="kp">nil</span><span class="kt">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.new
Book.unscoped.new
">Copy</button>
</div>
<p>請注意，當以 <code>Array</code> 格式給出時，<code>default_scope</code> 查詢引數
對於預設屬性分配，無法轉換為 <code>Hash</code>。例如。：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s2">"out_of_print = ?"</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Book &lt; ApplicationRecord
  default_scope { where("out_of_print = ?", false) }
end
'>Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Book</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">out_of_print: </span><span class="kp">nil</span><span class="kt">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.new
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">15.4 合併範圍</a></h4><p>就像 <code>where</code> 子句一樣，範圍使用 <code>AND</code> 條件合併。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">scope</span> <span class="ss">:in_print</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:out_of_print</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">true</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">'year_published &gt;= ?'</span><span class="p">,</span> <span class="no">Date</span><span class="p">.</span><span class="nf">current</span><span class="p">.</span><span class="nf">year</span> <span class="o">-</span> <span class="mi">50</span> <span class="p">)}</span>
  <span class="n">scope</span> <span class="ss">:old</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">'year_published &lt; ?'</span><span class="p">,</span> <span class="no">Date</span><span class="p">.</span><span class="nf">current</span><span class="p">.</span><span class="nf">year</span> <span class="o">-</span> <span class="mi">50</span> <span class="p">)}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  scope :in_print, -&gt; { where(out_of_print: false) }
  scope :out_of_print, -&gt; { where(out_of_print: true) }

  scope :recent, -&gt; { where('year_published &gt;= ?', Date.current.year - 50 )}
  scope :old, -&gt; { where('year_published &lt; ?', Date.current.year - 50 )}
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">out_of_print</span><span class="p">.</span><span class="nf">old</span>
<span class="go">SELECT books.* FROM books WHERE books.out_of_print = 'true' AND books.year_published &lt; 1969
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Book.out_of_print.old
">Copy</button>
</div>
<p>我們可以混合匹配 <code>scope</code> 和 <code>where</code> 條件和最終的 SQL
將所有條件加入 <code>AND</code>。</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">in_print</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'price &lt; 100'</span><span class="p">)</span>
<span class="go">SELECT books.* FROM books WHERE books.out_of_print = 'false' AND books.price &lt; 100
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Book.in_print.where('price &lt; 100')
">Copy</button>
</div>
<p>如果我們確實希望最後一個 <code>where</code> 子句獲勝，那麼 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/SpawnMethods.html#method-i-merge"><code>merge</code></a> 可以
使用。</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">in_print</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="no">Book</span><span class="p">.</span><span class="nf">out_of_print</span><span class="p">)</span>
<span class="go">SELECT books.* FROM books WHERE books.out_of_print = true
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Book.in_print.merge(Book.out_of_print)
">Copy</button>
</div>
<p>一個重要的警告是 <code>default_scope</code> 將被新增到
<code>scope</code> 和 <code>where</code> 條件。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">'year_published &gt;= ?'</span><span class="p">,</span> <span class="no">Date</span><span class="p">.</span><span class="nf">current</span><span class="p">.</span><span class="nf">year</span> <span class="o">-</span> <span class="mi">50</span> <span class="p">)}</span>

  <span class="n">scope</span> <span class="ss">:in_print</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:out_of_print</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
  default_scope { where('year_published &gt;= ?', Date.current.year - 50 )}

  scope :in_print, -&gt; { where(out_of_print: false) }
  scope :out_of_print, -&gt; { where(out_of_print: true) }
end
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">all</span>
<span class="go">SELECT books.* FROM books WHERE (year_published &gt;= 1969)
</span><span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">in_print</span>
<span class="go">SELECT books.* FROM books WHERE (year_published &gt;= 1969) AND books.out_of_print = true
</span><span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'price &gt; 50'</span><span class="p">)</span>
<span class="go">SELECT books.* FROM books WHERE (year_published &gt;= 1969) AND (price &gt; 50)
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Book.all
Book.in_print
Book.where('price &gt; 50')
">Copy</button>
</div>
<p>正如您在上面看到的，<code>default_scope</code> 正在合併
<code>scope</code> 和 <code>where</code> 條件。</p><h4 id=""><a class="anchorlink" href="#">15.5 刪除所有範圍</a></h4><p>如果我們出於任何原因希望刪除範圍，我們可以使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Scoping/Default/ClassMethods.html#method-i-unscoped"><code>unscoped</code></a> 方法。這是
如果在 model 中指定了 <code>default_scope</code> 並且不應被指定，則特別有用
申請了這個特定的查詢。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span><span class="p">.</span><span class="nf">unscoped</span><span class="p">.</span><span class="nf">load</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.unscoped.load
">Copy</button>
</div>
<p>此方法刪除所有範圍並將對錶進行正常查詢。</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">unscoped</span><span class="p">.</span><span class="nf">all</span>
<span class="go">SELECT books.* FROM books
</span><span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">true</span><span class="p">).</span><span class="nf">unscoped</span><span class="p">.</span><span class="nf">all</span>
<span class="go">SELECT books.* FROM books
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Book.unscoped.all
Book.where(out_of_print: true).unscoped.all
">Copy</button>
</div>
<p><code>unscoped</code> 也可以接受一個塊：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">unscoped</span> <span class="p">{</span> <span class="no">Book</span><span class="p">.</span><span class="nf">out_of_print</span> <span class="p">}</span>
<span class="go">SELECT books.* FROM books WHERE books.out_of_print
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Book.unscoped { Book.out_of_print }
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">16 動態查詢器</a></h3><p>對於您在表中定義的每個欄位（也稱為屬性），
Active Record 提供了一個 finder 方法。例如，如果您在 <code>Customer</code> model 上有一個名為 <code>first_name</code> 的欄位，
您可以從 Active Record 免費獲得實例方法 <code>find_by_first_name</code>。
如果你在 <code>Customer</code> model 上也有 <code>locked</code> 欄位，你也會得到 <code>find_by_locked</code> 方法。</p><p>您可以在動態查詢器的末尾指定一個感嘆號 (<code>!</code>)
讓他們在不返回任何記錄時引發 <code>ActiveRecord::RecordNotFound</code> 錯誤，例如 <code>Customer.find_by_name!("Ryan")</code></p><p>如果您想同時透過 <code>name</code> 和 <code>orders_count</code> 查詢，您只需在欄位之間鍵入“<code>and</code>”即可將這些查詢器連結在一起。
例如，<code>Customer.find_by_first_name_and_orders_count("Ryan", 5)</code>。</p><h3 id=""><a class="anchorlink" href="#">17 列舉</a></h3><p>列舉允許您為屬性定義一個 values 陣列並按名稱引用它們。儲存在資料庫中的實際值是一個已對映到 values 之一的整數。</p><p>宣告一個列舉將：</p>
<ul>
<li>建立可用於查詢具有或不具有列舉 values 之一的所有物件的範圍</li>
<li>建立一個實例方法，可用於確定物件是否具有列舉的特定 value</li>
<li>建立一個實例方法，可用於更改物件的列舉 value</li>
</ul>
<p>對於列舉的所有可能的 values。</p><p>例如，給定這個 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Enum.html#method-i-enum"><code>enum</code></a> 宣告：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Order</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">enum</span> <span class="ss">:status</span><span class="p">,</span> <span class="p">[</span><span class="ss">:shipped</span><span class="p">,</span> <span class="ss">:being_packaged</span><span class="p">,</span> <span class="ss">:complete</span><span class="p">,</span> <span class="ss">:cancelled</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class Order &lt; ApplicationRecord
  enum :status, [:shipped, :being_packaged, :complete, :cancelled]
end
">Copy</button>
</div>
<p>這些 <a href="#scopes">範圍</a> 是自動建立的，可用於為 <code>status</code> 查詢帶有或不帶有特定 value 的所有物件：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Order</span><span class="p">.</span><span class="nf">shipped</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Relation</span><span class="kt">&gt;</span> <span class="c1"># all orders with status == :shipped</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Order</span><span class="p">.</span><span class="nf">not_shipped</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Relation</span><span class="kt">&gt;</span> <span class="c1"># all orders with status != :shipped</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Order.shipped
Order.not_shipped
">Copy</button>
</div>
<p>這些實例方法是自動建立的，並查詢 model 是否具有 <code>status</code> 列舉的 value：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">shipped</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="nf">shipped?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="nf">complete?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="order = Order.shipped.first
order.shipped?
order.complete?
">Copy</button>
</div>
<p>這些實例方法是自動建立的，會先更新 <code>status</code> 的 value 為命名的 value
然後查詢狀態是否已成功設定為value：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">order</span> <span class="o">=</span> <span class="no">Order</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="nf">shipped!</span>
<span class="go">UPDATE "orders" SET "status" = ?, "updated_at" = ? WHERE "orders"."id" = ?  [["status", 0], ["updated_at", "2019-01-24 07:13:08.524320"], ["id", 1]]
</span><span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="order = Order.first
order.shipped!
">Copy</button>
</div>
<p>關於列舉的完整文件可以在<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Enum.html">這裡</a>找到。</p><h3 id=""><a class="anchorlink" href="#">18 理解方法鏈</a></h3><p>Active Record 模式實現了<a href="https://en.wikipedia.org/wiki/Method_chaining">方法鏈</a>，
這允許我們以簡單直接的方式一起使用多個 Active Record 方法。</p><p>當先前呼叫的方法返回一個語句時，您可以在語句中連結方法
<a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Relation.html"><code>ActiveRecord::Relation</code></a>，例如 <code>all</code>、<code>where</code> 和 <code>joins</code>。返回的方法
單個物件（參見 <a href="#retrieving-a-single-object">檢索單個物件部分</a>）
必須在語句的末尾。</p><p>下面有一些例子。本指南不會涵蓋所有可能性，僅舉幾個例子。
當呼叫 Active Record 方法時，查詢不會立即生成併發送到資料庫。
僅在實際需要資料時才傳送查詢。因此，下面的每個示例都會生成一個查詢。</p><h4 id=""><a class="anchorlink" href="#">18.1 從多個表中檢索過濾資料</a></h4><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span>
  <span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s1">'customers.id, customers.last_name, reviews.body'</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:reviews</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s1">'reviews.created_at &gt; ?'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="nf">week</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer
  .select('customers.id, customers.last_name, reviews.body')
  .joins(:reviews)
  .where('reviews.created_at &gt; ?', 1.week.ago)
">Copy</button>
</div>
<p>結果應該是這樣的：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">customers</span><span class="p">.</span><span class="n">last_name</span><span class="p">,</span> <span class="n">reviews</span><span class="p">.</span><span class="n">body</span>
<span class="k">FROM</span> <span class="n">customers</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">reviews</span>
  <span class="k">ON</span> <span class="n">reviews</span><span class="p">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">reviews</span><span class="p">.</span><span class="n">created_at</span> <span class="o">&gt;</span> <span class="s1">'2019-01-08'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT customers.id, customers.last_name, reviews.body
FROM customers
INNER JOIN reviews
  ON reviews.customer_id = customers.id
WHERE (reviews.created_at &gt; '2019-01-08')
">Copy</button>
</div>
<h4 id=""><a class="anchorlink" href="#">18.2 從多個表中檢索特定資料</a></h4><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Book</span>
  <span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s1">'books.id, books.title, authors.first_name'</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:author</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">title: </span><span class="s1">'Abstraction and Specification in Program Development'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book
  .select('books.id, books.title, authors.first_name')
  .joins(:author)
  .find_by(title: 'Abstraction and Specification in Program Development')
">Copy</button>
</div>
<p>以上應生成：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="n">books</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">books</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="n">authors</span><span class="p">.</span><span class="n">first_name</span>
<span class="k">FROM</span> <span class="n">books</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">authors</span>
  <span class="k">ON</span> <span class="n">authors</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">books</span><span class="p">.</span><span class="n">author_id</span>
<span class="k">WHERE</span> <span class="n">books</span><span class="p">.</span><span class="n">title</span> <span class="o">=</span> <span class="err">$</span><span class="mi">1</span> <span class="p">[[</span><span class="nv">"title"</span><span class="p">,</span> <span class="nv">"Abstraction and Specification in Program Development"</span><span class="p">]]</span>
<span class="k">LIMIT</span> <span class="mi">1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='SELECT books.id, books.title, authors.first_name
FROM books
INNER JOIN authors
  ON authors.id = books.author_id
WHERE books.title = $1 [["title", "Abstraction and Specification in Program Development"]]
LIMIT 1
'>Copy</button>
</div>
<div class="note"><p>請注意，如果查詢匹配多條記錄，則 <code>find_by</code> 將
只獲取第一個並忽略其他的（參見 <code>LIMIT 1</code>
以上宣告）。</p></div><h3 id=""><a class="anchorlink" href="#">19 查詢或構建新物件</a></h3><p>如果記錄不存在，通常需要查詢或建立記錄。您可以使用 <code>find_or_create_by</code> 和 <code>find_or_create_by!</code> 方法來做到這一點。</p><h4 id="find-or-create-by"><a class="anchorlink" href="#find-or-create-by">19.1 <code>find_or_create_by</code></a></h4><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Relation.html#method-i-find_or_create_by"><code>find_or_create_by</code></a> 方法檢查是否存在具有指定屬性的記錄。如果沒有，則呼叫 <code>create</code>。讓我們看一個例子。</p><p>假設您要查詢名為“Andy”的客戶，如果沒有，則建立一個。您可以透過執行：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">find_or_create_by</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Andy'</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Andy"</span><span class="p">,</span> <span class="ss">last_name: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">title: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">visits: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">orders_count: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">lock_version: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">created_at: </span><span class="s2">"2019-01-17 07:06:45"</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="s2">"2019-01-17 07:06:45"</span><span class="kt">&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.find_or_create_by(first_name: 'Andy')
">Copy</button>
</div>
<p>此方法生成的 SQL 如下所示：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">customers</span><span class="p">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">'Andy'</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">1</span>
<span class="k">BEGIN</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">customers</span> <span class="p">(</span><span class="n">created_at</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">locked</span><span class="p">,</span> <span class="n">orders_count</span><span class="p">,</span> <span class="n">updated_at</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'2011-08-30 05:22:57'</span><span class="p">,</span> <span class="s1">'Andy'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="s1">'2011-08-30 05:22:57'</span><span class="p">)</span>
<span class="k">COMMIT</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers WHERE (customers.first_name = 'Andy') LIMIT 1
BEGIN
INSERT INTO customers (created_at, first_name, locked, orders_count, updated_at) VALUES ('2011-08-30 05:22:57', 'Andy', 1, NULL, '2011-08-30 05:22:57')
COMMIT
">Copy</button>
</div>
<p><code>find_or_create_by</code> 返回已存在的記錄或新記錄。在我們的例子中，我們還沒有名為 Andy 的客戶，因此會建立並返回記錄。</p><p>新記錄可能不會儲存到資料庫中；這取決於驗證是否透過（就像 <code>create</code> 一樣）。</p><p>假設我們想將 'locked' 屬性設定為 <code>false</code>，如果我們是
建立新記錄，但我們不想將其包含在查詢中。所以
我們想找到名為“Andy”的客戶，或者如果該客戶沒有
存在，建立一個名為“Andy”的未鎖定的客戶。</p><p>我們可以透過兩種方式實現這一點。第一種是使用 <code>create_with</code>：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">create_with</span><span class="p">(</span><span class="ss">locked: </span><span class="kp">false</span><span class="p">).</span><span class="nf">find_or_create_by</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Andy'</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.create_with(locked: false).find_or_create_by(first_name: 'Andy')
">Copy</button>
</div>
<p>第二種方法是使用塊：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">find_or_create_by</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Andy'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">locked</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.find_or_create_by(first_name: 'Andy') do |c|
  c.locked = false
end
">Copy</button>
</div>
<p>只有在建立客戶時才會執行該塊。這
第二次執行此程式碼時，該塊將被忽略。</p><h4 id="find-or-create-by-bang"><a class="anchorlink" href="#find-or-create-by-bang">19.2 <code>find_or_create_by!</code></a></h4><p>如果新記錄無效，您還可以使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Relation.html#method-i-find_or_create_by-21"><code>find_or_create_by!</code></a> 引發異常。本指南未涵蓋驗證，但讓我們暫時假設您暫時新增</p><div class="code_container">
<pre><code class="highlight ruby"><span class="n">validates</span> <span class="ss">:orders_count</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="validates :orders_count, presence: true
">Copy</button>
</div>
<p>到您的 <code>Customer</code> model。如果您嘗試建立新的 <code>Customer</code> 而不傳遞 <code>orders_count</code>，則記錄將無效並引發異常：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">find_or_create_by!</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Andy'</span><span class="p">)</span>
<span class="go">ActiveRecord::RecordInvalid: Validation failed: Orders count can't be blank
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.find_or_create_by!(first_name: 'Andy')
">Copy</button>
</div>
<h4 id="find-or-initialize-by"><a class="anchorlink" href="#find-or-initialize-by">19.3 <code>find_or_initialize_by</code></a></h4><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Relation.html#method-i-find_or_initialize_by"><code>find_or_initialize_by</code></a> 方法將像
<code>find_or_create_by</code> 但它會呼叫 <code>new</code> 而不是 <code>create</code>。這
意味著將在記憶體中建立一個新的 model 實例但不會
儲存到資料庫中。繼續 <code>find_or_create_by</code> 示例，我們
現在想要名為“Nina”的客戶：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">nina</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">find_or_initialize_by</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Nina'</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Nina"</span><span class="p">,</span> <span class="ss">orders_count: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">locked: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">created_at: </span><span class="s2">"2011-08-30 06:09:27"</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="s2">"2011-08-30 06:09:27"</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">nina</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">nina</span><span class="p">.</span><span class="nf">new_record?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="nina = Customer.find_or_initialize_by(first_name: 'Nina')
nina.persisted?
nina.new_record?
">Copy</button>
</div>
<p>因為物件還沒有儲存在資料庫中，所以生成的 SQL 如下所示：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">customers</span><span class="p">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">'Nina'</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">1</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT * FROM customers WHERE (customers.first_name = 'Nina') LIMIT 1
">Copy</button>
</div>
<p>當你想把它儲存到資料庫時，只需呼叫 <code>save</code>：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">nina</span><span class="p">.</span><span class="nf">save</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="nina.save
">Copy</button>
</div>
<h3 id="sql"><a class="anchorlink" href="#sql">20 透過 SQL 查詢</a></h3><p>如果您想使用自己的 SQL 在表中查詢記錄，您可以使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Querying.html#method-i-find_by_sql"><code>find_by_sql</code></a>。即使底層查詢只返回一條記錄，<code>find_by_sql</code> 方法也將返回一個物件陣列。例如，您可以執行此查詢：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">find_by_sql</span><span class="p">(</span><span class="s2">"SELECT * FROM customers INNER JOIN orders ON customers.id = orders.customer_id ORDER BY customers.created_at desc"</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Lucas"</span> <span class="o">...</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Jan"</span> <span class="o">...</span><span class="kt">&gt;</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Customer.find_by_sql("SELECT * FROM customers INNER JOIN orders ON customers.id = orders.customer_id ORDER BY customers.created_at desc")
'>Copy</button>
</div>
<p><code>find_by_sql</code> 為您提供了一種對資料庫進行自定義呼叫和檢索實例化物件的簡單方法。</p><h4 id="select-all"><a class="anchorlink" href="#select-all">20.1 <code>select_all</code></a></h4><p><code>find_by_sql</code> 有一個近親叫做 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/ConnectionAdapters/DatabaseStatements.html#method-i-select_all"><code>connection.select_all</code></a>。 <code>select_all</code> 將檢索
使用自定義 SQL 的資料庫中的物件，就像 <code>find_by_sql</code> 一樣，但不會實例化它們。
此方法將返回 <code>ActiveRecord::Result</code> 類的實例並在此上呼叫 <code>to_a</code>
object 將返回一個雜湊陣列，其中每個散列表示一條記錄。</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">select_all</span><span class="p">(</span><span class="s2">"SELECT first_name, created_at FROM customers WHERE id = '1'"</span><span class="p">).</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[{</span><span class="s2">"first_name"</span><span class="o">=&gt;</span><span class="s2">"Rafael"</span><span class="p">,</span> <span class="s2">"created_at"</span><span class="o">=&gt;</span><span class="s2">"2012-11-10 23:23:45.281189"</span><span class="p">},</span> <span class="p">{</span><span class="s2">"first_name"</span><span class="o">=&gt;</span><span class="s2">"Eileen"</span><span class="p">,</span> <span class="s2">"created_at"</span><span class="o">=&gt;</span><span class="s2">"2013-12-09 11:22:35.221282"</span><span class="p">}]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.connection.select_all(&quot;SELECT first_name, created_at FROM customers WHERE id = '1'&quot;).to_a
">Copy</button>
</div>
<h4 id="pluck"><a class="anchorlink" href="#pluck">20.2 <code>pluck</code></a></h4><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Calculations.html#method-i-pluck"><code>pluck</code></a> 可用於從 model 的底層表中查詢單列或多列。它接受列名列表作為引數，並返回具有相應資料型別的指定列的 values 陣列。</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">true</span><span class="p">).</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
<span class="go">SELECT id FROM books WHERE out_of_print = false
</span><span class="p">=&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Order</span><span class="p">.</span><span class="nf">distinct</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:status</span><span class="p">)</span>
<span class="go">SELECT DISTINCT status FROM orders
</span><span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"shipped"</span><span class="p">,</span> <span class="s2">"being_packed"</span><span class="p">,</span> <span class="s2">"cancelled"</span><span class="p">]</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:first_name</span><span class="p">)</span>
<span class="go">SELECT customers.id, customers.first_name FROM customers
</span><span class="p">=&gt;</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"David"</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s2">"Fran"</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="s2">"Jose"</span><span class="p">]]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Book.where(out_of_print: true).pluck(:id)
Order.distinct.pluck(:status)
Customer.pluck(:id, :first_name)
">Copy</button>
</div>
<p><code>pluck</code> 可以替換如下程式碼：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span>
<span class="err">＃</span> <span class="err">或者</span>
<span class="no">Customer</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
<span class="err">＃</span> <span class="err">或者</span>
<span class="no">Customer</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:first_name</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="p">[</span><span class="n">c</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="nf">first_name</span><span class="p">]</span> <span class="p">}</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.select(:id).map { |c| c.id }
＃ 或者
Customer.select(:id).map(&amp;:id)
＃ 或者
Customer.select(:id, :first_name).map { |c| [c.id, c.first_name] }
">Copy</button>
</div>
<p>和：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
<span class="err">＃</span> <span class="err">或者</span>
<span class="no">Customer</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:first_name</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.pluck(:id)
＃ 或者
Customer.pluck(:id, :first_name)
">Copy</button>
</div>
<p>與<code>select</code>不同，<code>pluck</code>直接將資料庫結果轉換成Ruby <code>Array</code>，
不構造 <code>ActiveRecord</code> 物件。這可能意味著更好的效能
大型或頻繁執行的查詢。但是，任何 model 方法覆蓋都將
不可用。例如：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Customer</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="k">def</span> <span class="nf">name</span>
    <span class="s2">"I am </span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Customer &lt; ApplicationRecord
  def name
    "I am #{first_name}"
  end
end
'>Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">).</span><span class="nf">map</span> <span class="o">&amp;</span><span class="ss">:name</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"I am David"</span><span class="p">,</span> <span class="s2">"I am Jeremy"</span><span class="p">,</span> <span class="s2">"I am Jose"</span><span class="p">]</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"David"</span><span class="p">,</span> <span class="s2">"Jeremy"</span><span class="p">,</span> <span class="s2">"Jose"</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.select(:first_name).map &amp;:name
Customer.pluck(:first_name)
">Copy</button>
</div>
<p>您不僅可以從單個表中查詢欄位，還可以查詢多個表。</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Order</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:customer</span><span class="p">,</span> <span class="ss">:books</span><span class="p">).</span><span class="nf">pluck</span><span class="p">(</span><span class="s2">"orders.created_at, customers.email, books.title"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Order.joins(:customer, :books).pluck("orders.created_at, customers.email, books.title")
'>Copy</button>
</div>
<p>此外，與 <code>select</code> 和其他 <code>Relation</code> 作用域不同，<code>pluck</code> 會立即觸發
查詢，因此不能與任何其他範圍連結，儘管它可以與
之前已經構建的範圍：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="gr">NoMethodError: undefined method `limit' for #&lt;Array:0x007ff34d3ad6d8&gt;
</span><span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:first_name</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"David"</span><span class="p">]</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.pluck(:first_name).limit(1)
Customer.limit(1).pluck(:first_name)
">Copy</button>
</div>
<div class="note"><p>您還應該知道，如果關係物件包含包含 values，則使用 <code>pluck</code> 將觸發預載入，即使查詢不需要預載入。例如：</p></div><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">assoc</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:reviews</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">assoc</span><span class="p">.</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
<span class="go">SELECT "customers"."id" FROM "customers" LEFT OUTER JOIN "reviews" ON "reviews"."id" = "customers"."review_id"
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="assoc = Customer.includes(:reviews)
assoc.pluck(:id)
">Copy</button>
</div>
<p>避免這種情況的一種方法是 <code>unscope</code> 包括：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">assoc</span><span class="p">.</span><span class="nf">unscope</span><span class="p">(</span><span class="ss">:includes</span><span class="p">).</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="assoc.unscope(:includes).pluck(:id)
">Copy</button>
</div>
<h4 id="ids"><a class="anchorlink" href="#ids">20.3 <code>ids</code></a></h4><p><a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Calculations.html#method-i-ids"><code>ids</code></a> 可用於使用表的主要 key 提取關係的所有 ID。</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">ids</span>
<span class="go">SELECT id FROM customers
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.ids
">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">Customer</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="s2">"customer_id"</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class Customer &lt; ApplicationRecord
  self.primary_key = "customer_id"
end
'>Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">ids</span>
<span class="go">SELECT customer_id FROM customers
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.ids
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">21 物件的存在</a></h3><p>如果您只是想檢查物件是否存在，則有一個名為 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F"><code>exists?</code></a> 的方法。
此方法將使用與 <code>find</code> 相同的查詢來查詢資料庫，但不會返回一個
物件或物件集合，它將返回 <code>true</code> 或 <code>false</code>。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.exists?(1)
">Copy</button>
</div>
<p><code>exists?</code> 方法也需要多個 values，但問題是它會返回 <code>true</code> 如果有的話
存在這些記錄之一。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="ss">id: </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="err">＃</span> <span class="err">或者</span>
<span class="no">Customer</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="ss">first_name: </span><span class="p">[</span><span class="s1">'Jane'</span><span class="p">,</span> <span class="s1">'Sergei'</span><span class="p">])</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.exists?(id: [1,2,3])
＃ 或者
Customer.exists?(first_name: ['Jane', 'Sergei'])
">Copy</button>
</div>
<p>甚至可以在 model 或關係上使用沒有任何引數的 <code>exists?</code>。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Ryan'</span><span class="p">).</span><span class="nf">exists?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.where(first_name: 'Ryan').exists?
">Copy</button>
</div>
<p>如果至少有一個客戶具有 <code>first_name</code> 'Ryan' 和 <code>false</code>，則上述返回 <code>true</code>
否則。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">exists?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.exists?
">Copy</button>
</div>
<p>如果 <code>customers</code> 表為空，則以上返回 <code>false</code>，否則返回 <code>true</code>。</p><p>您還可以使用 <code>any?</code> 和 <code>many?</code> 來檢查 model 或關係是否存在。 <code>many?</code> 將使用 SQL <code>count</code> 來確定該專案是否存在。</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># 透過 model</span>
<span class="no">Order</span><span class="p">.</span><span class="nf">any?</span>   <span class="c1"># =&gt; SELECT 1 AS one FROM orders</span>
<span class="no">Order</span><span class="p">.</span><span class="nf">many?</span>  <span class="c1"># =&gt; SELECT COUNT(*) FROM orders</span>

<span class="c1"># 透過命名範圍</span>
<span class="no">Order</span><span class="p">.</span><span class="nf">shipped</span><span class="p">.</span><span class="nf">any?</span>   <span class="c1"># =&gt; SELECT 1 AS one FROM orders WHERE orders.status = 0</span>
<span class="no">Order</span><span class="p">.</span><span class="nf">shipped</span><span class="p">.</span><span class="nf">many?</span>  <span class="c1"># =&gt; SELECT COUNT(*) FROM orders WHERE orders.status = 0</span>

<span class="c1"># 透過關係</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">true</span><span class="p">).</span><span class="nf">any?</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">out_of_print: </span><span class="kp">true</span><span class="p">).</span><span class="nf">many?</span>

<span class="c1"># 透過 association</span>
<span class="no">Customer</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">any?</span>
<span class="no">Customer</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">orders</span><span class="p">.</span><span class="nf">many?</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# 透過 model
Order.any?   # =&gt; SELECT 1 AS one FROM orders
Order.many?  # =&gt; SELECT COUNT(*) FROM orders

# 透過命名範圍
Order.shipped.any?   # =&gt; SELECT 1 AS one FROM orders WHERE orders.status = 0
Order.shipped.many?  # =&gt; SELECT COUNT(*) FROM orders WHERE orders.status = 0

# 透過關係
Book.where(out_of_print: true).any?
Book.where(out_of_print: true).many?

# 透過 association
Customer.first.orders.any?
Customer.first.orders.many?
">Copy</button>
</div>
<h3 id=""><a class="anchorlink" href="#">22 計算</a></h3><p>本節使用 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Calculations.html#method-i-count"><code>count</code></a> 作為本序言中的示例方法，但所描述的選項適用於所有子節。</p><p>所有計算方法都直接在 model 上工作：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">count</span>
<span class="go">SELECT COUNT(*) FROM customers
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.count
">Copy</button>
</div>
<p>或者在關係上：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Ryan'</span><span class="p">).</span><span class="nf">count</span>
<span class="go">SELECT COUNT(*) FROM customers WHERE (first_name = 'Ryan')
</span></code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.where(first_name: 'Ryan').count
">Copy</button>
</div>
<p>您還可以在關係上使用各種查詢器方法來執行復雜的計算：</p><div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="s2">"orders"</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Ryan'</span><span class="p">,</span> <span class="ss">orders: </span><span class="p">{</span> <span class="ss">status: </span><span class="s1">'shipped'</span> <span class="p">}).</span><span class="nf">count</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.includes(&quot;orders&quot;).where(first_name: 'Ryan', orders: { status: 'shipped' }).count
">Copy</button>
</div>
<p>哪個將執行：</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">customers</span>
  <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">orders</span> <span class="k">ON</span> <span class="n">orders</span><span class="p">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="n">customers</span><span class="p">.</span><span class="n">id</span>
  <span class="k">WHERE</span> <span class="p">(</span><span class="n">customers</span><span class="p">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">'Ryan'</span> <span class="k">AND</span> <span class="n">orders</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="SELECT COUNT(DISTINCT customers.id) FROM customers
  LEFT OUTER JOIN orders ON orders.customer_id = customers.id
  WHERE (customers.first_name = 'Ryan' AND orders.status = 0)
">Copy</button>
</div>
<p>假設 Order 有 <code>enum status: [ :shipped, :being_packed, :cancelled ]</code>。</p><h4 id=""><a class="anchorlink" href="#">22.1 計數</a></h4><p>如果您想檢視 model 表中有多少條記錄，您可以呼叫 <code>Customer.count</code> 並返回該數字。
如果您想更具體並找到資料庫中存在標題的所有客戶，您可以使用 <code>Customer.count(:title)</code>。</p><p>有關選項，請參閱父部分，<a href="#calculations">計算</a>。</p><h4 id=""><a class="anchorlink" href="#">22.2 平均值</a></h4><p>如果您想檢視某個表中某個數字的平均值，您可以在與該表相關的類上呼叫 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Calculations.html#method-i-average"><code>average</code></a> 方法。這個方法呼叫看起來像這樣：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Order</span><span class="p">.</span><span class="nf">average</span><span class="p">(</span><span class="s2">"subtotal"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Order.average("subtotal")
'>Copy</button>
</div>
<p>這將返回一個數字（可能是一個浮點數，例如 3.14159265），表示該欄位中的平均 value。</p><p>有關選項，請參閱父部分，<a href="#calculations">計算</a>。</p><h4 id=""><a class="anchorlink" href="#">22.3 最小值</a></h4><p>如果要查詢表中某個欄位的最小 value，可以在與該表相關的類上呼叫 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Calculations.html#method-i-minimum"><code>minimum</code></a> 方法。這個方法呼叫看起來像這樣：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Order</span><span class="p">.</span><span class="nf">minimum</span><span class="p">(</span><span class="s2">"subtotal"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Order.minimum("subtotal")
'>Copy</button>
</div>
<p>有關選項，請參閱父部分，<a href="#calculations">計算</a>。</p><h4 id=""><a class="anchorlink" href="#">22.4 最大值</a></h4><p>如果要查詢表中某個欄位的最大 value，可以在與該表相關的類上呼叫 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Calculations.html#method-i-maximum"><code>maximum</code></a> 方法。這個方法呼叫看起來像這樣：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Order</span><span class="p">.</span><span class="nf">maximum</span><span class="p">(</span><span class="s2">"subtotal"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Order.maximum("subtotal")
'>Copy</button>
</div>
<p>有關選項，請參閱父部分，<a href="#calculations">計算</a>。</p><h4 id=""><a class="anchorlink" href="#">22.5 總和</a></h4><p>如果要查詢表中所有記錄的欄位總和，可以在與表相關的類上呼叫 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Calculations.html#method-i-sum"><code>sum</code></a> 方法。這個方法呼叫看起來像這樣：</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Order</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="s2">"subtotal"</span><span class="p">)</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='Order.sum("subtotal")
'>Copy</button>
</div>
<p>有關選項，請參閱父部分，<a href="#calculations">計算</a>。</p><h3 id=""><a class="anchorlink" href="#">23 執行解釋</a></h3><p>您可以在關係上執行 <a href="https://api.rubyonrails.org/v7.0.0/classes/ActiveRecord/Relation.html#method-i-explain"><code>explain</code></a>。 EXPLAIN 輸出因每個資料庫而異。</p><p>例如，執行</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="mi">1</span><span class="p">).</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:orders</span><span class="p">).</span><span class="nf">explain</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.where(id: 1).joins(:orders).explain
">Copy</button>
</div>
<p>可能會屈服</p><div class="code_container">
<pre><code class="highlight plaintext">EXPLAIN for: SELECT `customers`.* FROM `customers` INNER JOIN `orders` ON `orders`.`customer_id` = `customers`.`id` WHERE `customers`.`id` = 1
+----+-------------+------------+-------+---------------+
| id | select_type | table      | type  | possible_keys |
+----+-------------+------------+-------+---------------+
|  1 | SIMPLE      | customers  | const | PRIMARY       |
|  1 | SIMPLE      | orders     | ALL   | NULL          |
+----+-------------+------------+-------+---------------+
+---------+---------+-------+------+-------------+
| key     | key_len | ref   | rows | Extra       |
+---------+---------+-------+------+-------------+
| PRIMARY | 4       | const |    1 |             |
| NULL    | NULL    | NULL  |    1 | Using where |
+---------+---------+-------+------+-------------+

2 rows in set (0.00 sec)
</code></pre>
<button class="clipboard-button" data-clipboard-text="EXPLAIN for: SELECT `customers`.* FROM `customers` INNER JOIN `orders` ON `orders`.`customer_id` = `customers`.`id` WHERE `customers`.`id` = 1
+----+-------------+------------+-------+---------------+
| id | select_type | table      | type  | possible_keys |
+----+-------------+------------+-------+---------------+
|  1 | SIMPLE      | customers  | const | PRIMARY       |
|  1 | SIMPLE      | orders     | ALL   | NULL          |
+----+-------------+------------+-------+---------------+
+---------+---------+-------+------+-------------+
| key     | key_len | ref   | rows | Extra       |
+---------+---------+-------+------+-------------+
| PRIMARY | 4       | const |    1 |             |
| NULL    | NULL    | NULL  |    1 | Using where |
+---------+---------+-------+------+-------------+

2 rows in set (0.00 sec)
">Copy</button>
</div>
<p>在 MySQL 和 MariaDB 下。</p><p>Active Record 執行漂亮的列印，模擬
對應的資料庫外殼。因此，使用相同的查詢執行
PostgreSQL 介面卡將改為 yield</p><div class="code_container">
<pre><code class="highlight plaintext">EXPLAIN for: SELECT "customers".* FROM "customers" INNER JOIN "orders" ON "orders"."customer_id" = "customers"."id" WHERE "customers"."id" = $1 [["id", 1]]
                                  QUERY PLAN
------------------------------------------------------------------------------
 Nested Loop  (cost=4.33..20.85 rows=4 width=164)
    -&gt;  Index Scan using customers_pkey on customers  (cost=0.15..8.17 rows=1 width=164)
          Index Cond: (id = '1'::bigint)
    -&gt;  Bitmap Heap Scan on orders  (cost=4.18..12.64 rows=4 width=8)
          Recheck Cond: (customer_id = '1'::bigint)
          -&gt;  Bitmap Index Scan on index_orders_on_customer_id  (cost=0.00..4.18 rows=4 width=0)
                Index Cond: (customer_id = '1'::bigint)
(7 rows)
</code></pre>
<button class="clipboard-button" data-clipboard-text="EXPLAIN for: SELECT &quot;customers&quot;.* FROM &quot;customers&quot; INNER JOIN &quot;orders&quot; ON &quot;orders&quot;.&quot;customer_id&quot; = &quot;customers&quot;.&quot;id&quot; WHERE &quot;customers&quot;.&quot;id&quot; = $1 [[&quot;id&quot;, 1]]
                                  QUERY PLAN
------------------------------------------------------------------------------
 Nested Loop  (cost=4.33..20.85 rows=4 width=164)
    -&gt;  Index Scan using customers_pkey on customers  (cost=0.15..8.17 rows=1 width=164)
          Index Cond: (id = '1'::bigint)
    -&gt;  Bitmap Heap Scan on orders  (cost=4.18..12.64 rows=4 width=8)
          Recheck Cond: (customer_id = '1'::bigint)
          -&gt;  Bitmap Index Scan on index_orders_on_customer_id  (cost=0.00..4.18 rows=4 width=0)
                Index Cond: (customer_id = '1'::bigint)
(7 rows)
">Copy</button>
</div>
<p>急切載入可能會在幕後觸發多個查詢，並且一些查詢
可能需要以前的結果。正因為如此，<code>explain</code> 實際上
執行查詢，然後詢問查詢計劃。例如，</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="mi">1</span><span class="p">).</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:orders</span><span class="p">).</span><span class="nf">explain</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Customer.where(id: 1).includes(:orders).explain
">Copy</button>
</div>
<p>可能會為 MySQL 和 MariaDB 產生這個：</p><div class="code_container">
<pre><code class="highlight plaintext">EXPLAIN for: SELECT `customers`.* FROM `customers`  WHERE `customers`.`id` = 1
+----+-------------+-----------+-------+---------------+
| id | select_type | table     | type  | possible_keys |
+----+-------------+-----------+-------+---------------+
|  1 | SIMPLE      | customers | const | PRIMARY       |
+----+-------------+-----------+-------+---------------+
+---------+---------+-------+------+-------+
| key     | key_len | ref   | rows | Extra |
+---------+---------+-------+------+-------+
| PRIMARY | 4       | const |    1 |       |
+---------+---------+-------+------+-------+

1 row in set (0.00 sec)

EXPLAIN for: SELECT `orders`.* FROM `orders`  WHERE `orders`.`customer_id` IN (1)
+----+-------------+--------+------+---------------+
| id | select_type | table  | type | possible_keys |
+----+-------------+--------+------+---------------+
|  1 | SIMPLE      | orders | ALL  | NULL          |
+----+-------------+--------+------+---------------+
+------+---------+------+------+-------------+
| key  | key_len | ref  | rows | Extra       |
+------+---------+------+------+-------------+
| NULL | NULL    | NULL |    1 | Using where |
+------+---------+------+------+-------------+


1 row in set (0.00 sec)
</code></pre>
<button class="clipboard-button" data-clipboard-text="EXPLAIN for: SELECT `customers`.* FROM `customers`  WHERE `customers`.`id` = 1
+----+-------------+-----------+-------+---------------+
| id | select_type | table     | type  | possible_keys |
+----+-------------+-----------+-------+---------------+
|  1 | SIMPLE      | customers | const | PRIMARY       |
+----+-------------+-----------+-------+---------------+
+---------+---------+-------+------+-------+
| key     | key_len | ref   | rows | Extra |
+---------+---------+-------+------+-------+
| PRIMARY | 4       | const |    1 |       |
+---------+---------+-------+------+-------+

1 row in set (0.00 sec)

EXPLAIN for: SELECT `orders`.* FROM `orders`  WHERE `orders`.`customer_id` IN (1)
+----+-------------+--------+------+---------------+
| id | select_type | table  | type | possible_keys |
+----+-------------+--------+------+---------------+
|  1 | SIMPLE      | orders | ALL  | NULL          |
+----+-------------+--------+------+---------------+
+------+---------+------+------+-------------+
| key  | key_len | ref  | rows | Extra       |
+------+---------+------+------+-------------+
| NULL | NULL    | NULL |    1 | Using where |
+------+---------+------+------+-------------+


1 row in set (0.00 sec)
">Copy</button>
</div>
<p>並且可能為 PostgreSQL 產生這個：</p><div class="code_container">
<pre><code class="highlight plaintext">  Customer Load (0.3ms)  SELECT "customers".* FROM "customers" WHERE "customers"."id" = $1  [["id", 1]]
  Order Load (0.3ms)  SELECT "orders".* FROM "orders" WHERE "orders"."customer_id" = $1  [["customer_id", 1]]
=&gt; EXPLAIN for: SELECT "customers".* FROM "customers" WHERE "customers"."id" = $1 [["id", 1]]
                                    QUERY PLAN
----------------------------------------------------------------------------------
 Index Scan using customers_pkey on customers  (cost=0.15..8.17 rows=1 width=164)
   Index Cond: (id = '1'::bigint)
(2 rows)
</code></pre>
<button class="clipboard-button" data-clipboard-text="  Customer Load (0.3ms)  SELECT &quot;customers&quot;.* FROM &quot;customers&quot; WHERE &quot;customers&quot;.&quot;id&quot; = $1  [[&quot;id&quot;, 1]]
  Order Load (0.3ms)  SELECT &quot;orders&quot;.* FROM &quot;orders&quot; WHERE &quot;orders&quot;.&quot;customer_id&quot; = $1  [[&quot;customer_id&quot;, 1]]
=&gt; EXPLAIN for: SELECT &quot;customers&quot;.* FROM &quot;customers&quot; WHERE &quot;customers&quot;.&quot;id&quot; = $1 [[&quot;id&quot;, 1]]
                                    QUERY PLAN
----------------------------------------------------------------------------------
 Index Scan using customers_pkey on customers  (cost=0.15..8.17 rows=1 width=164)
   Index Cond: (id = '1'::bigint)
(2 rows)
">Copy</button>
</div>
<h4 id="explain"><a class="anchorlink" href="#explain">23.1 解釋 EXPLAIN</a></h4><p>EXPLAIN 輸出的解釋超出了本指南的範圍。這
以下提示可能會有所幫助：</p>
<ul>
<li><p>SQLite3：<a href="https://www.sqlite.org/eqp.html">解釋查詢計劃</a></p></li>
<li><p>MySQL：<a href="https://dev.mysql.com/doc/refman/en/explain-output.html">解釋輸出格式</a></p></li>
<li><p>MariaDB：<a href="https://mariadb.com/kb/en/mariadb/explain/">解釋</a></p></li>
<li><p>PostgreSQL: <a href="https://www.postgresql.org/docs/current/static/using-explain.html">使用解釋</a></p></li>
</ul>


        <h3>回饋</h3>
        <p>
          我們鼓勵您幫助提高本指南的品質。
        </p>
        <p>
          如果您發現任何拼寫錯誤或資訊錯誤，請提供回饋。
          要開始回饋，您可以閱讀我們的 <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">回饋</a> 部分。
        </p>
        <p>
          您還可能會發現不完整的內容或不是最新的內容。
          請務必為 main 新增任何遺漏的文件。假設是
          <a href="https://edgeguides.rubyonrails.org">非穩定版指南(edge guides)</a> 請先驗證問題是否已經在主分支上解決。
          請前往 <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南寫作準則</a> 查看寫作風格和慣例。
        </p>
        <p>
          如果由於某種原因您發現要修復的內容但無法自行修補，請您 <a href="https://github.com/rails/rails/issues">提出 issue</a>。
        </p>
        <p>關於 Ruby on Rails 的任何類型的討論歡迎提供任何文件至 <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">rubyonrails-docs 討論區</a>。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>本作品已獲得<a href="https://creativecommons.org/licenses/by-sa/4.0/">知識共享署名-相同方式共享 4.0 國際</a>許可</p>
<p>“Rails”、“Ruby on Rails”和 Rails 標誌是 David Heinemeier Hansson 的商標。 保留所有權利。</p>
    </div>
  </div>
</body>
</html>
